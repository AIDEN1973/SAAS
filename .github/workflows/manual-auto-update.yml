name: Manual Auto Update

# íŠ¸ë¦¬ê±°: pages í´ë” ë³€ê²½ ì‹œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰
on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/academy-admin/src/pages/**/*.tsx'
      - 'apps/academy-admin/src/constants/routes.ts'
      - 'apps/academy-admin/src/constants/sub-sidebar-menus.ts'
  workflow_dispatch:
    inputs:
      manual_id:
        description: 'ì—…ë°ì´íŠ¸í•  ë§¤ë‰´ì–¼ ID (ì˜ˆ: students, billing). ë¹„ì›Œë‘ë©´ ë³€ê²½ëœ ê²ƒë§Œ ì—…ë°ì´íŠ¸'
        required: false
        default: ''
      force_all:
        description: 'ì „ì²´ ë§¤ë‰´ì–¼ ê°•ì œ ì—…ë°ì´íŠ¸'
        required: false
        type: boolean
        default: false

# ë™ì‹œ ì‹¤í–‰ ì œì–´
concurrency:
  group: manual-update-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # 1. ë³€ê²½ ê°ì§€ ë° ë§¤ë‰´ì–¼ ë™ê¸°í™” ê²€ì¦
  # ============================================
  detect-changes:
    name: Detect Manual Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      needs_update: ${{ steps.check.outputs.needs_update }}
      manual_ids: ${{ steps.check.outputs.manual_ids }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # ìµœê·¼ ì»¤ë°‹ ë¹„êµìš©

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Check manual sync status
        id: check
        run: |
          # ë§¤ë‰´ì–¼ ë™ê¸°í™” ê²€ì¦
          npm run verify:manual-sync || true

          # ë³€ê²½ ê°ì§€ (check-only ëª¨ë“œ)
          OUTPUT=$(npm run watch:manual-changes -- --check-only 2>&1) || true

          echo "$OUTPUT"

          # ì—…ë°ì´íŠ¸ í•„ìš”í•œ ë§¤ë‰´ì–¼ ID ì¶”ì¶œ
          MANUAL_IDS=""
          if echo "$OUTPUT" | grep -q "ì—…ë°ì´íŠ¸ í•„ìš”"; then
            MANUAL_IDS=$(echo "$OUTPUT" | grep -E "^\[1m" | sed 's/\[1m//g' | sed 's/\[0m.*//g' | tr '\n' ',' | sed 's/,$//')
          fi

          # workflow_dispatch ì…ë ¥ê°’ ì²˜ë¦¬
          if [ -n "${{ github.event.inputs.manual_id }}" ]; then
            MANUAL_IDS="${{ github.event.inputs.manual_id }}"
          fi

          if [ "${{ github.event.inputs.force_all }}" == "true" ]; then
            MANUAL_IDS="all"
          fi

          # ì¶œë ¥ ì„¤ì •
          if [ -n "$MANUAL_IDS" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "manual_ids=$MANUAL_IDS" >> $GITHUB_OUTPUT
            echo "âœ… ì—…ë°ì´íŠ¸ í•„ìš”: $MANUAL_IDS"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "manual_ids=" >> $GITHUB_OUTPUT
            echo "âœ… ëª¨ë“  ë§¤ë‰´ì–¼ì´ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤."
          fi

  # ============================================
  # 2. AI ê¸°ë°˜ ë§¤ë‰´ì–¼ ìë™ ì—…ë°ì´íŠ¸
  # ============================================
  auto-update:
    name: Auto Update Manuals
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes]
    if: needs.detect-changes.outputs.needs_update == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run AI Manual Update
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          MANUAL_IDS="${{ needs.detect-changes.outputs.manual_ids }}"

          if [ "$MANUAL_IDS" == "all" ]; then
            echo "ğŸ”„ ì „ì²´ ë§¤ë‰´ì–¼ ì—…ë°ì´íŠ¸ ì¤‘..."
            npm run auto:manual-update -- --all
          else
            echo "ğŸ”„ ì„ íƒëœ ë§¤ë‰´ì–¼ ì—…ë°ì´íŠ¸ ì¤‘: $MANUAL_IDS"
            IFS=',' read -ra IDS <<< "$MANUAL_IDS"
            for id in "${IDS[@]}"; do
              echo "  - $id ì—…ë°ì´íŠ¸ ì¤‘..."
              npm run auto:manual-update -- --page=$id || true
              sleep 2  # API ë ˆì´íŠ¸ ë¦¬ë°‹ ë°©ì§€
            done
          fi

      - name: Generate Changelog
        run: npm run gen:manual-changelog -- --since=7d

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code apps/academy-admin/src/data/manuals/ || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and Push Changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add apps/academy-admin/src/data/manuals/
          git commit -m "docs(manual): AI ìë™ ì—…ë°ì´íŠ¸ - $(date +%Y-%m-%d)

          ìë™ ìƒì„±ëœ ë§¤ë‰´ì–¼ ì—…ë°ì´íŠ¸:
          - ë³€ê²½ëœ í˜ì´ì§€ ì½”ë“œ ë¶„ì„
          - ChatGPT APIë¡œ ë§¤ë‰´ì–¼ ë‚´ìš© ìƒì„±
          - lastUpdated ë‚ ì§œ ê°±ì‹ 

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push

      - name: No changes to commit
        if: steps.git-check.outputs.changes != 'true'
        run: echo "âœ… ë§¤ë‰´ì–¼ì— ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."

  # ============================================
  # 3. PR ì½”ë©˜íŠ¸ (PRì¸ ê²½ìš°ë§Œ)
  # ============================================
  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.needs_update == 'true'

    steps:
      - name: Comment PR with manual update suggestion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const manualIds = '${{ needs.detect-changes.outputs.manual_ids }}';

            const body = `## ğŸ“– ë§¤ë‰´ì–¼ ì—…ë°ì´íŠ¸ í•„ìš”

            ì´ PRì—ì„œ í˜ì´ì§€ ì½”ë“œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë§¤ë‰´ì–¼ì˜ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

            **ì˜í–¥ë°›ëŠ” ë§¤ë‰´ì–¼:** \`${manualIds}\`

            ### ìë™ ì—…ë°ì´íŠ¸ ë°©ë²•
            \`\`\`bash
            # íŠ¹ì • ë§¤ë‰´ì–¼ ì—…ë°ì´íŠ¸
            npm run auto:manual-update -- --page=${manualIds.split(',')[0]}

            # ë˜ëŠ” ë³€ê²½ ê°ì§€ + ìë™ ì—…ë°ì´íŠ¸
            npm run watch:manual-changes -- --auto-update
            \`\`\`

            > ğŸ’¡ main/develop ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ë©´ ìë™ìœ¼ë¡œ ë§¤ë‰´ì–¼ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.

            ---
            *Auto-generated by Manual Sync Checker*`;

            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“– ë§¤ë‰´ì–¼ ì—…ë°ì´íŠ¸ í•„ìš”')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ============================================
  # 4. ë¼ë²¨ ì¶”ê°€ (PRì¸ ê²½ìš°ë§Œ)
  # ============================================
  add-label:
    name: Add Label to PR
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.needs_update == 'true'

    steps:
      - name: Add needs-manual-update label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-manual-update']
            });
