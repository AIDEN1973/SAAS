/**
 * 출결 관리 페이지
 *
 * [LAYER: UI_PAGE]
 *
 * [요구사항]
 * - PC/태블릿/모바일 출결
 * - QR 출결(선택)
 * - 출결 알림 발송(카카오톡/SMS)
 * - 지각 기준, 결석 처리 규칙 설정
 * - 시간대별 출결 기록
 * - 자동 출결 메시지
 * - 출석부 출력
 * - 출결 히스토리 조회
 */

import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { ErrorBoundary , Container, Card, Button, Badge, Select, useModal, Checkbox, BottomActionBar, Grid, PageHeader , useResponsiveMode, isMobile, isTablet, NotificationCardLayout, EmptyState, DataTable } from '@ui-core/react';
// [SSOT] Barrel export를 통한 통합 import
import { createSafeNavigate } from '../utils';
import { CardGridLayout } from '../components/CardGridLayout';
import { Users, UserCheck, Clock, UserX } from 'lucide-react';
import { SchemaFilter } from '@schema-engine';
import { useAttendanceLogs, useCreateAttendanceLog, useDeleteAttendanceLog } from '@hooks/use-attendance';
import { useStudents } from '@hooks/use-student';
import { useClasses } from '@hooks/use-class';
import { useIndustryTerms } from '@hooks/use-industry-terms';
// [SSOT] Barrel export를 통한 통합 import
import { ROUTES } from '../constants';
import type { AttendanceFilter, AttendanceType, AttendanceStatus } from '@services/attendance-service';
import type { Student } from '@services/student-service';
import type { ColorToken } from '@design-system/core';
import type { DayOfWeek } from '@services/class-service';
import { toKST } from '@lib/date-utils';
import { createAttendanceFormSchema } from '../schemas/attendance.schema';
import { createAttendanceFilterSchema, createAttendanceHeaderFilterSchema } from '../schemas/attendance.filter.schema';
// 출결 설정은 환경설정 > 출결 설정으로 이동 (아키텍처 문서 3.3.7)
// import { attendanceSettingsFormSchema } from '../schemas/attendance-settings.schema';
import { useSchema } from '@hooks/use-schema';
import { useUserRole } from '@hooks/use-auth';

// 학생 출결 상태 인터페이스
interface StudentAttendanceState {
  student_id: string;
  check_in: boolean;
  check_out: boolean;
  status: AttendanceStatus;
  ai_predicted?: boolean; // AI 예측값 여부
  user_modified?: boolean; // 사용자가 수정했는지 여부 (사용자 입력 시 AI 데이터 override)
}

export function AttendancePage() {
  const navigate = useNavigate();
  // [P0-2 수정] SSOT: 네비게이션 보안 유틸리티 사용
  const safeNavigate = useMemo(
    () => createSafeNavigate(navigate),
    [navigate]
  );
  const mode = useResponsiveMode();
  // [SSOT] 반응형 모드 확인은 SSOT 헬퍼 함수 사용
  // mode는 'xs' | 'sm' | 'md' | 'lg' | 'xl' 형식이므로 대문자로 변환
  const modeUpper = mode.toUpperCase() as 'XS' | 'SM' | 'MD' | 'LG' | 'XL';
  const isMobileMode = isMobile(modeUpper);
  const isTabletMode = isTablet(modeUpper); // 아키텍처 문서 3.3.9: 태블릿 모드 감지 (768px ~ 1024px)
  const { data: userRole } = useUserRole();
  const terms = useIndustryTerms();

  // 역할별 권한 체크 (아키텍처 문서 2.3, 498-507줄)
  // Assistant: 출결 입력만 가능, 수정 권한 없음
  // Teacher: 출결 입력 및 수정 모두 가능
  const canModifyAttendance = userRole !== 'assistant';


  // 오늘 출결하기 관련 상태
  // localStorage 기반 상태 초기화 (마지막 선택 반 기억)
  const [selectedClassId, setSelectedClassId] = useState<string | null>(() => {
    try {
      const stored = localStorage.getItem('attendance-page-selected-class');
      return stored || null;
    } catch (error) {
      if (import.meta.env?.DEV) {
        console.warn('AttendancePage: localStorage 접근 실패, 기본값 사용', { error });
      }
      return null;
    }
  });
  const [selectedDate, setSelectedDate] = useState<string>(toKST().format('YYYY-MM-DD'));
  const [searchQuery, setSearchQuery] = useState<string>('');
  const [studentAttendanceStates, setStudentAttendanceStates] = useState<Record<string, StudentAttendanceState>>({});
  const [isSaving, setIsSaving] = useState(false);

  // 필터 상태 (출결 기록 조회는 Advanced 메뉴로 이동 - 아키텍처 문서에 명시되지 않음)
  const [filter, setFilter] = useState<AttendanceFilter>({
    date_from: toKST().format('YYYY-MM-DD'),
    date_to: toKST().format('YYYY-MM-DD'),
  });


  // 통계/히트맵 기능은 통계 또는 AI 인사이트 메뉴로 이동 (아키텍처 문서 3.3.8)
  // const [showStatistics, setShowStatistics] = useState(false);

  // 출결 설정은 환경설정 > 출결 설정으로 이동 (아키텍처 문서 1716줄)
  // const [showSettings, setShowSettings] = useState(false);
  // const { data: config } = useConfig(); // 현재 사용되지 않음

  // 전역 모달 훅 사용
  const { showAlert, showConfirm } = useModal();


  const handleClassIdChange = useCallback((classId: string | null) => {
    setSelectedClassId(classId);
    try {
      if (classId) {
        localStorage.setItem('attendance-page-selected-class', classId);
      } else {
        localStorage.removeItem('attendance-page-selected-class');
      }
    } catch (error) {
      if (import.meta.env?.DEV) {
        console.warn('AttendancePage: localStorage 저장 실패', { error });
      }
    }
  }, []);

  // [P0-FIX] Policy Registry 기반 출결 설정 (Automation Config First 원칙)
  // Fail Closed: Policy가 없으면 지각/결석 판정 불가 (기본값 null)
  // Note: 현재 사용되지 않지만 향후 확장을 위해 유지
  // const _attendanceConfig = useMemo(() => {
  //   const lateAfter = getPolicyValue<number>('ATTENDANCE_LATE_AFTER', config);
  //   const absentAfter = getPolicyValue<number>('ATTENDANCE_ABSENT_AFTER', config);
  //   const autoNotification = getPolicyValue<boolean>('ATTENDANCE_AUTO_NOTIFICATION', config) ?? false;
  //   const notificationChannel = getPolicyValue<string>('ATTENDANCE_NOTIFICATION_CHANNEL', config) ?? 'sms';

  //   return {
  //     late_after: lateAfter,
  //     absent_after: absentAfter,
  //     auto_notification: autoNotification,
  //     notification_channel: notificationChannel as 'sms' | 'kakao_at',
  //   };
  // }, [config]);

  // 출결 기록 상태
  // const [showCreateForm, setShowCreateForm] = useState(false); // (미사용) 출결 기록 수동 생성 UI 도입 시 사용

  // 데이터 조회
  const { data: attendanceLogsData, isLoading: isLoadingLogs, error: errorLogs } = useAttendanceLogs(filter);
  const attendanceLogs = attendanceLogsData || [];
  const { data: students, isLoading: isLoadingStudents, error: errorStudents } = useStudents();
  const { data: classes, isLoading: isLoadingClasses, error: errorClasses } = useClasses();

  // 오늘 수업 필터링 (Today-First Principle)
  // 기술문서 5-2: KST 기준 날짜 처리
  const todayClassesFilter = useMemo(() => {
    // 오늘 요일 계산 (월요일=1, 일요일=0) - KST 기준
    const todayKST = toKST();
    const dayOfWeek = todayKST.day(); // 0(일) ~ 6(토)
    const dayOfWeekMap: Record<number, DayOfWeek> = {
      0: 'sunday',
      1: 'monday',
      2: 'tuesday',
      3: 'wednesday',
      4: 'thursday',
      5: 'friday',
      6: 'saturday',
    };
    const todayDayOfWeek = dayOfWeekMap[dayOfWeek];
    return { day_of_week: todayDayOfWeek, status: 'active' as const };
  }, []);

  // 오늘 수업 목록
  const { data: todayClasses } = useClasses(todayClassesFilter);

  // 정본 규칙: apiClient.get('student_classes') 직접 조회 제거
  // 오늘 수업 반의 학생 ID 목록 조회
  // TODO: useStudents Hook이 여러 class_id를 지원하도록 개선 필요
  // 현재는 students 데이터에서 todayClasses에 속한 학생만 필터링 (아래 todayStudents useMemo에서 처리)
  const todayClassStudentIds = useMemo(() => {
    if (!todayClasses || todayClasses.length === 0) return new Set<string>();
    // students 데이터에 class 정보가 포함되어 있지 않으므로,
    // 실제 필터링은 아래 todayStudents useMemo에서 처리
    // 향후 useStudents Hook이 여러 class_id를 지원하도록 개선 필요
    return new Set<string>();
  }, [todayClasses]);

  // 오늘 수업 학생 목록 (오늘 수업이 있는 반에 속한 학생만)
  const todayStudents = useMemo(() => {
    if (!students || !todayClassStudentIds) return [];

    return students.filter(s => todayClassStudentIds.has(s.id));
  }, [students, todayClassStudentIds]);

  // 정본 규칙: apiClient.get('student_classes') 직접 조회 제거, useStudents Hook 사용
  // 선택된 반의 학생 조회
  const { data: selectedClassStudents } = useStudents(
    selectedClassId ? { class_id: selectedClassId } : undefined
  );

  const selectedClassStudentIds = useMemo(() => {
    if (!selectedClassStudents) return new Set<string>();
    return new Set<string>(selectedClassStudents.map((s) => s.id));
  }, [selectedClassStudents]);

  // 선택된 반의 학생 목록
  const filteredStudents = useMemo(() => {
    if (!todayStudents) return [];

    let filtered = todayStudents;

    // 수업 필터
    if (selectedClassId && selectedClassStudentIds) {
      filtered = filtered.filter(s => selectedClassStudentIds.has(s.id));
    }

    // 검색 필터
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(s =>
        s.name?.toLowerCase().includes(query) ||
        s.phone?.includes(query)
      );
    }

    return filtered;
  }, [todayStudents, selectedClassId, selectedClassStudentIds, searchQuery]);

  // [비활성화] AI 출석 예측 기능 비활성화
  const aiPredictions = useMemo<Record<string, { check_in: boolean; check_out: boolean; status: AttendanceStatus }>>(() => ({}), []);
  const isLoadingPredictions = false;

  // // AI 출석 예측 조회 (초기 상태에만 적용)
  // // [성능 최적화] useOptimizedQuery 사용
  // const { data: aiPredictions, isLoading: isLoadingPredictions } = useOptimizedQuery(
  //   ['ai-attendance-predictions', selectedDate, selectedClassId, filteredStudents.map(s => s.id)],
  //   async () => {
  //     if (!filteredStudents || filteredStudents.length === 0) return {};

  //     try {
  //       // AI 출석 예측 (아키텍처 문서 3.3.2: AI가 출석을 "예측"하여 기본값 설정)
  //       // 현재는 과거 출결 패턴 기반 간단한 예측 구현
  //       // 향후 Edge Function으로 AI 예측 API 호출로 확장 예정
  //       const predictions: Record<string, { check_in: boolean; check_out: boolean; status: AttendanceStatus }> = {};

  //       // 각 학생의 과거 출결 패턴 조회
  //       // 기술문서 5-2: KST 기준 날짜 처리
  //       const dateFrom = toKST(selectedDate).subtract(30, 'day').format('YYYY-MM-DD');

  //       for (const student of filteredStudents) {
  //         try {
  //           // 학생의 과거 출결 데이터 조회
  //           // 정본 규칙: fetchAttendanceLogs 함수 사용 (Hook의 queryFn 로직 재사용)
  //           if (!tenantId) continue;
  //           const pastLogs = await fetchAttendanceLogs(tenantId, {
  //             student_id: student.id,
  //             date_from: dateFrom,
  //             date_to: selectedDate,
  //             attendance_type: 'check_in',
  //           });

  //           if (pastLogs.length > 0) {
  //             // 출석률 계산
  //             const presentCount = (pastLogs as unknown as AttendanceLog[]).filter((log: AttendanceLog) => log.status === 'present').length;
  //             const attendanceRate = presentCount / pastLogs.length;

  //             // 출석률이 70% 이상이면 출석 예측
  //             if (attendanceRate >= 0.7) {
  //               predictions[student.id] = {
  //                 check_in: true,
  //                 check_out: false,
  //                 status: attendanceRate >= 0.9 ? 'present' : 'late',
  //               };
  //             }
  //           }
  //         } catch (error) {
  //           // AI 예측 실패 시 해당 학생은 예측값 없음으로 처리 (아키텍처 문서 3.3.2: fallback_on_prediction_failure)
  //         }
  //       }

  //       return predictions;
  //     } catch (error) {
  //       // AI 예측 실패 시 빈 객체 반환 (모든 학생 미체크 상태) - 아키텍처 문서 3.3.2: fallback_on_prediction_failure
  //       return {};
  //     }
  //   },
  //   {
  //     enabled: filteredStudents.length > 0 && viewMode === 'today',
  //     // useOptimizedQuery의 기본 staleTime(5분)이 자동 적용됨
  //   }
  // );

  // 전체 로딩 상태 (아키텍처 문서 3.3.3: loading 상태)
  // isLoadingPredictions 정의 이후에 계산해야 함
  const isLoading = isLoadingLogs || isLoadingStudents || isLoadingClasses || isLoadingPredictions;

  // 전체 에러 상태 (아키텍처 문서 3.3.3: error 상태)
  const error = errorLogs || errorStudents || errorClasses;

  // AI 예측값 초기화 여부 추적 (무한루프 방지)
  const initializedRef = useRef(false);

  // AI 예측값을 초기 상태에 적용 (한 번만 실행)
  useEffect(() => {
    // 이미 초기화된 경우 스킵
    if (initializedRef.current) return;
    if (isLoadingPredictions) return;
    if (filteredStudents.length === 0) return;

    // AI 예측값을 초기 상태로 설정
    const newStates: Record<string, StudentAttendanceState> = {};

    filteredStudents.forEach(student => {
      const prediction = aiPredictions[student.id];
      if (prediction) {
        newStates[student.id] = {
          student_id: student.id,
          check_in: prediction.check_in,
          check_out: prediction.check_out,
          status: prediction.status,
          ai_predicted: true,
          user_modified: false,
        };
      } else {
        // AI 예측이 없는 경우 미체크 상태
        newStates[student.id] = {
          student_id: student.id,
          check_in: false,
          check_out: false,
          status: 'present',
          ai_predicted: false,
          user_modified: false,
        };
      }
    });

    setStudentAttendanceStates(newStates);
    initializedRef.current = true;
  }, [aiPredictions, isLoadingPredictions, filteredStudents]);

  // 선택된 반/날짜 변경 시 상태 초기화
  useEffect(() => {
    setStudentAttendanceStates({});
    initializedRef.current = false; // 다시 초기화할 수 있도록 리셋
  }, [selectedClassId, selectedDate]);

  // 출결 필터 스키마 생성 (동적 옵션)
  const attendanceFilterSchema = useMemo(
    () => createAttendanceFilterSchema(students, classes, terms),
    [students, classes, terms]
  );

  // 출결 화면 헤더 필터 스키마 생성 (수업 선택, 날짜 선택, 검색)
  const attendanceHeaderFilterSchema = useMemo(
    () => createAttendanceHeaderFilterSchema(todayClasses, terms),
    [todayClasses, terms]
  );

  // Schema Registry 연동 (아키텍처 문서 S3 참조)
  const { data: attendanceFilterSchemaData } = useSchema(
    'attendance_filter',
    attendanceFilterSchema,
    'filter'
  );

  const { data: attendanceHeaderFilterSchemaData } = useSchema(
    'attendance_header_filter',
    attendanceHeaderFilterSchema,
    'filter'
  );

  // Fallback: Registry에서 조회 실패 시 로컬 스키마 사용
  const effectiveFilterSchema = attendanceFilterSchemaData || attendanceFilterSchema;
  const effectiveHeaderFilterSchema = attendanceHeaderFilterSchemaData || attendanceHeaderFilterSchema;
  void effectiveFilterSchema; // Reserved for future use

  // 필터 변경 핸들러
  const handleFilterChange = useCallback((filters: Record<string, unknown>) => {
    setFilter({
      date_from: filters.date_from ? String(filters.date_from) : toKST().format('YYYY-MM-DD'),
      date_to: filters.date_to ? String(filters.date_to) : toKST().format('YYYY-MM-DD'),
      student_id: filters.student_id ? String(filters.student_id) : undefined,
      class_id: filters.class_id ? String(filters.class_id) : undefined,
      attendance_type: filters.attendance_type as AttendanceType | undefined,
      status: filters.status as AttendanceStatus | undefined,
    });
  }, []);
  void handleFilterChange;

  // 출결 생성/삭제
  const createAttendance = useCreateAttendanceLog();
  const deleteAttendance = useDeleteAttendanceLog();


  // 지각/결석 자동 판정 함수
  // [P0-FIX] Fail Closed 패턴: Policy가 없으면 자동 판정 불가
  // Note: 현재 사용되지 않지만 향후 확장을 위해 유지
  // const _determineAttendanceStatus = (
  //   occurredAt: string | Date,
  //   classInfo: { start_time: string; day_of_week: string } | undefined,
  //   lateAfter: number | null,
  //   absentAfter: number | null
  // ): { status: AttendanceStatus; attendance_type: AttendanceType } => {
  //   if (!classInfo) {
  //     // 수업 정보가 없으면 수동 입력값 사용
  //     return { status: 'present', attendance_type: 'check_in' };
  //   }

  //   // [P0-FIX] Fail Closed: Policy가 없으면 자동 판정 불가 (수동 입력값 사용)
  //   if (lateAfter === null || absentAfter === null) {
  //     return { status: 'present', attendance_type: 'check_in' };
  //   }

  //   // 반의 요일 확인
  //   const dayMap: Record<string, number> = {
  //     'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4,
  //     'friday': 5, 'saturday': 6, 'sunday': 0,
  //   };
  //   const classDayOfWeek = dayMap[classInfo.day_of_week.toLowerCase()];
  //   const occurredAtKSTForDay = typeof occurredAt === 'string' ? toKST(occurredAt) : toKST(occurredAt.toISOString());
  //   const occurredDayOfWeek = occurredAtKSTForDay.day();

  //   // 요일이 맞지 않으면 수동 입력값 사용
  //   if (classDayOfWeek !== occurredDayOfWeek) {
  //     return { status: 'present', attendance_type: 'check_in' };
  //   }

  //   // 수업 시작 시간 파싱
  //   const [startHour, startMinute] = classInfo.start_time.split(':').map(Number);
  //   const occurredAtKST = typeof occurredAt === 'string' ? toKST(occurredAt) : toKST(occurredAt.toISOString());
  //   const classStartTime = occurredAtKST.hour(startHour).minute(startMinute).second(0).millisecond(0);

  //   // 시간 차이 계산 (분)
  //   const diffMinutes = occurredAtKST.diff(classStartTime, 'minute');

  //   // 자동 판정
  //   if (diffMinutes <= 0) {
  //     return { status: 'present', attendance_type: 'check_in' };
  //   } else if (diffMinutes <= lateAfter) {
  //     return { status: 'late', attendance_type: 'late' };
  //   } else if (diffMinutes <= absentAfter) {
  //     return { status: 'late', attendance_type: 'late' };
  //   } else {
  //     return { status: 'absent', attendance_type: 'absent' };
  //   }
  // };


  // 출결 설정은 환경설정 > 출결 설정으로 이동 (아키텍처 문서 3.3.7, 1716줄)
  // handleSaveSettings 함수 제거됨
  // handleCreateAttendance 함수 제거됨 (미사용)

  // 출결 스키마 생성 (동적 옵션)
  const attendanceSchema = useMemo(
    () => createAttendanceFormSchema(students, classes, terms),
    [students, classes, terms]
  );

  // Schema Registry 연동 (아키텍처 문서 S3 참조)
  const { data: attendanceFormSchemaData } = useSchema(
    'attendance',
    attendanceSchema,
    'form'
  );

  // Fallback: Registry에서 조회 실패 시 로컬 스키마 사용
  const effectiveFormSchema = attendanceFormSchemaData || attendanceSchema;
  void effectiveFormSchema; // Reserved for future use


  // 통계/히트맵/패턴 분석 기능은 통계 또는 AI 인사이트 메뉴로 이동 (아키텍처 문서 3.3.8)
  // calculateStatistics, analyzeDayPattern, analyzeTimePattern, calculateClassHeatmap, detectAbnormalAttendance 함수 제거됨

  // 출석부 출력
  const handlePrintAttendance = () => {
    try {
      // 출결 기록 확인
      if (!attendanceLogs) {
        showAlert('출결 기록을 불러오는 중입니다. 잠시 후 다시 시도해주세요.', terms.MESSAGES.ALERT, 'info');
        return;
      }

      if (attendanceLogs.length === 0) {
        showAlert('출력할 출결 기록이 없습니다.\n\n먼저 "출결 기록" 버튼을 클릭하여 출결 기록을 추가해주세요.', terms.MESSAGES.ALERT, 'info');
        return;
      }

      // 학생 정보 확인
      if (!students) {
        showAlert(`${terms.PERSON_LABEL_PRIMARY} 정보를 불러오는 중입니다. 잠시 후 다시 시도해주세요.`, terms.MESSAGES.ALERT, 'info');
        return;
      }

      if (students.length === 0) {
        showAlert(`${terms.PERSON_LABEL_PRIMARY} 정보가 없습니다.\n\n먼저 ${terms.PERSON_LABEL_PRIMARY}을(를) 등록해주세요.`, terms.MESSAGES.ALERT, 'info');
        return;
      }

      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('팝업이 차단되어 있습니다. 브라우저 설정에서 팝업을 허용해주세요.', terms.MESSAGES.ALERT, 'warning');
        return;
      }

      const dateStr = filter.date_from === filter.date_to
        ? filter.date_from
        : `${filter.date_from} ~ ${filter.date_to}`;

      const html = `
        <!DOCTYPE html>
        <html>
          <head>
            <meta charset="UTF-8">
            <title>출석부 - ${dateStr}</title>
            <style>
              body { font-family: 'Malgun Gothic', sans-serif; padding: var(--spacing-xl); }
              h1 { text-align: center; margin-bottom: var(--spacing-2xl); }
              table { width: 100%; border-collapse: collapse; margin-top: var(--spacing-xl); }
              th, td { border: var(--border-width-thin) solid var(--color-border); padding: var(--spacing-xs); text-align: left; }
              th { background-color: var(--color-gray-50); font-weight: var(--font-weight-semibold); }
              @media print { @page { margin: var(--print-page-margin); } }
            </style>
          </head>
          <body>
            <h1>출석부</h1>
            <p><strong>기간:</strong> ${dateStr}</p>
            <table>
              <thead>
                <tr>
                  <th>날짜/시간</th>
                  <th>${terms.PERSON_LABEL_PRIMARY}명</th>
                  <th>반</th>
                  <th>타입</th>
                  <th>상태</th>
                  <th>메모</th>
                </tr>
              </thead>
              <tbody>
                ${attendanceLogs.map(log => {
                  const student = students?.find((s) => s.id === log.student_id);
                  const classInfo = classes?.find((c) => c.id === log.class_id);
                  const occurredDateKST = toKST(log.occurred_at);
                  const dateStr = occurredDateKST.format('YYYY-MM-DD');
                  const timeStr = occurredDateKST.format('HH:mm');
                  const typeStr = log.attendance_type === 'check_in' ? terms.CHECK_IN_LABEL : log.attendance_type === 'check_out' ? terms.CHECK_OUT_LABEL : log.attendance_type === 'late' ? terms.LATE_LABEL : terms.ABSENCE_LABEL;
                  const statusStr = log.status === 'present' ? terms.PRESENT_LABEL : log.status === 'late' ? terms.LATE_LABEL : log.status === 'absent' ? terms.ABSENCE_LABEL : terms.EXCUSED_LABEL;

                  return `
                    <tr>
                      <td>${dateStr} ${timeStr}</td>
                      <td>${student?.name || '알 수 없음'}</td>
                      <td>${classInfo?.name || '-'}</td>
                      <td>${typeStr}</td>
                      <td>${statusStr}</td>
                      <td>${(log.notes || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </body>
        </html>
      `;

      printWindow.document.write(html);
      printWindow.document.close();

      // 인쇄 대화상자 열기 (약간의 지연 후)
      setTimeout(() => {
        try {
          printWindow.print();
        } catch (printError) {
          showAlert('인쇄 대화상자를 열 수 없습니다. 새 창에서 직접 인쇄해주세요.', terms.MESSAGES.ERROR, 'warning');
        }
      }, 100);
    } catch (error) {
      showAlert(
        `출석부 출력 중 오류가 발생했습니다: ${error instanceof Error ? error.message : 'Unknown error'}`,
        terms.MESSAGES.ERROR,
        'error'
      );
    }
  };
  void handlePrintAttendance;

  // 출결 기록 삭제 (아키텍처 문서 2.3: Assistant는 수정 권한 없음)
  const handleDeleteAttendance = async (logId: string) => {
    // 역할별 권한 체크
    if (!canModifyAttendance) {
      showAlert('출결 수정 권한이 없습니다. Teacher 또는 Admin에게 요청해주세요.', terms.MESSAGES.ALERT, 'warning');
      return;
    }

    const confirmed = await showConfirm(terms.MESSAGES.DELETE_CONFIRM, terms.MESSAGES.ALERT);
    if (!confirmed) {
      return;
    }

    try {
      await deleteAttendance.mutateAsync(logId);
    } catch (error) {
      showAlert(
        `출결 기록 삭제 중 오류가 발생했습니다: ${error instanceof Error ? error.message : 'Unknown error'}`,
        terms.MESSAGES.ERROR,
        'error'
      );
    }
  };
  void handleDeleteAttendance;

  // 출결 상태 뱃지 색상
  const getStatusBadgeColor = (status: AttendanceStatus): ColorToken => {
    switch (status) {
      case 'present':
        return 'success';
      case 'late':
        return 'warning';
      case 'absent':
        return 'error';
      case 'excused':
        return 'info';
      default:
        return 'secondary';
    }
  };
  void getStatusBadgeColor;

  // 출결 타입 뱃지 색상
  const getTypeBadgeColor = (type: AttendanceType): ColorToken => {
    switch (type) {
      case 'check_in':
        return 'success';
      case 'check_out':
        return 'info';
      case 'late':
        return 'warning';
      case 'absent':
        return 'error';
      default:
        return 'secondary';
    }
  };
  void getTypeBadgeColor;

  // 출결 저장 핸들러
  const handleSaveAttendance = useCallback(async () => {
    if (isSaving) return;

    setIsSaving(true);
    try {
      const attendanceRecords = Object.values(studentAttendanceStates)
        .filter(state => state.check_in || state.check_out)
        .map(state => ({
          student_id: state.student_id,
          class_id: selectedClassId || undefined,
          occurred_at: toKST(selectedDate).format('YYYY-MM-DDTHH:mm'),
          attendance_type: (state.check_in ? 'check_in' : 'check_out') as AttendanceType,
          status: state.status,
        }));

      // 출결 기록 생성 (아키텍처 문서 3.3.3: 출결 저장)
      for (const record of attendanceRecords) {
        await createAttendance.mutateAsync(record);
      }

      // Success 상태 (아키텍처 문서 3.3.3: success 상태 - 2초 후 자동 닫기)
      showAlert(terms.MESSAGES.SAVE_SUCCESS, terms.MESSAGES.SUCCESS, 'success');
      setStudentAttendanceStates({});

      // 2초 후 자동으로 데이터 새로고침 (아키텍처 문서 3.3.3: auto_close_duration: 2000)
      setTimeout(() => {
        // 출결 상태 초기화 및 화면 유지 (아키텍처 문서 3.3.3: on_auto_close: 'refresh_data')
        // 이미 setStudentAttendanceStates({})로 초기화했으므로 추가 작업 불필요
      }, 2000);
    } catch (error) {
      showAlert(terms.MESSAGES.SAVE_ERROR, terms.MESSAGES.ERROR, 'error');
    } finally {
      setIsSaving(false);
    }
  }, [studentAttendanceStates, selectedClassId, selectedDate, isSaving, createAttendance, showAlert, terms]);

  // 일괄 등원/하원 핸들러
  const handleBulkCheckIn = useCallback(() => {
    const newStates = { ...studentAttendanceStates };
    filteredStudents.forEach(student => {
      if (!newStates[student.id]) {
        newStates[student.id] = {
          student_id: student.id,
          check_in: true,
          check_out: false,
          status: 'present',
          ai_predicted: false,
          user_modified: true,
        };
      } else {
        newStates[student.id] = {
          ...newStates[student.id],
          check_in: true,
          user_modified: true,
        };
      }
    });
    setStudentAttendanceStates(newStates);
  }, [filteredStudents, studentAttendanceStates]);

  const handleBulkCheckOut = useCallback(() => {
    const newStates = { ...studentAttendanceStates };
    filteredStudents.forEach(student => {
      if (!newStates[student.id]) {
        newStates[student.id] = {
          student_id: student.id,
          check_in: false,
          check_out: true,
          status: 'present',
          ai_predicted: false,
          user_modified: true,
        };
      } else {
        newStates[student.id] = {
          ...newStates[student.id],
          check_out: true,
          user_modified: true,
        };
      }
    });
    setStudentAttendanceStates(newStates);
  }, [filteredStudents, studentAttendanceStates]);

  // 출결 요약 통계
  const attendanceSummary = useMemo(() => {
    const states = Object.values(studentAttendanceStates);
    const total = filteredStudents.length;
    const present = states.filter(s => s.check_in && s.status === 'present').length;
    const late = states.filter(s => s.check_in && s.status === 'late').length;
    const absent = states.filter(s => s.status === 'absent').length;
    return { total, present, late, absent };
  }, [studentAttendanceStates, filteredStudents]);

  return (
    <ErrorBoundary>
      <Container maxWidth="xl" padding="lg">
        <PageHeader
          title={`출결관리`}
        />

        {/* 출결 화면 */}
        <>
              {/* AttendanceHeader: 수업 선택, 날짜 선택, 검색 (아키텍처 문서 3.3.3) - SchemaFilter 사용 */}
              <div style={{ pointerEvents: isLoading ? 'none' : 'auto', opacity: isLoading ? 'var(--opacity-loading)' : 'var(--opacity-full)' }}>
                <SchemaFilter
                  schema={effectiveHeaderFilterSchema}
                  onFilterChange={(filters: Record<string, unknown>) => {
                    handleClassIdChange(filters.class_id ? String(filters.class_id) : null);
                    setSelectedDate(filters.date ? String(filters.date) : toKST().format('YYYY-MM-DD'));
                    setSearchQuery(filters.search ? String(filters.search) : '');
                  }}
                  defaultValues={{
                    class_id: selectedClassId || '',
                    date: selectedDate,
                    search: searchQuery,
                  }}
                />
              </div>

              {/* AttendanceSummary: 총원/출석/지각/결석 (아키텍처 문서 3.3.3: 상단 통계) */}
              <div style={{ marginBottom: 'var(--spacing-xl)', pointerEvents: isLoading ? 'none' : 'auto', opacity: isLoading ? 'var(--opacity-loading)' : 'var(--opacity-full)' }}>
                <CardGridLayout
                  cards={[
                    <NotificationCardLayout
                      key="total"
                      icon={<Users />}
                      title={terms.TOTAL_LABEL}
                      value={attendanceSummary.total}
                      unit="명"
                      layoutMode="stats"
                      iconBackgroundColor="var(--color-gray-100)"
                    />,
                    <NotificationCardLayout
                      key="present"
                      icon={<UserCheck />}
                      title={terms.PRESENT_LABEL}
                      value={attendanceSummary.present}
                      unit="명"
                      layoutMode="stats"
                      iconBackgroundColor="var(--color-success-50)"
                    />,
                    <NotificationCardLayout
                      key="late"
                      icon={<Clock />}
                      title={terms.LATE_LABEL}
                      value={attendanceSummary.late}
                      unit="명"
                      layoutMode="stats"
                      iconBackgroundColor="var(--color-warning-50)"
                    />,
                    <NotificationCardLayout
                      key="absent"
                      icon={<UserX />}
                      title={terms.ABSENCE_LABEL}
                      value={attendanceSummary.absent}
                      unit="명"
                      layoutMode="stats"
                      iconBackgroundColor="var(--color-error-50)"
                    />,
                  ]}
                  desktopColumns={4}
                  tabletColumns={2}
                  mobileColumns={2}
                />
              </div>

              {/* AttendanceStudentList: 학생 리스트 + 체크박스 UI (아키텍처 문서 3.3.3: 통계 다음에 StudentList) */}
              {/* 모바일: Bottom Action Bar를 위한 하단 패딩 추가 */}
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: 'var(--spacing-sm)',
                // HARD-CODE-EXCEPTION: paddingBottom 0은 레이아웃용 특수 값 (Bottom Action Bar 높이만큼 패딩)
                paddingBottom: isMobileMode ? 'var(--spacing-bottom-action-bar)' : '0',
              }}>
                {/* 로딩 상태 (아키텍처 문서 3.3.3: loading 상태) */}
                {isLoading && (
                  <Card padding="lg">
                    <div style={{
                      textAlign: 'center',
                      padding: 'var(--spacing-xl)',
                      pointerEvents: 'none',
                      opacity: 'var(--opacity-secondary)'
                    }}>
                      <div style={{
                        color: 'var(--color-text-secondary)',
                        marginBottom: 'var(--spacing-md)'
                      }}>
                        {`출결 정보를 ${terms.MESSAGES.LOADING}`}
                      </div>
                      {/* 스켈레톤 UI (아키텍처 문서 3.3.3: show_skeleton: true) */}
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-sm)' }}>
                        {[1, 2, 3].map(i => (
                          <div
                            key={i}
                            style={{
                              height: 'var(--spacing-bottom-action-bar)',
                              backgroundColor: 'var(--color-gray-100)',
                              borderRadius: 'var(--border-radius-md)',
                              opacity: 'var(--opacity-secondary)',
                            }}
                          />
                        ))}
                      </div>
                    </div>
                  </Card>
                )}

                {/* 에러 상태 (아키텍처 문서 3.3.3: error 상태) */}
                {!isLoading && error && (
                  <Card padding="lg">
                    <div style={{
                      textAlign: 'center',
                      padding: 'var(--spacing-lg)',
                      color: 'var(--color-error)'
                    }}>
                      <div style={{
                        fontWeight: 'var(--font-weight-semibold)',
                        marginBottom: 'var(--spacing-md)'
                      }}>
                        출결 정보를 불러올 수 없습니다.
                      </div>
                      <div style={{
                        color: 'var(--color-text-secondary)',
                        marginBottom: 'var(--spacing-md)'
                      }}>
                        {error instanceof Error ? error.message : '알 수 없는 오류가 발생했습니다.'}
                      </div>
                      <Button
                        variant="outline"
                        onClick={() => {
                          // 데이터 재조회를 위해 쿼리 무효화 및 재시도
                          window.location.reload();
                        }}
                      >
                        다시 시도
                      </Button>
                    </div>
                  </Card>
                )}

                {/* 정상 상태: 학생 리스트 - DataTable */}
                {!isLoading && !error && (
                  <DataTable
                    data={filteredStudents}
                    keyExtractor={(student) => student.id}
                    emptyMessage={`오늘 수업 ${terms.PERSON_LABEL_PRIMARY}이(가) 없습니다.`}
                    emptyIcon={Users}
                    loading={isLoading}
                    columns={[
                      {
                        key: 'name',
                        label: terms.PERSON_LABEL_PRIMARY,
                        width: '20%',
                        render: (_, student) => {
                          const studentWithExtras = student as Student & { primary_class_name?: string };
                          const studentGrade = student.grade ? `${student.grade}${terms.GRADE_LABEL}` : '';
                          const studentClass = studentWithExtras.primary_class_name || '';
                          const gradeClassInfo = [studentGrade, studentClass].filter(Boolean).join(' ');

                          return (
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)' }}>
                              {student.profile_image_url && (
                                <img
                                  src={student.profile_image_url}
                                  alt={student.name}
                                  loading="lazy"
                                  decoding="async"
                                  style={{
                                    width: 'var(--spacing-xl)',
                                    height: 'var(--spacing-xl)',
                                    borderRadius: 'var(--border-radius-full)',
                                    objectFit: 'cover',
                                    flexShrink: 0,
                                  }}
                                />
                              )}
                              <div>
                                <div style={{
                                  fontSize: 'var(--font-size-base)',
                                  fontWeight: 'var(--font-weight-semibold)',
                                  marginBottom: 'var(--spacing-2xs)'
                                }}>
                                  {student.name}
                                </div>
                                {gradeClassInfo && (
                                  <div style={{
                                    fontSize: 'var(--font-size-sm)',
                                    color: 'var(--color-text-secondary)'
                                  }}>
                                    {gradeClassInfo}
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        },
                      },
                      {
                        key: 'check_in',
                        label: terms.CHECK_IN_LABEL,
                        width: '15%',
                        align: 'center' as const,
                        render: (_, student) => {
                          const state = studentAttendanceStates[student.id] || {
                            student_id: student.id,
                            check_in: false,
                            check_out: false,
                            status: 'present' as AttendanceStatus,
                            ai_predicted: false,
                            user_modified: false,
                          };

                          return (
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)', justifyContent: 'center' }}>
                              <Checkbox
                                checked={state.check_in}
                                onChange={(e) => {
                                  setStudentAttendanceStates(prev => ({
                                    ...prev,
                                    [student.id]: {
                                      ...state,
                                      check_in: e.target.checked,
                                      user_modified: true,
                                      ai_predicted: false,
                                    },
                                  }));
                                }}
                              />
                              {state.ai_predicted && !state.user_modified && (
                                <Badge variant="soft" color="info" style={{ fontSize: 'var(--font-size-xs)' }}>
                                  AI
                                </Badge>
                              )}
                            </div>
                          );
                        },
                      },
                      {
                        key: 'check_out',
                        label: terms.CHECK_OUT_LABEL,
                        width: '15%',
                        align: 'center' as const,
                        render: (_, student) => {
                          const state = studentAttendanceStates[student.id] || {
                            student_id: student.id,
                            check_in: false,
                            check_out: false,
                            status: 'present' as AttendanceStatus,
                            ai_predicted: false,
                            user_modified: false,
                          };

                          return (
                            <Checkbox
                              checked={state.check_out}
                              onChange={(e) => {
                                setStudentAttendanceStates(prev => ({
                                  ...prev,
                                  [student.id]: {
                                    ...state,
                                    check_out: e.target.checked,
                                    user_modified: true,
                                    ai_predicted: false,
                                  },
                                }));
                              }}
                            />
                          );
                        },
                      },
                      {
                        key: 'status',
                        label: '상태',
                        width: '20%',
                        align: 'center' as const,
                        render: (_, student) => {
                          const state = studentAttendanceStates[student.id] || {
                            student_id: student.id,
                            check_in: false,
                            check_out: false,
                            status: 'present' as AttendanceStatus,
                            ai_predicted: false,
                            user_modified: false,
                          };

                          return (
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)', justifyContent: 'center', flexWrap: 'wrap' }}>
                              {state.status === 'late' && (
                                <Badge variant="solid" color="warning">{terms.LATE_LABEL}</Badge>
                              )}
                              {state.status === 'absent' && (
                                <Badge variant="solid" color="error">{terms.ABSENCE_LABEL}</Badge>
                              )}
                              {state.status === 'excused' && (
                                <Badge variant="solid" color="info">{terms.EXCUSED_LABEL}</Badge>
                              )}
                              {state.status === 'present' && state.check_in && (
                                <Badge variant="solid" color="success">{terms.PRESENT_LABEL}</Badge>
                              )}
                            </div>
                          );
                        },
                      },
                      {
                        key: 'status_select',
                        label: '상태 변경',
                        width: '20%',
                        render: (_, student) => {
                          const state = studentAttendanceStates[student.id] || {
                            student_id: student.id,
                            check_in: false,
                            check_out: false,
                            status: 'present' as AttendanceStatus,
                            ai_predicted: false,
                            user_modified: false,
                          };

                          return (
                            <Select
                              value={state.status}
                              onChange={(e) => {
                                setStudentAttendanceStates(prev => ({
                                  ...prev,
                                  [student.id]: {
                                    ...state,
                                    status: e.target.value as AttendanceStatus,
                                    user_modified: true,
                                    ai_predicted: false,
                                  },
                                }));
                              }}
                              options={[
                                { value: 'present', label: terms.PRESENT_LABEL },
                                { value: 'late', label: terms.LATE_LABEL },
                                { value: 'absent', label: terms.ABSENCE_LABEL },
                                { value: 'excused', label: terms.EXCUSED_LABEL },
                              ]}
                              size="sm"
                            />
                          );
                        },
                      },
                    ]}
                  />
                )}
                      {filteredStudents.map(student => {
                    const state = studentAttendanceStates[student.id] || {
                      student_id: student.id,
                      check_in: false,
                      check_out: false,
                      status: 'present' as AttendanceStatus,
                      ai_predicted: false,
                      user_modified: false,
                    };

                    // 학생 정보 확장 (아키텍처 문서 3.3.3: 학년/수업, 사진 표시)
                    const studentWithExtras = student as Student & { primary_class_name?: string };
                    const studentGrade = student.grade ? `${student.grade}${terms.GRADE_LABEL}` : '';
                    const studentClass = studentWithExtras.primary_class_name || '';
                    const gradeClassInfo = [studentGrade, studentClass].filter(Boolean).join(' ');

                    return (
                      <Card key={student.id} padding="lg">
                        <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-md)', flexWrap: 'wrap' }}>
                          {/* StudentInfo: 이름, 학년/수업, 사진 (아키텍처 문서 3.3.3) */}
                          <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', flex: 1, minWidth: 'var(--width-student-info-min)' }}>
                            {/* 사진 (선택) */}
                            {student.profile_image_url && (
                              <img
                                src={student.profile_image_url}
                                alt={student.name}
                                loading="lazy"
                                decoding="async"
                                style={{
                                  width: 'var(--spacing-xl)',
                                  height: 'var(--spacing-xl)',
                                  borderRadius: 'var(--border-radius-full)',
                                  objectFit: 'cover',
                                  flexShrink: 0,
                                }}
                              />
                            )}
                            <div style={{ flex: 1 }}>
                              {/* 아키텍처 문서 3.3.9: 태블릿 모드 기본 텍스트 최소 16px */}
                              <div style={{
                                fontSize: isTabletMode ? 'max(var(--font-size-lg), var(--tablet-font-size-text-min))' : 'var(--font-size-lg)',
                                fontWeight: 'var(--font-weight-semibold)',
                                marginBottom: 'var(--spacing-xs)'
                              }}>
                                {student.name}
                              </div>
                              {gradeClassInfo && (
                                <div style={{
                                  fontSize: isTabletMode ? 'max(var(--font-size-sm), var(--tablet-font-size-text-min))' : 'var(--font-size-sm)',
                                  color: 'var(--color-text-secondary)',
                                  marginBottom: 'var(--spacing-xs)'
                                }}>
                                  {gradeClassInfo}
                                </div>
                              )}
                            </div>
                          </div>

                          {/* AttendanceStatus: 등원 체크박스, 하원 체크박스, 지각/결석 배지, AI 예측 표시 (아키텍처 문서 3.3.3) */}
                          <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-md)', flexWrap: 'wrap' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)', cursor: 'pointer' }}>
                              <Checkbox
                                checked={state.check_in}
                                onChange={(e) => {
                                  setStudentAttendanceStates(prev => ({
                                    ...prev,
                                    [student.id]: {
                                      ...state,
                                      check_in: e.target.checked,
                                      user_modified: true, // 사용자 입력 시 AI 데이터 override
                                      ai_predicted: false, // 사용자 수정 시 AI 예측 플래그 제거
                                    },
                                  }));
                                }}
                              />
                              <span>{terms.CHECK_IN_LABEL}</span>
                              {state.ai_predicted && !state.user_modified && (
                                <Badge variant="soft" color="info" style={{ fontSize: 'var(--font-size-xs)' }}>
                                  AI 예측
                                </Badge>
                              )}
                            </label>
                            <label style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)', cursor: 'pointer' }}>
                              <Checkbox
                                checked={state.check_out}
                                onChange={(e) => {
                                  setStudentAttendanceStates(prev => ({
                                    ...prev,
                                    [student.id]: {
                                      ...state,
                                      check_out: e.target.checked,
                                      user_modified: true, // 사용자 입력 시 AI 데이터 override
                                      ai_predicted: false, // 사용자 수정 시 AI 예측 플래그 제거
                                    },
                                  }));
                                }}
                              />
                              <span>{terms.CHECK_OUT_LABEL}</span>
                            </label>
                            {/* 지각/결석 배지 (아키텍처 문서 3.3.3) */}
                            {state.status === 'late' && (
                              <Badge variant="solid" color="warning">{terms.LATE_LABEL}</Badge>
                            )}
                            {state.status === 'absent' && (
                              <Badge variant="solid" color="error">{terms.ABSENCE_LABEL}</Badge>
                            )}
                            {state.status === 'excused' && (
                              <Badge variant="solid" color="info">{terms.EXCUSED_LABEL}</Badge>
                            )}
                            {/* 상태 변경 Select (배지와 함께 사용) */}
                            <Select
                              value={state.status}
                              onChange={(value) => {
                                setStudentAttendanceStates(prev => ({
                                  ...prev,
                                  [student.id]: {
                                    ...state,
                                    status: (Array.isArray(value) ? value[0] : value) as AttendanceStatus,
                                    user_modified: true, // 사용자 입력 시 AI 데이터 override
                                    ai_predicted: false, // 사용자 수정 시 AI 예측 플래그 제거
                                  },
                                }));
                              }}
                              style={{ minWidth: 'var(--width-grid-column)' }}
                            >
                              <option value="present">{terms.PRESENT_LABEL}</option>
                              <option value="late">{terms.LATE_LABEL}</option>
                              <option value="absent">{terms.ABSENCE_LABEL}</option>
                              <option value="excused">{terms.EXCUSED_LABEL}</option>
                            </Select>
                          </div>

                          {/* ActionButtons: 등원 버튼, 하원 버튼, 상세 보기 버튼 (아키텍처 문서 3.3.3) */}
                          {/* 아키텍처 문서 3.3.9: 태블릿 모드에서는 큰 터치 버튼 (등원/하원 버튼 최소 80px × 80px) */}
                          {/* 아키텍처 문서 3.3.9: 태블릿 모드 버튼 간 간격 최소 8px */}
                          <div style={{ display: 'flex', alignItems: 'center', gap: isTabletMode ? 'max(var(--spacing-sm), var(--tablet-spacing-min))' : 'var(--spacing-xs)', flexWrap: 'wrap' }}>
                            <Button
                              variant="outline"
                              size={isTabletMode ? 'lg' : 'sm'}
                              onClick={() => {
                                setStudentAttendanceStates(prev => ({
                                  ...prev,
                                  [student.id]: {
                                    ...state,
                                    check_in: !state.check_in,
                                    user_modified: true,
                                    ai_predicted: false,
                                  },
                                }));
                              }}
                              style={isTabletMode ? {
                                minWidth: 'var(--spacing-bottom-action-bar)',
                                minHeight: 'var(--spacing-bottom-action-bar)',
                                fontSize: 'max(var(--font-size-lg), var(--tablet-font-size-button-min))', // 아키텍처 문서 3.3.9: 버튼 텍스트 최소 18px
                              } : undefined}
                            >
                              {terms.CHECK_IN_LABEL}
                            </Button>
                            <Button
                              variant="outline"
                              size={isTabletMode ? 'lg' : 'sm'}
                              onClick={() => {
                                setStudentAttendanceStates(prev => ({
                                  ...prev,
                                  [student.id]: {
                                    ...state,
                                    check_out: !state.check_out,
                                    user_modified: true,
                                    ai_predicted: false,
                                  },
                                }));
                              }}
                              style={isTabletMode ? {
                                minWidth: 'var(--spacing-bottom-action-bar)',
                                minHeight: 'var(--spacing-bottom-action-bar)',
                                fontSize: 'max(var(--font-size-lg), var(--tablet-font-size-button-min))', // 아키텍처 문서 3.3.9: 버튼 텍스트 최소 18px
                              } : undefined}
                            >
                              {terms.CHECK_OUT_LABEL}
                            </Button>
                            <Button
                              variant="ghost"
                              size={isTabletMode ? 'md' : 'sm'}
                              onClick={() => safeNavigate(ROUTES.STUDENT_DETAIL(student.id, 'info'))}
                              style={isTabletMode ? {
                                minWidth: 'var(--spacing-xl)',
                                minHeight: 'var(--spacing-xl)',
                              } : undefined}
                            >
                              상세
                            </Button>
                          </div>
                        </div>
                      </Card>
                    );
                  })}
                    </Grid>
                  ) : (
                    // 모바일/PC: 1열 리스트 형태 (아키텍처 문서 431줄: Mobile 1열, 408줄: PC 테이블 형태는 출결 화면에서는 카드 사용)
                    filteredStudents.map(student => {
                      const state = studentAttendanceStates[student.id] || {
                        student_id: student.id,
                        check_in: false,
                        check_out: false,
                        status: 'present' as AttendanceStatus,
                        ai_predicted: false,
                        user_modified: false,
                      };

                      // 학생 정보 확장 (아키텍처 문서 3.3.3: 학년/수업, 사진 표시)
                      const studentWithExtras = student as Student & { primary_class_name?: string };
                      const studentGrade = student.grade ? `${student.grade}${terms.GRADE_LABEL}` : '';
                      const studentClass = studentWithExtras.primary_class_name || '';
                      const gradeClassInfo = [studentGrade, studentClass].filter(Boolean).join(' ');

                      return (
                        <Card key={student.id} padding="lg">
                          <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-md)', flexWrap: 'wrap' }}>
                            {/* StudentInfo: 이름, 학년/수업, 사진 (아키텍처 문서 3.3.3) */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', flex: 1, minWidth: 'var(--width-student-info-min)' }}>
                              {/* 사진 (선택) */}
                              {student.profile_image_url && (
                                <img
                                  src={student.profile_image_url}
                                  alt={student.name}
                                  loading="lazy"
                                  decoding="async"
                                  style={{
                                    width: 'var(--spacing-xl)',
                                    height: 'var(--spacing-xl)',
                                    borderRadius: 'var(--border-radius-full)',
                                    objectFit: 'cover',
                                    flexShrink: 0,
                                  }}
                                />
                              )}
                              <div style={{ flex: 1 }}>
                                <div style={{ fontSize: 'var(--font-size-lg)', fontWeight: 'var(--font-weight-semibold)', marginBottom: 'var(--spacing-xs)' }}>
                                  {student.name}
                                </div>
                                {gradeClassInfo && (
                                  <div style={{ color: 'var(--color-text-secondary)', marginBottom: 'var(--spacing-xs)' }}>
                                    {gradeClassInfo}
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* AttendanceStatus: 등원 체크박스, 하원 체크박스, 지각/결석 배지, AI 예측 표시 (아키텍처 문서 3.3.3) */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-md)', flexWrap: 'wrap' }}>
                              <label style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)', cursor: 'pointer' }}>
                                <Checkbox
                                  checked={state.check_in}
                                  onChange={(e) => {
                                    setStudentAttendanceStates(prev => ({
                                      ...prev,
                                      [student.id]: {
                                        ...state,
                                        check_in: e.target.checked,
                                        user_modified: true, // 사용자 입력 시 AI 데이터 override
                                        ai_predicted: false, // 사용자 수정 시 AI 예측 플래그 제거
                                      },
                                    }));
                                  }}
                                />
                                <span>{terms.CHECK_IN_LABEL}</span>
                                {state.ai_predicted && !state.user_modified && (
                                  <Badge variant="soft" color="info" style={{ fontSize: 'var(--font-size-xs)' }}>
                                    AI 예측
                                  </Badge>
                                )}
                              </label>
                              <label style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)', cursor: 'pointer' }}>
                                <Checkbox
                                  checked={state.check_out}
                                  onChange={(e) => {
                                    setStudentAttendanceStates(prev => ({
                                      ...prev,
                                      [student.id]: {
                                        ...state,
                                        check_out: e.target.checked,
                                        user_modified: true, // 사용자 입력 시 AI 데이터 override
                                        ai_predicted: false, // 사용자 수정 시 AI 예측 플래그 제거
                                      },
                                    }));
                                  }}
                                />
                                <span>{terms.CHECK_OUT_LABEL}</span>
                              </label>
                              {/* 지각/결석 배지 (아키텍처 문서 3.3.3) */}
                              {state.status === 'late' && (
                                <Badge variant="solid" color="warning">{terms.LATE_LABEL}</Badge>
                              )}
                              {state.status === 'absent' && (
                                <Badge variant="solid" color="error">{terms.ABSENCE_LABEL}</Badge>
                              )}
                              {state.status === 'excused' && (
                                <Badge variant="solid" color="info">{terms.EXCUSED_LABEL}</Badge>
                              )}
                              {/* 상태 변경 Select (배지와 함께 사용) */}
                              <Select
                                value={state.status}
                                onChange={(value) => {
                                  setStudentAttendanceStates(prev => ({
                                    ...prev,
                                    [student.id]: {
                                      ...state,
                                      status: (Array.isArray(value) ? value[0] : value) as AttendanceStatus,
                                      user_modified: true, // 사용자 입력 시 AI 데이터 override
                                      ai_predicted: false, // 사용자 수정 시 AI 예측 플래그 제거
                                    },
                                  }));
                                }}
                                style={{ minWidth: 'var(--width-grid-column)' }}
                              >
                                <option value="present">{terms.PRESENT_LABEL}</option>
                                <option value="late">{terms.LATE_LABEL}</option>
                                <option value="absent">{terms.ABSENCE_LABEL}</option>
                                <option value="excused">{terms.EXCUSED_LABEL}</option>
                              </Select>
                            </div>

                            {/* ActionButtons: 등원 버튼, 하원 버튼, 상세 보기 버튼 (아키텍처 문서 3.3.3) */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)', flexWrap: 'wrap' }}>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => {
                                  setStudentAttendanceStates(prev => ({
                                    ...prev,
                                    [student.id]: {
                                      ...state,
                                      check_in: !state.check_in,
                                      user_modified: true,
                                      ai_predicted: false,
                                    },
                                  }));
                                }}
                              >
                                {terms.CHECK_IN_LABEL}
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => {
                                  setStudentAttendanceStates(prev => ({
                                    ...prev,
                                    [student.id]: {
                                      ...state,
                                      check_out: !state.check_out,
                                      user_modified: true,
                                      ai_predicted: false,
                                    },
                                  }));
                                }}
                              >
                                {terms.CHECK_OUT_LABEL}
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => safeNavigate(ROUTES.STUDENT_DETAIL(student.id, 'info'))}
                              >
                                상세
                              </Button>
                            </div>
                          </div>
                        </Card>
                      );
                    })
                  )
                )}
              </div>

              {/* AttendanceActions: 일괄 등원/하원/저장 버튼 (아키텍처 문서 3.3.3: StudentList 다음에 Actions) */}
              {/* 모바일: Bottom Action Bar, 태블릿/데스크톱: Card */}
              {/* 아키텍처 문서 3.3.9: 태블릿 모드에서는 큰 터치 버튼 (최소 120px × 60px) */}
              {isMobileMode ? (
                <BottomActionBar style={{ pointerEvents: isLoading ? 'none' : 'auto', opacity: isLoading ? 'var(--opacity-loading)' : 'var(--opacity-full)' }}>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={handleBulkCheckIn}
                    disabled={isSaving || isLoading}
                  >
                    일괄 {terms.CHECK_IN_LABEL}
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={handleBulkCheckOut}
                    disabled={isSaving || isLoading}
                  >
                    일괄 {terms.CHECK_OUT_LABEL}
                  </Button>
                  <div style={{ flex: 1 }} />
                  <Button
                    variant="solid"
                    color="primary"
                    size="sm"
                    onClick={handleSaveAttendance}
                    disabled={isSaving || isLoading}
                  >
                    {isSaving ? terms.MESSAGES.LOADING : terms.MESSAGES.SAVE}
                  </Button>
                </BottomActionBar>
              ) : (
                <Card padding="lg" style={{ marginBottom: 'var(--spacing-xl)', pointerEvents: isLoading ? 'none' : 'auto', opacity: isLoading ? 'var(--opacity-loading)' : 'var(--opacity-full)' }}>
                  <div style={{ display: 'flex', gap: isTabletMode ? 'max(var(--spacing-md), var(--tablet-spacing-min))' : 'var(--spacing-sm)', flexWrap: 'wrap' }}> {/* 아키텍처 문서 3.3.9: 버튼 간 간격 최소 8px */}
                    <Button
                      variant="outline"
                      size={isTabletMode ? 'lg' : 'md'}
                      onClick={handleBulkCheckIn}
                      disabled={isSaving || isLoading}
                      style={isTabletMode ? {
                        minWidth: 'var(--width-button-min)',
                        minHeight: 'var(--height-button-min)',
                        fontSize: 'max(var(--font-size-lg), var(--tablet-font-size-button-min))', // 아키텍처 문서 3.3.9: 버튼 텍스트 최소 18px
                      } : undefined}
                    >
                      일괄 {terms.CHECK_IN_LABEL}
                    </Button>
                    <Button
                      variant="outline"
                      size={isTabletMode ? 'lg' : 'md'}
                      onClick={handleBulkCheckOut}
                      disabled={isSaving || isLoading}
                      style={isTabletMode ? {
                        minWidth: 'var(--width-button-min)',
                        minHeight: 'var(--height-button-min)',
                        fontSize: 'max(var(--font-size-lg), var(--tablet-font-size-button-min))', // 아키텍처 문서 3.3.9: 버튼 텍스트 최소 18px
                      } : undefined}
                    >
                      일괄 {terms.CHECK_OUT_LABEL}
                    </Button>
                    <div style={{ flex: 1 }} />
                    {/* 통계 기능은 통계 또는 AI 인사이트 메뉴로 이동 (아키텍처 문서 3.3.8) */}
                    <Button
                      variant="solid"
                      color="primary"
                      size={isTabletMode ? 'lg' : 'md'}
                      onClick={handleSaveAttendance}
                      disabled={isSaving || isLoading}
                      style={isTabletMode ? {
                        minWidth: 'var(--width-button-min)',
                        minHeight: 'var(--height-button-min)',
                        fontSize: 'max(var(--font-size-lg), var(--tablet-font-size-button-min))', // 아키텍처 문서 3.3.9: 버튼 텍스트 최소 18px
                      } : undefined}
                    >
                      {isSaving ? `${terms.MESSAGES.LOADING}` : terms.MESSAGES.SAVE}
                    </Button>
                  </div>
                </Card>
              )}
        </>

        {/* 통계/히트맵/패턴 분석 기능은 통계 또는 AI 인사이트 메뉴로 이동 (아키텍처 문서 3.3.8) */}
      </Container>
    </ErrorBoundary>
  );
}
