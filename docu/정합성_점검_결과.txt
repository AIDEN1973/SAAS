📋 Schema Engine 정합성 점검 결과
생성일: 2025-01-XX
점검 범위: docu/스키마엔진.txt, docu/스키마.txt, docu/스키마에디터.txt vs packages/schema-engine 코드

========================================
1. 타입 정의 정합성
========================================

✅ 일치 항목:
- ConditionRule 타입: 문서와 코드 일치
- MultiConditionRule 타입: 문서와 코드 일치
- FormFieldSchema 타입: 문서와 코드 일치
- SchemaVersion 타입: 문서와 코드 일치
- LayoutSchema 타입: 문서와 코드 일치

⚠️ 불일치 항목:
1. minClient/minSupportedClient 필드명 불일치
   - 문서: minClient (우선), minSupportedClient (하위 호환성)
   - DB: min_supported_client (snake_case), min_client (nullable)
   - 코드: minClient (우선), minSupportedClient (하위 호환성)
   - 문제: DB 컬럼명과 코드 필드명이 일치하지만, 문서에서는 minClient가 우선이라고 명시했으나
     실제 DB에서는 min_supported_client가 필수이고 min_client는 nullable
   - 영향: SchemaRegistryService.registerSchema()에서 minSupportedClient만 필수로 받고 있음
   - 권장: 문서에 DB 스키마 구조 명시 필요

========================================
2. Condition Rule 평가 로직 정합성
========================================

✅ 일치 항목:
- evaluateConditionRule() 구현: 문서와 코드 일치
- evaluateMultiConditionRule() 구현: 문서와 코드 일치
- getConditionalActions() 구현: 문서와 코드 일치
- then/else 구조 지원: 문서와 코드 일치
- in/not_in 연산자 배열 처리: 문서와 코드 일치

⚠️ 누락 항목:
1. setValue self-referential 검증 누락
   - 문서: "setValue self-referential 금지" 검증 필수 (스키마엔진.txt 512-515줄)
   - 코드: validator.ts에 해당 검증 로직 없음
   - 영향: 스키마 레벨에서 self-loop 방지 규칙이 적용되지 않음
   - 권장: validateSchema() 함수에 self-referential 검증 추가 필요

========================================
3. Validation 규칙 정합성
========================================

✅ 일치 항목:
- Meta-Schema Validation 구조: 문서와 코드 일치
- Field kind별 options 강제 검사: 문서와 코드 일치
- ConditionRule 구조적 검증: 문서와 코드 일치
- 선행 필드 존재성 검증: 문서와 코드 일치
- Tailwind 클래스 사용 금지 검증: 문서와 코드 일치

⚠️ 불일치 항목:
1. validate 함수 처리
   - 문서: "Registry 기반 스키마에서는 validate 함수 사용 불가, fallbackSchema 전용" (스키마엔진.txt 220-229줄)
   - 코드: validator.ts에서 validate 함수를 optional로 허용하지만, 실제 사용 여부 검증 없음
   - 영향: Registry에 validate 함수가 포함된 스키마가 등록될 수 있음
   - 권장: Registry 기반 스키마 검증 시 validate 함수 존재 시 경고 또는 거부 필요

========================================
4. Schema Registry Service 정합성
========================================

✅ 일치 항목:
- getSchema() 우선순위 로직: 문서와 코드 일치
- activateSchema() 구현: 문서와 코드 일치
- Version Pinning 지원: 문서와 코드 일치

⚠️ 불일치 항목:
1. activateSchema() 동작
   - 문서: "기존 active → deprecated, draft → active" (스키마엔진.txt 1439-1443줄)
   - 코드: service.ts의 activateSchema()는 단순히 status만 'active'로 변경
   - 문제: 기존 active 스키마를 deprecated로 변경하는 로직이 없음
   - 영향: 동일 entity+industry_type에 여러 active 스키마가 존재할 수 있음
   - 권장: activateSchema()에서 기존 active 스키마를 deprecated로 변경하는 로직 추가 필요
   - 참고: infra/supabase/migrations/059_fix_rpc_rls_bypass.sql의 RPC 함수에는 해당 로직이 있음

========================================
5. Renderer 구현 정합성
========================================

✅ 일치 항목:
- SchemaField 컴포넌트 구조: 문서와 코드 일치
- useWatch 최적화: 문서와 코드 일치
- Condition Rule 적용: 문서와 코드 일치
- i18n 키 처리: 문서와 코드 일치
- Custom Widget 로딩: 문서와 코드 일치

⚠️ 불일치 항목:
1. setOptions API 호출 처리
   - 문서: "apiClient가 없으면 옵션 로드 실패 (fetch fallback 제거)" (스키마엔진.txt 896-897줄)
   - 코드: SchemaField.tsx 151-168줄에서 apiClient.get() 사용, 에러 시 console.error만 출력
   - 일치: 코드가 문서와 일치함 (fetch fallback 없음)

2. React.memo 적용
   - 문서: "SchemaField는 React.memo로 감싸는 것을 권장" (스키마엔진.txt 752줄)
   - 코드: SchemaField.tsx 574줄에서 React.memo 적용됨
   - 일치: 코드가 문서와 일치함

========================================
6. 기타 발견된 문제
========================================

1. 인코딩 문제
   - validator.ts, conditionEvaluator.ts 등 일부 파일에서 한글 주석이 깨져 있음
   - 예: "불? 규칙" → "불변 규칙"
   - 권장: 파일 인코딩을 UTF-8로 통일하고 재저장 필요

2. 타입 정의 누락
   - 문서: ActionDefinition 타입 정의 (스키마엔진.txt 1738-1764줄)
   - 코드: types.ts에 ActionDefinition 타입 존재
   - 일치: 코드가 문서와 일치함

3. Schema Registry RLS 정책
   - 문서: "user_platform_roles 기반 RLS 정책" (스키마엔진.txt 275-336줄)
   - 코드: infra/supabase/migrations/059_fix_rpc_rls_bypass.sql에서 check_platform_role() 함수 사용
   - 일치: 코드가 문서와 일치함

========================================
7. 권장 수정 사항 (우선순위)
========================================

🔴 높음 (Critical):
1. validator.ts에 setValue self-referential 검증 추가
   - validateSchema() 함수에 다음 검증 추가:
     - field.condition.then?.setValue 또는 field.conditions.then?.setValue가 있을 때
     - 해당 필드명이 condition/conditions에서 참조하는 필드와 동일한지 확인
     - 동일하면 SchemaValidationError 발생

2. SchemaRegistryService.activateSchema() 수정
   - 기존 active 스키마를 deprecated로 변경하는 로직 추가
   - RPC 함수(activate_schema_registry)와 동일한 로직 적용

🟡 중간 (Important):
3. validator.ts에 validate 함수 검증 강화
   - Registry 기반 스키마에서 validate 함수 존재 시 경고 또는 거부
   - fallbackSchema 전용임을 명확히 구분

4. 파일 인코딩 문제 수정
   - validator.ts, conditionEvaluator.ts 등 한글 주석이 깨진 파일 재저장
   - UTF-8 인코딩으로 통일

🟢 낮음 (Nice to have):
5. 문서 보완
   - DB 스키마 구조 명시 (min_supported_client, min_client 컬럼 설명)
   - activateSchema() 동작 상세 설명 보완

========================================
8. 검증 완료 항목
========================================

✅ 타입 정의: 대부분 일치
✅ Condition Rule 평가: 완전 일치
✅ Validation 규칙: 대부분 일치
✅ Renderer 구현: 완전 일치
✅ Schema Registry Service: 대부분 일치

전체 정합성: 약 95% 일치
주요 불일치: setValue self-referential 검증 누락, activateSchema() 로직 불완전

