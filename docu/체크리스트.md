# 새 기능 구현 시 필수 체크리스트

**버전**: 1.8.0
**최종 업데이트**: 2025-01-27
**관련 문서**: `docu/rules.md`, `docu/SSOT_UI_DESIGN.md`, `packages/shared-catalog.ts`, `P0 이슈 지시문`, `P1 이슈 지시문`, `P2 이슈 지시문`

---

## 📋 개요

새로운 `.ts`, `.tsx` 파일을 생성할 때 반드시 확인하고 준수해야 하는 기준들을 정리한 문서입니다.

**기존 파일 검증**: 이 체크리스트는 기존 파일 검증에도 사용 가능하나, 우선순위와 예외 처리가 다릅니다 (아래 "기존 파일 검증 가이드라인" 참조).

---

## 🔴 P0: 즉시 장애/보안 위험 (절대 금지)

### 1. 보안 및 멀티테넌트 격리

- [ ] **RLS 우회 금지**: `apiClient.get()`에서 `withTenant()` 필수 사용 (SELECT/UPDATE/DELETE)
- [ ] **INSERT 패턴**: INSERT는 `withTenant()` 사용 금지, `tenant_id`를 row object에 직접 포함
- [ ] **JWT claim 기반 RLS**: `set_config('app.current_tenant_id')` 기반 RLS 금지 (Transaction Pooling 환경)
- [ ] **Service Role Key**: 프론트엔드 코드에서 절대 사용 금지
- [ ] **환경변수 접근**: 서버/Edge 코드는 `@env-registry/server`의 `envServer` 사용 (process.env 직접 사용 금지)
- [ ] **클라이언트 환경변수**: 클라이언트 코드는 `envServer` import 금지, `NEXT_PUBLIC_*` 또는 `envClient`만 사용
- [ ] **권한 혼용 금지**: `tenant_id` / `role` / `platform` 권한 혼용 금지 (각각 독립적으로 처리)
- [ ] **메타 스키마 접근**: `meta.schema_registry`, `platform RBAC` 접근 시 권한 검증 필수
- [ ] **프론트 권한 추론 금지**: 프론트에서 권한 추론/생성 금지 (권한은 RLS/JWT claim 기반으로만 결정)
- [ ] **인증/권한 검증 필수**: Edge/Server에서 JWT 검증/권한 검증 없이 데이터 조회/변경 수행 금지
- [ ] **데이터 삭제/파괴 방지**: DELETE/UPDATE가 tenant scope(또는 RLS) 보장 없이 실행될 수 있는 경로 금지
- [ ] **findTenantByDomain() 함수 규칙**: `findTenantByDomain()` 함수는 반드시 `packages/services/tenant-service.ts` 안에 존재
  - 시그니처: `(domain: string) => Promise<{ id: uuid, tenant_id: uuid, status: string } | null>`
  - 반환 객체 필드 수 정확히 3개 (id, tenant_id, status 외 추가 필드 금지)
  - 추가 파라미터 금지
- [ ] **Custom Domain 보안**: Public Gateway Token 보안 - Signed token 기반 invoice 접근 (HMAC-SHA256)
  - 만료 시간: 10분 (KST 기준)
  - jti(jwt id) 포함

### 2. Fail-Closed 원칙 (Automation Config First)

- [ ] **기본값 금지**: "값이 없으면 기본값 사용" 패턴 금지
- [ ] **정본 패턴**: 설정이 없으면 실행하지 않음 (Fail Closed)
- [ ] **하드코딩 조건 금지**: 자동화 실행 조건을 코드 상수로 하드코딩 금지
- [ ] **Policy 기반 실행**: 모든 자동화는 Policy/Threshold/Toggle 기반으로만 실행
- [ ] **실행 결정 vs 실행 파라미터 구분**: Enabled Gate와 Channel/Provider Gate 구분 필수
  - 1단계: 실행 결정 - `auto_notification.<event_type>.enabled` 없으면 실행 안 함 (FAIL CLOSED)
  - 2단계: 실행 파라미터 - 실행이 이미 결정된 후 채널/인프라 파라미터: `notification.*`을 기본으로 사용 가능
  - `enabled`는 `notification.*`로 fallback 되지 않음

### 3. SSOT 정본 준수

- [ ] **정본 문서 우선**: 정본 문서(아키텍처 문서 > 프론트 자동화 문서 > README)와 불일치 금지
- [ ] **AUTOMATION_EVENT_CATALOG**: 카탈로그에 없는 `event_type` 실행/추가 금지
- [ ] **DOMAIN_ACTION_CATALOG**: 카탈로그에 없는 `action_key` 실행/추가 금지 (L2-B Intent 필수)
- [ ] **Policy 경로**: `POLICY_REGISTRY`를 통하지 않은 경로 문자열 직접 사용 금지
- [ ] **입력 정규화 레이어 필수**: DashboardCard 생성 시 `normalizeDashboardCard()`, `normalizeDashboardCards()` 등 SSOT 정규화 함수 필수 사용 (데이터 무결성 파괴 방지)
  - 위치: `apps/academy-admin/src/utils/dashboard-card-normalization.ts`
  - 사용 예: `const normalizedCards = normalizeDashboardCards(cards);`
- [ ] **금지된 legacy 경로 사용 금지**: 금지된 legacy 경로가 실제 실행에 사용됨 금지
  - 예: `student_task_cards` vs `task_cards` (금지 키워드: `task_cards` 직접 조회, `apiClient.get('task_cards')` 등)

### 4. PII 마스킹 (Critical)

- [ ] **PII 마스킹 필수**: 로그/모니터링 코드에서 전화번호·이메일·이름 등 PII는 `maskPII()`를 통해서만 출력
- [ ] **중앙 모듈 사용**: `@core/pii-utils` 또는 `@core-config/pii-utils`에서 import (직접 정의 금지)
- [ ] **개발 환경 포함**: 개발 환경(`import.meta.env?.DEV`)에서도 PII 마스킹 적용 필수
- [ ] **logger 사용 시**: `logger.debug/info/warn` 등에 사용자 객체 전체 전달 금지, `maskPII()` 적용 필수

### 5. 알림/경고 모달 규칙 (Critical)

- [ ] **네이티브 alert 금지**: `window.alert()`, `window.confirm()`, `window.prompt()` 사용 금지
- [ ] **커스텀 모달 사용**: `useModal().showAlert()`, `useModal().showConfirm()` 또는 커스텀 Modal 컴포넌트 사용

### 6. API 호출 규칙 (Zero-Trust)

- [ ] **@api-sdk/core 사용**: Edge Function 호출도 반드시 `@api-sdk/core`를 통해서만 수행
- [ ] **직접 호출 금지**: UI에서 `fetch/axios` 직접 호출 금지 (`@api-sdk/core` 외부에서 API 요청 금지)
- [ ] **React 컴포넌트**: React 컴포넌트에서 Supabase 직접 호출 금지, DB 쿼리/SQL 직접 작성 금지
- [ ] **Zero-Trust 원칙**: UI는 `tenant_id`를 입력/URL에서 받거나 직접 주입하지 않음 (컨텍스트에서만 결정)
- [ ] **getApiContext() 사용**: `tenantId`는 반드시 `getApiContext()`에서만 가져옴 (`@api-sdk/core`에서 import)
  - 예: `const context = getApiContext(); const tenantId = context.tenantId;`
  - UI에서 `tenantId`를 파라미터로 받거나 URL에서 추출하는 패턴 금지
- [ ] **권한 결정**: 정책/권한은 Zero-Trust 원칙에 따라 서버/Edge Function에서만 결정

### 7. 더미 데이터 생성 금지

- [ ] **운영 코드 금지**: 운영 코드(`apps/*`, `services/*`, `hooks/*`) 안에 랜덤 더미 데이터 생성 코드 포함 금지
- [ ] **테스트 전용**: 더미 데이터는 `dev/test/seed` 영역에만 생성

### 8. React Hooks 규칙 (Critical)

- [ ] **조기 return 금지**: 조기 return으로 인한 hooks 호출 순서 불일치 금지
- [ ] **조건부 hooks 금지**: 조건문 안에서 hooks 호출 금지 (항상 동일한 순서로 호출되어야 함)
- [ ] **Hooks 규칙 준수**: React Hooks 규칙을 준수하여 런타임 크래시 방지

### 9. 데이터 무결성 (트랜잭션/원자성)

- [ ] **원자적 처리**: 원자적으로 처리되어야 하는 변경은 트랜잭션/멱등성으로 보장
- [ ] **부분 실패 방지**: 부분 실패 시 데이터 손상 방지 (두 테이블 업데이트 중 하나만 성공 방지)
- [ ] **멱등성 처리**: 자동화/결제/청구/출결은 멱등성 없는 재시도로 중복 레코드 생성 방지
- [ ] **특히 주의**: 자동화/결제/청구/출결은 부분 성공이 P0로 이어지기 쉬움

### 10. Execution Audit 규칙 (P0)

- [ ] **Correlation Key 필수**: `execution_audit_runs` 테이블에 correlation key가 전혀 없는 Run은 금지 (P0)
  - 최소한 `request_id`, `source_event_id`, `diagnostic_id` 중 하나는 반드시 기록
  - 서버 Insert Gate + DB 제약으로 이중 강제
- [ ] **details PII 유입 금지**: `execution_audit_runs.details`는 allowlist 기반으로만 저장
  - allowlist 적용 책임: 서버 Insert Layer (Edge Function / API Server)
  - 2중 방어 권장: DB Trigger로 불허 키 제거/거부
  - 직접 식별 PII(전화번호, 주소, 원문 전문 등) 저장 금지, 참조키만 저장 (예: `message_id`, `vendor_message_id`)
- [ ] **operation_type 형식 강제**: `operation_type`은 kebab-case(하이픈)로 고정
  - 예: `send-sms`, `update-attendance`, `messaging.send-sms`
  - 허용되는 `operation_type`은 `meta.operation_registry`에 등록된 값만 사용 (미등록 금지)
  - 미등록 `operation_type`은 `unknown_operation`으로 기록, `status=failed`, Step 미생성

---

## 🟠 P1: 중장기 운영 리스크 (반드시 체크)

### 1. SSOT 약화 방지

- [ ] **Shared Catalog 등록**: 공통 로직(Hook/Feature/Adapter/Component) 생성 시 `packages/shared-catalog.ts`에 반드시 등록
  - 등록 조건: 2개 이상 사용처가 있거나 재사용 의도가 명확한 경우
  - 필수 항목: `key`, `path`, `import`, `useWhen`, `doNot`, `examples`(2개 이상)
- [ ] **SSOT 복제본 금지**: 동일 SSOT가 2곳 이상 존재하면 안 됨 (단일 수정으로 끝나야 함)
- [ ] **카탈로그 동기화**: `AUTOMATION_EVENT_CATALOG`가 `packages`와 `infra/functions/_shared` 간 불일치 없어야 함
- [ ] **Policy 경로 점(.) 이스케이프**: Policy 경로 키에 점(.) 포함 시 `split('.')` 로직 깨짐 방지 (경로 이스케이프 규칙 확인)
- [ ] **Default Policy vs 코드 상수 구분**: 코드에서 기본값 사용 시 Default Policy인지 코드 상수인지 명확히 구분 (혼동 방지)
- [ ] **Policy 소스 이원화 방지**: `getPolicyValueFromConfig`(config 기반)와 `useTenantSettingByPath`(path 기반) 혼용 시 일관성 유지
- [ ] **Policy Registry 사용**: `POLICY_REGISTRY` 및 `getPolicyValue<T>(key, config)` 함수 사용 (SSOT 위치: `apps/academy-admin/src/utils/policy-registry.ts`)
  - 모든 Policy를 Registry에 등록하여 경로/소스/타입/기본값 명확히 정의
  - Policy 소스 이원화 문제 해결: 단일 소스로 통일
- [ ] **Policy Key v1/v2 혼용 금지**: `legacy_policy_key`와 `policy_key_v2` 이중 저장 또는 혼용 금지 (정본은 v2만 사용)
- [ ] **industry_type enum 통일**: `realestate`/`real_estate`, `beauty_salon`/`salon` 혼용 금지
  - 정본: `academy`, `salon` (beauty_salon 사용 금지), `real_estate` (realestate 사용 금지, 언더스코어 필수)
  - 적용 범위: RLS 정책, Schema Registry, AI Risk Weight, SDUI Override, 라우팅/필터링

### 2. 공통 컴포넌트 사용

- [ ] **UI Core Component 우선**: 새 컴포넌트 생성 전 `packages/ui-core/src/components/` 확인
- [ ] **공통 컴포넌트 카탈로그**: `docu/SSOT_UI_DESIGN.md`의 "언제 무엇을 쓰는지" 결정표 참조
- [ ] **Shared Catalog 등록**: UI Core Component 중 공통 레이아웃/패턴 컴포넌트는 `shared-catalog.ts`의 `components` 섹션에 등록
- [ ] **Theme Engine 규칙**: Theme Merge Priority 준수 (System Default → Industry → Tenant → Dark Mode → High Contrast)
  - 허용되는 오버라이드: 색상 토큰만 (--color-primary, --color-secondary 등)
  - 금지되는 오버라이드: 폰트 패밀리, 간격 토큰, 폰트 크기, 테두리 반경, 그림자
  - Theme이 없을 때: Fail Closed, 기본값 사용
- [ ] **Layout Primitives 상세 규칙**: Container, Grid, SidebarLayout 등 Layout Primitives 사용 규칙 준수
  - Container: 페이지 최대 너비 제한 및 패딩 제공
  - Grid: 그리드 레이아웃 (반응형 컬럼)
  - SidebarLayout: 사이드바 + 메인 콘텐츠 레이아웃
  - Page Templates: Dashboard, List+Detail, Settings 템플릿 규칙
- [ ] **SDUI 연동 규칙**: 스키마에서 표현 가능한 UI 속성만 사용 (ui.variant, ui.density, ui.intent, ui.size, ui.layout.columns, ui.layout.columnGap)
  - 스키마에서 Tailwind 클래스 직접 사용 금지
  - 스키마는 논리적 구조만, 스타일은 core-ui가 담당
- [ ] **Mobile & Tablet UI/UX 규칙**: 모바일 환경에서는 테이블을 카드형 UI로 자동 전환, 확대보기(Zoom) 기능 제공
  - 모바일 환경에서 키패드와 버튼은 터치하기 쉬운 크기와 간격 유지 (최소 44px)
  - 태블릿 환경에서는 ui-core `DataTable`의 컴팩트 모드 사용
  - 모바일 환경에서는 하단 네비게이션 바 사용
  - 모바일 환경에서 폼 입력은 자동 완성, 입력 검증, 오류 메시지 명확히 제공
  - 모바일 환경에서는 이미지 지연 로딩, 가상 스크롤, 코드 스플리팅 적용
  - 모바일 환경에서도 웹 접근성 표준(WCAG 2.1 AA) 준수

### 3. Design Tokens 사용

- [ ] **하드코딩 금지**: px/rem/em/hex/opacity 값 하드코딩 금지
- [ ] **CSS 변수 사용**: 모든 디자인 값은 `var(--spacing-md)`, `var(--color-primary)` 등 CSS 변수 사용
- [ ] **토큰 위치**: `packages/ui-core/src/styles.css`의 Design Tokens 참조
- [ ] **새 토큰 추가**: 새 토큰 추가 시 `styles.css`와 `docu/SSOT_UI_DESIGN.md`에 반드시 추가

### 4. 레이어 분리 및 의존성 방향

- [ ] **의존성 방향 준수**: `apps/* → hooks/* → services/* → industry/* → core/* → DB`
- [ ] **Core → Industry 역전 금지**: Core Layer가 Industry Layer를 import 금지
- [ ] **Industry → Industry 의존성 금지**: 업종 간 의존성 금지
- [ ] **업종별 엔진 금지**: 업종별 Automation/AI 엔진 생성 금지 (Core Engine + Industry Adapter 구조만 허용)
- [ ] **index.ts 타입만 export**: Core/Industry Layer의 `index.ts`는 타입만 export, 서버 코드는 `/service` 경로에서만 import
- [ ] **Barrel export 역전 금지**: `index.ts` 등으로 Core→Industry 또는 Industry→Industry 간접 의존 생성 금지

### 5. 날짜 및 시간 처리 (KST)

- [ ] **toKST() 사용 필수**: 날짜 표시 로직에서 `.toLocaleString()` 직접 사용 금지, `toKST()` 헬퍼 사용
- [ ] **파일명 날짜 형식**: 파일명 생성 시 날짜는 반드시 KST 기준 (`toKST().format('YYYY-MM-DD')`)
- [ ] **toISOString() 직접 사용 금지**: `toISOString().split('T')[0]` 또는 `toISOString().slice(0, 10)` 직접 사용 금지
- [ ] **DB 날짜 처리**: DB에서 KST 기준 날짜 필요 시 `timezone('Asia/Seoul', now())::date` 사용, `CURRENT_DATE` 직접 사용 금지
- [ ] **타임존/상대시간 서버 결정 강제**: ChatOps_계약_붕괴_방지_체계_분석.md 3.6 참조
  - 타임존/상대시간은 서버에서만 결정 (클라이언트 추정 금지)
  - 자연어 상대시간 표현("오늘", "어제", "내일")은 서버에서 KST 기준으로 재확인 필수
  - `normalizeParams`에서 모든 날짜를 서버에서 KST 기준으로 재확인

### 6. 데이터 정규화 규칙 (SSOT)

- [ ] **min_client 정규화**: Schema Registry에서 `min_client` 입력 시 자동으로 `min_supported_client`로 정규화 (DB 트리거 기반)
  - 정본: `min_supported_client` (DB 컬럼), `minSupportedClient` (Schema JSON)
  - 레거시: `min_client`는 읽기만 허용, 저장 시 정규화
- [ ] **action_type 정규화**: `automation_actions.action_type` 저장 시 서버에서 하이픈으로 정규화 필수
  - 정본: `'request-approval'`, `'approve-and-execute'` (하이픈 표기)
  - 레거시: `'approve'`는 서버에서만 `'approve-and-execute'`로 정규화
  - 언더스코어 형태 입력 시 하이픈으로 정규화 후 DB 저장

### 7. 정책 해석 일관성 (P1)

- [ ] **Execution Level 해석 통일**: L0/L1/L2 해석은 정본 기준표(`docu/AI_자동화_기능_정리.md`, `docu/프론트 자동화.md`)에 따라 일관되게 해석
  - L0 (Auto): 정책에 따라 서버가 실행, 승인 불필요
  - L1 (Auto + Notice/Task): 정책에 따라 서버가 실행 + 알림/카드 생성, 승인 불필요
  - L2 (Approval): 승인 필요, 사용자 확인 후 서버가 정책 해석하여 실행
- [ ] **"자동" 용어 해석 통일**: "자동" 표현은 주어를 명시 (AI/서버/프론트 구분 명확)
- [ ] **정책 시점 일관성**: cache key/staleTime/refetch 경로 차이로 정책 적용 시점이 화면/훅마다 달라지지 않도록 통일
- [ ] **Policy Key v2 6개 고정 규칙**: 신규 자동화 추가 시 Policy Key를 늘리는 대신 `event_type` 카탈로그에 추가
  - 정본 Policy Key v2: `financial_health`, `capacity_optimization`, `customer_retention`, `growth_marketing`, `safety_compliance`, `workforce_ops`
  - Legacy Policy Key v1: `attendance_anomaly`, `payment_overdue`, `ai_suggestion`, `report_generation`, `dashboard_priority` (alias-only, 저장 경로로 사용 금지)

### 8. 확장 시 동기화 (P1)

- [ ] **업종 추가 시 전 계층 동기화**: 업종 추가 시 `industry_type` enum, RLS 정책, Schema Registry, AI Risk Weight 등 전 계층 동기화 필수
- [ ] **업종별 데이터 분리 전략**: 기본 철학은 "단일 테이블 + industry_type 컬럼 + Soft Isolation"
  - 업종별 데이터 분리 전환 기준표 참조 (`docu/rules.md` 13장)
  - Cursor는 industry-specific prefix 테이블(예: academy_*)을 자동 생성하지 않음
- [ ] **지역 통계 및 지도 기능 규칙**: 지역 통계는 store_count >= 3 조건을 만족할 때만 제공
  - `core_stores` 테이블 쿼리는 반드시 `withTenant()` 사용
  - `analytics.daily_region_metrics`는 집계·익명화된 테이블이므로 RLS 정책이 다를 수 있음
  - `analytics.daily_region_metrics` 조회 시 `withTenant()` 사용하지 않음
- [ ] **Kakao Maps API 사용 규칙**: 주소 → 좌표 변환은 반드시 Kakao Local REST API 사용, 서버/Edge Function에서만 수행
  - REST API 호출은 Next.js Server Components / Route Handlers / Supabase Edge Functions에서만 허용
  - 클라이언트에서는 Kakao JS SDK + JS_KEY만 사용
  - API Key 분리: 클라이언트는 `envClient.NEXT_PUBLIC_KAKAO_JS_KEY`, 서버는 `envServer.KAKAO_REST_API_KEY`
  - `NEXT_PUBLIC_KAKAO_REST_API_KEY` 같은 형태로 클라이언트에 REST API Key 노출 금지
  - GeoJSON 좌표 변환: [lng, lat] → LatLng(lat, lng)
- [ ] **Custom Domain 운영 규칙**: ACME 인증 실패 시 자동 재시도 및 수동 개입 프로세스 정의
  - DNS 연동 실패 시 지수 백오프 패턴으로 자동 재시도
  - 모든 활성 Custom Domain은 24시간마다 자동으로 DNS/SSL 상태 재검증
  - Wildcard SSL 인증서는 특정 조건에서만 사용, 개별 인증서 발급 불가능한 경우에만 Fallback
  - SSL 만료일 모니터링 및 만료 전 고객 알림 발송
- [ ] **event_type 추가 시 문서/코드 동기화**: `AUTOMATION_EVENT_CATALOG`에 `event_type` 추가 시 문서/코드 동기화 필수
- [ ] **동기화 자동 검증**: enum/카탈로그/정책키 동기화를 강제하는 CI/테스트/스크립트 권장 (수동 검증 의존 최소화)

---

## 🟡 P2: 품질 및 유지보수성 (권장)

### 1. 코드 일관성

- [ ] **레이어 태그**: 파일 상단에 `// LAYER: UI_CORE_COMPONENT`, `// LAYER: SHARED_HOOK` 등 태그 추가
- [ ] **에러 처리 패턴**: `safe()`, `safeAll()` 함수 등 SSOT 에러 처리 패턴 사용
  - 위치: `apps/academy-admin/src/utils/error-handling-utils.ts`
  - 사용 예: `const [students, stats] = await Promise.all([safe(fetchStudents(tenantId), []), safe(fetchStats(tenantId), {})]);`
- [ ] **PostgREST 에러 매핑**: PostgREST 에러는 반드시 `AppError`로 매핑하여 사용
  - 예: `23505` → `CONFLICT` (409), `23503` → `NOT_FOUND` (404)
- [ ] **React Query 패턴**: `queryKey`, `staleTime` 등 표준 상수(`CACHE_TIMES` 등) 사용
  - `createQueryKey()` SSOT 유틸리티 사용: `packages/hooks/use-query-key-utils/src/index.ts`
  - `CACHE_TIMES` 상수 사용: 매직 넘버 대신 명명된 상수 사용
- [ ] **네비게이션 보안**: `createSafeNavigate()`, `isSafeInternalPath()` SSOT 유틸리티 사용
  - 위치: `apps/academy-admin/src/utils/navigation-utils.ts`
  - 오픈 리다이렉트 방지: 외부 URL 또는 잘못된 형식은 무시 (Fail Closed)
  - 사용 예: `const safeNavigate = createSafeNavigate(navigate); safeNavigate('/students/list');`
- [ ] **타입 가드 함수**: `ensureArray()`, `ensureNumber()`, `ensureString()` 등 SSOT 타입 가드 함수 사용
  - 위치: `apps/academy-admin/src/utils/error-handling-utils.ts`
  - 사용 예: `const payments = ensureArray(await fetchPayments(tenantId));`
- [ ] **공통 로깅 유틸리티**: `logError()`, `logWarn()`, `logInfo()` SSOT 로깅 함수 사용
  - 위치: `apps/academy-admin/src/utils/logger-utils.ts`
  - 사용 예: `logError('HomePage:Stats', error);`

### 2. 네이밍 및 타입

- [ ] **명확한 네이밍**: 변수/함수/타입 이름이 역할을 명확히 드러냄
- [ ] **타입 표현**: `boolean` 남용 금지, 명확한 union/enum/타입 별칭 사용
- [ ] **unknown/any 최소화**: 정책/권한/이벤트/업종 분기 결정값에 `unknown/any` 사용 시 런타임 가드 필수
- [ ] **타입 신뢰도**: Policy 값 타입 검증 누락 방지 (`getPolicyValueFromConfig` 반환값이 `unknown`이면 런타임 타입 체크 필수)
- [ ] **배열 타입 가드**: API 응답이 배열이라는 보장 없이 배열 메서드 사용 금지 (타입 가드 필수)

### 3. 문서화

- [ ] **주석 추가**: 의도가 중요한 코드에는 설명 추가
- [ ] **SSOT 문서 동기화**: 코드 변경 시 관련 SSOT 문서도 업데이트

### 4. 네이밍 규칙

- [ ] **SQL 네이밍**: 테이블/컬럼은 `snake_case`, 인덱스는 `idx_<table>_<column>`, `ux_<table>_<unique_column>`
- [ ] **TypeScript 네이밍**: 파일명은 `kebab-case` (컴포넌트는 `PascalCase`), 변수명은 `camelCase`
- [ ] **업종 타입**: `industry_type` enum은 `academy`, `salon`, `real_estate` (언더스코어 필수, `realestate` 사용 금지)

### 5. 이모지 사용 금지 (코드 내 절대 금지)

- [ ] **코드 내 이모지 절대 금지**: 모든 코드 파일(`.ts`, `.tsx`, `.js`, `.jsx`)에서 이모지 사용 금지
  - 금지 위치: 주석, 문자열 리터럴, console.log/error/warn/info, 로그 메시지, 에러 메시지, UI 텍스트
  - 금지 예시: `console.log("✅ 성공!")`, `console.error("❌ 실패:")`, `"성공 ✅"`, `// ⚠️ 주의`
  - 허용 예시: `console.log("Success")`, `console.error("Failed:")`, `"성공"`, `// WARNING: 주의`
- [ ] **로깅 함수 이모지 금지**: `logError()`, `logWarn()`, `logInfo()` 등 모든 로깅 함수에서 이모지 사용 금지
  - 위치: `apps/academy-admin/src/utils/logger-utils.ts` 등
  - 예: `logError('Scope', error)` (이모지 없이)
- [ ] **에러 메시지 이모지 금지**: 에러 메시지, 예외 메시지, 사용자 피드백 메시지에 이모지 사용 금지
- [ ] **주석 이모지 금지**: 코드 주석에도 이모지 사용 금지 (예: `// ✅ 완료` → `// 완료` 또는 `// DONE`)
- [ ] **예외**: 기술 설계 문서(`docu/*.md`, `docu/*.txt`)는 예외 (문서 가독성을 위한 이모지 허용)
- [ ] **스크립트 파일 포함**: `scripts/*.ts`, `infra/**/*.ts` 등 모든 TypeScript/JavaScript 파일에 적용

### 6. Hot Tenant 샤딩 트리거 기준 규칙 (선택적, 초과 성장 시나리오)
- [ ] **Hot Tenant 샤딩 검토 기준**: 다음 기준 중 3개 이상을 동시에 만족하면 Hot Tenant 샤딩 검토
  - 단일 테넌트 QPS ≥ 1,000 req/s 또는 전체의 30% 초과
  - 단일 테넌트 월별 row 증가량 ≥ 1천만 rows/월
  - 단일 테넌트 이벤트 ingestion 속도 ≥ 10,000 events/min
  - 단일 테넌트 CPU 사용량이 전체의 25% 초과
  - 트래픽 급증 패턴 감지
  - ⚠️ 중요: 초과 성장 시나리오(수십만 테넌트)에서도 대규모 팀이 필요하며, 1인 개발사에서는 구현이 비현실적

---

## 📦 구체적 체크 항목

### UI 컴포넌트 생성 시

1. **UI Core Component 확인**
   - [ ] `packages/ui-core/src/components/index.ts`에서 사용 가능한 컴포넌트 확인
   - [ ] `docu/SSOT_UI_DESIGN.md`의 "언제 무엇을 쓰는지" 결정표 참조
   - [ ] 새 컴포넌트 생성 전 공통 컴포넌트 존재 여부 확인

2. **Design Tokens 사용**
   - [ ] 모든 스타일 값은 CSS 변수 사용 (`var(--spacing-md)`, `var(--color-primary)` 등)
   - [ ] 하드코딩된 px/rem/hex 값 사용 금지
   - [ ] `packages/ui-core/src/styles.css`의 토큰 참조

3. **레이아웃 패턴**
   - [ ] `Container`, `PageHeader` 등 Layout Primitives 사용
     - 위치: `packages/ui-core/src/components/`
     - `PageHeader`는 `Container` 내부의 첫 번째 요소로 배치
   - [ ] 반응형 처리: `useResponsiveMode()` Hook 사용
     - 위치: `packages/ui-core/src/hooks/useResponsiveMode.ts`
     - CSS Media Query 직접 사용 금지, Hook을 통해서만 접근
     - 브레이크포인트: xs (0px), sm (640px), md (768px), lg (1024px), xl (1280px)
   - [ ] 상태 UI: loading/error/empty 상태는 표준 패턴 사용
   - [ ] 에러 바운더리: `ErrorBoundary` 컴포넌트 사용 (필요 시)
     - 위치: `packages/ui-core/src/components/ErrorBoundary.tsx`
     - Schema Validation Failure, Widget Rendering Failure, Data Fetch Error, Version Mismatch Error 등 카테고리별 다른 UI/메시지 처리
   - [ ] **Theme Engine 규칙**: Theme Merge Priority 준수, 색상 토큰만 오버라이드 허용
   - [ ] **SDUI 연동 규칙**: 스키마에서 Tailwind 클래스 직접 사용 금지, ui.variant/ui.density/ui.intent 등만 사용
   - [ ] **Mobile & Tablet UI/UX**: 모바일 환경에서는 테이블을 카드형 UI로 자동 전환, 확대보기 기능 제공, 버튼 최소 44px

4. **Shared Catalog 등록**
   - [ ] 공통 레이아웃/패턴 컴포넌트는 `packages/shared-catalog.ts`의 `components` 섹션에 등록
   - [ ] 필수 항목: `key`, `path`, `import`, `useWhen`, `doNot`, `examples`(2개 이상)

### Hook 생성 시

1. **Shared Catalog 등록**
   - [ ] `packages/shared-catalog.ts`의 `hooks` 섹션에 등록 필수
   - [ ] 필수 항목: `key`, `path`, `import`, `useWhen`, `doNot`, `examples`(2개 이상)
   - [ ] `related` 필드로 관련 Feature/Adapter 연결

2. **레이어 규칙**
   - [ ] `packages/hooks/*` 경로에 위치
   - [ ] UI 렌더링 금지
   - [ ] 내부에서 `navigate()` 같은 라우팅 직접 실행 금지
   - [ ] React Query/상태 캡슐화만 수행

3. **직접 구현 패턴 금지**
   - [ ] `apiClient.get()` 직접 호출 금지
   - [ ] `useQuery`로 테이블 직접 조회 금지
   - [ ] 공통 Hook 사용 필수

### Service/UseCase 생성 시

1. **레이어 규칙**
   - [ ] `packages/services/*` 또는 `@industry/*/service` 경로에 위치
   - [ ] UI/Router 의존 금지
   - [ ] React 컴포넌트에서 직접 DB 호출 금지 원칙의 실행 주체

2. **멀티테넌트 처리**
   - [ ] SELECT/UPDATE/DELETE: `withTenant()` 필수 사용
   - [ ] INSERT: `tenant_id`를 row object에 직접 포함 (withTenant() 사용 금지)

3. **환경변수 접근**
   - [ ] 서버/Edge 코드: `@env-registry/server`의 `envServer` 사용
   - [ ] `process.env` 직접 사용 금지 (단, `process.env.NODE_ENV`는 예외)

4. **Core/Industry Layer import**
   - [ ] 서버 코드는 `/service` 경로에서만 import (`index.ts`는 타입만 export)
   - [ ] `packages/industry/industry-{업종}/index.ts`: 타입만 export
   - [ ] `packages/core/*/index.ts`: 타입만 export
   - [ ] **Service Layer 경로 혼용 방지**: `index.ts`와 `/service` 경로 혼용 시 일관성 유지 (타입만 export 원칙 준수)

5. **findTenantByDomain() 함수 규칙** (Custom Domain 기능 구현 시)
   - [ ] `findTenantByDomain()` 함수는 반드시 `packages/services/tenant-service.ts` 안에 존재
   - [ ] 시그니처: `(domain: string) => Promise<{ id: uuid, tenant_id: uuid, status: string } | null>`
   - [ ] 반환 객체 필드 수 정확히 3개 (id, tenant_id, status 외 추가 필드 금지)
   - [ ] 추가 파라미터 금지

### Edge Function 생성 시

1. **보안 규칙**
   - [ ] JWT claim에서 `tenant_id` 추출 (UI/입력에서 받지 않음)
   - [ ] 인증/권한 검증 필수
   - [ ] `set_config('app.current_tenant_id')` 사용 금지 (JWT claim 기반 RLS만 사용)

2. **환경변수 접근**
   - [ ] `@env-registry/server`의 `envServer` 사용
   - [ ] `process.env` 직접 사용 금지

3. **Kakao Maps API 사용** (지도 기능 구현 시)
   - [ ] 주소 → 좌표 변환은 서버/Edge Function에서만 수행 (Kakao Local REST API)
   - [ ] 클라이언트에서는 Kakao JS SDK + JS_KEY만 사용
   - [ ] API Key 분리: 클라이언트는 `envClient.NEXT_PUBLIC_KAKAO_JS_KEY`, 서버는 `envServer.KAKAO_REST_API_KEY`
   - [ ] GeoJSON 좌표 변환: [lng, lat] → LatLng(lat, lng)

4. **Custom Domain 운영** (Custom Domain 기능 구현 시)
   - [ ] ACME 인증 실패 시 자동 재시도 및 수동 개입 프로세스 정의
   - [ ] DNS 연동 실패 시 지수 백오프 패턴으로 자동 재시도
   - [ ] 모든 활성 Custom Domain은 24시간마다 자동으로 DNS/SSL 상태 재검증
   - [ ] SSL 만료일 모니터링 및 만료 전 고객 알림 발송

5. **Timeout 제약**
   - [ ] 대규모 루프/수천 row 직접 처리 금지
   - [ ] 짧은 요청/응답, Webhook, Public Gateway 검증 용도만

6. **Webhook 보안 패턴** (Webhook 처리 시)
   - [ ] **서명 검증**: `x-signature`, `x-timestamp` 헤더 검증 필수
   - [ ] **타임스탬프 검증**: 5분 이내 타임스탬프만 허용 (`within5MinKST()`)
   - [ ] **멱등성 처리**: `idempotency_key` 기반 중복 처리 방지 필수
   - [ ] **동일 idempotency_key**: 첫 번째 이벤트만 처리, 이후 이벤트 무시

7. **입력 정규화 레이어** (DashboardCard 생성 시)
   - [ ] **정규화 함수 사용**: `normalizeDashboardCard()`, `normalizeDashboardCards()` 필수 사용
   - [ ] **위치**: `apps/academy-admin/src/utils/dashboard-card-normalization.ts`
   - [ ] **사용 예**: `const normalizedCards = normalizeDashboardCards(cards);`

8. **Industry Adapter 사용** (업종별 테이블명/FK 관계명 사용 시)
   - [ ] **하드코딩 금지**: 업종별 테이블명(`'academy_students'`, `'academy_classes'` 등) 하드코딩 절대 금지
   - [ ] **Industry Adapter 필수**: `getTenantTableName()`, `getFKRelationName()`, `getTenantIndustryType()` 함수 사용 필수
   - [ ] **Import 위치**: `infra/supabase/functions/_shared/industry-adapter.ts`에서 import
   - [ ] **Fail-Closed 원칙**: 매핑 실패 시 null 반환, fallback 패턴 사용 (예: `|| 'academy_students'`)
   - [ ] **적용 범위**: 모든 Edge Functions에서 업종별 테이블명 사용 시 필수
     - L0 핸들러, Task 실행 핸들러, 자동화 Edge Functions 모두 적용
   - [ ] **코드 위치**: `infra/supabase/functions/_shared/industry-adapter.ts` (SSOT)

9. **Execution Audit 기록** (실행 결과 기록 시)
   - [ ] **Correlation Key 필수**: `execution_audit_runs` 생성 시 correlation key 최소 1개 필수
     - 우선순위: `request_id` > `task_id`/`automation_id`/`job_id` > `entity_type`+`entity_id` > `source_event_id`/`diagnostic_id`
   - [ ] **operation_type 등록**: `meta.operation_registry`에 등록된 `operation_type`만 사용
     - 형식: kebab-case(하이픈) 고정 (예: `send-sms`, `update-attendance`)
     - 미등록 시: `unknown_operation`으로 기록, `status=failed`, Step 미생성
   - [ ] **details allowlist**: `details` 필드는 allowlist 기반으로만 저장
     - PII 직접 저장 금지 (전화번호, 주소, 원문 전문 등)
     - 참조키만 저장 (예: `message_id`, `vendor_message_id`)
     - 서버 Insert Layer에서 allowlist 적용, DB Trigger로 2중 방어 권장

### SQL 생성 시

1. **RLS 정책**
   - [ ] JWT claim 기반 RLS 사용: `tenant_id = (auth.jwt() ->> 'tenant_id')::uuid`
   - [ ] 정책 이름: `tenant_isolation_<table>` 형식
   - [ ] `set_config` 기반 RLS 금지 (Transaction Pooling 환경)

2. **인덱스 규칙**
   - [ ] 로그성 테이블 파티션: `(tenant_id, occurred_at DESC)` 복합 인덱스 필수
   - [ ] 인덱스 네이밍: `idx_<table>_<column>`, `ux_<table>_<unique_column>`

3. **날짜 처리**
   - [ ] KST 기준 날짜: `timezone('Asia/Seoul', now())::date` 사용
   - [ ] `CURRENT_DATE` 직접 사용 금지 (UTC 기준 반환)

4. **Direct Update 규칙**
   - [ ] 금지 테이블: `invoices`, `payments`, `attendance_logs`, `ai_insights`, `notifications`, `ai_feedback_logs`, `automation_undo_logs` 등은 Direct Update 절대 금지, Edge Function 필수
   - [ ] 허용 테이블: `persons`, `classes`, `student_classes` 등은 Direct Update 가능 (RLS 정책 필수)
   - [ ] RLS 정책 확인: 모든 필드에 RLS 정책 적용 확인 필수

---

## 🔍 주요 SSOT 문서 참조

### 필수 참조 문서

1. **`docu/rules.md`**: 프로젝트 구조, 의존성 방향, 네이밍 규칙, 시간/타임존 규칙
2. **`docu/SSOT_UI_DESIGN.md`**: UI 디자인 시스템, Design Tokens, UI Core Component 카탈로그
3. **`docu/컴포넌트 디자인.md`**: 컴포넌트별 사용 예시 및 스타일 수정 가이드
4. **`packages/shared-catalog.ts`**: 공통 로직(Hook/Feature/Adapter/Component) 카탈로그
5. **`P0 이슈 지시문`**: 즉시 장애/보안 위험 기준
6. **`P1 이슈 지시문`**: 중장기 운영 리스크 기준
7. **`P2 이슈 지시문`**: 품질 및 유지보수성 기준

### 추가 참조 문서

- **`docu/디어쌤 아키텍처.md`**: 전체 아키텍처 설계
- **`docu/프론트 자동화.md`**: 프론트엔드 자동화 규칙
- **`docu/전체 기술문서.txt`**: 기술 문서 통합본

---

## ✅ 체크리스트 요약

### 새 파일 생성 전

- [ ] 관련 SSOT 문서 확인 (`docu/rules.md`, `docu/SSOT_UI_DESIGN.md` 등)
- [ ] 공통 컴포넌트/Hook 존재 여부 확인 (`packages/ui-core`, `packages/hooks`, `packages/shared-catalog.ts`)
- [ ] 레이어 분류 결정 (UI Core Component / Shared Hook / Service / Domain 등)

### 파일 생성 중

- [ ] P0 기준 준수 (보안, 멀티테넌트 격리, Fail-Closed, PII 마스킹, 알림 모달, API 호출, React Hooks 규칙, 데이터 무결성)
- [ ] P1 기준 준수 (SSOT, 공통 컴포넌트, Design Tokens, 레이어 분리, 날짜 처리)
- [ ] P2 기준 준수 (일관성, 네이밍, 문서화, 이모지 금지)

### 파일 생성 후

- [ ] Shared Catalog 등록 (공통 로직인 경우)
- [ ] 관련 SSOT 문서 업데이트 (필요한 경우)
- [ ] 레이어 태그 추가 (`// LAYER: ...`)
- [ ] P0/P1/P2 이슈 검증 수행

---

## 🚨 자주 놓치는 항목 Top 35

1. **Shared Catalog 등록 누락**: 공통 로직 생성 시 `packages/shared-catalog.ts` 등록 필수
2. **Design Tokens 미사용**: 하드코딩된 px/hex 값 대신 CSS 변수 사용
3. **withTenant() 패턴 혼동**: INSERT는 `tenant_id` 직접 포함, SELECT/UPDATE/DELETE는 `withTenant()` 사용
4. **환경변수 직접 접근**: 서버/Edge 코드에서 `process.env` 직접 사용 금지, `@env-registry/server` 사용
5. **UI Core Component 미확인**: 새 컴포넌트 생성 전 기존 공통 컴포넌트 존재 여부 확인
6. **PII 마스킹 누락**: 로그/모니터링에서 PII 직접 출력 금지, `maskPII()` 필수 사용
7. **window.alert 사용**: 네이티브 `alert/confirm/prompt` 금지, `useModal()` 사용
8. **날짜 처리 오류**: `toISOString().split('T')[0]` 직접 사용 금지, `toKST()` 사용 필수
9. **API 직접 호출**: `fetch/axios` 직접 호출 금지, `@api-sdk/core` 사용 필수
10. **Core/Industry import 경로**: 서버 코드는 `/service` 경로에서만 import, `index.ts`는 타입만 export
11. **React Hooks 규칙 위반**: 조기 return으로 인한 hooks 호출 순서 불일치, 조건부 hooks 호출
12. **데이터 무결성 누락**: 트랜잭션/멱등성 없이 원자적 처리가 필요한 변경을 분리
13. **입력 정규화 레이어 미사용**: DashboardCard 생성 시 `normalizeDashboardCard()` 미사용으로 인한 데이터 무결성 파괴
14. **getApiContext() 미사용**: `tenantId`를 파라미터나 URL에서 받는 패턴 (Zero-Trust 원칙 위반)
15. **action_type 정규화 누락**: 서버에서 하이픈으로 정규화하지 않고 DB에 저장
16. **타입 가드 누락**: Policy 값이나 API 응답 배열에 대한 런타임 타입 검증 누락
17. **industry_type enum 불일치**: `realestate`/`real_estate`, `beauty_salon`/`salon` 혼용으로 인한 RLS/라우팅/필터링 오작동
18. **Policy Key v1/v2 혼용**: `legacy_policy_key`와 `policy_key_v2` 이중 저장 또는 혼용
19. **Execution Level 해석 불일치**: L0/L1/L2 해석이 코드마다 다르게 적용
20. **금지된 legacy 경로 사용**: `task_cards` 직접 조회 등 금지된 legacy 경로가 실제 실행에 사용됨
21. **네비게이션 보안 누락**: `navigate()` 직접 호출로 인한 오픈 리다이렉트 공격 위험
22. **에러 처리 패턴 불일치**: `safe()` 함수 미사용으로 인한 부분 실패 시 전체 그룹 사라짐
23. **React Query 패턴 불일치**: `createQueryKey()` 미사용, `CACHE_TIMES` 상수 미사용
24. **공통 로깅 유틸리티 미사용**: `logError()` 대신 `console.error` 직접 사용
25. **코드 내 이모지 사용**: `console.log("✅ 성공!")`, `console.error("❌ 실패:")` 등 코드 내 이모지 사용
26. **Execution Audit correlation key 누락**: `execution_audit_runs` 생성 시 correlation key 없이 생성
27. **Execution Audit details PII 유입**: `execution_audit_runs.details`에 PII 직접 저장 또는 allowlist 미적용
28. **operation_type 미등록**: `meta.operation_registry`에 등록되지 않은 `operation_type` 사용
29. **findTenantByDomain() 규칙 위반**: 함수 위치/시그니처/반환 필드 수 불일치
30. **Kakao Maps API Key 혼용**: 클라이언트에서 REST API Key 사용 또는 서버에서 JS_KEY 사용
31. **Custom Domain 운영 규칙 누락**: ACME/DNS 재시도 정책, SSL 만료 알림 미구현
32. **Mobile UI/UX 규칙 누락**: 모바일 환경에서 테이블 카드형 전환, 확대보기 기능 미구현
33. **업종별 데이터 분리 전략 불일치**: industry_type 컬럼 대신 업종별 테이블 자동 생성
34. **Theme Engine 오버라이드 범위 위반**: 색상 외 폰트/간격/크기 오버라이드 시도
35. **SDUI Tailwind 클래스 직접 사용**: 스키마에서 Tailwind 클래스 문자열 직접 사용

---

**문서 버전**: 1.8.0
**최종 업데이트**: 2025-01-27
**유지보수 책임**: 개발 팀

---

## 🔄 기존 파일 검증 가이드라인

### 검증 가능 여부

**✅ 검증 가능**: 이 체크리스트는 기존 `.ts`, `.tsx` 파일 검증에도 사용할 수 있습니다.

### 우선순위별 검증 기준

#### P0 항목 (기존 코드에서도 필수)

- [ ] **즉시 수정 필수**: 보안, 멀티테넌트 격리, Fail-Closed 위반은 기존 코드에서도 반드시 수정
- [ ] **예외 불가**: P0 항목은 레거시 코드라도 예외 없이 수정 필요
- [ ] **검증 방법**: P0 이슈 지시문 기준으로 검증

**P0 필수 수정 항목**:
- RLS 우회 가능성
- Service Role Key 프론트 노출
- 환경변수 직접 접근 (`process.env` 직접 사용)
- PII 마스킹 누락 (로그에 직접 출력)
- React Hooks 규칙 위반 (런타임 크래시)
- 데이터 무결성 파괴 (트랜잭션/원자성 위반)

#### P1 항목 (점진적 개선 권장)

- [ ] **점진적 개선**: 중장기 운영 리스크이므로 우선순위에 따라 점진적으로 개선
- [ ] **레거시 허용**: 기존 코드에서 P1 항목 위반은 레거시로 인정 가능 (단, 신규 코드는 금지)
- [ ] **마이그레이션 계획**: P1 항목 위반 발견 시 마이그레이션 계획 수립 권장

**P1 점진적 개선 항목**:
- SSOT 약화 (Shared Catalog 미등록 등)
- Design Tokens 미사용 (하드코딩된 px/hex)
- 레이어 분리 위반 (의존성 역전)
- 날짜 처리 오류 (`toKST()` 미사용)

#### P2 항목 (선택적 개선)

- [ ] **선택적 개선**: 품질/유지보수성 항목이므로 필요 시에만 개선
- [ ] **레거시 허용**: 기존 코드에서 P2 항목 위반은 허용 가능
- [ ] **신규 코드만**: 신규 코드 생성 시에만 P2 기준 준수 권장

**P2 선택적 개선 항목**:
- 레이어 태그 부재
- 네이밍 규칙 불일치
- 이모지 사용
- 문서화 부족

### 레거시 코드 예외 처리

**레거시 코드 예외 조건**:

1. **P0 항목은 예외 불가**: 보안/멀티테넌트 격리 위반은 레거시라도 수정 필수
2. **P1/P2 항목 예외 허용**: 다음 조건에서 예외 허용 가능
   - 레거시 코드로 명확히 식별 가능
   - 마이그레이션 계획이 수립됨
   - 예외 사유가 문서화됨
   - whitelist에 등록됨

**예외 등록 형식**:
```typescript
// LEGACY-EXCEPTION: [파일 경로:라인] [예외 사유]
// 예: LEGACY-EXCEPTION: apps/academy-admin/src/legacy/old-component.tsx:45 하드코딩된 px 값 (v2.0 마이그레이션 예정)
```

### 검증 실행 방법

1. **전수 검증** (전체 파일 대상):
   ```bash
   # P0 항목만 검증 (보안/멀티테넌트)
   # P1/P2 항목은 선택적으로 검증
   ```

2. **변경 파일만 검증** (git diff 기준):
   ```bash
   # 최근 변경된 파일만 검증
   git diff --name-only | grep -E '\.(ts|tsx)$'
   ```

3. **특정 디렉토리 검증**:
   ```bash
   # 특정 앱/패키지만 검증
   # 예: apps/academy-admin만 검증
   ```

### 검증 결과 처리

**검증 결과 분류**:

1. **P0 이슈**: 즉시 수정 필수 (보안/멀티테넌트 격리)
2. **P1 이슈**: 마이그레이션 계획 수립 후 점진적 개선
3. **P2 이슈**: 선택적 개선 (필요 시에만)

**결과 문서화**:
- 검증 결과는 이슈 트래커 또는 PR에 기록
- 레거시 예외는 whitelist에 등록
- 마이그레이션 계획은 별도 문서로 관리

---

## 📝 변경 이력

### v1.8.0 (2025-01-27)
- P0 항목 추가: findTenantByDomain() 함수 규칙, Custom Domain 보안 규칙
- P1 항목 추가: Kakao Maps API 사용 규칙, Custom Domain 운영 규칙, Mobile & Tablet UI/UX 규칙, 업종별 데이터 분리 전략 규칙, 지역 통계 및 지도 기능 규칙, Theme Engine 규칙, Layout Primitives 상세 규칙, SDUI 연동 규칙, Policy Registry 사용 규칙, Automation Config First 원칙 세부 규칙
- P2 항목 추가: Hot Tenant 샤딩 트리거 기준 규칙 (선택적)
- 자주 놓치는 항목 Top 28 → Top 35로 확장
- 구체적 체크 항목 섹션 보완: UI 컴포넌트 생성 시, Edge Function 생성 시, Service/UseCase 생성 시

### v1.7.0 (2025-01-27)
- 이모지 사용 금지 규칙 강화 (P2): 코드 내 모든 위치에서 이모지 사용 절대 금지 규칙 구체화
  - 금지 위치: 주석, 문자열 리터럴, console.log/error/warn/info, 로깅 함수, 에러 메시지, UI 텍스트
  - 스크립트 파일 포함: 모든 TypeScript/JavaScript 파일에 적용
  - 예외: 기술 설계 문서(`docu/*.md`, `docu/*.txt`)만 예외
- 자주 놓치는 항목 Top 27 → Top 28로 확장

### v1.6.0 (2025-01-27)
- Execution Audit 규칙 추가 (P0): Correlation Key 필수, details PII 유입 금지, operation_type 형식 강제 및 등록 필수
- ErrorBoundary 사용 규칙 추가 (P2): UI Core Component의 ErrorBoundary 컴포넌트 사용
- Edge Function Execution Audit 기록 규칙 추가: correlation key, operation_type 등록, details allowlist 적용
- 자주 놓치는 항목 Top 24 → Top 27로 확장

### v1.5.0 (2025-01-27)
- 코드 일관성 규칙 보완 (P2): `safe()`, `safeAll()` 함수 사용, `createQueryKey()` SSOT 유틸리티 사용, `CACHE_TIMES` 상수 사용
- 네비게이션 보안 규칙 추가 (P0): `createSafeNavigate()`, `isSafeInternalPath()` SSOT 유틸리티 사용 (오픈 리다이렉트 방지)
- 타입 가드 함수 규칙 추가 (P2): `ensureArray()`, `ensureNumber()`, `ensureString()` 등 SSOT 타입 가드 함수 사용
- 공통 로깅 유틸리티 규칙 추가 (P2): `logError()`, `logWarn()`, `logInfo()` SSOT 로깅 함수 사용
- 레이아웃 패턴 규칙 구체화 (P1): `Container`, `PageHeader` 사용 규칙, `useResponsiveMode()` Hook 사용 규칙 구체화
- 자주 놓치는 항목 Top 20 → Top 24로 확장

### v1.4.0 (2025-01-27)
- 보안 및 멀티테넌트 격리 규칙 보완 (P0): 권한 혼용 금지, 메타 스키마 접근 권한 검증, 프론트 권한 추론 금지, 인증/권한 검증 필수, 데이터 삭제/파괴 방지
- SSOT 정본 준수 규칙 보완 (P0): 금지된 legacy 경로 사용 금지
- SSOT 약화 방지 규칙 보완 (P1): Policy 소스 이원화 방지, Policy Key v1/v2 혼용 금지, industry_type enum 통일 규칙
- 정책 해석 일관성 규칙 추가 (P1): Execution Level 해석 통일, "자동" 용어 해석 통일, 정책 시점 일관성, Policy Key v2 6개 고정 규칙
- 확장 시 동기화 규칙 추가 (P1): 업종 추가 시 전 계층 동기화, event_type 추가 시 문서/코드 동기화, 동기화 자동 검증
- Service Layer 경로 혼용 방지 규칙 추가 (P1)
- 자주 놓치는 항목 Top 16 → Top 20으로 확장

### v1.3.0 (2025-01-27)
- 입력 정규화 레이어 규칙 추가 (P0): `normalizeDashboardCard()` 필수 사용
- `getApiContext()` 사용 규칙 구체화 (P0): `tenantId`는 반드시 `getApiContext()`에서만 가져옴
- 데이터 정규화 규칙 추가 (P1): `min_client`, `action_type` 정규화 규칙
- Policy 경로 점(.) 이스케이프 규칙 추가 (P1)
- Default Policy vs 코드 상수 구분 규칙 추가 (P1)
- 타입 신뢰도 규칙 보완 (P2): Policy 값 타입 검증, 배열 타입 가드
- 자주 놓치는 항목 Top 12 → Top 16으로 확장

### v1.2.0 (2025-01-27)
- 기존 파일 검증 가이드라인 추가
- P0/P1/P2 우선순위별 검증 기준 명시
- 레거시 코드 예외 처리 규칙 추가
- Phase A/B/C 프로세스 가이드 추가

### v1.1.0 (2025-01-27)
- PII 마스킹 규칙 추가 (P0)
- 알림/경고 모달 규칙 추가 (P0)
- API 호출 규칙 및 Zero-Trust 원칙 추가 (P0)
- 더미 데이터 생성 금지 규칙 추가 (P0)
- React Hooks 규칙 추가 (P0)
- 데이터 무결성(트랜잭션/원자성) 규칙 추가 (P0)
- 날짜 및 시간 처리 규칙 추가 (P1)
- 네이밍 규칙 추가 (P2)
- 이모지 사용 금지 규칙 추가 (P2)
- Core/Industry Layer import 규칙 추가 (P1)
- Direct Update 규칙 추가 (SQL 생성 시)
- Webhook 보안 패턴 추가 (Edge Function 생성 시)
- 에러 처리 패턴 보완 (PostgREST 에러 매핑 추가) (P2)
- 자주 놓치는 항목 Top 5 → Top 12로 확장

### v1.0.0 (2025-01-27)
- 초기 문서 생성

---

## 🔍 코드 검증 실행 방법

### 빠른 검증 (Quick Verification)

**신규 코드 구현 후**:
```
"체크리스트.md P0 항목으로 검증해줘"
```

**기존 코드 재검증**:
```
"체크리스트.md로 [파일 경로] 검증해줘 (P0만)"
```

### 상세 검증 (Detailed Verification)

로직 오류 검증이 필요한 경우 (정규식, 조건문, 알고리즘 등):
```
"코드검증_지시문.md의 [템플릿 이름] 사용해서 검증해줘"
```

**관련 문서**: `docu/코드검증_지시문.md` (즉시 사용 가능한 템플릿 및 예시)

### 검증 범위

- **구조 검증**: 이 체크리스트 (P0/P1/P2 항목)
- **로직 검증**: 단위 테스트 또는 코드검증_지시문.md 템플릿
- **통합 검증**: E2E 테스트 또는 실제 시나리오

---
