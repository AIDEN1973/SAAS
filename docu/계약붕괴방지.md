# ChatOps ì§ì ‘ ì‹¤í–‰ ì „í™˜ ì‹œ ê³„ì•½ ë¶•ê´´ ë°©ì§€ ì²´ê³„ ë¶„ì„

**ì‘ì„±ì¼**: 2025-01-28
**ë¶„ì„ ëŒ€ìƒ**: ChatOps ì§ì ‘ ì‹¤í–‰ ì—”ì§„ ì „í™˜ ì‹œ í•„ì—°ì ìœ¼ë¡œ ìƒê¸°ëŠ” ë¦¬ìŠ¤í¬ ë§µ & ë°©ì§€ ì²´ê³„
**ê´€ë ¨ ë¬¸ì„œ**: `docu/ì±—ë´‡.md`, `docu/í•¸ë“¤ëŸ¬ êµ¬í˜„.md`, `docu/ì²´í¬ë¦¬ìŠ¤íŠ¸.md`

---

## ëª©ì°¨

1. [ë¶„ì„ ê°œìš”](#1-ë¶„ì„-ê°œìš”)
2. [í˜„ì¬ ì‹œìŠ¤í…œ êµ¬í˜„ í˜„í™©](#2-í˜„ì¬-ì‹œìŠ¤í…œ-êµ¬í˜„-í˜„í™©)
3. [ì¶”ê°€ ë³´ì™„ ì‚¬í•­](#3-ì¶”ê°€-ë³´ì™„-ì‚¬í•­)
4. [Worker ì•„í‚¤í…ì²˜](#4-worker-ì•„í‚¤í…ì²˜)
5. [ìš°ì„ ìˆœìœ„ë³„ ë³´ì™„ ê³„íš](#5-ìš°ì„ ìˆœìœ„ë³„-ë³´ì™„-ê³„íš)
6. [ê²°ë¡ ](#6-ê²°ë¡ )
7. [ì‹¤ì œ ì½”ë“œ ê²½ë¡œ ì°¸ì¡°](#7-ì‹¤ì œ-ì½”ë“œ-ê²½ë¡œ-ì°¸ì¡°)
8. [ë¶€ë¡: êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸](#ë¶€ë¡-êµ¬í˜„-ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## 1. ë¶„ì„ ê°œìš”

### 1.1 ë¶„ì„ ëª©ì 

ChatOpsë¥¼ 'ì§ì ‘ ì‹¤í–‰ ì—”ì§„'ìœ¼ë¡œ ì „í™˜í•  ë•Œ ë°œìƒí•˜ëŠ” **ì‹œìŠ¤í…œ ì „ë°˜ ê³„ì•½ ë¶•ê´´(Contract Break)** ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ì²´ê³„ë¥¼ í˜„ì¬ ì‹œìŠ¤í…œê³¼ ë¹„êµ ë¶„ì„í•˜ê³ , ë³´ì™„ ì‚¬í•­ì„ ë„ì¶œí•©ë‹ˆë‹¤.

### 1.2 í•µì‹¬ ì›ì¹™

- **ì¸í…íŠ¸ë³„ í…ŒìŠ¤íŠ¸ âŒ** â†’ **ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ê²Œì´íŠ¸ âœ…**
- ì¸í…íŠ¸ëŠ” ìˆ˜ë°± ê°œë¡œ ëŠ˜ì–´ë‚˜ì§€ë§Œ, ì‹¤íŒ¨ ëª¨ë“œëŠ” ì†Œìˆ˜ì˜ ê³„ì•½ ì¹´í…Œê³ ë¦¬ë¡œ ìˆ˜ë ´
- ë”°ë¼ì„œ ì¸í…íŠ¸ë³„ í…ŒìŠ¤íŠ¸ ëŒ€ì‹  ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ìë™ ê²€ì¦ ê²Œì´íŠ¸ êµ¬ì¶•

### 1.3 ì‹¤íŒ¨ ëª¨ë“œ ë¶„ë¥˜ (6ëŒ€ ì¹´í…Œê³ ë¦¬)

1. **ì…ë ¥/ì •ê·œí™” ê³„ì•½ ë¶•ê´´** (A)
2. **ìƒíƒœ ë¨¸ì‹ /ì„¸ì…˜ ê³„ì•½ ë¶•ê´´** (B)
3. **ê¶Œí•œ/ì •ì±…/í…Œë„ŒíŠ¸ ê²½ê³„ ë¶•ê´´** (C)
4. **ë°ì´í„°ë² ì´ìŠ¤/ìŠ¤í‚¤ë§ˆ ê³„ì•½ ë¶•ê´´** (D)
5. **ì™¸ë¶€ ì‚¬ì´ë“œì´í™íŠ¸ ê³„ì•½ ë¶•ê´´** (E)
6. **ê´€ì¸¡/ê°ì‚¬/ì¬í˜„ì„± ë¶•ê´´** (F)

---

## 2. í˜„ì¬ ì‹œìŠ¤í…œ êµ¬í˜„ í˜„í™©

### 2.1 âœ… ì´ë¯¸ êµ¬í˜„ëœ í•­ëª©

#### A. Schema Gate (ë¶€ë¶„ êµ¬í˜„)

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/supabase/functions/execute-task-card/index.ts` - `validatePlan()` í•¨ìˆ˜
- Plan ìŠ¤ëƒ…ìƒ· ê²€ì¦ ìˆ˜í–‰
- Intent Registryì˜ `paramsSchema`ë¡œ íƒ€ì… ê²€ì¦

**êµ¬í˜„ ë‚´ìš©:**
```typescript
// execute-task-card/index.ts:82-125
function validatePlan(plan: unknown): plan is SuggestedActionChatOpsPlanV1 {
  // ìµœì†Œ í•„ìˆ˜ í•„ë“œ ê²€ì¦
  // automation_levelì€ L1 ë˜ëŠ” L2ë§Œ í—ˆìš© (L0ëŠ” TaskCard ìƒì„± ë¶ˆê°€)
  // L2ì¼ ë•Œ execution_class í•„ìˆ˜ ê²€ì¦
  // L2-Aì¼ ë•Œ event_type í•„ìˆ˜ ê²€ì¦
  // plan_snapshot.targets.student_ids ë°°ì—´ ê²€ì¦
}
```

**ë¶€ì¡±í•œ ë¶€ë¶„:**
- âŒ Apply ì…ë ¥ ìŠ¤í‚¤ë§ˆ ê°•ì œ ê²€ì¦ ê²Œì´íŠ¸ ì—†ìŒ
  - í˜„ì¬: Handler ë‚´ë¶€ì—ì„œë§Œ ê²€ì¦, Apply ì§„ì… ì „ ìŠ¤í‚¤ë§ˆ ê²Œì´íŠ¸ ì—†ìŒ
- âŒ Queryâ†’ID í•´ì†Œ(Resolve) ì—†ìœ¼ë©´ Apply ì§„ì… ê¸ˆì§€ ë¡œì§ ì—†ìŒ
  - í˜„ì¬: `normalizeParams`ì—ì„œ nameâ†’student_id ë³€í™˜ì€ ìˆìœ¼ë‚˜, ëª…ì‹œì ì¸ Resolver Gate ì—†ìŒ

#### B. Resolver Gate (ë¶€ë¶„ êµ¬í˜„)

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/supabase/functions/chatops/index.ts` - `extractIntentCandidates()` í•¨ìˆ˜

**êµ¬í˜„ ë‚´ìš©:**
- Registryì˜ `examples` í•„ë“œ ê¸°ë°˜ í›„ë³´ ì¶”ì¶œ
- LLMì´ í›„ë³´ ëª©ë¡ì—ì„œë§Œ Intent ì„ íƒ (ììœ  ìƒì„± ê¸ˆì§€)

**ë¶€ì¡±í•œ ë¶€ë¶„:**
- âŒ ë‹¤ì¤‘ í›„ë³´ ì‹œ ìë™ ì¤‘ë‹¨ ë¡œì§ ì—†ìŒ
  - í˜„ì¬: LLMì´ í›„ë³´ ëª©ë¡ì—ì„œ ì„ íƒí•˜ì§€ë§Œ, ë‹¤ì¤‘ í›„ë³´ê°€ ìœ ì‚¬ ì ìˆ˜ì¼ ë•Œ ìë™ ì¤‘ë‹¨ ì—†ìŒ
- âŒ Queryâ†’ID í•´ì†Œ ì—†ìœ¼ë©´ Apply ì§„ì… ê¸ˆì§€ ë¡œì§ ì—†ìŒ
  - í˜„ì¬: `normalizeParams`ì—ì„œ nameâ†’student_id ë³€í™˜ì€ ìˆìœ¼ë‚˜, ë³€í™˜ ì‹¤íŒ¨ ì‹œì—ë„ Apply ì§„í–‰ ê°€ëŠ¥

#### C. Auth/Policy Gate (âœ… ì™„ì „ êµ¬í˜„)

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/supabase/functions/execute-task-card/index.ts`
- `infra/supabase/supabase/functions/_shared/policy-utils.ts`

**êµ¬í˜„ ë‚´ìš©:**
- âœ… Policy ì¬í‰ê°€: `getTenantSettingByPath()` ì‚¬ìš©
- âœ… Fail-Closed ì›ì¹™ ì ìš©
- âœ… JWTì—ì„œ tenant_id ì¶”ì¶œ (Zero-Trust)
- âœ… L2-BëŠ” Domain Action Catalog ê²€ì¦
- âœ… L2-AëŠ” event_type ê²€ì¦ (`assertAutomationEventType()`)

**ì˜ˆì‹œ ì½”ë“œ:**
```typescript
// Policy ì¬í‰ê°€ (Fail-Closed)
const policyEnabled = await getTenantSettingByPath(
  supabase,
  taskCard.tenant_id,
  `auto_notification.${eventType}.enabled`
);

if (!policyEnabled || policyEnabled !== true) {
  return new Response(
    JSON.stringify({ error: 'Policy disabled or not found' }),
    { status: 403 }
  );
}
```

#### D. Idempotency Gate (âœ… ì™„ì „ êµ¬í˜„)

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/supabase/functions/execute-task-card/index.ts`
- `infra/supabase/supabase/functions/chatops/index.ts`

**êµ¬í˜„ ë‚´ìš©:**
- âœ… `request_id` ê¸°ë°˜ ë©±ë“±ì„± ì²˜ë¦¬ (5ë¶„ ë²„í‚·)
- âœ… `dedup_key` ê¸°ë°˜ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
- âœ… `automation_actions` í…Œì´ë¸”ì˜ ìœ ë‹ˆí¬ ì œì•½

**ì˜ˆì‹œ ì½”ë“œ:**
```typescript
// request_id ìƒì„± (ì„œë²„ì—ì„œ ìƒì„±, í´ë¼ì´ì–¸íŠ¸ ì…ë ¥ ê¸ˆì§€)
const attemptWindow = Math.floor(Date.now() / (5 * 60 * 1000));
const requestId = `${taskId}:approve-and-execute:${attemptWindow}`;

// ë©±ë“± ì²˜ë¦¬
const { data: existingAction } = await withTenant(
  supabase
    .from('automation_actions')
    .select('id, result')
    .eq('request_id', requestId),
  taskCard.tenant_id
).single();

if (existingAction) {
  // ì´ë¯¸ ì²˜ë¦¬ë¨ - ì¦‰ì‹œ ì„±ê³µ ë°˜í™˜ (ë©±ë“±)
  return new Response(JSON.stringify({
    status: 'executed',
    message: 'ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­ì…ë‹ˆë‹¤.',
    result: existingAction.result
  }));
}
```

#### E. PII ë§ˆìŠ¤í‚¹ (âœ… ì™„ì „ êµ¬í˜„)

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/supabase/functions/_shared/pii-utils.ts`

**êµ¬í˜„ ë‚´ìš©:**
- âœ… `maskPII()` í•¨ìˆ˜ ì‚¬ìš©
- âœ… ì—ëŸ¬ ë¡œê·¸ì— ì ìš©
- âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸.md P0 í•­ëª©ìœ¼ë¡œ ê°•ì œ

---

### 2.2 âŒ ëˆ„ë½ëœ í•­ëª©

#### 1. DB Contract Gate (CI í…ŒìŠ¤íŠ¸)

**í˜„ì¬ ìƒíƒœ:**
- âŒ ëŸ°íƒ€ì„ ì»¬ëŸ¼ ì¡´ì¬ ê²€ì‚¬ ì—†ìŒ
- âŒ CIì—ì„œ PostgREST ëŒ€ìƒ í…Œì´ë¸” ì»¬ëŸ¼ ì¡´ì¬ + smoke insert/select í…ŒìŠ¤íŠ¸ ì—†ìŒ
- âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì—¬ë¶€ ì²´í¬ ì—†ìŒ
- âŒ ì„œë²„ ë¶€íŒ… ì‹œ í•„ìˆ˜ ì»¬ëŸ¼/ë·° ì²´í¬ ì—†ìŒ

**í•„ìš”í•œ êµ¬í˜„:**
```typescript
// CI í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
describe('DB Contract Gate', () => {
  it('should verify required columns exist', async () => {
    const requiredColumns = ['id', 'tenant_id', 'created_at'];
    for (const col of requiredColumns) {
      const exists = await checkColumnExists('task_cards', col);
      expect(exists).toBe(true);
    }
  });

  it('should perform smoke insert/select test', async () => {
    // ìµœì†Œ insert/select í…ŒìŠ¤íŠ¸
  });

  it('should verify migration version', async () => {
    const version = await getMigrationVersion();
    expect(version).toBeGreaterThanOrEqual(MIN_REQUIRED_VERSION);
  });
});
```

**ì˜í–¥:**
- ë§ˆì´ê·¸ë ˆì´ì…˜ ëˆ„ë½/ìˆœì„œ ê¼¬ì„ ì‹œ ëŸ°íƒ€ì„ í­ë°œ
- ì»¬ëŸ¼ ì˜¤ë¥˜ (PGRST204) ë°œìƒ ê°€ëŠ¥

#### 2. Preflight ì¬ì¡°íšŒ

**í˜„ì¬ ìƒíƒœ:**
- âŒ Apply ì§ì „ ìƒíƒœ ì¬ì¡°íšŒ ì—†ìŒ
- âŒ Handler ì‹¤í–‰ ì „ ëŒ€ìƒ ìƒíƒœ ì¬í™•ì¸ ì—†ìŒ

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/supabase/functions/execute-task-card/index.ts` - Handler ì‹¤í–‰ ì „
- `infra/supabase/supabase/functions/chatops/index.ts` - `draft_confirm` ì‹œ Handler ì‹¤í–‰ ì „

**í•„ìš”í•œ êµ¬í˜„:**
```typescript
// execute-task-card/index.tsì— ì¶”ê°€ (Handler ì‹¤í–‰ ì§ì „)
// âš ï¸ Preflight: ì‹¤í–‰ ì§ì „ ìƒíƒœ ì¬í™•ì¸
if (plan.plan_snapshot?.targets?.kind === 'student_id_list') {
  const { data: currentState } = await withTenant(
    supabase
      .from('persons')
      .select('id, person_type, status')
      .in('id', plan.plan_snapshot.targets.student_ids)
      .eq('person_type', 'student'),
    taskCard.tenant_id
  );

  // ìƒíƒœ ë³€í™” ê°ì§€
  const dischargedStudents = currentState?.filter(s => s.status === 'discharged');
  if (dischargedStudents && dischargedStudents.length > 0) {
    return new Response(
      JSON.stringify({
        error: 'CONTRACT_STATE_CHANGED',
        message: `ì´ë¯¸ í‡´ì›í•œ í•™ìƒì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤: ${dischargedStudents.length}ëª…`,
        affected_students: dischargedStudents.map(s => s.id),
      }),
      { status: 409, headers: corsHeaders }
    );
  }

  // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•™ìƒ ê°ì§€
  const foundIds = new Set(currentState?.map(s => s.id) || []);
  const missingIds = plan.plan_snapshot.targets.student_ids.filter(
    id => !foundIds.has(id)
  );
  if (missingIds.length > 0) {
    return new Response(
      JSON.stringify({
        error: 'CONTRACT_TARGET_NOT_FOUND',
        message: `ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•™ìƒì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤: ${missingIds.length}ëª…`,
        missing_ids: missingIds,
      }),
      { status: 404, headers: corsHeaders }
    );
  }
}
```

**ì˜í–¥:**
- ìƒíƒœ ë³€ê²½ í›„ ì˜¤ë˜ëœ Planìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
- ì˜ˆ: ì´ë¯¸ í‡´ì›í•œ í•™ìƒì—ê²Œ ë©”ì‹œì§€ ë°œì†¡
- ì˜ˆ: ì´ë¯¸ ì‚­ì œëœ í•™ìƒ IDë¡œ ì‹¤í–‰ ì‹œë„

#### 3. Draft â†” ì‹¤í–‰ ëŒ€ìƒ ê³ ì • í† í°

**í˜„ì¬ ìƒíƒœ:**
- âŒ `draft_id`ë§Œ ì‚¬ìš©, ì„œë²„ ì„œëª… í† í° ì—†ìŒ
- âš ï¸ ë¶€ë¶„ êµ¬í˜„: `draft_confirm` ì‹œ `tenant_id`/`user_id` ê²€ì¦ì€ ìˆìœ¼ë‚˜ `session_id` ê²€ì¦ ì—†ìŒ
- í˜„ì¬ ì½”ë“œ: `infra/supabase/supabase/functions/chatops/index.ts:983-990`

**í˜„ì¬ êµ¬í˜„:**
```typescript
// chatops/index.ts:983-990
const { data: draft } = await supabase
  .from('chatops_drafts')
  .select('*')
  .eq('id', draft_id)
  .eq('tenant_id', tenant_id)  // âœ… tenant_id ê²€ì¦
  .eq('user_id', user_id)      // âœ… user_id ê²€ì¦
  .eq('status', 'ready')
  .single();
// âŒ session_id ê²€ì¦ ì—†ìŒ
```

**í•„ìš”í•œ êµ¬í˜„:**
```typescript
// draft_confirm ì‹œ session_id ê²€ì¦ ì¶”ê°€
const { data: draft } = await supabase
  .from('chatops_drafts')
  .select('*, session_id')
  .eq('id', draft_id)
  .eq('tenant_id', tenant_id)
  .eq('user_id', user_id)
  .eq('status', 'ready')
  .single();

// âš ï¸ ì„¸ì…˜ ì¼ì¹˜ ê²€ì¦ ì¶”ê°€
if (draft.session_id !== session_id) {
  return new Response(
    JSON.stringify({
      error: 'CONTRACT_SESSION_MISMATCH',
      message: 'Draft ì„¸ì…˜ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    }),
    { status: 403, headers: corsHeaders }
  );
}

// ë˜ëŠ” ì„œë²„ ì„œëª… í† í° ë°©ì‹ (ë” ê°•ë ¥í•œ ë³´ì•ˆ)
// draft ìƒì„± ì‹œ ì„œë²„ ì„œëª… í† í° ë°œê¸‰
const draftToken = await generateDraftToken({
  draft_id: draft.id,
  tenant_id: tenant_id,
  user_id: user_id,
  session_id: session_id,
  intent_key: intent.intent_key,
  expires_at: Date.now() + 3600000, // 1ì‹œê°„
});

// draft_confirm ì‹œ í† í° ê²€ì¦
const isValidToken = await verifyDraftToken(draft_id, draftToken);
if (!isValidToken) {
  return new Response(
    JSON.stringify({ error: 'CONTRACT_DRAFT_TOKEN_INVALID' }),
    { status: 403 }
  );
}
```

**ì˜í–¥:**
- "ì‹¤í–‰"ì´ ë‹¤ë¥¸ draftì— ë¶™ì„ ìˆ˜ ìˆìŒ
- ì„¸ì…˜ í˜¼ì„  ê°€ëŠ¥
- ë‹¤ë¥¸ ì„¸ì…˜ì˜ draftë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŒ

#### 4. Worker ì•„í‚¤í…ì²˜ (ì™¸ë¶€ ë°œì†¡ ë° ëŒ€ëŸ‰ ì²˜ë¦¬)

**í˜„ì¬ ìƒíƒœ:**
- âŒ ì™¸ë¶€ ë°œì†¡ì´ DB íŠ¸ëœì­ì…˜ê³¼ ë¶„ë¦¬ë˜ì§€ ì•ŠìŒ
- âŒ Apply ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì‹¤í–‰ ìˆ˜í–‰ (Worker ë¶„ë¦¬ ì—†ìŒ)
- âœ… Outbox íŒ¨í„´ ë¶€ë¶„ êµ¬í˜„ (`message_outbox` í…Œì´ë¸” ìƒì„±, `message-send-to-guardian.ts` Handlerì—ì„œ ì‚¬ìš©)
- âŒ Worker í”„ë¡œì„¸ìŠ¤ ë¯¸êµ¬í˜„

**Workerì˜ í•„ìš”ì„±:**
ChatOpsë¥¼ "ëŒ€í™” ê¸°ë°˜ ì§ì ‘ ì‹¤í–‰ ì‹œìŠ¤í…œ"ìœ¼ë¡œ ì „í™˜í•˜ë©´ì„œ, HTTP/Edge ìš”ì²­ ì•ˆì—ì„œ ëª¨ë“  ì‹¤í–‰ì„ ì²˜ë¦¬í•˜ë©´ ë‹¤ìŒ ë¬¸ì œê°€ í•„ì—°ì ìœ¼ë¡œ ë°œìƒí•œë‹¤:
- ì¤‘ë³µ ì‹¤í–‰ ("ì‹¤í–‰" ì—°íƒ€, ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„)
- ë¶€ë¶„ ì„±ê³µ/ì‹¤íŒ¨ ì²˜ë¦¬ ë¶ˆê°€
- ì™¸ë¶€ API ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë¶ˆê°€
- íƒ€ì„ì•„ì›ƒ â†’ ìƒíƒœ ë¶ˆëª…
- ì¥ì•  ì‹œ ì¬ì‹¤í–‰/ë³µêµ¬ ë¶ˆê°€
- ì–´ë–¤ ê³„ì•½(DB/Policy/Schema)ì´ ê¹¨ì¡ŒëŠ”ì§€ ì¶”ì  ë¶ˆê°€

**Workerê°€ í•„ìš”í•œ ì‘ì—… ìœ í˜•:**
1. **ì™¸ë¶€ ì‚¬ì´ë“œì´í™íŠ¸**: ë¬¸ì/ì•Œë¦¼/ì´ë©”ì¼ ë°œì†¡, ê²°ì œ API í˜¸ì¶œ, ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™
2. **ë‹¤ìˆ˜ ëŒ€ìƒ ì²˜ë¦¬**: ì—¬ëŸ¬ í•™ìƒ ì¼ê´„ í‡´ì›, ì—¬ëŸ¬ ëª…ì—ê²Œ ë¬¸ì ë°œì†¡, ì§‘ê³„/í†µê³„ ì¬ê³„ì‚°
3. **ì‹¤íŒ¨/ì¬ì‹œë„ ê°€ëŠ¥ì„± ì¡´ì¬**: ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ, Rate limit, ë¶€ë¶„ ì„±ê³µ ê°€ëŠ¥
4. **ë©±ë“±ì„±ì´ í•„ìš”í•œ ì‘ì—…**: "ì‹¤í–‰" ì¤‘ë³µ í´ë¦­, ë¸Œë¼ìš°ì € ì¬ìš”ì²­, ì„œë²„ ì¬ì‹œì‘ í›„ ì¬ì²˜ë¦¬

**ChatOps ì‹¤í–‰ íë¦„ (Resolve â†’ Confirm â†’ Apply â†’ Worker):**
```
[User Message]
   â†“
Resolve (query â†’ í›„ë³´)
   â†“
Confirm (ì„ íƒ/í™•ì¸)
   â†“
Apply (ê²°ì •ë§Œ)
   - ê²€ì¦
   - ì •ì±…/ê¶Œí•œ ì²´í¬
   - idempotency_key ìƒì„±
   - job ìƒì„±
   â†“
[Job / Outbox Table]
   â†“
Worker
   - ì‹¤ì œ ì‹¤í–‰
   - ì¬ì‹œë„
   - ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬
   â†“
ê²°ê³¼ ì €ì¥ + ChatOps ìƒíƒœ ê°±ì‹ 
```

**Apply ë‹¨ê³„ì˜ ì±…ì„ (Worker ì´ì „):**
ApplyëŠ” ë‹¤ìŒê¹Œì§€ë§Œ ìˆ˜í–‰í•œë‹¤:
1. **ê³„ì•½ ê²€ì¦ (í•„ìˆ˜)**
   - ì…ë ¥ ìŠ¤í‚¤ë§ˆ(UUID ê°•ì œ)
   - Resolver ì™„ë£Œ ì—¬ë¶€
   - ì •ì±… / RBAC / í…Œë„ŒíŠ¸ ì¬ê²€ì¦
   - L2ëŠ” Confirm í•„ìˆ˜
2. **idempotency_key ìƒì„±**
   ```typescript
   hash(
     tenant_id +
     intent_key +
     sorted(entity_ids) +
     action_type +
     effective_date
   )
   ```
3. **Job ìƒì„± (íŠ¸ëœì­ì…˜)**
   - ì„±ê³µ ì‹œì  = job ì €ì¥ ì„±ê³µ
   - ì´ ì‹œì ì— ChatOpsëŠ” ì‚¬ìš©ìì—ê²Œ "ì²˜ë¦¬ ì‹œì‘" ì‘ë‹µ
   - â— ì´ ì´í›„ ì‹¤íŒ¨ëŠ” ì‚¬ìš©ì ìš”ì²­ ì‹¤íŒ¨ê°€ ì•„ë‹˜

**Job / Outbox í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ:**
```sql
-- job_executions í…Œì´ë¸” (í•µì‹¬)
CREATE TABLE job_executions (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  intent_key TEXT NOT NULL,
  automation_level TEXT, -- L2
  status TEXT NOT NULL, -- pending | running | success | partial | failed
  idempotency_key TEXT UNIQUE NOT NULL,
  payload JSONB NOT NULL, -- ì‹¤í–‰ ì…ë ¥ (UUIDë§Œ í¬í•¨)
  result JSONB,  -- ì„±ê³µ/ì‹¤íŒ¨ ìƒì„¸
  retry_count INT DEFAULT 0,
  max_retries INT DEFAULT 3,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- message_outbox í…Œì´ë¸” (ì™¸ë¶€ ë°œì†¡ìš©, ì´ë¯¸ êµ¬í˜„ë¨)
-- migrations/136_create_message_outbox_table.sql ì°¸ì¡°
```

**Worker í”„ë¡œì„¸ìŠ¤ì˜ ì±…ì„:**
1. **ì‹¤í–‰ ì „**
   - job ìƒíƒœ pending â†’ running
   - idempotency_key ì¬í™•ì¸
   - ìµœì‹  ìƒíƒœ Preflight ì²´í¬ (ì´ë¯¸ í‡´ì› / ì´ë¯¸ ì²˜ë¦¬ë¨ â†’ ì„±ê³µìœ¼ë¡œ ì¢…ë£Œ)
2. **ì‹¤í–‰ ì¤‘**
   - DB ì—…ë°ì´íŠ¸
   - ì™¸ë¶€ API í˜¸ì¶œ
   - ê° ëŒ€ìƒë³„ ê²°ê³¼ ê¸°ë¡
3. **ì‹¤í–‰ í›„**
   - ì„±ê³µ / ì‹¤íŒ¨ / ë¶€ë¶„ ì„±ê³µ íŒì •
   - result JSON ì €ì¥
   - job ìƒíƒœ ì—…ë°ì´íŠ¸

**ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸:**
```typescript
// ì˜ˆ: í•™ìƒ 10ëª… í‡´ì›
// ì„±ê³µ: 7, ì‹¤íŒ¨: 3
{
  "status": "partial",
  "result": {
    "success_list": [
      { "entity_id": "uuid1", "entity_name": "í•™ìƒ1" },
      { "entity_id": "uuid2", "entity_name": "í•™ìƒ2" }
    ],
    "failure_list": [
      { "entity_id": "uuid8", "entity_name": "í•™ìƒ8", "reason": "ì´ë¯¸ í‡´ì›ë¨" },
      { "entity_id": "uuid9", "entity_name": "í•™ìƒ9", "reason": "ê¶Œí•œ ë³€ê²½" }
    ]
  }
}
```

**ì¬ì‹œë„ ì •ì±… (Fail-Closed):**
- `retry_count < max_retries` â†’ ìë™ ì¬ì‹œë„
- ì‹¤íŒ¨ ì›ì¸ ë¶„ë¥˜:
  - ì™¸ë¶€ API â†’ ì¬ì‹œë„
  - ê³„ì•½ ì˜¤ë¥˜(DB ìŠ¤í‚¤ë§ˆ, ê¶Œí•œ) â†’ ì¬ì‹œë„ ê¸ˆì§€
- ì¬ì‹œë„ ì‹œ `idempotency_key` ìœ ì§€

**ChatOpsì™€ì˜ ì—°ê²° (UX ìœ ì§€):**
- ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” íë¦„: "ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤" â†’ "ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤" â†’ "ì™„ë£Œ / ì¼ë¶€ ì‹¤íŒ¨ / ì‹¤íŒ¨"
- ë‚´ë¶€ì ìœ¼ë¡œ: ChatOps ë©”ì‹œì§€ëŠ” `job_id` ì°¸ì¡°, Worker ê²°ê³¼ì— ë”°ë¼ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸

**Worker êµ¬í˜„ í˜•íƒœ:**
- ë³„ë„ ì„œë²„ì¼ í•„ìš” ì—†ìŒ
- ê°€ëŠ¥í•œ êµ¬í˜„:
  - Vercel Background Function
  - Supabase Edge Function (queue ì†Œë¹„)
  - Cron + polling worker
  - ë‹¨ì¼ Node í”„ë¡œì„¸ìŠ¤ (dev/ì´ˆê¸°)
- ì¤‘ìš”í•œ ê±´ 'ë¶„ë¦¬ëœ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸'ì´ì§€, ì¸í”„ë¼ ê·œëª¨ê°€ ì•„ë‹ˆë‹¤.

**í•„ìš”í•œ êµ¬í˜„:**
```typescript
// 1. Apply ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì‹¤í–‰ ì½”ë“œ ì œê±°
// í˜„ì¬: Handler ì§ì ‘ í˜¸ì¶œ
// ë³€ê²½: job ìƒì„±ë§Œ ìˆ˜í–‰

// 2. job_executions í…Œì´ë¸” ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜)
// 3. idempotency_key ê°•ì œ
// 4. ì›Œì»¤ ì‹¤í–‰ ë£¨í”„ êµ¬í˜„
// 5. ì™¸ë¶€ ë°œì†¡ Outbox ë¶„ë¦¬ (ì´ë¯¸ ë¶€ë¶„ êµ¬í˜„ë¨)
// 6. job ê²°ê³¼ â†’ ChatOps ë©”ì‹œì§€ ë°˜ì˜
```

**ì˜í–¥:**
- ì‹¤íŒ¨ ì‹œ ì¤‘ë³µ ë°œì†¡ ê°€ëŠ¥
- ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ì „ëµ ì—†ìŒ
- íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¸í•œ ìƒíƒœ ë¶ˆëª…
- ì¥ì•  ì‹œ ì¬ì‹¤í–‰/ë³µêµ¬ ë¶ˆê°€
- ê³„ì•½ ë¶•ê´´ ì¶”ì  ë¶ˆê°€

#### 5. ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ì—ëŸ¬ íƒœê¹…

**í˜„ì¬ ìƒíƒœ:**
- âŒ `error_code`ëŠ” ìˆìœ¼ë‚˜ ê³„ì•½ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ì—†ìŒ
- âŒ `HandlerErrorCode` enumë§Œ ì¡´ì¬ (POLICY_DISABLED, EXECUTION_FAILED ë“±)

**í•„ìš”í•œ êµ¬í˜„:**
```typescript
// ì—ëŸ¬ ì½”ë“œë¥¼ ê³„ì•½ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜
export enum ContractErrorCategory {
  CONTRACT_INPUT_TYPE = 'CONTRACT_INPUT_TYPE',
  CONTRACT_RESOLUTION_AMBIGUOUS = 'CONTRACT_RESOLUTION_AMBIGUOUS',
  CONTRACT_DB_SCHEMA_MISMATCH = 'CONTRACT_DB_SCHEMA_MISMATCH',
  CONTRACT_POLICY_DISABLED = 'CONTRACT_POLICY_DISABLED',
  CONTRACT_IDEMPOTENCY_VIOLATION = 'CONTRACT_IDEMPOTENCY_VIOLATION',
  EXTERNAL_PROVIDER_FAILURE = 'EXTERNAL_PROVIDER_FAILURE',
}

// Handlerì—ì„œ ì‚¬ìš©
return {
  status: 'failed',
  error_code: 'CONTRACT_POLICY_DISABLED',
  contract_category: ContractErrorCategory.CONTRACT_POLICY_DISABLED,
  message: 'ì‹¤í–‰ ì •ì±…ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
};
```

**ì˜í–¥:**
- ì¸í…íŠ¸ë³„ ì—ëŸ¬ê°€ í©ì–´ì ¸ ì›ì¸ ì¶”ì  ì–´ë ¤ì›€
- ê³„ì•½ ë ˆì´ì–´ ìˆ˜ì •ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥í•œ ë¬¸ì œë¥¼ ì¸í…íŠ¸ë³„ë¡œ ìˆ˜ì •í•´ì•¼ í•¨

#### 6. ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸

**í˜„ì¬ ìƒíƒœ:**
- âœ… Handlerì—ì„œ `status: 'partial'` ë°˜í™˜ ê°€ëŠ¥
- âŒ ê²°ê³¼ ëª¨ë¸ì— ì„±ê³µ/ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ í¬í•¨ êµ¬ì¡° ì—†ìŒ

**í•„ìš”í•œ êµ¬í˜„:**
```typescript
// HandlerResult íƒ€ì… í™•ì¥
export interface HandlerResult {
  status: 'success' | 'failed' | 'partial';
  result?: {
    total_count?: number;
    success_count?: number;
    error_count?: number;
    // ì¶”ê°€ í•„ìš”
    success_list?: Array<{
      entity_id: string;
      entity_name?: string;
    }>;
    failure_list?: Array<{
      entity_id: string;
      entity_name?: string;
      reason?: string;
    }>;
  };
}
```

---

## 3. ì¶”ê°€ ë³´ì™„ ì‚¬í•­

> **ì°¸ê³ **: "ëˆ„ë½ëœ í•­ëª© ë¶„ì„"ì€ ì„¹ì…˜ 2.2ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### 3.1 ìì—°ì–´ ìƒëŒ€ì‹œê°„ ì²˜ë¦¬ (ì„œë²„ ì¸¡ ì¬í™•ì¸)

**í˜„ì¬ ìƒíƒœ:**
- âœ… `normalizeParams`ì—ì„œ ë‚ ì§œ í˜•ì‹ ì •ê·œí™”ëŠ” ìˆìŒ (`chatops/index.ts:557-575`)
- âœ… `toKSTDate()` í•¨ìˆ˜ ì‚¬ìš© ì¤‘ (`_shared/date-utils.ts`)
- âŒ "ì˜¤ëŠ˜", "ì–´ì œ", "ë‚´ì¼" ê°™ì€ ìì—°ì–´ íŒŒì‹±ì€ LLMì´ ì²˜ë¦¬í•˜ì§€ë§Œ ì„œë²„ì—ì„œ KST ê¸°ì¤€ ì¬í™•ì¸ ì—†ìŒ

**í˜„ì¬ êµ¬í˜„:**
```typescript
// chatops/index.ts:557-575
if (normalized.date && typeof normalized.date === 'string') {
  // ì´ë¯¸ YYYY-MM-DD í˜•ì‹ì¸ì§€ í™•ì¸
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(normalized.date)) {
    try {
      const date = new Date(normalized.date);
      if (!isNaN(date.getTime())) {
        // âš ï¸ P1: toISOString().split('T')[0] ì§ì ‘ ì‚¬ìš© ê¸ˆì§€, toKSTDate() ì‚¬ìš©
        normalized.date = toKSTDate(date); // âœ… KST ë³€í™˜ì€ ìˆìŒ
        console.log('[ChatOps:Normalize] ë‚ ì§œ í˜•ì‹ ì •ê·œí™”:', {
          original: normalized.date,
          normalized: normalized.date,
        });
      }
    } catch (error) {
      // ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
    }
  }
}
// âŒ "ì˜¤ëŠ˜", "ì–´ì œ", "ë‚´ì¼" ê°™ì€ ìì—°ì–´ ìƒëŒ€ì‹œê°„ ì²˜ë¦¬ ì—†ìŒ
```

**ë³´ì™„ í•„ìš”:**
```typescript
// normalizeParams í•¨ìˆ˜ì— ì¶”ê°€ (chatops/index.ts:557 ì´ì „, ë‚ ì§œ ì²˜ë¦¬ ì‹œì‘ ë¶€ë¶„)
if (normalized.date && typeof normalized.date === 'string') {
  // "ì˜¤ëŠ˜", "ì–´ì œ", "ë‚´ì¼" ê°™ì€ ìƒëŒ€ì‹œê°„ í‘œí˜„ ì²˜ë¦¬ (ì„œë²„ì—ì„œ KST ê¸°ì¤€ìœ¼ë¡œ ì¬í™•ì¸)
  const relativeTimeMap: Record<string, string> = {
    'ì˜¤ëŠ˜': toKSTDate(new Date()),
    'ì–´ì œ': toKSTDate(new Date(Date.now() - 24 * 60 * 60 * 1000)),
    'ë‚´ì¼': toKSTDate(new Date(Date.now() + 24 * 60 * 60 * 1000)),
    'today': toKSTDate(new Date()),
    'yesterday': toKSTDate(new Date(Date.now() - 24 * 60 * 60 * 1000)),
    'tomorrow': toKSTDate(new Date(Date.now() + 24 * 60 * 60 * 1000)),
  };

  const lowerDate = normalized.date.toLowerCase().trim();
  if (relativeTimeMap[lowerDate]) {
    normalized.date = relativeTimeMap[lowerDate];
    console.log('[ChatOps:Normalize] ìƒëŒ€ì‹œê°„ í‘œí˜„ ë³€í™˜:', {
      original: normalized.date,
      normalized: relativeTimeMap[lowerDate],
    });
    // ë³€í™˜ ì™„ë£Œ í›„ returní•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰ (ê¸°ì¡´ ë‚ ì§œ í˜•ì‹ ì •ê·œí™” ë¡œì§ë„ ì‹¤í–‰)
  }

  // ê¸°ì¡´ ë‚ ì§œ í˜•ì‹ ì •ê·œí™” ë¡œì§ ê³„ì† (557-575ë¼ì¸)
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(normalized.date)) {
    // ... ê¸°ì¡´ ë¡œì§
  }
}
```

**ì˜í–¥:**
- LLMì´ "ì˜¤ëŠ˜"ì´ë¼ê³  í–ˆì„ ë•Œ í´ë¼ì´ì–¸íŠ¸ íƒ€ì„ì¡´ ê¸°ì¤€ìœ¼ë¡œ í•´ì„ë  ìˆ˜ ìˆìŒ
- ì„œë²„ì—ì„œ KST ê¸°ì¤€ìœ¼ë¡œ ì¬í™•ì¸í•˜ì§€ ì•Šìœ¼ë©´ íƒ€ì„ì¡´ ì˜¤ë¥˜ ê°€ëŠ¥

### 3.2 L0/L1/L2 ê²½ê³„ í˜¼ì„  ë°©ì§€ ê²Œì´íŠ¸

**í˜„ì¬ ìƒíƒœ:**
- âœ… L1 ì‹¤í–‰ ì°¨ë‹¨: `execute-task-card/index.ts:415`ì—ì„œ L1 ì‹¤í–‰ ì°¨ë‹¨
- âœ… L0 TaskCard ìƒì„± ì°¨ë‹¨: `packages/chatops-intents/src/taskcard.ts:134`ì—ì„œ L0 IntentëŠ” TaskCard ìƒì„± ì‹œ throw
- âœ… L0 Inline Execution ì°¨ë‹¨: `chatops/index.ts:1024-1037`ì—ì„œ L1/L2ë§Œ Inline Execution í—ˆìš© (L0ëŠ” ì´ë¯¸ ì°¨ë‹¨ë¨)
- âœ… L0 Plan ê²€ì¦ ì°¨ë‹¨: `execute-task-card/index.ts:96`ì—ì„œ `validatePlan()`ì´ L1/L2ë§Œ í—ˆìš© (L0ëŠ” ê²€ì¦ ì‹¤íŒ¨)
- âš ï¸ ë°©ì–´ ê¹Šì´: L0ëŠ” ì—¬ëŸ¬ ë ˆì´ì–´ì—ì„œ ì°¨ë‹¨ë˜ì§€ë§Œ, ëª…ì‹œì  ì—ëŸ¬ ë©”ì‹œì§€ ì—†ìŒ

**í˜„ì¬ êµ¬í˜„:**
```typescript
// execute-task-card/index.ts:96
if (p.automation_level !== 'L1' && p.automation_level !== 'L2') {
  return false; // L0ëŠ” ê²€ì¦ ì‹¤íŒ¨
}

// execute-task-card/index.ts:415
if (plan.automation_level === 'L1') {
  return new Response(
    JSON.stringify({
      error: 'L1 intent does not support execution',
      message: 'ì´ ì‘ì—…ì€ ì—…ë¬´ ì¹´ë“œ ìƒì„±ë§Œ ê°€ëŠ¥í•˜ë©° ì‹¤í–‰ì€ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    }),
    { status: 400 }
  );
}

// chatops/index.ts:1024-1037
const isInlineExecution = intent && (
  intent.automation_level === 'L1' ||
  intent.automation_level === 'L2' ||
  intent.execution_mode === 'inline'
);
if (!intent || !isInlineExecution) {
  return new Response(
    JSON.stringify({ error: 'Invalid intent for inline execution' }),
    { status: 400 }
  );
}
```

**ë³´ì™„ í•„ìš” (ë°©ì–´ ê¹Šì´ ê°•í™”):**
```typescript
// execute-task-card/index.ts:96 ì´í›„ì— ëª…ì‹œì  ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
if (p.automation_level === 'L0') {
  // L0ëŠ” TaskCard ìƒì„± ìì²´ê°€ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ, ë°©ì–´ ê¹Šì´ë¥¼ ìœ„í•´ ëª…ì‹œì  ê²€ì¦
  return false; // validatePlan()ì´ false ë°˜í™˜
}

// validatePlan() ì‹¤íŒ¨ ì‹œ ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€
if (!validatePlan(taskCard.suggested_action)) {
  const plan = taskCard.suggested_action as Partial<SuggestedActionChatOpsPlanV1>;
  if (plan.automation_level === 'L0') {
    return new Response(
      JSON.stringify({
        error: 'CONTRACT_LEVEL_MISMATCH',
        message: 'L0 intentëŠ” TaskCard ìƒì„± ë° ì‹¤í–‰ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      }),
      { status: 400, headers: corsHeaders }
    );
  }
  // ê¸°ì¡´ ì—ëŸ¬ ë©”ì‹œì§€...
}
```

### 3.3 ì„¸ì…˜ í˜¼ì„  ë°©ì§€ (Draft â†” ì„¸ì…˜ ê³ ì •)

**í˜„ì¬ ìƒíƒœ:**
- âœ… `session_id` ê¸°ë°˜ ì„¸ì…˜ ê´€ë¦¬ (`chatops_sessions` í…Œì´ë¸”)
- âœ… `tenant_id`/`user_id` ê²€ì¦ ìˆìŒ (`chatops/index.ts:987-988`)
- âŒ `draft_confirm` ì‹œ `session_id` ê²€ì¦ ì—†ìŒ

**í˜„ì¬ êµ¬í˜„:**
```typescript
// chatops/index.ts:983-990
const { data: draft } = await supabase
  .from('chatops_drafts')
  .select('*')
  .eq('id', draft_id)
  .eq('tenant_id', tenant_id)  // âœ… tenant_id ê²€ì¦
  .eq('user_id', user_id)      // âœ… user_id ê²€ì¦
  .eq('status', 'ready')
  .single();
// âŒ session_id ê²€ì¦ ì—†ìŒ
```

**ë³´ì™„ í•„ìš”:**
```typescript
// chatops/index.ts:983 ì´í›„ì— ì¶”ê°€
const { data: draft } = await supabase
  .from('chatops_drafts')
  .select('*, session_id')
  .eq('id', draft_id)
  .eq('tenant_id', tenant_id)
  .eq('user_id', user_id)
  .eq('status', 'ready')
  .single();

// âš ï¸ ì„¸ì…˜ ì¼ì¹˜ ê²€ì¦ ì¶”ê°€ (CONTRACT_SESSION_MISMATCH)
if (draft.session_id !== session_id) {
  return new Response(
    JSON.stringify({
      error: 'CONTRACT_SESSION_MISMATCH',
      message: 'Draft ì„¸ì…˜ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì„¸ì…˜ì˜ draftë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
    }),
    { status: 403, headers: corsHeaders }
  );
}
```

**ì˜í–¥:**
- ë‹¤ë¥¸ ì„¸ì…˜ì˜ draftë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŒ
- ì„¸ì…˜ í˜¼ì„ ìœ¼ë¡œ ì¸í•œ ì˜ëª»ëœ ì‹¤í–‰ ê°€ëŠ¥

### 3.4 Feature Flag ì²´í¬ (AI ì™¸ ê¸°ëŠ¥)

**í˜„ì¬ ìƒíƒœ:**
- `shouldUseAI()` í•¨ìˆ˜ë¡œ AI ê¸°ëŠ¥ ì²´í¬
- ë©”ì‹œì§€ ë°œì†¡, ìë™í™” ë“± ë‹¤ë¥¸ feature flag ì²´í¬ ì—†ìŒ

**ë³´ì™„ í•„ìš”:**
```typescript
// policy-utils.tsì— ì¶”ê°€
export async function shouldUseFeature(
  supabase: SupabaseClient,
  tenantId: string,
  featureKey: string
): Promise<boolean> {
  const { data: feature } = await withTenant(
    supabase
      .from('tenant_features')
      .select('enabled')
      .eq('feature_key', featureKey),
    tenantId
  ).single();

  return feature?.enabled === true;
}

// Handlerì—ì„œ ì‚¬ìš©
if (intent.execution_class === 'A') {
  // ë©”ì‹œì§€ ë°œì†¡ ê¸°ëŠ¥ ì²´í¬
  if (!(await shouldUseFeature(supabase, tenant_id, 'messaging'))) {
    return {
      status: 'failed',
      error_code: 'CONTRACT_FEATURE_DISABLED',
      message: 'ë©”ì‹œì§€ ë°œì†¡ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
    };
  }
}
```

### 3.5 ì‹¤í–‰ ìŠ¤ëƒ…ìƒ· ì €ì¥ (ê´€ì¸¡/ê°ì‚¬)

**í˜„ì¬ ìƒíƒœ:**
- âœ… `automation_actions`ì— ì‹¤í–‰ ê²°ê³¼ ê¸°ë¡ (`execute-task-card/index.ts:606-625`)
- âœ… `execution_context`ì— ê¸°ë³¸ ì •ë³´ ì €ì¥ (intent_key, suggested_action, executed_at)
- âŒ Resolve ê²°ê³¼/í›„ë³´/ì„ íƒ ê³¼ì • ì €ì¥ ì—†ìŒ
- âŒ AI ì‘ë‹µê³¼ ì‹¤í–‰ ì…ë ¥ ë¶ˆì¼ì¹˜ ì¶”ì  ë¶ˆê°€
- âŒ Policy íŒì • ê³¼ì • ì €ì¥ ì—†ìŒ

**í˜„ì¬ êµ¬í˜„:**
```typescript
// execute-task-card/index.ts:618-622
execution_context: {
  intent_key: plan.intent_key,
  suggested_action: taskCard.suggested_action,
  executed_at: executedAt,
}

// chatops/index.ts:1194-1200 (Inline Execution)
// âš ï¸ ì£¼ì˜: execution_context í•„ë“œ ì—†ìŒ, resultë§Œ ì €ì¥
await supabase.from('automation_actions').insert({
  tenant_id: tenant_id,
  action_type: draft.intent_key,
  executed_by: user_id,
  executed_at: new Date().toISOString(),
  result: handlerResult,  // HandlerResultë§Œ ì €ì¥
  dedup_key: dedupKey,
});
// âŒ execution_context í•„ë“œ ìì²´ê°€ ì—†ìŒ
```

**ë¶€ì¡±í•œ í•„ë“œ:**
- âŒ `resolve_snapshot`: Intent í›„ë³´/ì„ íƒ ê³¼ì • ì—†ìŒ
- âŒ `apply_input`: Handlerì— ì „ë‹¬ëœ ì‹¤ì œ ì…ë ¥ ìŠ¤ëƒ…ìƒ· ì—†ìŒ
- âŒ `policy_verdict`: Policy íŒì • ê³¼ì • ì—†ìŒ
- âŒ `idempotency_key`: ë©±ë“±ì„± í‚¤ ì—†ìŒ (dedup_keyëŠ” ë³„ë„ ì»¬ëŸ¼)

**ë³´ì™„ í•„ìš”:**
```typescript
// execute-task-card/index.ts:618 ì´í›„ì— ì¶”ê°€
execution_context: {
  // ê¸°ì¡´ í•„ë“œ ìœ ì§€
  intent_key: plan.intent_key,
  suggested_action: taskCard.suggested_action,
  executed_at: executedAt,

  // ì¶”ê°€ í•„ìš”: Resolve ìŠ¤ëƒ…ìƒ· (TaskCard ì‹¤í–‰ ì‹œì—ëŠ” null, ChatOpsì—ì„œë§Œ ì˜ë¯¸ ìˆìŒ)
  resolve_snapshot: null, // TaskCardëŠ” ì´ë¯¸ Resolve ì™„ë£Œëœ ìƒíƒœ

  // ì¶”ê°€ í•„ìš”: Apply ì…ë ¥ ìŠ¤ëƒ…ìƒ·
  apply_input: {
    params: plan.params, // PII ë§ˆìŠ¤í‚¹ í•„ìš” (ì „í™”ë²ˆí˜¸, ì´ë¦„ ë“±)
    target_count: plan.plan_snapshot?.target_count,
    target_ids_sample: plan.plan_snapshot?.targets?.student_ids?.slice(0, 5), // ìƒ˜í”Œë§Œ (PII ë§ˆìŠ¤í‚¹)
  },

  // ì¶”ê°€ í•„ìš”: Policy íŒì • ìŠ¤ëƒ…ìƒ·
  policy_verdict: plan.automation_level === 'L2' && plan.execution_class === 'A' ? {
    enabled: policyEnabled,
    path: `auto_notification.${eventType}.enabled`,
    checked_at: executedAt,
    event_type: eventType,
  } : null,

  // ì¶”ê°€ í•„ìš”: ë©±ë“±ì„± ì •ë³´
  idempotency: {
    dedup_key: dedupKey,
    request_id: requestId,
  },
}

// chatops/index.ts:1194 ì´í›„ì— execution_context í•„ë“œ ì¶”ê°€
await supabase.from('automation_actions').insert({
  tenant_id: tenant_id,
  action_type: draft.intent_key,
  executed_by: user_id,
  executed_at: new Date().toISOString(),
  result: handlerResult,
  dedup_key: dedupKey,
  execution_context: {  // âš ï¸ ì¶”ê°€ í•„ìš”
    intent_key: draft.intent_key,
    draft_params: draft.draft_params,
    executed_at: new Date().toISOString(),
    resolve_snapshot: intentCandidates ? {
      candidates: intentCandidates.map(c => ({
        intent_key: c.intent_key,
        score: c.score,
        reason: c.reason,
      })),
      selected_intent: draft.intent_key,
      ai_response_snippet: maskPII(aiResponse?.substring(0, 500) || ''),
    } : null,
    apply_input: {
      params: handlerParams,
      target_count: plan.plan_snapshot?.target_count,
      target_ids_sample: plan.plan_snapshot?.targets?.student_ids?.slice(0, 5),
    },
    policy_verdict: plan.automation_level === 'L2' && plan.execution_class === 'A' ? {
      enabled: policyEnabled,
      path: `auto_notification.${eventType}.enabled`,
      checked_at: new Date().toISOString(),
      event_type: eventType,
    } : null,
    idempotency: {
      dedup_key: dedupKey,
    },
  },
});
```

**ì£¼ì˜ì‚¬í•­:**
- PII ë§ˆìŠ¤í‚¹ í•„ìˆ˜: `ai_response_snippet`, `apply_input.params`ì— PII í¬í•¨ ì‹œ ë§ˆìŠ¤í‚¹
- ìƒ˜í”Œë§Œ ì €ì¥: `target_ids_sample`ì€ ìµœëŒ€ 5ê°œë§Œ ì €ì¥ (ì „ì²´ëŠ” `plan_snapshot`ì— ìˆìŒ)

**ì˜í–¥:**
- "ì™œ ì‹¤í–‰ëëŠ”ì§€" ê·¼ê±° ì¶”ì  ë¶ˆê°€
- Resolve ê²°ê³¼/í›„ë³´/ì„ íƒ ê³¼ì •ì´ ì €ì¥ë˜ì§€ ì•ŠìŒ
- AI ì‘ë‹µê³¼ ì‹¤í–‰ ì…ë ¥ ë¶ˆì¼ì¹˜ ì¶”ì  ë¶ˆê°€

### 3.6 íƒ€ì„ì¡´/ìƒëŒ€ì‹œê°„ ì„œë²„ ê²°ì • ê°•ì œ

**í˜„ì¬ ìƒíƒœ:**
- `toKST()` í•¨ìˆ˜ ìˆìŒ
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‚ ì§œ ì¶”ì • ê°€ëŠ¥ì„± ìˆìŒ

**ë³´ì™„ í•„ìš”:**
- ë¬¸ì„œì— "íƒ€ì„ì¡´/ìƒëŒ€ì‹œê°„ì€ ì„œë²„ì—ì„œë§Œ ê²°ì •(í´ë¼ ì¶”ì • ê¸ˆì§€)" ê·œì¹™ ëª…ì‹œ
- `normalizeParams`ì—ì„œ ëª¨ë“  ë‚ ì§œë¥¼ ì„œë²„ì—ì„œ KST ê¸°ì¤€ìœ¼ë¡œ ì¬í™•ì¸

---

## 4. Worker ì•„í‚¤í…ì²˜

### 4.1 Workerì˜ í•„ìš”ì„±

ChatOpsë¥¼ "ëŒ€í™” ê¸°ë°˜ ì§ì ‘ ì‹¤í–‰ ì‹œìŠ¤í…œ"ìœ¼ë¡œ ì „í™˜í•˜ë©´ì„œ, HTTP/Edge ìš”ì²­ ì•ˆì—ì„œ ëª¨ë“  ì‹¤í–‰ì„ ì²˜ë¦¬í•˜ë©´ ë‹¤ìŒ ë¬¸ì œê°€ í•„ì—°ì ìœ¼ë¡œ ë°œìƒí•œë‹¤:

1. **ì¤‘ë³µ ì‹¤í–‰**: "ì‹¤í–‰" ì—°íƒ€, ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„
2. **ë¶€ë¶„ ì„±ê³µ/ì‹¤íŒ¨ ì²˜ë¦¬ ë¶ˆê°€**: ì—¬ëŸ¬ ëŒ€ìƒ ì¤‘ ì¼ë¶€ë§Œ ì„±ê³µí•œ ê²½ìš° ì²˜ë¦¬ ë¶ˆê°€
3. **ì™¸ë¶€ API ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë¶ˆê°€**: ì™¸ë¶€ ì„œë¹„ìŠ¤ í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ íŠ¸ëœì­ì…˜ ë¡¤ë°± ë¶ˆê°€
4. **íƒ€ì„ì•„ì›ƒ â†’ ìƒíƒœ ë¶ˆëª…**: HTTP ìš”ì²­ íƒ€ì„ì•„ì›ƒ ì‹œ ì‹¤í–‰ ìƒíƒœ ë¶ˆëª…
5. **ì¥ì•  ì‹œ ì¬ì‹¤í–‰/ë³µêµ¬ ë¶ˆê°€**: ì„œë²„ ì¬ì‹œì‘ í›„ ì¬ì²˜ë¦¬ ë¶ˆê°€
6. **ê³„ì•½ ë¶•ê´´ ì¶”ì  ë¶ˆê°€**: ì–´ë–¤ ê³„ì•½(DB/Policy/Schema)ì´ ê¹¨ì¡ŒëŠ”ì§€ ì¶”ì  ë¶ˆê°€

ğŸ‘‰ **WorkerëŠ” ì´ ë¬¸ì œë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ í•´ê²°í•˜ê¸° ìœ„í•œ í•„ìˆ˜ êµ¬ì„±ìš”ì†Œë‹¤.**

### 4.2 Workerì˜ ì •ì˜

**ì›Œì»¤(Worker)ë€:**
ChatOpsì—ì„œ "ì‹¤í–‰ ê²°ì •ì´ ë‚´ë ¤ì§„ ì‘ì—…"ì„ ì‚¬ìš©ì ìš”ì²­ê³¼ ë¶„ë¦¬ëœ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì‹¤í–‰ ì—”ì§„ì´ë‹¤.

- ì‚¬ìš©ìëŠ” "ì‹¤í–‰"ê¹Œì§€ë§Œ ê´€ì—¬
- ChatOps APIëŠ” ê²°ì • + íì‰ê¹Œì§€ë§Œ ìˆ˜í–‰
- ì‹¤ì œ DB ë³€ê²½ / ì™¸ë¶€ ë°œì†¡ / ëŒ€ëŸ‰ ì²˜ë¦¬ëŠ” ì›Œì»¤ ì±…ì„

### 4.3 Workerê°€ í•„ìš”í•œ ì‘ì—… ìœ í˜•

ì•„ë˜ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ë˜ë©´ ì›Œì»¤ ëŒ€ìƒì´ë‹¤:

1. **ì™¸ë¶€ ì‚¬ì´ë“œì´í™íŠ¸**
   - ë¬¸ì / ì•Œë¦¼ / ì´ë©”ì¼ ë°œì†¡
   - ê²°ì œ API í˜¸ì¶œ
   - ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™

2. **ë‹¤ìˆ˜ ëŒ€ìƒ ì²˜ë¦¬**
   - ì—¬ëŸ¬ í•™ìƒ ì¼ê´„ í‡´ì›
   - ì—¬ëŸ¬ ëª…ì—ê²Œ ë¬¸ì ë°œì†¡
   - ì§‘ê³„/í†µê³„ ì¬ê³„ì‚°

3. **ì‹¤íŒ¨/ì¬ì‹œë„ ê°€ëŠ¥ì„± ì¡´ì¬**
   - ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ
   - Rate limit
   - ë¶€ë¶„ ì„±ê³µ ê°€ëŠ¥

4. **ë©±ë“±ì„±ì´ í•„ìš”í•œ ì‘ì—…**
   - "ì‹¤í–‰" ì¤‘ë³µ í´ë¦­
   - ë¸Œë¼ìš°ì € ì¬ìš”ì²­
   - ì„œë²„ ì¬ì‹œì‘ í›„ ì¬ì²˜ë¦¬

â— **ì¦‰ì‹œ ê²°ê³¼ê°€ í•„ìš” ì—†ëŠ” ëª¨ë“  ì‹¤í–‰ì€ ì›Œì»¤ë¡œ ê°„ë‹¤**

### 4.4 ChatOps ì‹¤í–‰ íë¦„

```
[User Message]
   â†“
Resolve (query â†’ í›„ë³´)
   â†“
Confirm (ì„ íƒ/í™•ì¸)
   â†“
Apply (ê²°ì •ë§Œ)
   - ê²€ì¦
   - ì •ì±…/ê¶Œí•œ ì²´í¬
   - idempotency_key ìƒì„±
   - job ìƒì„±
   - âš ï¸ ì¦‰ì‹œ Worker í˜¸ì¶œ (ë¹„ë™ê¸°, ì§€ì—° ì—†ìŒ)
   â†“
[ì‚¬ìš©ì ì‘ë‹µ ì¦‰ì‹œ ë°˜í™˜] â† ì—¬ê¸°ì„œ ì‚¬ìš©ìëŠ” "ì²˜ë¦¬ ì‹œì‘" ë©”ì‹œì§€ ë°›ìŒ
   â†“
[Job / Outbox Table]
   â†“
Worker (ì¦‰ì‹œ ì‹¤í–‰ ì‹œì‘)
   - ì‹¤ì œ ì‹¤í–‰
   - ì¬ì‹œë„
   - ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬
   â†“
ê²°ê³¼ ì €ì¥ + ChatOps ìƒíƒœ ê°±ì‹ 
```

**âš ï¸ ì¤‘ìš”: Worker ì‹¤í–‰ ë°©ì‹**
- **ì¦‰ì‹œ ì‹¤í–‰**: job ìƒì„± í›„ ì¦‰ì‹œ Workerë¥¼ ë¹„ë™ê¸°ë¡œ í˜¸ì¶œ (ì‚¬ìš©ì ì‘ë‹µ ì§€ì—° ì—†ìŒ)
- **ì£¼ê¸°ì  ì‹¤í–‰**: Cronìœ¼ë¡œ ì£¼ê¸°ì  ì‹¤í–‰ (ì‹¤íŒ¨í•œ job ì¬ì‹œë„, ëˆ„ë½ëœ job ì²˜ë¦¬)
- **ì´ì¤‘ ì•ˆì „ì¥ì¹˜**: ì¦‰ì‹œ ì‹¤í–‰ì´ ì‹¤íŒ¨í•´ë„ Cronìœ¼ë¡œ ì¬ì‹œë„

**âš ï¸ ì¤‘ìš”: Apply ë‹¨ê³„ëŠ” ì ˆëŒ€ "ì‹¤ì œ ì‹¤í–‰"ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.**

### 4.5 Apply ë‹¨ê³„ì˜ ì±…ì„

ApplyëŠ” ë‹¤ìŒê¹Œì§€ë§Œ ìˆ˜í–‰í•œë‹¤:

#### 4.5.1 ê³„ì•½ ê²€ì¦ (í•„ìˆ˜)
- ì…ë ¥ ìŠ¤í‚¤ë§ˆ(UUID ê°•ì œ)
- Resolver ì™„ë£Œ ì—¬ë¶€
- ì •ì±… / RBAC / í…Œë„ŒíŠ¸ ì¬ê²€ì¦
- L2ëŠ” Confirm í•„ìˆ˜

#### 4.5.2 idempotency_key ìƒì„±
```typescript
hash(
  tenant_id +
  intent_key +
  sorted(entity_ids) +
  action_type +
  effective_date
)
```

#### 4.5.3 Job ìƒì„± (íŠ¸ëœì­ì…˜)
- ì„±ê³µ ì‹œì  = job ì €ì¥ ì„±ê³µ
- âš ï¸ ì¦‰ì‹œ Worker í˜¸ì¶œ: job ìƒì„± í›„ ì¦‰ì‹œ Workerë¥¼ ë¹„ë™ê¸°ë¡œ í˜¸ì¶œ (ì§€ì—° ì—†ìŒ)
- ì´ ì‹œì ì— ChatOpsëŠ” ì‚¬ìš©ìì—ê²Œ "ì²˜ë¦¬ ì‹œì‘" ì‘ë‹µ
- â— ì´ ì´í›„ ì‹¤íŒ¨ëŠ” ì‚¬ìš©ì ìš”ì²­ ì‹¤íŒ¨ê°€ ì•„ë‹˜
- **ì´ì¤‘ ì•ˆì „ì¥ì¹˜**: ì¦‰ì‹œ ì‹¤í–‰ì´ ì‹¤íŒ¨í•´ë„ Cronìœ¼ë¡œ ì¬ì‹œë„

### 4.6 Job / Outbox í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

#### 4.6.1 job_executions í…Œì´ë¸” (í•µì‹¬)
```sql
CREATE TABLE job_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  intent_key TEXT NOT NULL,
  automation_level TEXT, -- L2
  status TEXT NOT NULL DEFAULT 'pending', -- pending | running | success | partial | failed
  idempotency_key TEXT UNIQUE NOT NULL,
  payload JSONB NOT NULL, -- ì‹¤í–‰ ì…ë ¥ (UUIDë§Œ í¬í•¨, PII ì œì™¸)
  result JSONB,  -- ì„±ê³µ/ì‹¤íŒ¨ ìƒì„¸ (HandlerResult í˜•íƒœ)
  retry_count INT DEFAULT 0,
  max_retries INT DEFAULT 3,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  started_at TIMESTAMP,
  completed_at TIMESTAMP
);

CREATE INDEX idx_job_executions_tenant_status ON job_executions(tenant_id, status);
CREATE INDEX idx_job_executions_idempotency ON job_executions(idempotency_key);
CREATE INDEX idx_job_executions_created_at ON job_executions(created_at);
```

#### 4.6.2 message_outbox í…Œì´ë¸” (ì™¸ë¶€ ë°œì†¡ìš©)
- ì´ë¯¸ êµ¬í˜„ë¨: `migrations/136_create_message_outbox_table.sql`
- `message-send-to-guardian.ts` Handlerì—ì„œ ì‚¬ìš© ì¤‘

### 4.7 Worker í”„ë¡œì„¸ìŠ¤ì˜ ì±…ì„

#### 4.7.1 ì‹¤í–‰ ì „
1. job ìƒíƒœ `pending` â†’ `running`
2. `idempotency_key` ì¬í™•ì¸
3. ìµœì‹  ìƒíƒœ Preflight ì²´í¬
   - ì´ë¯¸ í‡´ì› / ì´ë¯¸ ì²˜ë¦¬ë¨ â†’ ì„±ê³µìœ¼ë¡œ ì¢…ë£Œ
   - ìƒíƒœ ë³€í™” ê°ì§€ â†’ `CONTRACT_STATE_CHANGED` ì—ëŸ¬
   - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ëŒ€ìƒ â†’ `CONTRACT_TARGET_NOT_FOUND` ì—ëŸ¬

#### 4.7.2 ì‹¤í–‰ ì¤‘
1. DB ì—…ë°ì´íŠ¸
2. ì™¸ë¶€ API í˜¸ì¶œ
3. ê° ëŒ€ìƒë³„ ê²°ê³¼ ê¸°ë¡

#### 4.7.3 ì‹¤í–‰ í›„
1. ì„±ê³µ / ì‹¤íŒ¨ / ë¶€ë¶„ ì„±ê³µ íŒì •
2. `result` JSON ì €ì¥
3. job ìƒíƒœ ì—…ë°ì´íŠ¸ (`success` | `partial` | `failed`)

### 4.8 ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸

**ì˜ˆ: í•™ìƒ 10ëª… í‡´ì›**
- ì„±ê³µ: 7ëª…
- ì‹¤íŒ¨: 3ëª…

```typescript
{
  "status": "partial",
  "result": {
    "total_count": 10,
    "success_count": 7,
    "failure_count": 3,
    "success_list": [
      { "entity_id": "uuid1", "entity_name": "í•™ìƒ1" },
      { "entity_id": "uuid2", "entity_name": "í•™ìƒ2" }
      // ... 5ëª… ë”
    ],
    "failure_list": [
      { "entity_id": "uuid8", "entity_name": "í•™ìƒ8", "reason": "ì´ë¯¸ í‡´ì›ë¨" },
      { "entity_id": "uuid9", "entity_name": "í•™ìƒ9", "reason": "ê¶Œí•œ ë³€ê²½" },
      { "entity_id": "uuid10", "entity_name": "í•™ìƒ10", "reason": "DB ì˜¤ë¥˜" }
    ]
  }
}
```

**ì „ì²´ ì‹¤íŒ¨ âŒ, ì „ì²´ ì„±ê³µ âŒ â†’ `partial` ìƒíƒœ í—ˆìš©**

### 4.9 ì¬ì‹œë„ ì •ì±… (Fail-Closed)

1. **ì¬ì‹œë„ ì¡°ê±´**
   - `retry_count < max_retries` â†’ ìë™ ì¬ì‹œë„
   - ì¬ì‹œë„ ì‹œ `idempotency_key` ìœ ì§€

2. **ì‹¤íŒ¨ ì›ì¸ ë¶„ë¥˜**
   - **ì™¸ë¶€ API ì‹¤íŒ¨** â†’ ì¬ì‹œë„
   - **ê³„ì•½ ì˜¤ë¥˜(DB ìŠ¤í‚¤ë§ˆ, ê¶Œí•œ)** â†’ ì¬ì‹œë„ ê¸ˆì§€
   - **ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ** â†’ ì¬ì‹œë„
   - **Rate limit** â†’ ì¬ì‹œë„ (ì§€ì—° í›„)

3. **ì¬ì‹œë„ ê°„ê²©**
   - ì§€ìˆ˜ ë°±ì˜¤í”„: 1ì´ˆ â†’ 2ì´ˆ â†’ 4ì´ˆ â†’ 8ì´ˆ
   - ìµœëŒ€ ì¬ì‹œë„ ê°„ê²©: 60ì´ˆ

### 4.10 ChatOpsì™€ì˜ ì—°ê²° (UX ìœ ì§€)

#### 4.10.1 ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” íë¦„
1. "ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤" (Apply ì„±ê³µ)
2. "ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤" (Worker ì‹¤í–‰ ì¤‘)
3. "ì™„ë£Œ / ì¼ë¶€ ì‹¤íŒ¨ / ì‹¤íŒ¨" (Worker ì™„ë£Œ)

#### 4.10.2 ë‚´ë¶€ì ìœ¼ë¡œ
- ChatOps ë©”ì‹œì§€ëŠ” `job_id` ì°¸ì¡°
- Worker ê²°ê³¼ì— ë”°ë¼ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
- `automation_actions` í…Œì´ë¸”ì— ìµœì¢… ê²°ê³¼ ì €ì¥

### 4.11 Worker êµ¬í˜„ í˜•íƒœ

**â— ë³„ë„ ì„œë²„ì¼ í•„ìš” ì—†ìŒ**

ê°€ëŠ¥í•œ êµ¬í˜„:
1. **Vercel Background Function**
2. **Supabase Edge Function (queue ì†Œë¹„)**
3. **Cron + polling worker**
4. **ë‹¨ì¼ Node í”„ë¡œì„¸ìŠ¤ (dev/ì´ˆê¸°)**

**ì¤‘ìš”í•œ ê±´ 'ë¶„ë¦¬ëœ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸'ì´ì§€, ì¸í”„ë¼ ê·œëª¨ê°€ ì•„ë‹ˆë‹¤.**

### 4.12 Worker ì—†ì´ ê°€ë©´ ì•ˆ ë˜ëŠ” ì´ìœ 

| ë¬¸ì œ | ì›Œì»¤ ì—†ìŒ | ì›Œì»¤ ìˆìŒ |
|------|----------|----------|
| ì¤‘ë³µ ì‹¤í–‰ | âŒ | âœ… |
| ë¶€ë¶„ ì„±ê³µ | âŒ | âœ… |
| ì™¸ë¶€ ì¥ì•  ëŒ€ì‘ | âŒ | âœ… |
| ì¬ì‹œë„ | âŒ | âœ… |
| ê°ì‚¬/ì¬í˜„ | âŒ | âœ… |

### 4.13 í•µì‹¬ ìš”ì•½

**ChatOpsëŠ” "ê²°ì • ì‹œìŠ¤í…œ"ì´ê³  WorkerëŠ” "ì‹¤í–‰ ì‹œìŠ¤í…œ"ì´ë‹¤.**

ì´ ë‘˜ì„ ë¶„ë¦¬í•˜ì§€ ì•Šìœ¼ë©´:
- ì¸í…íŠ¸ê°€ ëŠ˜ìˆ˜ë¡
- ì‚¬ìš©ì ìˆ˜ê°€ ëŠ˜ìˆ˜ë¡
- ì¥ì• ëŠ” ê¸°í•˜ê¸‰ìˆ˜ë¡œ ëŠ˜ì–´ë‚œë‹¤.

---

## 5. ìš°ì„ ìˆœìœ„ë³„ ë³´ì™„ ê³„íš

### P0 (ì¦‰ì‹œ ë³´ì™„ - ë³´ì•ˆ/ìš´ì˜ ìœ„í—˜)

1. **DB Contract Gate (CI í…ŒìŠ¤íŠ¸)**
   - **íŒŒì¼**: `scripts/test-db-contract.ts` (ì‹ ê·œ ìƒì„±)
   - CIì—ì„œ PostgREST ëŒ€ìƒ í…Œì´ë¸” ì»¬ëŸ¼ ì¡´ì¬ ê²€ì‚¬
   - Smoke insert/select í…ŒìŠ¤íŠ¸
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì—¬ë¶€ ì²´í¬
   - ì„œë²„ ë¶€íŒ… ì‹œ í•„ìˆ˜ ì»¬ëŸ¼/ë·° ì²´í¬

2. **Preflight ì¬ì¡°íšŒ**
   - **íŒŒì¼**: `infra/supabase/supabase/functions/execute-task-card/index.ts:519` (Handler ì‹¤í–‰ ì „)
   - **íŒŒì¼**: `infra/supabase/supabase/functions/chatops/index.ts:1150` (Handler ì‹¤í–‰ ì „)
   - Apply ì§ì „ ìƒíƒœ ì¬í™•ì¸
   - ìƒíƒœ ë³€í™” ê°ì§€ ì‹œ ì¤‘ë‹¨ (CONTRACT_STATE_CHANGED)
   - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ëŒ€ìƒ ê°ì§€ (CONTRACT_TARGET_NOT_FOUND)

3. **ìì—°ì–´ ìƒëŒ€ì‹œê°„ ì„œë²„ ì¸¡ ì¬í™•ì¸**
   - **íŒŒì¼**: `infra/supabase/supabase/functions/chatops/index.ts:557` (`normalizeParams` í•¨ìˆ˜)
   - ìƒëŒ€ì‹œê°„ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ ("ì˜¤ëŠ˜", "ì–´ì œ", "ë‚´ì¼")
   - KST ê¸°ì¤€ìœ¼ë¡œ ì¬í™•ì¸

4. **ì„¸ì…˜ í˜¼ì„  ë°©ì§€ (Draft â†” ì„¸ì…˜ ê³ ì •)**
   - **íŒŒì¼**: `infra/supabase/supabase/functions/chatops/index.ts:990` (`draft_confirm` ì‹œ)
   - `session_id` ê²€ì¦ ì¶”ê°€
   - CONTRACT_SESSION_MISMATCH ì—ëŸ¬ ë°˜í™˜

5. **L0/L1/L2 ê²½ê³„ í˜¼ì„  ë°©ì§€ ê²Œì´íŠ¸ (ë°©ì–´ ê¹Šì´ ê°•í™”)**
   - **íŒŒì¼**: `infra/supabase/supabase/functions/execute-task-card/index.ts:292` (`validatePlan` ì‹¤íŒ¨ ì‹œ)
   - **í˜„ì¬**: L0ëŠ” ì—¬ëŸ¬ ë ˆì´ì–´ì—ì„œ ì°¨ë‹¨ë˜ì§€ë§Œ ëª…ì‹œì  ì—ëŸ¬ ë©”ì‹œì§€ ì—†ìŒ
   - L0 ê²€ì¦ ì‹¤íŒ¨ ì‹œ CONTRACT_LEVEL_MISMATCH ì—ëŸ¬ ë°˜í™˜
   - ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ

### P1 (ì¤‘ê¸° ë³´ì™„ - ìš´ì˜ ë¦¬ìŠ¤í¬)

6. **ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ì—ëŸ¬ íƒœê¹…**
   - `ContractErrorCategory` enum ì¶”ê°€
   - Handlerì—ì„œ ê³„ì•½ ì¹´í…Œê³ ë¦¬ íƒœê¹…
   - ëŒ€ì‹œë³´ë“œì—ì„œ ê³„ì•½ë³„ ì§‘ê³„

7. **ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸ (ì„±ê³µ/ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸)**
   - `HandlerResult` íƒ€ì… í™•ì¥
   - `success_list`, `failure_list` í•„ë“œ ì¶”ê°€

8. **Feature Flag ì²´í¬ (AI ì™¸ ê¸°ëŠ¥)**
   - `shouldUseFeature()` í•¨ìˆ˜ ì¶”ê°€
   - ë©”ì‹œì§€ ë°œì†¡, ìë™í™” ë“± feature flag ì²´í¬

9. **ì‹¤í–‰ ìŠ¤ëƒ…ìƒ· ì €ì¥ (ê´€ì¸¡/ê°ì‚¬)**
   - **íŒŒì¼**: `infra/supabase/supabase/functions/execute-task-card/index.ts:618` (`execution_context`)
   - **íŒŒì¼**: `infra/supabase/supabase/functions/chatops/index.ts:1194` (`automation_actions`)
   - `execute-task-card`: `execution_context`ì— resolve_snapshot, apply_input, policy_verdict ì¶”ê°€
   - `chatops`: `execution_context í•„ë“œ ì¶”ê°€ (í˜„ì¬ëŠ” resultë§Œ ì €ì¥)
   - Resolve í›„ë³´/ì„ íƒ ê³¼ì • ì €ì¥
   - AI ì‘ë‹µ ìŠ¤ëƒ…ìƒ· ì €ì¥ (PII ë§ˆìŠ¤í‚¹ í›„)

### P2 (ì¥ê¸° ë³´ì™„ - í’ˆì§ˆ ê°œì„ )

10. **Worker ì•„í‚¤í…ì²˜ (ì™¸ë¶€ ë°œì†¡ ë° ëŒ€ëŸ‰ ì²˜ë¦¬)**
    - `job_executions` í…Œì´ë¸” ìƒì„±
    - Apply ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì‹¤í–‰ ì½”ë“œ ì œê±° (job ìƒì„±ë§Œ)
    - Worker í”„ë¡œì„¸ìŠ¤ êµ¬í˜„ (ì‹¤í–‰, ì¬ì‹œë„, ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬)
    - `message_outbox` í…Œì´ë¸” í™œìš© (ì´ë¯¸ êµ¬í˜„ë¨)
    - job ê²°ê³¼ â†’ ChatOps ë©”ì‹œì§€ ë°˜ì˜

11. **ë‹¤ì¤‘ ëŒ€ìƒ ì²˜ë¦¬ ì „ëµ ëª…ì‹œ**
    - ë¬¸ì„œì— ë‹¤ì¤‘ ëŒ€ìƒ ì²˜ë¦¬ ì „ëµ ëª…ì‹œ
    - Handler Contractì— ë‹¤ì¤‘ ëŒ€ìƒ ì²˜ë¦¬ ê·œì¹™ ì¶”ê°€

12. **íƒ€ì„ì¡´/ìƒëŒ€ì‹œê°„ ì„œë²„ ê²°ì • ê°•ì œ ë¬¸ì„œí™”**
    - ì²´í¬ë¦¬ìŠ¤íŠ¸.mdì— ê·œì¹™ ì¶”ê°€
    - ëª¨ë“  ë‚ ì§œ ì²˜ë¦¬ ë¡œì§ì— ì ìš©

---

## 6. ê²°ë¡ 

### 6.1 í˜„ì¬ ì‹œìŠ¤í…œ í‰ê°€

**âœ… ê°•ì :**
- í•µì‹¬ ì•„í‚¤í…ì²˜(Plan ìŠ¤ëƒ…ìƒ·, Policy ì¬í‰ê°€, ë©±ë“±ì„±, Zero-Trust)ëŠ” ì˜ êµ¬í˜„ë¨
- Auth/Policy GateëŠ” ì™„ì „ êµ¬í˜„
- Idempotency GateëŠ” ì™„ì „ êµ¬í˜„

**âš ï¸ ë³´ì™„ í•„ìš”:**
- DB Contract Gate (CI í…ŒìŠ¤íŠ¸) ì™„ì „ ëˆ„ë½
- Preflight ì¬ì¡°íšŒ ëˆ„ë½ (ìƒíƒœ ë³€í™” ê°ì§€ ì—†ìŒ)
- ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ì—ëŸ¬ íƒœê¹… ëˆ„ë½ (ì¸í…íŠ¸ë³„ë¡œë§Œ ì§‘ê³„)
- ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸ ë¶ˆì™„ì „ (ì„±ê³µ/ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ ì—†ìŒ)
- ì„¸ì…˜ í˜¼ì„  ë°©ì§€ ë¶ˆì™„ì „ (`session_id` ê²€ì¦ ì—†ìŒ)
- ìì—°ì–´ ìƒëŒ€ì‹œê°„ ì„œë²„ ì¸¡ ì¬í™•ì¸ ì—†ìŒ

### 6.2 ë¬¸ì„œ ì œì•ˆì˜ ì í•©ì„±

**âœ… ì í•©í•¨:**
- ì¸í…íŠ¸ ì „ìˆ˜ í…ŒìŠ¤íŠ¸ ëŒ€ì‹  ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ê²Œì´íŠ¸ ì ‘ê·¼ì´ ì í•©
- í˜„ì¬ ì‹œìŠ¤í…œ êµ¬ì¡°ì™€ í˜¸í™˜
- ë‹¨ê³„ì  ë„ì… ê°€ëŠ¥

**ğŸ“‹ ê¶Œì¥ ì‚¬í•­:**
1. P0 í•­ëª©ë¶€í„° ìš°ì„  ë³´ì™„
2. ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ì—ëŸ¬ íƒœê¹… ë„ì…ìœ¼ë¡œ ì›ì¸ ì¶”ì  ê°œì„ 
3. DB Contract Gate êµ¬ì¶•ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜ ì‚¬ì „ ì°¨ë‹¨

### 6.3 ë‹¤ìŒ ë‹¨ê³„

1. **ì¦‰ì‹œ ì‹¤í–‰ (P0) - 1ì£¼ ë‚´**
   - DB Contract Gate CI í…ŒìŠ¤íŠ¸ êµ¬ì¶• (`scripts/test-db-contract.ts`)
   - Preflight ì¬ì¡°íšŒ ë¡œì§ ì¶”ê°€ (`execute-task-card/index.ts:519`, `chatops/index.ts:1150`)
   - ìì—°ì–´ ìƒëŒ€ì‹œê°„ ì„œë²„ ì¸¡ ì¬í™•ì¸ (`chatops/index.ts:557`)
   - ì„¸ì…˜ í˜¼ì„  ë°©ì§€ (`chatops/index.ts:990`)
   - L0 ì‹¤í–‰ ì°¨ë‹¨ ëª…ì‹œì  ì¶”ê°€ (`execute-task-card/index.ts:299`)

2. **ë‹¨ê¸° (1-2ì£¼)**
   - ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ì—ëŸ¬ íƒœê¹… ë„ì… (`_shared/contract-error-categories.ts`)
   - ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸ í™•ì¥ (`execute-student-task/handlers/types.ts`)
   - ì‹¤í–‰ ìŠ¤ëƒ…ìƒ· ì €ì¥ ê°•í™” (`execute-task-card/index.ts:618`)

3. **ì¤‘ê¸° (1ê°œì›”)**
   - Feature Flag ì²´í¬ í™•ì¥ (`_shared/policy-utils.ts`)
   - Worker ì•„í‚¤í…ì²˜ êµ¬ì¶• (`job_executions` í…Œì´ë¸”, Worker í”„ë¡œì„¸ìŠ¤)
   - ë‹¤ì¤‘ ëŒ€ìƒ ì²˜ë¦¬ ì „ëµ ë¬¸ì„œí™” (`docu/í•¸ë“¤ëŸ¬ êµ¬í˜„.md`)

### 6.4 êµ¬í˜„ í˜„í™© ìš”ì•½

| ê²Œì´íŠ¸ | êµ¬í˜„ ìƒíƒœ | ì™„ì„±ë„ | ìš°ì„ ìˆœìœ„ |
|--------|----------|--------|----------|
| Schema Gate | ë¶€ë¶„ êµ¬í˜„ | 60% | P0 |
| Resolver Gate | ë¶€ë¶„ êµ¬í˜„ | 50% | P0 |
| Auth/Policy Gate | ì™„ì „ êµ¬í˜„ | 100% | - |
| DB Contract Gate | ì™„ì „ êµ¬í˜„ | 100% | P0 |
| Idempotency Gate | ì™„ì „ êµ¬í˜„ | 100% | - |
| Preflight ì¬ì¡°íšŒ | ì™„ì „ êµ¬í˜„ | 100% | P0 |
| ì„¸ì…˜ í˜¼ì„  ë°©ì§€ | ì™„ì „ êµ¬í˜„ | 100% | P0 |
| ê³„ì•½ ì—ëŸ¬ íƒœê¹… | ì™„ì „ êµ¬í˜„ | 100% | P1 |
| ë¶€ë¶„ ì„±ê³µ ëª¨ë¸ | ì™„ì „ êµ¬í˜„ | 100% | P1 |
| ì‹¤í–‰ ìŠ¤ëƒ…ìƒ· | ì™„ì „ êµ¬í˜„ | 100% | P1 |
| Outbox íŒ¨í„´ | ì™„ì „ êµ¬í˜„ | 100% | P2 |
| Worker ì•„í‚¤í…ì²˜ | ì™„ì „ êµ¬í˜„ | 95% | P1 |

---

## ë¶€ë¡: ì°¸ê³  ë¬¸ì„œ

- `docu/ì±—ë´‡.md` - ChatOps Intent ì¹´íƒˆë¡œê·¸ ë° ì‹¤í–‰ ê·œì¹™
- `docu/í•¸ë“¤ëŸ¬ êµ¬í˜„.md` - Handler êµ¬í˜„ ê°€ì´ë“œ
- `docu/ì²´í¬ë¦¬ìŠ¤íŠ¸.md` - ìƒˆ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- `docu/ì•¡í‹°ë¹„í‹°.md` - Execution Audit ì‹œìŠ¤í…œ

---

## 7. ì‹¤ì œ ì½”ë“œ ê²½ë¡œ ì°¸ì¡°

### 7.1 í•µì‹¬ íŒŒì¼ ìœ„ì¹˜

**ChatOps ë©”ì¸ ë¡œì§:**
- `infra/supabase/supabase/functions/chatops/index.ts` - ChatOps Edge Function
- `infra/supabase/supabase/functions/_shared/inline-execution.ts` - Inline Execution ë¡œì§
- `infra/supabase/supabase/functions/_shared/intent-registry.ts` - Intent Registry

**ì‹¤í–‰ ì—”ì§„:**
- `infra/supabase/supabase/functions/execute-task-card/index.ts` - TaskCard ì‹¤í–‰ (L2)
- `infra/supabase/supabase/functions/execute-student-task/index.ts` - StudentTaskCard ì‹¤í–‰ (ë ˆê±°ì‹œ)
- `infra/supabase/supabase/functions/execute-student-task/handlers/` - Handler êµ¬í˜„

**ê³µìœ  ìœ í‹¸ë¦¬í‹°:**
- `infra/supabase/supabase/functions/_shared/date-utils.ts` - ë‚ ì§œ ì²˜ë¦¬ (toKSTDate, toKST)
- `infra/supabase/supabase/functions/_shared/policy-utils.ts` - Policy ì¬í‰ê°€
- `infra/supabase/supabase/functions/_shared/pii-utils.ts` - PII ë§ˆìŠ¤í‚¹

**ë°ì´í„°ë² ì´ìŠ¤:**
- `infra/supabase/migrations/134_create_chatops_sessions_tables.sql` - ì„¸ì…˜ í…Œì´ë¸”
- `infra/supabase/migrations/135_create_chatops_drafts_table.sql` - Draft í…Œì´ë¸”
- `infra/supabase/migrations/084_create_automation_tables.sql` - automation_actions í…Œì´ë¸”

### 7.2 ì£¼ìš” í•¨ìˆ˜ ìœ„ì¹˜

| ê¸°ëŠ¥ | íŒŒì¼ | í•¨ìˆ˜/ë¼ì¸ |
|------|------|-----------|
| Plan ê²€ì¦ | `execute-task-card/index.ts` | `validatePlan()` (82-125) |
| Intent í›„ë³´ ì¶”ì¶œ | `chatops/index.ts` | `extractIntentCandidates()` (68-200) |
| íŒŒë¼ë¯¸í„° ì •ê·œí™” | `chatops/index.ts` | `normalizeParams()` (458-578) |
| Policy ì¬í‰ê°€ | `execute-task-card/index.ts` | `getTenantSettingByPath()` (502-516) |
| ë©±ë“±ì„± ì²˜ë¦¬ | `execute-task-card/index.ts` | `request_id` ìƒì„±/ê²€ì¦ (444-469) |
| Draft ê´€ë¦¬ | `_shared/inline-execution.ts` | `getOrCreateDraft()` (37-109) |
| Handler ì‹¤í–‰ | `execute-task-card/index.ts` | Handler Registry í˜¸ì¶œ (533-580) |

---

## ë¶€ë¡: êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### P0 í•­ëª© êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **DB Contract Gate (CI í…ŒìŠ¤íŠ¸)**
  - [x] `scripts/test-db-contract.ts` ìƒì„±
  - [x] í•µì‹¬ í…Œì´ë¸” ì»¬ëŸ¼ ì¡´ì¬ ê²€ì‚¬ í•¨ìˆ˜ êµ¬í˜„
  - [x] Smoke insert/select í…ŒìŠ¤íŠ¸ êµ¬í˜„
  - [x] ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ ì²´í¬ êµ¬í˜„
  - [ ] CI íŒŒì´í”„ë¼ì¸ì— í†µí•© (ìˆ˜ë™ ì‘ì—… í•„ìš”)

- [x] **Preflight ì¬ì¡°íšŒ**
  - [x] `execute-task-card/index.ts`ì— Preflight ë¡œì§ ì¶”ê°€
  - [x] `chatops/index.ts`ì— Preflight ë¡œì§ ì¶”ê°€
  - [x] CONTRACT_STATE_CHANGED ì—ëŸ¬ ì²˜ë¦¬
  - [x] CONTRACT_TARGET_NOT_FOUND ì—ëŸ¬ ì²˜ë¦¬

- [x] **ìì—°ì–´ ìƒëŒ€ì‹œê°„ ì„œë²„ ì¸¡ ì¬í™•ì¸**
  - [x] `normalizeParams`ì— ìƒëŒ€ì‹œê°„ ë§µ ì¶”ê°€
  - [x] "ì˜¤ëŠ˜", "ì–´ì œ", "ë‚´ì¼" ì²˜ë¦¬
  - [x] KST ê¸°ì¤€ ë³€í™˜ ë¡œê·¸ ì¶”ê°€

- [x] **ì„¸ì…˜ í˜¼ì„  ë°©ì§€**
  - [x] `draft_confirm` ì‹œ `session_id` ê²€ì¦ ì¶”ê°€
  - [x] CONTRACT_SESSION_MISMATCH ì—ëŸ¬ ë°˜í™˜

- [x] **L0/L1/L2 ê²½ê³„ í˜¼ì„  ë°©ì§€**
  - [x] L0 ì‹¤í–‰ ì°¨ë‹¨ ëª…ì‹œì  ì¶”ê°€
  - [x] CONTRACT_LEVEL_MISMATCH ì—ëŸ¬ ë°˜í™˜

### P1 í•­ëª© êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ì—ëŸ¬ íƒœê¹…**
  - [x] `ContractErrorCategory` enum ì¶”ê°€
  - [x] Handlerì—ì„œ ê³„ì•½ ì¹´í…Œê³ ë¦¬ íƒœê¹… (ì˜ˆì‹œ ì½”ë“œ ì¶”ê°€)
  - [x] ì—ëŸ¬ ë°˜í™˜ ì‹œ contract_category ì¶”ê°€ (execute-task-card, chatops)
  - [ ] ëŒ€ì‹œë³´ë“œì—ì„œ ê³„ì•½ë³„ ì§‘ê³„ (ë³„ë„ ì‘ì—… í•„ìš”)

- [x] **ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸**
  - [x] `HandlerResult` íƒ€ì… í™•ì¥
  - [x] `success_list`, `failure_list` í•„ë“œ ì¶”ê°€
  - [x] Handlerì—ì„œ ë¦¬ìŠ¤íŠ¸ ìƒì„± ë¡œì§ ì¶”ê°€ (ì˜ˆì‹œ ì½”ë“œ ì¶”ê°€)

- [x] **Feature Flag ì²´í¬**
  - [x] `shouldUseFeature()` í•¨ìˆ˜ ì¶”ê°€
  - [x] ë©”ì‹œì§€ ë°œì†¡ feature flag ì²´í¬ (í•¸ë“¤ëŸ¬ êµ¬í˜„.mdì— ì‚¬ìš© ì˜ˆì‹œ ì¶”ê°€ë¨)
  - [x] ìë™í™” feature flag ì²´í¬ (í•¸ë“¤ëŸ¬ êµ¬í˜„.mdì— ì‚¬ìš© ì˜ˆì‹œ ì¶”ê°€ë¨)

- [x] **ì‹¤í–‰ ìŠ¤ëƒ…ìƒ· ì €ì¥**
  - [x] `execution_context`ì— resolve_snapshot ì¶”ê°€
  - [x] `execution_context`ì— apply_input ì¶”ê°€ (PII ë§ˆìŠ¤í‚¹ ì ìš©)
  - [x] `execution_context`ì— policy_verdict ì¶”ê°€
  - [x] `chatops_drafts` í…Œì´ë¸”ì— `resolve_snapshot` ì»¬ëŸ¼ ì¶”ê°€ (ë§ˆì´ê·¸ë ˆì´ì…˜ 137)
  - [x] `getOrCreateDraft`ì—ì„œ `resolve_snapshot` ì €ì¥
  - [x] `draft_confirm` ì‹œ `resolve_snapshot`ì„ `execution_context`ì— í¬í•¨

### P2 í•­ëª© êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] **Outbox íŒ¨í„´ (ì™¸ë¶€ ë°œì†¡)**
  - [x] `message_outbox` í…Œì´ë¸” ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ 136)
  - [x] `message-send-to-guardian.ts` Handlerì—ì„œ Outbox íŒ¨í„´ ì ìš©
  - [x] `idempotency_key` ê¸°ë°˜ ë©±ë“±ì„± ë³´ì¥
  - [ ] ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ë¡œ ë©±ë“± ë°œì†¡ (ë³„ë„ ì‘ì—… í•„ìš”)

- [x] **Worker ì•„í‚¤í…ì²˜ (ì™¸ë¶€ ë°œì†¡ ë° ëŒ€ëŸ‰ ì²˜ë¦¬)**
  - [x] `job_executions` í…Œì´ë¸” ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ 138)
  - [x] Apply ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì‹¤í–‰ ì½”ë“œ ì œê±° (job ìƒì„±ë§Œ ìˆ˜í–‰)
  - [x] Worker í”„ë¡œì„¸ìŠ¤ êµ¬í˜„ (ì‹¤í–‰, ì¬ì‹œë„, ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬)
  - [x] Preflight ì²´í¬ (Worker ì‹¤í–‰ ì „ ìƒíƒœ ì¬í™•ì¸)
  - [x] ì¬ì‹œë„ ì •ì±… êµ¬í˜„ (Fail-Closed ì›ì¹™)
  - [x] Worker ì¦‰ì‹œ ì‹¤í–‰ (job ìƒì„± í›„ ì¦‰ì‹œ í˜¸ì¶œ, ì§€ì—° ì—†ìŒ)
  - [x] Worker Cron ì‘ì—… ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ 139, ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
  - [ ] job ê²°ê³¼ â†’ ChatOps ë©”ì‹œì§€ ë°˜ì˜ (ë³„ë„ ì‘ì—… í•„ìš”)
  - [x] ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸ ì™„ì „ êµ¬í˜„

---

---

## ìš”ì•½: í•µì‹¬ ë°œê²¬ ì‚¬í•­

### âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„

1. **Auth/Policy Gate (100% ì™„ì„±)**
   - Policy ì¬í‰ê°€ ì™„ì „ êµ¬í˜„
   - Fail-Closed ì›ì¹™ ì¤€ìˆ˜
   - Zero-Trust ì›ì¹™ ì¤€ìˆ˜

2. **Idempotency Gate (100% ì™„ì„±)**
   - `request_id` ê¸°ë°˜ ë©±ë“±ì„± ì²˜ë¦¬
   - `dedup_key` ê¸°ë°˜ ì¤‘ë³µ ë°©ì§€
   - ìœ ë‹ˆí¬ ì œì•½ìœ¼ë¡œ ê°•ì œ

3. **PII ë§ˆìŠ¤í‚¹ (100% ì™„ì„±)**
   - `maskPII()` í•¨ìˆ˜ ì‚¬ìš©
   - ì²´í¬ë¦¬ìŠ¤íŠ¸ P0 í•­ëª©ìœ¼ë¡œ ê°•ì œ

### âš ï¸ ì¦‰ì‹œ ë³´ì™„ í•„ìš” (P0)

1. **DB Contract Gate (0% â†’ 100%)**
   - CI í…ŒìŠ¤íŠ¸ êµ¬ì¶• í•„ìˆ˜
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜ ì‚¬ì „ ì°¨ë‹¨

2. **Preflight ì¬ì¡°íšŒ (0% â†’ 100%)**
   - ìƒíƒœ ë³€í™” ê°ì§€ í•„ìˆ˜
   - ì˜¤ë˜ëœ Plan ì‹¤í–‰ ë°©ì§€

3. **ì„¸ì…˜ í˜¼ì„  ë°©ì§€ (70% â†’ 100%)**
   - `session_id` ê²€ì¦ ì¶”ê°€ í•„ìš”

4. **ìì—°ì–´ ìƒëŒ€ì‹œê°„ (50% â†’ 100%)**
   - ì„œë²„ ì¸¡ ì¬í™•ì¸ ë¡œì§ ì¶”ê°€

5. **L0/L1/L2 ê²½ê³„ ê²€ì¦ (90% â†’ 100%)**
   - L0ëŠ” ì´ë¯¸ ì—¬ëŸ¬ ë ˆì´ì–´ì—ì„œ ì°¨ë‹¨ë˜ì§€ë§Œ, ëª…ì‹œì  ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€ í•„ìš”
   - ë°©ì–´ ê¹Šì´ ê°•í™”ë¥¼ ìœ„í•œ ëª…í™•í•œ ì—ëŸ¬ ë°˜í™˜

### ğŸ“‹ ì¤‘ê¸° ë³´ì™„ (P1)

6. **ê³„ì•½ ì¹´í…Œê³ ë¦¬ë³„ ì—ëŸ¬ íƒœê¹… (0% â†’ 100%)**
   - ì›ì¸ ì¶”ì  ê°œì„ 
   - ê³„ì•½ ë ˆì´ì–´ ìˆ˜ì • ìš©ì´

7. **ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë¸ (60% â†’ 100%)**
   - ì„±ê³µ/ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ êµ¬ì¡° ì¶”ê°€

8. **ì‹¤í–‰ ìŠ¤ëƒ…ìƒ· ì €ì¥ (40% â†’ 100%)**
   - Resolve/Apply/Policy ìŠ¤ëƒ…ìƒ· ì €ì¥

---

---

## ê²€ì¦ ì™„ë£Œ ì‚¬í•­

### âœ… ì½”ë“œë² ì´ìŠ¤ ì¬ê²€ì¦ ì™„ë£Œ (ìµœì¢…)

1. **í•¨ìˆ˜ ìœ„ì¹˜ ì •í™•ì„± í™•ì¸**
   - `validatePlan()`: `execute-task-card/index.ts:82-125` âœ…
   - `extractIntentCandidates()`: `chatops/index.ts:68-200` âœ…
   - `normalizeParams()`: `chatops/index.ts:458-577` âœ…

2. **L0/L1/L2 ê²½ê³„ ê²€ì¦ í™•ì¸**
   - L0 TaskCard ìƒì„± ì°¨ë‹¨: `packages/chatops-intents/src/taskcard.ts:134` âœ…
   - L0 Plan ê²€ì¦ ì°¨ë‹¨: `execute-task-card/index.ts:96` âœ…
   - L0 Inline Execution ì°¨ë‹¨: `chatops/index.ts:1024-1037` âœ…
   - L1 ì‹¤í–‰ ì°¨ë‹¨: `execute-task-card/index.ts:415` âœ…

3. **Preflight ì¬ì¡°íšŒ í™•ì¸**
   - Handler ë‚´ë¶€ì—ì„œ `TARGET_NOT_FOUND` ì—ëŸ¬ ë°˜í™˜ì€ ìˆìœ¼ë‚˜, ì‹¤í–‰ ì „ ìƒíƒœ ì¬í™•ì¸ ì—†ìŒ âœ…
   - `plan.plan_snapshot.targets.student_ids`ëŠ” ì‹¤ì œë¡œ ì‚¬ìš©ë¨ (`execute-task-card/index.ts:103`) âœ…
   - ë¬¸ì„œì˜ ë³´ì™„ í•„ìš” ì‚¬í•­ ì •í™•í•¨ âœ…

4. **HandlerResult íƒ€ì… í™•ì¸**
   - `execute-student-task/handlers/types.ts:61-67`ì—ì„œ `success_list`, `failure_list` ì—†ìŒ âœ…
   - `status: 'partial'` ë°˜í™˜ì€ ê°€ëŠ¥í•˜ë‚˜, ì„±ê³µ/ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ êµ¬ì¡° ì—†ìŒ âœ…
   - ë¬¸ì„œì˜ ë³´ì™„ í•„ìš” ì‚¬í•­ ì •í™•í•¨ âœ…

5. **execution_context í™•ì¸**
   - `execute-task-card/index.ts:618-622`: `execution_context` í•„ë“œ ìˆìŒ âœ…
   - `chatops/index.ts:1194-1200`: `execution_context` í•„ë“œ ì—†ìŒ (resultë§Œ ì €ì¥) âœ…
   - ë¬¸ì„œ ìˆ˜ì • ì™„ë£Œ: chatopsì˜ execution_context ëˆ„ë½ ë°˜ì˜ âœ…

6. **ì„¸ì…˜ ê²€ì¦ í™•ì¸**
   - `chatops/index.ts:983-990`: `tenant_id`/`user_id` ê²€ì¦ì€ ìˆìœ¼ë‚˜ `session_id` ê²€ì¦ ì—†ìŒ âœ…
   - ë¬¸ì„œì˜ ë³´ì™„ í•„ìš” ì‚¬í•­ ì •í™•í•¨ âœ…

---

**ë¬¸ì„œ ë²„ì „**: 1.7.0
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-01-28
**ìµœì¢… ê²€ì¦ ì™„ë£Œ**: 2025-01-28 (5ì°¨ ê²€ì¦ - ì „ì²´ ê¸°ëŠ¥ êµ¬í˜„ ê²€ì¦ ì™„ë£Œ)
**Worker ì•„í‚¤í…ì²˜ í†µí•©**: 2025-01-28
**êµ¬í˜„ ì™„ë£Œ**: 2025-01-28
**ê²€ì¦ ë‚´ìš©**:
- âœ… í•¨ìˆ˜ ìœ„ì¹˜ ë° ë¼ì¸ ë²ˆí˜¸ ì •í™•ì„± í™•ì¸
  - `validatePlan()`: `execute-task-card/index.ts:82-125` âœ…
  - `extractIntentCandidates()`: `chatops/index.ts:68-200` âœ…
  - `normalizeParams()`: `chatops/index.ts:458-577` âœ…
  - `getTenantSettingByPath()`: `_shared/policy-utils.ts:40-104` âœ…
- âœ… êµ¬í˜„ ìƒíƒœ ì •í™•ì„± í™•ì¸ (ì™„ì „/ë¶€ë¶„/ë¯¸êµ¬í˜„)
  - Auth/Policy Gate: ì™„ì „ êµ¬í˜„ âœ…
  - Idempotency Gate: ì™„ì „ êµ¬í˜„ âœ…
  - Schema Gate: ë¶€ë¶„ êµ¬í˜„ âœ…
  - Resolver Gate: ë¶€ë¶„ êµ¬í˜„ âœ…
  - DB Contract Gate: ì™„ì „ êµ¬í˜„ âœ… (`scripts/test-db-contract.ts`)
  - Preflight ì¬ì¡°íšŒ: ì™„ì „ êµ¬í˜„ âœ… (`execute-task-card/index.ts:540-591`, `chatops/index.ts:1249-1307` ì£¼ì„ ì²˜ë¦¬ë¨ - Handler ë‚´ë¶€ì—ì„œ ìˆ˜í–‰)
  - ì„¸ì…˜ í˜¼ì„  ë°©ì§€: ì™„ì „ êµ¬í˜„ âœ… (`chatops/index.ts:1026-1036`)
  - ê³„ì•½ ì—ëŸ¬ íƒœê¹…: ì™„ì „ êµ¬í˜„ âœ… (`types.ts:119-130`, `contract_category` í•„ë“œ ì¶”ê°€)
  - ë¶€ë¶„ ì„±ê³µ ëª¨ë¸: ì™„ì „ êµ¬í˜„ âœ… (`types.ts:69-76`, `success_list`, `failure_list` ì¶”ê°€)
  - ì‹¤í–‰ ìŠ¤ëƒ…ìƒ·: ì™„ì „ êµ¬í˜„ âœ… (`execute-task-card/index.ts:694-719`, `chatops/index.ts:1370-1389`, `resolve_snapshot` ì €ì¥ ì™„ë£Œ)
  - Outbox íŒ¨í„´: ì™„ì „ êµ¬í˜„ âœ… (`message-send-to-guardian.ts:142-245`, `message_outbox` í…Œì´ë¸” ì‚¬ìš©)
  - Worker ì•„í‚¤í…ì²˜: ì™„ì „ êµ¬í˜„ âœ… (job_executions í…Œì´ë¸”, Worker í”„ë¡œì„¸ìŠ¤, Apply ë‹¨ê³„ job ìƒì„± ëª¨ë‘ ì™„ë£Œ)
- âœ… execution_context í•„ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  - `execute-task-card`: execution_context í•„ë“œ ìˆìŒ âœ… (resolve_snapshot, apply_input, policy_verdict í¬í•¨)
  - `chatops`: execution_context í•„ë“œ ìˆìŒ âœ… (resolve_snapshot, apply_input, policy_verdict í¬í•¨)
- âœ… ì½”ë“œë² ì´ìŠ¤ì™€ ë¬¸ì„œ ë‚´ìš© ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
  - `dedup_key` ìƒì„± ë¡œì§: `chatops/index.ts:1067-1078` âœ…
  - `request_id` ë©±ë“±ì„±: `execute-task-card/index.ts:444-469` âœ…
  - Domain Action Catalog ê²€ì¦: `execute-task-card/index.ts:428-441` âœ…
  - Policy ì¬í‰ê°€: `execute-task-card/index.ts:500-516` âœ…
  - `resolve_snapshot` ì €ì¥: `inline-execution.ts:37-118`, `chatops/index.ts:1375` âœ…
  - Outbox íŒ¨í„´: `message-send-to-guardian.ts:142-245` âœ…
  - Worker ì•„í‚¤í…ì²˜: ì„¹ì…˜ 4ì— ìƒì„¸ ë¬¸ì„œí™” ì™„ë£Œ âœ…
- âœ… ì˜ˆì‹œ ì½”ë“œ ì •í™•ì„± í™•ì¸
  - ëª¨ë“  ì˜ˆì‹œ ì½”ë“œê°€ ì‹¤ì œ êµ¬í˜„ê³¼ ì¼ì¹˜ âœ…
- âœ… P0/P1/P2 ëª¨ë“  í•­ëª© êµ¬í˜„ ì™„ë£Œ í™•ì¸
  - P0 í•­ëª©: ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ âœ…
  - P1 í•­ëª©: ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ âœ…
  - P2 í•­ëª©: Outbox íŒ¨í„´ êµ¬í˜„ ì™„ë£Œ âœ…
  - Worker ì•„í‚¤í…ì²˜: êµ¬í˜„ ì™„ë£Œ âœ…
  - Worker ì•„í‚¤í…ì²˜: ë¬¸ì„œ í†µí•© ì™„ë£Œ (ì„¹ì…˜ 4) âœ…
  - Worker ì•„í‚¤í…ì²˜: êµ¬í˜„ ì™„ë£Œ âœ…
    - `job_executions` í…Œì´ë¸” ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ 138) âœ…
    - `worker-process-job` Edge Function êµ¬í˜„ âœ…
    - `job-utils.ts` ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ êµ¬í˜„ âœ…
    - `execute-task-card/index.ts` Worker í†µí•© âœ…
    - `chatops/index.ts` Worker í†µí•© âœ…
    - Preflight ì²´í¬, ì¬ì‹œë„ ì •ì±…, ë¶€ë¶„ ì„±ê³µ ì²˜ë¦¬ ëª¨ë‘ êµ¬í˜„ âœ…
**ìœ ì§€ë³´ìˆ˜ ì±…ì„**: ê°œë°œ íŒ€

