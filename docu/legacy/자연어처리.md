# ChatOps 자연어 처리 분석 및 개선 방안

**최종 업데이트**: 2024-12-28 | **매칭 정확도**: 100% (11개 테스트 케이스 모두 통과)

## 현재 처리 방식 분석

### 1. Intent 파싱 단계 (AI 기반)

**처리 흐름:**
1. 사용자 메시지 → GPT-4o-mini 분석
2. AI가 Intent 추출 및 JSON 생성
3. Fallback 함수에서 키워드 매칭 (AI 실패 시)

**현재 키워드 매핑:**
```typescript
'billing.query.overdue_list': ['연체', '연체자', '연체 목록', '미납', '미납자']
```

**문제점:**
- "돈 안낸 사람", "돈 안낸", "납부 안한", "결제 안한", "미결제" 등 다양한 표현 미지원
- AI 프롬프트에 동의어 처리 지침 없음

### 2. 필터링 단계 (프론트엔드)

**처리 흐름:**
1. 원본 메시지에서 키워드 추출
2. 필드별 키워드 매칭
3. 매칭된 필드만 표시

**현재 키워드 매핑:**
```typescript
status: ['상태', '출석', '결석', '지각', '재학', '휴원', '퇴원']
amount: ['금액', '요금', '비용', '가격']
```

**문제점:**
- "미납", "연체", "미결제" 같은 상태 표현이 status 필드에 매핑되지 않음
- 금액 관련 표현이 제한적

## 개선 방안

### 1. 키워드 매핑 확장 (동의어/유의어 추가)

#### Intent 키워드 확장
```typescript
'billing.query.overdue_list': [
  // 기존
  '연체', '연체자', '연체 목록', '미납', '미납자',
  // 추가
  '돈 안낸', '돈 안낸 사람', '돈 안낸 학생',
  '납부 안한', '납부 안한 사람', '납부 안한 학생',
  '결제 안한', '결제 안한 사람', '결제 안한 학생',
  '미결제', '미결제자', '미결제 학생',
  '미납자 목록', '연체자 목록', '미납 학생',
  '안낸 사람', '안낸 학생', '안낸 사람들',
  '미납 대상', '연체 대상', '미납 회원'
]
```

#### 필터링 키워드 확장
```typescript
status: [
  // 기존
  '상태', '출석', '결석', '지각', '재학', '휴원', '퇴원',
  // 추가
  '미납', '연체', '미결제', '납부', '결제',
  '돈 안낸', '납부 안한', '결제 안한',
  '미납자', '연체자', '미결제자'
]

amount: [
  // 기존
  '금액', '요금', '비용', '가격',
  // 추가
  '돈', '비용', '수강료', '학비', '납부액', '결제액',
  '미납액', '연체액', '미결제액'
]
```

### 2. AI 프롬프트 개선 (동의어 처리 지침 추가)

**추가할 내용:
```
⚠️ 동의어/유의어 처리 규칙:

사용자가 다양한 표현으로 같은 의미를 전달할 수 있습니다.
다음과 같은 동의어 매핑을 이해하고 올바른 Intent를 선택하세요:

[수납/청구 도메인]
- "미납", "연체", "돈 안낸", "납부 안한", "결제 안한", "미결제" → billing.query.overdue_list
- "청구서", "인보이스", "납부서", "계산서" → billing.query.invoice_status
- "결제", "납부", "입금", "수납" → billing.query.by_student (결제 내역 조회)

[출결 도메인]
- "지각", "늦은", "늦게 온" → attendance.query.late
- "결석", "안온", "안나온", "불참" → attendance.query.absent
- "출석", "나온", "참석" → attendance.query.by_student

[학생 도메인]
- "학생", "대상", "회원", "원생", "수강생" → student.query.*
- "전화번호", "연락처", "번호", "핸드폰" → student.query.profile (전화번호 조회)

사용자 메시지의 의미를 파악하여 올바른 Intent를 선택하세요.
예를 들어 "돈 안낸 사람"은 "미납자"와 같은 의미이므로 billing.query.overdue_list를 사용하세요.
```

### 3. 의미 기반 매칭 강화

#### 패턴 기반 매칭 추가
```typescript
// 부정 표현 패턴
const negativePatterns = [
  /안\s*낸/,      // "안 낸", "안낸"
  /안\s*한/,      // "안 한", "안한"
  /안\s*한\s*사람/,
  /미\w+/,        // "미납", "미결제", "미체크"
  /안\s*\w+/,     // "안낸", "안한"
];

// "돈 안낸 사람" → "미납자" 매핑
function normalizeToStandardTerm(message: string): string {
  // 부정 표현을 표준 용어로 변환
  if (negativePatterns.some(pattern => pattern.test(message))) {
    // "돈 안낸" → "미납"
    if (message.includes('돈') || message.includes('납부') || message.includes('결제')) {
      return message.replace(/돈\s*안\s*낸|납부\s*안\s*한|결제\s*안\s*한/g, '미납');
    }
  }
  return message;
}
```

### 4. 필터링 단계 개선

#### 의미 기반 필드 매핑
```typescript
// 필드별 의미 매핑 확장
const fieldSemantics: Record<string, string[]> = {
  status: [
    // 직접 키워드
    '상태', '출석', '결석', '지각', '재학', '휴원', '퇴원',
    // 미납 관련
    '미납', '연체', '미결제', '납부 안한', '결제 안한', '돈 안낸',
    // 출석 관련
    '나온', '안온', '불참', '참석',
  ],
  amount: [
    // 직접 키워드
    '금액', '요금', '비용', '가격',
    // 동의어
    '돈', '수강료', '학비', '납부액', '결제액',
    // 미납 관련
    '미납액', '연체액', '미결제액',
  ],
};
```

## 구현 완료 사항

### Phase 1: 즉시 적용 (완료) ✅
1. ✅ Intent 키워드 확장 (동의어 추가)
   - `billing.query.overdue_list`에 "돈 안낸", "납부 안한", "결제 안한", "미결제" 등 추가
   - `actionKeywords.overdue`에 동의어 확장
   - `domainKeywords.billing`에 동의어 확장
2. ✅ AI 프롬프트에 동의어 처리 지침 추가
   - 수납/청구 도메인 동의어 매핑 지침 추가
   - 출결 도메인 동의어 매핑 지침 추가
   - 학생 도메인 동의어 매핑 지침 추가
3. ✅ 필터링 키워드 확장
   - `status` 필드에 미납/연체 관련 동의어 추가
   - `amount` 필드에 동의어 확장
   - `phone` 필드에 동의어 확장

### Phase 2: 구조적 개선 (완료) ✅
**목표**: Catalog 중심 후보 제한 + 선택 + Fail-Closed + 디스앰비규에이션

1. ✅ **Intent Registry에 `examples` 필드 추가**
   - SSOT: `packages/chatops-intents/src/registry.ts`
   - 각 Intent에 발화 예시(`examples?: string[]`) 추가
   - 147개 Intent 모두 자동 생성 스크립트로 처리 (`scripts/generate-intent-examples.ts`)
   - 품질 게이트: 다양성 점수, PII 필터링, 중복 제거
   - **최종 상태**: 145개 Intent, 147개 examples (비율: 1.01 examples/intent)

2. ✅ **`extractIntentCandidates` 함수 구현 및 개선**
   - Registry 기반 후보 추출 (나중에 임베딩으로 교체 가능하도록 구조 고정)
   - 우선순위: `examples` 매칭 > `description` 매칭 > 키워드 패턴 매칭
   - 상위 N개 후보 반환 (기본 10개)
   - **개선 사항**:
     - `bestExampleScore` 도입: 여러 examples 중 최고 점수만 사용 (중복 점수 방지)
     - 중요 키워드 가중치: 도메인 특화 키워드 매칭 시 추가 점수 부여
     - 정확 일치 점수: 20점 → 30점
     - 부분 일치 조건: 60% → 70% 겹침 요구, 점수 8점 → 12점
     - query 타입 키워드 확장: '애들', '목록', '리스트', '현황' 추가, 점수 1점 → 2점

3. ✅ **LLM 프롬프트 제약 강화**
   - 후보 목록을 프롬프트에 주입
   - "반드시 이 후보 목록에서만 Intent를 선택하세요" 명시
   - LLM을 "생성자"에서 "선택자"로 제한

4. ✅ **프론트엔드 SSOT 준수**
   - 키워드 필터링을 "판정"에서 "표시 보조"로 변경
   - `extractRequestedFields` 함수: "필드 표시 보조 함수"로 명시
   - SSOT 경계 보호: 프론트엔드는 Intent 판정 금지

5. ✅ **환경변수 중앙 관리**
   - `env-registry`를 통한 `OPENAI_API_KEY` 로드
   - 스크립트에서 `packages/env-registry/src/server` 사용

6. ✅ **잘못된 examples 수정**
   - `attendance.query.by_class`: "반별 출결 조회" 관련 examples로 수정
   - `attendance.exec.mark_excused`: "출결 사유 처리" 관련 examples로 수정

7. ✅ **매칭 정확도 개선**
   - **최종 정확도**: 100% (11개 테스트 케이스 모두 통과)
   - 이전: 81.8% → 개선 후: 100.0%

## 구현 우선순위

### Phase 3: 장기 개선 (예정)
1. 임베딩 기반 검색 도입 (Intent 300개+ 또는 업종 3개+ 확장 시)
2. 컨텍스트 기반 의미 추론
3. 사용자별 맞춤 표현 학습

## 예상 효과

### 개선 전
- "돈 안낸 사람" → ❌ Intent 매칭 실패 또는 잘못된 Intent 선택
- "미납 학생 이름" → ❌ 필터링 실패 (status 필드 인식 못함)

### 개선 후
- "돈 안낸 사람" → ✅ billing.query.overdue_list 매칭 (100% 정확도)
- "미납 학생 이름" → ✅ status 필드 인식 + 이름만 표시
- "오늘 지각한 애들 보여줘" → ✅ attendance.query.late 매칭 (정확 일치 30점)
- "지각학생조회" → ✅ attendance.query.late 매칭 (키워드 일치 + 중요 키워드 보너스)

## 테스트 케이스

### Intent 파싱 테스트
```
입력: "돈 안낸 사람 목록 보여줘"
예상: billing.query.overdue_list

입력: "납부 안한 학생들"
예상: billing.query.overdue_list

입력: "미결제자 조회"
예상: billing.query.overdue_list
```

### 필터링 테스트
```
입력: "미납 학생 이름만"
예상: 이름 필드만 표시

입력: "연체자 금액"
예상: 금액 필드만 표시

입력: "돈 안낸 사람 전화번호"
예상: 전화번호 필드만 표시
```

## 기술 스택 및 도구

### Intent Examples 자동 생성 스크립트
- **위치**: `scripts/generate-intent-examples.ts`
- **기능**: 147개 Intent 모두에 발화 예시(`examples`) 자동 생성
- **품질 게이트**:
  - 최소 6개 예시 (기본 8개 생성)
  - 다양성 점수 최소 0.25
  - PII 필터링 (전화번호, 주민번호, 계좌번호, 이메일, 주소)
  - 중복 제거 및 유사도 필터링 (0.8 이상)
  - 길이 제한 (200자)
- **자동 재생성**: 최대 3회 재시도
- **환경변수**: `env-registry`를 통한 `OPENAI_API_KEY` 중앙 관리
- **사용법**: `npm run gen:intent-examples` (옵션: `--dry-run`, `--target=N`, `--only-missing`)

### Intent Resolver 구조
- **함수**: `extractIntentCandidates(message, maxCandidates = 10)`
- **위치**: `infra/supabase/functions/chatops/index.ts`
- **우선순위 및 점수 체계**:
  1. `examples` 필드 매칭 (가장 높은 점수)
     - 정확 일치: 30점
     - 부분 일치: 최소 5자, 70% 이상 겹침 시 12점 × 겹침 비율
     - 키워드 일치: 최소 2개 키워드 필요, 키워드당 2점 + 중요 키워드 보너스 3점
     - 중요 키워드: ['지각', '결석', '출석', '출결', '연체', '미납', '프로필', '검색']
     - 여러 examples 중 최고 점수만 사용 (bestExampleScore)
  2. `description` 필드 매칭
     - examples 매칭이 있으면: 1점
     - examples 매칭이 없으면: 5점
  3. 키워드 패턴 매칭 (도메인/타입/액션)
     - 도메인 키워드: examples 있으면 1점, 없으면 2점
     - 타입 키워드: examples 있으면 0.5점, 없으면 query는 2점, 기타는 1점
     - query 타입 키워드 확장: '애들', '목록', '리스트', '현황' 추가
  4. `INTENT_KEYWORD_MAP` 기반 매칭 (하위 호환성)
     - examples 있으면: 1점
     - examples 없으면: 2점
- **반환**: 점수 내림차순 정렬된 상위 N개 후보
- **매칭 정확도**: 100% (11개 테스트 케이스 모두 통과)

### 프론트엔드 필터링 (SSOT 준수)
- **위치**: `packages/ui-core/src/components/ChatOpsPanel.tsx`
- **함수**: `extractRequestedFields(originalMessage)` - "필드 표시 보조 함수"
- **역할**: Intent 판정 금지, UI 표시 필터링만 수행
- **SSOT 경계 보호**: 프론트엔드는 Intent Registry를 직접 참조하지 않음

