# ğŸ“˜ DearSSam Multi-Tenant Academy SaaS â€” Technical Architecture v3.3

(Zero-Management Â· SDUI Â· AI-Driven Â· Multi-Tenant Â· Regional Analytics)

## âš ï¸ Automation Config First (ë¶ˆë³€ ì›ì¹™)

**ë³¸ ì‹œìŠ¤í…œì—ì„œ ì–´ë– í•œ ìë™í™”ë„ í•˜ë“œì½”ë”©ëœ ì¡°ê±´ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.**
**ëª¨ë“  ìë™í™”ëŠ” ì‚¬ìš©ì ì„¤ì •ê°’(Policy / Threshold / Toggle)ì„ í†µí•´ í™œì„±Â·ë¹„í™œì„± ë° ê°•ë„ê°€ ê²°ì •ë˜ë©°,**
**ì‹¤í–‰ ì—¬ë¶€ëŠ” ì„œë²„/Edge Functionì´ í•´ë‹¹ ì„¤ì •ì„ í•´ì„í•˜ì—¬ íŒë‹¨í•œë‹¤.**

âš ï¸ í‘œí˜„Â·ë‹¨ì–´Â·ìˆœì„œ ë³€ê²½ ê¸ˆì§€

### ê¸°ë³¸ê°’(Default)ì˜ ì •ë³¸ ì •ì˜

**ê¸°ë³¸ê°’(Default)ì´ë€ ì½”ë“œ ìƒìˆ˜ê°€ ì•„ë‹ˆë¼ Default Policyì´ë‹¤.**
**ëª¨ë“  ìë™í™” ê¸°ëŠ¥ì€ ê¸°ë³¸ ì •ì±…(Default Policy)ì„ ê°€ì§€ë©°,**
**ì´ ê¸°ë³¸ ì •ì±…ì€ í…Œë„ŒíŠ¸ ìƒì„± ì‹œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥ëœë‹¤.**
**ì½”ë“œì— í•˜ë“œì½”ë”©ëœ ê¸°ë³¸ ì„ê³„ê°’ì´ë‚˜ ì¡°ê±´ì€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.**

**ê¸ˆì§€ íŒ¨í„´:**
- âŒ "ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©"
- âŒ "undefinedë©´ 3ìœ¼ë¡œ ì²˜ë¦¬"
- âŒ ì½”ë“œ ë‚´ë¶€ ìƒìˆ˜ ê¸°ë°˜ ì¡°ê±´

**ì •ë³¸ íŒ¨í„´:**
- âœ… ì„¤ì •ì´ ì¡´ì¬ â†’ ì‚¬ìš©
- âœ… ì„¤ì •ì´ ì—†ìŒ â†’ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (Fail Closed)

### ìë™í™”ì˜ ì •ë³¸ êµ¬ì¡°

ìë™í™”ëŠ” ë°˜ë“œì‹œ ì•„ë˜ 3ìš”ì†Œ ì¡°í•©ìœ¼ë¡œë§Œ ì„¤ëª…í•œë‹¤:

1. **Trigger**: ìƒí™© ì‹ í˜¸ ë˜ëŠ” ì´ë²¤íŠ¸
2. **Policy**: ì‚¬ìš©ì ì„¤ì •ê°’ (ON/OFF, ì„ê³„ê°’, ìŠ¹ì¸ ë ˆë²¨)
3. **Executor**: Server / Edge Function (ì •ì±… í•´ì„ + ì‹¤í–‰)

âŒ í”„ë¡ íŠ¸ì—”ë“œëŠ” íŒë‹¨Â·ì‹¤í–‰ ì£¼ì²´ê°€ ì•„ë‹ˆë‹¤.

### ìë™í™” í•­ëª©ë³„ Policy ì„¤ì • í‘œ (ê³µí†µ)

**âš ï¸ ëª¨ë“  ë¬¸ì„œì— ë™ì¼í•˜ê²Œ ì‚½ì… (í˜•íƒœÂ·ë‚´ìš© ë³€ê²½ ê¸ˆì§€)**

| ìë™í™” í•­ëª© | ì‚¬ìš©ì ì„¤ì • ê°€ëŠ¥ | í•˜ë“œì½”ë”© ê¸ˆì§€ |
|------------|----------------|--------------|
| ì¶œê²° ì´ìƒ ê°ì§€ | ê°ì§€ ê¸°ì¤€, ì¹´ë“œ ìƒì„± ì—¬ë¶€ | ê¸°ì¤€ê°’ |
| ë¯¸ë‚© ì•Œë¦¼ | ìë™ ë°œì†¡ ON/OFF, ì‹œì  | ë°œì†¡ ì¡°ê±´ |
| AI ì—…ë¬´ ì¹´ë“œ(TaskCard, task_type: 'ai_suggested', entity_type='student') | AI ON/OFF, ìŠ¹ì¸ í•„ìš” ì—¬ë¶€ | ì„œë²„ê°€ ì •ì±…ì— ë”°ë¼ ì‹¤í–‰ | (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
| ëŒ€ì‹œë³´ë“œ ìš°ì„ ìˆœìœ„ | ê°€ì¤‘ì¹˜ ì¡°ì • | ê·¸ë£¹ ìˆœì„œ |
| ë¦¬í¬íŠ¸ ìƒì„± | ìë™ ìƒì„± ì—¬ë¶€ | ìƒì„± ì£¼ê¸° |

â€» ìƒìœ„ Policy KeyëŠ” SSOT(v2 6ê°œ)ë¡œ ê³ ì •ëœë‹¤. ì‹ ê·œ ìë™í™”ëŠ” event_type ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ í›„ ê°€ëŠ¥í•˜ë©°, ì¹´íƒˆë¡œê·¸ì— ì—†ëŠ” event_typeì€ ì‹¤í–‰/ì¶”ê°€í•  ìˆ˜ ì—†ë‹¤. (ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ = ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`ì— event_type ì¶”ê°€, êµ¬í˜„ ìœ„ì¹˜: `packages/core/core-automation/src/automation-event-catalog.ts`, `infra/supabase/functions/_shared/automation-event-catalog.ts`)

---

## âš ï¸ Automation & AI Industry-Neutral Rule (SSOT)

ë³¸ í”Œë«í¼ì˜ ìë™í™” ì„¤ì • ë° AI ê¸°ëŠ¥ì€ **ì—…ì¢…(Academy/Salon/Nail ë“±)ì— ì¢…ì†ë˜ì§€ ì•ŠëŠ”ë‹¤.**

### ë¶ˆë³€ ì›ì¹™
- ìë™í™”/AIì˜ ì‹¤í–‰ êµ¬ì¡°ëŠ” **Core Platform ê³µí†µ ë¡œì§**ì´ë‹¤.
- ì—…ì¢…ë³„ ì°¨ì´ëŠ” ë¡œì§ì´ ì•„ë‹ˆë¼ **Adapter + Schema ë ˆì´ì–´**ì—ì„œë§Œ í—ˆìš©ëœë‹¤.
- ì—…ì¢…ë³„ ì‹ ê·œ ìë™í™” ì—”ì§„ ë˜ëŠ” AI ì—”ì§„ì„ ìƒì„±í•˜ëŠ” í–‰ìœ„ëŠ” ê¸ˆì§€ëœë‹¤.

### í—ˆìš© êµ¬ì¡°
```
Core Automation / AI Engine
 â””â”€ Industry Adapter (academy | salon | nail | ...)
```

### ê¸ˆì§€ êµ¬ì¡°
- ì—…ì¢…ë³„ Automation Engine âŒ
- ì—…ì¢…ë³„ AI Engine âŒ
- ì—…ì¢…ë³„ í•˜ë“œì½”ë”© ì¡°ê±´ âŒ

ë³¸ ê·œì¹™ì€ ëª¨ë“  ë¬¸ì„œì™€ êµ¬í˜„ì˜ ì •ë³¸(SSOT)ì´ë‹¤.

### AI Engine Architecture (SSOT)

AI ê¸°ëŠ¥ì€ ë‹¤ìŒ 2ê³„ì¸µìœ¼ë¡œ êµ¬ì„±ëœë‹¤.

1. **Core AI Engine**
- ìš”ì•½, íŒ¨í„´ ê°ì§€, ë¦¬í¬íŠ¸ ìƒì„±, ì´ìƒ íƒì§€
- ì—…ì¢… ë¹„ì˜ì¡´
- ëª¨ë¸ í˜¸ì¶œ / í”„ë¡¬í”„íŠ¸ / ê²°ê³¼ í¬ë§· ê³µí†µ

2. **Industry Adapter**
- ì—…ì¢…ë³„ ë°ì´í„° ë§¤í•‘
- ìš©ì–´ ì¹˜í™˜
- ê°€ì¤‘ì¹˜ ì„¤ì •
- UI Label ë³€í™˜

âš ï¸ AI íŒë‹¨ ë° ì‹¤í–‰ ë¡œì§ì€ Core Engineì—ë§Œ ì¡´ì¬í•œë‹¤.

### Edge Functions Industry Adapter êµ¬í˜„ (SSOT)

Edge Functionsì—ì„œ ì—…ì¢…ë³„ í…Œì´ë¸”ëª… ë° FK ê´€ê³„ëª…ì„ ë™ì ìœ¼ë¡œ ë§¤í•‘í•˜ê¸° ìœ„í•œ Industry Adapterê°€ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/functions/_shared/industry-adapter.ts`

**ì£¼ìš” ê¸°ëŠ¥:**
1. **í…Œì´ë¸”ëª… ë™ì  ë§¤í•‘**
   - `getTenantTableName(supabase, tenantId, entityType)`: í…Œë„ŒíŠ¸ì˜ industry_typeì— ë”°ë¼ ì—”í‹°í‹° íƒ€ì…('student', 'class' ë“±)ì„ ì—…ì¢…ë³„ í…Œì´ë¸”ëª…ìœ¼ë¡œ ë³€í™˜
   - ì˜ˆ: `academy` â†’ `academy_students`, `salon` â†’ `salon_customers`

2. **FK ê´€ê³„ëª… ë™ì  ë§¤í•‘**
   - `getFKRelationName(fkKey, industryType)`: ì—…ì¢…ë³„ FK ê´€ê³„ëª…ì„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ì¡°íšŒ
   - ì§€ì› FK í‚¤: `attendance_logs_class_id`, `student_classes_class_id`, `student_classes_student_id`, `class_sessions_class_id`, `invoices_student_id`, `student_person_id`, `class_teacher_id`

3. **ì—…ì¢… íƒ€ì… ì¡°íšŒ**
   - `getTenantIndustryType(supabase, tenantId)`: í…Œë„ŒíŠ¸ì˜ industry_type ì¡°íšŒ

**ì‚¬ìš© ê·œì¹™:**
- âŒ í•˜ë“œì½”ë”©ëœ í…Œì´ë¸”ëª… ì‚¬ìš© ê¸ˆì§€ (ì˜ˆ: `'academy_students'`, `'academy_classes'`)
- âœ… Industry Adapter í•¨ìˆ˜ ì‚¬ìš© í•„ìˆ˜
- âœ… Fail-Closed ì›ì¹™: ë§¤í•‘ ì‹¤íŒ¨ ì‹œ null ë°˜í™˜, fallback íŒ¨í„´ ì‚¬ìš©

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
import { getTenantTableName, getTenantIndustryType, getFKRelationName } from '../_shared/industry-adapter.ts';

// í…Œì´ë¸”ëª… ë™ì  ì¡°íšŒ
const studentTableName = await getTenantTableName(supabase, tenant_id, 'student');
const classTableName = await getTenantTableName(supabase, tenant_id, 'class');

// FK ê´€ê³„ëª… ë™ì  ì¡°íšŒ
const industryType = await getTenantIndustryType(supabase, tenant_id);
const classFKName = getFKRelationName('attendance_logs_class_id', industryType) ||
  'academy_classes!attendance_logs_class_id_fkey'; // Fallback

// ì¿¼ë¦¬ ì‹¤í–‰
const { data } = await withTenant(
  supabase
    .from(studentTableName || 'academy_students') // Fallback
    .select(`*`),
  tenant_id
);
```

**ì ìš© ë²”ìœ„:**
- ëª¨ë“  Edge Functionsì—ì„œ ì—…ì¢…ë³„ í…Œì´ë¸”ëª… ì‚¬ìš© ì‹œ í•„ìˆ˜
- L0 í•¸ë“¤ëŸ¬ (`l0-handlers.ts`): ëª¨ë“  í•¸ë“¤ëŸ¬ì—ì„œ ì ìš© ì™„ë£Œ
- Task ì‹¤í–‰ í•¸ë“¤ëŸ¬ (`execute-student-task/handlers/*`): ëª¨ë“  í•¸ë“¤ëŸ¬ì—ì„œ ì ìš© ì™„ë£Œ
- ìë™í™” Edge Functions: ëª¨ë“  ìë™í™” í•¨ìˆ˜ì—ì„œ ì ìš© ì™„ë£Œ

### UI Component Industry-Neutral Rule

AI ê´€ë ¨ UI ì»´í¬ë„ŒíŠ¸(ChatOpsPanel, ExecutionAuditPanel, AILayerMenu)ë„ ì—…ì¢…ì— ì¢…ì†ë˜ì§€ ì•Šìœ¼ë©°, ëª¨ë“  ì—…ì¢…ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ë¶ˆë³€ ì›ì¹™:**
- AI UI ì»´í¬ë„ŒíŠ¸ëŠ” `packages/ui-core/src/components/`ì— ìœ„ì¹˜í•˜ë©°, ì—…ì¢… ë…ë¦½ì ìœ¼ë¡œ ì„¤ê³„ë©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ ì°¨ì´ëŠ” propì„ í†µí•œ í™•ì¥ í¬ì¸íŠ¸(`onViewTaskCard`, `onChatOpsViewTaskCard` ë“±)ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ í•˜ë“œì½”ë”©ëœ ë¼ìš°íŒ… ê²½ë¡œë‚˜ CSS í´ë˜ìŠ¤ëŠ” ê¸ˆì§€ë©ë‹ˆë‹¤.

**êµ¬í˜„ ìœ„ì¹˜:**
- `ChatOpsPanel`: `packages/ui-core/src/components/ChatOpsPanel.tsx`
- `ExecutionAuditPanel`: `packages/ui-core/src/components/ExecutionAuditPanel.tsx`
- `AILayerMenu`: `packages/ui-core/src/components/AILayerMenu.tsx`

**ì—…ì¢…ë³„ í™•ì¥ ë°©ë²•:**
- ì—…ì¢…ë³„ ë¼ìš°íŒ…ì€ `AppLayout`ì—ì„œ `onChatOpsViewTaskCard` propì„ í†µí•´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ ë¼ë²¨/ìš©ì–´ëŠ” Industry Adapterë¥¼ í†µí•´ ë³€í™˜ë©ë‹ˆë‹¤.

### Automation Policy Schema Rule

ìë™í™” ì„¤ì •(Policy)ì€ ì—…ì¢…ê³¼ ë¬´ê´€í•œ **ì¤‘ë¦½ ìŠ¤í‚¤ë§ˆ**ë¡œ ì •ì˜ëœë‹¤.

- Schema KeyëŠ” ì—…ì¢… ìš©ì–´ë¥¼ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.
- UI Labelë§Œ Industry Adapterì—ì„œ ë³€í™˜ëœë‹¤.
- tenant_settings JSONì€ ì—…ì¢… ê³µí†µ êµ¬ì¡°ë¥¼ ê°€ì§„ë‹¤.

ì˜ˆ:
- academy: "ì¶œê²° ì´ìƒ"
- salon: "ë°©ë¬¸ ì´ìƒ"
â†’ ë‚´ë¶€ ì •ì±… í‚¤ëŠ” ë™ì¼í•˜ë‹¤.

## âœ… ì„¤ì • ì €ì¥ SSOT (Single Source of Truth)

**âš ï¸ ëª¨ë“  ìë™í™” ì„¤ì •ì€ ì•„ë˜ ê·œê²©ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.**

### ì €ì¥ì†Œ ë° ê²½ë¡œ ê·œê²©
- **ì €ì¥ì†Œ**: `tenant_settings` KV êµ¬ì¡° (key='config' rowì˜ value JSONB)
  - `tenant_settings` í…Œì´ë¸”ì€ (tenant_id, key, value JSONB) KV êµ¬ì¡°ì…ë‹ˆë‹¤.
  - âš ï¸ ì¤‘ìš”: `config`ëŠ” ì»¬ëŸ¼ì´ ì•„ë‹ˆë¼ key='config'ì¸ rowì˜ value(JSONB)ì…ë‹ˆë‹¤. `tenant_settings.auto_notification.*` ê°™ì€ top-level ì»¬ëŸ¼ í‘œê¸° ê¸ˆì§€
- **ìë™í™” ì •ì±… ê²½ë¡œ**: `auto_notification.<event_type>.(enabled|channel|template_key|throttle|...)`
- **ì½”ë“œì—ì„œ ì„¤ì • ì½ê¸°**:
  - **ì„œë²„/Edge Function**: `getTenantSettingByPath(supabase, tenantId, path, legacyPath?)` í˜•ì‹ ì‚¬ìš©
    - ì˜ˆ: `await getTenantSettingByPath(supabase, tenantId, "auto_notification.overdue_outstanding_over_limit.enabled")`
    - ì‹œê·¸ë‹ˆì²˜: `(supabase: SupabaseClient, tenantId: string, path: string, legacyPath?: string) => Promise<unknown>`
    - ë°˜í™˜ íƒ€ì…: `unknown` (ì‹¤ì œ êµ¬í˜„ íƒ€ì…) â†’ ì‚¬ìš© ì‹œ íƒ€ì… ìºìŠ¤íŒ… í•„ìš” (ì˜ˆ: `as boolean`, `as number`)
    - ë°˜í™˜ ê°’ ì˜ë¯¸: Policyê°€ ì—†ìœ¼ë©´ `null`, ìˆìœ¼ë©´ ì§ì ‘ ê°’ `T` ë°˜í™˜ (`.value` ì ‘ê·¼ ë¶ˆí•„ìš”)
    - **í”„ë¡ íŠ¸ì—”ë“œ Hook `useTenantSettingByPath`**: `UseQueryResult<unknown, Error>` ë°˜í™˜ (React Queryì˜ `useQuery` ë°˜í™˜ ê°ì²´)
      - ì‚¬ìš© ì˜ˆì‹œ: `const { data: enabledValue } = useTenantSettingByPath("auto_notification.overdue.enabled");`
    - **í”„ë¡ íŠ¸ì—”ë“œ SSOT ìœ í‹¸ë¦¬í‹°** (apps/academy-admin/src/utils):
      - âš ï¸ **Policy ì¡°íšŒ SSOT**: `getPolicyValueFromConfig<T>(config, path)` í•¨ìˆ˜ ì‚¬ìš© (SSOT ìœ„ì¹˜: `apps/academy-admin/src/utils/policy-utils.ts`)
        - ì‚¬ìš© ì˜ˆì‹œ: `import { getPolicyValueFromConfig } from '../utils'; const threshold = getPolicyValueFromConfig<number>(config, 'auto_notification.overdue.threshold');`
      - âš ï¸ **Policy Registry SSOT**: `POLICY_REGISTRY` ë° `getPolicyValue<T>(key, config)` í•¨ìˆ˜ ì‚¬ìš© (SSOT ìœ„ì¹˜: `apps/academy-admin/src/utils/policy-registry.ts`)
        - Policy ì†ŒìŠ¤ ì´ì›í™” ë¬¸ì œ í•´ê²°: ëª¨ë“  Policyë¥¼ Registryì— ë“±ë¡í•˜ì—¬ ë‹¨ì¼ ì†ŒìŠ¤ë¡œ í†µì¼
        - ì‚¬ìš© ì˜ˆì‹œ: `import { getPolicyValue, POLICY_REGISTRY } from '../utils'; const threshold = getPolicyValue<number>('PAYMENT_FAILED_THRESHOLD', config);`
        - âš ï¸ **EMERGENCY_CARDS_POLICY_PATHS ë³€ê²½ì‚¬í•­**: `apps/academy-admin/src/constants/emergency-cards-policy.ts`ì˜ `EMERGENCY_CARDS_POLICY_PATHS`ëŠ” `POLICY_REGISTRY`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¬ì •ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ exportëŠ” ìœ ì§€í•˜ë˜, ì‹ ê·œ ì½”ë“œì—ì„œëŠ” `POLICY_REGISTRY`ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      - âš ï¸ **Barrel Export íŒ¨í„´**: ëª¨ë“  ìœ í‹¸ë¦¬í‹°ëŠ” `apps/academy-admin/src/utils/index.ts`ë¥¼ í†µí•´ export (SSOT)
        - ì‚¬ìš© ì˜ˆì‹œ: `import { getPolicyValueFromConfig, getPolicyValue, safe, normalizeDashboardCard } from '../utils';`
      - âš ï¸ **Constants Barrel Export íŒ¨í„´**: ëª¨ë“  ìƒìˆ˜ëŠ” `apps/academy-admin/src/constants/index.ts`ë¥¼ í†µí•´ export (SSOT)
        - ì‚¬ìš© ì˜ˆì‹œ: `import { POLICY_KEY_V2_CATEGORIES, AUTOMATION_EVENT_CRITERIA_FIELDS, AUTOMATION_EVENT_DESCRIPTIONS, validateAutomationEventDescriptions } from '../constants';`
        - Automation Event ê´€ë ¨ ìƒìˆ˜ì™€ ê²€ì¦ í•¨ìˆ˜ëŠ” ì´ íŒŒì¼ì„ í†µí•´ export
      - `data` ì†ì„±: `T | null` (Policyê°€ ì—†ìœ¼ë©´ `null`, ìˆìœ¼ë©´ ì§ì ‘ ê°’ `T`, `.value` ì ‘ê·¼ ë¶ˆí•„ìš”)
      - ì½”ë“œ ìœ„ì¹˜: `packages/hooks/use-config/src/useConfig.ts`
    - ì½”ë“œ ìœ„ì¹˜: `infra/supabase/functions/_shared/policy-utils.ts`
    - âš ï¸ **ìë™ ê²€ì¦ (êµ¬í˜„ ìƒíƒœ)**: `getTenantSettingByPath()` í•¨ìˆ˜ëŠ” `auto_notification.<event_type>.*` í˜•ì‹ì˜ ê²½ë¡œë¥¼ ë°›ì„ ë•Œ ìë™ìœ¼ë¡œ event_typeì„ ì¶”ì¶œí•˜ì—¬ ì¹´íƒˆë¡œê·¸ì— ë“±ë¡ëœ ê°’ì¸ì§€ ê²€ì¦í•©ë‹ˆë‹¤ (Fail-Closed, êµ¬í˜„ í™•ì¸: `infra/supabase/functions/_shared/policy-utils.ts:82`ì—ì„œ `assertAutomationEventType` í˜¸ì¶œ).
  - **í”„ë¡ íŠ¸ì—”ë“œ**: í”„ë¡ íŠ¸ì—”ë“œ ë˜í¼ í•¨ìˆ˜ ì‚¬ìš© (êµ¬í˜„ í•„ìš” ì‹œ `packages/hooks/use-config` ë˜ëŠ” ìœ ì‚¬ íŒ¨í‚¤ì§€ì—ì„œ ì œê³µ)
    - âš ï¸ í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” ì§ì ‘ `getTenantSettingByPath`ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©°, React Hook ë˜ëŠ” API í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ ì ‘ê·¼
  - ë‚´ë¶€ ë™ì‘: 1) tenant_settingsì—ì„œ tenant_id + key='config' rowì˜ value(JSONB) íšë“, 2) value(JSONB)ì—ì„œ ê²½ë¡œ ì¶”ì¶œ

### âœ… ê¸ˆì§€ ì‚¬í•­
- âŒ `tenant_settings.auto_notification.*` ì²˜ëŸ¼ **config ì—†ì´ top-level ì»¬ëŸ¼ì²˜ëŸ¼ ë³´ì´ëŠ” í‘œê¸° ê¸ˆì§€**
- âŒ v1/v2 í‚¤ë¥¼ ì´ì¤‘ ì €ì¥ ê¸ˆì§€ (legacy v1ì€ alias-only, ì €ì¥ ê²½ë¡œë¡œ ì‚¬ìš© ê¸ˆì§€)
- âŒ ì±„ë„ ì½”ë“œ 'kakao' ì €ì¥ ê¸ˆì§€ (SSOT-3: ì €ì¥/ì‹¤í–‰ìš©ì€ 'sms' | 'kakao_at'ë§Œ í—ˆìš©)

## âš ï¸ Policy Key v2 (Purpose-Based) â€” SSOT (ì •ë³¸)

âš ï¸ ì¤‘ìš”: ì •ë³¸ì€ Policy Key v2 6ê°œë§Œ ì‚¬ìš©, legacy_policy_keyëŠ” UI í•„í„°/ê²€ìƒ‰ìš© alias

ë³¸ ì‹œìŠ¤í…œì˜ ìë™í™”ëŠ” Policy Key(v2) 6ê°œë¥¼ ì •ë³¸(SSOT)ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
- ì •ì±… ì €ì¥/ê¶Œí•œ/ë¼ìš°íŒ…/ì„¤ì • UI ê·¸ë£¹í•‘ì€ policy_key_v2ë§Œ ì‚¬ìš©í•œë‹¤.
- ê¸°ì¡´ 5ê°œ Policy KeyëŠ” legacy_policy_key(alias)ë¡œë§Œ ìœ ì§€í•œë‹¤. (ëŸ°íƒ€ì„ SSOT ì•„ë‹˜)
- ì‹ ê·œ ìë™í™” ì¶”ê°€ëŠ” Policy Keyë¥¼ ëŠ˜ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ event_type(ì‹œë‚˜ë¦¬ì˜¤) ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ë¡œë§Œ ìˆ˜í–‰í•œë‹¤. (ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ = ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`ì— event_type ì¶”ê°€, êµ¬í˜„ ìœ„ì¹˜: `packages/core/core-automation/src/automation-event-catalog.ts`, `infra/supabase/functions/_shared/automation-event-catalog.ts`)
- ì„¤ì •ê°’ì´ ì—†ê±°ë‚˜ enabled=falseì´ë©´ ìë™í™”ëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤(Fail-Closed).

### Policy Key v2 (6)
1) financial_health: ì¬ë¬´/í˜„ê¸ˆíë¦„/ìˆ˜ë‚©/ë§¤ì¶œ KPI
2) capacity_optimization: ì •ì›/ì‹œê°„í‘œ/ë°˜ ìš´ì˜ ìµœì í™”
3) customer_retention: ì¶œê²° ìœ ì§€/ì´íƒˆ ì˜ˆë°©/ë¦¬ìŠ¤í¬ ì¼€ì–´
4) growth_marketing: ì‹ ê·œ/ì„±ì¥/ì „í™˜/ì§€ì—­ ê²½ìŸ(ë²¤ì¹˜ë§ˆí‚¹)
5) safety_compliance: ì•ˆì „/ê³µì§€/ë™ì˜/ë¯¼ê°ì •ë³´/ë¶„ìŸ ë¦¬ìŠ¤í¬
6) workforce_ops: ê°•ì‚¬/ì§ì› ìš´ì˜(ì—…ë¬´ëŸ‰/ê²°ê·¼/ëŒ€ì²´)

### Legacy Policy Key(v1, ê¸°ì¡´ 5ê°œ) â€” Alias Only
- attendance_anomaly / payment_overdue / ai_suggestion / report_generation / dashboard_priority(ë¯¸ì‚¬ìš©)
- legacy_policy_keyëŠ” í‘œì‹œ/ê²€ìƒ‰/í˜¸í™˜ì„ ìœ„í•œ ë©”íƒ€ë°ì´í„°ì´ë©°, ì •ì±… ì €ì¥ ê²½ë¡œì˜ SSOTê°€ ì•„ë‹ˆë‹¤.
- ë™ì¼ event_typeì— ëŒ€í•´ v2 ì •ì±…ê³¼ v1 ì •ì±…ì„ ì´ì¤‘ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤(ì„¤ì • ì¤‘ë³µ ê¸ˆì§€).

### í™•ì¥ ê·œì¹™
- ìƒìœ„ Policy Key(v2 6ê°œ)ëŠ” ê³ ì •(SSOT).
- ì‹ ê·œ ìë™í™”ëŠ” event_type ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€í•˜ê³ , policy_key_v2 / legacy_policy_key / level / trigger / executor / policy_pathë¥¼ ì •ì˜í•œë‹¤.
- ë¬¸ì„œ/ì½”ë“œì—ì„œ "í‘œì— ì—†ëŠ” ìë™í™” ì‹ ê·œ ì¶”ê°€ ë¶ˆê°€"ëŠ” "ì¹´íƒˆë¡œê·¸ì— ì—†ëŠ” event_typeì€ ì‹¤í–‰/ì¶”ê°€ ë¶ˆê°€"ë¡œ í•´ì„í•œë‹¤.

### ì½”ë“œ SSOT ìœ„ì¹˜
- âš ï¸ ì¤‘ìš”: ì •ë³¸(SSOT)ì€ ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`, ë¬¸ì„œì˜ í‘œëŠ” ê·¸ ì¶œë ¥ë¬¼
- event_type ì¹´íƒˆë¡œê·¸ ì •ë³¸(SSOT)ì€ ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`ì´ë©°, ë¬¸ì„œì˜ í‘œëŠ” ê·¸ ì¹´íƒˆë¡œê·¸ë¥¼ ë°˜ì˜í•œ ì¶œë ¥ë¬¼ì´ë‹¤.
  - **êµ¬í˜„ ìƒíƒœ**: âœ… `AUTOMATION_EVENT_CATALOG` ì½”ë“œ ìƒìˆ˜ êµ¬í˜„ ì™„ë£Œ (2024ë…„ êµ¬í˜„, íŒŒì¼ ê²½ë¡œ: `packages/core/core-automation/src/automation-event-catalog.ts`, `infra/supabase/functions/_shared/automation-event-catalog.ts`, `infra/supabase/supabase/functions/_shared/automation-event-catalog.ts`)
  - **ì½”ë“œ ìœ„ì¹˜**:
    - `packages/core/core-automation/src/automation-event-catalog.ts` (Node.js/TypeScript í™˜ê²½, ì •ë³¸)
    - `infra/supabase/functions/_shared/automation-event-catalog.ts` (Edge Function/Deno í™˜ê²½)
    - `infra/supabase/supabase/functions/_shared/automation-event-catalog.ts` (re-export íŒŒì¼, ìë™ ë™ê¸°í™”ë¨)
    - âš ï¸ **ìˆ˜ì • ì‹œ**: 2ê°œ íŒŒì¼(packages + infra/functions/_shared)ë§Œ ì—…ë°ì´íŠ¸í•˜ë©´ ë©ë‹ˆë‹¤. infra/supabase/supabase/functions/_shared/automation-event-catalog.tsëŠ” re-exportì´ë¯€ë¡œ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
  - **ì„±ëŠ¥ ìµœì í™”**: `isAutomationEventType()` í•¨ìˆ˜ëŠ” Set ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ O(1) ì‹œê°„ ë³µì¡ë„ë¡œ ê²€ì¦í•©ë‹ˆë‹¤. ë°°ì—´ì˜ `includes()`ëŠ” O(n)ì´ì§€ë§Œ Setì˜ `has()`ëŠ” O(1)ì…ë‹ˆë‹¤.
  - **ê²€ì¦ í•¨ìˆ˜**: `apps/academy-admin/src/constants/automation-event-descriptions.ts`ì˜ `validateAutomationEventDescriptions()` í•¨ìˆ˜ëŠ” `AUTOMATION_EVENT_CRITERIA_FIELDS`ì™€ `AUTOMATION_EVENT_DESCRIPTIONS`ê°€ `AUTOMATION_EVENT_CATALOG`ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ ì‚¬ìš© ê¶Œì¥)
- legacy_policy_keyëŠ” UI í•„í„°/ê²€ìƒ‰/í˜¸í™˜ í‘œê¸°ìš©ì´ë©°, ëŸ°íƒ€ì„ ì €ì¥/ì‹¤í–‰/ê¶Œí•œ ë¶„ê¸°ì—ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ì„¤ì • ì €ì¥ì€ `tenant_settings` KV êµ¬ì¡°ì—ì„œ key='config' rowì˜ value(JSONB) ê²½ë¡œ ê¸°ë°˜ì´ë©°, ì‹ ê·œ í•­ëª©ì€ `auto_notification.<event_type>.<field>` í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•œë‹¤.
  - **ì„œë²„/Edge Function ì½”ë“œ ì˜ˆì‹œ**: `await getTenantSettingByPath(supabase, tenantId, "auto_notification.overdue_outstanding_over_limit.enabled")`
  - ë‚´ë¶€ ë™ì‘: 1) tenant_settingsì—ì„œ key='config' rowì˜ value(JSONB) íšë“, 2) value(JSONB)ì—ì„œ ê²½ë¡œ ì¶”ì¶œ

### ì±…ì„ ê²½ê³„ (Responsibility Boundary)

**1) `tenant_settings` KV: key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œ `notification.*` (ë©”ì‹œì§€/ì•Œë¦¼ ì¸í”„ë¼ ê¸°ë³¸ ì •ì±…)**
- âš ï¸ ì¤‘ìš”: `notification.*` ê²½ë¡œëŠ” `tenant_settings` í…Œì´ë¸”ì˜ key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œì…ë‹ˆë‹¤. ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB)ì…ë‹ˆë‹¤.
- ê¸°ë³¸ ì±„ë„, ë°œì†¡ ì œí•œ, fallback, provider ë“± "ì¸í”„ë¼ ë ˆë²¨" ì •ì±…
- ìë™í™”ë³„ ì˜¤ë²„ë ˆì´ê°€ ì—†ì„ ë•Œ ì‚¬ìš©ë˜ëŠ” ê¸°ë³¸ê°’

**2) `tenant_settings` KV: key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œ `auto_notification.<event_type>.*` (ìë™í™”ë³„ ì •ì±… ì˜¤ë²„ë ˆì´)**
- ìë™í™” enable/channel/template_key ë“± "event_type ë‹¨ìœ„ ì •ì±…"
- ê° ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„¸ë¶€ ì„¤ì •

**3) `tenant_features['ai'].enabled` (+ PLATFORM_AI_ENABLED)**
- AI ì‹¤í–‰/ë¹„ìš©ì´ ê±¸ë¦¬ëŠ” ê¸°ëŠ¥ì˜ ìµœì¢… ìŠ¤ìœ„ì¹˜ (Fail-Closed)
- í”„ë¡ íŠ¸ëŠ” ìˆ¨ê¹€ì´ ì•„ë‹ˆë¼ "í‘œì‹œí•˜ë˜ ì‹¤í–‰ì„ ë§‰ëŠ” ë°©ì‹"ì´ ì›ì¹™

### Industry Expansion Rule (Critical)

ì‹ ê·œ ì—…ì¢…(Salon, Nail ë“±) í™•ì¥ ì‹œ ë‹¤ìŒì„ ê¸ˆì§€í•œë‹¤:

- ì‹ ê·œ ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•
- ì‹ ê·œ AI ë¶„ì„ ì‹œìŠ¤í…œ êµ¬ì¶•
- ì‹ ê·œ ì„¤ì • UI íë¦„ êµ¬ì¶•

í—ˆìš©ë˜ëŠ” ì‘ì—…ì€ ë‹¤ìŒë¿ì´ë‹¤:
- Industry Adapter ì¶”ê°€
- Schema Override ì¶”ê°€
- Label / Copy / ê°€ì¤‘ì¹˜ ì¡°ì •

---

## 0. ê°œìš”(Overview)

### 0.1 ë¬¸ì„œ ëª©ì 

**âš ï¸ 2-1: ë¬¸ì„œ ëª©ì  ëª…í™•í™” (ìƒìœ„ ê°œìš” + ì°¸ì¡° í—ˆë¸Œ):**

ë³¸ ë¬¸ì„œëŠ” ë””ì–´ìŒ¤ í•™ì›ê´€ë¦¬ í”„ë¡œê·¸ë¨ì˜ ì£¼ìš” ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­(SRS)ê³¼ ìƒìœ„ ë ˆë²¨ ê¸°ìˆ  ì•„í‚¤í…ì²˜ë¥¼ í†µí•© ì •ë¦¬í•˜ê³ , ìƒì„¸ ìŠ¤í‚¤ë§ˆ/ëª¨ë“ˆ/UX ê·œì•½ì€ ê°ê°ì˜ ì „ìš© ë¬¸ì„œë¥¼ ì •ì‹ ì¶œì²˜ë¡œ ì°¸ì¡°í•œë‹¤:

- **ìƒì„¸ DB ìŠ¤í‚¤ë§ˆ / ëª¨ë“ˆë³„ êµ¬í˜„ ê°€ì´ë“œ**: ì „ì²´ ê¸°ìˆ ë¬¸ì„œ ì°¸ì¡° (T1, T3 ë“±)
- **SDUI/ì»´í¬ë„ŒíŠ¸/ë°˜ì‘í˜•/ë‹¤í¬ëª¨ë“œ ê·œì•½**: UI/UX Technical Architecture ì°¸ì¡° (U6)
- **Schema Registry/Editor/Meta-Schema**: ìŠ¤í‚¤ë§ˆì—”ì§„ ë¬¸ì„œ ì°¸ì¡° (S3)
- **Regional Analytics SRS/ì•Œê³ ë¦¬ì¦˜ ìƒì„¸**: í†µê³„ë¬¸ì„œ ì°¸ì¡° (RA1)

ë³¸ ë¬¸ì„œëŠ” **"ë§ˆìŠ¤í„° ê°œìš” + Cross-Reference í—ˆë¸Œ"** ì—­í• ì„ ìˆ˜í–‰í•˜ë©°, ê° ë„ë©”ì¸ë³„ ìƒì„¸ ìŠ¤í™ì€ ìœ„ ì „ìš© ë¬¸ì„œë¥¼ ì •ë³¸(SSOT)ìœ¼ë¡œ ë”°ë¥¸ë‹¤.

**âš ï¸ ë¬¸ì„œ ì •ë³¸(SSOT) ê·œì¹™:**

ê° ë„ë©”ì¸ë³„ë¡œ ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(SSOT) ë¬¸ì„œê°€ ì§€ì •ë˜ì–´ ìˆìœ¼ë©°, ë‹¤ë¥¸ ë¬¸ì„œëŠ” ì´ë¥¼ ì°¸ì¡°ë§Œ í•©ë‹ˆë‹¤:

- **TaskCard/ìë™í™”**: í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ (ì •ë³¸, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- **ChatOps**: ì±—ë´‡.md (ì •ë³¸, ChatOps ê¸°ëŠ¥ ì œì–´ ì‹œìŠ¤í…œ ê¸°ìˆ ëª…ì„¸)
- **Auth/RLS**: ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt PART 18 (ì •ë³¸)
- **Regional Analytics**: ë””ì–´ìŒ¤ í†µê³„ë¬¸ì„œ.txt (ì •ë³¸)
- **ì „ì²´ ì•„í‚¤í…ì²˜**: ì´ ë¬¸ì„œ (`docu/ë””ì–´ìŒ¤  ì•„í‚¤í…ì²˜.md`, ì •ë³¸)

**âš ï¸ ì¤‘ìš”**: ìŠ¤í™ì´ ì—¬ëŸ¬ ë¬¸ì„œì— í©ì–´ì ¸ ìˆìœ¼ë©´ ì¶©ëŒì´ ë°œìƒí•˜ë¯€ë¡œ, ê° ë„ë©”ì¸ë³„ë¡œ ì •ë³¸ ë¬¸ì„œ 1ê°œë¥¼ ì§€ì •í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì°¸ì¡°ë§Œ í•©ë‹ˆë‹¤.

**âš ï¸ Platform RBAC vs Tenant RBAC ë¶„ë¦¬ ê·œì¹™ (ë³´ì•ˆ ë¶ˆë³€ ê·œì¹™, ëª¨ë“  ë¬¸ì„œ ê³µí†µ):**

**meta.schema_registryëŠ” Platform ê¶Œí•œ(user_platform_roles)ìœ¼ë¡œë§Œ í†µì œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.**
- âœ… **í—ˆìš©**: `user_platform_roles.role = 'super_admin'` ë˜ëŠ” `'developer'` ë˜ëŠ” `'qa'`
- âŒ **ê¸ˆì§€**: `user_tenant_roles` ê¸°ë°˜ ì ‘ê·¼ (í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€)
- âš ï¸ ì¤‘ìš”: ì´ ê·œì¹™ì€ "í•œ ë¬¸ì„œì˜ ì˜ˆì‹œ"ê°€ ì•„ë‹ˆë¼, **ì „ êµ¬ê°„ ê³µí†µ SSOT ë¸”ë¡(= ë³´ì•ˆ ë¶ˆë³€ ê·œì¹™)**ì…ë‹ˆë‹¤.

**ê³„ì•½ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ (Contract Test, í•„ìˆ˜):**

ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ëŠ” CI/CD íŒŒì´í”„ë¼ì¸ì— í¬í•¨ë˜ì–´ì•¼ í•˜ë©°, ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤:

| í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ | ê¸°ëŒ€ ê²°ê³¼ | ì„¤ëª… |
|------------|---------|------|
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` SELECT ì‹œë„ | 403 Forbidden ë˜ëŠ” ë¹ˆ ê²°ê³¼ì…‹ | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` INSERT ì‹œë„ | 403 Forbidden | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` UPDATE ì‹œë„ | 403 Forbidden | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` DELETE ì‹œë„ | 403 Forbidden | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_platform_roles.role = 'super_admin'` ì‚¬ìš©ìê°€ SELECT | ì„±ê³µ (ë°ì´í„° ë°˜í™˜) | Platform ê¶Œí•œ í—ˆìš© |
| `user_platform_roles.role = 'developer'` ì‚¬ìš©ìê°€ SELECT | ì„±ê³µ (ë°ì´í„° ë°˜í™˜) | Platform ê¶Œí•œ í—ˆìš© |
| `user_platform_roles.role = 'qa'` ì‚¬ìš©ìê°€ SELECT | ì„±ê³µ (ë°ì´í„° ë°˜í™˜) | Platform ê¶Œí•œ í—ˆìš© |
| `user_platform_roles.role = 'super_admin'` ì‚¬ìš©ìê°€ INSERT/UPDATE/DELETE | ì„±ê³µ | Platform ê¶Œí•œ í—ˆìš© |

âš ï¸ ì¤‘ìš”: ì´ í…ŒìŠ¤íŠ¸ë“¤ì€ RLS ì •ì±…ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ ê²€ì¦í•˜ë©°, ë³´ì•ˆ ì‚¬ê³ ë¥¼ ì‚¬ì „ì— ë°©ì§€í•©ë‹ˆë‹¤.

**AI ì½”ë“œ ìƒì„± ê·œì•½:**
- AI ì½”ë“œ/SQL ìƒì„± ì‹œ ì ìš©ë˜ëŠ” ê·œì¹™ì€ AI_ìë™ê²€ì¦_í”„ë¡œì„¸ìŠ¤ ë¬¸ì„œë¥¼ ë”°ë¥¸ë‹¤.

**ì°¸ì¡° ë²ˆí˜¸ ì‚¬ìš©ë²•ì€ 0.8 ì°¸ì¡° ë¬¸ì„œ ë§¤í•‘í‘œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.**

### 0.2 ëŒ€ìƒ ë²”ìœ„

- ì „ì²´ ì‹œìŠ¤í…œ ê°œìš”
- ì‚¬ìš©ì ìœ í˜• ë° ê¶Œí•œ
- í•µì‹¬ ë„ë©”ì¸ SRS
- ì§€ì—­ ê¸°ë°˜ í†µê³„ SRS
- ë©”ì‹œì§€/ì•Œë¦¼ SRS
- AI ë¶„ì„ ê¸°ëŠ¥ SRS
- ê¸°ìˆ  ì•„í‚¤í…ì²˜ (Multi-Tenant / RLS / SDUI / Zero-Trust / API SDK)

### 0.3 í•µì‹¬ ì² í•™ â€” Zero-Management Platform

ë””ì–´ìŒ¤ì€ "Zero-Management(ê´€ë¦¬ í•„ìš” ì—†ìŒ)"ì„ ëª©í‘œë¡œ ì„¤ê³„ëœ AI ê¸°ë°˜ í•™ì› ìš´ì˜ ìë™í™” í”Œë«í¼ì´ë‹¤.

ì‚¬ìš©ìê°€ ì–´ë–¤ ê¸°ëŠ¥ì„ ì°¾ì•„ì„œ ì¡°ì‘í•˜ê¸°ë³´ë‹¤, **ì„œë²„ê°€** ë¨¼ì € íŒë‹¨Â·ì¶”ì²œÂ·**ìƒì„±**í•˜ë©°, í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©ìê°€ ìŠ¹ì¸Â·í™•ì¸í•˜ë„ë¡ í•œë‹¤.

ì¦‰, í•™ì› ì›ì¥/ì„ ìƒë‹˜ì€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ë„ ìš´ì˜ì´ ëŒì•„ê°€ëŠ” ì‹œìŠ¤í…œì„ ê²½í—˜í•˜ê²Œ ëœë‹¤.

**âš ï¸ Architecture v3.3 ì‹¤í–‰ ì£¼ì²´ ë¶„ë¦¬ (ì •ë³¸ ê·œì¹™):**

ë³¸ ë¬¸ì„œì—ì„œ "ì‹œìŠ¤í…œì´ ì •ì±…ì— ë”°ë¼ ì‹¤í–‰í•œë‹¤"ëŠ” í‘œí˜„ì€ ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
- **AI/Rule Engine**: íŒë‹¨ ë° ì¶”ì²œ ìƒì„± (ì„œë²„)
- **Edge Function**: ì‹¤ì œ ì‹¤í–‰ ë° Role ê²€ì¦ (ì„œë²„)
- **í”„ë¡ íŠ¸ì—”ë“œ**: ìŠ¹ì¸ ìš”ì²­ë§Œ (UIëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ)

**ìš©ì–´ í†µì¼:**
- ~~"AI Suggestion"~~ (v2.x ì‚­ì œ) = TaskCard (task_type: 'ai_suggested', entity_type='student') (ì •ë³¸, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- "ìë™ ì‹¤í–‰" = ì„œë²„ê°€ ì •ì±…ì— ë”°ë¼ ì‹¤í–‰
- "í”„ë¡ íŠ¸ ìŠ¹ì¸" = ìŠ¹ì¸ ìš”ì²­ (ì‹¤í–‰ì€ ì„œë²„)

### 0.4 ì‹œìŠ¤í…œ íŠ¹ì„±

ë””ì–´ìŒ¤ í•™ì›ê´€ë¦¬ ì‹œìŠ¤í…œì€ ì¶œê²°ë²„ìŠ¤ + ê²°ì œë²„ìŠ¤ + ì§€ì—­í†µê³„ + AI ë¶„ì„ì´ ê²°í•©ëœ í•œêµ­ ìµœì´ˆì˜ ì—”í„°í”„ë¼ì´ì¦ˆ ë©€í‹°í…Œë„ŒíŠ¸ í•™ì› SaaSì´ë‹¤.

ë˜í•œ Multi-SaaS í”Œë«í¼ìœ¼ë¡œ í•™ì›/ë¯¸ìš©ì‹¤/ë¶€ë™ì‚° ë“± ì—¬ëŸ¬ ì—…ì¢…ì„ ë‹¨ì¼ ì½”ë“œë² ì´ìŠ¤ì—ì„œ ìš´ì˜í•œë‹¤.

**âš ï¸ ë³¸ ë¬¸ì„œì˜ ë²”ìœ„:**

ë³¸ ë¬¸ì„œëŠ” Multi-SaaS Monorepo ì¤‘ 'í•™ì› ì—…ì¢…(Academy)'ì„ **ì„¤ëª… ì˜ˆì‹œ**ë¡œ ì‚¬ìš©í•˜ë˜, í•™ì›ì€ ê¸°ë³¸ ì—…ì¢… ì˜ˆì‹œì¼ ë¿ ì •ë³¸ì´ ì•„ë‹˜ì„ ëª…ì‹œí•œë‹¤.

**âš ï¸ ì¤‘ìš”: í•™ì›ì€ ì˜ˆì‹œì¼ ë¿, ì •ë³¸ì´ ì•„ë‹˜**
- í•™ì›(Academy)ì€ ì„¤ëª…ì„ ìœ„í•œ ê¸°ë³¸ ì—…ì¢… ì˜ˆì‹œì¼ ë¿ì´ë‹¤.
- Core Platform / Event Engine / Payment / Notification / Regional Analytics / AI êµ¬ì¡°ëŠ” ëª¨ë“  ì—…ì¢…(Salon, Nail, Real Estate ë“±)ì—ì„œ ë™ì¼í•˜ê²Œ ì¬ì‚¬ìš©ë˜ëŠ” ê³µí†µ ë¡œì§ì´ë‹¤.
- ì—…ì¢…ë³„ ì°¨ì´ëŠ” Industry Adapter ë ˆì´ì–´ì—ì„œë§Œ í—ˆìš©ëœë‹¤.

**í•µì‹¬ íŠ¹ì§•:**

- ì¶œê²°ë²„ìŠ¤ ê¸°ë°˜ ê¸°ëŠ¥ì„ ì™„ì „ ìƒìœ„ í˜¸í™˜
- ë§¤ì¶œÂ·í•™ìƒ ìˆ˜Â·ì¶œì„ë¥  ë“±ì„ ì§€ì—­ ë‹¨ìœ„ë¡œ ë¹„êµí•˜ëŠ” ì§€ì—­ ê¸°ë°˜ í†µê³„ íƒ‘ì¬
- ê²°ì œ(ì¹´ë“œ/ê³„ì¢Œ/ê°„í¸ê²°ì œ) ì™„ì „ í†µí•©
- í•™ìƒ/ë°˜/ì¶œê²°/ìˆ˜ë‚©/ë©”ì‹œì§€ ì „ ê¸°ëŠ¥ í†µí•©
- ë°˜ì‘í˜• ì™„ì „ ì§€ì›
- SDUI ê¸°ë°˜ í™”ë©´ ìë™ ìƒì„±
- RLS ê¸°ë°˜ ì™„ì „í•œ ë°ì´í„° ê²©ë¦¬
- AI ê¸°ë°˜ ìƒë‹´ì¼ì§€ ë¶„ì„, ì¶œê²° ì´ìƒ íƒì§€, ìš´ì˜ ë¦¬í¬íŠ¸ ìƒì„±
- ì´ˆê¸° ì‚¬ìš©ìë„ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¨ìˆœ UI ê¸°ë°˜, ê³ ê¸‰ ê¸°ëŠ¥ì€ ìˆ¨ê²¨ì§„ Advanced Panelì—ì„œë§Œ ì œê³µ

### 0.5 ë„ë©”ì¸ êµ¬ì„±ë„

ì•„ë˜ 7ê°œê°€ ë©”ì¸ ë„ë©”ì¸ì´ë‹¤:

1. í•™ìƒê´€ë¦¬(Student Management)
2. ë°˜/ê°•ì‚¬ ê´€ë¦¬(Class & Teacher Management)
3. ì¶œê²° ê´€ë¦¬(Attendance Management)
4. ìˆ˜ë‚©/ì²­êµ¬ ê´€ë¦¬(Billing & Payment)
5. ë©”ì‹œì§€/ê³µì§€(Notification System)
6. ì§€ì—­ ê¸°ë°˜ í†µê³„(Regional Analytics)
7. AI ë¶„ì„ ê¸°ëŠ¥(AI Insights)

### 0.6 ìš©ì–´ì •ì˜(Glossary)

- **Zero-Management**: ê´€ë¦¬ í•„ìš” ì—†ìŒ, ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ìš´ì˜
- **SDUI**: Schema-Driven UI, ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ í™”ë©´ ìë™ ìƒì„±
- **RLS**: Row Level Security, í–‰ ë‹¨ìœ„ ë³´ì•ˆ ì •ì±…
- **Multi-Tenant**: ë©€í‹°í…Œë„ŒíŠ¸, ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì—¬ëŸ¬ ê³ ê° ê²©ë¦¬
- **Regional Analytics**: ì§€ì—­ ê¸°ë°˜ í†µê³„, ì§€ì—­ ë‹¨ìœ„ ë¹„êµ ë¶„ì„
- **Auto-Billing**: ìë™ ì²­êµ¬ ìƒì„± ë° ë°œì†¡
- **Partial Payment**: ë¶€ë¶„ë‚©ë¶€, ì²­êµ¬ ê¸ˆì•¡ì˜ ì¼ë¶€ë§Œ ë‚©ë¶€
- **Early Payment**: ì¡°ê¸°ë‚©ë¶€, ê¸°ê°„ ë‚´ ì¡°ê¸° ë‚©ë¶€ ì‹œ í• ì¸
- **TaskCard**: ì—…ë¬´ ì¹´ë“œ, **ì„œë²„ê°€** ìƒì„±í•˜ëŠ” ì—…ë¬´ ëª©ë¡ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

### 0.7 ë¬¸ì„œ ë²„ì „ íˆìŠ¤í† ë¦¬

- v3.0: ê¸°ìˆ  ì•„í‚¤í…ì²˜ ê¸°ë³¸ êµ¬ì¡° ì •ë¦¬ (Multi-Tenant / SDUI / AI / Regional Analytics ì´ˆì•ˆ)
- v3.1: ì¶œê²°ë²„ìŠ¤Â·ì•Œë¦¼ë±…í¬ ë§¤ë‰´ì–¼ ì™„ì „ ë°˜ì˜, Event Engine/Quota/Abuse ì •ì±…, Early/Partial Payment, Regional Analytics Pipeline v1.0, AI Override/Undo/Feedback êµ¬ì¡° ì¶”ê°€
- v3.2: 15ê°œ Critical/High ì´ìŠˆ í•´ê²° (industry_type enum í†µì¼, ì¹´ë“œ ê·œì¹™ í†µí•©, QR State Machine, Priority ë‹¨ìˆœí™”, Notification Retry í†µí•©, ì¶œê²° ì„¤ì • ì„¹ì…˜ ë¶„ë¦¬, ì„¤ì • UI ìœ„ì¹˜ í†µì¼ ë“±)
- v3.3: Critical 3ê±´, High 9ê±´, Medium 17ê±´ ì´ìŠˆ í•´ê²° (industry_type enum ì™„ì „ í†µì¼, ì¶œê²° ì„¤ì • JSON ë‹¨ì¼ ì •ë³¸ í™•ì •, Notification Retry ê·œì¹™ í†µí•©, í™ˆ ëŒ€ì‹œë³´ë“œ Priority Table í†µì¼, Billing Home ìš°ì„ ìˆœìœ„ ì¶©ëŒ í•´ê²°, Payment Webhook ì „ëµ ìš°ì„ ìˆœìœ„ ëª…í™•í™”, ì¶œê²° Anti-Abuse Fingerprint ì„¤ëª… í†µì¼, QR í† í° ë§Œë£Œ ê·œì¹™ ì¤‘ë³µ ì œê±°, í´ë˜ìŠ¤ ë„ë©”ì¸ Industry Layer ë¶„ë¦¬ ê·œì¹™ ì¶”ê°€, Regional Analytics ë¹„êµ ê·¸ë£¹ ë¡œì§ ë‹¨ì¼ ì •ë³¸ í™•ì •, AI Risk Weight ì—…ì¢…ë³„ ê°€ì¤‘ì¹˜ ì¼ê´€ì„± í™•ë³´, AI Undo ê·œì¹™ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ ì¶©ëŒ í•´ê²° ë“±)

### 0.8 ì°¸ì¡° ë¬¸ì„œ ë§¤í•‘í‘œ (Reference Map)

ë³¸ ë¬¸ì„œëŠ” ìƒìœ„ ë ˆë²¨ ì•„í‚¤í…ì²˜ì™€ ì£¼ìš” ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­ì„ ë‹¤ë£¨ë©°, ìƒì„¸ ìŠ¤í™ì€ ì•„ë˜ ì „ìš© ë¬¸ì„œë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.

**âš ï¸ ì¤‘ìš”: ë³¸ ë¬¸ì„œì—ì„œ ë‹¤ë¥¸ ë¬¸ì„œë¥¼ ì°¸ì¡°í•  ë•ŒëŠ” ì•„ë˜ ì°¸ì¡° ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.**

| ì°¸ì¡° ë²ˆí˜¸ | ë¬¸ì„œëª… | ì‹¤ì œ íŒŒì¼ | ì—­í•  |
|---------|--------|---------|------|
| **T1** | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 1 | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt | ì „ì²´ ì•„í‚¤í…ì²˜/Monorepo/ë©€í‹°í…Œë„ŒíŠ¸/DB ëª¨ë¸ (RLS ì •ì±…: 3-1 ì„¹ì…˜) |
| **T3** | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 3 | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt | ê²°ì œÂ·ì•Œë¦¼ë±…í‚¹/Public Gateway/Analytics/ë°°ì¹˜/í†µê³„ (ê²°ì œ ì •ì±…: 14-2-1-1 ì„¹ì…˜, ì¶œê²° DB: PART 1 ì°¸ì¡°, AI ëª¨ë¸: 15 ì„¹ì…˜) |
| **T6** | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 6 | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt | Monorepo êµ¬ì¡° ìƒì„¸ ì •ë³¸ |
| **T7** | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 7 | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt | Custom Domain ìš´ì˜ ê°€ì´ë“œ ì •ë³¸ |
| **T18** | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 18 | ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt | Auth/RLS ë§¤í•‘ ì •ë³¸ |
| **R1.1** | rules.md 1-1 | rules.md | Monorepo êµ¬ì¡° ì •ë³¸ |
| **R7.4** | rules.md 7-4 | rules.md | ê²°ì œ/ì•Œë¦¼ë±…í‚¹ ìš´ì˜ ì •ì±… ì •ë³¸ |
| **S3** | ìŠ¤í‚¤ë§ˆì—”ì§„ v2.1 | ìŠ¤í‚¤ë§ˆì—”ì§„.txt | SDUI êµ¬ì¡° ì •ë³¸ (Schema Registry, Meta-Schema, Condition Rule, Action Engine í¬í•¨) |
| **U6** | UI/UX Technical Architecture v6.0 | UI/UX Technical Architecture v6.0 | ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ/ë°˜ì‘í˜• UX ì •ë³¸ |
| **RA1** | í†µê³„ë¬¸ì„œ v1.0 | ë””ì–´ìŒ¤ í†µê³„ë¬¸ì„œ.txt | Regional Analytics ì •ë³¸ |

**ì°¸ì¡° í‘œí˜„ ê·œì¹™:**
- ë³¸ ë¬¸ì„œ ë‚´ ì°¸ì¡°: "ë³¸ ë¬¸ì„œ X.X ì„¹ì…˜ ì°¸ì¡°"
- ë‹¤ë¥¸ ë¬¸ì„œ ì°¸ì¡°: ì°¸ì¡° ë²ˆí˜¸ ì‚¬ìš© ì˜ˆì‹œ
  - "ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 18 ì°¸ì¡°" â†’ "T18 ì°¸ì¡°"
  - "rules.md 1-1ì ˆ ê¸°ì¤€" â†’ "R1.1 ê¸°ì¤€"
  - "ìŠ¤í‚¤ë§ˆì—”ì§„ ë¬¸ì„œ ì°¸ì¡°" â†’ "S3 ì°¸ì¡°"
  - "í†µê³„ë¬¸ì„œ ì°¸ì¡°" â†’ "RA1 ì°¸ì¡°"

## 1. í”Œë«í¼ ì „ì²´ ì•„í‚¤í…ì²˜ (Platform Architecture)

### 1.1 Multi-SaaS Monorepo êµ¬ì¡°

ë””ì–´ìŒ¤ì€ ë‹¨ì¼ ì½”ë“œë² ì´ìŠ¤ì—ì„œ ì—¬ëŸ¬ ì—…ì¢… SaaSë¥¼ ìš´ì˜í•˜ëŠ” Multi-SaaS í”Œë«í¼ì´ë‹¤.

**âš ï¸ 1-1: Monorepo êµ¬ì¡° vs rules.md êµ¬ì¡° ì •í•©ì„± í™•ë³´:**

**Monorepo êµ¬ì¡° (ê°œë…ì  ë ˆì´ì–´):**

ì‹¤ì œ Monorepo ë””ë ‰í„°ë¦¬ êµ¬ì¡°ì™€ ë„¤ì´ë° ê·œì¹™ì€ R1.1ì„ ì •ë³¸ìœ¼ë¡œ ë”°ë¥´ë©°,
ì´ ë¬¸ì„œì˜ `/core-platform`, `/ui-core`, `/industry-*` í‘œê¸°ëŠ” ê°œë…ì  ë ˆì´ì–´ ì´ë¦„ì´ë‹¤.

êµ¬í˜„ ì‹œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë§¤í•‘í•œë‹¤ (ê°œë… ë ˆì´ì–´ëª…ê³¼ ì‹¤ì œ íŒ¨í‚¤ì§€ëª… êµ¬ë¶„):

- `/core-platform` â†’ `packages/core/*` (core-auth, core-tenancy, core-billing ë“±)
- `/ui-core`(ê°œë…) â†’ `packages/ui-core` (ì‹¤ì œ UI íŒ¨í‚¤ì§€, `@ui-core/react`)
- `/industry-academy` â†’ `packages/industry/industry-academy`
- `/industry-salon` â†’ `packages/industry/industry-salon`
- `/industry-real-estate` â†’ `packages/industry/industry-real-estate`
- `/schema-engine` â†’ `packages/schema-engine` (SDUI ì—”ì§„)

**ì‹¤ì œ Monorepo ë””ë ‰í„°ë¦¬ êµ¬ì¡° (R1.1 ì •ë³¸):**

**âš ï¸ ì¤‘ìš”: ì•„ë˜ êµ¬ì¡°ëŠ” ê³µì‹ ìµœì¢… Monorepo êµ¬ì¡°ì…ë‹ˆë‹¤. ì‹¤ì œ íŒ¨í‚¤ì§€ ì´ë¦„/í´ë” êµ¬ì¡°ëŠ” R1.1 ë° T6ì„ ì •ë³¸ìœ¼ë¡œ ë”°ë¦…ë‹ˆë‹¤.**

```
/packages
  /core/*                 # ì—…ì¢… ê³µí†µ Core Platform Layer
    /core-auth
    /core-tenancy
    /core-billing
    /core-notification
    /core-payment
    /core-analytics
    /core-config
  /industry/*             # ì—…ì¢…ë³„ ì „ìš© ë ˆì´ì–´
    /industry-academy
    /industry-salon
    /industry-real-estate
  /ui-core                # UI Composition ê³„ì¸µ (ì‹¤ì œ íŒ¨í‚¤ì§€)
  /design-system          # Theme/Tokens (ui-coreê°€ ì†Œë¹„í•˜ëŠ” í† í° ë ˆì´ì–´)
  /theme-engine           # Theme Token / Tenant Theme Override ì—”ì§„
  /schema-engine          # SDUI ì—”ì§„
  /services/*             # ê³µí†µ ì„œë¹„ìŠ¤ ë ˆì´ì–´
  /hooks/*                # ê³µí†µ React Hooks
  /lib/*                  # ê³µí†µ ìœ í‹¸ë¦¬í‹°
  /env-registry/*         # í™˜ê²½ ë³€ìˆ˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬

/apps
  /academy-admin          # í•™ì› ê´€ë¦¬ì ì•±
  /academy-parent         # í•™ë¶€ëª¨ ì•±
  /super-admin            # Super Admin ì•± (ì „ì²´ í…Œë„ŒíŠ¸ ê´€ë¦¬)
  /public-gateway         # ê³µê°œ ê²Œì´íŠ¸ì›¨ì´
```

**âš ï¸ 1-3: UI ê³„ì¸µ ì´ë¦„ê³¼ ì‹¤ì œ UI ë¬¸ì„œ ê³„ì¸µ ëª…ì‹œ:**

`/ui-core`ëŠ” UI/UX Technical Architecture v6.0ì— ì •ì˜ëœ
core-ui / design-system / theme-engine ê³„ì¸µì„ í¬í•¨í•˜ëŠ” ê³µí†µ UI ë ˆì´ì–´ë¥¼ ì˜ë¯¸í•œë‹¤.

UI ê³„ì¸µ êµ¬ì¡°:
- schema-engine â†’ core-ui â†’ design-system â†’ theme-engine
- ìŠ¤í‚¤ë§ˆì—”ì§„ì˜ ì‹¤ì œ UI ì˜ì¡´ì„±ì€ `schema-engine â†’ @ui-core/react`ì´ë©°, theme/tokensëŠ” CSS ë³€ìˆ˜ë¡œ ì ìš©ëœë‹¤.

#### 1.1.1 Shared Feature ì •ì˜ (ì—…ì¢… ë…ë¦½)

**ìœ„ì¹˜:** `apps/*/features/*` (ì•± ë‚´ë¶€) ë˜ëŠ” `packages/schema-engine/*`

**ëª©ì :** ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ì¬ì‚¬ìš©ë˜ëŠ” ì‚¬ìš©ì í”Œë¡œìš°/ê¸°ëŠ¥ ì œê³µ

**ì •ì˜:**
- ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ì¬ì‚¬ìš©ë˜ëŠ” ì‚¬ìš©ì í”Œë¡œìš°/ê¸°ëŠ¥
- UI + ìƒíƒœ + ì •ì±… + ë¡œë”©/ì—ëŸ¬ í¬í•¨ ê°€ëŠ¥
- ë°ì´í„° ì ‘ê·¼ì€ Hook/Serviceë¡œ ìœ„ì„

**ë¬¼ë¦¬ ìœ„ì¹˜:**
- **UI ë¹„ì¤‘ì´ í° í”Œë¡œìš°:** `apps/*/features/` (ì•± ë‚´ë¶€ ëª¨ë“ˆ)
  - ì˜ˆ: `apps/academy-admin/src/features/ProtectedRoute.tsx`
  - ì˜ˆ: `apps/academy-admin/src/features/RoleBasedRoute.tsx`
- **ë„ë©”ì¸/ë°ì´í„° ì ‘ê·¼:** ê¸°ì¡´ëŒ€ë¡œ `hooks/services/industry/core`ë¡œ ë¶„ë¦¬
- **SDUI ì—”ì§„:** `packages/schema-engine/*` (Shared Feature ì„±ê²©)

**ë¶ˆë³€ ê·œì¹™:**
- Shared FeatureëŠ” ê¸°ì¡´ ì˜ì¡´ì„± ë°©í–¥ ê·œì¹™ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.
- `apps/* â†’ features/* â†’ hooks/* â†’ services/* â†’ industry/* â†’ core/* â†’ DB` ìˆœì„œë¡œ ì˜ì¡´í•©ë‹ˆë‹¤.
- Shared Feature ë‚´ë¶€ì—ì„œ ì§ì ‘ DB í˜¸ì¶œ ê¸ˆì§€ (Hook/Serviceë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼).

**ì°¸ê³ :** `docu/rules.md` Layer Classification Rules ì„¹ì…˜

### 1.2 Core / Industry / App Layer êµ¬ì¡°

**SDUI ìš°ì„ ìˆœìœ„ ê·œì¹™:**

1. tenant override (í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆ)
2. industry override (ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ)
3. core default (ê³µí†µ ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ)

**Schema Registryì˜ industry_type:**

- ëª¨ë“  ìŠ¤í‚¤ë§ˆëŠ” industry_type í•„ë“œë¡œ ì—…ì¢… êµ¬ë¶„
- RLS ì •ì±…ì—ì„œ industry_type ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- ì—…ì¢…ë³„ ë…ë¦½ì ì¸ ìŠ¤í‚¤ë§ˆ ë²„ì „ ê´€ë¦¬

#### 1.2.1 Domain/Service ì „ì²´ ëª©ë¡ (ì—…ì¢… ë…ë¦½)

**ìœ„ì¹˜:** `packages/core/*` (ì—…ì¢… ê³µí†µ) + `packages/industry/*` (ì—…ì¢…ë³„)

**ëª©ì :** ëª¨ë“  ì—…ì¢…ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ë„ë©”ì¸ ëª¨ë¸, ê³µí†µ ìŠ¤í‚¤ë§ˆ ì œê³µ

**ë¶„ë¥˜:** Domain/Service (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§. ì—…ì¢…ë³„ ë„ë©”ì¸: `packages/industry/*`. ì—…ì¢… ê³µí†µ ë„ë©”ì¸: `packages/core/*`)

**ì—…ì¢… ê³µí†µ Domain/Service (`packages/core/*`):**

**í˜„ì¬ êµ¬í˜„ëœ Core ëª¨ë“ˆ (20ê°œ):**

| ëª¨ë“ˆ | ê²½ë¡œ | ìš©ë„ | ì—…ì¢… ë…ë¦½ì„± |
|------|------|------|------------|
| core-activity | `packages/core/core-activity` | Activity Feed / íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ê¸°ë¡ | âœ… |
| core-analytics | `packages/core/core-analytics` | í†µê³„ íŒŒì´í”„ë¼ì¸ | âœ… |
| core-auth | `packages/core/core-auth` | ì¸ì¦ (ë¡œê·¸ì¸/íšŒì›ê°€ì…) | âœ… |
| core-automation | `packages/core/core-automation` | ìë™í™” ì—”ì§„ (ì—…ì¢… ë…ë¦½) | âœ… |
| core-billing | `packages/core/core-billing` | ê³¼ê¸ˆ/ì²­êµ¬ | âœ… |
| core-calendar | `packages/core/core-calendar` | ì¼ì •/ì˜ˆì•½/ìˆ˜ì—… ìŠ¤ì¼€ì¤„ | âœ… |
| core-community | `packages/core/core-community` | ê²Œì‹œíŒ/ëŒ“ê¸€/ê³µì§€ | âœ… |
| core-config | `packages/core/core-config` | ì„¤ì • ê´€ë¦¬ | âœ… |
| core-consultation | `packages/core/core-consultation` | ìƒë‹´/ê¸°ë¡ ê´€ë¦¬ | âœ… |
| core-coupons | `packages/core/core-coupons` | ì¿ í°/í• ì¸ ê´€ë¦¬ | âœ… |
| core-events | `packages/core/core-events` | ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜ ê´€ë¦¬ | âœ… |
| core-metering | `packages/core/core-metering` | ì‚¬ìš©ëŸ‰ ì¸¡ì • | âœ… |
| core-notification | `packages/core/core-notification` | ì•Œë¦¼ ì‹œìŠ¤í…œ | âœ… |
| core-party | `packages/core/core-party` | íšŒì›/ê³ ê° ê³µí†µ ëª¨ë¸ | âœ… |
| core-payment | `packages/core/core-payment` | ê²°ì œ ì‹œìŠ¤í…œ | âœ… |
| core-reviews | `packages/core/core-reviews` | ë¦¬ë·°/í‰ê°€ ì‹œìŠ¤í…œ | âœ… |
| core-schema-registry | `packages/core/core-schema-registry` | ìŠ¤í‚¤ë§ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ | âœ… |
| core-search | `packages/core/core-search` | Full Text Search | âœ… |
| core-storage | `packages/core/core-storage` | íŒŒì¼ ì—…ë¡œë“œ/ê¶Œí•œ | âœ… |
| core-tags | `packages/core/core-tags` | ê³µí†µ íƒœê¹… ì‹œìŠ¤í…œ | âœ… |
| core-tenancy | `packages/core/core-tenancy` | í…Œë„Œì‹œ ê´€ë¦¬ | âœ… |
| core-tenancy-referral | `packages/core/core-tenancy-referral` | B2B ì¶”ì²œì¸ ì½”ë“œ | âœ… |
| pii-utils | `packages/core/pii-utils` | PII ìœ í‹¸ë¦¬í‹° | âœ… |

**ê³µí†µ ëª¨ë“ˆ êµ¬ì¡° íŒ¨í„´:**
```
packages/core/{module-name}/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts      # íƒ€ì…ë§Œ export (ì„œë²„ ì½”ë“œëŠ” /service ê²½ë¡œì—ì„œë§Œ import)
â”‚   â”œâ”€â”€ service.ts    # ì„œë²„ ì‚¬ì´ë“œ ì„œë¹„ìŠ¤ ë¡œì§
â”‚   â””â”€â”€ types.ts      # íƒ€ì… ì •ì˜
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

**ë¶ˆë³€ ê·œì¹™:**
- Core Layer ëª¨ë“ˆì˜ `index.ts`ëŠ” íƒ€ì…ë§Œ exportí•˜ë©°, ì„œë²„ ì½”ë“œëŠ” `/service` ê²½ë¡œì—ì„œë§Œ importí•©ë‹ˆë‹¤.
- Core Layer ëª¨ë“ˆì€ Industry Layerë¥¼ importí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ë‹¨ë°©í–¥ ì˜ì¡´ì„±).
- Core Layer ëª¨ë“ˆì€ ë‹¤ë¥¸ Core Layer ëª¨ë“ˆì„ importí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ëª¨ë“  Core ëª¨ë“ˆì€ ì—…ì¢… ë…ë¦½ì ìœ¼ë¡œ ì„¤ê³„ë˜ì–´ ëª¨ë“  ì—…ì¢…ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ì—…ì¢…ë³„ Domain/Service (`packages/industry/*`):**

| ì—…ì¢… | ê²½ë¡œ | ìš©ë„ | ì—…ì¢… ë…ë¦½ì„± |
|------|------|------|------------|
| Academy | `packages/industry/industry-academy` | í•™ì› ì—…ì¢…ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | âš ï¸ Academy ì „ìš© |
| Salon | `packages/industry/industry-salon` | ë¯¸ìš©ì‹¤ ì—…ì¢…ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | âš ï¸ Salon ì „ìš© |
| Real Estate | `packages/industry/industry-real-estate` | ë¶€ë™ì‚° ì—…ì¢…ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | âš ï¸ Real Estate ì „ìš© |
| Gym | `packages/industry/industry-gym` | ì²´ìœ¡ê´€ ì—…ì¢…ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (í–¥í›„ ì¶”ê°€) | âš ï¸ Gym ì „ìš© |

**ì°¸ê³ :** Automation & AI Industry-Neutral Rule (ë³¸ ë¬¸ì„œ 55-100ì¤„)ì— ë”°ë¼ ìë™í™”/AIì˜ ì‹¤í–‰ êµ¬ì¡°ëŠ” Core Platform ê³µí†µ ë¡œì§ì…ë‹ˆë‹¤.

#### 1.2.2 Service/UseCase ê³µí†µí™” íŒ¨í„´ (ì—…ì¢… ë…ë¦½)

**ìœ„ì¹˜:** `packages/services/*` + `@industry/*/service`

**ëª©ì :** Industry Layerë¥¼ ë˜í•‘í•˜ì—¬ ì œê³µí•˜ëŠ” ê³µí†µ ì„œë¹„ìŠ¤ ë ˆì´ì–´

**ë¶„ë¥˜:** Service/UseCase (ë„ë©”ì¸ ë¡œì§/ë°ì´í„° ì ‘ê·¼ ìº¡ìŠí™”. UI/Router ì˜ì¡´ ê¸ˆì§€. React ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§ì ‘ DB í˜¸ì¶œ ê¸ˆì§€ ì›ì¹™ì˜ ì‹¤í–‰ ì£¼ì²´)

**í˜„ì¬ êµ¬í˜„ëœ Service íŒ¨í‚¤ì§€ (4ê°œ):**

| Service íŒ¨í‚¤ì§€ | ê²½ë¡œ | Industry Layer ë§¤í•‘ | ìš©ë„ | ì—…ì¢… ë…ë¦½ì„± |
|---------------|------|-------------------|------|------------|
| attendance-service | `packages/services/attendance-service` | `@industry/academy` | ì¶œì„ ê´€ë¦¬ | âš ï¸ Academy ì „ìš© (í–¥í›„ ì—…ì¢…ë³„ Service ì¶”ê°€) |
| auth-service | `packages/services/auth-service` | `@core/auth`, `@core/tenancy` | ì¸ì¦/íšŒì›ê°€ì… | âœ… |
| class-service | `packages/services/class-service` | `@industry/academy` | ìˆ˜ì—… ê´€ë¦¬ | âš ï¸ Academy ì „ìš© (í–¥í›„ ì—…ì¢…ë³„ Service ì¶”ê°€) |
| student-service | `packages/services/student-service` | `@industry/academy` | í•™ìƒ ê´€ë¦¬ | âš ï¸ Academy ì „ìš© (í–¥í›„ ì—…ì¢…ë³„ Service ì¶”ê°€) |

**Service Layer êµ¬ì¡° íŒ¨í„´:**
```
packages/services/{service-name}/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts      # íƒ€ì…ë§Œ export (í´ë¼ì´ì–¸íŠ¸ì—ë„ ì‚¬ìš© ê°€ëŠ¥)
â”‚   â”œâ”€â”€ service.ts    # ì„œë²„ ì‚¬ì´ë“œ ì„œë¹„ìŠ¤ ë¡œì§ (Industry Layer ë˜í•‘)
â”‚   â””â”€â”€ types.ts      # íƒ€ì… ì •ì˜
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

**ë¶ˆë³€ ê·œì¹™:**
- Service LayerëŠ” Industry Layerë¥¼ ë˜í•‘í•˜ì—¬ ì œê³µí•©ë‹ˆë‹¤.
- Service Layerì˜ `index.ts`ëŠ” íƒ€ì…ë§Œ exportí•˜ë©°, ì„œë²„ ì½”ë“œëŠ” `/service` ê²½ë¡œì—ì„œë§Œ importí•©ë‹ˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ëŠ” `@services/{service-name}`ë¥¼ í†µí•´ íƒ€ì…ì„ importí•©ë‹ˆë‹¤.
- ì„œë²„ëŠ” `@services/{service-name}/service`ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ `@industry/{ì—…ì¢…}/service`ë¥¼ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
- Service LayerëŠ” Zero-Trust ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ êµ¬ì„± ìš”ì†Œì…ë‹ˆë‹¤.

**ì˜ì¡´ì„± ë°©í–¥:**
```
Service Layer â†’ Industry Layer â†’ Core Layer â†’ DB
```

**ì°¸ê³ :** `docu/rules.md` 105ì¤„, `docu/ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt` 3953-3963ì¤„

#### 1.2.3 lib ê³µí†µ ìœ í‹¸ë¦¬í‹° ì „ì²´ ëª©ë¡ (ì—…ì¢… ë…ë¦½)

**ìœ„ì¹˜:** `packages/lib/*`

**ëª©ì :** ëª¨ë“  ì—…ì¢…ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ìœ í‹¸ë¦¬í‹° ì œê³µ

**í˜„ì¬ êµ¬í˜„ëœ lib íŒ¨í‚¤ì§€ (2ê°œ):**

| íŒ¨í‚¤ì§€ | ê²½ë¡œ | ì£¼ìš” í•¨ìˆ˜ | ìš©ë„ | ì—…ì¢… ë…ë¦½ì„± |
|--------|------|----------|------|------------|
| date-utils | `packages/lib/date-utils` | `toKST`, `getTodayKST`, `getDateRangeKST` | KST íƒ€ì„ì¡´ í—¬í¼ | âœ… |
| supabase-client | `packages/lib/supabase-client` | `createClient`, `createServerClient`, `withTenant` | Supabase í´ë¼ì´ì–¸íŠ¸ ìœ í‹¸ë¦¬í‹° | âœ… |

**date-utils ì‚¬ìš©ë²•:**
```typescript
import { toKST, getTodayKST } from '@lib/date-utils';

// KST ê¸°ì¤€ í˜„ì¬ ì‹œê°„
const nowKst = toKST();

// KST ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´
const today = getTodayKST(); // 'YYYY-MM-DD'
```

**supabase-client ì‚¬ìš©ë²•:**
```typescript
// í´ë¼ì´ì–¸íŠ¸
import { createClient } from '@lib/supabase-client';

// ì„œë²„/Edge
import { createServerClient } from '@lib/supabase-client/server';

// ë©€í‹°í…Œë„ŒíŠ¸
import { withTenant } from '@lib/supabase-client/db';
```

**ë¶ˆë³€ ê·œì¹™:**
- ëª¨ë“  ì‹œê°„ì€ DBì—ëŠ” UTCë¡œ ì €ì¥í•˜ë˜, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§Â·í‘œì‹œÂ·ì§‘ê³„ëŠ” KST ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- UIÂ·ë¦¬í¬íŠ¸Â·ë¡œê·¸Â·ì•ŒëŒ: í•­ìƒ KSTë¡œ ë³€í™˜í•´ì„œ í‘œì‹œí•©ë‹ˆë‹¤.
- `toISOString().split('T')[0]` ë˜ëŠ” `toISOString().slice(0, 10)` ì§ì ‘ ì‚¬ìš© ê¸ˆì§€ (KST ë³€í™˜ í•„ìˆ˜).

**ì°¸ê³ :** `docu/rules.md` 5. ì‹œê°„ & íƒ€ì„ì¡´(KST) ê·œì¹™, `docu/ì „ì²´ ê¸°ìˆ ë¬¸ì„œ.txt` 19-1. íƒ€ì„ì¡´(KST) í‘œì¤€

#### 1.2.4 Cross-cutting Concern ì •ë¦½ (ì—…ì¢… ë…ë¦½)

**ìœ„ì¹˜:** `packages/lib/*` + `packages/api-sdk/*` + `packages/env-registry/*` + `packages/core/core-config/*` + `packages/ui-core/src/components/ErrorBoundary.tsx`

**ëª©ì :** ë¡œê¹…/ì •ì±…/ê¶Œí•œ/ì¶”ì /ì—ëŸ¬ì²˜ë¦¬/PII ë“± ì „ ì˜ì—­ì— ì ìš©ë˜ëŠ” ê³µí†µ ê·œì¹™ê³¼ ìœ í‹¸ ì œê³µ

**ë¶„ë¥˜:** Cross-cutting Concern (ë¡œê¹…/ì •ì±…/ê¶Œí•œ/ì¶”ì /ì—ëŸ¬ì²˜ë¦¬/PII ë“± ì „ ì˜ì—­ì— ì ìš©ë˜ëŠ” ê³µí†µ ê·œì¹™ê³¼ ìœ í‹¸)

**í˜„ì¬ êµ¬í˜„ëœ Cross-cutting Concern íŒ¨í‚¤ì§€:**

| íŒ¨í‚¤ì§€ | ê²½ë¡œ | ì£¼ìš” ê¸°ëŠ¥ | ìš©ë„ | ì—…ì¢… ë…ë¦½ì„± |
|--------|------|----------|------|------------|
| lib/date-utils | `packages/lib/date-utils` | KST íƒ€ì„ì¡´ í—¬í¼ | ë‚ ì§œ/ì‹œê°„ ë³€í™˜ | âœ… |
| lib/supabase-client | `packages/lib/supabase-client` | Supabase í´ë¼ì´ì–¸íŠ¸ ìœ í‹¸ë¦¬í‹° | DB ì ‘ê·¼ ì¶”ìƒí™” | âœ… |
| api-sdk | `packages/api-sdk` | Zero-Trust API SDK | API ìš”ì²­ ì¶”ìƒí™”, ê¶Œí•œ ì£¼ì… | âœ… |
| env-registry | `packages/env-registry` | í™˜ê²½ë³€ìˆ˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬ | í™˜ê²½ë³€ìˆ˜ ì ‘ê·¼ í†µì œ | âœ… |
| core-config | `packages/core/core-config` | ì„¤ì • ê´€ë¦¬ | ì„¤ì • ì ‘ê·¼ í†µì œ | âœ… |
| ErrorBoundary | `packages/ui-core/src/components/ErrorBoundary.tsx` | ì—ëŸ¬ ê²½ê³„ | ì—ëŸ¬ ì²˜ë¦¬ | âœ… |
| pii-utils | `packages/core/pii-utils` | PII ìœ í‹¸ë¦¬í‹° | ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ | âœ… |

**ë¶ˆë³€ ê·œì¹™:**
- Cross-cutting Concernì€ ëª¨ë“  ë ˆì´ì–´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
- ë¡œê¹…/ì¶”ì ì€ ì „ ì˜ì—­ì— ì ìš©ë˜ë©°, ê° ë ˆì´ì–´ì—ì„œ ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ì •ì±…/ê¶Œí•œì€ Zero-Trust ì›ì¹™ì— ë”°ë¼ ì„œë²„/Edge Functionì—ì„œë§Œ ê²°ì •í•©ë‹ˆë‹¤.
- ì—ëŸ¬ì²˜ë¦¬ëŠ” ErrorBoundaryì™€ api-sdk Error Handlingì„ í†µí•´ ì¼ê´€ë˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.

**ì°¸ê³ :** `docu/rules.md` Layer Classification Rules ì„¹ì…˜

#### 1.2.5 design-system Theme Engine ìƒì„¸ (ì—…ì¢… ë…ë¦½)

**ìœ„ì¹˜:** `packages/design-system`

**ëª©ì :** ì—…ì¢… ë…ë¦½ì ì¸ Multi-Tenant Theme Engine ì œê³µ

**Theme Merge Priority:**
1. system default tokens (ì‹œìŠ¤í…œ ê¸°ë³¸ í† í°)
2. industry tokens (ì—…ì¢…ë³„ í† í°) - `industry_themes` í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
3. tenant theme override (í…Œë„ŒíŠ¸ë³„ í…Œë§ˆ ì˜¤ë²„ë¼ì´ë“œ) - `tenant_theme_overrides` í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
4. dark mode (ë‹¤í¬ëª¨ë“œ)
5. high contrast (forced-colors)

**êµ¬í˜„ ìœ„ì¹˜:**
- Theme Engine: `packages/design-system/src/theme.ts`
- Tokens: `packages/design-system/src/tokens.ts`

**ì£¼ìš” Export:**
```typescript
import { ThemeEngine, createTheme } from '@design-system/core';
import type { ThemeMode, IndustryType, ThemeTokens, ThemeConfig } from '@design-system/core';
```

**Theme Engine ì‚¬ìš©ë²•:**
```typescript
import { createTheme } from '@design-system/core';

const theme = createTheme({
  mode: 'light' | 'dark' | 'auto',
  industryType: 'academy' | 'salon' | 'real_estate' | 'gym' | 'ngo',
  industryTheme: { tokens: { ... } }, // ì—…ì¢…ë³„ í† í°
  tenantTheme: { tokens: { ... } }, // í…Œë„ŒíŠ¸ë³„ í…Œë§ˆ ì˜¤ë²„ë¼ì´ë“œ
  highContrast: false,
});

const tokens = theme.getTokens();
const spacing = theme.getSpacing('md');
const color = theme.getColor('primary', 'DEFAULT');
```

**ë¶ˆë³€ ê·œì¹™:**
- ëª¨ë“  ìŠ¤íƒ€ì¼ì€ design-system í† í°ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ ì°¨ì´ëŠ” Industry Themeì„ í†µí•´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì€ Tenant Theme Overrideë¥¼ í†µí•´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- Theme Engineì€ ì—…ì¢… ë…ë¦½ì ìœ¼ë¡œ ì„¤ê³„ë˜ì–´ ëª¨ë“  ì—…ì¢…ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ì°¸ê³ :** `docu/ì „ì²´ ìœ ì•„ì´ë¬¸ì„œ.txt` 512-539ì¤„

#### 1.2.6 api-sdk Zero-Trust API SDK ìƒì„¸ (ì—…ì¢… ë…ë¦½)

**ìœ„ì¹˜:** `packages/api-sdk`

**ëª©ì :** Zero-Trust ì›ì¹™ì„ ì¤€ìˆ˜í•˜ëŠ” API SDK ì œê³µ

**ì£¼ìš” Export:**
```typescript
import { apiClient, getApiContext, setApiContext } from '@api-sdk/core';
import type { ApiResponse, ApiRequest } from '@api-sdk/core';
```

**ApiClient í´ë˜ìŠ¤ ë©”ì„œë“œ:**
- `get<T>(table, options?)`: GET ìš”ì²­
- `post<T>(table, data)`: POST ìš”ì²­
- `put<T>(table, id, data)`: PUT ìš”ì²­
- `delete<T>(table, id)`: DELETE ìš”ì²­
- `call<T>(endpoint, method, body?)`: ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
- `invokeFunction<T>(functionName, body?)`: Edge Function í˜¸ì¶œ

**Zero-Trust ì›ì¹™:**
- UIì—ì„œ `fetch`, `axios`, `supabase client`ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ëª¨ë“  ìš”ì²­ì€ SDKë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- SDKê°€ ìë™ìœ¼ë¡œ `tenant_id`, `industry_type`, `auth token`ì„ ì‚½ì…í•©ë‹ˆë‹¤.
- UIëŠ” "ë¬´ìŠ¨ í…Œë„ŒíŠ¸ì¸ì§€" ë˜ëŠ” "ì–´ë–¤ ì—…ì¢…ì¸ì§€" ì´í•´í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
- UIê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë°ì´í„° ë²”ìœ„ëŠ” RLSê°€ ì±…ì„ì§‘ë‹ˆë‹¤.

**Error Handling ê·œì¹™:**
- ì¸ì¦ ë§Œë£Œ: JWT í† í° ë§Œë£Œ ì‹œ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- í…Œë„ŒíŠ¸ ë³€ê²½: Contextì˜ `tenantId` ë³€ê²½ ì‹œ ëª¨ë“  í™œì„± ì¿¼ë¦¬ ìë™ ë¬´íš¨í™”
- Industry Mismatch: ìš”ì²­í•œ `industry_type`ê³¼ ì‹¤ì œ ë°ì´í„°ì˜ `industry_type` ë¶ˆì¼ì¹˜ ì‹œ ì˜¤ë¥˜ ë°˜í™˜
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ëŠ” ìë™ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)

**Edge Function í˜¸ì¶œ ê·œì¹™:**
- Edge Function í˜¸ì¶œë„ ë°˜ë“œì‹œ `@api-sdk/core`ë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
- UIëŠ” ì ˆëŒ€ ì§ì ‘ `fetch`ë¡œ Edge Functionì„ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
- `apiClient.invokeFunction()`ì„ ì‚¬ìš©í•˜ì—¬ Edge Function í˜¸ì¶œ
- `apiClient`ëŠ” ìë™ìœ¼ë¡œ tenant_id, industry_type, JWT í† í°ì„ í¬í•¨í•˜ì—¬ ìš”ì²­

**ë¶ˆë³€ ê·œì¹™:**
- ëª¨ë“  API ìš”ì²­ì€ `@api-sdk/core`ë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- SDKëŠ” ì—…ì¢… ë…ë¦½ì ìœ¼ë¡œ ì„¤ê³„ë˜ì–´ ëª¨ë“  ì—…ì¢…ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ì°¸ê³ :** `docu/ì „ì²´ ìœ ì•„ì´ë¬¸ì„œ.txt` 359-410ì¤„, `docu/ìŠ¤í‚¤ë§ˆì—”ì§„.txt` 80-89ì¤„

### 1.3 Supabase ê¸°ë°˜ ë©€í‹°í…Œë„ŒíŠ¸ êµ¬ì¡°

**RLS(Row Level Security) ì •ì±…ì˜ ì‹¤ì œ í…Œì´ë¸” ë‹¨ìœ„ ì •ì˜:**

**RLS ì •ì±… 3ì¢…:**

â‘  tenant_id = auth.jwt().tenant_id
- í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ì™„ì „ ê²©ë¦¬
- ëª¨ë“  í…Œì´ë¸”ì— ê¸°ë³¸ ì ìš©

â‘¡ industry_type = auth.jwt().industry_type
- ì—…ì¢…ë³„ ë°ì´í„° ê²©ë¦¬
- ì—…ì¢… ê°„ ë°ì´í„° ì ‘ê·¼ ì°¨ë‹¨

â‘¢ admin override ê°€ëŠ¥ ì—¬ë¶€
- ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ íŠ¹ì • ì •ì±… ìš°íšŒ ê°€ëŠ¥ ì—¬ë¶€
- Super Adminì€ ëª¨ë“  í…Œë„ŒíŠ¸ ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥

**âš ï¸ 2-3: RLS ì˜ˆì‹œ í…œí”Œë¦¿ (ì „ì²´ ê¸°ìˆ ë¬¸ì„œì™€ í˜•ì‹ í†µì¼):**

**í‘œì¤€ RLS í…œí”Œë¦¿ (FOR ALL + USING/WITH CHECK, JWT claim ê¸°ë°˜):**

```sql
CREATE POLICY tenant_isolation_students ON public.students
FOR ALL TO authenticated
USING (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
)
WITH CHECK (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
);
```

**ì—…ì¢… ê²©ë¦¬ ì •ì±… ì˜ˆì‹œ:**

```sql
CREATE POLICY industry_isolation_students ON public.students
FOR ALL TO authenticated
USING (
  industry_type = (auth.jwt() ->> 'industry_type')::text
)
WITH CHECK (
  industry_type = (auth.jwt() ->> 'industry_type')::text
);
```

**ê´€ë¦¬ì ìš°íšŒ ì •ì±… ì˜ˆì‹œ:**

âš ï¸ ì¤‘ìš”: í”Œë«í¼ ê¶Œí•œ(super_admin/developer)ì€ DB ê¸°ë°˜(user_platform_roles)ì„ ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(SSOT)ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
JWT role claimì€ í‘œì‹œ/UX íŒíŠ¸ ìˆ˜ì¤€ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê±°ë‚˜ ì™„ì „ ì œê±°í•©ë‹ˆë‹¤.

```sql
CREATE POLICY admin_override_students ON public.students
FOR ALL TO authenticated
USING (
  -- ì •ë³¸: DB ê¸°ë°˜ ê¶Œí•œ ê²€ì¦ (SSOT)
  EXISTS (SELECT 1 FROM user_platform_roles WHERE user_id = auth.uid() AND role = 'super_admin')
  OR tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
)
WITH CHECK (
  -- ì •ë³¸: DB ê¸°ë°˜ ê¶Œí•œ ê²€ì¦ (SSOT)
  EXISTS (SELECT 1 FROM user_platform_roles WHERE user_id = auth.uid() AND role = 'super_admin')
  OR tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
);
```

**ì°¸ê³ :** ìƒì„¸ ì„¤ëª…ê³¼ ë³€í˜•(ì˜µì…˜2: ì„¸ì…˜ ë³€ìˆ˜ ê¸°ë°˜)ì€ ì „ì²´ ê¸°ìˆ ë¬¸ì„œ 3-2-2 ì°¸ê³ 

**âš ï¸ 2-1: RLSì—ì„œ role ì‚¬ìš© ë°©ì‹ ëª…ì‹œ ê°•í™”:**

âš ï¸ ì¤‘ìš”: í”Œë«í¼ ê¶Œí•œ(super_admin/developer)ì€ DB ê¸°ë°˜(user_platform_roles)ì„ ë‹¨ì¼ ì§„ì‹¤ ì›ì²œ(SSOT)ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
JWT role claim(`auth.jwt()->>'role'`)ì€ ë³´ì•ˆ íŒë‹¨ì— ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°, í‘œì‹œ/UX íŒíŠ¸ ìˆ˜ì¤€ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê±°ë‚˜ ì™„ì „ ì œê±°í•©ë‹ˆë‹¤.

(ì •í™•í•œ ë§¤í•‘ ë¡œì§ì€ T18 ì°¸ì¡°)

**Zero-Trust ì›ì¹™:**

- Edge Function ë‚´ë¶€ì—ì„œ tenant_idë¥¼ ì ˆëŒ€ UIì—ì„œ ë°›ì•„ì˜¤ë©´ ì•ˆ ë¨
- insert ì‹œ tenant_idëŠ” ì„œë²„ê°€ JWTì—ì„œ ì¶”ì¶œí•˜ì—¬ ì‚½ì…
- UIëŠ” tenant_idë¥¼ ì§ì ‘ ì „ë‹¬í•˜ì§€ ì•ŠìŒ
- ëª¨ë“  ë°ì´í„° ì ‘ê·¼ì€ RLS ì •ì±…ì„ í†µí•´ì„œë§Œ ê°€ëŠ¥

**ë³´ì•ˆ ê°ì‚¬ ì¤€ìˆ˜:**

- ëª¨ë“  í…Œì´ë¸”ì— RLS ì •ì±… í•„ìˆ˜ ì ìš©
- RLS ì •ì±… ì—†ì´ëŠ” ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€
- ì •ì±… ë³€ê²½ ì´ë ¥ ì¶”ì  ë° ë¡œê·¸ ë³´ê´€

**RBAC ì—…ì¢…ë³„ ë¶„ë¦¬:**

- ì—­í• (Role)ì€ ì—…ì¢…ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ì •ì˜
- core-uiì™€ industry-uiì˜ ì—­í•  êµ¬ë¶„ ëª…í™•í™”
- ì—…ì¢… ê°„ ê¶Œí•œ ê²©ë¦¬ ë³´ì¥

**âš ï¸ RLS ì •ì±… ì„¸ë¶€ ê·œì•½:**

RLS ì •ì±… ì´ë¦„ ê·œì¹™ê³¼ ì„¸ë¶€ ë³€í˜•(ì˜µì…˜2: ì„¸ì…˜ ë³€ìˆ˜ ê¸°ë°˜ ë“±)ì€ ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 18(T18) ë° rules.md 7ì¥(R7.x)ì„ ì •ë³¸ìœ¼ë¡œ ë”°ë¥¸ë‹¤.

### 1.4 Zero-Trust Security Model

**Zero-Trust ì›ì¹™:**

- Edge Function ë‚´ë¶€ì—ì„œ tenant_idë¥¼ ì ˆëŒ€ UIì—ì„œ ë°›ì•„ì˜¤ë©´ ì•ˆ ë¨
- insert ì‹œ tenant_idëŠ” ì„œë²„ê°€ JWTì—ì„œ ì¶”ì¶œí•˜ì—¬ ì‚½ì…
- UIëŠ” tenant_idë¥¼ ì§ì ‘ ì „ë‹¬í•˜ì§€ ì•ŠìŒ
- ëª¨ë“  ë°ì´í„° ì ‘ê·¼ì€ RLS ì •ì±…ì„ í†µí•´ì„œë§Œ ê°€ëŠ¥

**AI íŒë‹¨ íˆìŠ¤í† ë¦¬ ë¡œê·¸:**

- AIê°€ ì œê³µí•œ ì¶”ì²œê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì„œë²„ê°€ ì‹¤í–‰í•œ ëª¨ë“  ì˜ì‚¬ê²°ì •ì€ ë‹¤ìŒì„ ë¡œê·¸ë¡œ ë³´ê´€:
  - ì‹œê°„
  - ì…ë ¥ ë°ì´í„°
  - íŒë‹¨ ê·¼ê±°
  - ì‹¤í–‰ ê²°ê³¼
  - ì‚¬ìš©ì ë³´ì • ì—¬ë¶€
- Zero-Trust UI ê·œì¹™ê³¼ ë§ë¬¼ë ¤ ëª¨ë“  AI í–‰ë™ ì¶”ì  ê°€ëŠ¥

### 1.5 Event-Driven Architecture(EA) ê°œìš”

ë””ì–´ìŒ¤ì˜ ëª¨ë“  ìë™í™”ëŠ” ì•„ë˜ 4ê°€ì§€ Event Sourceì— ì˜í•´ ì‹¤í–‰ëœë‹¤:

**Time-based Events (ì‹œê°„ ê¸°ë°˜ ë°°ì¹˜)**
- 04:00 ì„œë²„ê°€ ì²­êµ¬ ìƒì„±
- ì›”ë§ ì„œë²„ê°€ ë¦¬í¬íŠ¸ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)
- ë§¤ì¼ ì•„ì¹¨ ì„œë²„ê°€ AI ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ ìƒì„± (07:00, AI í˜¸ì¶œ í¬í•¨)

**Behavior-based Events (ì‚¬ìš©ì í–‰ë™ ê¸°ë°˜)**
- í•™ìƒ ë“±ì›/í•˜ì› ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì„œë²„ê°€ ì¶œê²° ë©”ì‹œì§€ ë°œì†¡
- ìƒë‹´ì¼ì§€ ì €ì¥ ì‹œ ì„œë²„ê°€ AI ìš”ì•½ ìƒì„±
- ê²°ì œ ì™„ë£Œ ì‹œ ì„œë²„ê°€ ì˜ìˆ˜ì¦ ë°œì†¡

**Pattern-based Events (AI ê°ì§€ ê¸°ë°˜)**
- ê²°ì„ íŒ¨í„´ ì´ìƒ íƒì§€
- ë°˜ë³„ ì¶œì„ë¥  ì €í•˜ ê°ì§€
- í•™ìŠµÂ·ì„±ì  ê¸°ë°˜ ì´íƒˆ ìœ„í—˜ ê°ì§€
- ì¶œê²° íŒ¨í„´ ë³€í™” ê°ì§€

**External Events (ì™¸ë¶€ ì‹œìŠ¤í…œ + ì„¼ì„œ)**
- QR ìŠ¤ìº”
- íƒœë¸”ë¦¿/í‚¤ì˜¤ìŠ¤í¬ ê°ì§€
- ê²°ì œ Webhook (ì•Œë¦¼ë±…í¬)
- ë‚ ì”¨ API ë³€í™” ê°ì§€ (í­ìš° â†’ ì•ˆë‚´ ë¬¸êµ¬ ì œì•ˆ)

### 1.6 SDUI(Schema-Driven UI) ê¸°ë°˜ í™”ë©´ ìë™ ìƒì„±

SDUI(Schema-Driven UI)ëŠ” ë””ì–´ìŒ¤ì˜ í•µì‹¬ ê¸°ìˆ ë¡œ, í™”ë©´ ìë™ ìƒì„± ë° ì—…ì¢… ê°„ ì¬ì‚¬ìš©ì„ ë‹´ë‹¹í•œë‹¤.

**ë„ë©”ì¸ë³„ SDUI ì ìš© ë²”ìœ„:**

| ë„ë©”ì¸ | SDUI ê¸°ë°˜ ì—¬ë¶€ | ì»¤ìŠ¤í…€ í•„ìš” ì—¬ë¶€ | ë¹„ê³  |
|--------|---------------|-----------------|------|
| í•™ìƒ ë“±ë¡/ìˆ˜ì • Form | 100% SDUI | ì—†ìŒ | Form Schemaë¡œ ì™„ì „ ìë™ ìƒì„± |
| ìƒë‹´ì¼ì§€ ì‘ì„± | 70% SDUI (Form) | ìš”ì•½ ê²°ê³¼ UIë§Œ Custom | Formì€ SDUI, AI ìš”ì•½ ê²°ê³¼ëŠ” Custom Widget |
| ë°˜ ìƒì„± Form | 100% SDUI | ì—†ìŒ | Form Schemaë¡œ ì™„ì „ ìë™ ìƒì„± |
| ì¶œê²° í™”ë©´ | SDUI ì‚¬ìš© âŒ | ì™„ì „ ì»¤ìŠ¤í…€ | ì‹¤ì‹œê°„ì„± ë° íŠ¹ìˆ˜ UX ìš”êµ¬ë¡œ ì§ì ‘ êµ¬í˜„ |
| ìˆ˜ë‚©/ì²­êµ¬ ìƒì„¸ | 50% SDUI (Table/Detail) | ê²°ì œ íŒ¨ë„ Custom | Table/Detailì€ SDUI, ê²°ì œ ì—°ë™ì€ Custom Widget |
| ì§€ì—­í†µê³„ | SDUI ì‚¬ìš© âŒ | ì „ìš© Dashboard | ë³µì¡í•œ ì°¨íŠ¸/íˆíŠ¸ë§µìœ¼ë¡œ ì „ìš© êµ¬í˜„ |
| AI ì¸ì‚¬ì´íŠ¸ | 30% SDUI (Card/Widget) | ë¶„ì„ ê²°ê³¼ Custom | ì¹´ë“œ ë ˆì´ì•„ì›ƒì€ SDUI, AI ê²°ê³¼ëŠ” Custom |

**SDUI ì ìš© ì›ì¹™:**

- Form/Table/Detail/FilterëŠ” ê°€ëŠ¥í•œ í•œ SDUIë¡œ ìƒì„±
- ì‹¤ì‹œê°„ì„±/íŠ¹ìˆ˜ UXê°€ í•„ìš”í•œ í™”ë©´ì€ Custom êµ¬í˜„
- Custom Widgetì€ SDUI ë‚´ì—ì„œ ë™ì  ë¡œë”© ê°€ëŠ¥

### 1.7 AI-First Workflow ì •ì˜

ì‚¬ìš©ìê°€ ë¬´ì—‡ì„ í•´ì•¼ í• ì§€ ê³ ë¯¼í•˜ê¸° ì „ì— ì„œë²„ê°€ ë¨¼ì € ë¶„ì„Â·ì œì•ˆÂ·ìš”ì•½í•œë‹¤ (AI í˜¸ì¶œ í¬í•¨).

**ì˜ˆ:**
- "ì˜¤ëŠ˜ ê²°ì„ìƒ 3ëª… ì¤‘ 2ëª…ì€ ìµœê·¼ 1ì£¼ê°„ ìƒíƒœê°€ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤. ì—°ë½ì„ ì¶”ì²œí•©ë‹ˆë‹¤."
- "ì´ë²ˆ ì£¼ ìˆ˜ì—… ì¤‘ ìˆ˜í•™Aë°˜ ì¶œê²°ë¥ ì´ ì§€ì—­ í‰ê·  ëŒ€ë¹„ 12% ë‚®ìŠµë‹ˆë‹¤. ì›ì¸ì„ ë¶„ì„í• ê¹Œìš”?"
- "ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œê°€ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆìƒ ìˆ˜ë‚©ë¥ ì€ 92%ì…ë‹ˆë‹¤."

**AI Action Level ì •ì˜ (3ë‹¨ê³„):**

**Level 1 â€” AI Insight Only (í•´ì„ë§Œ ì œê³µ)**
- ì‚¬ìš©ìê°€ íŒë‹¨í•  ìˆ˜ ìˆë„ë¡ ì„¤ëª…Â·ìš”ì•½Â·ë¶„ì„ì„ ì œê³µ
- ì˜ˆ: "ì§€ì—­ ëŒ€ë¹„ ì¶œì„ë¥  +4% ìƒìŠ¹"

**Level 2 â€” TaskCard (task_type: 'ai_suggested', entity_type='student') (ì¶”ì²œ + ì´ˆì•ˆ ì œê³µ)** (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

**âš ï¸ v3.3 ì •ë³¸: "AI Suggestion"ì€ ë…ë¦½ ê°œë…ì´ ì•„ë‹™ë‹ˆë‹¤.**
- TaskCard (task_type: 'ai_suggested', entity_type='student')ë¡œ í†µí•©ë¨ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- ì„œë²„/Edge Functionì—ì„œ ìƒì„±
- í”„ë¡ íŠ¸ì—”ë“œëŠ” ìŠ¹ì¸ ìš”ì²­ë§Œ ì²˜ë¦¬
- í–‰ë™ì€ ì‚¬ìš©ìê°€ ê²°ì •
- ì˜ˆ:
  - "ì•ˆë¶€ ë¬¸ì ì´ˆì•ˆ ì¤€ë¹„ë¨ â†’ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
  - "ì´ë²ˆ ë°˜ ì¶œì„ë¥  ì €ì¡° â†’ ì›ì¸ì„ ë¶„ì„í• ê¹Œìš”?"

**Level 3 â€” AI Auto-Action (ì„œë²„ê°€ ì •ì±… í•´ì„ í›„ ì‹¤í–‰)**

**âš ï¸ ì‹¤í–‰ ì£¼ì²´ ëª…ì‹œ:**
- AI/Rule Engine: íŒë‹¨ (ì„œë²„)
- Edge Function: ì‹¤í–‰ (ì„œë²„)
- í”„ë¡ íŠ¸ì—”ë“œ: ìŠ¹ì¸ ìš”ì²­ë§Œ (UIëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ)
- ì‚¬ìš©ì ê°œì… ì—†ì´ ì‹œìŠ¤í…œ ìì²´ ì‹¤í–‰
- ì˜ˆ:
  - ì„œë²„ê°€ ì²­êµ¬ ìƒì„± ë° ë°œì†¡
  - ìë™ ë¯¸ë‚© ì•Œë¦¼
  - ìë™ ê²°ì œ ì¬ì‹œë„

### 1.8 ë°˜ì‘í˜•Â·ê¸°ê¸°ë³„ ì ì‘í˜• UI ì•„í‚¤í…ì²˜(Adaptive UI)

UIëŠ” ë™ì¼í•˜ê²Œ ê³ ì •ëœ í˜•íƒœê°€ ì•„ë‹ˆë¼, ì‚¬ìš©ìì˜ ì—­í•  / ì‹œê°„ëŒ€ / ìƒí™© / ì—…ë¬´ íë¦„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë³€í•œë‹¤.

**ì˜ˆ:**
- ìˆ˜ì—… ì‹œì‘ 10ë¶„ ì „ â†’ ì¶œì„ë¶€ ë°”ë¡œê°€ê¸° ë°°ë„ˆ í‘œì‹œ (í´ë¦­ ì‹œ ì§„ì…)
- ìˆ˜ì—… ì¢…ë£Œ í›„ â†’ ìƒë‹´ì¼ì§€ ì‘ì„± í™”ë©´ì„ ìë™ ì¶”ì²œ
- ì›”ë§ â†’ ì²­êµ¬ ìš”ì•½ ì¹´ë“œ ìš°ì„ ìˆœìœ„ ê°€ì¤‘ì¹˜ ì¦ê°€ (ê°•ì¡° í‘œì‹œ, ê·¸ë£¹ ìˆœì„œëŠ” ë¶ˆë³€)
- ë¹„ê°€ ë§ì´ ì˜¤ëŠ” ë‚  â†’ **ì„œë²„ê°€** í•˜ì› ì•ˆì „ ì•ˆë‚´ë¬¸ TaskCard **ìƒì„±** (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

**âš ï¸ C1: ë°˜ì‘í˜• ê·œì¹™(PC/Tablet/Mobile) êµ¬ì²´í™”:**

**ê¸°ê¸°ë³„ ê·œì¹™ (Figma-Level êµ¬ì²´í™”):**

**PC (> 1024px)**
- ê´€ë¦¬/ì •ì‚°/í†µê³„ ë“±ì˜ ë³µì¡í•œ ê¸°ëŠ¥ ì œê³µ
- ë°ì´í„° ë°€ë„ê°€ ë†’ì€ ëŒ€ì‹œë³´ë“œ
- ìƒì„¸ ë¶„ì„ê³¼ í¸ì§‘ ì‘ì—… ì¤‘ì‹¬
- **ë ˆì´ì•„ì›ƒ ê·œì¹™:**
  - í•™ìƒ ë¦¬ìŠ¤íŠ¸: í…Œì´ë¸” í˜•íƒœ (ì»¬ëŸ¼: ì´ë¦„, í•™ë…„, ë°˜, ìƒíƒœ, ì—°ë½ì²˜, ì•¡ì…˜)
  - ë°˜ ê·¸ë¦¬ë“œ: 4ì—´ ê·¸ë¦¬ë“œ í˜•íƒœ (ë°˜ ì¹´ë“œ 4ê°œì”© í‘œì‹œ)
  - í™•ì¥ íŒ¨ë„: ì‚¬ì´ë“œë°” ë˜ëŠ” í•˜ë‹¨ íŒ¨ë„ë¡œ ìƒì„¸ ì •ë³´ í‘œì‹œ
  - ëŒ€ì‹œë³´ë“œ: 2-3ì—´ ê·¸ë¦¬ë“œ (ì¹´ë“œí˜• ë ˆì´ì•„ì›ƒ)

**Tablet (768px ~ 1024px, íŠ¹íˆ í•™ì› íƒœë¸”ë¦¿)**
- ì¶œê²° ëª¨ë“œê°€ ê¸°ë³¸ (íƒœë¸”ë¦¿ ê¸°ë³¸ í™”ë©´ ì„¤ì •)
- QR ì½”ë“œ í‘œì‹œ ë˜ëŠ” í•™ìƒ ê°ì§€ ê¸°ëŠ¥
- ìƒë‹´/í•™ìƒê´€ë¦¬ í™”ë©´ì€ ìµœì†Œí™”
- í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ(í° ë²ˆí˜¸ íŒ¨ë“œ + ë“±ì›/í•˜ì› ë²„íŠ¼)
- **ë ˆì´ì•„ì›ƒ ê·œì¹™:**
  - í•™ìƒ ë¦¬ìŠ¤íŠ¸: ì¹´ë“œ í˜•íƒœ (2ì—´ ê·¸ë¦¬ë“œ, ì¹´ë“œë‹¹ í•™ìƒ ì •ë³´ ìš”ì•½)
  - ë°˜ ê·¸ë¦¬ë“œ: 2ì—´ ê·¸ë¦¬ë“œ í˜•íƒœ (ë°˜ ì¹´ë“œ 2ê°œì”© í‘œì‹œ)
  - ì¶œê²° í™”ë©´: í° í„°ì¹˜ ë²„íŠ¼ ì¤‘ì‹¬ (ë“±ì›/í•˜ì› ë²„íŠ¼ ìµœì†Œ 80px Ã— 80px)
  - í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ: ì „ì²´ í™”ë©´, í° í°íŠ¸ (ìµœì†Œ 24px), ìµœì†Œ í„°ì¹˜ ì˜ì—­ 44px Ã— 44px

**Mobile (< 768px, ì„ ìƒë‹˜Â·í•™ë¶€ëª¨)**
- ìƒí™© ê¸°ë°˜ ì¶”ì²œ ë°°ë„ˆ/ìš°ì„ ìˆœìœ„ ì¡°ì • (í´ë¦­ í•„ìš”):
  - ìˆ˜ì—… ì‹œì‘ â†’ ì¶œì„ë¶€ ë°”ë¡œê°€ê¸° ë°°ë„ˆ í‘œì‹œ (í´ë¦­ ì‹œ ì§„ì…)
  - ìˆ˜ì—… ì¢…ë£Œ â†’ ìƒë‹´ì¼ì§€ ì‘ì„± TaskCard ìƒì„± (ì„œë²„, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
  - ë“±ì› ë°œìƒ â†’ ì¶œê²° íˆìŠ¤í† ë¦¬ ìë™ ê°±ì‹  (ì„œë²„)
- ë©”ë‰´ë³´ë‹¤ "ì˜¤ëŠ˜ í•´ì•¼ í•  ì¼"ì´ ìµœìƒë‹¨
- **ë ˆì´ì•„ì›ƒ ê·œì¹™:**
  - í•™ìƒ ë¦¬ìŠ¤íŠ¸: ì¹´ë“œ í˜•íƒœ (1ì—´, ì„¸ë¡œ ìŠ¤í¬ë¡¤, ì¹´ë“œë‹¹ í•™ìƒ ì •ë³´ ìš”ì•½)
  - ë°˜ ê·¸ë¦¬ë“œ: 1ì—´ ë¦¬ìŠ¤íŠ¸ í˜•íƒœ (ë°˜ ì¹´ë“œ ì„¸ë¡œ ë‚˜ì—´)
  - ì¶œê²° í™”ë©´: ìŠ¤ì™€ì´í”„ ê°€ëŠ¥í•œ ì¹´ë“œ í˜•íƒœ (í•™ìƒë‹¹ 1ì¹´ë“œ, ì¢Œìš° ìŠ¤ì™€ì´í”„ë¡œ ë‹¤ìŒ í•™ìƒ)
  - í™ˆ í™”ë©´: ì¹´ë“œ ê·¸ë¦¬ë“œ í˜•íƒœ (ëª¨ë“  ì¹´ë“œ ì¶œë ¥, 4ì—´ ë ˆì´ì•„ì›ƒ, ì„¸ë¡œ ìŠ¤í¬ë¡¤)

**ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ë°˜ì‘í˜• ì „í™˜ ì¡°ê±´ (ë ˆì´ì•„ì›ƒ ì „í™˜):**

viewport width ê¸°ì¤€:
- ëª¨ë°”ì¼: < 768px
- íƒœë¸”ë¦¿: 768px ~ 1024px
- ë°ìŠ¤í¬í†±: > 1024px

user agent ê¸°ì¤€:
- íƒœë¸”ë¦¿ ë””ë°”ì´ìŠ¤ ê°ì§€ ì‹œ í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ ì˜µì…˜ ì œê³µ
- íŠ¹ì • íƒœë¸”ë¦¿ ëª¨ë¸ì€ ìë™ í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ í™œì„±í™”

## 2. ì‚¬ìš©ì/ê¶Œí•œ êµ¬ì¡° (RBAC Architecture)

### 2.1 ì‚¬ìš©ì ìœ í˜•(Role) ì •ì˜

**ì—­í• ë³„ ê¶Œí•œ ìš”ì•½**

| ì—­í•  | ê¶Œí•œ ìš”ì•½ |
|------|----------|
| ì›ì¥(Admin) | ëª¨ë“  ê¸°ëŠ¥ ì ‘ê·¼, ê²°ì œ/ìˆ˜ë‚©/ì •ì‚°, ì„¤ì • |
| ì‹¤ì¥(Sub Admin) | í•™ìƒ/ë°˜/ì¶œê²°/ìˆ˜ë‚© ì¼ë¶€ ì ‘ê·¼ |
| ì„ ìƒë‹˜(Teacher) | ì¶œê²°, í•™ìƒ ì¡°íšŒ, ìƒë‹´ì¼ì§€ |
| ë³´ì¡°ì„ ìƒë‹˜(Assistant) | ì¶œê²° ì…ë ¥ |
| ìƒë‹´ì§ì›(Counselor) | ìƒë‹´ ê¸°ë¡, ë“±ë¡ ì²˜ë¦¬ |
| í•™ë¶€ëª¨(Parent) | ë“±Â·í•˜ì› ì•Œë¦¼, ê³µì§€ ì¡°íšŒ, ìˆ˜ë‚© ë‚´ì—­ |

### 2.2 ì—­í• ë³„ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤

**Automation Permission Matrix (ìë™í™” ê¶Œí•œ í–‰ë ¬)**

ìë™ ê¸°ëŠ¥ì€ ê¶Œí•œì— ë”°ë¼ ì‹¤í–‰ ë²”ìœ„ê°€ ì œí•œëœë‹¤.

| ìë™ ê¸°ëŠ¥ | Admin | Sub Admin | Teacher | Assistant | Parent |
|----------|-------|-----------|---------|-----------|--------|
| ìë™ ì²­êµ¬ ìƒì„± | ì‹¤í–‰ + ë³´ê¸° | ë³´ê¸° | X | X | X |
| ë¯¸ë‚© ìë™ ì•Œë¦¼ | ì‹¤í–‰ + ë³´ê¸° | ë³´ê¸° | X | X | ìˆ˜ì‹  |
| ì¶œê²° ìë™ ê°ì§€ | ë³´ê¸° | ë³´ê¸° | ë³´ê¸° | ë³´ê¸° | ìˆ˜ì‹  |
| AI ë¦¬í¬íŠ¸ ìƒì„± | ë³´ê¸° | ë³´ê¸° | ìš”ì•½ë§Œ | X | X |
| ì„œë²„ê°€ ìƒë‹´ AI ìš”ì•½ ìƒì„± | ì‹¤í–‰ | ì‹¤í–‰ | ìš”ì²­ë§Œ (ì‹¤í–‰ X) | X | X |

**ì¤‘ìš” ì›ì¹™:**

- ìë™ ë©”ì‹œì§€ ë°œì†¡, ìë™ ìˆ˜ë‚© ì•Œë¦¼, ìë™ ì²­êµ¬ ë“±ì€ ì›ì¥(Admin) ê¶Œí•œ ë²”ìœ„
- ì„ ìƒë‹˜/ë³´ì¡°êµì‚¬ì—ê²ŒëŠ” ìë™í™”ê°€ í‘œì‹œë˜ê¸°ë§Œ í•˜ê³  ì‹¤í–‰ ê¶Œí•œì„ ê°€ì§€ë©´ ì•ˆ ë¨
- ìƒë‹´ì§ì›, ì‹¤ì¥ ë“± ì¤‘ê°„ ê¶Œí•œì—ê²Œ ì–´ë–¤ ìë™í™”ê°€ ì ìš©ë˜ëŠ”ì§€ ëª…í™•íˆ ì •ì˜

**AI Override ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤:**

| AI ê¸°ëŠ¥ | Admin | Sub Admin | Teacher | Assistant |
|---------|-------|-----------|---------|-----------|
| Insight Override | ê°€ëŠ¥ | ê°€ëŠ¥ | ì œí•œì  | ë¶ˆê°€ |
| Suggestion Override | ê°€ëŠ¥ | ê°€ëŠ¥ | ê°€ëŠ¥ | ë¶ˆê°€ |
| Auto-Action Undo | ê°€ëŠ¥ | ì œí•œì  | ë¶ˆê°€ | ë¶ˆê°€ |
| ë¯¸ë‚© ê´€ë ¨ AI Override | ê°€ëŠ¥ | ë¶ˆê°€ | ë¶ˆê°€ | ë¶ˆê°€ |

### 2.3 ë©”ë‰´ ì ‘ê·¼ ì œì–´ ê·œì¹™

**ì—­í• ë³„ UI ë‹¨ìˆœí™” ì›ì¹™**

ê° ì—­í• ë³„ UIëŠ” ë³µì¡í•œ ë©”ë‰´ë¥¼ ëª¨ë‘ ìˆ¨ê¸°ë©°, ì—­í• ë³„ë¡œ í•„ìš”í•œ í•µì‹¬ ê¸°ëŠ¥ë§Œ ë…¸ì¶œí•œë‹¤.

âš ï¸ **AI í† ê¸€ ì •ì±… ìš°ì„ ìˆœìœ„ ê·œì¹™:**
- AI ê´€ë ¨ ë©”ë‰´/ì„¹ì…˜ì€ ì—­í• ë³„ ìˆ¨ê¹€ ê·œì¹™ê³¼ ë¬´ê´€í•˜ê²Œ í•­ìƒ í‘œì‹œë©ë‹ˆë‹¤ (ìˆ¨ê¹€ ê¸ˆì§€).
- ì—­í• ë³„ UI ìˆ¨ê¹€ ê·œì¹™ì€ AI í† ê¸€ ì •ì±…ë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë‚®ìŠµë‹ˆë‹¤.
- AI ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”(`effective_ai_enabled=false`)ë˜ì–´ë„ UIëŠ” ìˆ¨ê¸°ì§€ ì•Šê³ , ì‹¤í–‰ë§Œ ì°¨ë‹¨í•©ë‹ˆë‹¤.

**ë³´ì¡°ì„ ìƒë‹˜(Assistant):**
- ì¶œê²° ë²„íŠ¼ë§Œ ë…¸ì¶œ
- í•™ìƒ ê²€ìƒ‰ ë° ì¶œê²° ì²´í¬ë§Œ ê°€ëŠ¥
- **ì¶œê²° ìˆ˜ì • ê¶Œí•œ ì—†ìŒ**: ì¶œê²° ê¸°ë¡ ìƒì„±ë§Œ ê°€ëŠ¥í•˜ë©° ìˆ˜ì • ê¶Œí•œì€ ì—†ë‹¤

**ì„ ìƒë‹˜(Teacher):**
- ì˜¤ëŠ˜ì˜ ë°˜ + í•™ìƒ ë¦¬ìŠ¤íŠ¸ + ì¶œê²° ì²´í¬ë§Œ ë…¸ì¶œ
- ìƒë‹´ì¼ì§€ ì‘ì„± ê¸°ëŠ¥ í¬í•¨
- í†µê³„/AI ìš”ì•½ ì¹´ë“œëŠ” ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥
- ê³ ê¸‰ ì„¤ì • ë©”ë‰´ ìˆ¨ê¹€
- **ì¶œê²° ìˆ˜ì • ê¶Œí•œ ìˆìŒ**: ì¶œê²° ì…ë ¥ ë° ìˆ˜ì • ëª¨ë‘ ê°€ëŠ¥

**ì¶œê²° ìˆ˜ì • ê¶Œí•œ ëª…ì‹œ:**

ì¶œê²°ë²„ìŠ¤ ê¸°ë°˜ ê¶Œí•œ ê·œì¹™:

| ì—­í•  | ì¶œê²° ì…ë ¥ | ì¶œê²° ìˆ˜ì • |
|------|----------|----------|
| Teacher | âœ… ê°€ëŠ¥ | âœ… ê°€ëŠ¥ |
| Assistant | âœ… ê°€ëŠ¥ | âŒ ë¶ˆê°€ |

**Assistant ì¶œê²° ìˆ˜ì • ì œí•œ:**
- AssistantëŠ” ì¶œê²° ê¸°ë¡ ìƒì„±ë§Œ ê°€ëŠ¥
- ê¸°ì¡´ ì¶œê²° ê¸°ë¡ ìˆ˜ì • ê¶Œí•œ ì—†ìŒ
- ì¶œê²° ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° Teacher ë˜ëŠ” Adminì—ê²Œ ìš”ì²­
- ì¶œê²° ìˆ˜ì • ì‹œë„ ì‹œ ê¶Œí•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ

**ì›ì¥(Admin):**
- ì „ì²´ ë©”ë‰´ ë…¸ì¶œ
- ê³ ê¸‰ ê¸°ëŠ¥ ì ‘ê·¼ ê°€ëŠ¥
- ì„¤ì • ë° ì •ì‚° ê¸°ëŠ¥ í¬í•¨

### 2.4 í˜ì´ì§€/ë¼ìš°íŒ… ì ‘ê·¼ ì œì–´ (Frontend RBAC)

**ê¶Œí•œë³„ ë¼ìš°íŒ… ê·œì¹™**

ê¶Œí•œì— ë”°ë¼ URL ì ‘ê·¼ì„ ì œí•œí•˜ëŠ” ë¼ìš°íŒ… ê·œì¹™:

**Admin â†’ ì „ì²´ ì ‘ê·¼ ê°€ëŠ¥**
- ëª¨ë“  URL ì ‘ê·¼ ê°€ëŠ¥
- /billing/**, /classes/**, /analytics/** ë“± ì „ì²´

**Sub Admin â†’ billing ì¼ë¶€ ì œí•œ**
- /billing/create, /billing/settings ì ‘ê·¼ ì œí•œ
- /billing/view, /billing/history ì ‘ê·¼ ê°€ëŠ¥
- /classes/**, /students/** ì ‘ê·¼ ê°€ëŠ¥
- /analytics/** ì ‘ê·¼ ê°€ëŠ¥

**Teacher â†’ ì¶œê²°/í•™ìƒ/AI ìš”ì•½ë§Œ**
- /attendance/** ì ‘ê·¼ ê°€ëŠ¥
- /students/view ì ‘ê·¼ ê°€ëŠ¥ (ìˆ˜ì • ì œí•œ)
- /ai/insights/summary ì ‘ê·¼ ê°€ëŠ¥ (ìƒì„¸ ë¶„ì„ ì œí•œ)
- /billing/** ì ‘ê·¼ ê¸ˆì§€
- /classes/schedule ì ‘ê·¼ ê°€ëŠ¥
- /analytics/region ì ‘ê·¼ ê¸ˆì§€ (ìš”ì•½ë§Œ ì œê³µ)

**Assistant â†’ ì¶œê²°ë§Œ**
- /attendance/** ì ‘ê·¼ ê°€ëŠ¥
- /students/view ì ‘ê·¼ ê°€ëŠ¥ (ì½ê¸° ì „ìš©)
- /billing/** ì ‘ê·¼ ê¸ˆì§€
- /classes/** ì ‘ê·¼ ê¸ˆì§€
- /analytics/** ì ‘ê·¼ ê¸ˆì§€

**Parent â†’ public-gateway API only**
- /public-gateway/payment/** ì ‘ê·¼ ê°€ëŠ¥
- /public-gateway/attendance/notifications ì ‘ê·¼ ê°€ëŠ¥
- /public-gateway/billing/history ì ‘ê·¼ ê°€ëŠ¥
- Admin ì•±ì˜ ëª¨ë“  URL ì ‘ê·¼ ê¸ˆì§€

**ë¼ìš°íŒ… ê·œì¹™ ì ìš©:**

- í”„ë¡ íŠ¸ì—”ë“œ ë¼ìš°í„°ì—ì„œ ê¶Œí•œ ì²´í¬ í›„ ì ‘ê·¼ ì œí•œ
- ë°±ì—”ë“œ RLS ì •ì±…ê³¼ ì¼ì¹˜í•˜ë„ë¡ ì„¤ê³„
- ê¶Œí•œ ì—†ëŠ” URL ì ‘ê·¼ ì‹œ 403 Forbidden ë°˜í™˜
- ê¶Œí•œ ë¶€ì¡± ì‹œ ìë™ìœ¼ë¡œ í—ˆìš©ëœ ë©”ë‰´ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

**ë¼ìš°íŒ… ì¶©ëŒ ë°©ì§€:**

- í”„ë¡ íŠ¸ì—”ë“œ ë¼ìš°í„°ì™€ ë°±ì—”ë“œ RLSê°€ ë™ì¼í•œ ê¶Œí•œ ê·œì¹™ ì‚¬ìš©
- ê¶Œí•œ ë³€ê²½ ì‹œ ë¼ìš°í„°ì™€ RLS ì •ì±… ë™ì‹œ ì—…ë°ì´íŠ¸
- ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì‹œ í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ ëª¨ë‘ ê²€ì¦

**ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ê¸°ë³¸ ë¼ìš°íŒ… ê·œì¹™:**

ëª¨ë°”ì¼ ë° íƒœë¸”ë¦¿ì—ì„œëŠ” ì—­í• ë³„ë¡œ ê¸°ë³¸ ì§„ì… í™”ë©´ì´ ë‹¤ë¥´ë‹¤:

```typescript
mobile_default_route_role_map = {
  teacher: '/attendance/today',      // ì„ ìƒë‹˜ì€ ì¶œê²° í™”ë©´
  parent: '/public-gateway/home',    // í•™ë¶€ëª¨ëŠ” ê³µê°œ ê²Œì´íŠ¸ì›¨ì´
  assistant: '/attendance/today',   // ë³´ì¡°ì„ ìƒë‹˜ì€ ì¶œê²° í™”ë©´
  admin: '/home',                    // ì›ì¥ì€ í™ˆ ëŒ€ì‹œë³´ë“œ
  sub_admin: '/home'                 // ì‹¤ì¥ì€ í™ˆ ëŒ€ì‹œë³´ë“œ
}
```

**âš ï¸ Role ì´ë¦„ í‘œê¸° í†µì¼:**

- ë¬¸ì„œ ë‚´ í‘œ/ë§¤íŠ¸ë¦­ìŠ¤ì˜ í•œê¸€ ë¼ë²¨: ì›ì¥(Admin), ì‹¤ì¥(Sub Admin), ì„ ìƒë‹˜(Teacher), ë³´ì¡°ì„ ìƒë‹˜(Assistant), í•™ë¶€ëª¨(Parent)
- ì‹¤ì œ ì‹œìŠ¤í…œ role ê°’(enum/ë¬¸ìì—´): ì†Œë¬¸ì snake_case ì‚¬ìš© (`admin`, `sub_admin`, `instructor`, `teacher`, `assistant`, `guardian`, `parent`)  -- instructor/guardianì€ ì •ë³¸ í‚¤, teacher/parentëŠ” backward compatibility

**ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ë¼ìš°íŒ… ì¼ê´€ì„± ê·œì¹™:**
- ëª¨ë°”ì¼ ì ‘ì† ì‹œ ì—­í• ë³„ ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
- íƒœë¸”ë¦¿ ì ‘ì† ì‹œ í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ í™œì„±í™” ì‹œ `/attendance/today`ë¡œ ê³ ì •
- ì—­í•  ë³€ê²½ ì‹œ ê¸°ë³¸ ë¼ìš°íŠ¸ë„ ìë™ ì—…ë°ì´íŠ¸

### 2.5 Supabase RLS ì •ì±… êµ¬ì¡°

(ë³¸ ë¬¸ì„œ 1.3 ì„¹ì…˜ ì°¸ì¡°)

### 2.6 Multi-Industry RBAC í™•ì¥

**Industry Layer ë°ì´í„° í•„ë“œ í…œí”Œë¦¿ ê·œì¹™**

ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ì°¨ë³„í™”ë¥¼ ìœ„í•œ ê·œì¹™:

**Core Entity í™•ì¥ ê·œì¹™:**

- Core Platformì˜ ê³µí†µ ì—”í‹°í‹°(persons, parties ë“±)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™•ì¥
- ì—…ì¢…ë³„ í•„ë“œëŠ” industry_* ì ‘ë‘ì‚¬ ì‚¬ìš©
- ì˜ˆ:
  - academy_student { grade, subject_group, parents }
  - salon_customer { last_visit_at, preferred_style }
  - real_estate_tenant { contract_end_date, rent_cycle }

**ì—…ì¢…ë³„ í•„ë“œ ì¶”ê°€ ê·œì¹™:**

- Schema Registryì— industry_typeë³„ í•„ë“œ ì •ì˜
- ì—…ì¢…ë³„ í•„ë“œëŠ” JSONB ë˜ëŠ” ë³„ë„ í…Œì´ë¸”ë¡œ í™•ì¥ ê°€ëŠ¥
- RLS ì •ì±…ì—ì„œ industry_type ê¸°ë°˜ í•„ë“œ ì ‘ê·¼ ì œì–´

**ì—…ì¢…ë³„ ë©”ë‰´ ìˆ¨ê¹€/ë…¸ì¶œ ê·œì¹™:**

- SDUI ìŠ¤í‚¤ë§ˆì—ì„œ industry_type ì¡°ê±´ìœ¼ë¡œ ë©”ë‰´ í‘œì‹œ ì œì–´
- ì˜ˆ: academyëŠ” "ë°˜ ê´€ë¦¬" ë©”ë‰´, salonì€ "ì˜ˆì•½ ê´€ë¦¬" ë©”ë‰´
- Schema Engineì´ industry_typeì— ë”°ë¼ ìë™ í•„í„°ë§

**ì—…ì¢…ë³„ í†µê³„/AI ëª¨ë¸ ë¶„ë¦¬ ê·œì¹™:**

- í†µê³„ ì§‘ê³„ ì‹œ industry_typeë³„ë¡œ ë³„ë„ Materialized View ìƒì„±
- AI ëª¨ë¸ë„ ì—…ì¢…ë³„ë¡œ ë¶„ë¦¬ í•™ìŠµ ë° ì ìš©
- ì—…ì¢… ê°„ ë°ì´í„° í˜¼í•© ë°©ì§€

**ë°ì´í„° í•„ë“œ í…œí”Œë¦¿ ì˜ˆì‹œ:**

**Academy (í•™ì›):**
- student: grade, subject_group, parents, class_id
- class: schedule, capacity, teacher_id
- attendance: check_in_time, check_out_time

**Salon (ë¯¸ìš©ì‹¤):**
- customer: last_visit_at, preferred_style, stylist_id
- appointment: service_type, duration, price
- visit_history: service_date, stylist_feedback

**Real Estate (ë¶€ë™ì‚°):**
- tenant: contract_end_date, rent_cycle, property_id
- property: address, size, rent_amount
- contract: start_date, end_date, deposit

### 2.7 Parent App(í•™ë¶€ëª¨ ì•±) ê¶Œí•œ ëª¨ë¸

**Parent UX (í•™ë¶€ëª¨ ê²½í—˜) ì •ì˜**

í•™ì› ì›ì¥ì€ 1%ì˜ ì‹œê°„ë§Œ ì“°ê³ , í•™ë¶€ëª¨ê°€ 99%ì˜ ê²°ì œë¥¼ ìˆ˜í–‰í•¨.

**í•™ë¶€ëª¨ ì•±ì—ì„œ ìë™ ì²­êµ¬ ì•Œë¦¼ + ìë™ ê²°ì œ ë§í¬ ì œê³µ**
- ì²­êµ¬ì„œ ìƒì„± ì‹œ ì¦‰ì‹œ ì•Œë¦¼ ë°œì†¡
- ì•Œë¦¼ í´ë¦­ ì‹œ ê²°ì œ í™”ë©´ìœ¼ë¡œ ì´ë™ (ì‚¬ìš©ì í´ë¦­ í•„ìš”)

**ê²°ì œ ì„±ê³µ ì‹œ ì˜ìˆ˜ì¦ ìë™ ë°œì†¡**
- ê²°ì œ ì™„ë£Œ ì¦‰ì‹œ ì„œë²„ê°€ ì˜ìˆ˜ì¦ ìƒì„± ë° ë°œì†¡
- SMS/ì•± ë‚´ ì•Œë¦¼ìœ¼ë¡œ ì œê³µ

**ìë™ ê²°ì œ ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì‹œë„ ì¼ì • ì•ˆë‚´**
- ì‹¤íŒ¨ ì›ì¸ ë° ì¬ì‹œë„ ì¼ì • ëª…í™•íˆ ì•ˆë‚´
- ì¶”ê°€ ì¡°ì¹˜ í•„ìš” ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì œê³µ

**ìë…€ë³„ ê²°ì œ ë‚´ì—­ ìë™ ì •ë¦¬**
- ìë…€ë³„ë¡œ ê²°ì œ ë‚´ì—­ ë¶„ë¦¬ í‘œì‹œ
- ê²°ì œ ì´ë ¥ ë° ë¯¸ë‚© í˜„í™© í•œëˆˆì— í™•ì¸

## 3. ë„ë©”ì¸ ìš”êµ¬ì‚¬í•­ (Domain SRS)

### 3.1 í•™ìƒ(Student) ë„ë©”ì¸

#### 3.1.1 í•™ìƒ ê´€ë¦¬ í™ˆ(Home) â€” í•™ìƒ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ

**ë¼ìš°íŒ… ë° í™”ë©´ êµ¬ì¡°**

í•™ìƒ ë©”ë‰´ ì²« ì§„ì… ì‹œ ë¼ìš°íŠ¸ëŠ” `/students/home`ì´ë©°, ê¸°ë³¸ í™”ë©´ì€ í•™ìƒ ê´€ë¦¬ ì „ìš© ëŒ€ì‹œë³´ë“œì´ë‹¤.

ì „ì²´ í•™ìƒ ëª©ë¡ì€ `/students/list`ë¡œ ë¶„ë¦¬ë˜ë©°, í™ˆ í™”ë©´ì—ì„œëŠ” ë³„ë„ì˜ "ì „ì²´ í•™ìƒ ë³´ê¸°" ë²„íŠ¼ìœ¼ë¡œë§Œ ì§„ì… ê°€ëŠ¥í•˜ë‹¤.

**âš ï¸ ì°¸ê³ : Student Task CardsëŠ” `/home` ëŒ€ì‹œë³´ë“œì—ì„œ í‘œì‹œë©ë‹ˆë‹¤.**
- `/students/home`ì€ í•™ìƒ ê´€ë¦¬ ì „ìš© í†µê³„/ì•¡ì…˜/í™œë™ ëŒ€ì‹œë³´ë“œ
- `/home`ì€ ì „ì²´ ì—…ë¬´ ëŒ€ì‹œë³´ë“œ (Student Task Cards í¬í•¨)

**í•™ìƒ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ êµ¬ì„±**

**1. í•™ìƒ í†µê³„ ì¹´ë“œ ì„¹ì…˜**
- **ì „ì²´ í•™ìƒ ìˆ˜**: ì „ì²´/í™œì„±/ë¹„í™œì„±/ì‹ ê·œ ë“±ë¡ í•™ìƒ ìˆ˜
- **ì˜¤ëŠ˜ ì¶œì„ë¥ **: ì¶œì„/ì§€ê°/ê²°ì„/ë¯¸ì²´í¬ í˜„í™©
- **ì˜¤ëŠ˜ ì§€ê°ë¥ **: ì˜¤ëŠ˜ ì§€ê°í•œ í•™ìƒ ë¹„ìœ¨
- **ì˜¤ëŠ˜ ê²°ì„ë¥ **: ì˜¤ëŠ˜ ê²°ì„í•œ í•™ìƒ ë¹„ìœ¨
- **í™œì„± í•™ìƒ ìˆ˜**: status='active'ì¸ í•™ìƒ ìˆ˜
- **ë¹„í™œì„± í•™ìƒ ìˆ˜**: status='inactive'ì¸ í•™ìƒ ìˆ˜
- **ë°˜ë‹¹ í‰ê·  ì¸ì›**: ì „ì²´ í•™ìƒ ìˆ˜ / í™œì„± ë°˜ ìˆ˜
- **í‰ê·  ì •ì›ë¥ **: (í˜„ì¬ ì¸ì› / ì •ì›) Ã— 100
- **ARPU (í•™ìƒ 1ì¸ë‹¹ ë§¤ì¶œ)**: ì´ë²ˆ ë‹¬ ë§¤ì¶œ / ì „ì²´ í•™ìƒ ìˆ˜
- **ì´ë²ˆ ì£¼ í‰ê·  ì¶œì„ë¥ **: ìµœê·¼ 7ì¼ ì¶œì„ë¥  í‰ê· 
- **í•™ìƒ ì•Œë¦¼**: ìœ„í—˜ í•™ìƒ/ê²°ì„ í•™ìƒ/ìƒë‹´ ëŒ€ê¸° ê±´ìˆ˜
- **ìƒë‹´ í†µê³„**: ì´ë²ˆ ë‹¬ ìƒë‹´ ê±´ìˆ˜/ëŒ€ê¸° ì¤‘/ê¸´ê¸‰ ìƒë‹´ ê±´ìˆ˜

**2. ë¹ ë¥¸ ì•¡ì…˜ ì¹´ë“œ**
- í•™ìƒ ë“±ë¡
- ì¼ê´„ ë“±ë¡ (ì—‘ì…€ ì—…ë¡œë“œ)
- í•™ìƒ ëª©ë¡ ë³´ê¸°
- ìƒë‹´ ê¸°ë¡ ì‘ì„±
- ì¶œê²° ì²´í¬

**3. ìµœê·¼ í™œë™ ì¹´ë“œ**
- ìµœê·¼ ë“±ë¡ëœ í•™ìƒ (ìµœê·¼ 5ëª…)
- ìµœê·¼ ìƒë‹´ ê¸°ë¡ (ìµœê·¼ 5ê±´)
- ìµœê·¼ ì¶œê²° ì´ë²¤íŠ¸ (ìµœê·¼ 5ê±´)
- ìµœê·¼ íƒœê·¸ ì¶”ê°€/ë³€ê²½ (ìµœê·¼ 5ê±´)

ê° ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ê¸°ëŠ¥ í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ë©°, í•™ìƒ ê´€ë¦¬ ëª¨ë“ˆì˜ ì§„ì…ì  ì—­í• ì„ í•œë‹¤.

#### 3.1.2 "ì˜¤ëŠ˜ì˜ í•™ìƒ ì—…ë¬´ ì¹´ë“œ" UI ìŠ¤í™

**Data Model:**

```typescript
TaskCard {
  task_type: 'risk' | 'absence' | 'counseling' | 'new_signup' | 'ai_suggested'
  entity_id: UUID      // ì—…ì¢… ì¤‘ë¦½ ì—”í‹°í‹° ID (ì •ë³¸)
  entity_type: string  // ì—…ì¢… ì¤‘ë¦½ ì—”í‹°í‹° íƒ€ì… (ì •ë³¸, ì˜ˆ: 'student', 'client', 'customer')
  student_id: UUID     // ë ˆê±°ì‹œ í•„ë“œ (í•˜ìœ„ í˜¸í™˜ì„±, entity_type='student'ì¸ ê²½ìš° entity_idì™€ ë™ì¼)
  source?: 'attendance' | 'billing' | 'behavior' | 'weather' | 'proactive_analysis' // TaskCard (task_type: 'ai_suggested') ê·¼ê±°
  priority: number (0-100) // ì •ë³¸: 0-100 ìŠ¤ì¼€ì¼
  title: string
  description: string
  action_url: string
  suggested_action?: jsonb // ì•¡ì…˜ ì •ì˜ (ë©”ì‹œì§€ ì´ˆì•ˆ, ë¶„ì„ ìš”ì²­ ë“±)
  dedup_key?: string // ì¤‘ë³µ ë°©ì§€ í‚¤: "{tenantId}:{trigger}:{entityType}:{entityId}:{window}"
  status?: 'pending' | 'approved' | 'executed' | 'expired' // ìŠ¹ì¸ ìƒíƒœ
  created_at: timestamp
  expires_at: timestamp (í•„ìˆ˜, ì¹´ë“œ ë§Œë£Œ ì‹œì )
  metadata?: jsonb // ì¶”ê°€ ë°ì´í„°
}

// í•™ìƒìš© ë³„ì¹­ (í•˜ìœ„ í˜¸í™˜ì„±)
StudentTaskCard = TaskCard where entity_type='student'
```

**UI Layout:**

ì¹´ë“œ êµ¬ì¡°:
- í—¤ë”: task_type ì•„ì´ì½˜ + ìš°ì„ ìˆœìœ„ ë°°ì§€
- ì œëª©: title (ìµœëŒ€ 2ì¤„)
- ì„¤ëª…: description (ìµœëŒ€ 3ì¤„)
- ì•¡ì…˜ ë²„íŠ¼: "ì²˜ë¦¬í•˜ê¸°" (action_urlë¡œ ì´ë™)
- ë©”íƒ€ ì •ë³´: í•™ìƒ ì´ë¦„, ìƒì„± ì‹œê°„

**í•„ë“œ ì •ì˜:**

task_typeë³„ í•„ë“œ:
- risk: risk_level, risk_reason, recommended_action
- absence: absence_days, last_attendance_date, parent_contact_needed
- counseling: counseling_type, urgency, scheduled_date
- new_signup: signup_date, welcome_message_sent, initial_setup_needed

**task_type â†’ URL ë§¤í•‘ ê·œì¹™:**

ì¹´ë“œì˜ `action_url`ì€ `task_type`ì— ë”°ë¼ ì•„ë˜ ê·œì¹™ìœ¼ë¡œ ì„œë²„ê°€ ìƒì„±í•œë‹¤:

```typescript
task_type_url_map = {
  counseling: `/students/${entity_id}/counsel`,
  absence: `/students/${entity_id}/attendance`,
  risk: `/students/${entity_id}/risk`,
  new_signup: `/students/${entity_id}/welcome`
}
```

**ì‹ ê·œ ë“±ë¡ í•™ìƒ í™˜ì˜ ì¹´ë“œ (new_signup) íƒ€ì´í‹€/ì„¤ëª… í˜•ì‹:**
- íƒ€ì´í‹€: "{í•™ìƒì´ë¦„} í•™ìƒ ì‹ ê·œ ë“±ë¡" (ì˜ˆ: "ë°•ì†Œì˜ í•™ìƒ ì‹ ê·œ ë“±ë¡")
- ì„¤ëª…: "í™˜ì˜ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•´ ë³´ì„¸ìš”."

**URL ìƒì„± ê·œì¹™:**
- `entity_id`ëŠ” ì¹´ë“œì˜ `entity_id` í•„ë“œ ê°’ìœ¼ë¡œ ì¹˜í™˜ (ì •ë³¸)
- ë ˆê±°ì‹œ: `student_id`ëŠ” ì¹´ë“œì˜ `student_id` í•„ë“œ ê°’ìœ¼ë¡œ ì¹˜í™˜ (í•˜ìœ„ í˜¸í™˜, entity_type='student'ì¸ ê²½ìš° entity_idì™€ ë™ì¼)
- ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ URLë¡œ ë¼ìš°íŒ…
- URLì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ì—ëŸ¬ ì²˜ë¦¬

**âš ï¸ ë¼ìš°íŒ… ê³µì‹ ìŠ¤í™ í•„ìš”:**

í˜„ì¬ ê·œì¹™ì€ ìœ ë‹ˆë²„ì…œí•˜ë‚˜ ì‹¤ì œ App Router êµ¬ì¡°ê°€ ë¶ˆëª…í™•:
- ìƒë‹´ì¼ì§€ëŠ” `/students/{id}/notes/{noteId}`ì¼ ê°€ëŠ¥ì„± ë†’ìŒ
- ì¶œê²° ìƒì„¸ëŠ” `/attendance/student/{id}` ê°€ëŠ¥ì„±ë„ ìˆìŒ

**í•´ê²°: "ë””ì–´ìŒ¤ ë¼ìš°íŒ… ê³µì‹ ìŠ¤í™ v1.0"ì„ ë³„ë„ ë¬¸ì„œë¡œ ì •ì˜í•´ì•¼ í•¨.**

**ìš°ì„ ìˆœìœ„ ê³„ì‚°:**
- ê¸´ê¸‰ë„ (1-40) + ì‹œê°„ëŒ€ (1-30) + ë‹´ë‹¹ ë°˜/í•™ìƒ (1-30)
- ìµœì¢… priority = ê¸´ê¸‰ë„ + ì‹œê°„ëŒ€ + ë‹´ë‹¹ ë°˜/í•™ìƒ

#### 3.1.3 í•™ìƒì—…ë¬´ì¹´ë“œ(TaskCard) ìƒì„± ê·œì¹™ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

**ì¹´ë“œ ìƒì„± ì‹œì  ë° ë§Œë£Œ ê·œì¹™:**

**Generation Timing:**

**Daily batch at 06:00 (ì‹ ê·œ ì¹´ë“œ ìƒì„±)**
- ë§¤ì¼ ìƒˆë²½ 6ì‹œì— ë°°ì¹˜ ì‘ì—… ì‹¤í–‰
- ì „ë‚  ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ì¹´ë“œ ìƒì„±
- ê¸°ì¡´ ë§Œë£Œëœ ì¹´ë“œ ì •ë¦¬

**Real-time generation triggered by:**
- ê²°ì„ ì´ë²¤íŠ¸: í•™ìƒ ê²°ì„ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¹´ë“œ ìƒì„±
- ìƒë‹´ì¼ì§€ ì €ì¥: ìƒë‹´ì¼ì§€ ì €ì¥ ì‹œ ìƒë‹´ í•„ìš” ì¹´ë“œ ìƒì„±
- ì´íƒˆ ìœ„í—˜ ê°ì§€: ì„œë²„ê°€ ì´íƒˆ ìœ„í—˜ ê°ì§€ ì‹œ ì¦‰ì‹œ ì¹´ë“œ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)
- ì‹ ê·œ ë“±ë¡: í•™ìƒ ë“±ë¡ ì‹œ í™˜ì˜ ì¹´ë“œ ìƒì„±

**âš ï¸ M1: TaskCard ë§Œë£Œ ê·œì¹™(expires_at) í†µì¼ (v3.3 í™•ì •, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­):**

**ì¹´ë“œ ë§Œë£Œ ë¡œì§ (ë‹¨ì¼ ì •ë³¸):**

**expires_at ì„¤ì • ê·œì¹™ (í•„ìˆ˜ í•„ë“œ):**
- ìƒë‹´ ê´€ë ¨: ë‹¹ì¼ ìì • (23:59:59)
- ê²°ì„ ê´€ë ¨: 3ì¼ í›„ ìì •
- ì‹ ê·œë“±ë¡: 7ì¼ í›„ ìì •
- ì´íƒˆ ìœ„í—˜: 5ì¼ í›„ ìì •

**Stale ì¹´ë“œ ì‚­ì œ ê·œì¹™:**
- expires_atì´ ì§€ë‚œ ì¹´ë“œëŠ” ìë™ ì‚­ì œ
- ë°°ì¹˜ ì‘ì—…ì—ì„œ ë§Œë£Œ ì¹´ë“œ ì •ë¦¬ (ë§¤ì¼ 06:00)
- ì‚¬ìš©ìê°€ ì²˜ë¦¬ ì™„ë£Œí•œ ì¹´ë“œëŠ” ì¦‰ì‹œ ì‚­ì œ

**âš ï¸ ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ TaskCard ë§Œë£Œ ê·œì¹™ì„ ì–¸ê¸‰í•  ë•Œ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­):**
- "3.1.3 í•™ìƒì—…ë¬´ì¹´ë“œ ìƒì„± ê·œì¹™ì˜ expires_at ì„¤ì • ê·œì¹™ ì°¸ì¡°" í˜•íƒœë¡œë§Œ ì–¸ê¸‰
- ì¤‘ë³µëœ ê·œì¹™ ì •ì˜ ì œê±°

**ì¹´ë“œ ìš°ì„ ìˆœìœ„ ì¬ê³„ì‚°:**
- ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ìš°ì„ ìˆœìœ„ ì¬ê³„ì‚°
- ë°°ì¹˜ ì‘ì—…ì—ì„œ ì „ì²´ ì¹´ë“œ ìš°ì„ ìˆœìœ„ ì¬ì •ë ¬

**í•™ìƒì—…ë¬´ì¹´ë“œ ì¤‘ë³µ ìƒì„± ë°©ì§€ ê·œì¹™:**

ë™ì¼í•œ ì¹´ë“œê°€ ì¤‘ë³µ ìƒì„±ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ê·œì¹™:

```typescript
task_card_dedup = {
  // ë™ì¼ task_type + ë™ì¼ entity_type + ë™ì¼ entity_id + ë™ì¼ ë‚ ì§œ â†’ 1ì¥ë§Œ ìƒì„±
  same_task_same_entity_same_day: {
    condition: 'same task_type + same entity_type + same entity_id + same day',
    action: 'keep_existing',
    update_priority: true
  }
}
```

**ì¤‘ë³µ ë°©ì§€ ì ìš©:**
- ê°™ì€ ë‚  ë™ì¼ í•™ìƒì— ëŒ€í•´ ë™ì¼ task_type ì¹´ë“œëŠ” 1ì¥ë§Œ ìœ ì§€
- ìƒˆ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ê¸°ì¡´ ì¹´ë“œì˜ ìš°ì„ ìˆœìœ„ë§Œ ì—…ë°ì´íŠ¸
- ì¹´ë“œ ë‚´ìš©ì´ ë³€ê²½ëœ ê²½ìš° ê¸°ì¡´ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ìƒˆ ì¹´ë“œ ìƒì„± ì•ˆ í•¨)

**í•™ìƒ ì—…ë¬´ ì¹´ë“œ ìš°ì„ ìˆœìœ„ ê·œì¹™:**

1ìˆœìœ„: ìœ„í—˜/ì´ìƒ ìƒí™©
- ì´íƒˆ ìœ„í—˜
- ì¶œê²° ì´ìƒ
- ê¸´ê¸‰í•œ ìƒë‹´ í•„ìš”

2ìˆœìœ„: ë‹¹ì¼ ì¼ì •
- ì˜¤ëŠ˜ ìƒë‹´ ì˜ˆì •
- ì‹ ê·œ ë“±ë¡ ì²˜ë¦¬

3ìˆœìœ„: ì£¼ê°„ ê´€ë¦¬
- 3ì¼ ì—°ì† ê²°ì„
- ì„±ì·¨ë„ ì €í•˜ íŒ¨í„´ ê°ì§€

ì •ë ¬ ê¸°ì¤€: ê¸´ê¸‰ë„ â†’ ì‹œê°„ëŒ€ â†’ ë‹´ë‹¹ ë°˜/í•™ìƒ

#### 3.1.4 ì „ì²´ í•™ìƒ ëª©ë¡(List View) â€” ê²€ìƒ‰ ë° ìƒì„¸

**ì—­í•  ë° ì§„ì… ê²½ë¡œ**

ì´ í™”ë©´ì€ ì—…ë¬´ í™ˆì´ ì•„ë‹Œ "ê³ ê¸‰/ìƒì„¸ ì¡°íšŒ ê¸°ëŠ¥"ì´ë©°, ê¸°ë³¸ ì§„ì… ë™ì„ ì€ í•™ìƒ ê´€ë¦¬ í™ˆ(`/students/home`)ì—ì„œ "ì „ì²´ í•™ìƒ ë³´ê¸°" ë²„íŠ¼ ë˜ëŠ” ìƒë‹¨ íƒ­ ì „í™˜ì„ í†µí•´ì„œë§Œ ê°€ëŠ¥í•˜ë‹¤.

**ë¼ìš°íŒ…:** `/students/list`

**í•™ìƒ ê¸°ë³¸ ì •ë³´ ì¡°íšŒ**
- ì´ë¦„, í•™ë¶€ëª¨, ì—°ë½ì²˜, ëŒ€í‘œë°˜ë§Œ í‘œì‹œ
- í•™ìƒ ê²€ìƒ‰ ë° ê¸°ë³¸ í•„í„°(í•™ë…„, ë°˜, ìƒíƒœ)

**í•™ìƒ ë“±ë¡/ìˆ˜ì •**
- ìµœì†Œ ì…ë ¥ìœ¼ë¡œ í•™ìƒ ë“±ë¡ ê°€ëŠ¥
- í•™ë¶€ëª¨ ì •ë³´ ê´€ë¦¬
- í•™ìƒ ìƒíƒœ(ì¬ì›/íœ´ì›/í‡´ì›) ë³€ê²½

**ë°˜ ë°°ì • ë° ì´ë™**
- ê¸°ë³¸ ë°˜ ë°°ì • ê¸°ëŠ¥
- ë°˜ ì´ë™ ê¸°ëŠ¥

**ìƒë‹´ì¼ì§€/í•™ìŠµì¼ì§€ ê´€ë¦¬**
- ìƒë‹´ì¼ì§€ ì‘ì„± ë° ì¡°íšŒ
- í•™ìŠµì¼ì§€ ê´€ë¦¬

#### 3.1.5 ìƒë‹´/í•™ìŠµì¼ì§€ AI ìš”ì•½

**ê¸°ëŠ¥ ê°œìš”**

ìƒë‹´ì¼ì§€/í•™ìŠµì¼ì§€ ìƒì„¸ í™”ë©´ì— "AI ìš”ì•½" ë²„íŠ¼ ì¶”ê°€.

ì…ë ¥ëœ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ:
- ìš”ì•½ í•œ ì¤„
- í•µì‹¬ í‚¤ì›Œë“œ
- í–‰ë™ ê¶Œì¥ì‚¬í•­(ì„ íƒ)

**ë™ì‘ ë°©ì‹**

1. í”„ëŸ°íŠ¸ì—ì„œ note_idì™€ ì›ë¬¸ ì¼ë¶€ë¥¼ í¬í•¨í•œ ìš”ì²­ì„ Edge Functionì— ì „ë‹¬
2. Edge Functionì´ LLM API í˜¸ì¶œ
3. ê²°ê³¼ë¥¼ note_ai_summary í…Œì´ë¸”ì— ì €ì¥(ìºì‹± ìš©)

**âš ï¸ ìƒë‹´ì¼ì§€ ìš”ì•½ ì‹œ ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ ê·œì¹™ (PII Masking):**

ë¯¼ê°ì •ë³´(í•™ìƒ ì‹¤ëª…/ì „í™”ë²ˆí˜¸ ë“±)ë¥¼ ëª¨ë¸ì— ê·¸ëŒ€ë¡œ ë³´ë‚´ì§€ ì•Šë„ë¡ ì‚¬ì „ ë§ˆìŠ¤í‚¹ í•„ìˆ˜:

```typescript
pii_masking_rule = {
  // ë§ˆìŠ¤í‚¹ ëŒ€ìƒ ì •ë³´
  masking_targets: {
    // í•™ìƒ ì‹¤ëª…
    student_name: {
      pattern: /[ê°€-í£]{2,4}/g,
      replacement: '[í•™ìƒ]',
      preserve_length: false
    },

    // ì „í™”ë²ˆí˜¸
    phone_number: {
      pattern: /(\d{3})-(\d{4})-(\d{4})/g,
      replacement: '010-****-****',
      preserve_length: true
    },

    // í•™ì›ëª… (âš ï¸ M6: í•™ì›ëª… ë§ˆìŠ¤í‚¹ íŒ¨í„´ ì¡°ì •)
    academy_name: {
      // ì§€ë‚˜ì¹˜ê²Œ ê´‘ë²”ìœ„í•œ íŒ¨í„´ ëŒ€ì‹ , ëª…ì‹œì  í•™ì›ëª…ë§Œ ë§ˆìŠ¤í‚¹
      pattern: /([ê°€-í£]+í•™ì›|([ê°€-í£]+(í•™ì›|ì•„ì¹´ë°ë¯¸|êµìœ¡ì›)))/g,
      replacement: '[í•™ì›ëª…]',
      preserve_length: false,
      // í•™ì›ëª…ì€ ì»¨í…ìŠ¤íŠ¸ì— ë”°ë¼ ì„ íƒì  ë§ˆìŠ¤í‚¹ (í•„ìš”í•œ ê²½ìš°ë§Œ)
      conditional_masking: true
    },

    // ì£¼ì†Œ
    address: {
      pattern: /[ê°€-í£]+ì‹œ[ê°€-í£]+êµ¬[ê°€-í£]+ë™/g,
      replacement: '[ì£¼ì†Œ]',
      preserve_length: false
    }
  },

  // ë§ˆìŠ¤í‚¹ ì ìš© ê·œì¹™
  masking_application: {
    // AI ìš”ì•½ ìƒì„± ì „ ìë™ ë§ˆìŠ¤í‚¹
    before_ai_processing: true,

    // ì›ë³¸ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ë³´ê´€ (ë§ˆìŠ¤í‚¹ëœ ë²„ì „ë§Œ AIì— ì „ë‹¬)
    preserve_original: true,

    // ë§ˆìŠ¤í‚¹ ë¡œê·¸ ê¸°ë¡
    log_masking: true
  }
}
```

**ì£¼ì˜ì‚¬í•­:**
- ë¯¼ê°ì •ë³´(í•™ìƒ ì‹¤ëª…/ì „í™”ë²ˆí˜¸ ë“±)ë¥¼ ëª¨ë¸ì— ê·¸ëŒ€ë¡œ ë³´ë‚´ì§€ ì•Šë„ë¡ ì‚¬ì „ ë§ˆìŠ¤í‚¹ í•„ìˆ˜
- ìš”ì•½ì€ ê´€ë¦¬ì/ì„ ìƒë‹˜ ì „ìš© í™”ë©´ì—ë§Œ ë…¸ì¶œ(í•™ë¶€ëª¨ìš© ì•±ì—ëŠ” ê¸°ë³¸ ë¹„ë…¸ì¶œ)
- ì›ë³¸ ë°ì´í„°ëŠ” ë³´ê´€í•˜ë˜, AI ì²˜ë¦¬ ì‹œì—ëŠ” ë§ˆìŠ¤í‚¹ëœ ë²„ì „ë§Œ ì‚¬ìš©

#### 3.1.6 í•™ìƒ íƒœê·¸ ì‹œìŠ¤í…œ (ê³ ê¸‰ ê¸°ëŠ¥)

**í…Œì´ë¸” êµ¬ì¡°(ì˜ˆì‹œ)**

```
tags:
- id, tenant_id, name, color, category(optional), active

student_tags:
- student_id, tag_id, created_at
```

**ì‚¬ìš© ì˜ˆì‹œ**

"ì§‘ì¤‘ê´€ë¦¬", "ê³ ìœ„í—˜ ì´íƒˆ", "ì„±ì¥ ë¹ ë¦„", "ìˆ˜í•™ê°•í™”", "ì˜ì–´íšŒí™”" ë“±

**UI ìš”êµ¬**

- í•™ìƒ ë¦¬ìŠ¤íŠ¸ì—ì„œ íƒœê·¸ ì¹©(chip) í‘œì‹œ (ê³ ê¸‰ ì˜µì…˜ í™œì„±í™” ì‹œ)
- í•„í„° íŒ¨ë„ì—ì„œ íƒœê·¸ë¡œ ê²€ìƒ‰ ê°€ëŠ¥ (ê³ ê¸‰ ì˜µì…˜ í™œì„±í™” ì‹œ)
- íƒœê·¸ ìƒ‰ìƒì€ í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í„°ë§ˆì´ì§• í—ˆìš©

#### 3.1.7 ë‹¤ì¤‘ ë°˜ ì†Œì†(ë©€í‹° í´ë˜ìŠ¤) (ê³ ê¸‰ ê¸°ëŠ¥)

**ë°ì´í„° ëª¨ë¸**

```
classes (ê¸°ì¡´)

student_classes (N:N):
- student_id, class_id, primary(bool), joined_at, left_at
```

**ê¸°ëŠ¥**

- í•œ í•™ìƒì´ ì—¬ëŸ¬ ë°˜ì— ë™ì‹œì— ë“±ë¡ ê°€ëŠ¥
- "ëŒ€í‘œ ë°˜(primary class)" ê°œë…ì„ ë„ì…í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ ê¸°ë³¸ í‘œì‹œì— ì‚¬ìš©
- ì¶œê²°/ì²­êµ¬/í†µê³„ì—ì„œ class_id ê¸°ì¤€ ì§‘ê³„ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬

**UI ìš”êµ¬ì‚¬í•­:**

- í•™ìƒê´€ë¦¬ ê¸°ë³¸ í™”ë©´ì—ëŠ” ìµœì†Œ ì •ë³´(ì´ë¦„Â·í•™ë¶€ëª¨Â·ì—°ë½ì²˜Â·ëŒ€í‘œë°˜)ë§Œ í‘œì‹œí•˜ë©°,
- íƒœê·¸Â·ì¼ê´„ë“±ë¡Â·ë‹¤ì¤‘ë°˜ ê´€ë¦¬ ë“± ê³ ê¸‰ ê¸°ëŠ¥ì€ 'ê³ ê¸‰ ì˜µì…˜(Advanced)' ë²„íŠ¼ í´ë¦­ ì‹œ ë‚˜íƒ€ë‚œë‹¤.

### 3.2 ë°˜/ê°•ì‚¬(Class & Teacher) ë„ë©”ì¸

#### 3.2.1 Today-First ê¸°ì¤€

**ì‹ ê·œ ê¸°ë³¸ í™”ë©´ = "ì˜¤ëŠ˜ ìˆ˜ì—… ìˆëŠ” ë°˜"**

í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ê³§ ì‹œì‘í•  ë°˜ì´ ìƒë‹¨ ê³ ì •
- ë°˜ë³„ ì´ì›/ì¶œì„/ì§€ê° ê°„ë‹¨ í‘œì‹œ
- ì„œë²„ê°€ ì¶”ì²œ ìƒì„± (AI í˜¸ì¶œ í›„ ì„œë²„ê°€ ì •ì±… í•´ì„í•˜ì—¬ ê°•ì¡°):
  - "ì¶œì„ë¥  ì €ì¡° ë°˜"
  - "ê°•ì‚¬ ì¼ì • ì¶©ëŒ ê°€ëŠ¥ì„± ìˆìŒ"

**âš ï¸ H6: í´ë˜ìŠ¤ ë„ë©”ì¸ Industry Layer ë¶„ë¦¬ ê·œì¹™:**

**Core vs Industry êµ¬ë¶„:**

í´ë˜ìŠ¤ ë„ë©”ì¸ ê¸°ëŠ¥ì€ Core Platformê³¼ Industry Layerë¡œ ë¶„ë¦¬ë©ë‹ˆë‹¤:

**Core Platform (ì—…ì¢… ê³µí†µ):**
- ë°˜ ê¸°ë³¸ ì •ë³´ (ì´ë¦„, ì‹œê°„í‘œ, ê°•ì‚¬ ë°°ì •)
- í•™ìƒ-ë°˜ ë‹¤ì¤‘ ì†Œì† ê´€ë¦¬
- ì‹œê°„í‘œ ì¶©ëŒ ê°ì§€ (ê¸°ë³¸ ë¡œì§)

**Industry Layer (ì—…ì¢…ë³„ ì°¨ë³„í™”):**
- ë°˜ ìë™ ìƒ‰ìƒ íƒœê¹… (í•™ì›: ê³¼ëª©ë³„, ë¯¸ìš©ì‹¤: ì„œë¹„ìŠ¤ë³„)
- ë¶€ë‹´ì„ ì„¤ì • (í•™ì› ì „ìš©)
- ë°˜ë³„ ì§€ê° ê¸°ì¤€ ì„¤ì • (í•™ì› ì „ìš©)
- ë°˜ë³„ ìˆ˜ì—…ë£Œ ì„¤ì • (í•™ì› ì „ìš©)

**âš ï¸ M3-2: í´ë˜ìŠ¤ ë„ë©”ì¸ Core vs Industry êµ¬ë¶„ í‘œ:**

ë‚˜ì¤‘ì— Schema/í´ë” êµ¬ì¡° ì¡ì„ ë•Œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆê²Œ, ê¸°ëŠ¥ë³„ Layer êµ¬ë¶„:

| ê¸°ëŠ¥ | Layer |
|------|-------|
| class ê¸°ë³¸ ì—”í‹°í‹°(ì´ë¦„/ì‹œê°„í‘œ) | core-platform |
| student_classes N:N | core-platform |
| ì‹œê°„í‘œ ì¶©ëŒ ê°ì§€ (ê¸°ë³¸ ë¡œì§) | core-platform |
| ë°˜ ìë™ ìƒ‰ìƒ íƒœê¹… | industry-academy |
| ë¶€ë‹´ì„ ì„¤ì • | industry-academy |
| ë°˜ë³„ ì§€ê° ê¸°ì¤€ (class_specific_late_rules) | industry-academy |
| ë°˜ë³„ ìˆ˜ì—…ë£Œ ì„¤ì • | industry-academy |

**âš ï¸ ëª¨ë“  Class ê¸°ëŠ¥ì— ëŒ€í•´ "Core vs Industry" êµ¬ë¶„ ì£¼ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.**

#### 3.2.2 Schedule Conflict Detection (ì‹œê°„í‘œ ì¶©ëŒ ê°ì§€)

ì¶œì„ë¶€ ë°”ë¡œê°€ê¸° ë°°ë„ˆ í‘œì‹œ ì „ì— ì•„ë˜ ê²€ì¦ì„ ìˆ˜í–‰í•œë‹¤. (ì •ë³¸: ìë™ ì—´ë¦¼ ê¸ˆì§€, í´ë¦­ ì‹œ ì§„ì…)

**ì¶©ëŒ ê°ì§€ í•­ëª©:**
- ë‹´ë‹¹ ê°•ì‚¬ì˜ ì‹œê°„í‘œ ì¤‘ë³µ ì—¬ë¶€
- í•™ìƒì˜ ëŒ€í‘œë°˜/ì„œë¸Œë°˜ ì¶©ëŒ ì—¬ë¶€
- êµì‹¤ ìì› ì¤‘ë³µ ì—¬ë¶€

**ì¶©ëŒ ì‹œë‚˜ë¦¬ì˜¤:**
- ì„ ìƒë‹˜ì´ ë™ì‹œì— ë‘ ë°˜ì„ ë§¡ê³  ìˆëŠ” ê²½ìš°
- ë™ì¼ í•™ìƒì´ ì´ì¤‘ ë°°ì •ëœ ê²½ìš°
- ë°˜ ì‹œê°„ ì¼ë¶€ê°€ ê²¹ì¹˜ëŠ” ê²½ìš°
- êµì‹¤ì´ ì¤‘ë³µ ì‚¬ìš© ì¤‘ì¸ ê²½ìš°

**ì¶©ëŒ ì‹œ UI ì²˜ë¦¬:**
- "ì‹œê°„í‘œ ì¶©ëŒ ê°ì§€ë¨" ì•Œë¦¼ í‘œì‹œ
- "ì–´ë–¤ ë°˜ì„ ìš°ì„ í• ì§€ ì„ íƒí•˜ì‹­ì‹œì˜¤" ì„ íƒ í™”ë©´ ì œê³µ
- "AI ì¶”ì²œ ë°˜: ì¶œì„ë¥  ì €ì¡° ë°˜" ì¶”ì²œ ì •ë³´ ì œê³µ
- ì¶©ëŒ í•´ê²° ì „ê¹Œì§€ ì¶œì„ë¶€ ë°”ë¡œê°€ê¸° ë°°ë„ˆ í‘œì‹œ ë°©ì§€ (ì •ë³¸: ìë™ ì—´ë¦¼ ê¸ˆì§€)

#### 3.2.3 ê¸°ë³¸ ê¸°ëŠ¥

**ì˜¤ëŠ˜ ìˆ˜ì—… ìˆëŠ” ë°˜ ëª©ë¡**
- ì˜¤ëŠ˜ ìˆ˜ì—…ì´ ìˆëŠ” ë°˜ë§Œ ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œ
- ë°˜ë³„ í•™ìƒ ìˆ˜ ë° ì¶œê²° í˜„í™© ê°„ë‹¨ í‘œì‹œ
- ìˆ˜ì—… ì‹œì‘ 10ë¶„ ì „ â†’ í™ˆ/ì¶œê²° íƒ­ì— ì¶œì„ë¶€ ì—´ê¸° ì¹´ë“œ/ë°°ë„ˆ í‘œì‹œ, í´ë¦­ ì‹œ ì´ë™ (ì •ë³¸: ìë™ í™”ë©´ ì „í™˜ ê¸ˆì§€)

**âš ï¸ M5: ë°˜ ìƒì„± ìµœì†Œ ì…ë ¥ ì¡°ê±´ í†µì¼ (v3.3 í™•ì •):**

**ë°˜ ìƒì„± (ìµœì†Œ ì…ë ¥) - ë‹¨ì¼ ì •ë³¸:**
- ë°˜ ì´ë¦„ë§Œ ì…ë ¥í•´ë„ ìƒì„± ê°€ëŠ¥
- ì‹œê°„Â·ìš”ì¼Â·ì •ì›Â·ìƒ‰ìƒ ë“±ì€ ê³ ê¸‰ ì˜µì…˜ì—ì„œ ìˆ˜ì •

**ê¸°ë³¸ ê°•ì‚¬ ë°°ì •**
- ë°˜ë³„ ê°•ì‚¬ ì§€ì • (ìµœì†Œ ì •ë³´ë§Œ)

#### 3.2.4 ê³ ê¸‰ ê¸°ëŠ¥ (Advanced ì˜µì…˜ì—ì„œë§Œ ì œê³µ)

**ì „ì²´ ë°˜/ê°•ì‚¬ ê´€ë¦¬**
- ëª¨ë“  ë°˜ ëª©ë¡ ì¡°íšŒ ë° ê´€ë¦¬
- ë°˜ ìƒì„¸ ì •ë³´ ìˆ˜ì •

**ë°˜ í¸ì„±í‘œ(Calendar-like)**
- ìº˜ë¦°ë” ë·°ë¡œ ë°˜ ì¼ì • í™•ì¸
- ìš”ì¼/ì‹œê°„ë³„ ë°˜ í¸ì„±í‘œ

**ë°˜ ìë™ ìƒ‰ìƒ íƒœê¹…**
- ë°˜ë³„ ìƒ‰ìƒ ìë™ í• ë‹¹ ë° ì»¤ìŠ¤í„°ë§ˆì´ì§•
- **âš ï¸ Industry Layerì— ìœ„ì¹˜:** `industry-academy` ë ˆì´ì–´ì— êµ¬í˜„

**ë¶€ë‹´ì„ ì„¤ì •**
- ë¶€ë‹´ì„ ë°°ì • ë° ê´€ë¦¬
- **âš ï¸ Industry Layerì— ìœ„ì¹˜:** `industry-academy` ë ˆì´ì–´ì— êµ¬í˜„

**âš ï¸ ë°˜/ê°•ì‚¬ ë„ë©”ì¸ Industry Layer ë¶„ë¦¬:**

"ë¶€ë‹´ì„ ì„¤ì •", "ë°˜ ìë™ ìƒ‰ìƒ íƒœê¹…"ì€ Industry Layerì— ìœ„ì¹˜í•´ì•¼ í•¨:
- Core Platformì˜ "class entity í™•ì¥"ìœ¼ë¡œ OR
- `industry-academy` ë ˆì´ì–´ì— ìœ„ì¹˜
- í˜„ì¬ ë¬¸ì„œì—ëŠ” í•™ìƒÂ·ë°˜ ë„ë©”ì¸ì˜ ì¼ë¶€ë¡œ ë³´ì´ì§€ë§Œ, ì‹¤ì œ êµ¬í˜„ ì‹œ Industry Layerë¡œ ë¶„ë¦¬ í•„ìš”

**ë°˜ë³„ ìƒì„¸ í†µê³„**
- ì¶œê²°ë¥ /ì •ì›ë¥ /ì§€ê°ë¥  ìƒì„¸ í‘œì‹œ
- ë°˜ë³„ ì„±ê³¼ ë¶„ì„

**UI ìš”êµ¬ì‚¬í•­:**

- ë°˜ ìƒì„± ì‹œ ìµœì†Œ ì…ë ¥(ë°˜ ì´ë¦„ë§Œ)ìœ¼ë¡œë„ ìƒì„± ê°€ëŠ¥í•˜ë©°,
- ì‹œê°„Â·ìš”ì¼Â·ì •ì›Â·ìƒ‰ìƒ ë“±ì€ ê³ ê¸‰ ì˜µì…˜ì—ì„œ ìˆ˜ì •í•œë‹¤.
- ë°˜ ëª©ë¡ì€ ê¸°ë³¸ì ìœ¼ë¡œ "ì˜¤ëŠ˜ ìˆ˜ì—… ìˆëŠ” ë°˜"ë§Œ í‘œì‹œí•˜ë©°,
- ì „ì²´ ë°˜ ê´€ë¦¬ ë° í¸ì„±í‘œëŠ” Advanced ì˜ì—­ìœ¼ë¡œ ì´ë™í•œë‹¤.

### 3.3 ì¶œê²°(Attendance) ë„ë©”ì¸

#### 3.3.1 í•µì‹¬ ì›ì¹™

ì¶œê²° ê¸°ëŠ¥ì€ ì‹¤ì‚¬ìš© ë¹ˆë„ê°€ ê°€ì¥ ë†’ìœ¼ë¯€ë¡œ ìµœì†Œí•œì˜ ì¡°ì‘ìœ¼ë¡œ ì¶œê²°ì´ ê°€ëŠ¥í•´ì•¼ í•œë‹¤.
ì¶œê²° ë©”ì¸ í™”ë©´ì€ "ì˜¤ëŠ˜ ì¶œê²°í•˜ê¸°"ì™€ "QR ì¶œê²° ì‹¤í–‰(í•™ìƒìš©)" ë‘ ê°œë§Œ ìˆì–´ì•¼ í•œë‹¤.

#### 3.3.2 ìë™ ë™ì‘ ê¸°ë°˜ ì¶œê²° (Zero-Interaction Principle)

**âš ï¸ AI ì¶œì„ ì˜ˆì¸¡ê°’ ì ìš© ë²”ìœ„ ì›ì¹™:**

AI ì¶œì„ ì˜ˆì¸¡ê°’ì€ ì´ˆê¸° ìƒíƒœì—ì„œë§Œ ì¶”ì²œê°’ìœ¼ë¡œ í‘œì‹œë˜ë©°, Teacherì˜ ëª¨ë“  ìˆ˜ë™ ì…ë ¥ì€ AI ì˜ˆì¸¡ê°’ì„ ì¦‰ì‹œ overrideí•œë‹¤.

**ì‹ ê·œ ê¸°ëŠ¥ ë°˜ì˜**

**QR ê°ì§€ ì‹œ ìë™ ë“±ì› ì²˜ë¦¬**
- QR ìŠ¤ìº” ì‹œ ìë™ ë“±ì› ì²˜ë¦¬ (ì‚¬ìš©ì í™•ì¸ ìµœì†Œí™”)

**ê³ ì • ì¥ì¹˜(íƒœë¸”ë¦¿)ì—ì„œ í•™ìƒ ê°ì§€ ì‹œ ìë™ ì²´í¬**
- í•™ìƒ ì¸ì‹ ì‹œ ìë™ ì¶œê²° ì²˜ë¦¬
- ì„ ìƒë‹˜ í™”ë©´ì—ëŠ” "ì…ì‹¤ ì™„ë£Œ"ë§Œ í‘œì‹œ

**AIê°€ ì¶œì„ì„ "ì˜ˆì¸¡"í•˜ì—¬ ì´ˆê¸° ì¶”ì²œê°’ ì œê³µ**
- ê³¼ê±° ì¶œê²° íŒ¨í„´ ê¸°ë°˜ìœ¼ë¡œ ì˜¤ëŠ˜ ì¶œì„ ì˜ˆìƒ í•™ìƒ ì¶”ì²œ
- ì„ ìƒë‹˜ì´ í™•ì¸/ìˆ˜ì •ë§Œ í•˜ë©´ ë¨

**âš ï¸ AI ì¶œì„ ì˜ˆì¸¡ê°’ ì ìš© ë²”ìœ„ ëª…í™•í™”:**

AI ì˜ˆì¸¡ ì¶œì„ ì²´í¬ëŠ” teacherê°€ ìˆ˜ë™ìœ¼ë¡œ ì–¸ì œë“  ìˆ˜ì • ê°€ëŠ¥í•˜ë©°, AI ì¶”ì²œê°’ì€ "ì´ˆê¸° ìƒíƒœ"ì—ë§Œ í‘œì‹œë˜ê³ , ì‚¬ìš©ì ì…ë ¥ì´ ë°œìƒí•˜ë©´ AI ë°ì´í„°ëŠ” override ëœë‹¤.

```typescript
ai_attendance_prediction_rule = {
  // AI ì˜ˆì¸¡ê°’ì€ ì´ˆê¸° ìƒíƒœì—ë§Œ ì ìš©
  initial_state_only: true,

  // ì‚¬ìš©ì ì…ë ¥ ë°œìƒ ì‹œ AI ë°ì´í„° override
  user_input_overrides_ai: true,

  // TeacherëŠ” ì–¸ì œë“  ìˆ˜ì • ê°€ëŠ¥
  teacher_can_modify: true,

  // AI ì˜ˆì¸¡ ì‹¤íŒ¨ ì‹œ fallback
  fallback_on_prediction_failure: {
    action: 'show_all_students_unchecked',
    allow_manual_check: true
  }
}
```

**ì ìš© ë²”ìœ„:**
- AI ì˜ˆì¸¡ê°’ì€ í™”ë©´ ì´ˆê¸° ë¡œë“œ ì‹œì—ë§Œ ì´ˆê¸° ì¶”ì²œê°’ìœ¼ë¡œ í‘œì‹œ
- Teacherê°€ ì¶œì„ ì²´í¬ë¥¼ ë³€ê²½í•˜ë©´ AI ì˜ˆì¸¡ê°’ì€ ë¬´ì‹œë¨
- AI ì˜ˆì¸¡ ì‹¤íŒ¨ ì‹œ ëª¨ë“  í•™ìƒì„ ë¯¸ì²´í¬ ìƒíƒœë¡œ í‘œì‹œ
- ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì²´í¬ ê°€ëŠ¥
- AI ì˜ˆì¸¡ê°’ì€ 100% ìë™ ì²´í¬ê°€ ì•„ë‹Œ "ì´ˆê¸° ì¶”ì²œê°’" ì—­í• ë§Œ ìˆ˜í–‰

**ê²€ìƒ‰ ì—†ì´ "ì˜¤ëŠ˜ ìˆ˜ì—… í•™ìƒë§Œ" ê¸°ë³¸ ë…¸ì¶œ**
- ë°˜ë³„ ì˜¤ëŠ˜ ìˆ˜ì—… í•™ìƒë§Œ ìë™ í•„í„°ë§
- ë¶ˆí•„ìš”í•œ ê²€ìƒ‰ ê³¼ì • ì œê±°

#### 3.3.3 ê¸°ë³¸ UI (ë§¤ì¼ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥)

**âš ï¸ C2: ì¶œê²° í™”ë©´ì˜ ì‹¤ì œ ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°:**

**ì¶œê²° í™”ë©´ ì»´í¬ë„ŒíŠ¸ íŠ¸ë¦¬:**

```
AttendanceScreen (ì¶œê²° í™”ë©´)
â”œâ”€ AttendanceHeader (í—¤ë”)
â”‚  â”œâ”€ ë°˜ ì„ íƒ ë“œë¡­ë‹¤ìš´
â”‚  â”œâ”€ ë‚ ì§œ ì„ íƒ
â”‚  â””â”€ ê²€ìƒ‰ ì…ë ¥
â”‚
â”œâ”€ AttendanceStudentList (í•™ìƒ ë¦¬ìŠ¤íŠ¸)
â”‚  â”œâ”€ StudentCard (í•™ìƒ ì¹´ë“œ) Ã— N
â”‚  â”‚  â”œâ”€ StudentInfo (í•™ìƒ ì •ë³´)
â”‚  â”‚  â”‚  â”œâ”€ ì´ë¦„
â”‚  â”‚  â”‚  â”œâ”€ í•™ë…„/ë°˜
â”‚  â”‚  â”‚  â””â”€ ì‚¬ì§„ (ì„ íƒ)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ AttendanceStatus (ì¶œê²° ìƒíƒœ)
â”‚  â”‚  â”‚  â”œâ”€ ë“±ì› ì²´í¬ë°•ìŠ¤
â”‚  â”‚  â”‚  â”œâ”€ í•˜ì› ì²´í¬ë°•ìŠ¤
â”‚  â”‚  â”‚  â”œâ”€ ì§€ê°/ê²°ì„ ë°°ì§€
â”‚  â”‚  â”‚  â””â”€ AI ì˜ˆì¸¡ í‘œì‹œ (ì„ íƒ)
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ ActionButtons (ì•¡ì…˜ ë²„íŠ¼)
â”‚  â”‚     â”œâ”€ ë“±ì› ë²„íŠ¼
â”‚  â”‚     â”œâ”€ í•˜ì› ë²„íŠ¼
â”‚  â”‚     â””â”€ ìƒì„¸ ë³´ê¸° ë²„íŠ¼
â”‚  â”‚
â”‚  â””â”€ EmptyState (í•™ìƒ ì—†ìŒ)
â”‚     â””â”€ "ì˜¤ëŠ˜ ìˆ˜ì—… í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€
â”‚
â”œâ”€ AttendanceSummary (ì¶œê²° ìš”ì•½)
â”‚  â”œâ”€ ì´ì›
â”‚  â”œâ”€ ì¶œì„ ìˆ˜
â”‚  â”œâ”€ ì§€ê° ìˆ˜
â”‚  â””â”€ ê²°ì„ ìˆ˜
â”‚
â””â”€ AttendanceActions (ì¶œê²° ì•¡ì…˜)
   â”œâ”€ ì¼ê´„ ë“±ì› ë²„íŠ¼
   â”œâ”€ ì¼ê´„ í•˜ì› ë²„íŠ¼
   â””â”€ ì €ì¥ ë²„íŠ¼
```

**ì¶œê²° í™”ë©´ ìƒíƒœ ë³€í™˜ (State Machine):**

```typescript
attendance_screen_state_machine = {
  initial: 'loading',
  states: {
    loading: {
      on: {
        DATA_LOADED: 'ready',
        ERROR: 'error'
      }
    },
    ready: {
      on: {
        STUDENT_SELECTED: 'editing',
        BULK_ACTION: 'bulk_processing',
        SAVE_CLICKED: 'saving'
      }
    },
    editing: {
      on: {
        SAVE: 'saving',
        CANCEL: 'ready'
      }
    },
    bulk_processing: {
      on: {
        BULK_COMPLETE: 'ready',
        BULK_ERROR: 'ready'
      }
    },
    saving: {
      on: {
        SAVE_SUCCESS: 'success',
        SAVE_ERROR: 'error'
      }
    },
    success: {
      on: {
        CONTINUE: 'ready',
        AUTO_CLOSE: 'ready'  // 2ì´ˆ í›„ ìë™ìœ¼ë¡œ readyë¡œ ì „í™˜
      }
    },
    error: {
      on: {
        RETRY: 'loading',
        DISMISS: 'ready'
      }
    }
  }
}
```

**ë¡œë”©/ì˜¤ë¥˜/Success ìƒíƒœ êµ¬ì„±:**

```typescript
attendance_screen_states = {
  loading: {
    ui: {
      show_skeleton: true,  // ìŠ¤ì¼ˆë ˆí†¤ UI í‘œì‹œ
      disable_interaction: true,
      message: 'ì¶œê²° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'
    }
  },

  error: {
    ui: {
      show_error_message: true,
      error_message: 'ì¶œê²° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
      show_retry_button: true,
      retry_button_text: 'ë‹¤ì‹œ ì‹œë„'
    },
    actions: {
      on_retry: 'reload_data',
      on_dismiss: 'hide_error'
    }
  },

  success: {
    ui: {
      show_success_toast: true,
      success_message: 'ì¶œê²° ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      auto_close_duration: 2000  // 2ì´ˆ í›„ ìë™ ë‹«ê¸°
    },
    actions: {
      on_continue: 'stay_on_screen',
      on_auto_close: 'refresh_data'
    }
  }
}
```

**ì˜¤ëŠ˜ ì¶œê²°í•˜ê¸°**
- PC/íƒœë¸”ë¦¿/ëª¨ë°”ì¼ ì¶œê²°
- ì˜¤ëŠ˜ ìˆ˜ì—… í•™ìƒë§Œ ìë™ í‘œì‹œ
- AI ì˜ˆì¸¡ ê¸°ë°˜ ì´ˆê¸° ì¶”ì²œê°’ ì œê³µ
- í•™ìƒ ê²€ìƒ‰ ë° ì¶œê²° ì²´í¬
- ë“±ì›/í•˜ì› ì²˜ë¦¬

**QR ì¶œê²° ì‹¤í–‰ (ì„¤ì • í™œì„±í™” ì‹œì—ë§Œ ë…¸ì¶œ)**
- QR ì½”ë“œ ìŠ¤ìº”ì„ í†µí•œ ìë™ ì¶œê²°
- í•™ìƒìš© ëª¨ë°”ì¼ í™”ë©´

**ì¶œê²° ì•Œë¦¼ ë°œì†¡**
- ë“±ì›/í•˜ì› ì‹œ ìë™ ì•Œë¦¼ ë°œì†¡ (ì„¤ì • ê¸°ë°˜)

**âš ï¸ M3: Attendance Fallback ê·œì¹™ ì¤‘ë³µ ì œê±°:**

**ë‹¨ì¼ ì •ë³¸ (v3.3 í™•ì •):**

ì¶œê²° Fallback ê·œì¹™ì€ ì•„ë˜ ì„¹ì…˜ì—ì„œë§Œ ì •ì˜í•˜ê³ , ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œëŠ” ì°¸ì¡° í˜•íƒœë¡œë§Œ ì–¸ê¸‰í•©ë‹ˆë‹¤.

#### 3.3.4 ì¶œê²° Fallback UI/UX ê·œì¹™

Zero-Interactionì´ ì‹¤íŒ¨í•œ ê²½ìš°, ì‹œìŠ¤í…œì€ ì¦‰ì‹œ ì•„ë˜ fallbackì„ ì œê³µ:

**ìë™ ì¶œê²° ì‹¤íŒ¨ â†’ "í„°ì¹˜ 1íšŒë¡œ ë“±ì› ì²˜ë¦¬" ë²„íŠ¼ ì œê³µ**
- ìë™ ê°ì§€ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ìˆ˜ë™ ì²˜ë¦¬ ë²„íŠ¼ í‘œì‹œ
- ìµœì†Œí•œì˜ í´ë¦­ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥

**QR ë³µì œ ì˜ì‹¬ â†’ "ë³¸ì¸ ì¸ì¦ ìš”ì²­" í™”ë©´ ìë™ í‘œì‹œ**
- ë™ì¼ QR ë°˜ë³µ ì‚¬ìš© ê°ì§€ ì‹œ ìë™ ì¸ì¦ ìš”ì²­
- ì¶”ê°€ ë³´ì•ˆ ê²€ì¦ ì§„í–‰

**í‚¤ì˜¤ìŠ¤í¬ì—ì„œ ì–¼êµ´ ì¸ì‹ ì‹¤íŒ¨ â†’ "í•™ìƒ ë²ˆí˜¸ ì…ë ¥" ëª¨ë“œ ìë™ ì „í™˜**
- ì¸ì‹ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ëŒ€ì²´ ì…ë ¥ ë°©ì‹ ì œê³µ
- ì‚¬ìš©ì í˜¼ë€ ìµœì†Œí™”

**í•™ìƒ ë™ì¼ ì´ë¦„ ì¤‘ë³µ â†’ "í•™ìƒ ì„ íƒ" í™”ë©´ ìë™ í‘œì‹œ**
- ì¤‘ë³µ ì´ë¦„ ê°ì§€ ì‹œ ì„ íƒ í™”ë©´ ì œê³µ
- ì¶”ê°€ ì •ë³´(í•™ë…„/ë°˜)ë¡œ êµ¬ë¶„

**ì¸ì¦ ì‹¤íŒ¨ â†’ "ì¬ì‹œë„" ë˜ëŠ” "ê´€ë¦¬ì í™•ì¸" ì˜µì…˜ ì œê³µ**
- ì¸ì¦ ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´

#### 3.3.5 QR ì¶œê²° ì•„í‚¤í…ì²˜

**âš ï¸ ì¶œê²° ì„¤ì • í†µí•© ì›ì¹™:**

(ì¶œê²° ì„¤ì • JSON êµ¬ì¡°ëŠ” 3.3.7 'ì¶œê²° ì„¤ì •'ì˜ `attendance.*` ê²½ë¡œ ì •ì˜ë¥¼ ë”°ë¥¸ë‹¤. ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB)ì…ë‹ˆë‹¤.)

**í•µì‹¬ í•©ì˜: QRì€ "í•™ì› ê³ ì • QR ì½”ë“œ + í•™ìƒ íœ´ëŒ€í° ì´¬ì˜ ë°©ì‹"**

**QR ì½”ë“œ ë°©ì‹**

ê° í•™ì›(ë° ì„ íƒì ìœ¼ë¡œ ë°˜/ê°•ì˜ì‹¤)ë³„ë¡œ ê³ ì • QR ì½”ë“œë¥¼ ë°œê¸‰í•œë‹¤.

**QR ë‚´ìš©:**
```
https://{public-gateway}/attend?q={signed_token}
```

signed_token ë‚´ë¶€ ì •ë³´:
- tenant_id
- location_type (academy / classroom / branch)
- location_id
- expires_at (í•„ìˆ˜, í•™ì› ê³ ì • QRì€ 90ì¼ ìë™ ì„¤ì •)
- HMAC ì„œëª…

**âš ï¸ ğŸ”¥ H5: QR í† í° ë§Œë£Œ ë° ì¬ë°œê¸‰ ê·œì¹™ (ë‹¨ì¼ ì •ë³¸, v3.3 í™•ì •):**

**ì •ë³¸ ê·œì¹™:**

```typescript
qr_token_expiry = {
  // í•™ì› ê³ ì • QRì€ ìœ íš¨ê¸°ê°„ 90ì¼ ìë™ ì„¤ì •
  default_expiry_days: 90,

  // ë§Œë£Œ 7ì¼ ì „ ìë™ ì¬ë°œê¸‰
  auto_renew_before_days: 7,

  // ì¬ë°œê¸‰ ì‹œ ê´€ë¦¬ìì—ê²Œ ì•ˆë‚´
  notify_admin_on_renew: true
}
```

**QR í† í° ì¬ë°œê¸‰ í”„ë¡œì„¸ìŠ¤:**
- ë§Œë£Œ 7ì¼ ì „ ì„œë²„ê°€ ìƒˆ QR í† í° ìƒì„±
- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— "QR í† í° ì¬ë°œê¸‰ í•„ìš”" ì•Œë¦¼ ì¹´ë“œ ìƒì„±
- ìƒˆ QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ ë° ì¶œë ¥ ì•ˆë‚´
- ê¸°ì¡´ QR ì½”ë“œëŠ” ë§Œë£Œì¼ê¹Œì§€ ìœ íš¨ (ì ì§„ì  êµì²´)

**âš ï¸ ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ QR í† í° ë§Œë£Œ ê·œì¹™ì„ ì–¸ê¸‰í•  ë•Œ:**
- "3.3.5 QR ì¶œê²° ì•„í‚¤í…ì²˜ì˜ QR í† í° ìœ íš¨ê¸°ê°„ ê·œì¹™ ì°¸ì¡°" í˜•íƒœë¡œë§Œ ì–¸ê¸‰
- ì¤‘ë³µëœ ê·œì¹™ ì •ì˜ ì œê±°

**ì¶œê²° íë¦„**

1. í•™ì›ì´ ì…êµ¬/ê°•ì˜ì‹¤ì— QR ì¶œë ¥Â·ë¶€ì°©
2. í•™ìƒì´ ë³¸ì¸ íœ´ëŒ€í°ìœ¼ë¡œ QR ì´¬ì˜ â†’ ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €/ì•± ì˜¤í”ˆ
3. ì¸ì¦ ì²˜ë¦¬:
   - **í•™ë¶€ëª¨/í•™ìƒ ì•± ë¡œê·¸ì¸ ìƒíƒœ** â†’ ìë™ ì¸ì¦ (JWT í† í° í™•ì¸)
   - **ë¹„ë¡œê·¸ì¸ ë¸Œë¼ìš°ì € ì ‘ê·¼** â†’ SMS ë³¸ì¸ ì¸ì¦ ë˜ëŠ” temporary token ë°œê¸‰
4. ì¶œê²° API í˜¸ì¶œ:
   - attendance_mode = 'qr'
   - device_type = 'mobile'
   - qr_payload í¬í•¨
   - auth_token ë˜ëŠ” temp_token í¬í•¨
5. ì„œë²„ì—ì„œ:
   - í† í° ìœ íš¨ì„± ê²€ì¦(HMAC, ë§Œë£Œì‹œê°„ ë“±)
   - ì¸ì¦ ìƒíƒœ í™•ì¸ (ë¡œê·¸ì¸ ë˜ëŠ” SMS ì¸ì¦ ì™„ë£Œ)
   - ì¶œê²° ì´ë²¤íŠ¸(`attendance_logs`)ì— source='qr' ê¸°ë¡

**âš ï¸ ì¶œê²° í…Œì´ë¸” ëª…ëª… í†µì¼:**

ë¬¸ì„œ ì „ë°˜ì—ì„œ ì¶œê²° ê´€ë ¨ í…Œì´ë¸”ì€ ì•„ë˜ í‘œì¤€ ëª…ëª…ì„ ì‚¬ìš©í•œë‹¤:

- **attendance_logs**: ì¶œê²° ì›ë³¸ ë¡œê·¸ (ì›ë³¸ í…Œì´ë¸”)
- **attendance_events**: Event Engine ë‚´ë¶€ ì´ë²¤íŠ¸ (Event Engine internal)
- **attendance_daily**: ì¼ë³„ ì§‘ê³„ ë°ì´í„° (ì§‘ê³„ í…Œì´ë¸”)
- **attendance_mv**: Materialized View (Materialized View)

**âš ï¸ B6: ì¶œê²° Anti-Abuse Device Fingerprint ì‹¤ì œ DB í•„ë“œ ì •ì˜:**

**attendance_logs í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ (Anti-Abuse í•„ë“œ í¬í•¨):**

```sql
CREATE TABLE public.attendance_logs (
  id bigserial NOT NULL,
  tenant_id uuid NOT NULL,
  student_id uuid NOT NULL,
  class_id uuid,
  occurred_at timestamptz NOT NULL,
  attendance_type text NOT NULL CHECK (attendance_type IN ('check_in', 'check_out', 'absent', 'late')),
  status text NOT NULL CHECK (status IN ('present', 'late', 'absent', 'excused')),
  notes text,
  created_by uuid,
  created_at timestamptz NOT NULL DEFAULT now(),

  -- âš ï¸ B6: Anti-Abuse í•„ë“œ (Device Fingerprint/GPS/Auth Method)
  device_fingerprint text,  -- SHA256 í•´ì‹œê°’ (ì›¹: user_agent+ip+screen, ëª¨ë°”ì¼: device_uuid+app_instance_id)
  gps_lat numeric(10, 7),    -- GPS ìœ„ë„ (QR ì¶œê²° ì‹œ ì„ íƒì  ìˆ˜ì§‘)
  gps_lng numeric(10, 7),    -- GPS ê²½ë„ (QR ì¶œê²° ì‹œ ì„ íƒì  ìˆ˜ì§‘)
  auth_method text,          -- ì¸ì¦ ë°©ë²•: 'qr', 'manual', 'sms_auth', 'temp_token', 'fingerprint_match'
  source text,               -- ì¶œê²° ì†ŒìŠ¤: 'pc', 'tablet', 'mobile', 'qr'
  ip_address inet,          -- IP ì£¼ì†Œ (ë¶€ì •í–‰ìœ„ íƒì§€ìš©)
  user_agent text,           -- User Agent (ì›¹ ë¸Œë¼ìš°ì €ìš©)

  PRIMARY KEY (id, occurred_at)
) PARTITION BY RANGE (occurred_at);
```

**í•„ë“œ ì„¤ëª…:**
- `device_fingerprint`: Device Fingerprint SHA256 í•´ì‹œê°’ (low-assurance indicator)
- `gps_lat`, `gps_lng`: GPS ì¢Œí‘œ (QR ì¶œê²° ì‹œ `qr_gps_enabled=true`ì¼ ë•Œë§Œ ìˆ˜ì§‘)
- `auth_method`: ì‹¤ì œ ì¸ì¦ ë°©ë²• (QR ì¸ì¦, SMS ì¸ì¦, ì„ì‹œ í† í° ë“±)
- `source`: ì¶œê²° ì†ŒìŠ¤ (PC/íƒœë¸”ë¦¿/ëª¨ë°”ì¼/QR)
- `ip_address`, `user_agent`: ë¶€ì •í–‰ìœ„ íƒì§€ìš© ë³´ì¡° ì •ë³´

**ìƒíƒœ í•„ë“œ í‘œì¤€:**
- `status`: `present` | `late` | `absent` | `leave_early`

**QR ì¸ì¦ ë°©ì‹:**

**âš ï¸ Parent/Student ì¸ì¦ ëª¨ë¸ ëª…í™•í™”:**

**ì¸ì¦ í† í° êµ¬ë¶„:**
- **Parent Token**: í•™ë¶€ëª¨ ì•±ì—ì„œ ë°œê¸‰ëœ JWT (role='guardian' ë˜ëŠ” 'parent')  -- guardianì€ ì •ë³¸ í‚¤, parentëŠ” backward compatibility
- **Student Token**: í•™ìƒ ì•±ì—ì„œ ë°œê¸‰ëœ JWT (role='student')
- ë‘ í† í° ëª¨ë‘ QR ì¶œê²°ì— ì‚¬ìš© ê°€ëŠ¥í•˜ë‚˜, ê¶Œí•œ ë²”ìœ„ëŠ” ë‹¤ë¦„

**í•™ë¶€ëª¨/í•™ìƒ ì•± ë¡œê·¸ì¸ ìƒíƒœ:**
- ì•± ë‚´ JWT í† í° ìë™ ì „ë‹¬ (Parent Token ë˜ëŠ” Student Token)
- ì¶”ê°€ ì¸ì¦ ì—†ì´ ì¶œê²° ì²˜ë¦¬ ê°€ëŠ¥
- Parent Token: ìë…€ ì¶œê²° ì¡°íšŒ ê°€ëŠ¥
- Student Token: ë³¸ì¸ ì¶œê²°ë§Œ ê°€ëŠ¥

**ë¹„ë¡œê·¸ì¸ ë¸Œë¼ìš°ì € ì ‘ê·¼:**
- SMS ë³¸ì¸ ì¸ì¦: í•™ìƒ ì „í™”ë²ˆí˜¸ë¡œ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
- Temporary Token: ì¼íšŒìš© í† í° ë°œê¸‰ (5ë¶„ ìœ íš¨)
- ì¸ì¦ ì™„ë£Œ í›„ ì¶œê²° ì²˜ë¦¬ ì§„í–‰

**í•™ìƒ ë³¸ì¸ íœ´ëŒ€í° ì§ì ‘ ì¸ì¦:**
- í•™ë¶€ëª¨ ì•± ì—†ì´ í•™ìƒ ë³¸ì¸ íœ´ëŒ€í°ìœ¼ë¡œ ì§ì ‘ QRì„ ì°ì–´ë„ ì¸ì¦ ê°€ëŠ¥
- ì¼ë¶€ í•™ì›ì—ì„œ í•™ìƒ ë³¸ì¸ ë²ˆí˜¸ë¡œ ì¸ì¦ ì§„í–‰
- í•™ìƒ ì „í™”ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ ë²ˆí˜¸ë¡œ SMS ì¸ì¦ ì§„í–‰
- Parent ì•± ì—†ì´ë„ í•™ìƒ ë‹¨ë… QR ì¶œê²° ê°€ëŠ¥

**SMS ì¸ì¦ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°©ë²•:**
- SMS ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë³´ì¡° ì¸ì¦ ì œê³µ:
  - **ë°©ë²• 1**: í•™ìƒ ID + ìƒë…„ì›”ì¼ 4ìë¦¬ ì…ë ¥
  - **ë°©ë²• 2**: í•™ë¶€ëª¨ ë²ˆí˜¸ ê¸°ë°˜ ëŒ€ì²´ ì¸ì¦
- ë³´ì¡° ì¸ì¦ ì„±ê³µ ì‹œ ì¶œê²° ì²˜ë¦¬ ì§„í–‰
- ë³´ì¡° ì¸ì¦ ì‹¤íŒ¨ ì‹œ ê´€ë¦¬ì í™•ì¸ ìš”ì²­

**ë³´ì•ˆ ê³ ë ¤ì‚¬í•­**

- í† í° ì„œëª… í•„ìˆ˜ (í‰ë¬¸ academy_idë§Œ ë…¸ì¶œ ê¸ˆì§€)
- ì¼ì • ì‹œê°„ ì´ìƒ ì§€ë‚œ QR í† í° â†’ ë¬´íš¨ ì²˜ë¦¬ ë˜ëŠ” ë¦¬í”„ë ˆì‹œ í•„ìš”
- QRë¥¼ ìº¡ì²˜/ë³µì œí•œ ê²½ìš°:
  - ìœ„ì¹˜ ê¸°ë°˜(ì„ íƒ ì‚¬í•­) or ì‹œê°„ëŒ€ ê¸°ë°˜ ì¶”ê°€ ê²€ì¦(ì˜ˆ: ì•¼ê°„ ì‹œê°„ëŒ€ ì œí•œ)

#### 3.3.6 Anti-Abuse Rule (ì¶œê²° ë¶€ì •í–‰ìœ„ ë°©ì§€ ê·œì¹™)

QR ì¶œê²°ì˜ ë¶€ì •í–‰ìœ„ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ê·œì¹™:

**1) Device Fingerprint ë¹„êµ**

**âš ï¸ C8: Device Fingerprint ì‹ ë¢°ë„ ë¶„ë¥˜ í†µì¼:**

ì´ˆë°˜ ì„¤ëª…ê³¼ í›„ë°˜ ë³´ì™„ ê·œì¹™ì´ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ í†µì¼:

- Device FingerprintëŠ” "low-assurance device indicator"ë¡œ ë¶„ë¥˜
- "strong identifier"ì²˜ëŸ¼ ì„œìˆ í•˜ì§€ ì•ŠìŒ
- Private Mode, VPN, í•™êµ ê³µìš© ì™€ì´íŒŒì´ í™˜ê²½ì—ì„œ ë§¤ë²ˆ ë‹¤ë¥¸ fingerprint ìƒì„± ê°€ëŠ¥
- ë†’ì€ ì‹ ë¢°ë„ê°€ í•„ìš”í•œ ê²½ìš° ì¶”ê°€ ì¸ì¦(SMS, ë³¸ì¸ í™•ì¸) í•„ìˆ˜

**Device Fingerprint ë¹„êµ ê·œì¹™:**
- ë™ì¼ ê¸°ê¸° í† í° ì§€ë¬¸(Device Fingerprint) ë¹„êµ
- ë™ì¼ ê¸°ê¸°ì—ì„œ ë°˜ë³µ QR ì…ë ¥ ì‹œ ê²½ê³ 
- Fingerprint ë¶ˆì¼ì¹˜ ì‹œ: `attendance.device_fingerprint_fallback_policy`ì— ë”°ë¼ ì²˜ë¦¬ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))
  - `sms_auth`: SMS ì¸ì¦ìœ¼ë¡œ ìë™ ì „í™˜
  - `block`: ì¶œê²° ì°¨ë‹¨
  - `warn`: ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ì¶œê²° í—ˆìš©

**2) GPS ê¸°ë°˜ í—ˆìš© ë°˜ê²½ ì œí•œ (ì„ íƒ)**

**âš ï¸ M2: GPS ì¶œê²° ì˜µì…˜ UIì—ì„œ optionalë¡œ ëª…ì‹œ:**

**GPS ì˜µì…˜ ì œí•œì‚¬í•­ (v3.3 í™•ì •):**

GPS ì˜µì…˜ì€ ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ì—ì„œ 100% ë™ì‘í•˜ì§€ ì•ŠìŒ:
- í•™ìƒ íœ´ëŒ€í°ì—ì„œ QRì„ ì°ëŠ” êµ¬ì¡°ì—ì„œ GPS ê¶Œí•œ ìš”ì²­ ì‹œ ê±°ë¶€ìœ¨ ë§¤ìš° ë†’ìŒ
- ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ê±°ì˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
- **Fallback ê·œì¹™ì„ ê°•í™”í•´ì•¼ í•¨**

**UI í‘œì‹œ ê·œì¹™:**
- GPS ì˜µì…˜ì€ ì„¤ì • UIì—ì„œ **"ì„ íƒ ì‚¬í•­(Optional)"**ë¡œ ëª…ì‹œ
- Default Policy: `qr_gps_enabled: false` (í…Œë„ŒíŠ¸ ìƒì„± ì‹œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥)
- í™œì„±í™” ì‹œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ: "ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ GPS ê¶Œí•œ ê±°ë¶€ ì‹œ ìë™ìœ¼ë¡œ SMS ì¸ì¦ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤"

**GPS ì„¤ì •:**
- GPS ê¸°ë°˜ í—ˆìš© ë°˜ê²½ ì œí•œ ì˜µì…˜ (`attendance.qr_gps_enabled`, ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))
- ê¸°ë³¸ í—ˆìš© ë°˜ê²½: 150m (`attendance.qr_gps_radius_meters`, ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))
- í•™ì› ìœ„ì¹˜ì—ì„œ ë²—ì–´ë‚œ QR ì…ë ¥ ê°ì§€
- GPS ê²€ì¦ ì‹¤íŒ¨ ì‹œ: SMS ì¸ì¦ ë˜ëŠ” ë³¸ì¸ í™•ì¸ìœ¼ë¡œ ìë™ Fallback
- GPS ê¶Œí•œ ê±°ë¶€ ì‹œ: ìë™ìœ¼ë¡œ SMS ì¸ì¦ìœ¼ë¡œ ì „í™˜

**3) ë¹„ì •ìƒ ì‹œê°„ëŒ€ ê°ì§€ (Adaptive Rule)**
- ì •ê·œ ìˆ˜ì—… ì‹œê°„ì´ ì•„ë‹Œë° QR ì°í˜ ê°ì§€
- ì¥ì‹œê°„ ì™¸ë¶€ì—ì„œ QR ì…ë ¥ ë°œìƒ ê°ì§€

**4) ë™ì¼ í•™ìƒì˜ ë°˜ë³µ QR ì…ë ¥ ì‹œ ê²½ê³ **
- ì§§ì€ ì‹œê°„ ë‚´ ë™ì¼ í•™ìƒ QR ë°˜ë³µ ì…ë ¥ ê°ì§€
- ë¶€ì •í–‰ìœ„ ì˜ì‹¬ ì‹œ ë³¸ì¸ ì¸ì¦ ìš”ì²­

**5) AI ê¸°ë°˜ "ì¶œì„ ë¶ˆì¼ì¹˜ íŒ¨í„´" ë¶„ì„**
- í•™ìƒì´ QR ì½”ë“œë¥¼ ì‚¬ì§„ ì°ì–´ì„œ ì¹œêµ¬ì—ê²Œ ë³´ë‚´ì¤Œ ê°ì§€
- ì¹œêµ¬ê°€ ëŒ€ì‹  QRì„ ì°ì–´ì¤Œ ê°ì§€
- íŒ¨í„´ ë¶„ì„ ê¸°ë°˜ ì´ìƒ ì¶œê²° ìë™ íƒì§€

**Device Fingerprint ê³„ì‚° ì•Œê³ ë¦¬ì¦˜**

Device FingerprintëŠ” ì¶œê²° ë¶€ì •í–‰ìœ„ ë°©ì§€ë¥¼ ìœ„í•œ ê¸°ê¸° ì‹ë³„ìì´ë‹¤.

**âš ï¸ Device Fingerprint ì‹ ë¢°ë„ ë¶„ë¥˜:**

Device FingerprintëŠ” í”„ë¼ì´ë²„ì‹œ ë¬¸ì œë¡œ ì‹¤ì œ ì›¹ë¸Œë¼ìš°ì €ì—ì„œ reliableí•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤:

- Private Mode, VPN, í•™êµ ê³µìš© ì™€ì´íŒŒì´ í™˜ê²½ì—ì„œ ë§¤ë²ˆ ë‹¤ë¥¸ fingerprint ìƒì„± ê°€ëŠ¥
- **fingerprintëŠ” "low-assurance device indicator"ë¡œ ë¶„ë¥˜í•´ì•¼ í•¨**
- ë†’ì€ ì‹ ë¢°ë„ê°€ í•„ìš”í•œ ê²½ìš° ì¶”ê°€ ì¸ì¦(SMS, ë³¸ì¸ í™•ì¸) í•„ìˆ˜

**ê³„ì‚° ë°©ì‹:**

**ì›¹ ë¸Œë¼ìš°ì €:**
```
device_fingerprint = sha256(
  user_agent +
  ip_address +
  device_id (cookie ê¸°ë°˜) +
  screen_resolution +
  timezone
)
```

**ëª¨ë°”ì¼ ì•±:**
```
device_fingerprint = sha256(
  device_uuid (OS ì œê³µ) +
  app_instance_id +
  device_model
)
```

**Fingerprint ì €ì¥:**
- ì²« ì¶œê²° ì‹œ device_fingerprint ìƒì„± ë° ì €ì¥
- ì´í›„ ì¶œê²° ì‹œ ê¸°ì¡´ fingerprintì™€ ë¹„êµ
- **âš ï¸ ğŸ”¥ 5ë²ˆ: Device Fingerprint ë…¼ë¦¬ ì¼ê´€ì„± í™•ë³´:**

**ë¶€ì •í–‰ìœ„ íƒì§€ì—ì„œ fingerprint ì˜ì¡´ë„ ë‚®ì¶”ê¸°:**

Device FingerprintëŠ” "low-assurance indicator"ì´ë¯€ë¡œ, ë¶€ì •í–‰ìœ„ íŒë‹¨ ì‹œ ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³  **ë³´ì¡° ì§€í‘œ**ë¡œë§Œ í™œìš©:

```typescript
anti_abuse_detection_rule = {
  // Device FingerprintëŠ” ê²½ê³  ìˆ˜ì¤€ìœ¼ë¡œë§Œ ì‚¬ìš©
  fingerprint_check: {
    level: 'warning',  // 'block'ì´ ì•„ë‹Œ 'warning'
    action: 'sms_auth_fallback',  // ë¶ˆì¼ì¹˜ ì‹œ SMS ì¸ì¦ìœ¼ë¡œ ìë™ ì „í™˜
    strict_mode: false  // ì—„ê²© ëª¨ë“œ ë¹„í™œì„±í™” (ê¸°ë³¸ê°’)
  },

  // ì‹¤ì œ ì°¨ë‹¨ì€ ë‹¤ìŒ ì¡°ê±´ì—ì„œë§Œ:
  block_conditions: [
    'gps_out_of_range + fingerprint_mismatch + abnormal_time',  // ë³µí•© ì¡°ê±´
    'repeated_failed_auth_attempts',  // ë°˜ë³µ ì¸ì¦ ì‹¤íŒ¨
    'ai_pattern_anomaly_detected'  // AI íŒ¨í„´ ì´ìƒ íƒì§€
  ],

  // SMS fallback ê°•í™”
  sms_fallback_priority: 'high',  // Fingerprint ë¶ˆì¼ì¹˜ ì‹œ ì¦‰ì‹œ SMS ì¸ì¦
  require_sms_on_fingerprint_mismatch: true  // ë¶ˆì¼ì¹˜ ì‹œ SMS í•„ìˆ˜
}
```

**ë…¼ë¦¬ ì¼ê´€ì„± í™•ë³´:**
- FingerprintëŠ” "low-assurance"ì´ë¯€ë¡œ ë‹¨ë… ì°¨ë‹¨ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- Fingerprint ë¶ˆì¼ì¹˜ ì‹œ â†’ SMS ì¸ì¦ìœ¼ë¡œ ìë™ ì „í™˜ (ì°¨ë‹¨ì´ ì•„ë‹Œ ì¶”ê°€ ì¸ì¦)
- ì‹¤ì œ ì°¨ë‹¨ì€ ë³µí•© ì¡°ê±´(GPS + ì‹œê°„ëŒ€ + AI íŒ¨í„´)ì—ì„œë§Œ ìˆ˜í–‰

**iOS Safari Private Mode ì˜ˆì™¸ ì²˜ë¦¬:**

Private Modeì—ì„œëŠ” localStorage ê¸ˆì§€ ë° device UUID ìƒì„±ì´ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ:

```typescript
fingerprint_fallback = {
  // iOS Safari Private Mode ê°ì§€
  is_private_mode: detect_ios_safari_private_mode(),

  // Fallback ê³„ì‚° ë°©ì‹
  fallback_fingerprint: sha256(
    ip_address +
    user_agent +
    screen_resolution
  ),

  // ë³´ì•ˆ ë“±ê¸‰ ìë™ ì„¤ì •
  security_level: 'low'
}
```

**Private Mode ì²˜ë¦¬ ê·œì¹™:**
- iOS Safari Private Mode ê°ì§€ ì‹œ fingerprint_fallback ì‚¬ìš©
- ë³´ì•ˆ ë“±ê¸‰ì„ 'low'ë¡œ ìë™ ì„¤ì •
- `attendance.device_fingerprint_fallback_policy`ì— ë”°ë¼ ì²˜ë¦¬ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB)):
  - `sms_auth`: SMS ì¸ì¦ ìš”ì²­
  - `block`: ì¶œê²° ê±°ë¶€
  - `warn`: ê²½ê³  í›„ ì¶œê²° í—ˆìš©
- Private Mode ì‚¬ìš© ì´ë ¥ ë¡œê·¸ ê¸°ë¡

**Fingerprint ê°±ì‹  ê·œì¹™:**
- ì •ìƒì ì¸ ê¸°ê¸° ë³€ê²½ ì‹œ (ì˜ˆ: ìƒˆ í° êµ¬ë§¤) ìˆ˜ë™ ê°±ì‹  í—ˆìš©
- ê´€ë¦¬ì ìŠ¹ì¸ í›„ fingerprint ì—…ë°ì´íŠ¸
- ê°±ì‹  ì´ë ¥ ì¶”ì 

**âš ï¸ ğŸ”¥ H4: ì¶œê²° Anti-Abuse Fingerprint ì„¤ëª… í†µì¼:**

**ì •ë³¸ ê·œì¹™ (v3.3 í™•ì •):**

1. **Fingerprint mismatch â†’ SMS ì¸ì¦ fallbackì´ ì •ë³¸**
   - Fingerprint ë¶ˆì¼ì¹˜ ì‹œ ì¦‰ì‹œ SMS ì¸ì¦ìœ¼ë¡œ ìë™ ì „í™˜
   - ì°¨ë‹¨ì´ ì•„ë‹Œ ì¶”ê°€ ì¸ì¦ ìš”ì²­

2. **Fingerprint ë‹¨ë… ì°¨ë‹¨ ê¸ˆì§€**
   - Fingerprintë§Œìœ¼ë¡œëŠ” ì¶œê²° ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ
   - ì‹¤ì œ ì°¨ë‹¨ì€ ë³µí•© ì¡°ê±´(GPS + ì‹œê°„ëŒ€ + AI íŒ¨í„´)ì—ì„œë§Œ ìˆ˜í–‰

**ë¶€ì •í–‰ìœ„ ê°ì§€ ì‹œ ì²˜ë¦¬ (ë³µí•© ì¡°ê±´ ì¶©ì¡± ì‹œ):**
- ì¦‰ì‹œ ì¶œê²° ì²˜ë¦¬ ì¤‘ë‹¨
- ë³¸ì¸ ì¸ì¦ ìš”ì²­ í™”ë©´ í‘œì‹œ
- ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ ì¹´ë“œ ìƒì„±
- ì¶œê²° ì´ë ¥ì— "ì˜ì‹¬" í”Œë˜ê·¸ í‘œì‹œ

**UI ë…¸ì¶œ ë°©ì‹:**
- QR ì¶œê²°ì€ Default Policyì— ë”°ë¼ ë¹„í™œì„±ìœ¼ë¡œ ì„¤ì •ë˜ë©°, ì›ì¥ì´ 'QR ì¶œê²° ì‚¬ìš©' ì„¤ì •ì„ ì¼œì•¼ QR ê¸°ëŠ¥ì´ ë©”ë‰´ì— ë‚˜íƒ€ë‚œë‹¤.
- QR ì¶œê²° ë©”ë‰´ëŠ” Default Policyì— ë”°ë¼ ìˆ¨ê¹€ìœ¼ë¡œ ì„¤ì •ë˜ë©°, ì„¤ì •ì—ì„œ ì¼œë©´ ë…¸ì¶œëœë‹¤.

#### 3.3.7 ì¶œê²° ì„¤ì • (í™˜ê²½ì„¤ì • > ì¶œê²° ì„¤ì •ìœ¼ë¡œ ì´ë™)

**âš ï¸ ì¶œê²° ì„¤ì • í†µí•© ì›ì¹™:**

ì¶œê²° ì„¤ì •ì€ ë°˜ë“œì‹œ `attendance.*` ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¨ì¼ JSON êµ¬ì¡°ë¡œ í†µí•©í•˜ì—¬ ì œì–´í•œë‹¤. (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))
QR ì¸ì¦/ë³´ì¡° ì¸ì¦/í† í° ìœ íš¨ê¸°ê°„/ì§€ê° ê¸°ì¤€/ì¤‘ë³µ ì²´í¬/ì¶œê²° ëª¨ë“œ ì„¤ì • ëª¨ë‘ ì´ JSON ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•œë‹¤.

**âš ï¸ ğŸ”¥ 15ë²ˆ: ì„¤ì • UI ìœ„ì¹˜ í†µì¼:**

**ìµœì¢… UI êµ¬ì¡° (PART 4 ì•ë‹¨ì— ëª…í™•íˆ ì •ë¦¬):**

**ì„¤ì • UI ìœ„ì¹˜ (í™•ì •):**
- **ì¶œê²° ì„¤ì •**: í™˜ê²½ì„¤ì • > ì¶œê²° ì„¤ì • (ì¶œê²° ê´€ë¦¬ í™”ë©´ì—ì„œ ì œê±°)
- **ê³ ê¸‰ ê¸°ëŠ¥**: Advanced ë©”ë‰´ (í¼ì¹˜ê¸° ë°©ì‹)
- **ì‹œìŠ¤í…œ ì„¤ì •**: í™˜ê²½ì„¤ì • > ì‹œìŠ¤í…œ ì„¤ì •

**ì„¤ì • UI ê³„ì¸µ êµ¬ì¡°:**
```
í™˜ê²½ì„¤ì •
â”œâ”€ ì¶œê²° ì„¤ì • (ë³¸ ë¬¸ì„œ 3.3.7 ì„¹ì…˜ ì°¸ì¡°)
â”œâ”€ ì•Œë¦¼ ì„¤ì •
â”œâ”€ ì²­êµ¬ ì„¤ì •
â”œâ”€ ì‹œìŠ¤í…œ ì„¤ì •
â””â”€ Advanced (í¼ì¹˜ê¸°)
   â”œâ”€ ìƒí’ˆ ê´€ë¦¬
   â”œâ”€ ì •ì‚°/ë§¤ì¶œ ìƒì„¸
   â””â”€ í…œí”Œë¦¿ ê´€ë¦¬
```

**ì¤‘ìš”: ì¶œê²° ì„¤ì •ì€ ìš´ì˜ ì´ˆë°˜ì— 1íšŒë§Œ ì„¤ì •í•˜ë¯€ë¡œ, ì¶œê²° ê´€ë¦¬ í™”ë©´ì—ì„œ ì œê±°í•˜ê³  "í™˜ê²½ì„¤ì • > ì¶œê²° ì„¤ì •"ìœ¼ë¡œ ì´ë™í•œë‹¤.**

ì¶œê²°ë²„ìŠ¤ ë§¤ë‰´ì–¼ì— ì¡´ì¬í•˜ëŠ” "ì¶œê²°ë¬¸ì ì„¤ì •" í•­ëª©ì„ ë””ì–´ìŒ¤ tenant_settingsì— ë°˜ì˜.

**attendance.* ê²½ë¡œ ê³µì‹ ìŠ¤í™ (ë‹¨ì¼ ì†ŒìŠ¤, ì €ì¥ ìœ„ì¹˜: tenant_settings(key='config').value(JSONB)):**

ëª¨ë“  ì¶œê²° ê´€ë ¨ ì„¤ì •ì€ ì•„ë˜ JSON êµ¬ì¡°ë¡œ í†µí•© ê´€ë¦¬ëœë‹¤:

```json
{
  "attendance": {
    // ê¸°ë³¸ ì¶œê²° ì„¤ì •
    "late_after_minutes": 10,          // ì§€ê° ê¸°ì¤€ (ë¶„)
    "absent_after_minutes": 60,        // ê²°ì„ ê¸°ì¤€ (ë¶„)
    "allow_duplicate_checkin": false,  // ì¤‘ë³µ ì¶œê²° í—ˆìš© ì—¬ë¶€
    "time_format_24h": true,           // 24ì‹œê°„/12ì‹œê°„ ì„¤ì •
    "default_mode": "pc",              // pc/tablet/mobile/qr

    // QR ì¶œê²° ì„¤ì •
    "qr_enabled": true,                // QR ì¶œê²° ì‚¬ìš© ì—¬ë¶€
    "qr_token_expiry_days": 90,  // QR í† í° ìœ íš¨ê¸°ê°„ (ì¼, ì •ë³¸ ì„¤ì •ê°’)
    "qr_auth_fallback_enabled": true,  // QR ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë³´ì¡° ì¸ì¦ í—ˆìš©
    "sms_auth_fallback_enabled": true, // SMS ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë³´ì¡° ì¸ì¦ í—ˆìš©

    // QR ë³´ì•ˆ ì„¤ì •
    "qr_gps_enabled": false,           // GPS ê¸°ë°˜ í—ˆìš© ë°˜ê²½ ì œí•œ ì‚¬ìš© ì—¬ë¶€
    "qr_gps_radius_meters": 150,       // GPS í—ˆìš© ë°˜ê²½ (ë¯¸í„°)

    // Device Fingerprint ì„¤ì •
    "device_fingerprint_strict": false, // Device Fingerprint ì—„ê²© ëª¨ë“œ (Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ falseë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥, low-assurance indicatorì´ë¯€ë¡œ ê¸°ë³¸ì€ ëŠìŠ¨í•˜ê²Œ)
    "device_fingerprint_fallback_policy": "sms_auth",  // Fingerprint ë¶ˆì¼ì¹˜ ì‹œ ì •ì±…: "sms_auth" | "block" | "warn"

    // ì¶œê²° ì¤‘ë³µ ì²´í¬ ì˜ˆì™¸ ê·œì¹™
    "duplicate_checkin_exceptions": {
      "allow_checkout_after_minutes": 5,  // ë“±ì› í›„ Në¶„ ì´í›„ í•˜ì› ì²´í¬ í—ˆìš©
      "auto_checkout_enabled": true  // í•™ë¶€ëª¨ ì•± ìë™ í•˜ì› ì²˜ë¦¬ í—ˆìš©
    },

    // AI ì˜ˆì¸¡ ëª¨ë¸ í•™ìŠµ ì˜ˆì™¸ ì²˜ë¦¬
    "ai_prediction_learning": {
      "exclude_user_overrides": true,  // ì‚¬ìš©ìê°€ AI ì¶”ì²œì„ ë¬´ì‹œí•œ ê²½ìš° í•™ìŠµì—ì„œ ì œì™¸
      "exception_logging": true  // ì˜ˆì™¸ ë¡œê¹… í™œì„±í™”
    },

    // ì¶œê²° ì´ìƒ ê°ì§€ ì„¤ì • (ìë™í™” ì—°ê³„)
    "absence_threshold_days": 3,  // ê²°ì„ ê°ì§€ ì„ê³„ê°’ (ì¼, Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ 3ì¼ë¡œ ì„¤ì •ê°’ ì €ì¥)
    "anomaly_detection": {
      "enabled": true,  // ì¶œê²° ì´ìƒ ê°ì§€ í™œì„±í™” ì—¬ë¶€ (Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥)
      "threshold": 3  // ì´ìƒ íŒ¨í„´ ê°ì§€ ì„ê³„ê°’ (ì¼, Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ 3ì¼ ì—°ì† ê²°ì„ìœ¼ë¡œ ì„¤ì •ê°’ ì €ì¥)
    },

    // ë°˜ë³„ ì§€ê° ê¸°ì¤€ (ì„ íƒ)
    "class_specific_late_rules": {}  // ì˜ˆ: {"class_1": 10, "class_2": 15}
  }
}
```

**ì„¤ì • í•­ëª© ì„¤ëª…:**
- allow_duplicate_checkin:
  - true: ê°™ì€ í•™ìƒì´ ê°™ì€ ë‚  ì—¬ëŸ¬ ë²ˆ ë“±ì› ì²´í¬ ê°€ëŠ¥(íŠ¹ìˆ˜ ìš´ì˜ í•™ì›)
  - false: ì´ë¯¸ ë“±ì› ê¸°ë¡ì´ ìˆìœ¼ë©´ ì¬ë“±ì›ì„ ë§‰ê³  ì•Œë¦¼ í‘œì‹œ
- time_format_24h:
  - UIì˜ ì‹œê°„ í‘œì‹œë¥¼ 24ì‹œê°„ì œ/12ì‹œê°„ì œë¡œ ë³€ê²½
  - ì¶œê²°ë²„ìŠ¤ì˜ ì„¤ì • í™”ë©´ ê¸°ëŠ¥ì´ ë””ì–´ìŒ¤ Config ëª¨ë¸ê³¼ 1:1 ëŒ€ì‘ë¨

ì„¤ì • UIëŠ” ì ‘ê¸°/í¼ì¹˜ê¸° ê°€ëŠ¥ êµ¬ì¡°ë¡œ ë‹¨ìˆœí™”í•œë‹¤.

**âš ï¸ ì¶œê²° ì„¤ì • í†µí•© êµ¬ì¡° ëª…ì‹œ:**

ì¶œê²° ì„¤ì •(attendance_settings)ì€ ë‹¨ì¼ JSON êµ¬ì¡°(`attendance.*` ê²½ë¡œ)ë¡œ í†µí•©ë˜ì–´ì•¼ í•˜ë©°, QR ì¸ì¦/ë³´ì¡° ì¸ì¦/í† í° ë¡œì§/ì§€ê° ê¸°ì¤€/ì¤‘ë³µ ì²´í¬/ì¶œê²° ëª¨ë“œë„ ëª¨ë‘ ì´ JSON êµ¬ì¡°ì—ì„œ ì œì–´ëœë‹¤. (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))

ë¬¸ì„œ ë‚´ ì—¬ëŸ¬ ìœ„ì¹˜(3.3.5 QR ì¶œê²° ì•„í‚¤í…ì²˜, 3.3.7 ì¶œê²° ì„¤ì •)ì—ì„œ ì¶œê²° ì„¤ì •ì´ ì–¸ê¸‰ë˜ì—ˆë”ë¼ë„ ì‹¤ì œ ë°ì´í„° êµ¬ì¡°ëŠ” í•˜ë‚˜ë§Œ ì¡´ì¬í•œë‹¤.

**âš ï¸ C2: ì¶œê²° ì„¤ì • JSON ë‹¨ì¼ ì •ë³¸ í™•ì •:**

ì¶œê²° ì„¤ì • JSONì€ **3.3.7 ì¶œê²° ì„¤ì •** ì„¹ì…˜ì˜ ìƒì„¸ êµ¬ì¡° ë²„ì „ë§Œ ìœ ì§€í•˜ê³ , ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œëŠ” ì°¸ì¡° í˜•íƒœë¡œë§Œ ì–¸ê¸‰í•©ë‹ˆë‹¤.

**ì •ë³¸ ìœ„ì¹˜:** 3.3.7 ì¶œê²° ì„¤ì •ì˜ `attendance.*` ê²½ë¡œ ê³µì‹ ìŠ¤í™ ì°¸ì¡° (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))

**ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ ì¶œê²° ì„¤ì •ì„ ì–¸ê¸‰í•  ë•Œ:**
- "3.3.7 ì¶œê²° ì„¤ì •ì˜ `attendance.*` ê²½ë¡œ ê³µì‹ ìŠ¤í™ ì°¸ì¡°" í˜•íƒœë¡œë§Œ ì–¸ê¸‰ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))
- ì¤‘ë³µëœ JSON êµ¬ì¡° ì •ì˜ ì œê±°

#### 3.3.8 ì¶œê²° íŒ¨í„´ ë¶„ì„ & AI ì´ìƒ íƒì§€

**ì¤‘ìš”: ì¶œê²° íŒ¨í„´ ë¶„ì„ ë° AI íƒì§€ëŠ” ì‹¤ì œë¡œëŠ” "ë¶„ì„/í†µê³„" ê¸°ëŠ¥ì´ë¯€ë¡œ, ì¶œê²° ê´€ë¦¬ í™”ë©´ì—ì„œ ì œê±°í•˜ê³  "í†µê³„" ë˜ëŠ” "AI ì¸ì‚¬ì´íŠ¸" ë©”ë‰´ë¡œ ì´ë™í•œë‹¤.**

**ì°¸ê³ :** ì´ ê¸°ëŠ¥ì˜ ìƒì„¸ ë‚´ìš©ì€ ë³¸ ì„¹ì…˜(3.3.8)ì—ë§Œ ì •ì˜ë˜ì–´ ìˆìœ¼ë©°, í†µê³„(3.6) ë° AI ì¸ì‚¬ì´íŠ¸(3.7) ë©”ë‰´ì—ì„œë„ ë™ì¼í•œ ë°ì´í„°ì™€ ë¶„ì„ ë¡œì§ì„ í™œìš©í•œë‹¤.

**ë°ì´í„° ìˆ˜ì§‘**

core-analyticsëŠ” ë‹¤ìŒ í•„ë“œë¥¼ ê°€ì§„ `attendance_daily`(ì§‘ê³„ í…Œì´ë¸”)ë¥¼ ë¶„ì„ ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš©:

**âš ï¸ ì¶œê²° í…Œì´ë¸” ëª…ëª… í†µì¼:**
- `attendance_logs`: ì¶œê²° ì›ë³¸ ë¡œê·¸ (ì›ë³¸ í…Œì´ë¸”)
- `attendance_daily`: ì¼ë³„ ì§‘ê³„ ë°ì´í„° (ì§‘ê³„ í…Œì´ë¸”, ë¶„ì„ ëŒ€ìƒ)
- tenant_id
- student_id
- class_id
- occurred_at
- status (present/late/absent/leave_early ë“±)
- source (pc/tablet/mobile/qr)

**ì¼ ë‹¨ìœ„/ì£¼ ë‹¨ìœ„ rollup í…Œì´ë¸” ìƒì„±:**
- daily_attendance_stats
- class_attendance_heatmap

**ë°˜ë³„ ì¶œê²° íˆíŠ¸ë§µ**

ì¶•:
- Xì¶•: ìš”ì¼(ì›”~ì¼)
- Yì¶•: ì‹œê°„ëŒ€(ì˜ˆ: 1ì‹œê°„ ë‹¨ìœ„)

ê°’:
- ì¶œì„ë¥ , ì§€ê°ë¥ , ê²°ì„ë¥ 

UI:
- í…Œì´ë¸”í˜• Heatmap (ìƒ‰ìƒ ë‹¨ê³„ë¡œ ì§„í•˜ê¸° í‘œì‹œ)

**ìš”ì¼Â·ì‹œê°„ëŒ€ íŒ¨í„´ ë¶„ì„**

ì§€í‘œ:
- íŠ¹ì • ìš”ì¼/ì‹œê°„ëŒ€ì— ë°˜ë³µë˜ëŠ” ì§€ê°Â·ê²°ì„ íŒ¨í„´
- í•™ì› ì „ì²´ vs ë°˜ë³„ ë¹„êµ

ê²°ê³¼:
- "í™”ìš”ì¼ 18~20ì‹œ ì§€ê°ë¥  â†‘" ê°™ì€ Insight ìƒì„±

**AI ê¸°ë°˜ ì´ìƒ ì¶œê²° íƒì§€**

ê¸°ë³¸ ê·œì¹™ ê¸°ë°˜:
- ë‹¨ê¸°ê°„ ë‚´ ê¸‰ê²©í•œ ê²°ì„ ì¦ê°€
- íŠ¹ì • í•™ìƒì˜ ê°‘ì‘ìŠ¤ëŸ¬ìš´ íŒ¨í„´ ë³€í™”
- íŠ¹ì • ë°˜/ìš”ì¼ì—ì„œ ë¹„ì •ìƒ íŒ¨í„´

í–¥í›„:
- ML ëª¨ë¸ ì—°ë™ ê°€ëŠ¥í•˜ë„ë¡ anomaly_score ì»¬ëŸ¼ ì˜ˆì•½

#### 3.3.9 í‚¤ì˜¤ìŠ¤í¬/íƒœë¸”ë¦¿ ëª¨ë“œ

**íƒœë¸”ë¦¿ ì „ìš© ëª¨ë“œì˜ ì»´í¬ë„ŒíŠ¸ ê·œê²©**

íƒœë¸”ë¦¿/í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œë¥¼ ìœ„í•œ êµ¬ì²´ì ì¸ ê¸°ìˆ  ê·œê²©:

**â‘  í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ ì „ìš© ì»´í¬ë„ŒíŠ¸ ê·œê²©**

**ë²„íŠ¼ ìµœì†Œ ë„ˆë¹„/ë†’ì´:**
- ìµœì†Œ ë„ˆë¹„: 120px
- ìµœì†Œ ë†’ì´: 60px
- í„°ì¹˜ ì˜ì—­ ìµœì†Œ 48px ê·œì¹™ ì¤€ìˆ˜

**í°íŠ¸ í¬ê¸°:**
- ê¸°ë³¸ í…ìŠ¤íŠ¸: ìµœì†Œ 16px
- ë²„íŠ¼ í…ìŠ¤íŠ¸: ìµœì†Œ 18px
- ì œëª©: ìµœì†Œ 24px

**í„°ì¹˜ ì˜ì—­:**
- ëª¨ë“  í´ë¦­ ê°€ëŠ¥ ìš”ì†ŒëŠ” ìµœì†Œ 48px Ã— 48px
- ë²„íŠ¼ ê°„ ê°„ê²©: ìµœì†Œ 8px

**ì˜¤í”„ë¼ì¸ ìºì‹±:**
- ì¶œê²° ë°ì´í„°ëŠ” ë¡œì»¬ ìºì‹œ ì €ì¥
- ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹œ ìë™ ë™ê¸°í™”
- ì˜¤í”„ë¼ì¸ ìƒíƒœ í‘œì‹œ

**ì˜¤í”„ë¼ì¸ ì¶œê²° ë™ê¸°í™” ì¶©ëŒ ì „ëµ:**

ì˜¤í”„ë¼ì¸ì—ì„œ ìƒì„±ëœ ì¶œê²° ë°ì´í„°ê°€ ì„œë²„ì™€ ë™ê¸°í™”ë  ë•Œ ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„í‚¤í…ì²˜ ë ˆë²¨ì—ì„œì˜ ì¶©ëŒ í•´ê²° ë°©í–¥:

1. **Version/Timestamp ê¸°ë°˜ ë³‘í•©:**
   - `attendance_logs` í…Œì´ë¸”ì— `version` ë˜ëŠ” `last_modified_at` í•„ë“œ ê¸°ë°˜ ì¶©ëŒ ê°ì§€
   - ì„œë²„ ë²„ì „ì´ ë” ìµœì‹ ì´ë©´ ì„œë²„ ë°ì´í„° ìš°ì„ , ë¡œì»¬ ë²„ì „ì´ ë” ìµœì‹ ì´ë©´ ë¡œì»¬ ë°ì´í„° ìš°ì„  (Last Writer Wins)

2. **ì¶©ëŒ ì‹œ ê²€í†  í•„ìš” ìƒíƒœ:**
   - ì¶©ëŒ ê°ì§€ ì‹œ ì¶œê²° ìƒíƒœë¥¼ "ê²€í†  í•„ìš”" ìƒíƒœë¡œ ì„¤ì •
   - ê´€ë¦¬ì UIì—ì„œ ì¶©ëŒëœ ì¶œê²° ë‚´ì—­ì„ í™•ì¸í•˜ê³  ìˆ˜ë™ìœ¼ë¡œ ë³‘í•© ê°€ëŠ¥

3. **ê¶Œí•œ ê²½ê³„ ì •ì±…:**
   - ì¶œê²° ìˆ˜ì • ê¶Œí•œì€ `staff_role`ê³¼ ì¶œê²° ì´ë²¤íŠ¸ ìƒì„± ì‹œì (`event_age`)ì— ë”°ë¼ ì œí•œ
   - ì˜ˆ: ì¶œì„ í›„ 1ì‹œê°„ ì´ë‚´ëŠ” êµì‚¬(`staff_role >= TEACHER`) ìˆ˜ì • ê°€ëŠ¥, ê·¸ ì´í›„ëŠ” ê´€ë¦¬ì(`staff_role >= MANAGER`)ë§Œ ìˆ˜ì • ê°€ëŠ¥
   - RLS ì •ì±…ê³¼ ì—°ê³„í•˜ì—¬ `staff_role >= MANAGER AND event_age < X ì¼` ì¡°ê±´ìœ¼ë¡œ ì ‘ê·¼ ì œì–´

**â‘¡ íƒœë¸”ë¦¿ íšŒì „(landscape) ê¸°ì¤€ ë ˆì´ì•„ì›ƒ ê·œì¹™**

**ê°€ë¡œ ëª¨ë“œ(Landscape):**
- ì¶œê²° í™”ë©´: 2ì—´ ë ˆì´ì•„ì›ƒ
- í•™ìƒ ë¦¬ìŠ¤íŠ¸: ê·¸ë¦¬ë“œ í˜•íƒœ
- ë²„íŠ¼ ì˜ì—­: í•˜ë‹¨ ê³ ì •

**ì„¸ë¡œ ëª¨ë“œ(Portrait):**
- ì¶œê²° í™”ë©´: 1ì—´ ë ˆì´ì•„ì›ƒ
- í•™ìƒ ë¦¬ìŠ¤íŠ¸: ë¦¬ìŠ¤íŠ¸ í˜•íƒœ
- ë²„íŠ¼ ì˜ì—­: ìš°ì¸¡ ê³ ì •

**ë°˜ì‘í˜• ì „í™˜:**
- í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì¦‰ì‹œ ë ˆì´ì•„ì›ƒ ì¬ì¡°ì •
- ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ ìµœì†Œí™” (ì„±ëŠ¥ ìš°ì„ )

### 3.4 ìˆ˜ë‚©Â·ì²­êµ¬(Billing & Payment)

#### 3.4.1 ìˆ˜ë‚© ê´€ë¦¬ í™ˆ(Home) â€” ì„œë²„ê°€ ì²­êµ¬ ìƒì„± ì§„í–‰ í˜„í™© ëŒ€ì‹œë³´ë“œ

**ë¼ìš°íŒ… ë° í™”ë©´ êµ¬ì¡°**

ìˆ˜ë‚© ë©”ë‰´ ì²« ì§„ì… ì‹œ ë¼ìš°íŠ¸ëŠ” `/billing/home`ì´ë©°, ê¸°ë³¸ í™”ë©´ì€ ìë™ ì²­êµ¬ ì§„í–‰ í˜„í™© ëŒ€ì‹œë³´ë“œì´ë‹¤.

ì²­êµ¬/ìˆ˜ë‚© ìƒì„¸ ëª©ë¡ì€ `/billing/list`ë¡œ ë¶„ë¦¬ë˜ë©°, í™ˆ í™”ë©´ì—ì„œëŠ” ë³„ë„ì˜ "ì „ì²´ ì²­êµ¬ì„œ ë³´ê¸°" ë²„íŠ¼ìœ¼ë¡œë§Œ ì§„ì… ê°€ëŠ¥í•˜ë‹¤.

**Auto-Billing ëª¨ë¸ (Zero-Interaction Principle)**

**ëª¨ë“  ì²­êµ¬ì„œëŠ” ì„œë²„ê°€ ìƒì„± â†’ ê´€ë¦¬ìê°€ ë°œì†¡ ë²„íŠ¼ ëˆ„ë¥¼ í•„ìš” ì—†ìŒ**
- ì›” ì„œë²„ê°€ ì²­êµ¬ ìƒì„± (ë°°ì¹˜)
- ì„œë²„ê°€ ì²­êµ¬ì„œ ë°œì†¡ (ì„¤ì • ê¸°ë°˜)

**ë¯¸ë‚©ì€ ìë™ ì•Œë¦¼(ìŠ¤ì¼€ì¤„ ê¸°ë°˜ + AI íƒ€ì´ë° ì¶”ì²œ)**
- AIê°€ ìµœì  ì•Œë¦¼ ì‹œì  ì¶”ì²œ
- ìë™ ì¬ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì‹¤í–‰

**ê²°ì œ ì‹¤íŒ¨ ì‹œ ì •ì±… ê¸°ë°˜ ì¬ì‹œë„ ì‹¤í–‰ (Policy ê¸°ë°˜)**
- ê²°ì œ ì‹¤íŒ¨ ê°ì§€ ì‹œ ìë™ ì¬ì‹œë„
- ê´€ë¦¬ì ê°œì… ìµœì†Œí™”

**í™ˆ í™”ë©´ ê¸°ë³¸ êµ¬ì„± (ëŒ€ì‹œë³´ë“œ ì¤‘ì‹¬)**

**ì´ë²ˆë‹¬ ì˜ˆìƒ ìˆ˜ë‚©ë¥  ì¹´ë“œ**
- ì„œë²„ê°€ ì˜ˆìƒ ìˆ˜ë‚©ë¥  ê³„ì‚° ë° í‘œì‹œ (AI í˜¸ì¶œ í¬í•¨)
- ì›”ë§ ì²­êµ¬ ìš”ì•½ ì¹´ë“œ ìš°ì„ ìˆœìœ„ ê°€ì¤‘ì¹˜ ì¦ê°€ (ê°•ì¡° í‘œì‹œ, ê·¸ë£¹ ìˆœì„œëŠ” ë¶ˆë³€, Adaptive UI)

**ì„œë²„ê°€ ì²­êµ¬ ìƒì„± ì§„í–‰ í˜„í™©**
- ì´ë²ˆ ë‹¬ ì„œë²„ê°€ ìƒì„±í•œ ì²­êµ¬ì„œ ìˆ˜
- ë°œì†¡ ì™„ë£Œ / ë°œì†¡ ëŒ€ê¸° / ë°œì†¡ ì‹¤íŒ¨ í˜„í™©
- ìë™ ì²­êµ¬ ì§„í–‰ë¥  í‘œì‹œ

**ê²°ì œ í˜„í™© ìš”ì•½**
- ë‚©ë¶€ ì™„ë£Œ / ë¯¸ë‚© / ë¶€ë¶„ë‚©ë¶€ í˜„í™©
- ê²°ì œ ì‹¤íŒ¨ ìë™ ì¬ì‹œë„ í˜„í™©
- ì£¼ìš” ì§€í‘œ (ìˆ˜ë‚©ë¥ , ë¯¸ë‚©ë¥  ë“±)

**ë¯¸ë‚© ì•Œë¦¼ ì§„í–‰ í˜„í™©**
- ìë™ ë¯¸ë‚© ì•Œë¦¼ ë°œì†¡ í˜„í™©
- AI ì¶”ì²œ íƒ€ì´ë° ê¸°ë°˜ ì•Œë¦¼ ìŠ¤ì¼€ì¤„
- ì•Œë¦¼ ë°œì†¡ ì„±ê³µ/ì‹¤íŒ¨ í˜„í™©

**ê¸´ê¸‰ ì•Œë¦¼ ì¹´ë“œ**
- ê²°ì œ ì‹¤íŒ¨ ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš”
- ë¯¸ë‚© í•™ìƒ ì¦‰ì‹œ ì—°ë½ í•„ìš”
- ìë™ ì¬ì‹œë„ ì‹¤íŒ¨ ì•Œë¦¼

**Billing Home ì¹´ë“œ ë…¸ì¶œ ì¡°ê±´:**

ì¹´ë“œ ë…¸ì¶œì€ ì•„ë˜ ì¡°ê±´ì— ë”°ë¼ ê²°ì •ëœë‹¤:

```typescript
billing_home_card_visibility = {
  // ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œê°€ 1ê±´ë„ ì—†ìœ¼ë©´ ëª¨ë“  ì¹´ë“œëŠ” "ì¤€ë¹„ ì¤‘"ìœ¼ë¡œ í‘œì‹œ
  no_invoices_this_month: {
    condition: 'count(invoices where period_start >= current_month) = 0',
    action: 'show_placeholder_card',
    message: 'ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
  },

  // ê²°ì œ ìˆ˜ë‹¨ ë¯¸ë“±ë¡ ì‹œ "ê²°ì œìˆ˜ë‹¨ ì„¤ì • í•„ìš”" ì¹´ë“œ ìµœìƒë‹¨ ë…¸ì¶œ
  no_payment_method: {
    condition: 'count(payment_methods where tenant_id = current_tenant) = 0',
    action: 'show_urgent_card',
    priority: 1,
    message: 'ê²°ì œìˆ˜ë‹¨ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.'
  }
}
```

**ì¹´ë“œ ë…¸ì¶œ ìš°ì„ ìˆœìœ„:**
1. ê²°ì œìˆ˜ë‹¨ ë¯¸ë“±ë¡ ì¹´ë“œ (ìµœìƒë‹¨ ê³ ì •)
2. ê¸´ê¸‰ ì•Œë¦¼ ì¹´ë“œ
3. ì´ë²ˆë‹¬ ì˜ˆìƒ ìˆ˜ë‚©ë¥  ì¹´ë“œ
4. ìë™ ì²­êµ¬ ì§„í–‰ í˜„í™©
5. ê²°ì œ í˜„í™© ìš”ì•½
6. ë¯¸ë‚© ì•Œë¦¼ ì§„í–‰ í˜„í™©

**âš ï¸ ğŸ”¥ H2: Billing Home ì¹´ë“œ ìš°ì„ ìˆœìœ„ ì¶©ëŒ í•´ê²°:**

**ëª…í™•í•œ ê·œì¹™:**

1. **Billing Home ìš°ì„ ìˆœìœ„ëŠ” Billing í™”ë©´(`/billing/home`)ì—ì„œë§Œ ì ìš©**
   - Billing ë©”ë‰´ ë‚´ë¶€ì—ì„œë§Œ í•´ë‹¹ ìš°ì„ ìˆœìœ„ ì‚¬ìš©
   - Billing í™”ë©´ì—ì„œëŠ” Billing Home ìš°ì„ ìˆœìœ„ ê·œì¹™ ë”°ë¦„

2. **Home í™”ë©´(`/home`)ì€ Home Dashboard Ruleë§Œ ë”°ë¦„**
   - Home í™”ë©´ì—ì„œëŠ” Billing ì¹´ë“œê°€ Home Dashboard Priority Tableì— ë”°ë¼ ì¬ì •ë ¬
   - Billing Home ìš°ì„ ìˆœìœ„ëŠ” Home í™”ë©´ì—ì„œ ë¬´ì‹œë¨

**Billing Home(`/billing/home`)ì˜ ì¹´ë“œ ìš°ì„ ìˆœìœ„ëŠ” Billing ë©”ë‰´ ë‚´ë¶€ì—ì„œë§Œ ì ìš©ë˜ë©°, í™ˆ ëŒ€ì‹œë³´ë“œ(`/home`)ì—ì„œëŠ” Home ëŒ€ì‹œë³´ë“œ ìš°ì„ ìˆœìœ„ ê·œì¹™ì— ë§ê²Œ ì¬ì •ë ¬ëœë‹¤:**

```typescript
card_priority_integration = {
  // Billing ë©”ë‰´ ë‚´ë¶€ (/billing/home)
  billing_home_priority: {
    scope: '/billing/home',
    rules: [
      'ê²°ì œìˆ˜ë‹¨ ë¯¸ë“±ë¡',
      'ê¸´ê¸‰ ì•Œë¦¼',
      'ì˜ˆìƒ ìˆ˜ë‚©ë¥ ',
      'ìë™ ì²­êµ¬ ì§„í–‰ í˜„í™©',
      'ê²°ì œ í˜„í™©'
    ]
  },

  // í™ˆ ëŒ€ì‹œë³´ë“œ (/home)
  home_dashboard_priority: {
    scope: '/home',
    rules: [
      'Emergency (ê¸´ê¸‰ ì•Œë¦¼)',
      'AI Briefing',
      'Student Tasks',
      'Classes',
      'Stats',
      'Billing Summary'  // Billing ì¹´ë“œëŠ” ìš”ì•½ í˜•íƒœë¡œë§Œ í‘œì‹œ
    ]
  },

  // ì¹´ë“œ ìœ í˜•ë³„ Global Priority Mapping Table
  global_priority_mapping = {
    // Billing Homeì˜ "ê²°ì œ ìˆ˜ë‹¨ ì—†ìŒ" ì¹´ë“œ
    'billing_no_payment_method': {
      billing_home_priority: 1,      // Billing Homeì—ì„œ ìµœìš°ì„ 
      home_dashboard_priority: 2,    // Homeì—ì„œëŠ” Emergency ë‹¤ìŒ
      group_id: 'EMERGENCY',          // Emergency ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¥˜
      convert_to_emergency: true      // Homeì—ì„œëŠ” Emergency ì¹´ë“œë¡œ ë³€í™˜
    },

    // Billing Homeì˜ "ê¸´ê¸‰ ì•Œë¦¼" ì¹´ë“œ
    'billing_urgent_alert': {
      billing_home_priority: 2,
      home_dashboard_priority: 1,   // Homeì—ì„œëŠ” ìµœìš°ì„ 
      group_id: 'EMERGENCY'
    },

    // Billing Homeì˜ "ì˜ˆìƒ ìˆ˜ë‚©ë¥ " ì¹´ë“œ
    'billing_expected_collection_rate': {
      billing_home_priority: 3,
      home_dashboard_priority: 5,    // Homeì—ì„œëŠ” Billing Summary ê·¸ë£¹
      group_id: 'BILLING',
      convert_to_summary: true        // ìš”ì•½ í˜•íƒœë¡œ ë³€í™˜
    }
  },

  // ì¹´ë“œ í†µí•© ê·œì¹™
  integration_rule: {
    // í™ˆ í™”ë©´ì—ì„œëŠ” Billing ì¹´ë“œê°€ Home ìš°ì„ ìˆœìœ„ì— ë§ê²Œ ì¬ì •ë ¬
    on_home_dashboard: {
      billing_cards: 'convert_to_summary_card',
      priority: 'follow_global_priority_mapping',
      merge_with_student_tasks: false,

      // êµ¬ì²´ì  ìš°ì„ ìˆœìœ„ ë³€í™˜
      priority_conversion: {
        // Billing Homeì˜ "ê²°ì œ ìˆ˜ë‹¨ ì—†ìŒ"ì€ Homeì—ì„œ Emergency ê·¸ë£¹ìœ¼ë¡œ ì´ë™
        'billing_no_payment_method': {
          from: { scope: 'billing_home', priority: 1 },
          to: { scope: 'home', group: 'EMERGENCY', priority: 2 }
        }
      }
    }
  }
}
```

**í†µí•© ê·œì¹™ ì ìš©:**
- Billing Homeì€ Billing ë©”ë‰´ ë‚´ë¶€ì—ì„œë§Œ ì ìš©
- í™ˆ í™”ë©´ì—ì„œëŠ” Billing ì¹´ë“œê°€ Home ëŒ€ì‹œë³´ë“œ ìš°ì„ ìˆœìœ„ì— ë§ê²Œ ì¬ì •ë ¬
- ì¹´ë“œ ìš°ì„ ìˆœìœ„ ì²´ê³„ê°€ ë©”ë‰´ë³„/í™ˆë³„ êµ¬ë¶„ë˜ì–´ì•¼ í•¨
- Global Priority Mapping Tableì„ í†µí•´ êµ¬ì²´ì  ìš°ì„ ìˆœìœ„ ë³€í™˜ ê·œì¹™ ëª…ì‹œ

**"ì¤€ë¹„ ì¤‘" ìƒíƒœ ì²˜ë¦¬:**
- ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œê°€ ì—†ìœ¼ë©´ ëª¨ë“  ì¹´ë“œì— "ì¤€ë¹„ ì¤‘" í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
- ìë™ ì²­êµ¬ ë°°ì¹˜ ì‹¤í–‰ ì „ê¹Œì§€ "ì¤€ë¹„ ì¤‘" ìœ ì§€
- ì‚¬ìš©ìì—ê²Œ ìë™ ì²­êµ¬ ì˜ˆì • ì‹œê°„ ì•ˆë‚´

#### 3.4.2 ì „ì²´ ì²­êµ¬/ìˆ˜ë‚© ëª©ë¡(List View) â€” ê²€ìƒ‰ ë° ìƒì„¸

**ì—­í•  ë° ì§„ì… ê²½ë¡œ**

ì´ í™”ë©´ì€ ì—…ë¬´ í™ˆì´ ì•„ë‹Œ "ê³ ê¸‰/ìƒì„¸ ì¡°íšŒ ê¸°ëŠ¥"ì´ë©°, ê¸°ë³¸ ì§„ì… ë™ì„ ì€ ìˆ˜ë‚© í™ˆ(ëŒ€ì‹œë³´ë“œ)ì—ì„œ "ì „ì²´ ì²­êµ¬ì„œ ë³´ê¸°" ë²„íŠ¼ ë˜ëŠ” ìƒë‹¨ íƒ­ ì „í™˜ì„ í†µí•´ì„œë§Œ ê°€ëŠ¥í•˜ë‹¤.

**ë¼ìš°íŒ…:** `/billing/list`

**ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œ ë³´ê¸°**
- í˜„ì¬ ì›” ì²­êµ¬ ë‚´ì—­ ì¡°íšŒ (ì„œë²„ê°€ ìƒì„±)
- í•™ìƒë³„ ì²­êµ¬ ìƒíƒœ í™•ì¸
- ìƒì„¸ í•„í„° ë° ê²€ìƒ‰ ê¸°ëŠ¥

**ê²°ì œ ìƒíƒœ ë³´ê¸°**
- ë‚©ë¶€ ì™„ë£Œ/ë¯¸ë‚© ìƒíƒœ í™•ì¸
- ê²°ì œ ë‚´ì—­ ì¡°íšŒ
- ê²°ì œ ì‹¤íŒ¨ ìë™ ì¬ì‹œë„ í˜„í™©

**ë¯¸ë‚© ê´€ë¦¬**
- ë¯¸ë‚© í•™ìƒ ëª©ë¡ ì¡°íšŒ
- AI ì¶”ì²œ íƒ€ì´ë° ê¸°ë°˜ ì •ì±… í•´ì„ í›„ ë¯¸ë‚© ì•Œë¦¼ (Policy ê¸°ë°˜)

#### 3.4.3 Partial Payment (ë¶€ë¶„ë‚©ë¶€) ëª…ì„¸

ì¶œê²°ë²„ìŠ¤Â·ì•Œë¦¼ë±…í¬ ë§¤ë‰´ì–¼ ê¸°ì¤€ìœ¼ë¡œ í•™ì›ì—ì„œëŠ” ì¼ë¶€ ë‚©ë¶€ ê¸°ëŠ¥ì´ ë§¤ìš° ë¹ˆë²ˆí•¨.

**ë¶€ë¶„ë‚©ë¶€ ì²˜ë¦¬:**

```
invoice.amount_due = invoice.amount - sum(payments.amount)
invoice.amount_paid = sum(payments.amount where status = 'paid')
```

- ì²­êµ¬ ê¸ˆì•¡ì—ì„œ ì‹¤ì œ ë‚©ë¶€ ê¸ˆì•¡ì„ ì°¨ê°í•œ ë¯¸ë‚© ê¸ˆì•¡ ê³„ì‚°
- ë¶€ë¶„ë‚©ë¶€ ì‹œ amount_dueëŠ” 0ë³´ë‹¤ í¬ê³  amountë³´ë‹¤ ì‘ìŒ
- **amount_paid**: `sum(payments.amount)`ë¥¼ ë¹„ë™ê¸° ì§‘ê³„í•˜ì—¬ ìºì‹œí•œ ê°’ (ì„±ëŠ¥ ìµœì í™”ìš©)

**âš ï¸ Partial Payment API ìŠ¤í™:**

```typescript
// Edge Function: fns-payment-partial
POST /api/payments/partial

Request:
{
  invoice_id: uuid,
  amount: number,
  payment_method: 'bank' | 'card' | 'easy_pay',
  payment_date: timestamp
}

Response:
{
  payment_id: uuid,
  invoice_status: 'partial' | 'paid',
  amount_due: number,
  amount_paid: number
}

// ì²˜ë¦¬ ë¡œì§:
// 1. payments í…Œì´ë¸”ì— ìƒˆ ë ˆì½”ë“œ ìƒì„±
// 2. invoice.amount_paid = sum(payments.amount where status = 'paid')
// 3. invoice.amount_due = invoice.amount - invoice.amount_paid
// 4. invoice.status ì—…ë°ì´íŠ¸ (partial ë˜ëŠ” paid)
```

**invoice.status:**
- partial: ì¼ë¶€ë‚© (amount_due > 0 AND amount_due < amount)
- paid: ì™„ë‚© (amount_due = 0)
- unpaid: ë¯¸ë‚© (amount_due = amount)

**Webhook ìˆ˜ì‹  ì‹œ ì²˜ë¦¬ ê·œì¹™:**

**ê²°ì œ ê¸ˆì•¡ < invoice.amount â†’ partial**
- ë¶€ë¶„ë‚©ë¶€ë¡œ ì²˜ë¦¬
- invoice.statusë¥¼ 'partial'ë¡œ ì—…ë°ì´íŠ¸
- amount_due ì¬ê³„ì‚°

**ê²°ì œ ê¸ˆì•¡ == invoice.amount â†’ paid**
- ì™„ë‚©ìœ¼ë¡œ ì²˜ë¦¬
- invoice.statusë¥¼ 'paid'ë¡œ ì—…ë°ì´íŠ¸
- amount_due = 0

**ê²°ì œ ê¸ˆì•¡ > invoice.amount â†’ ì˜¤ë¥˜ or ì”ì•¡ ë³´ì •**
- ì˜¤ë¥˜ ì²˜ë¦¬: ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ ì¹´ë“œ ìƒì„±
- ì”ì•¡ ë³´ì • ì˜µì…˜: ì´ˆê³¼ ë‚©ë¶€ ê¸ˆì•¡ì„ ë‹¤ìŒ ì²­êµ¬ì„œì— ìë™ ë°˜ì˜
- ì´ˆê³¼ ë‚©ë¶€ ì´ë ¥ ì¶”ì 

**Payment Webhook ì˜ˆì™¸ ì¼€ì´ìŠ¤ ì²˜ë¦¬:**

**Webhook ì§€ì—° ë„ì°© ì²˜ë¦¬:**

**âš ï¸ ì´ì „ ë‹¬ ì²­êµ¬ì„œê°€ ì´ë¯¸ ë§ˆê°ëœ ê²½ìš° ì²˜ë¦¬:**

ì´ì „ ë‹¬ ì²­êµ¬ì„œê°€ ì´ë¯¸ ë§ˆê°ëœ ê²½ìš° ì•„ë˜ ì „ëµì„ ì ìš©í•œë‹¤:

```typescript
// âš ï¸ ğŸ”¥ H3: Payment Webhook ë§ˆê°ëœ invoice ì²˜ë¦¬ ì „ëµ ìš°ì„ ìˆœìœ„ ëª…í™•í™”
// âš ï¸ ğŸ”¥ 7ë²ˆ: Payment Webhook ì§€ì—° ì²˜ë¦¬ ë‹¨ìˆœí™” (ì‹¤ì œ êµ¬í˜„ ë‚œì´ë„ ê³ ë ¤)
closed_invoice_payment_strategy = {
  // ìƒìš©í™” ë‹¨ê³„ ì „ëµ (Default Policy, ìš°ì„ ìˆœìœ„ 1)
  mvp_strategy: {
    // ì „ëµ 1: ë§ˆê°ëœ invoiceë¥¼ reopened (ìƒìš©í™” ë‹¨ê³„ Default Policy)
    reopen_closed_invoice: {
      enabled: true,  // Default Policy: ìƒìš©í™” ë‹¨ê³„ì—ì„œ í…Œë„ŒíŠ¸ ìƒì„± ì‹œ enabled=trueë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥
      priority: 1,    // ìµœìš°ì„  ì „ëµ
      condition: 'invoice.status = "closed" AND payment.amount > 0',
      action: 'invoice.status = "reopened", invoice.closed_at = null',
      log: 'invoice_reopened_log',
      require_admin_approval: false
    }
  },

  // Advanced ì „ëµ (ì„¤ì •ì—ì„œ í™œì„±í™” ê°€ëŠ¥, ìš°ì„ ìˆœìœ„ 2-3)
  advanced_strategies: {
    // ì „ëµ 2: ì´ˆê³¼/ì§€ì—° ê²°ì œ ê¸ˆì•¡ì„ ë‹¤ìŒ ë‹¬ë¡œ ìë™ ì´ì›”
    carry_over_to_next_month: {
      enabled: false,  // Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ enabled=falseë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥, Advanced ëª¨ë“œì—ì„œë§Œ í™œì„±í™” ê°€ëŠ¥
      priority: 2,     // Advanced ì „ëµ 1ìˆœìœ„
      condition: 'invoice.status = "closed" AND payment.amount > invoice.amount',
      action: 'create_credit_note, apply_to_next_invoice',
      log: 'carry_over_log',
      require_admin_approval: true,
      requires_advanced_mode: true
    },

    // ì „ëµ 3: íšŒê³„ ìƒ ì¶©ëŒ ì‹œ ê´€ë¦¬ì ìˆ˜ë™ ì²˜ë¦¬ ìš”ì²­
    accounting_conflict: {
      enabled: false,  // Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ enabled=falseë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥, Advanced ëª¨ë“œì—ì„œë§Œ í™œì„±í™” ê°€ëŠ¥
      priority: 3     // Advanced ì „ëµ 2ìˆœìœ„ (ìµœí›„ ìˆ˜ë‹¨)
      condition: 'invoice.status = "closed" AND accounting_period_closed = true',
      action: 'create_admin_alert_card',
      message: 'ë§ˆê°ëœ íšŒê³„ ê¸°ê°„ì— ê²°ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ì¡°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.',
      require_manual_review: true,
      requires_advanced_mode: true
    }
  },

  // ì›” ìˆ˜ë‚© ë§ˆê°(ì›” í´ë¡œì§•) ì²˜ë¦¬
  monthly_closing: {
    // ë§ˆê° ì‹œì : ë§¤ì›” ë§ì¼ 23:59
    closing_time: 'last_day_of_month 23:59',

    // ë§ˆê° í›„ ê²°ì œ ì²˜ë¦¬ (ìƒìš©í™” ë‹¨ê³„: reopenë§Œ)
    post_closing_payment: {
      mvp_strategy: 'reopen_closed_invoice',  // ìƒìš©í™” ë‹¨ê³„ ê¸°ë³¸ ì „ëµ
      advanced_strategies: ['carry_over', 'accounting_conflict'],  // Advanced ëª¨ë“œì—ì„œë§Œ
      require_admin_approval: false  // ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ìë™ ì²˜ë¦¬
    }
  }
}
```

**ì¥ì :**
- ìƒìš©í™” ë‹¨ê³„ êµ¬í˜„ ë‹¨ìˆœí™”: reopenë§Œ êµ¬í˜„í•˜ë©´ ë¨
- Event Engine state explosion ë°©ì§€
- Advanced ëª¨ë“œì—ì„œ í•„ìš” ì‹œ í™•ì¥ ê°€ëŠ¥

**Webhook ì§€ì—° ë„ì°© ì²˜ë¦¬ ê·œì¹™:**
- Webhookì´ ëŠ¦ê²Œ ë„ì°©í•˜ì—¬ ì´ì „ ë‹¬ ì²­êµ¬ì„œì— ë°˜ì˜ë˜ëŠ” ê²½ìš°
- ì²˜ë¦¬ ê·œì¹™:
  - invoice.period_endë¥¼ í™•ì¸í•˜ì—¬ í˜„ì¬ ì›” ì²­êµ¬ì„œì¸ì§€ ê²€ì¦
  - ì´ì „ ë‹¬ ì²­êµ¬ì„œì¸ ê²½ìš° í•´ë‹¹ invoiceì— ë°˜ì˜
  - ì´ì „ ë‹¬ ì²­êµ¬ì„œê°€ ì´ë¯¸ ë§ˆê°ëœ ê²½ìš°: ìœ„ ì „ëµì— ë”°ë¼ ì²˜ë¦¬
  - ìˆ˜ë™ ì¡°ì • ê¸°ëŠ¥ ì œê³µ

**ë§ˆê° ì²˜ë¦¬ ê·œì¹™:**
- ë§ˆê°ëœ invoiceë¥¼ reopened í•  ìˆ˜ ìˆìŒ (ê¶Œí•œ: Adminë§Œ)
- ì´ˆê³¼/ì§€ì—° ê²°ì œ ê¸ˆì•¡ì€ ë‹¤ìŒ ë‹¬ ì²­êµ¬ì„œì— ìë™ ì´ì›”
- íšŒê³„ ìƒ ì¶©ëŒ ì‹œ ê´€ë¦¬ì ìˆ˜ë™ ì²˜ë¦¬ í•„ìˆ˜
- ì›” ìˆ˜ë‚© ë§ˆê°(ì›” í´ë¡œì§•) í›„ ê²°ì œëŠ” ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”

**ë¯¸ë‚© í•´ì†Œ ì‹œ AI ì¹´ë“œ ì œê±°:**
- ë¯¸ë‚© í•´ì†Œ ì²˜ë¦¬ ì‹œ ê´€ë ¨ AI ì¹´ë“œ ìë™ ì œê±°
- ì²˜ë¦¬ ê·œì¹™:
  - invoice.statusê°€ 'unpaid' â†’ 'paid' ë˜ëŠ” 'partial'ë¡œ ë³€ê²½ ì‹œ
  - í•´ë‹¹ í•™ìƒì˜ ë¯¸ë‚© ê´€ë ¨ AI ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ ì •ì±… í•´ì„ í›„ ì‚­ì œ (Policy ê¸°ë°˜)
  - ë¯¸ë‚© ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ
  - ê´€ë ¨ ì´ë²¤íŠ¸ ë¡œê·¸ ê¸°ë¡

**Payment Webhook â†’ ë¯¸ë‚© ì•Œë¦¼ ìë™ ì·¨ì†Œ:**

ê²°ì œê°€ ì„±ê³µí•˜ë©´ í•´ë‹¹ invoiceì— ì˜ˆì•½ëœ ë¯¸ë‚© ì•Œë¦¼ì€ ì¦‰ì‹œ ì·¨ì†Œí•œë‹¤:

```typescript
payment_success_notification_cancel = {
  // ê²°ì œ ì„±ê³µ ì‹œ ë¯¸ë‚© ì•Œë¦¼ ìë™ ì·¨ì†Œ
  on_payment_success: {
    // ì˜ˆì•½ëœ ë¯¸ë‚© ì•Œë¦¼ ì¦‰ì‹œ ì·¨ì†Œ
    cancel_scheduled_notifications: true,

    // ì§€ì—° ë°œì†¡ ëŒ€ê¸° ì¤‘ì¸ ì•Œë¦¼ ì·¨ì†Œ
    cancel_pending_notifications: true,

    // ëŒ€ìƒ: í•´ë‹¹ invoice_idì™€ ì—°ê²°ëœ ëª¨ë“  ë¯¸ë‚© ì•Œë¦¼
    target: 'all_unpaid_notifications_for_invoice',

    // ì·¨ì†Œ ì´ë²¤íŠ¸ ë¡œê·¸ ê¸°ë¡
    log_cancellation: true
  }
}
```

**ë¯¸ë‚© ì•Œë¦¼ ì·¨ì†Œ ê·œì¹™:**
- ê²°ì œ ì„±ê³µ Webhook ìˆ˜ì‹  ì‹œ ì¦‰ì‹œ ì²˜ë¦¬
- ì˜ˆì•½ë°œì†¡/ì§€ì—°ë°œì†¡ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  ë¯¸ë‚© ì•Œë¦¼ ì·¨ì†Œ
- ì·¨ì†Œëœ ì•Œë¦¼ì€ `notification_logs`ì— `cancelled` ìƒíƒœë¡œ ê¸°ë¡

**âš ï¸ Queue ì§€ì—° ê³ ë ¤ Grace Period:**

"í•™ë¶€ëª¨ê°€ ê²°ì œí–ˆëŠ”ë° ë©”ì‹œì§€ë¥¼ 1ë¶„ ëŠ¦ê²Œ ë°›ëŠ” ê²½ìš°" â†’ ì¤‘ë³µ ì•Œë¦¼ ë°œìƒ ê°€ëŠ¥ì„± ë°©ì§€:

```typescript
notification_queue_grace_period = {
  // Queue latency(ì§€ì—°)ë¥¼ ê³ ë ¤í•œ grace-period
  grace_period_seconds: 15,  // 15ì´ˆ grace period

  // ê²°ì œ ì„±ê³µ í›„ 15ì´ˆ ì´ë‚´ ë„ì°©í•œ ë¯¸ë‚© ì•Œë¦¼ì€ ìë™ ì·¨ì†Œ
  cancel_pending_within_grace_period: true,

  // ì‚¬ìš©ìì—ê²Œ "ë°œì†¡ ëŒ€ê¸° ì¤‘" ìƒíƒœ í‘œì‹œ
  show_pending_status: true
}
```
- ì•Œë¦¼ë±…í¬Â·ì¶œê²°ë²„ìŠ¤ ì‹¤ì„œë¹„ìŠ¤ì™€ ë™ì¼í•œ ë™ì‘ ë³´ì¥

**ë¶€ë¶„ë‚©ë¶€ UI:**
- ì²­êµ¬ì„œ ìƒì„¸ í™”ë©´ì— "ë‚©ë¶€ ì§„í–‰ë¥ " í‘œì‹œ
- ë¶€ë¶„ë‚©ë¶€ ë‚´ì—­ í‘œì‹œ (ë‚©ë¶€ì¼, ê¸ˆì•¡, ì”ì•¡)
- ë¯¸ë‚© ê¸ˆì•¡ ê°•ì¡° í‘œì‹œ

ì´ ê¸°ëŠ¥ì´ ì—†ìœ¼ë©´ ì‹¤ì œ í•™ì›ì—ì„œ ìš´ì˜ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

#### 3.4.4 ì¡°ê¸°ë‚©ë¶€(Early Payment) ê·œì¹™

í•™ì› ìš´ì˜ì—ì„œ ìì£¼ ì¡´ì¬í•˜ëŠ” ì¡°ê¸°ë‚©ë¶€ ê¸°ëŠ¥:

**ì¡°ê¸°ë‚©ë¶€ ì„¤ì •:**

```
early_payment_allowed: boolean
- ì¡°ê¸°ë‚©ë¶€ í—ˆìš© ì—¬ë¶€
- Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ falseë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥

early_payment_discount: number | null
- ì¡°ê¸°ë‚©ë¶€ í• ì¸ìœ¨ ë˜ëŠ” í• ì¸ ê¸ˆì•¡
- ì˜ˆ: 5 (5% í• ì¸) ë˜ëŠ” 10000 (10,000ì› í• ì¸)
- nullì¸ ê²½ìš° í• ì¸ ì—†ìŒ

early_payment_period: { start_at: date, end_at: date } | null
- ì¡°ê¸°ë‚©ë¶€ ê°€ëŠ¥ ê¸°ê°„
- nullì¸ ê²½ìš° í•­ìƒ ê°€ëŠ¥
```

**ì¡°ê¸°ë‚©ë¶€ ì²˜ë¦¬:**

**ì¡°ê¸°ë‚©ë¶€ ê¸ˆì•¡ ê³„ì‚°:**
- ì›ë˜ ì²­êµ¬ ê¸ˆì•¡ì—ì„œ í• ì¸ ì ìš©
- early_payment_discountê°€ í¼ì„¼íŠ¸ì¸ ê²½ìš°: amount * (1 - discount / 100)
- early_payment_discountê°€ ê¸ˆì•¡ì¸ ê²½ìš°: amount - discount

**ì¡°ê¸°ë‚©ë¶€ ìƒíƒœ:**
- invoice.status = 'early_paid'
- payment.early_payment = true
- payment.discount_amount ê¸°ë¡

**ì¡°ê¸°ë‚©ë¶€ UI:**
- ì²­êµ¬ì„œì— "ì¡°ê¸°ë‚©ë¶€ í• ì¸" ì˜µì…˜ í‘œì‹œ
- í• ì¸ ê¸ˆì•¡ ë° ìµœì¢… ë‚©ë¶€ ê¸ˆì•¡ í‘œì‹œ
- ì¡°ê¸°ë‚©ë¶€ ê¸°ê°„ ì•ˆë‚´

**âš ï¸ C9: Early Payment í™˜ë¶ˆ ê·œì¹™ê³¼ Billing ì—”ì§„ ì¶©ëŒ í•´ê²°:**

**Early Payment í™˜ë¶ˆ/ì·¨ì†Œ ë¡œì§ (Billing ì—”ì§„ê³¼ í†µí•©):**

í•™ìƒì´ ì¤‘ë„í‡´ì› ì‹œ ì¡°ê¸°ë‚©ë¶€ í• ì¸ ì ìš© ê¸ˆì•¡ì˜ í™˜ë¶ˆ ì²˜ë¦¬ëŠ” **Monthly Closing ë° Carry-Over ê·œì¹™ê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡** ì•„ë˜ ê·œì¹™ì„ ì ìš©í•œë‹¤:

```typescript
early_payment_refund_rule = {
  // ì¡°ê¸°ë‚©ë¶€ í• ì¸ ì ìš© ê¸ˆì•¡ í™˜ë¶ˆ ê³„ì‚°
  refund_calculation: {
    // ì›ë˜ ì²­êµ¬ ê¸ˆì•¡ ê¸°ì¤€ í™˜ë¶ˆ
    original_amount: 'invoice.amount',

    // ì‹¤ì œ ë‚©ë¶€ ê¸ˆì•¡ (í• ì¸ ì ìš© í›„)
    paid_amount: 'payment.amount',

    // í• ì¸ ê¸ˆì•¡
    discount_amount: 'invoice.amount - payment.amount',

    // í™˜ë¶ˆ ê¸ˆì•¡ ê³„ì‚°
    refund_amount: {
      // ì¤‘ë„í‡´ì› ì‹œ ì‹¤ì œ ë‚©ë¶€ ê¸ˆì•¡ ê¸°ì¤€ìœ¼ë¡œ í™˜ë¶ˆ (í• ì¸ ê¸ˆì•¡ì€ í™˜ë¶ˆ ë¶ˆê°€)
      on_withdrawal: 'refund_paid_amount_only',

      // âš ï¸ Monthly Closing ì¶©ëŒ ë°©ì§€:
      // - ì´ë¯¸ ë§ˆê°ëœ invoiceì˜ ê²½ìš°, í™˜ë¶ˆì€ ë‹¤ìŒ ë‹¬ invoiceì— creditìœ¼ë¡œ ë°˜ì˜
      // - ë§ˆê° ì „ invoiceì˜ ê²½ìš°, ì¦‰ì‹œ í™˜ë¶ˆ ì²˜ë¦¬ ê°€ëŠ¥
      monthly_closing_conflict: {
        if_invoice_closed: 'create_credit_for_next_invoice',
        if_invoice_open: 'immediate_refund',
        require_admin_approval: false
      },

      // í• ì¸ ê¸ˆì•¡ì€ í™˜ë¶ˆ ëŒ€ìƒì—ì„œ ì œì™¸ (ì´ë¯¸ ì œê³µëœ í˜œíƒ)
      discount_not_refundable: true
    }
  },

  // âš ï¸ Carry-Over ê·œì¹™ê³¼ì˜ í†µí•©:
  // Early Payment í™˜ë¶ˆ ì‹œ ì´ˆê³¼ ë‚©ë¶€ ê¸ˆì•¡ì´ ìˆëŠ” ê²½ìš°, ë‹¤ìŒ ë‹¬ invoiceì— ìë™ ë°˜ì˜
  carry_over_integration: {
    excess_payment_handling: {
      if_excess_payment: 'carry_over_to_next_invoice',
      credit_note_creation: true,
      notify_admin: false
    }
  },

  // í™˜ë¶ˆ ì²˜ë¦¬ ì˜ˆì‹œ
  example: {
    original_amount: 300000,      // ì›ë˜ ì²­êµ¬ ê¸ˆì•¡
    early_payment_discount: 30000, // ì¡°ê¸°ë‚©ë¶€ í• ì¸ 10%
    paid_amount: 270000,           // ì‹¤ì œ ë‚©ë¶€ ê¸ˆì•¡
    refund_on_withdrawal: 270000  // í™˜ë¶ˆ ê¸ˆì•¡ (ë‚©ë¶€í•œ ê¸ˆì•¡ë§Œ í™˜ë¶ˆ)
  }
}
```

#### 3.4.5 Smart Retry Logic (ê²°ì œ ì½”ë“œ ê¸°ë°˜ ì¬ì‹œë„ ì •ì±…)

**âš ï¸ í•µì‹¬ ê°œì„ ì•ˆ 4: Billing / Payment / Webhook / Retry ê·œì¹™ í†µí•©**

**í†µí•© ê²°ì œ/ì²­êµ¬/Webhook/Retry ê·œì¹™ (v3.2 í™•ì •, v3.3ì—ì„œ ë³€ê²½ ì—†ì´ ìœ ì§€):**

```typescript
billing_payment_webhook_retry_unified_rule = {
  // 1. Payment Webhook ì²˜ë¦¬
  webhook_processing: {
    // ë©±ë“±ì„± í‚¤ ìƒì„± (C11 í•´ê²°)
    idempotency_key: '{provider}_{webhook_id}_{payment_id}',

    // Webhook ìˆ˜ì‹  ì‹œ ì²˜ë¦¬ ìˆœì„œ
    processing_order: [
      '1. idempotency_key ì¤‘ë³µ í™•ì¸',
      '2. invoice/payment ì—…ë°ì´íŠ¸',
      '3. ë¯¸ë‚© ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ (ê²°ì œ ì„±ê³µ ì‹œ)',
      '4. AI ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸',
      '5. Notification ë°œì†¡ (ê²°ì œ ì™„ë£Œ ì•Œë¦¼)'
    ]
  },

  // 2. Payment Retry ì •ì±…
  // âš ï¸ M7: Payment Retryì™€ Notification Retry í‘œí˜„ í†µì¼
  payment_retry: {
    // Smart Retry Logic (ì˜¤ë¥˜ ì½”ë“œ ê¸°ë°˜)
    // ì¬ì‹œë„ ì •ì±…ì€ Notification Retryì™€ ë™ì¼í•œ êµ¬ì¡° ì‚¬ìš© (max_retries, retry_interval, on_failure)
    error_code_retry_policy: {
      'E101': {
        retry: true,
        max_retries: 3,           // Notification Retryì™€ ë™ì¼í•œ í•„ë“œëª…
        retry_interval: '1 hour', // interval ëŒ€ì‹  retry_interval ì‚¬ìš© (í†µì¼)
        on_failure: 'create_admin_alert_card'  // on_failure í†µì¼
      },      // ì”ì•¡ ë¶€ì¡±
      'E501': {
        retry: true,
        max_retries: 2,
        retry_interval: 'immediate',  // interval â†’ retry_interval
        on_failure: 'move_to_dlq'  // on_failure í†µì¼
      },  // ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ
      'E203': {
        retry: true,
        max_retries: 2,
        retry_interval: '10 minutes',  // interval â†’ retry_interval
        on_failure: 'notify_admin'  // on_failure í†µì¼
      },  // ì¹´ë“œì‚¬ ì¼ì‹œ ì˜¤ë¥˜
      'E104': {
        retry: false,
        action: 'notify_user',
        on_failure: 'notify_user'  // on_failure í†µì¼
      },                  // í•œë„ ì´ˆê³¼
      'E302': {
        retry: false,
        action: 'notify_admin',
        on_failure: 'notify_admin'  // on_failure í†µì¼
      },                // ê³„ì¢Œ ì •ì§€
      'E401': {
        retry: false,
        action: 'request_auth',
        on_failure: 'request_auth'  // on_failure í†µì¼
      }                 // ì¸ì¦ ì‹¤íŒ¨
    },

    // ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬ (Notification Retryì™€ ë™ì¼í•œ êµ¬ì¡°)
    on_retry_failure: {
      action: 'create_admin_alert_card',
      notify_parent: true,
      suggest_alternative_payment: true,
      dlq_storage: true  // DLQ ì €ì¥ ì˜µì…˜ ì¶”ê°€ (í†µì¼)
    }
  },

  // 3. Invoice ë°œì†¡ ì‹¤íŒ¨ ì¬ë°œì†¡ ê·œì¹™
  invoice_delivery_retry: {
    // ë°œì†¡ ì‹¤íŒ¨ ì‹œ ì¬ë°œì†¡ ì •ì±…
    on_delivery_failure: {
      max_retries: 3,
      retry_interval: '1 hour',
      require_admin_approval: false,  // ìë™ ì¬ë°œì†¡

      // ì¬ë°œì†¡ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
      on_retry_failure: {
        action: 'create_admin_alert_card',
        message: 'ì²­êµ¬ì„œ ë°œì†¡ ì‹¤íŒ¨. ìˆ˜ë™ ë°œì†¡ í•„ìš”'
      }
    },

    // ë°œì†¡ ì‹¤íŒ¨ ì›ì¸ë³„ ì²˜ë¦¬
    failure_reasons: {
      'provider_error': { retry: true, max_retries: 3 },
      'template_rejected': { retry: false, action: 'notify_admin' },
      'recipient_invalid': { retry: false, action: 'update_contact' }
    }
  },

  // 4. Webhook ì§€ì—° ë„ì°© ì²˜ë¦¬
  webhook_delay_handling: {
    // ì´ì „ ë‹¬ ì²­êµ¬ì„œ ë§ˆê° ì²˜ë¦¬ (C9 í•´ê²°)
    closed_invoice_payment: {
      strategy: 'reopen_or_carry_over',
      default: 'reopen_closed_invoice',
      require_admin_approval: false
    }
  }
}
```

**ì•Œë¦¼ë±…í¬ Webhookì˜ ì˜¤ë¥˜ ì½”ë“œë³„ ì¬ì‹œë„ ì •ì±…:**

| ì˜¤ë¥˜ ì½”ë“œ ìœ í˜• | ì˜ˆì‹œ | ì¬ì‹œë„ ì •ì±… |
|--------------|------|------------|
| ì”ì•¡ ë¶€ì¡± | E101 | 1ì‹œê°„ í›„ 3íšŒê¹Œì§€ ì¬ì‹œë„ |
| ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ | E501 | ì¦‰ì‹œ 2íšŒ ì¬ì‹œë„ |
| ì¹´ë“œì‚¬ ì¼ì‹œ ì˜¤ë¥˜ | E203 | 10ë¶„ í›„ 2íšŒ ì¬ì‹œë„ |
| í•œë„ ì´ˆê³¼ | E104 | ì¬ì‹œë„ ì—†ìŒ + ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ |
| ê³„ì¢Œ ì •ì§€ | E302 | ì¬ì‹œë„ ì—†ìŒ + ê´€ë¦¬ì ì¹´ë“œ ìƒì„± |
| ì¸ì¦ ì‹¤íŒ¨ | E401 | ì¬ì‹œë„ ì—†ìŒ + ì‚¬ìš©ì ì¸ì¦ ìš”ì²­ |

**ì¬ì‹œë„ ì •ì±… ì›ì¹™:**
- ë¬´í•œ ì¬ì‹œë„ ë°©ì§€ (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ)
- ì˜¤ë¥˜ ì½”ë“œë³„ ì ì ˆí•œ ì¬ì‹œë„ ê°„ê²© ì„¤ì •
- ì¬ì‹œë„ ë¶ˆê°€ëŠ¥í•œ ì˜¤ë¥˜ëŠ” ì¦‰ì‹œ ì‚¬ìš©ì/ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼
- ì¬ì‹œë„ ì´ë ¥ì€ ê²°ì œ ë‚´ì—­ì— ê¸°ë¡

**ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬:**
- ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ë„ë‹¬ ì‹œ ì¬ì‹œë„ ì¤‘ë‹¨
- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— "ê²°ì œ ì‹¤íŒ¨" ì•Œë¦¼ ì¹´ë“œ ìƒì„±
- í•™ë¶€ëª¨ì—ê²Œ ê²°ì œ ì‹¤íŒ¨ ì•ˆë‚´ ë° ëŒ€ì²´ ê²°ì œ ë°©ë²• ì œì‹œ

**âš ï¸ H7: ì²­êµ¬ì„œ ì¬ë°œì†¡ ì‹¤íŒ¨ ì²˜ë¦¬ ê·œì¹™ ì¶”ê°€:**

```typescript
invoice_resend_policy = {
  // ë°œì†¡ ì‹¤íŒ¨ ì‹œ ì¬ë°œì†¡ ê¶Œí•œ/ì¡°ê±´/íšŸìˆ˜/ìš°ì„ ìˆœìœ„
  on_delivery_failure: {
    // ìë™ ì¬ë°œì†¡ (Provider ì˜¤ë¥˜ì¸ ê²½ìš°)
    auto_retry: {
      condition: 'provider_error',
      max_retries: 3,
      retry_interval: '1 hour',
      require_admin_approval: false
    },

    // ìˆ˜ë™ ì¬ë°œì†¡ (í…œí”Œë¦¿ ê±°ë¶€ ë“±)
    manual_retry: {
      condition: 'template_rejected OR recipient_invalid',
      require_admin_approval: true,
      admin_action: 'update_template OR update_contact'
    }
  },

  // ì¬ë°œì†¡ ìš°ì„ ìˆœìœ„
  priority: {
    'unpaid_invoice': 1,      // ë¯¸ë‚© ì²­êµ¬ì„œ ìµœìš°ì„ 
    'partial_invoice': 2,     // ë¶€ë¶„ë‚© ì²­êµ¬ì„œ
    'paid_invoice': 3         // ì™„ë‚© ì²­êµ¬ì„œ (ë‚®ì€ ìš°ì„ ìˆœìœ„)
  }
}
```

#### 3.4.6 ì²­êµ¬/ìˆ˜ë‚© ì—”ì§„

**ì£¼ìš” ê¸°ëŠ¥**

**ìƒí’ˆ ìœ í˜•**

```
plan_type: monthly, times, package
- monthly: ê³ ì • ì›” íšŒë¹„
- times: ì¶œê²° íšŸìˆ˜ì™€ ì—°ë™ëœ íšŸìˆ˜ì œ
- package: ì¼ì • ê¸°ê°„ + ì¼ì • íšŒì°¨/ê³¼ëª© ë¬¶ìŒ ìƒí’ˆ(ë³µí•©í˜•)
```

**ì„ ë¶ˆ/í›„ë¶ˆ ëª¨ë¸**

ì¶œê²°ë²„ìŠ¤ ë§¤ë‰´ì–¼ì˜ ìš©ì–´ë¥¼ ë”°ë¦„:
```
billing_mode:
  - prepaid: ì‹ ê·œ ë“±ë¡ìƒ(ì„ ë¶ˆ)
  - postpaid: ê¸°ì¡´ ì¬ì›ìƒ(í›„ë¶ˆ)
```

**ì›” ì„œë²„ê°€ ì²­êµ¬ ìƒì„± (Batch)**

ë°°ì¹˜ ì‹œê°: ë§¤ì¼ 04:00 KST

ë™ì‘:
- billing_plans + enrollments + attendance ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ
- í•´ë‹¹ ê¸°ê°„ì— ëŒ€í•œ invoices ì„œë²„ê°€ ìƒì„±
- ì¶œê²° ì—°ë™ íšŸìˆ˜ì œì˜ ê²½ìš°, ë‚¨ì€ íšŒì°¨/ìë™ ì°¨ê° ê·œì¹™ ë°˜ì˜

ë©±ë“±ì„±:
- (tenant_id, period_start, period_end, template_key) ìœ ë‹ˆí¬ ì œì•½ ìœ ì§€
- ë°°ì¹˜ ì‹¤í–‰ ì‹œ ë™ì¼ ê¸°ê°„ ì¤‘ë³µ ì¸ë³´ì´ìŠ¤ ìƒì„± ë°©ì§€

**ì¶œê²° ì—°ë™ íšŸìˆ˜ì œ**

```
times_link_mode í•„ë“œ ì¶”ê°€:
- linked: ì¶œê²° ë°œìƒ ì‹œ ìë™ íšŸìˆ˜ ì°¨ê°
- manual: ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ íšŸìˆ˜ ì°¨ê°
```

ì¶œê²° ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ:
- linkedì¸ ê²½ìš° remaining_times ê°ì†Œ
- 0 ì´í•˜ë¡œ ë‚´ë ¤ê°ˆ ê²½ìš°, ì¶”ê°€ ì¶œê²° ì‹œ ê²½ê³ /ì•Œë¦¼ ë°œì†¡ ì˜µì…˜ ì§€ì›

**ë¯¸ë‚© ê´€ë¦¬**

- ë¯¸ë‚© í•™ìƒ ëª©ë¡ ì¡°íšŒ
- ë¯¸ë‚© ì•Œë¦¼ ë°œì†¡ ì„¤ì •
- ë¯¸ë‚© ì´ë ¥ ì¶”ì 

**ìˆ˜ë‚© í™ˆ ëŒ€ì‹œë³´ë“œ ë©”íŠ¸ë¦­ ê³„ì‚° ê·œì¹™**

ìˆ˜ë‚© í™ˆ(`/billing/home`) ëŒ€ì‹œë³´ë“œì˜ ê° ì¹´ë“œ ìˆ˜ì¹˜ëŠ” ì•„ë˜ ê³„ì‚°ì‹ìœ¼ë¡œ ì‚°ì¶œí•œë‹¤:

```typescript
billing_home_metrics_spec = {
  // ì˜ˆìƒ ìˆ˜ë‚©ë¥  = ì‹¤ì œ ë‚©ë¶€ ê¸ˆì•¡ / ì „ì²´ ì²­êµ¬ ê¸ˆì•¡
  expected_collection_rate:
    sum(invoices.amount_paid) / sum(invoices.amount) * 100,

  // ì„œë²„ê°€ ì²­êµ¬ ìƒì„± ì§„í–‰ë¥  = ë°œì†¡ ì™„ë£Œ ì²­êµ¬ì„œ ìˆ˜ / ì „ì²´ ì²­êµ¬ì„œ ìˆ˜
  // ë°œì†¡ ì‹¤íŒ¨ ì²­êµ¬ì„œëŠ” ê³„ì‚°ì—ì„œ ì œì™¸
  auto_billing_progress:
    count(invoices where status in ('sent', 'paid', 'partial')
          and messaging_delivery_failed = false)
    / count(invoices where messaging_delivery_failed = false) * 100,

  // ê²°ì œ ì‹¤íŒ¨ ì¬ì‹œë„ ê±´ìˆ˜ = ì¬ì‹œë„ ì‹¤íŒ¨í•œ ê²°ì œ ê±´ìˆ˜
  failed_retry_count:
    count(payments where last_retry_status = 'failed'),

  // AI ë¯¸í•´ê²° ë¯¸ë‚© ê±´ìˆ˜ = ë¯¸ë‚© ìƒíƒœì´ë©´ì„œ AIê°€ í•´ê²°í•˜ì§€ ëª»í•œ ê±´ìˆ˜
  unresolved_unpaid:
    count(invoices where status = 'unpaid' and ai_status = 'unresolved')
}
```

**ê³„ì‚° ê¸°ì¤€:**
- ê³„ì‚° ë²”ìœ„: í˜„ì¬ ì›”(ì´ë²ˆ ë‹¬) ì²­êµ¬ì„œë§Œ ëŒ€ìƒ
- ì—…ë°ì´íŠ¸ ì£¼ê¸°: ì‹¤ì‹œê°„ (ë°ì´í„° ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ê³„ì‚°)
- ìºì‹±: Materialized View ë˜ëŠ” Redis ìºì‹œ í™œìš©

**ë¶€ë¶„ë‚©ë¶€ ê¸ˆì•¡ ì •ë ¬ ê·œì¹™:**
- ë¶€ë¶„ë‚©ë¶€ ê¸ˆì•¡ì´ ì—¬ëŸ¬ ë²ˆ ë°œìƒí•˜ëŠ” ê²½ìš° ê°€ì¥ ìµœì‹  ê²°ì œ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
- ê²°ì œ ë‚´ì—­ì€ `payment.created_at DESC` ìˆœì„œë¡œ í‘œì‹œ
- ë¶€ë¶„ë‚©ë¶€ ì§„í–‰ë¥  ê³„ì‚° ì‹œ ìµœì‹  ê²°ì œ ê¸ˆì•¡ ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„

**ë°œì†¡ ì‹¤íŒ¨ ì²­êµ¬ì„œ ì²˜ë¦¬:**
- `messaging_delivery_failed = true`ì¸ ì²­êµ¬ì„œëŠ” ìë™ ì²­êµ¬ ì§„í–‰ë¥  ê³„ì‚°ì—ì„œ ì œì™¸
- ë°œì†¡ ì‹¤íŒ¨ ì²­êµ¬ì„œëŠ” ë³„ë„ ì¹´ë“œë¡œ í‘œì‹œ
- ë°œì†¡ ì‹¤íŒ¨ ì›ì¸ ë° ì¬ë°œì†¡ ì˜µì…˜ ì œê³µ

#### 3.4.7 ê²°ì œ ì²˜ë¦¬ ì±…ì„ ë²”ìœ„

**ì¤‘ìš”: ë””ì–´ìŒ¤ í”Œë«í¼ì€ ê²°ì œ ë¡œì§(ì´ì²´, ì¹´ë“œìŠ¹ì¸, ê°„í¸ê²°ì œ)ì„ ì§ì ‘ êµ¬í˜„í•˜ì§€ ì•ŠëŠ”ë‹¤.**

ëª¨ë“  ê²°ì œëŠ” ì•Œë¦¼ë±…í¬(íš¨ì„±FMS) ë° ê·¸ í•˜ìœ„ PGì‚¬ì—ì„œ ì²˜ë¦¬ë˜ë©°, ë””ì–´ìŒ¤ì€ API í˜¸ì¶œ + Webhook ìˆ˜ì‹  + DB ì—…ë°ì´íŠ¸ë§Œ ë‹´ë‹¹í•œë‹¤.

**ê²°ì œ ìˆ˜ë‹¨**

ì§€ì› ìˆ˜ë‹¨:
- ê³„ì¢Œì´ì²´(ì•Œë¦¼ë±…í¬ ê°€ìƒê³„ì¢Œ/ê³„ì¢Œì´ì²´)
- ì¹´ë“œê²°ì œ (ì•Œë¦¼ë±…í¬ ì—°ë™ PG)
- ê°„í¸ê²°ì œ(ì¹´ì¹´ì˜¤í˜ì´/ë„¤ì´ë²„í˜ì´ ë“±, ì•Œë¦¼ë±…í¬ë¥¼ í†µí•´ ì œê³µ)

**ì¤‘ìš” ëª…ì‹œì‚¬í•­:**
- "ì¹´ë“œ ê²°ì œ"ì™€ "ê°„í¸ê²°ì œ" ì—­ì‹œ ì•Œë¦¼ë±…í¬ë¥¼ í†µí•´ ì œê³µë˜ë©°, ë³„ë„ì˜ PGì‚¬ APIë¥¼ ì§ì ‘ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.
- ì•Œë¦¼ë±…í¬ê°€ ì œê³µí•˜ëŠ” í†µí•© ê²°ì œ API ìŠ¤í™ì„ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.

**API ì—°ë™ ë°©ì‹**

**fns-payment-alimbank-request Edge Function:**
- ì¸ìë¡œ tenant_id, invoice_id, amount, channel(bank/card/easy_pay) ë“±ì„ ìˆ˜ì‹ 
- ì•Œë¦¼ë±…í¬ APIì— ê²°ì œ ìš”ì²­ ìƒì„±
- ìš”ì²­/ì‘ë‹µ ì „ë¬¸ì€ audit ìš©ë„ë¡œ audit.payment_requestsì— ê¸°ë¡

**fns-payment-alimbank-webhook Edge Function:**
- ì•Œë¦¼ë±…í¬ Webhook ìˆ˜ì‹  ì „ìš©
- ìš”ì²­ ì„œëª…/í•´ì‹œ ê²€ì¦ í›„, payments ë° invoices.status ì—…ë°ì´íŠ¸
- ë©±ë“±ì„± í‚¤(idempotency_key)ë¡œ ì¤‘ë³µ ì½œë°± ë°©ì§€

**ì •ì‚°/íšŒê³„ ì±…ì„:**
- ì •ì‚°/íšŒê³„ëŠ” ì•Œë¦¼ë±…í¬ ë° PGì‚¬ì—ì„œ ì œê³µí•˜ëŠ” ì •ì‚° ë‚´ì—­ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°,
- ë””ì–´ìŒ¤ì€ ì¡°íšŒÂ·í•„í„°Â·í†µê³„Â·ëŒ€ì‹œë³´ë“œ ì—­í• ì— ì§‘ì¤‘í•œë‹¤.

#### 3.4.8 ê³ ê¸‰ ê¸°ëŠ¥ (Advanced ì˜µì…˜ì—ì„œë§Œ ì œê³µ)

**ìƒí’ˆ ìœ í˜• ê´€ë¦¬**
- plan_type ì„¤ì • (monthly/times/package)
- ìƒí’ˆ ìƒì„± ë° ìˆ˜ì •

**ìë™ ì²­êµ¬ ë°°ì¹˜ ì„¤ì •**
- ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì •
- ì²­êµ¬ ê·œì¹™ ì»¤ìŠ¤í„°ë§ˆì´ì§•

**íŒ¨í‚¤ì§€ ìƒí’ˆ ìƒì„±**
- ë³µí•©í˜• ìƒí’ˆ ì„¤ì •

**ì •ì‚°/íšŒê³„ ê¸°ëŠ¥**
- ì›” ë§¤ì¶œ ìƒì„¸ ë¶„ì„
- ê³¼ëª©ë³„ ë§¤ì¶œ ë¶„ì„
- ê°•ì‚¬ ë§¤ì¶œ ë°°ë¶„(ì˜µì…˜)
- ê²°ì œí˜„í™©(ì•Œë¦¼ë±…í¬ ì—°ë™ ê²°ê³¼ ì¡°íšŒ)

**UI ìš”êµ¬ì‚¬í•­:**

- ìˆ˜ë‚©/ì²­êµ¬ í™”ë©´ì€ 'ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œ ë³´ê¸°', 'ê²°ì œ ìƒíƒœ ë³´ê¸°'ë§Œ ê¸°ë³¸ ì œê³µí•˜ë©°,
- ìƒí’ˆ ê´€ë¦¬, ì •ì‚°, ë§¤ì¶œ ë¶„ì„ ë“±ì€ Advanced ë©”ë‰´ë¡œ ì´ë™í•œë‹¤.

### 3.5 ë©”ì‹œì§€/ê³µì§€(Notification)

#### 3.5.1 AI ìë™ ì´ˆì•ˆ ì œì•ˆ ëª¨ë¸ (AI-First Workflow)

**ì‹ ê·œ ê¸°ëŠ¥**

ì„œë²„ê°€ ìƒí™©ì„ ê°ì§€í•˜ê³  ë©”ì‹œì§€ ì´ˆì•ˆì„ ì¶”ì²œ ìƒì„± (AI í˜¸ì¶œ í›„ ì„œë²„ê°€ ì •ì±… í•´ì„í•˜ì—¬ TaskCard ìƒì„±, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

**ì˜ˆì‹œ:**
- "ì˜¤ëŠ˜ í­ìš° ì§€ì—­ì´ë¼ í•˜ì› ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
  â†’ ì„œë²„ê°€ ë‚ ì”¨ ì •ë³´ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì²œ ìƒì„± (AI í˜¸ì¶œ í›„ ì„œë²„ê°€ ì •ì±… í•´ì„í•˜ì—¬ ì´ˆì•ˆ ì œê³µ)
- "ê¹€â—‹â—‹ í•™ìƒ 3ì¼ ê²°ì„ â€” í•™ë¶€ëª¨ ì•ˆë¶€ ë¬¸ì ì´ˆì•ˆì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤."
  â†’ ì„œë²„ê°€ ê²°ì„ íŒ¨í„´ ë¶„ì„ í›„ ì¶”ì²œ ìƒì„± (AI í˜¸ì¶œ í›„ ì„œë²„ê°€ ì •ì±… í•´ì„í•˜ì—¬ ì´ˆì•ˆ ìƒì„±)
- ìˆ˜ì—… ì¢…ë£Œ í›„ â†’ ìƒë‹´ì¼ì§€ ì‘ì„± í™”ë©´ ìë™ ì¶”ì²œ (Adaptive UI)

#### 3.5.2 ê¸°ë³¸ UI (ë§¤ì¼ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥)

**ê³µì§€ ë³´ë‚´ê¸°**
- ë‹¨ì²´ ê³µì§€ ë°œì†¡
- AI ì¶”ì²œ ì´ˆì•ˆ ê¸°ë°˜ ê°„ë‹¨í•œ ë©”ì‹œì§€ ì‘ì„± ë° ë°œì†¡
- ìƒí™© ê¸°ë°˜ AI ìë™ ì œì•ˆ

**ì¶œê²° ì•Œë¦¼**
- ë“±ì›/í•˜ì› ì•Œë¦¼ ì •ì±… ê¸°ë°˜ ë°œì†¡ (Policy ì„¤ì • ê¸°ë°˜)

#### 3.5.3 Notification Provider êµ¬ì¡°

**âš ï¸ ğŸ”¥ 8ë²ˆ: Notification Retry êµ¬ì¡° í†µí•© (3ì¤‘ êµ¬ì¡° í•´ê²°):**

**Notification Retry State Machine (í†µí•© ê·œì¹™):**

```typescript
notification_retry_state_machine = {
  // âš ï¸ Retry Order ì •ì˜ (ëª…í™•í•œ ìˆœì„œ)
  retry_order: [
    '1. Provider-level retry (ë™ì¼ ì±„ë„ ë‚´)',
    '2. Channel-level fallback (ì•Œë¦¼í†¡ â†’ SMS)',
    '3. Dead-Letter Queue (ìµœì¢… ì‹¤íŒ¨)'
  ],

  // 1ë‹¨ê³„: Provider-level Retry (ë™ì¼ ì±„ë„ ë‚´)
  provider_level_retry: {
    condition: 'provider_error_code in [500, 502, 503, 504] OR network_error',
    max_retries: 3,
    retry_interval: 'exponential_backoff',  // 1ì´ˆ â†’ 5ì´ˆ â†’ 30ì´ˆ
    channels: ['kakao_at', 'sms'],  // ëª¨ë“  ì±„ë„ì— ì ìš©
    on_failure: 'move_to_channel_fallback'
  },

  // 2ë‹¨ê³„: Channel-level Fallback (ì•Œë¦¼í†¡ â†’ SMS)
  channel_level_fallback: {
    condition: 'provider_retry_exhausted OR provider_error_code not in [500, 502, 503, 504]',
    fallback_rule: {
      from: 'kakao_at',
      to: 'sms',
      delay: 10,  // 10ì´ˆ í›„ SMS ë°œì†¡
      max_fallback_attempts: 1  // SMS fallbackì€ 1íšŒë§Œ
    },
    on_failure: 'move_to_dlq'
  },

  // 3ë‹¨ê³„: Dead-Letter Queue (ìµœì¢… ì‹¤íŒ¨)
  dead_letter_queue: {
    condition: 'all_channels_failed',
    action: 'create_admin_alert_card',
    dlq_storage: true,
    manual_retry_enabled: true
  }
}
```

**Dead-Letter Queue Mapping:**

```typescript
dlq_mapping = {
  'provider_error': {
    retry_count: 3,
    final_status: 'failed_provider',
    dlq_reason: 'provider_unavailable'
  },
  'channel_fallback_failed': {
    retry_count: 1,
    final_status: 'failed_all_channels',
    dlq_reason: 'all_channels_exhausted'
  },
  'invalid_recipient': {
    retry_count: 0,
    final_status: 'failed_validation',
    dlq_reason: 'recipient_invalid'
  }
}
```

**âš ï¸ ìµœì¢… í†µí•© ê·œì¹™ (Final Notification Rule):**

**1) ì±„ë„ ìš°ì„ ìˆœìœ„:**
- kakao_at â†’ ì‹¤íŒ¨ â†’ 10ì´ˆ í›„ SMS 1íšŒë§Œ fallback

**2) SMS ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ì—†ìŒ**

**3) Provider-level retryëŠ” 'ê³µê¸‰ì—…ì²´ ì˜¤ë¥˜(500 ë˜ëŠ” ë„¤íŠ¸ì›Œí¬)'ì—ë§Œ ì ìš©:**
- ì´ëŠ” ë™ì¼ ì±„ë„ ë‚´ retryì´ë©°, ì•Œë¦¼í†¡â†’SMS fallbackê³¼ëŠ” ë³„ê°œ
- Retry Order: Provider Retry â†’ Channel Fallback â†’ DLQ

**4) ëª¨ë“  ì±„ë„ ì‹¤íŒ¨ ì‹œ â†’ Dead-Letter Queue â†’ ê´€ë¦¬ì ê¸´ê¸‰ ì¹´ë“œ ìƒì„±**

**ì¤‘ìš”: ë””ì–´ìŒ¤ì€ ë¬¸ì/ì•Œë¦¼í†¡ ì¸í”„ë¼ë¥¼ ì§ì ‘ êµ¬í˜„í•˜ì§€ ì•ŠëŠ”ë‹¤.**

**SMS/LMS ë°œì†¡**

ë””ì–´ìŒ¤ì˜ SMS/LMS ë°œì†¡ì€ ê¸°ì¡´ í”Œë ˆì´ì˜¨ì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ Provider ë¡œì§ì„ ì¬ì‚¬ìš©í•œë‹¤.

**êµ¬í˜„ ì£¼ì²´:**
- core-notification â†’ Provider ì¶”ìƒí™”
- ì‹¤ì œ ì „ì†¡ ë¡œì§ì€ @lib/notification-sms-provider (í”Œë ˆì´ì˜¨ ê³µí†µ ëª¨ë“ˆ) ì‚¬ìš©

ë””ì–´ìŒ¤ì—ì„œ ìƒˆë¡œ ë§Œë“œëŠ” ê²ƒì€:
- ë°œì†¡ ìš”ì²­ ìƒì„±
- í…œí”Œë¦¿ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©
- ë°œì†¡ ê²°ê³¼ ì €ì¥(ë¡œê·¸)
- ì¬ì‹œë„ ì •ì±… ì •ì˜

ì¦‰, í†µì‹ ì‚¬/ê²Œì´íŠ¸ì›¨ì´ ì—°ë™ì´ ì•„ë‹ˆë‹¤.

**ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ (ì‹ ê·œ êµ¬í˜„)**

ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡(AT)ì€ ì‹ ê·œ Providerë¡œ êµ¬í˜„í•œë‹¤.

**ì—°ë™ ë°©ì‹:**
- ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë©”ì‹œì§€ ë˜ëŠ” ì•Œë¦¼í†¡ ì§€ì› SMS ì‚¬ì—…ì API ì‚¬ìš©
- ë””ì–´ìŒ¤ì€ ë‹¤ìŒë§Œ ë‹´ë‹¹:
  - í…œí”Œë¦¿ í‚¤ + ë³€ìˆ˜ ì „ë‹¬
  - ì‘ë‹µì½”ë“œ/ì „ì†¡ ê²°ê³¼ ìˆ˜ì‹ 
  - ì‹¤íŒ¨ ì‹œ SMS ëŒ€ì²´ ë°œì†¡ ì˜µì…˜ ì²˜ë¦¬

**ê¸°ìˆ  ìš”êµ¬:**
- í…œí”Œë¦¿ ìŠ¹ì¸/ê´€ë¦¬ í™”ë©´(UI)
- í…œí”Œë¦¿ê³¼ ì—…ë¬´ ì´ë²¤íŠ¸(ë“±ì›/í•˜ì›/ì²­êµ¬/ë¯¸ë‚©) ë§¤í•‘

**Provider ì‘ë‹µì½”ë“œ â†’ Internal Status ë§¤í•‘í‘œ**

ê° Providerì˜ ì‘ë‹µì½”ë“œë¥¼ ë‚´ë¶€ ìƒíƒœê°’ìœ¼ë¡œ ì •ê·œí™”í•˜ëŠ” ë§¤í•‘í‘œ:

| Provider | provider_code | meaning | internal_status |
|----------|--------------|---------|----------------|
| í”Œë ˆì´ì˜¨ SMS | 0 | ì„±ê³µ | sent |
| í”Œë ˆì´ì˜¨ SMS | 400 | ì˜ëª»ëœ ìš”ì²­ | failed |
| í”Œë ˆì´ì˜¨ SMS | 401 | ì¸ì¦ ì‹¤íŒ¨ | failed_auth |
| í”Œë ˆì´ì˜¨ SMS | 500 | ê³µê¸‰ì—…ì²´ ì˜¤ë¥˜ | retry |
| ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ | 0 | ì„±ê³µ | sent |
| ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ | 400 | ì˜ëª»ëœ ìš”ì²­ | failed |
| ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ | 401 | ì¸ì¦ ì‹¤íŒ¨ | failed_auth |
| ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ | 500 | ê³µê¸‰ì—…ì²´ ì˜¤ë¥˜ | retry |

**ë§¤í•‘ ê·œì¹™:**
- Webhook/Callback ìˆ˜ì‹  ì‹œ provider_codeë¥¼ internal_statusë¡œ ë³€í™˜
- internal_statusê°€ 'retry'ì¸ ê²½ìš° ìë™ ì¬ì‹œë„ ì •ì±… ì ìš©
- internal_statusê°€ 'failed'ì¸ ê²½ìš° DLQì— ì €ì¥
- internal_statusê°€ 'sent'ì¸ ê²½ìš° ë°œì†¡ ì™„ë£Œ ì²˜ë¦¬

**ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ í…œí”Œë¦¿ ìŠ¹ì¸ í”Œë¡œìš°**

**âš ï¸ ì‹¤ì œ ì„œë¹„ìŠ¤ ë°©ì‹ ê³ ë ¤:**

ë¬¸ì„œëŠ” API ê¸°ë°˜ ì„¤ëª…ìœ¼ë¡œ ë˜ì–´ ìˆìœ¼ë‚˜, ì‹¤ì œë¡œëŠ” ëŒ€ë¶€ë¶„ "ì‚¬ì—…ì ì½˜ì†”ì—ì„œ ìˆ˜ë™ ì œì¶œ + API ì¡°íšŒ" ë°©ì‹:
- ì‹¤ì œ ì„œë¹„ìŠ¤ ë°©ì‹ê³¼ ì°¨ì´ ìˆì„ ìˆ˜ ìˆìŒ
- ì‚¬ì—…ì ì½˜ì†” ìˆ˜ë™ ì œì¶œ í›„ APIë¡œ ìƒíƒœ ì¡°íšŒí•˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ ê³ ë ¤ í•„ìš”

ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ í…œí”Œë¦¿ ìŠ¹ì¸Â·ê²€ìˆ˜ í”„ë¡œì„¸ìŠ¤:

1) í…œí”Œë¦¿ ì‘ì„±
- ê´€ë¦¬ìê°€ í…œí”Œë¦¿ ë‚´ìš© ì‘ì„±
- ë³€ìˆ˜ ë°”ì¸ë”© ì„¤ì •
- í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°

2) ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì„¼í„° APIë¡œ ì œì¶œ
- ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì„¼í„° APIë¥¼ í†µí•´ í…œí”Œë¦¿ ì œì¶œ
- ì œì¶œ ì‹œ í…œí”Œë¦¿ ìƒíƒœ: 'pending'

3) í…œí”Œë¦¿ ìƒíƒœ ê´€ë¦¬
- pending: ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
- approved: ìŠ¹ì¸ ì™„ë£Œ (ë°œì†¡ ê°€ëŠ¥)
- rejected: ìŠ¹ì¸ ê±°ë¶€

4) rejected ì‚¬ìœ  í‘œì‹œ
- ìŠ¹ì¸ ê±°ë¶€ ì‹œ ê±°ë¶€ ì‚¬ìœ  í‘œì‹œ
- í…œí”Œë¦¿ ìˆ˜ì • í›„ ì¬ì œì¶œ ê°€ëŠ¥

5) ìŠ¹ì¸ëœ í…œí”Œë¦¿ë§Œ ë°œì†¡ ê°€ëŠ¥
- approved ìƒíƒœì˜ í…œí”Œë¦¿ë§Œ ì‹¤ì œ ë°œì†¡ì— ì‚¬ìš©
- pending/rejected í…œí”Œë¦¿ì€ ë°œì†¡ ë¶ˆê°€

6) í…œí”Œë¦¿ë³„ revision ê´€ë¦¬
- í…œí”Œë¦¿ ìˆ˜ì • ì‹œ ìƒˆ revision ìƒì„±
- ì´ì „ revision ì´ë ¥ ë³´ê´€
- ê° revisionë³„ ìŠ¹ì¸ ìƒíƒœ ê´€ë¦¬

**âš ï¸ B4: Notification Provider Approval Process ì‹¤ì œ Flow ì—°ê²° êµ¬ì¡°:**

**í…œí”Œë¦¿ í‚¤ì˜ ì‹¤ì œ naming convention:**
```typescript
template_key_naming = {
  // í˜•ì‹: {category}_{event_type}_{industry}_{version}
  format: '{category}_{event_type}_{industry}_{version}',

  // ì˜ˆì‹œ:
  examples: {
    attendance_checkin: 'attendance_checkin_academy_v1',
    billing_unpaid_alert: 'billing_unpaid_alert_academy_v1',
    counseling_summary: 'counseling_summary_academy_v1'
  },

  // ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
  categories: ['attendance', 'billing', 'counseling', 'announcement', 'system'],

  // ì´ë²¤íŠ¸ íƒ€ì…
  event_types: ['checkin', 'checkout', 'unpaid_alert', 'payment_complete', 'summary'],

  // ì—…ì¢…ë³„ ë¶„ê¸°
  industry_suffix: {
    academy: '_academy',
    salon: '_salon',
    real_estate: '_real_estate'
  }
}
```

**í…œí”Œë¦¿ versioning ê·œì¹™:**
```typescript
template_versioning = {
  // ë²„ì „ í˜•ì‹: v{major}.{minor}
  format: 'v{major}.{minor}',

  // ë²„ì „ ì¦ê°€ ê·œì¹™
  version_increment: {
    major: 'í…œí”Œë¦¿ ë‚´ìš© ëŒ€í­ ë³€ê²½ ì‹œ',
    minor: 'í…œí”Œë¦¿ ë³€ìˆ˜ ì¶”ê°€/ìˆ˜ì • ì‹œ'
  },

  // ì´ì „ ë²„ì „ ê´€ë¦¬
  previous_version_handling: {
    keep_previous: true,  // ì´ì „ ë²„ì „ ë³´ê´€
    auto_deprecate: false,  // ìë™ íê¸° ì•ˆ í•¨
    manual_deprecation: true  // ìˆ˜ë™ íê¸°ë§Œ ê°€ëŠ¥
  }
}
```

**ì—…ì¢…ë³„ default template set:**
```typescript
default_template_set = {
  academy: {
    attendance_checkin: 'attendance_checkin_academy_v1',
    attendance_checkout: 'attendance_checkout_academy_v1',
    billing_unpaid_alert: 'billing_unpaid_alert_academy_v1',
    counseling_summary: 'counseling_summary_academy_v1',
    announcement: 'announcement_academy_v1'
  },
  salon: {
    appointment_reminder: 'appointment_reminder_salon_v1',
    service_complete: 'service_complete_salon_v1',
    payment_reminder: 'payment_reminder_salon_v1'
  },
  real_estate: {
    property_viewing_reminder: 'property_viewing_reminder_real_estate_v1',
    contract_reminder: 'contract_reminder_real_estate_v1'
  }
}
```

**ë©”ì‹œì§€ ì¹´í…Œê³ ë¦¬ë³„ í…œí”Œë¦¿ mapping table:**
```typescript
message_category_template_mapping = {
  // ì¶œê²° ê´€ë ¨
  attendance: {
    checkin: {
      template_key: 'attendance_checkin_{industry}_v1',
      channel_priority: ['kakao_at', 'sms'],
      required_variables: ['student_name', 'checkin_time', 'class_name']
    },
    checkout: {
      template_key: 'attendance_checkout_{industry}_v1',
      channel_priority: ['kakao_at', 'sms'],
      required_variables: ['student_name', 'checkout_time', 'class_name']
    }
  },

  // ì²­êµ¬/ê²°ì œ ê´€ë ¨
  billing: {
    unpaid_alert: {
      template_key: 'billing_unpaid_alert_{industry}_v1',
      channel_priority: ['kakao_at', 'sms'],
      required_variables: ['student_name', 'invoice_amount', 'due_date']
    },
    payment_complete: {
      template_key: 'billing_payment_complete_{industry}_v1',
      channel_priority: ['kakao_at', 'sms'],
      required_variables: ['student_name', 'payment_amount', 'payment_date']
    }
  },

  // ìƒë‹´ ê´€ë ¨
  counseling: {
    summary: {
      template_key: 'counseling_summary_{industry}_v1',
      channel_priority: ['kakao_at'],
      required_variables: ['student_name', 'counseling_date', 'summary_text']
    }
  },

  // ê³µì§€ ê´€ë ¨
  announcement: {
    general: {
      template_key: 'announcement_{industry}_v1',
      channel_priority: ['kakao_at', 'sms'],
      required_variables: ['announcement_title', 'announcement_content']
    }
  }
}
```

**í…œí”Œë¦¿ ìŠ¹ì¸ UI:**
- í…œí”Œë¦¿ ëª©ë¡ í™”ë©´ì— ìƒíƒœ í‘œì‹œ
- ìŠ¹ì¸ ëŒ€ê¸° í…œí”Œë¦¿ í•„í„°ë§
- ìŠ¹ì¸ ê±°ë¶€ ì‚¬ìœ  í™•ì¸
- í…œí”Œë¦¿ ìˆ˜ì • ë° ì¬ì œì¶œ ê¸°ëŠ¥

**ë©”ì‹œì§€ ì±„ë„ ë§¤í•‘**

channel í•„ë“œ:
- sms: ë¬¸ì ë°œì†¡(í”Œë ˆì´ì˜¨ Provider)
- kakao_at: ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡(ì‹ ê·œ Provider)

**UI/ì„¤ì •:**
- í…ë„ŒíŠ¸/í•™ì›ë³„ë¡œ "ì¶œê²° ì•Œë¦¼ ë°©ì‹" ì„ íƒ:
  - kakao_at ìš°ì„  + ì‹¤íŒ¨ ì‹œ SMS
  - SMSë§Œ ì‚¬ìš©
  - ì•Œë¦¼ ì‚¬ìš© ì•ˆ í•¨

**ì±…ì„ ë²”ìœ„ ìš”ì•½**

ë””ì–´ìŒ¤:
- ë©”ì‹œì§€ ìƒì„±/íì‰/ë¡œê·¸
- Provider API í˜¸ì¶œ

ì™¸ë¶€ Provider:
- ì‹¤ì œ ë©”ì‹œì§€ ì „ì†¡
- í†µì‹ ì‚¬/ì¹´ì¹´ì˜¤ì™€ì˜ í†µì‹ 

#### 3.5.4 ë©”ì‹œì§€ ì±„ë„ ìš°ì„ ìˆœìœ„ ê·œì¹™

**âš ï¸ C3: Notification Provider ìš°ì„ ìˆœìœ„ ê·œì¹™ í†µì¼ (í™•ì •):**

ë¬¸ì„œ ë‚´ ë‘ ê·œì¹™ì´ í˜¼ì¬ë˜ì–´ ìˆì—ˆìœ¼ë‚˜, ì•„ë˜ í™•ì •ë³¸ìœ¼ë¡œ í†µì¼:

**ê³µì‹ Notification Rule (v3.2 í™•ì •, v3.3ì—ì„œ ë³€ê²½ ì—†ì´ ìœ ì§€):**

1. **ì±„ë„ ìš°ì„ ìˆœìœ„:**
   - kakao_at â†’ ì‹¤íŒ¨ â†’ 10ì´ˆ í›„ SMS 1íšŒë§Œ fallback
   - Channel-level retry(ì•Œë¦¼í†¡â†’SMS)ëŠ” 1íšŒë¡œ ì œí•œ

2. **SMS ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ì—†ìŒ**

3. **Provider-level retryëŠ” 'ê³µê¸‰ì—…ì²´ ì˜¤ë¥˜(500 ë˜ëŠ” ë„¤íŠ¸ì›Œí¬)'ì—ë§Œ ì ìš©:**
   - ì´ëŠ” ë™ì¼ ì±„ë„ ë‚´ retryì´ë©°, ì•Œë¦¼í†¡â†’SMS fallbackê³¼ëŠ” ë³„ê°œ
   - Provider-level retryëŠ” ìµœëŒ€ 3íšŒ, Exponential Backoff

4. **ëª¨ë“  ì±„ë„ ì‹¤íŒ¨ ì‹œ â†’ ê´€ë¦¬ì ê¸´ê¸‰ ì¹´ë“œ ìƒì„±**

**âš ï¸ ì´ì „ ë²„ì „ì˜ "Provider-level retry + SMS fallback" í˜¼í•© ì„¤ëª…ì€ ë¬´ì‹œí•˜ê³  ìœ„ ê·œì¹™ë§Œ ë”°ë¦„**

**kakao_at ìš°ì„ **
- ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ì„ ìµœìš°ì„  ì±„ë„ë¡œ ì‚¬ìš©

**ì‹¤íŒ¨ â†’ 10ì´ˆ í›„ SMS fallback (1íšŒë§Œ)**
- ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨ ì‹œ 10ì´ˆ í›„ ì„œë²„ê°€ SMS ë°œì†¡
- Channel-level retryëŠ” 1íšŒë¡œ ì œí•œ
- ì‚¬ìš©ìì—ê²Œ ì§€ì—° ì—†ì´ ë©”ì‹œì§€ ì „ë‹¬

**SMS ì‹¤íŒ¨ â†’ ì¬ì‹œë„ ì—†ìŒ**
- SMS ë°œì†¡ ì‹¤íŒ¨ ì‹œ ì¶”ê°€ ì¬ì‹œë„ ì—†ìŒ
- ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ ì¹´ë“œ ìƒì„±

**Provider-level Retry ì ìš© ë²”ìœ„:**
- Provider-level retryëŠ” 'ê³µê¸‰ ì—…ì²´ ì‹œìŠ¤í…œ ì˜¤ë¥˜'ì—ë§Œ ì ìš©
- ì˜ˆ: ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ API ì„œë²„ ì˜¤ë¥˜(500), ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ ë“±
- Channel-level retry(ì•Œë¦¼í†¡â†’SMS)ì™€ëŠ” ë³„ê°œë¡œ ë™ì‘

**ë°œì†¡ ì‹¤íŒ¨ ì‹œ ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ ì¹´ë“œ ìƒì„±**
- ëª¨ë“  ì±„ë„ ì‹¤íŒ¨ ì‹œ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— ì•Œë¦¼ ì¹´ë“œ í‘œì‹œ
- ìˆ˜ë™ ì²˜ë¦¬ í•„ìš” ì‹œ ëª…í™•íˆ ì•ˆë‚´

**âš ï¸ M4: Notification Throttling ì¤‘ë³µ ì œê±°:**

**ë‹¨ì¼ ì •ë³¸ (v3.3 í™•ì •):**

Notification Throttling ê·œì¹™ì€ ì•„ë˜ ì„¹ì…˜ì—ì„œë§Œ ì •ì˜í•˜ê³ , ë‹¤ë¥¸ ì„¹ì…˜(ì˜ˆ: 10.7 Rate Limit & Abuse Detection)ì—ì„œëŠ” ì°¸ì¡° í˜•íƒœë¡œë§Œ ì–¸ê¸‰í•©ë‹ˆë‹¤.

#### 3.5.5 Notification Throttling Rule (ì•Œë¦¼ ì²˜ë¦¬ëŸ‰ ì œí•œ ê·œì¹™)

**âš ï¸ ì‹¤ì‹œê°„ Rate Limit (ì´ˆ ë‹¨ìœ„):**

ìë™í™”ê°€ ë§ì•„ì§ˆ ê²½ìš° ë©”ì‹œì§€ í­ì£¼ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ì œí•œ ê·œì¹™:

**Rate Limit (ë‹¨ì¼ ì •ë³¸):**
- ì„œë²„ ì „ì²´: 50ê±´/ì´ˆ
- ë‹¨ì¼ í…Œë„ŒíŠ¸: 3ê±´/ì´ˆ
- ì´ˆê³¼ ì‹œ ìë™ íì‰ ë° ì§€ì—° ì²˜ë¦¬

**âš ï¸ ë©”ì‹œì§€ ì „ì†¡ ì§€ì—° UX:**

Rate limit â†’ Event Queue â†’ DLQ â†’ Retry íë¦„ì—ì„œ ì „ì†¡ ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ:

```typescript
notification_delay_ux = {
  // ì „ì†¡ ì§€ì—° ì‹œ ì‚¬ìš©ìì—ê²Œ ëª…ì‹œ
  show_pending_status: true,
  pending_message: 'ë°œì†¡ ëŒ€ê¸° ì¤‘',

  // ì§€ì—° ì‹œê°„ í‘œì‹œ
  show_delay_time: true,
  delay_threshold_seconds: 5  // 5ì´ˆ ì´ìƒ ì§€ì—° ì‹œ í‘œì‹œ
}
```

**ğŸ‘‰ ë©”ì‹œì§€ ì „ì†¡ì§€ì—°ì„ ì‚¬ìš©ìì—ê²Œ ëª…ì‹œí•˜ëŠ” UXê°€ í•„ìš” ("ë°œì†¡ ëŒ€ê¸° ì¤‘")**

**ì¤‘ë³µ ë°œì†¡ ë°©ì§€:**
- ë¶€ëª¨ 1ëª…ë‹¹ ë™ì¼ ë©”ì‹œì§€ëŠ” 10ë¶„ ì•ˆì— 1íšŒë§Œ ë°œì†¡
- ì¶œê²°/í•˜ì› ì•Œë¦¼ì€ ì—°ì† 3ë¶„ ì´ë‚´ ì¤‘ë³µ ë°œì†¡ ê¸ˆì§€
- ë™ì¼ ì´ë²¤íŠ¸ì˜ ì¤‘ë³µ ë°œì†¡ ë°©ì§€ (idempotency_key ì‚¬ìš©)

**Fallback Delay ê·œì¹™:**
- Queue Overflow ì‹œ "ì§€ì—° ë°œì†¡ ëª¨ë“œ" ì „í™˜
- ê¸´ê¸‰ ì•Œë¦¼ì€ ìš°ì„  ì²˜ë¦¬, ì¼ë°˜ ì•Œë¦¼ì€ ì§€ì—°
- ì§€ì—° ë°œì†¡ ì‹œ ì‚¬ìš©ìì—ê²Œ "ë°œì†¡ ëŒ€ê¸° ì¤‘" ìƒíƒœ í‘œì‹œ

**ë¹„ìš© ìµœì í™”:**
- ë™ì¼ ë‚´ìš© ë°˜ë³µ ë°œì†¡ ê¸ˆì§€ë¡œ ë¹„ìš© ì ˆê°
- ìŠ¤íŒ¸ ì²˜ë¦¬ ë°©ì§€ë¥¼ ìœ„í•œ Rate Limit ì ìš©
- í•œ í•™ì›ë§Œ ì‚¬ìš©í•´ë„ ë©”ì‹œì§€ í­ì£¼ ë°©ì§€

**Notification Provider ë¹„ìš© ì¡°ê±´:**

ì•Œë¦¼í†¡ ì‹¤íŒ¨ â†’ SMS fallback ì‹œ ë¹„ìš© ì²˜ë¦¬ ê·œì¹™:

```typescript
notification_cost_handling = {
  // ì•Œë¦¼í†¡ ì‹¤íŒ¨ â†’ SMS fallback ì‹œ SMS ë¹„ìš©ì€ í…Œë„ŒíŠ¸ê°€ ë¶€ë‹´
  fallback_sms_cost: {
    payer: 'tenant',
    billing_method: 'monthly_invoice'
  },

  // SMS ë¹„ìš© ì•ˆë‚´ëŠ” ì²­êµ¬ì„œ PDF ë˜ëŠ” ì„¤ì • UIì—ì„œ í‘œì‹œ
  cost_display: {
    location: ['invoice_pdf', 'settings_ui'],
    details: ['sms_count', 'sms_cost_per_unit', 'total_cost']
  }
}
```

**ë¹„ìš© ì²˜ë¦¬ ê·œì¹™:**
- ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ì‹¤íŒ¨ ì‹œ SMS fallback ë¹„ìš©ì€ í…Œë„ŒíŠ¸ ë¶€ë‹´
- ì›”ë³„ ì²­êµ¬ì„œì— SMS ì‚¬ìš©ëŸ‰ ë° ë¹„ìš© ëª…ì‹œ
- ì„¤ì • UIì—ì„œ SMS ë¹„ìš© ì•ˆë‚´ ë° ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ì œê³µ
- ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ì•½ê´€ ê¸°ë°˜ ë¹„ìš© ì²˜ë¦¬ ëª…ì‹œ

#### 3.5.6 í•™ë¶€ëª¨ ì¤‘ë³µ ìˆ˜ì‹  ì œì–´

**âš ï¸ ìˆ˜ì‹ ì ë‹¨ìœ„ Limit (ì¼/10ë¶„ ë‹¨ìœ„):**

**í•™ë¶€ëª¨(contact_id) ë‹¨ìœ„ Rate Limit:**

```
max_notifications_per_parent_per_day = 20
- í•™ë¶€ëª¨ 1ëª…ë‹¹ í•˜ë£¨ ìµœëŒ€ 20ê±´ ì œí•œ
- ì´ˆê³¼ ì‹œ íì— ì €ì¥ í›„ ë‹¤ìŒ ë‚  ë°œì†¡
- ê¸´ê¸‰ ì•Œë¦¼ì€ ì œí•œ ì˜ˆì™¸ (ìµœëŒ€ 5ê±´)
```

**same_message_hash ì œì–´:**
```
same_message_hash cannot be sent to same_parent within 10 minutes
- ë™ì¼ ë©”ì‹œì§€ í•´ì‹œëŠ” 10ë¶„ ë‚´ ì¤‘ë³µ ë°œì†¡ ê¸ˆì§€
- ë©”ì‹œì§€ ë‚´ìš© ê¸°ë°˜ í•´ì‹œ ìƒì„±
```

**í•™ë¶€ëª¨ ì¤‘ë³µ ìˆ˜ì‹  ì‹œë‚˜ë¦¬ì˜¤ ëŒ€ì‘:**

ìë…€ 2ëª… ì´ìƒì¸ ê²½ìš°:
- ì¶œê²° ì•Œë¦¼ì´ 2ë°°ë¡œ í­ì£¼ ê°€ëŠ¥ â†’ ì¼ì¼ ì œí•œìœ¼ë¡œ ë°©ì§€
- ë¯¸ë‚© ì•Œë¦¼ë„ ì¤‘ë³µ ë°œì†¡ ê°€ëŠ¥ â†’ ë©”ì‹œì§€ í•´ì‹œë¡œ ë°©ì§€
- ë™ì¼ ë‚´ìš© ì•Œë¦¼ì€ 10ë¶„ ë‚´ 1íšŒë§Œ ë°œì†¡

**ì¤‘ë³µ ìˆ˜ì‹  ì œì–´ ë¡œì§:**
- ë°œì†¡ ì „ contact_id + message_hash ì¡°í•© í™•ì¸
- 10ë¶„ ë‚´ ë™ì¼ ì¡°í•© ë°œê²¬ ì‹œ ë°œì†¡ ì·¨ì†Œ
- ì¼ì¼ ë°œì†¡ëŸ‰ 20ê±´ ì´ˆê³¼ ì‹œ íì— ì €ì¥

**ëª¨ë‹ˆí„°ë§:**
- ë°œì†¡ëŸ‰ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼
- Rate Limit ì´ˆê³¼ ì‹œ ê´€ë¦¬ì ì•Œë¦¼
- ë°œì†¡ ì‹¤íŒ¨ìœ¨ ì¶”ì  ë° ë¦¬í¬íŠ¸

#### 3.5.7 Quota / Billing / Abuse Prevention ì •ì±…

**âš ï¸ í…Œë„ŒíŠ¸ ë‹¨ìœ„ Quota (ì¼ ë‹¨ìœ„):**

ëŒ€ê·œëª¨ í•™ì›(í•™ìƒ 500~2000ëª…) ì‚¬ìš© ì‹œ ë¦¬ì†ŒìŠ¤ í­ì£¼ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ì •ì±…:

**â‘  í…Œë„ŒíŠ¸ë³„ ë©”ì‹œì§€ ì¼ì¼ ë°œì†¡ëŸ‰(Quota)**
- ê¸°ë³¸: 5,000ê±´/ì¼
- ì´ˆê³¼ ì‹œ ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”
- ì´ˆê³¼ ì‚¬ìš© ì‹œ ì¶”ê°€ ê³¼ê¸ˆ ë˜ëŠ” í”Œëœ ì—…ê·¸ë ˆì´ë“œ ì•ˆë‚´

**â‘¡ í…Œë„ŒíŠ¸ë³„ AI í˜¸ì¶œëŸ‰ ì œí•œ**
- ìƒë‹´ì¼ì§€ ìš”ì•½: í•˜ë£¨ 200ê±´ ì œí•œ
- AI ë¦¬í¬íŠ¸ ìƒì„±: í•˜ë£¨ 10ê±´ ì œí•œ
- ì¶œê²° ì´ìƒ íƒì§€: ì‹¤ì‹œê°„ (ì œí•œ ì—†ìŒ)
- ì´ˆê³¼ ì‹œ "AI í˜¸ì¶œ í•œë„ ì´ˆê³¼" ì•Œë¦¼ ë° ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”

**â‘¢ í…Œë„ŒíŠ¸ë³„ í†µê³„/AI ì—…ë°ì´íŠ¸ ë¹ˆë„ ì œí•œ**
- í†µê³„ ë¦¬í”„ë ˆì‹œ: 1ë¶„ì— 1íšŒ ì œí•œ
- AI ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸: 10ë¶„ì— 1íšŒ ì œí•œ
- ì´ˆê³¼ ìš”ì²­ì€ íì— ì €ì¥ í›„ ìˆœì°¨ ì²˜ë¦¬

**â‘£ Abuse ë°©ì§€ ë£°**
- ë™ì¼ IPì—ì„œ ê³¼ë„í•œ ìš”ì²­: 1ë¶„ì— 100íšŒ ì´ˆê³¼ ì‹œ ìë™ ì°¨ë‹¨
- ìŠ¤íŒ¸ì„± ë©”ì‹œì§€ ìë™ ì°¨ë‹¨: AI ê¸°ë°˜ ìŠ¤íŒ¸ ê°ì§€
- ë¯¸ë‚© ì•Œë¦¼ì„ í•˜ë£¨ ìˆ˜ì‹­ ë²ˆ ë³´ë‚´ëŠ” ì‹œë‚˜ë¦¬ì˜¤ ë°©ì§€: ë™ì¼ ìˆ˜ì‹ ì 1ì¼ 3íšŒ ì œí•œ
- ë¹„ì •ìƒ íŒ¨í„´ ê°ì§€ ì‹œ ìë™ ê³„ì • ì¼ì‹œ ì •ì§€

**Quota ê´€ë¦¬:**
- Quota ì‚¬ìš©ëŸ‰ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
- Quota ì´ˆê³¼ ì‹œ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— ì•Œë¦¼
- Quota ì¦ê°€ ìš”ì²­ í”„ë¡œì„¸ìŠ¤ ì œê³µ

#### 3.5.8 ê³ ê¸‰ ê¸°ëŠ¥ (Advanced ì˜µì…˜ì—ì„œë§Œ ì œê³µ)

**í…œí”Œë¦¿ ê´€ë¦¬**
- ë©”ì‹œì§€ í…œí”Œë¦¿ ìƒì„± ë° ê´€ë¦¬
- í…œí”Œë¦¿ ë³€ìˆ˜ ì„¤ì •

**ì˜ˆì•½ ë°œì†¡**
- ì˜ˆì•½ ì‹œê°„ ì„¤ì • ë° ë°œì†¡

**ìë™ ë¯¸ë‚© ì•Œë¦¼ ê´€ë¦¬**
- ë¯¸ë‚© ì•Œë¦¼ ê·œì¹™ ì„¤ì •

**ì•Œë¦¼í†¡ í…œí”Œë¦¿ ìŠ¹ì¸**
- ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ í…œí”Œë¦¿ ê´€ë¦¬

**ë©”ì‹œì§€ ì±„ë„ ë¼ìš°íŒ… ì„¤ì •**
- SMS/ì•Œë¦¼í†¡ ìš°ì„ ìˆœìœ„ ì„¤ì •

**ë°œì†¡ ë‚´ì—­ ì¡°íšŒ**
- ìƒì„¸ ë°œì†¡ ì´ë ¥ í™•ì¸

**UI ìš”êµ¬ì‚¬í•­:**

- ë©”ì‹œì§€ í™”ë©´ì—ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 'ê³µì§€ ë³´ë‚´ê¸°' ë²„íŠ¼ë§Œ ë³´ì´ë©°,
- í…œí”Œë¦¿ ê´€ë¦¬, ì˜ˆì•½ë°œì†¡, ì±„ë„ ì„¤ì • ë“±ì€ ê³ ê¸‰ ì˜µì…˜ì—ì„œ ì œê³µí•œë‹¤.

### 3.6 ì§€ì—­ ê¸°ë°˜ í†µê³„(Regional Analytics)

(ì¶œê²°ë²„ìŠ¤ì— ì—†ëŠ” "ì´ˆê²©ì°¨ ê¸°ëŠ¥")

**ì¤‘ìš”: ê¸°ë³¸ ì§€ì—­ í†µê³„ ê¸°ëŠ¥ì€ ìƒìš©í™” ë‹¨ê³„ì— í¬í•¨ë©ë‹ˆë‹¤.**

**âš ï¸ Regional Analytics ë¬¸ì„œ ì •í•©ì„±:**

Regional Analyticsì˜ ìƒì„¸ SRS, í…Œì´ë¸” êµ¬ì¡°, ì§€í‘œ ì •ì˜ëŠ” í†µê³„ë¬¸ì„œ v1.0(RA1)ì„ ì •ë³¸ìœ¼ë¡œ ë”°ë¥¸ë‹¤. í…Œì´ë¸”/ë·° ëª…ì¹­ì€ ë³¸ ë¬¸ì„œì˜ Regional Analytics ë§¤í•‘í‘œ(3.6.5 ì„¹ì…˜)ì™€ í†µê³„ë¬¸ì„œ v1.0ì´ ë™ì¼í•˜ê²Œ ìœ ì§€ëœë‹¤.

#### 3.6.1 í…Œë„ŒíŠ¸ ìœ„ì¹˜ ì„¤ì • ê·œì¹™

ì§€ì—­ ê¸°ë°˜ í†µê³„ë¥¼ í•˜ë ¤ë©´ ê° í•™ì›ì˜ í–‰ì •ë™/êµ¬/ì‹œ ë‹¨ìœ„ ì •ë³´ê°€ í•„ìš”í•˜ë‹¤.

**location.* ê²½ë¡œ í•„ë“œ êµ¬ì¡° (ì €ì¥ ìœ„ì¹˜: tenant_settings(key='config').value(JSONB)):**

```json
{
  "location": {
    "si": "ì„œìš¸íŠ¹ë³„ì‹œ",
    "gu": "ê°•ë‚¨êµ¬",
    "dong": "ëŒ€ì¹˜ë™",
    "lat": 37.498,
    "lng": 127.061
  }
}
```

**ìœ„ì¹˜ ì •ë³´ í•„ìˆ˜ì„±:**
- ì´ ê°’ì´ ì—†ìœ¼ë©´ ì§€ì—­ í‰ê·  ë¹„êµ ë¶ˆê°€
- AI ì¸ì‚¬ì´íŠ¸ê°€ ì§€ì—­ ê¸°ë°˜ ë¶„ì„ì„ ëª»í•¨
- ì§€ë„ ê¸°ë°˜ í†µê³„ë„ ë¶ˆê°€ëŠ¥

**ìœ„ì¹˜ ì •ë³´ ì„¤ì •:**
- í…Œë„ŒíŠ¸ ìƒì„± ì‹œ ìœ„ì¹˜ ì •ë³´ í•„ìˆ˜ ì…ë ¥
- ì„¤ì • í™”ë©´ì—ì„œ ìœ„ì¹˜ ì •ë³´ ìˆ˜ì • ê°€ëŠ¥
- ì£¼ì†Œ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ í–‰ì •ë™/êµ¬/ì‹œ ë§¤í•‘
- GPS ì¢Œí‘œëŠ” ì„ íƒ ì‚¬í•­ (ì§€ë„ ê¸°ëŠ¥ ì‚¬ìš© ì‹œ í•„ìš”)

**ìœ„ì¹˜ ì •ë³´ í™œìš©:**
- ì§€ì—­ í‰ê·  ê³„ì‚° ì‹œ í•´ë‹¹ ì§€ì—­ì˜ ëª¨ë“  í•™ì› ë°ì´í„° ì§‘ê³„
- ì§€ì—­ ìˆœìœ„ ê³„ì‚° ì‹œ ë™ì¼ ì§€ì—­ ë‚´ ìˆœìœ„ ì‚°ì¶œ
- AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹œ ì§€ì—­ íŠ¹ì„± ë°˜ì˜

#### 3.6.2 ì§€ì—­ì½”ë“œ ê·œì¹™(í–‰ì •ë™ ì½”ë“œí‚¤)

ì§€ì—­ ë¶„ì„ê³¼ ë¹„êµì—ëŠ” ë°˜ë“œì‹œ ì§€ì—­ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.

**ì§€ì—­ ì½”ë“œ êµ¬ì¡°:**

**location_code (í–‰ì •ë™ ì½”ë“œ):**
- H_DONG_CODE í˜•ì‹
- ì˜ˆ: 1168010100 (ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ëŒ€ì¹˜ë™)
- í–‰ì •ì•ˆì „ë¶€ í‘œì¤€ í–‰ì •ë™ ì½”ë“œ ì‚¬ìš©

**sigungu_code (ì‹œêµ°êµ¬ ì½”ë“œ):**
- SIGUNGU_CODE í˜•ì‹
- ì˜ˆ: 11680 (ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬)
- í–‰ì •ì•ˆì „ë¶€ í‘œì¤€ ì‹œêµ°êµ¬ ì½”ë“œ ì‚¬ìš©

**sido_code (ì‹œë„ ì½”ë“œ):**
- SIDO_CODE í˜•ì‹
- ì˜ˆ: 11 (ì„œìš¸íŠ¹ë³„ì‹œ)
- í–‰ì •ì•ˆì „ë¶€ í‘œì¤€ ì‹œë„ ì½”ë“œ ì‚¬ìš©

**location.* ê²½ë¡œ í™•ì¥ êµ¬ì¡° (ì €ì¥ ìœ„ì¹˜: tenant_settings(key='config').value(JSONB)):**

```json
{
  "location": {
    "si": "ì„œìš¸íŠ¹ë³„ì‹œ",
    "gu": "ê°•ë‚¨êµ¬",
    "dong": "ëŒ€ì¹˜ë™",
    "lat": 37.498,
    "lng": 127.061,
    "sido_code": "11",
    "sigungu_code": "11680",
    "location_code": "1168010100"
  }
}
```

**ì§€ì—­ ì½”ë“œ í™œìš©:**
- ì§€ì—­ í‰ê·  ê³„ì‚° ì‹œ location_codeë¡œ ì¡°ì¸
- ì „êµ­ ë‹¨ìœ„ Heatmap ìƒì„± ì‹œ sido_code/sigungu_code ì‚¬ìš©
- AI ë¶„ì„ ì‹œ Administrative Join ìˆ˜í–‰
- ì§€ì—­ í†µê³„ ì§‘ê³„ ì‹œ ì½”ë“œ ê¸°ë°˜ ê·¸ë£¹í•‘

**ì§€ì—­ ì½”ë“œ ë§¤í•‘:**
- ì£¼ì†Œ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ í–‰ì •ë™ ì½”ë“œ ë§¤í•‘
- í–‰ì •ì•ˆì „ë¶€ ê³µê³µë°ì´í„° API í™œìš©
- ì½”ë“œ ë§¤í•‘ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ì…ë ¥ ê°€ëŠ¥

**âš ï¸ ì§€ì—­ ì½”ë“œ ìš©ì–´ í†µì¼ (SSOT):**

ë³¸ ë¬¸ì„œëŠ” ì§€ì—­ í†µê³„ìš© ì½”ë“œ ë„¤ì´ë°ì˜ "ì •ë³¸"ì´ë‹¤:
- í–‰ì •ë™ ì½”ë“œ â†’ `location_code` (ì •ë³¸)
- ì‹œêµ°êµ¬ ì½”ë“œ â†’ `sigungu_code` (ì •ë³¸)
- ì‹œë„ ì½”ë“œ â†’ `sido_code` (ì •ë³¸)

**SSOT ë§¤í•‘ ê·œì¹™:**
- ë‹¤ë¥¸ í†µê³„ ë¬¸ì„œ/í…Œì´ë¸”ì—ì„œ `region_code`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, `region_code = location_code`ë¡œ ë§¤í•‘ë©ë‹ˆë‹¤.
- ëª¨ë“  ì¡°ì¸/ETL/ë­í‚¹ì—”ì§„ì—ì„œëŠ” `location_code`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì •ë³¸ìœ¼ë¡œ í•©ë‹ˆë‹¤.
- `analytics.daily_region_metrics.region_code`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `location_code`ì™€ ë™ì¼í•œ ì˜ë¯¸ì…ë‹ˆë‹¤.

**ì§€ì—­ë³„ ë¹„êµ ê·¸ë£¹ ê²°ì • ë¡œì§**

í†µê³„ë¥¼ ì •í™•íˆ ë¹„êµí•˜ë ¤ë©´ "ì§€ì—­ ê·¸ë£¹"ì´ ì–´ë–»ê²Œ ì¡íˆëŠ”ì§€ ëª…í™•íˆ ì •ì˜í•´ì•¼ í•œë‹¤:

```typescript
comparison_group_rule = {
  // 1ìˆœìœ„: ê°™ì€ í–‰ì •ë™ ë‚´ í•™ì›ë“¤
  primary: 'same_dong',  // location_code ê¸°ì¤€

  // 2ìˆœìœ„: í–‰ì •ë™ ë‚´ í•™ì› ìˆ˜ê°€ ë¶€ì¡±í•˜ë©´ ê°™ì€ êµ¬ ë‚´ í•™ì›ë“¤
  fallback: 'same_sigungu',  // sigungu_code ê¸°ì¤€
  minimum_sample_size: 3,  // ìµœì†Œ 3ê°œ í•™ì› í•„ìš” (ì§€ë°©ì§€ì—­ ê³ ë ¤)

  // 3ìˆœìœ„: êµ¬ ë‚´ í•™ì› ìˆ˜ê°€ ë¶€ì¡±í•˜ë©´ ê°™ì€ ì‹œë„ ë‚´ í•™ì›ë“¤
  fallback2: 'same_sido',  // sido_code ê¸°ì¤€

  // ì—…ì¢… í•„í„°: ë™ì¼ ì—…ì¢…(industry_type) ë‚´ì—ì„œë§Œ ë¹„êµ
  industry_filter: true
}
```

**ë¹„êµ ê·¸ë£¹ ê²°ì • í”„ë¡œì„¸ìŠ¤ (ê³µì‹ í™•ì •):**
1. ê°™ì€ í–‰ì •ë™(location_code) ë‚´ í•™ì› ìˆ˜ í™•ì¸
2. 3ê°œ ë¯¸ë§Œì´ë©´ ê°™ì€ êµ¬(sigungu_code)ë¡œ í™•ì¥
3. ì—¬ì „íˆ 3ê°œ ë¯¸ë§Œì´ë©´ ê°™ì€ ì‹œë„(sido_code)ë¡œ í™•ì¥
4. ì—¬ì „íˆ 3ê°œ ë¯¸ë§Œì´ë©´ ê¶Œì—­(region_zone)ìœ¼ë¡œ í™•ì¥
5. ë™ì¼ ì—…ì¢…(industry_type) í•„í„° ì ìš©
6. ìµœì¢… ê·¸ë£¹ ë‚´ í•™ì›ë“¤ì˜ í‰ê· ê°’ ê³„ì‚°

**âš ï¸ ğŸ”¥ 9ë²ˆ: Regional Analytics ë¹„êµ ê·¸ë£¹ ë¡œì§ í†µì¼ (í™•ì •):**

**ê³µì‹ Fallback ìš°ì„ ìˆœìœ„ (ë‹¨ì¼ ì •ë³¸):**
- 1ìˆœìœ„: ë™ (location_code)
- 2ìˆœìœ„: êµ¬ (sigungu_code)
- 3ìˆœìœ„: ì‹œë„ (sido_code)
- 4ìˆœìœ„: ê¶Œì—­ (region_zone)

**ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ "ê¶Œì—­ â†’ ë™ â†’ êµ¬" í˜•íƒœë¡œ ì–¸ê¸‰ëœ ê²½ìš°ëŠ” ì˜¤ë¥˜ì…ë‹ˆë‹¤.**
**ìœ„ ìˆœì„œ(ë™ â†’ êµ¬ â†’ ì‹œë„ â†’ ê¶Œì—­)ê°€ ê³µì‹ í™•ì •ë³¸ì…ë‹ˆë‹¤.**

**âš ï¸ Regional Analytics ë¹„êµ ê·¸ë£¹ ë¡œì§ê³¼ Industry í•„í„° ì¡°í•© ì‹œ ì²˜ë¦¬ ë°©ì‹:**

ì‹¤ì œ ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ì²˜ë¦¬ ë°©ì‹ì„ ëª…í™•íˆ ì •ì˜:

```typescript
regional_comparison_with_industry_filter = {
  // Fallback ìš°ì„ ìˆœìœ„ (ì—…ì¢… í•„í„° ì ìš©)
  fallback_priority: {
    // 1ìˆœìœ„: ê°™ì€ ë™ + ê°™ì€ ì—…ì¢…
    primary: { location: 'same_dong', industry: 'same_industry' },

    // 2ìˆœìœ„: ê°™ì€ êµ¬ + ê°™ì€ ì—…ì¢…
    fallback1: { location: 'same_sigungu', industry: 'same_industry' },

    // 3ìˆœìœ„: ê°™ì€ ì‹œë„ + ê°™ì€ ì—…ì¢…
    fallback2: { location: 'same_sido', industry: 'same_industry' },

    // 4ìˆœìœ„: ê°™ì€ ê¶Œì—­ + ê°™ì€ ì—…ì¢…
    fallback3: { location: 'same_region_zone', industry: 'same_industry' },

    // 5ìˆœìœ„: ì—…ì¢… í•„í„° ì œê±° í›„ ì§€ì—­ë§Œ ë¹„êµ
    fallback4: { location: 'same_region_zone', industry: 'all_industries' }
  },

  // âš ï¸ C10 í•´ê²°: Fallback ìš°ì„ ìˆœìœ„ í†µì¼
  // ê³µì‹ ìˆœì„œ: ë™ â†’ êµ¬ â†’ ì‹œë„ â†’ ê¶Œì—­ (ìœ„ fallback_priority ì°¸ì¡°)
  // tenant_settings KV êµ¬ì¡°ì—ì„œ key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œ regional_analytics.comparison_priorityë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥í•˜ë‚˜
  // ê¸°ë³¸ê°’ì€ ìœ„ ìˆœì„œë¥¼ ë”°ë¦„

  // ìµœì†Œ ìƒ˜í”Œ ìˆ˜ ê·œì¹™
  minimum_sample_size: {
    primary: 3,      // 1ìˆœìœ„ ê·¸ë£¹ ìµœì†Œ 3ê°œ (ì§€ë°©ì§€ì—­ ê³ ë ¤í•˜ì—¬ 5ì—ì„œ 3ìœ¼ë¡œ ì¡°ì •)
    fallback: 3,      // Fallback ê·¸ë£¹ ìµœì†Œ 3ê°œ
    absolute_minimum: 3  // ì ˆëŒ€ ìµœì†Œê°’

    // âš ï¸ ì‹¤ì œ ìš´ì˜ ê³ ë ¤ì‚¬í•­:
    // "ìµœì†Œ ì§€ì—­ ìƒ˜í”Œ 5ê°œ"ëŠ” ì‹¤ì œ í•™ì› í†µê³„ì—ì„œ ì§€ë‚˜ì¹˜ê²Œ ë†’ì€ í¸
    // ì„œìš¸ ì´ì™¸ ì§€ì—­ì—ì„œëŠ” ê±°ì˜ í•­ìƒ "ë¹„êµ ë¶ˆê°€"ë¡œ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ
    // â†’ ê¸°ë³¸ê°’ì„ 3ìœ¼ë¡œ ì¡°ì •í•˜ì—¬ ì§€ë°©ì§€ì—­ì—ì„œë„ ì‘ë™í•˜ë„ë¡ ê°œì„ 
    // â†’ tenant_settings KV êµ¬ì¡°ì—ì„œ key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œ regional_analytics.minimum_sample_sizeë¡œ ì¡°ì • ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  },

  // AI ë¬¸ì¥ ì¶œë ¥ ê·œì¹™ ê°•í™”
  ai_insight_message_rule = {
    // ë¹„êµ ë¶ˆê°€ ì‹œ ë©”ì‹œì§€
    insufficient_sample: {
      condition: 'count(academies_in_group) < 3',
      message: 'ë¹„êµí•  ìˆ˜ ìˆëŠ” í•™ì›ì´ ë¶€ì¡±í•˜ì—¬ ì§€ì—­ ë¹„êµ ë¶„ì„ì„ ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
    },

    // Fallback ì‚¬ìš© ì‹œ ë©”ì‹œì§€
    fallback_used: {
      condition: 'used_fallback_group',
      message_template: '{fallback_level} ê¸°ì¤€ìœ¼ë¡œ í‰ê·  ëŒ€ë¹„ {comparison_result}',
      example: 'ë™ì—ì„œëŠ” ë¹„êµ ë¶ˆê°€í–ˆì§€ë§Œ, êµ¬ ê¸°ì¤€ìœ¼ë¡œ í‰ê·  ëŒ€ë¹„ +7% ìš°ìˆ˜í•©ë‹ˆë‹¤.'
    },

    // ì—…ì¢… í•„í„° ì œê±° ì‹œ ë©”ì‹œì§€
    industry_filter_removed: {
      condition: 'industry_filter_removed',
      message: 'ë™ì¼ ì—…ì¢… ë¹„êµê°€ ë¶ˆê°€í•˜ì—¬ ì „ì²´ ì—…ì¢… ê¸°ì¤€ìœ¼ë¡œ ë¹„êµí–ˆìŠµë‹ˆë‹¤.'
    }
  }
}
```

**ìµœì†Œí‘œë³¸ìˆ˜ ë¯¸ë‹¬ ì‹œ ì²˜ë¦¬:**

ë¹„êµ ê·¸ë£¹ì˜ í•™ì› ìˆ˜ê°€ ìµœì†Œí‘œë³¸ìˆ˜ ë¯¸ë§Œì¼ ë•Œ:

```typescript
minimum_sample_handling = {
  // N < 3ì´ë©´ ì§€ì—­ ë¹„êµ ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŒ
  insufficient_sample: {
    condition: 'count(academies_in_group) < 3',
    action: 'skip_comparison',
    message: 'ë¹„êµí•  í•™ì› ìˆ˜ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
  },

  // 3 <= N < 5ì´ë©´ ê²½ê³  ë©”ì‹œì§€ì™€ í•¨ê»˜ ë¹„êµ ìˆ˜í–‰ (Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ minimum_sample_size=3ìœ¼ë¡œ ì„¤ì •ê°’ ì €ì¥ë˜ì–´ ìˆì–´ ì´ êµ¬ê°„ì€ ì‚¬ì‹¤ìƒ ì‚¬ìš© ì•ˆ ë¨)
  low_sample: {
    condition: '3 <= count(academies_in_group) < 5',
    action: 'show_warning',
    message: 'ë¹„êµ ëŒ€ìƒ í•™ì› ìˆ˜ê°€ ì ì–´ ì •í™•ë„ê°€ ë‚®ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
  }
}
```

**ì²˜ë¦¬ ê·œì¹™:**
- í•™ì› ìˆ˜ê°€ 3ê°œ ë¯¸ë§Œì´ë©´ ì§€ì—­ ë¹„êµ ì¸ì‚¬ì´íŠ¸ ìƒì„± ì•ˆ í•¨
- "ë¹„êµí•  í•™ì› ìˆ˜ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤" ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
- 3ê°œ ì´ìƒì´ë©´ ì •ìƒ ë¹„êµ ìˆ˜í–‰ (ì§€ë°©ì§€ì—­ ê³ ë ¤í•˜ì—¬ ê¸°ë³¸ê°’ 3ìœ¼ë¡œ ì¡°ì •)
- âš ï¸ **minimum_sample_size ê¸°ë³¸ê°’ ë³€ê²½**: 5 â†’ 3 (ì§€ë°©ì§€ì—­ì—ì„œ ëŒ€ë¶€ë¶„ ì‘ë™í•˜ì§€ ì•ŠëŠ” ë¬¸ì œ í•´ê²°)

#### 3.6.3 AI í•´ì„ ë¬¸ì¥ ì¤‘ì‹¬ (ì´ˆë³´ì ì¹œí™”ì )

**UI êµ¬ì„± ì›ì¹™**

"AI í•´ì„ ë¬¸ì¥"ì„ ìµœìƒë‹¨ì— ë°°ì¹˜
- ì˜ˆì‹œ: "ì´ë²ˆ ì£¼ ì¶œì„ë¥  +3% í–¥ìƒ, ì§€ì—­ í‰ê·  ëŒ€ë¹„ +4% ìš°ìˆ˜í•©ë‹ˆë‹¤."
- ê·¸ë˜í”„ëŠ” ì•„ë˜ë¡œ "í¼ì¹˜ê¸°" ì²˜ë¦¬
- ì´ˆë³´ìë„ ìˆ«ìì™€ ê·¸ë˜í”„ ì—†ì´ ë¬¸ì¥ìœ¼ë¡œ ì´í•´ ê°€ëŠ¥

**UI ë…¸ì¶œ ë°©ì‹:**
- ì§€ì—­ ê¸°ë°˜ í†µê³„ëŠ” ë””ì–´ìŒ¤ì˜ í•µì‹¬ ê¸°ëŠ¥ìœ¼ë¡œ, ê¸°ë³¸ ë©”ë‰´ì—ì„œ í•­ìƒ ë…¸ì¶œëœë‹¤.
- ì´ˆë³´ ì‚¬ìš©ìë¥¼ ìœ„í•´ ê¸°ë³¸ í™”ë©´ì€ AI í•´ì„ ë¬¸ì¥ ì¤‘ì‹¬, ìƒì„¸ ë¶„ì„ë§Œ ë³„ë„ í˜ì´ì§€ì—ì„œ ì œê³µí•œë‹¤.

#### 3.6.4 ë°ì´í„° ì—…ë°ì´íŠ¸ ì£¼ê¸° ì •ì˜ (ì›ì²œâ†’Staging ì§‘ê³„ ì£¼ê¸°)

**âš ï¸ 2-1: Regional Analytics ì§‘ê³„ ì£¼ê¸° vs MV Refresh ì£¼ê¸° ëª…í™•í™”:**

**ì›ì²œâ†’Staging ì§‘ê³„ ì£¼ê¸° (ì •ë³¸):**

**attendance_stats_staging: 1ë¶„ ë‹¨ìœ„**
- ì¶œê²° ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì›ì²œ ë°ì´í„°(attendance_logs)ì—ì„œ Staging í…Œì´ë¸”ë¡œ ì§‘ê³„
- 1ë¶„ ë‹¨ìœ„ë¡œ ì§‘ê³„ ë°ì´í„° ì—…ë°ì´íŠ¸
- ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œì— ë°˜ì˜

**class_heatmap_staging: 10ë¶„ ë‹¨ìœ„**
- ë°˜ë³„ ì¶œê²° íˆíŠ¸ë§µì€ ì›ì²œ ë°ì´í„°ì—ì„œ Staging í…Œì´ë¸”ë¡œ 10ë¶„ ë‹¨ìœ„ë¡œ ì§‘ê³„
- ì‹¤ì‹œê°„ì„±ë³´ë‹¤ëŠ” ì •í™•ì„± ìš°ì„ 
- ì¼ë³„ ì§‘ê³„ ë°ì´í„°ëŠ” ë§¤ì¼ ìì •ì— ìƒì„±

**analytics.daily_region_metrics: 1ì¼ 1íšŒ (00:30)**
- ì§€ì—­ í†µê³„ëŠ” í•˜ë£¨ 1íšŒ ìì • 30ë¶„ì— ì§‘ê³„ (ì •ë³¸ ì´ë¦„: analytics.daily_region_metrics)
- ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ìµœì í™”
- âš ï¸ ì°¸ê³ : regional_metrics_dailyëŠ” êµ¬ë²„ì „/íê¸°ëœ ë„¤ì´ë°ì…ë‹ˆë‹¤. ì •ë³¸ì€ analytics.daily_region_metricsë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

**âš ï¸ 2-4: AI ì¸ì‚¬ì´íŠ¸ ìŠ¤ì¼€ì¤„ (Phase êµ¬ë¶„):**

**ai_insight:**
- **ìƒìš©í™” ë‹¨ê³„**: ì£¼ê°„ ë¸Œë¦¬í•‘ (ë§¤ì£¼ ì›”ìš”ì¼ 07:00), ì£¼ê°„ ëª¨ë¸ ì¬í•™ìŠµ, Daily briefing â†’ 07:00 ì„œë²„ê°€ ìƒì„± (AI í˜¸ì¶œ í¬í•¨), ê³ ê¸‰ ì¸ì‚¬ì´íŠ¸ ì‹¤ì‹œê°„ ê°ì§€
- Risk detection â†’ ì‹¤ì‹œê°„ ê°ì§€ ë° ì—…ë°ì´íŠ¸ (ìƒìš©í™” ë‹¨ê³„ë¶€í„° ì ìš©)

**âš ï¸ MV Refresh ì£¼ê¸°ëŠ” 7.5 Materialized View ì„¤ê³„ ì„¹ì…˜ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.**

#### 3.6.5 Analytics Pipeline Specification (ë°ì´í„° íŒŒì´í”„ë¼ì¸ êµ¬ì¡°)

**âš ï¸ 2-1: Materialized View Refresh ì „ëµì€ 7.5 Materialized View ì„¤ê³„ ì„¹ì…˜ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.**

í†µê³„ ì •í•©ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ 3ê³„ì¸µ ë°ì´í„° íŒŒì´í”„ë¼ì¸:

**Raw Layer (ì›ì²œ ë°ì´í„°):**
- attendance_logs: ì¶œê²° ì›ë³¸ ë¡œê·¸
- payments: ê²°ì œ ì›ë³¸ ë°ì´í„°
- invoices: ì²­êµ¬ì„œ ì›ë³¸ ë°ì´í„°
- students, classes ë“± ê¸°ë³¸ ì—”í‹°í‹°

**Staging Layer (ì§‘ê³„ ë°ì´í„°):**
- 1ë¶„/10ë¶„ ë‹¨ìœ„ aggregate ìˆ˜í–‰
- daily_attendance_stats: ì¼ë³„ ì¶œê²° í†µê³„
- class_attendance_heatmap: ë°˜ë³„ ì¶œê²° íˆíŠ¸ë§µ
- hourly_payment_stats: ì‹œê°„ë³„ ê²°ì œ í†µê³„

**Analytics Layer (ë¶„ì„ ë°ì´í„°):**
- AIÂ·ì§€ì—­í†µê³„ìš© ìµœì¢… ë°ì´í„°
- analytics.daily_store_metrics: ë§¤ì¥ ë‹¨ìœ„ ì¼ë³„ KPI (ì •ë³¸, SSOT)
- analytics.daily_region_metrics: ì§€ì—­ ë‹¨ìœ„ ì§‘ê³„ KPI (ì •ë³¸, SSOT)
- ai_insights: AI ì¸ì‚¬ì´íŠ¸ ë…¼ë¦¬ í…Œì´ë¸” (ì •ë³¸, SSOT, í•„ìš” ì‹œ MVë¡œ íŒŒìƒ ê°€ëŠ¥)

**âš ï¸ ì¤‘ìš”: Analytics í…Œì´ë¸” ëª…ì¹­ ì •ë³¸í™” (SSOT):**

ë³¸ ë¬¸ì„œì—ì„œ ê¸°ìˆ í•˜ëŠ” ì§€ì—­ í†µê³„ í…Œì´ë¸”ì€ í†µê³„ë¬¸ì„œ(RA1)ì™€ ê¸°ìˆ ë¬¸ì„œì˜ ì •ì‹ í…Œì´ë¸”ëª…ì„ ê¸°ì¤€ìœ¼ë¡œ ì •ë³¸í™”í•©ë‹ˆë‹¤.

**ì •ë³¸ í…Œì´ë¸” (SSOT):**
- `analytics.daily_store_metrics`: ë§¤ì¥ ë‹¨ìœ„ ì¼ë³„ KPI (ì •ë³¸)
- `analytics.daily_region_metrics`: ì§€ì—­ ë‹¨ìœ„ ì§‘ê³„ KPI (ì •ë³¸)

**êµ¬ë²„ì „/íê¸°ëœ ë„¤ì´ë° (ì‚¬ìš© ê¸ˆì§€):**
- ~~regional_metrics_daily~~ â†’ analytics.daily_region_metricsë¡œ êµì²´
- ~~academy_metrics_daily~~ â†’ analytics.daily_store_metricsë¡œ êµì²´
- ~~analytics.daily_metrics~~ â†’ analytics.daily_store_metricsë¡œ êµì²´
- ~~analytics.monthly_revenue~~ â†’ analytics.daily_store_metricsì—ì„œ íŒŒìƒ (í•„ìš” ì‹œ)

**Materialized View/ë·° (ì„±ëŠ¥ ìµœì í™”ìš©, ì„ íƒ):**
- ì„±ëŠ¥ì´ í•„ìš”í•œ ê²½ìš° `analytics.daily_region_metrics`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ MVë¥¼ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë‚˜, ì •ë³¸ í…Œì´ë¸”ì€ `analytics.daily_region_metrics`ì…ë‹ˆë‹¤.
- í†µê³„ë¬¸ì„œ(RA1)ì™€ ê¸°ìˆ ë¬¸ì„œê°€ ë‹¨ì¼ ì •ë³¸(Single Source of Truth)ì…ë‹ˆë‹¤.

**âš ï¸ Materialized View Refresh ì „ëµì€ 7.5 Materialized View ì„¤ê³„ ì„¹ì…˜ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.**

**ë°ì´í„° íë¦„ (Data Flow):**

**ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ â†’ Analytics:**
- ì¶œê²° ì´ë²¤íŠ¸, ê²°ì œ ì´ë²¤íŠ¸ ë“± ì‹¤ì‹œê°„ ë°œìƒ â†’ `analytics.events` í…Œì´ë¸”ì— ê¸°ë¡
  - âš ï¸ ì°¸ê³ : `analytics.events.event_type`ì€ ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ `event_type`ê³¼ ë‹¤ë¥¸ ë„ë©”ì¸ ê°’ì…ë‹ˆë‹¤. `analytics.events.event_type`ì€ ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ íƒ€ì…(ì˜ˆ: `attendance.check_in`, `payment_webhook`)ì´ë©°, ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ `event_type`ì€ ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ í‚¤(ì˜ˆ: `overdue_outstanding_over_limit`, `payment_due_reminder`)ì…ë‹ˆë‹¤.
- Edge Functionì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì§‘í•˜ê³  ì „ì²˜ë¦¬

**ë°°ì¹˜ ì§‘ê³„ â†’ Analytics:**
- `analytics.events` â†’ `analytics.daily_store_metrics` (ë§¤ì¥ ë‹¨ìœ„ ì¼ë³„ ì§‘ê³„, ì •ë³¸)
- `analytics.events` â†’ `analytics.daily_region_metrics` (ì§€ì—­ ë‹¨ìœ„ ì§‘ê³„, ì •ë³¸)
- Cron Job ê¸°ë°˜ ì£¼ê¸°ì  ì§‘ê³„ ì‹¤í–‰

**âš ï¸ ì¤‘ìš”: analytics.daily_metrics, analytics.monthly_revenueëŠ” êµ¬ë²„ì „/íê¸°ëœ ë„¤ì´ë°ì´ë©° ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ë³¸ì€ analytics.daily_store_metrics, analytics.daily_region_metricsë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.**

**AI ì—”ì§„ â†’ AI ì‚°ì¶œë¬¼:**
- `analytics.daily_store_metrics` + `analytics.daily_region_metrics` â†’ AI ì—”ì§„ ì…ë ¥
- AI ì—”ì§„ â†’ `ai_student_risk_scores` (ë˜ëŠ” ìœ ì‚¬ í…Œì´ë¸”) ìƒì„±
- Risk Score ê³„ì‚° ë° ì´ìƒ íƒì§€ ìˆ˜í–‰

**UI â†’ ì‚¬ìš©ì í™”ë©´:**
- `ai_student_risk_scores` â†’ `TaskCard` ìƒì„± (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- `ai_student_risk_scores` â†’ Emergency ë¦¬ìŠ¤íŠ¸ í™”ë©´ í‘œì‹œ
- `analytics.daily_store_metrics` â†’ Regional Analytics ëŒ€ì‹œë³´ë“œ í‘œì‹œ

**íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ìœ„ì¹˜:**
- Edge Function: ì‹¤ì‹œê°„ ì§‘ê³„ (1ë¶„/10ë¶„ ë‹¨ìœ„)
- Cron Job: ì¼ì¼ ì§‘ê³„ (analytics.daily_store_metrics, analytics.daily_region_metrics)
- ì™¸ë¶€ ETL (ì„ íƒ): ëŒ€ê·œëª¨ ë°ì´í„° ì²˜ë¦¬ ì‹œ AWS Athena/Kinesis í™œìš©

**í…Œë„ŒíŠ¸ ë°ì´í„° ë¶„ë¦¬ ì „ëµ:**
- ëª¨ë“  ì§‘ê³„ëŠ” tenant_id ê¸°ì¤€ìœ¼ë¡œ ì™„ì „ ë¶„ë¦¬
- RLS ì •ì±…ìœ¼ë¡œ í…Œë„ŒíŠ¸ ê°„ ë°ì´í„° ì ‘ê·¼ ì°¨ë‹¨
- Materialized Viewë„ í…Œë„ŒíŠ¸ë³„ë¡œ ë¶„ë¦¬ ìƒì„±

**ìºì‹± ì „ëµ:**
- í†µê³„ ë·°ëŠ” Materialized Viewë¡œ ìºì‹±
- ìì£¼ ì¡°íšŒë˜ëŠ” í†µê³„ëŠ” Redis ìºì‹œ í™œìš©
- ìºì‹œ ë¬´íš¨í™”ëŠ” ë°ì´í„° ê°±ì‹  ì‹œ ìë™ ìˆ˜í–‰

#### 3.6.6 ë°ì´í„° ë¬´ê²°ì„± ë³´ì •(Backfill & Repair) ë¡œì§

ì‹¤ì œ ìš´ì˜ì—ì„œ ë°œìƒí•˜ëŠ” ë°ì´í„° ëˆ„ë½/ì˜¤ë¥˜ë¥¼ ë³´ì •í•˜ëŠ” í”„ë¡œì„¸ìŠ¤:

**â‘  Backfill Job**
- ì§€ë‚œ Nì¼ ë°ì´í„° ì¬ì§‘ê³„
- íŠ¹ì • í…Œë„ŒíŠ¸ë§Œ ì¬ì§‘ê³„ ê°€ëŠ¥í•´ì•¼ í•¨
- Webhook ì§€ì—°ìœ¼ë¡œ ê²°ì œ ì •ë³´ê°€ ëŠ¦ê²Œ ë“¤ì–´ì˜¨ ê²½ìš° ë³´ì •
- ì¶œê²° ë¡œê·¸ê°€ íŠ¹ì • ì‹œê°„ ëˆ„ë½ëœ ê²½ìš° ë³´ì •

**â‘¡ Repair Mode**
- í†µê³„ mismatch ë°œê²¬ ì‹œ ì¬ê³„ì‚° ì‹¤í–‰
- ìš´ì˜ìê°€ "í†µê³„ ì¬ë™ê¸°í™”" ë²„íŠ¼ì„ ëˆ„ë¥¼ ìˆ˜ ìˆì–´ì•¼ í•¨
- ì¼ì¼ í†µê³„ê°€ ì˜ëª» ì§‘ê³„ëœ ê²½ìš° ìˆ˜ë™ ì¬ê³„ì‚°
- ì¬ê³„ì‚° ì§„í–‰ ìƒí™© í‘œì‹œ ë° ì™„ë£Œ ì•Œë¦¼

**â‘¢ Analytics Locking**
- ì§‘ê³„ ì¤‘ì—ëŠ” ê°™ì€ ë°ì´í„°ì…‹ì„ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ìˆ˜ì •í•˜ì§€ ëª»í•˜ë„ë¡ ì ê¸ˆ í•„ìš”
- ë™ì‹œ ì§‘ê³„ ë°©ì§€ë¡œ ë°ì´í„° ì •í•©ì„± ë³´ì¥
- Lock íƒ€ì„ì•„ì›ƒ: 30ë¶„ (ì´ˆê³¼ ì‹œ ìë™ í•´ì œ)

**ìë™ ë³´ì • í”„ë¡œì„¸ìŠ¤:**
- ì¼ì¼ ìë™ ê²€ì¦ ì‘ì—… ì‹¤í–‰
- ë°ì´í„° ë¶ˆì¼ì¹˜ ê°ì§€ ì‹œ ìë™ Backfill ì‹¤í–‰
- ì‹¬ê°í•œ ë¶ˆì¼ì¹˜ ë°œê²¬ ì‹œ ê´€ë¦¬ì ì•Œë¦¼

**ìˆ˜ë™ ë³´ì • í”„ë¡œì„¸ìŠ¤:**
- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ "ë°ì´í„° ì¬ë™ê¸°í™”" ê¸°ëŠ¥ ì œê³µ
- íŠ¹ì • ê¸°ê°„/í…Œë„ŒíŠ¸ ì„ íƒí•˜ì—¬ ì¬ì§‘ê³„ ê°€ëŠ¥
- ì¬ì§‘ê³„ ì´ë ¥ ì¶”ì  ë° ë¡œê·¸ ë³´ê´€

#### 3.6.7 ì§€ì—­ ê¸°ì¤€

**ì§€ì—­ ë¹„êµ ê¸°ì¤€:**

- í–‰ì •ë™ (location_code)
- êµ¬ (sigungu_code)
- ì‹œ/ë„ (sido_code)
- ê¶Œì—­(Region Zone, ë³¸ì‚¬ ì •ì˜)

**âš ï¸ ê¶Œì—­(Region Zone) ì •ì˜:**

ê¶Œì—­ì€ ë³¸ì‚¬ ìš´ì˜ ì§€í‘œì™€ ì—°ê²°í•˜ê¸° ìœ„í•œ ìƒìœ„ ì§€ì—­ ë‹¨ìœ„ì´ë‹¤:

```typescript
region_zone = {
  // ê¶Œì—­ ì½”ë“œ êµ¬ì¡°
  region_code: string,  // ì˜ˆ: "SEOUL_SOUTH", "GYEONGGI_NORTH"
  region_name: string,  // ì˜ˆ: "ì„œìš¸ ë‚¨ë¶€ê¶Œ", "ê²½ê¸° ë¶ë¶€ê¶Œ"

  // ê¶Œì—­ ë§¤í•‘ ê·œì¹™
  mapping_rule: {
    // ì‹œë„ ì½”ë“œ ê¸°ë°˜ ë§¤í•‘
    sido_code_to_region: {
      "11": "SEOUL_SOUTH",  // ì„œìš¸íŠ¹ë³„ì‹œ â†’ ì„œìš¸ ë‚¨ë¶€ê¶Œ
      "41": "GYEONGGI_NORTH"  // ê²½ê¸°ë„ â†’ ê²½ê¸° ë¶ë¶€ê¶Œ
    },

    // ë˜ëŠ” ìˆ˜ë™ ë§¤í•‘ (í…Œë„ŒíŠ¸ë³„)
    manual_mapping: true
  },

  // âš ï¸ C10: ì§€ì—­ í†µê³„ Fallback ë¡œì§ í†µì¼ (í™•ì •)
  // ê³µì‹ Fallback ìš°ì„ ìˆœìœ„ (ë³¸ì‚¬ ìš´ì˜ ê¸°ì¤€):
  fallback_priority: {
    1: 'same_dong',         // 1ìˆœìœ„: ê°™ì€ í–‰ì •ë™ (location_code)
    2: 'same_sigungu',      // 2ìˆœìœ„: ê°™ì€ êµ¬ (sigungu_code)
    3: 'same_sido',         // 3ìˆœìœ„: ê°™ì€ ì‹œë„ (sido_code)
    4: 'same_region_zone'   // 4ìˆœìœ„: ê°™ì€ ê¶Œì—­ (region_code)
  }

  // âš ï¸ ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ "ê¶Œì—­ â†’ ë™ â†’ êµ¬" í˜•íƒœë¡œ ì–¸ê¸‰ëœ ê²½ìš°ëŠ” ì˜¤ë¥˜
  // ìœ„ ìˆœì„œ(ë™ â†’ êµ¬ â†’ ì‹œë„ â†’ ê¶Œì—­)ê°€ ê³µì‹ í™•ì •ë³¸
}
```

**ê¶Œì—­ í™œìš©:**
- ë³¸ì‚¬ ìš´ì˜ ì§€í‘œ ì§‘ê³„ ì‹œ ê¶Œì—­ ë‹¨ìœ„ë¡œ ê·¸ë£¹í•‘
- ê¶Œì—­ë³„ í‰ê· /ìˆœìœ„ ê³„ì‚°
- ê¶Œì—­ ì½”ë“œëŠ” `location.region_code`ì— ì €ì¥ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))

#### 3.6.8 ë¶„ì„ ì§€í‘œ

**ìš´ì˜ ì§€í‘œ**
- í•™ìƒ ìˆ˜
- ì‹ ê·œ ë“±ë¡ ìˆ˜
- ì´íƒˆ(íœ´ì›/í‡´ì›)
- ì¶œì„ë¥ 
- ì§€ê°ë¥ /ê²°ì„ë¥ 

**ë§¤ì¶œ ì§€í‘œ**
- ì›” ë§¤ì¶œ
- ì˜ˆì • ë§¤ì¶œ
- ë¯¸ë‚©ë¥ 
- ARPU
- ê³¼ëª©ë³„ ë§¤ì¶œ

**ì„±ì¥ ì§€í‘œ**
- í•™ìƒ ì„±ì¥ë¥ 
- ë§¤ì¶œ ì„±ì¥ë¥ 
- ì‹ ê·œ ì „í™˜ë¥ 
- ì¬ë“±ë¡ë¥ 

**íŒ¨í„´ ì§€í‘œ**
- ë“±ì› ì‹œê°„ëŒ€
- ìš”ì¼ë³„ ì¶œì„ íŒ¨í„´
- ë°˜ë³„ ì¶œê²° íŒ¨í„´

#### 3.6.9 ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

**ë¹„êµ/ìˆœìœ„ ê¸°ëŠ¥**
- "ëŒ€ì¹˜ë™ í•™ìƒ ìˆ˜ ìƒìœ„ 12%"
- "ì†¡íŒŒêµ¬ ë§¤ì¶œ ìƒìœ„ 8%"
- "ì§€ì—­ í‰ê·  ëŒ€ë¹„ ì¶œì„ë¥  +4%"

**íˆíŠ¸ë§µ ê¸°ëŠ¥**
- ì§€ì—­ ì„±ì¥ë¥ 
- ì§€ì—­ ì¶œì„ë¥ 
- í•™ìƒ ë¶„í¬

**AI ì¸ì‚¬ì´íŠ¸ ê¸°ëŠ¥**
- ì¶œê²° ì´ìƒ íƒì§€
- ì§€ì—­ ëŒ€ë¹„ ê°•ì /ì•½ì  ë¶„ì„
- ì¶”ì²œ ìš´ì˜ ì „ëµ

### 3.7 AI ì¸ì‚¬ì´íŠ¸(AI Insights)

**ì¤‘ìš”: ê¸°ë³¸ AI ë¶„ì„ ê¸°ëŠ¥ì€ ìƒìš©í™” ë‹¨ê³„ì— í¬í•¨ë©ë‹ˆë‹¤.**

**âš ï¸ AI ì½”ë“œ ìƒì„± ê·œì•½:**

AI ì½”ë“œ/SQL ìƒì„± ì‹œì—ëŠ” AI ìë™ ê²€ì¦ í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ Zero-Trust/RLS ê·œì¹™ì„ ê°•ì œí•œë‹¤. AI ì½”ë“œ ìƒì„± ê·œì¹™ì€ AI_ìë™ê²€ì¦_í”„ë¡œì„¸ìŠ¤ ë¬¸ì„œë¥¼ ì •ë³¸ìœ¼ë¡œ ë”°ë¥¸ë‹¤.

**âš ï¸ AI Risk Score Weight ì—…ì¢…ë³„ ì°¨ë“± ì›ì¹™:**

ì„œë²„ê°€ AI Risk Score Weightë¥¼ ì ìš©í•  ë•Œ ì—…ì¢…ë³„(`industry_type`)ë¡œ Default Policyê°€ ë‹¤ë¥´ë©°, Tenant Overrideê°€ ìš°ì„  ì ìš©ëœë‹¤.

#### 3.7.1 í™ˆ í™”ë©´ ìƒë‹¨ "AI ë¸Œë¦¬í•‘ ì¹´ë“œ" ë„ì… (AI-First Workflow)

**ê¸°ë³¸ í™”ë©´ êµ¬ì„±**

í™ˆ í™”ë©´ ìƒë‹¨ì— AI ë¸Œë¦¬í•‘ ì¹´ë“œ ìë™ í‘œì‹œ

**ì˜ˆì‹œ:**
- "ì›ì¥ë‹˜, ì˜¤ëŠ˜ 3ê±´ì˜ ìƒë‹´ì´ í•„ìš”í•˜ë©° 2ëª…ì˜ í•™ìƒì´ ì´íƒˆ ìœ„í—˜ ë‹¨ê³„ì…ë‹ˆë‹¤."
- "ì´ë²ˆ ì£¼ ìˆ˜ì—… ì¤‘ ìˆ˜í•™Aë°˜ ì¶œê²°ë¥ ì´ ì§€ì—­ í‰ê·  ëŒ€ë¹„ 12% ë‚®ìŠµë‹ˆë‹¤. ì›ì¸ì„ ë¶„ì„í• ê¹Œìš”?"
- "ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œê°€ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆìƒ ìˆ˜ë‚©ë¥ ì€ 92%ì…ë‹ˆë‹¤."

ê° ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ ë¶„ì„ í™”ë©´ìœ¼ë¡œ ì´ë™ (ì‚¬ìš©ì í´ë¦­ í•„ìš”)

**ì£¼ìš” ê¸°ëŠ¥**

- ì„œë²„ê°€ ìƒë‹´ì¼ì§€ AI ìš”ì•½ ìƒì„±
  - ìƒë‹´ì¼ì§€ ì‘ì„± ì‹œ ì„œë²„ê°€ AI ìš”ì•½ ìƒì„±
- í•™ìƒ ì¶œê²° ì´ìƒ íƒì§€
  - ì„œë²„ê°€ ì¶œê²° íŒ¨í„´ ë¶„ì„ ë° ì´ìƒ íƒì§€ (AI í˜¸ì¶œ í¬í•¨)
- ë°˜/ê³¼ëª© ì„±ê³¼ ë¶„ì„
  - ì„œë²„ê°€ ë°˜ë³„/ê³¼ëª©ë³„ ì„±ê³¼ ë¶„ì„ (AI í˜¸ì¶œ í¬í•¨)
- ì§€ì—­ ëŒ€ë¹„ ë¶€ì¡± ì˜ì—­ ë¶„ì„
  - ì„œë²„ê°€ ì§€ì—­ í†µê³„ì™€ ë¹„êµí•˜ì—¬ ë¶€ì¡± ì˜ì—­ ì‹ë³„ (AI í˜¸ì¶œ í¬í•¨)
- ì›”ê°„ ìš´ì˜ ë¦¬í¬íŠ¸ ìƒì„±
  - ì„œë²„ê°€ ì›”ë§ ìš´ì˜ ë¦¬í¬íŠ¸ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)

**ì¶œë ¥ ì˜ˆ:**

"ìµœê·¼ 4ì£¼ê°„ ì›”ìš”ì¼ ì§€ê°ë¥ ì´ ì§€ì—­ í‰ê· ë³´ë‹¤ 12% ë†’ìŠµë‹ˆë‹¤.
ë“±ì› ì‹œê°„ ì¬ì¡°ì • ë° ë°˜ ê°œí¸ì„ ê³ ë ¤í•˜ì„¸ìš”."

**UI ë…¸ì¶œ ë°©ì‹:**
- AI ì¸ì‚¬ì´íŠ¸ëŠ” ê¸°ë³¸ ë©”ë‰´ì—ì„œ í•­ìƒ ë…¸ì¶œë˜ë©°,
- í™ˆ í™”ë©´ ìƒë‹¨ì— AI ë¸Œë¦¬í•‘ ì¹´ë“œ ìë™ í‘œì‹œ
- ê¸°ë³¸ í™”ë©´ì—ì„œëŠ” ì„œë²„ê°€ ìƒì„±í•œ "ìš”ì•½ ì¹´ë“œ" ì¤‘ì‹¬ìœ¼ë¡œ (ì¼ë¶€ íƒ€ì…ì—ì„œë§Œ AI í˜¸ì¶œ ë°œìƒ)
- ì‚¬ìš©ìì—ê²Œ ë¶€ë‹´ ì—†ì´ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ê³ ,
- ìƒì„¸ ë¶„ì„ì€ ë³„ë„ í˜ì´ì§€ì—ì„œ ì œê³µí•œë‹¤.
- ì¦‰, AIëŠ” ìˆ¨ê¹€ ê¸°ëŠ¥ì´ ì•„ë‹ˆë¼ 'ê°€ë²¼ìš´ ì§„ì… â†’ ê¹Šì€ ë¶„ì„' êµ¬ì¡°ì˜ í•µì‹¬ ë©”ë‰´ì´ë‹¤.

**âš ï¸ AI ì˜¨ì˜¤í”„ ì œì–´ (ê¸€ë¡œë²Œ í—¤ë” í† ê¸€) - SSOT ê¸°ì¤€:**

- **ìœ„ì¹˜**: ê¸€ë¡œë²Œ í—¤ë” ìš°ì¸¡ ìƒë‹¨ (ì‚¬ìš©ì í”„ë¡œí•„/ì„¤ì • ë©”ë‰´ ê·¼ì²˜)
- **ê¸°ëŠ¥ (SSOT)**: `tenant_features(feature_key='ai').enabled` ê°’ì„ í† ê¸€ (í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ SSOT ì„¹ì…˜ ì°¸ì¡°)
- **ë™ì‘**: AI ê¸°ëŠ¥ë§Œ ë¹„í™œì„±í™”, ì„¸ë¶€ í˜ì´ì§€/ë©”ë‰´ëŠ” ìˆ¨ê¸°ì§€ ì•ŠìŒ
- **ì¦‰ì‹œ ë°˜ì˜**: í† ê¸€ ë³€ê²½ ì‹œ ì¦‰ì‹œ Edge Functionì— ì „ë‹¬
- **AI ë¹„í™œì„±í™” ì‹œ**: Rule Engine ê¸°ë°˜ í´ë°± ì²˜ë¦¬ (AI ì—†ì´ ê·œì¹™ ê¸°ë°˜ ìë™í™”ë§Œ ìˆ˜í–‰)
- **ì‹œê°ì  í”¼ë“œë°±**: AI ë¸Œë¦¬í•‘ ì¹´ë“œì— "AI ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ ê°€ëŠ¥

**âš ï¸ SSOT ìŠ¤ìœ„ì¹˜ ì •ì˜:**
- í”Œë«í¼(ì‹œìŠ¤í…œ) ìŠ¤ìœ„ì¹˜: `PLATFORM_AI_ENABLED` (env-registry/serverì—ì„œë§Œ ì½ìŒ)
- í…Œë„ŒíŠ¸ ìŠ¤ìœ„ì¹˜(SSOT): `tenant_features(feature_key='ai').enabled`
- ìµœì¢… ìœ íš¨ê°’: `effective_ai_enabled = PLATFORM_AI_ENABLED && tenant_features['ai'].enabled`

â†’ ìƒì„¸ êµ¬í˜„ì€ ì „ì²´ ìœ ì•„ì´ë¬¸ì„œ 6-4 ì„¹ì…˜ ë° í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ "ê¸€ë¡œë²Œ í—¤ë” AI í† ê¸€ â€” UX/ì •ì±… SSOT" ì„¹ì…˜ ì°¸ì¡°

**AI ë¸Œë¦¬í•‘ ì¹´ë“œ ì¤‘ë³µ ì œê±° ê·œì¹™:**

ì¹´ë“œê°€ ë„ˆë¬´ ë§ì´ ìƒì„±ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ê·œì¹™:

```typescript
dedup_rule = {
  // ë™ì¼ insight_type + ë™ì¼ student/class/sessionì´ 24ì‹œê°„ ë‚´ì— ì¤‘ë³µ ìƒì„±ë˜ë©´ ë®ì–´ì“°ê¸°
  same_insight_within_24h: {
    condition: 'same insight_type + same entity_id',
    time_window: '24 hours',
    action: 'overwrite_existing'
  },

  // ë™ì¼ ë‚´ìš©ì˜ ì¸ì‚¬ì´íŠ¸ëŠ” ìµœì‹  ê²ƒìœ¼ë¡œë§Œ í‘œì‹œ
  same_content: {
    condition: 'same insight_content_hash',
    action: 'keep_latest'
  }
}
```

**ì¤‘ë³µ ì œê±° ì ìš© ë²”ìœ„:**
- Daily briefing: ë§¤ì¼ 1ê°œë§Œ ìƒì„±
- Risk detection: ë™ì¼ í•™ìƒ/ë°˜ì— ëŒ€í•´ 24ì‹œê°„ ë‚´ 1ê°œë§Œ ìœ ì§€
- ìƒë‹´ì¼ì§€ ìš”ì•½: ë™ì¼ ìƒë‹´ì¼ì§€ì— ëŒ€í•´ ìµœì‹  ìš”ì•½ë§Œ ìœ ì§€

**âš ï¸ ğŸ”¥ 2ë²ˆ: TaskCard / AI Insight / AI Briefing ê·œì¹™ í†µí•© (ê²½ê³„ ëª…í™•í™”, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­):**

**"í•™ìƒ ë‹¨ìœ„ ì—…ë¬´" vs "ë°ì´í„° ë‹¨ìœ„ ì¸ì‚¬ì´íŠ¸" ëª…í™•íˆ ë¶„ë¦¬:**

ë¬¸ì„œ ë‚´ 3ê°œ ì„¹ì…˜ì—ì„œ ê°ê° ë”°ë¡œ ì •ì˜ë˜ì–´ ìˆì—ˆìœ¼ë‚˜, ì•„ë˜ í†µí•© ê·œì¹™ìœ¼ë¡œ í†µì¼:

**ì¹´ë“œ íƒ€ì…ë³„ ìƒì„± ê·œì¹™ (ê²½ê³„ ëª…í™•í™”):**

```typescript
card_type_boundary = {
  // TaskCard: "í•™ìƒ ë‹¨ìœ„ ì—…ë¬´" ë ˆì´ì–´ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
  TaskCard: {
    purpose: 'actionable_student_tasks',  // ì‹¤í–‰ ê°€ëŠ¥í•œ í•™ìƒ ì—…ë¬´
    trigger: [
      'ê²°ì„ 3ì¼ ë°œìƒ',
      'ì´íƒˆ ìœ„í—˜ ê°ì§€',
      'ìƒë‹´ í•„ìš”',
      'ì‹ ê·œ ë“±ë¡'
    ],
    scope: 'student_level',  // í•™ìƒ ë‹¨ìœ„
    action_required: true  // ì‚¬ìš©ì ì•¡ì…˜ í•„ìš”
  },

  // AI Insight: "ë°ì´í„° ë‹¨ìœ„ ì¸ì‚¬ì´íŠ¸" ë ˆì´ì–´
  AI_Insight: {
    purpose: 'data_analysis_insights',  // ë°ì´í„° ë¶„ì„ ì¸ì‚¬ì´íŠ¸
    trigger: [
      'ì¶œê²° íŒ¨í„´ ë¶„ì„',
      'ì§€ì—­ ë¹„êµ ë¶„ì„',
      'ì„±ê³¼ ë¶„ì„'
    ],
    scope: 'data_level',  // ë°ì´í„° ë‹¨ìœ„
    action_required: false  // ì •ë³´ ì œê³µë§Œ
  },

  // AI Briefing: "ë°ì¼ë¦¬ ìš”ì•½" ë ˆì´ì–´
  AI_Briefing: {
    purpose: 'daily_summary',  // ì¼ì¼ ìš”ì•½
    trigger: [
      'ë§¤ì¼ 07:00 ì„œë²„ê°€ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)'
    ],
    scope: 'tenant_level',  // í…Œë„ŒíŠ¸ ë‹¨ìœ„
    action_required: false  // ì •ë³´ ì œê³µë§Œ
  }
}
```

**ì¤‘ë³µ ìƒì„± ë°©ì§€ ê·œì¹™:**

```typescript
card_creation_conflict_resolution = {
  // ê²°ì„ 3ì¼ â†’ TaskCardë§Œ ìƒì„± (AI InsightëŠ” ìƒì„± ì•ˆ í•¨, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
  'absence_3_days': {
    create: ['TaskCard'], // StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­
    skip: ['AI_Insight']  // ì¤‘ë³µ ë°©ì§€
  },

  // ì´íƒˆ ìœ„í—˜ â†’ TaskCard ìš°ì„ , AI InsightëŠ” ë³„ë„ ìƒì„± (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
  'risk_detection': {
    create: ['TaskCard', 'AI_Insight'], // StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­
    dedup_rule: 'same_student_same_day_only_one_insight'  // ë™ì¼ í•™ìƒ ë™ì¼ ë‚ ì§œëŠ” 1ê°œë§Œ
  },

  // ì˜¤ì „ 7ì‹œ AI ë¸Œë¦¬í•‘ ìƒì„± ì§í›„ â†’ AI InsightëŠ” ë®ì–´ì“°ê¸° ì•ˆ í•¨
  'after_briefing_generation': {
    ai_insight_rule: 'keep_existing_if_created_within_1_hour'  // 1ì‹œê°„ ë‚´ ìƒì„±ëœ ê²ƒì€ ìœ ì§€
  }
}
```

**í†µí•© Dedup/TTL/ìš°ì„ ìˆœìœ„ ê·œì¹™ (ê³µì‹ ì •ì˜, ë‹¨ì¼ ì†ŒìŠ¤):**

TaskCard, AI Insight, AI Briefing Card ì„¸ ì‹œìŠ¤í…œì— ëŒ€í•œ í†µí•© ê·œì¹™ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­):

```typescript
// âš ï¸ ê³µì‹ í†µí•© ê·œì¹™ (v3.2 í™•ì •, ëª¨ë“  ì„¹ì…˜ì—ì„œ ì´ ê·œì¹™ë§Œ ì°¸ì¡°)
unified_card_dedup_ttl_priority_rule = {
  // ê³µí†µ Dedup ê·œì¹™
  dedup: {
    // ë™ì¼ íƒ€ì… + ë™ì¼ ì—”í‹°í‹° + ë™ì¼ ë‚ ì§œ â†’ 1ì¥ë§Œ ìœ ì§€
    same_type_same_entity_same_day: {
      TaskCard: 'same task_type + same entity_type + same entity_id + same day',
      TaskCard: 'same task_type + same entity_type + same entity_id + same day' + ' (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)',
      AI_Insight: 'same insight_type + same entity_id + same day',
      AI_Briefing: 'same_date (per_date: 1)'
    },

    // ë™ì¼ ë‚´ìš©ì€ ìµœì‹  ê²ƒìœ¼ë¡œë§Œ ìœ ì§€
    same_content: {
      condition: 'same_content_hash',
      action: 'keep_latest'
    }
  },

  // ê³µí†µ TTL ê·œì¹™
  ttl: {
    TaskCard: 'expires_at ê¸°ì¤€', // StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­
    AI_Insight: '24ì‹œê°„',
    AI_Briefing: 'per_date: 1'
  },

  // ê³µí†µ ìš°ì„ ìˆœìœ„ ê³„ì‚°
  priority: {
    TaskCard: 'ê¸´ê¸‰ë„ + ì‹œê°„ëŒ€ + ë‹´ë‹¹ ë°˜/í•™ìƒ', // StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­
    AI_Insight: 'risk_score + ìƒì„± ì‹œê°„',
    AI_Briefing: 'ìƒì„± ì‹œê°„ (ìµœì‹  ìš°ì„ )'
  }
}
```

**âš ï¸ ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ Dedup/TTL/Priorityë¥¼ ì–¸ê¸‰í•  ë•ŒëŠ”:**
- "3.7.1 AI ë¸Œë¦¬í•‘ ì¹´ë“œì˜ í†µí•© Dedup/TTL/ìš°ì„ ìˆœìœ„ ê·œì¹™ ì°¸ì¡°" í˜•íƒœë¡œë§Œ ì–¸ê¸‰
- ì¤‘ë³µëœ ê·œì¹™ ì •ì˜ ì œê±°

**âš ï¸ ğŸ”¥ H1-1: DashboardCard íƒ€ì… ì •ì˜ ê³µí†µí™” (SSOT ì¹œí™”):**

**ë¬¸ì œì :**
- `HomePage.tsx`ì™€ `AllCardsPage.tsx`ì—ì„œ ë™ì¼í•œ íƒ€ì… ì •ì˜ê°€ ì¤‘ë³µë¨
- `EmergencyCard`, `AIBriefingCard`, `ClassCard`, `StatsCard`, `BillingSummaryCard` ì¸í„°í˜ì´ìŠ¤ ë° `DashboardCard` íƒ€ì…ì´ ë‘ íŒŒì¼ì— ì¤‘ë³µ ì¡´ì¬
- íƒ€ì… ë³€ê²½ ì‹œ ë‘ ê³³ ëª¨ë‘ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ìœ ì§€ë³´ìˆ˜ ë¬¸ì œ

**í•´ê²° ë°©ì•ˆ: ê³µí†µ íƒ€ì… íŒŒì¼ ì¶”ì¶œ**

**ìœ„ì¹˜:** `apps/academy-admin/src/types/dashboardCard.ts`

**êµ¬í˜„ ë°©ì‹:**

```typescript
import type { StudentTaskCard } from '@hooks/use-student';

export interface EmergencyCard {
  id: string;
  type: 'emergency';
  title: string;
  message: string;
  priority: number;
  action_url?: string;
}

export interface AIBriefingCard {
  id: string;
  type: 'ai_briefing';
  title: string;
  summary: string;
  insights: string[];
  created_at: string;
  action_url?: string;
}

export interface ClassCard {
  id: string;
  type: 'class';
  class_name: string;
  start_time: string;
  student_count: number;
  attendance_count: number;
  action_url: string;
}

export interface StatsCard {
  id: string;
  type: 'stats';
  title: string;
  value: string;
  unit?: string;
  trend?: string;
  action_url?: string;
  /** ê·¸ë˜í”„ ë°ì´í„° í‚¤ (daily_store_metrics í…Œì´ë¸”ì˜ í•„ë“œëª…) */
  chartDataKey?: 'student_count' | 'revenue' | 'attendance_rate' | 'new_enrollments' | 'late_rate' | 'absent_rate' | 'active_student_count' | 'inactive_student_count' | 'avg_students_per_class' | 'avg_capacity_rate' | 'arpu';
}

export interface BillingSummaryCard {
  id: string;
  type: 'billing_summary';
  title: string;
  expected_collection_rate: number;
  unpaid_count: number;
  action_url: string;
  priority?: number; // ì •ë³¸ ê·œì¹™: context ê¸°ë°˜ ê°€ì¤‘ì¹˜
}

export type DashboardCard = EmergencyCard | AIBriefingCard | ClassCard | StatsCard | BillingSummaryCard | StudentTaskCard;
```

**ì‚¬ìš© ì˜ˆì‹œ:**

```typescript
// HomePage.tsx, AllCardsPage.tsxì—ì„œ ê³µí†µ ì‚¬ìš©
import type { DashboardCard } from '../types/dashboardCard';
// SSOT: Barrel Exportë¥¼ í†µí•œ ìœ í‹¸ë¦¬í‹° import
import { normalizeDashboardCard, normalizeDashboardCards } from '../utils';

export function HomePage() {
  // ...
  const sortedCards = React.useMemo(() => {
    const cards: DashboardCard[] = [];
    // ...
    // âš ï¸ ì¤‘ìš”: ì¹´ë“œ ìƒì„± ì‹œ ì…ë ¥ ì •ê·œí™” ë ˆì´ì–´ ì‚¬ìš© í•„ìˆ˜
    // created_at, priority, action_url í•„ë“œëŠ” ì •ê·œí™” í›„ ì‚¬ìš©
    const normalizedCards = normalizeDashboardCards(cards);
    return normalizedCards;
  }, [/* ... */]);
}
```

**ì¥ì :**
- SSOT ì›ì¹™ ì¤€ìˆ˜: íƒ€ì… ì •ì˜ê°€ í•œ ê³³ì—ë§Œ ì¡´ì¬
- ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ: íƒ€ì… ë³€ê²½ ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •
- íƒ€ì… ì•ˆì •ì„±: TypeScriptë¡œ íƒ€ì… ì²´í¬ ê°€ëŠ¥
- í™•ì¥ì„±: ìƒˆë¡œìš´ ì¹´ë“œ íƒ€ì… ì¶”ê°€ ì‹œ íƒ€ì… íŒŒì¼ì—ë§Œ ì¶”ê°€

**âš ï¸ ğŸ”¥ H1: í™ˆ ëŒ€ì‹œë³´ë“œ Priority Table í†µì¼:**

**í™ˆ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìš°ì„ ìˆœìœ„ ê³µì‹ í…Œì´ë¸” (v3.3 í™•ì •, ë‹¨ì¼ ì •ë³¸):**

ì¹´ë“œ ìš°ì„ ìˆœìœ„ ì¶©ëŒì„ ì›ì²œì ìœ¼ë¡œ ì°¨ë‹¨í•˜ê¸° ìœ„í•œ ë‹¨ì¼ í…Œì´ë¸”:

```typescript
home_dashboard_card_groups = {
  // ê·¸ë£¹ Enum ì •ì˜
  card_group_enum: [
    'EMERGENCY',      // ê¸´ê¸‰ ì•Œë¦¼ ê·¸ë£¹
    'AI_BRIEFING',    // AI ë¸Œë¦¬í•‘ ê·¸ë£¹
    'STUDENT_TASKS',  // í•™ìƒ ì—…ë¬´ ì¹´ë“œ ê·¸ë£¹
    'CLASSES',        // ì˜¤ëŠ˜ì˜ ë°˜ ìˆ˜ì—… ê·¸ë£¹
    'ATTENDANCE_STATS',  // ì¶œì„ ê´€ë ¨ ì§€í‘œ ê·¸ë£¹ (STATS í•˜ìœ„)
    'STUDENT_GROWTH_STATS',  // í•™ìƒ ì„±ì¥ ì§€í‘œ ê·¸ë£¹ (STATS í•˜ìœ„)
    'REVENUE_STATS',  // ë§¤ì¶œ ê´€ë ¨ ì§€í‘œ ê·¸ë£¹ (STATS í•˜ìœ„)
    'COLLECTION_STATS',  // ìˆ˜ë‚© ê´€ë ¨ ì§€í‘œ ê·¸ë£¹ (STATS í•˜ìœ„)
    'BILLING',        // ìˆ˜ë‚© ìš”ì•½ ê·¸ë£¹
    'STATS'           // í†µê³„/íŠ¸ë Œë“œ ê·¸ë£¹ (ê¸°íƒ€)
  ],

  // ê·¸ë£¹ë³„ ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„)
  group_priority: {
    EMERGENCY: 1,
    AI_BRIEFING: 2,
    STUDENT_TASKS: 3,
    CLASSES: 4,
    ATTENDANCE_STATS: 5,
    STUDENT_GROWTH_STATS: 6,
    REVENUE_STATS: 7,
    COLLECTION_STATS: 8,
    BILLING: 9,
    STATS: 10
  },

  // ê·¸ë£¹ ë‚´ë¶€ ìš°ì„ ìˆœìœ„ ê·œì¹™
  within_group_priority: {
    EMERGENCY: {
      // ê¸´ê¸‰ ì¹´ë“œëŠ” í•­ìƒ ìµœìƒë‹¨, ê·¸ë£¹ ë‚´ë¶€ ì •ë ¬ ì—†ìŒ
      rule: 'always_top'
    },
    STUDENT_TASKS: {
      // TaskCardì˜ priority ê°’ ì‚¬ìš© (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
      rule: 'use_card_priority',
      // ë‹¨, TaskCard priorityê°€ 90 ì´ìƒì´ì–´ë„ Emergency ê·¸ë£¹ë³´ë‹¤ëŠ” ë‚®ìŒ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
      max_priority: 99  // Emergency ê·¸ë£¹ì´ í•­ìƒ ìš°ì„ 
    },
    AI_BRIEFING: {
      // ìƒì„± ì‹œê°„ ê¸°ì¤€ (ìµœì‹  ìš°ì„ )
      rule: 'created_at_desc'
    },
    CLASSES: {
      // ìˆ˜ì—… ì‹œì‘ ì‹œê°„ ê¸°ì¤€
      rule: 'class_start_time_asc'
    }
  },

  // Merge Rule
  merge_rule: {
    // ê¸´ê¸‰(Emergency) ì¹´ë“œëŠ” í•­ìƒ ìµœìƒë‹¨
    emergency_always_top: true,

    // TaskCard priorityê°€ 90 ì´ìƒì´ì–´ë„ Emergency ê·¸ë£¹ë³´ë‹¤ëŠ” ë‚®ìŒ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
    student_task_max_priority: 99,

    // AI Insightê°€ TaskCardì— ì˜ì¡´í•˜ëŠ” ê²½ìš° ìƒí˜¸ ì°¸ì¡° ë°©ì§€ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
    prevent_circular_reference: {
      ai_insight_depends_on_student_task: false,
      student_task_depends_on_ai_insight: false
    },

    // "ì˜¤ëŠ˜ì˜ ë°˜ ìˆ˜ì—… ì¹´ë“œ" ê·¸ë£¹ ëª…í™•íˆ ì •ì˜
    classes_group: {
      group_id: 'CLASSES',
      priority: 4,
      cards: ['today_classes', 'class_attendance_summary', 'class_schedule']
    }
  }
}
```

**í†µí•© ê·œì¹™ ì ìš©:**
- ì„¸ ì‹œìŠ¤í…œ ëª¨ë‘ ë™ì¼í•œ Dedup ë¡œì§ ì‚¬ìš© (êµ¬í˜„ ì¬ì‚¬ìš©)
- TTLì€ ê° ì¹´ë“œ íƒ€ì…ë³„ë¡œ ë‹¤ë¥´ê²Œ ì„¤ì • ê°€ëŠ¥
- ìš°ì„ ìˆœìœ„ëŠ” ì¹´ë“œ íƒ€ì…ë³„ë¡œ ë³„ë„ ê³„ì‚°í•˜ë˜, í†µí•© ì •ë ¬ ê·œì¹™ ì ìš©
- ê·¸ë£¹ ìš°ì„ ìˆœìœ„ â†’ ê·¸ë£¹ ë‚´ë¶€ ìš°ì„ ìˆœìœ„ ìˆœìœ¼ë¡œ ì •ë ¬

**AI ë¸Œë¦¬í•‘ ì¹´ë“œ ìºì‹± ê·œì¹™:**

ë§¤ì¼ 7ì‹œì— ìƒì„±í•´ë„ ì‚¬ìš©ìê°€ ì•±ì„ ëŠ¦ê²Œ ì—´ë©´ ì¹´ë“œê°€ ì—¬ëŸ¬ ì¥ ë³´ì´ëŠ” í˜„ìƒì„ ë°©ì§€:

```typescript
ai_briefing_card_caching = {
  // AI briefing cardëŠ” ë‚ ì§œë³„ 1ì¥ë§Œ ì €ì¥í•˜ë©°, ìµœì‹  1ì¥ë§Œ ìœ ì§€
  storage_rule: {
    per_date: 1,
    keep_latest_only: true
  },

  // ë‚ ì§œë³„ ì¹´ë“œ ìƒì„± ì‹œ ê¸°ì¡´ ì¹´ë“œ ìë™ ì‚­ì œ
  on_new_card: {
    action: 'delete_old_card',
    condition: 'same_date'
  }
}
```

**ìºì‹± ì²˜ë¦¬ ê·œì¹™:**
- ë‚ ì§œë³„ AI ë¸Œë¦¬í•‘ ì¹´ë“œëŠ” 1ì¥ë§Œ ì €ì¥
- ìƒˆ ì¹´ë“œ ìƒì„± ì‹œ ê°™ì€ ë‚ ì§œì˜ ê¸°ì¡´ ì¹´ë“œ ìë™ ì‚­ì œ
- ì‚¬ìš©ìê°€ ì•±ì„ ëŠ¦ê²Œ ì—´ì–´ë„ ìµœì‹  1ì¥ë§Œ í‘œì‹œ
- ì¹´ë“œ ìƒì„± ì‹œê°„ê³¼ ê´€ê³„ì—†ì´ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ê´€ë¦¬

#### 3.7.1.1 í™ˆ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ ê³µí†µí™” (SSOT ì¹œí™”)

**âš ï¸ ì¤‘ìš”: HomePageì™€ AllCardsPageì—ì„œ ì¹´ë“œ ë Œë”ë§ ë¡œì§ ì¤‘ë³µ ì œê±°**

**ë¬¸ì œì :**
- `HomePage.tsx`ì™€ `AllCardsPage.tsx`ì—ì„œ ê° ì¹´ë“œ íƒ€ì…ë³„ ë Œë”ë§ ë¡œì§ì´ ì¤‘ë³µë¨
- Emergency Card, AI Briefing Card, Class Card, Stats Card, Billing Summary Card ë Œë”ë§ì´ ë‘ íŒŒì¼ì— ì¤‘ë³µ ì¡´ì¬
- ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³€ê²½ ì‹œ ë‘ ê³³ ëª¨ë‘ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ìœ ì§€ë³´ìˆ˜ ë¬¸ì œ

**í•´ê²° ë°©ì•ˆ: ê³µí†µ ì»´í¬ë„ŒíŠ¸ ì¶”ì¶œ**

**ìœ„ì¹˜:** `apps/academy-admin/src/components/dashboard-cards/`

**êµ¬ì¡°:**
```
apps/academy-admin/src/components/dashboard-cards/
â”œâ”€â”€ EmergencyCard.tsx
â”œâ”€â”€ AIBriefingCard.tsx
â”œâ”€â”€ ClassCard.tsx
â”œâ”€â”€ StatsCard.tsx
â””â”€â”€ BillingSummaryCard.tsx
```

**êµ¬í˜„ ë°©ì‹:**

```typescript
// apps/academy-admin/src/components/dashboard-cards/EmergencyCard.tsx
import { Card } from '@ui-core/react';
import type { EmergencyCard as EmergencyCardType } from '../../types/dashboardCard';

export interface EmergencyCardProps {
  card: EmergencyCardType;
  onAction?: (card: EmergencyCardType) => void;
}

export function EmergencyCard({ card, onAction }: EmergencyCardProps) {
  return (
    <Card
      key={card.id}
      padding="md"
      variant="elevated"
      style={{
        borderLeft: `var(--border-width-thick) solid var(--color-error)`,
        cursor: card.action_url ? 'pointer' : 'default',
      }}
      onClick={() => card.action_url && onAction?.(card)}
    >
      <div style={{ display: 'flex', alignItems: 'flex-start', gap: 'var(--spacing-sm)' }}>
        <div style={{ flex: 1 }}>
          <h3 style={{ fontSize: 'var(--font-size-lg)', fontWeight: 'var(--font-weight-semibold)', marginBottom: 'var(--spacing-xs)' }}>
            {card.title}
          </h3>
          <p style={{ color: 'var(--color-text-secondary)' }}>
            {card.message}
          </p>
        </div>
      </div>
    </Card>
  );
}
```

**Renderer Registryì™€ì˜ ì—°ê³„:**

```typescript
// apps/academy-admin/src/utils/dashboardCardRenderer.ts
import { EmergencyCard } from '../components/dashboard-cards/EmergencyCard';
import { AIBriefingCard } from '../components/dashboard-cards/AIBriefingCard';
// ... ê¸°íƒ€ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸

const cardRenderers = {
  'emergency': (card, navigate) => <EmergencyCard key={card.id} card={card as EmergencyCardType} onAction={handleCardClick(card, navigate)} />,
  'ai_briefing': (card, navigate) => <AIBriefingCard key={card.id} card={card as AIBriefingCardType} onAction={handleCardClick(card, navigate)} />,
  // ... ê¸°íƒ€ ì¹´ë“œ íƒ€ì…
};
```

**ì¥ì :**
- SSOT ì›ì¹™ ì¤€ìˆ˜: ì¹´ë“œ ë Œë”ë§ ë¡œì§ì´ í•œ ê³³ì—ë§Œ ì¡´ì¬
- ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ: ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³€ê²½ ì‹œ ì»´í¬ë„ŒíŠ¸ íŒŒì¼ë§Œ ìˆ˜ì •
- ì¬ì‚¬ìš©ì„±: ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œë„ ë™ì¼í•œ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ ì‚¬ìš© ê°€ëŠ¥
- í…ŒìŠ¤íŠ¸ ìš©ì´ì„±: ê° ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ë¥¼ ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

**ê³µí†µí™” ëŒ€ìƒ ì¹´ë“œ:**
- âœ… Emergency Card: í™ˆì—ì„œ í•­ìƒ ìµœìƒë‹¨ ê·¸ë£¹ìœ¼ë¡œ ë‹¤ë£¨ëŠ” êµ¬ì¡°ê°€ ë¬¸ì„œ ì˜ˆì‹œì— ì¡´ì¬
- âœ… AI Briefing Card: í™ˆ ìš°ì„ ìˆœìœ„ì— ê³ ì • ë“±ì¥ + AI OFF ì‹œì—ë„ ë©”ì‹œì§€ë¡œ í‘œì‹œ(ìˆ¨ê¹€ ê¸ˆì§€)
- âœ… Class Card: ì˜¤ëŠ˜ì˜ ìˆ˜ì—… ì¹´ë“œ
- âœ… Stats Card: í†µê³„ ì¹´ë“œ
- âœ… Billing Summary Card: ì²­êµ¬ ìš”ì•½ ì¹´ë“œ

**âš ï¸ ì°¸ê³ :**
- StudentTaskCardëŠ” ì´ë¯¸ ê³µí†µ ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬ë˜ì–´ ìˆìŒ (`apps/academy-admin/src/components/StudentTaskCard.tsx`)
- StudentTaskCardë§Œ ê³µí†µ ë¶„ë¦¬ëœ ì´ìœ : AI Suggestion ê°œë… íê¸° ë° StudentTaskCardë¡œ ì •ë³¸ í†µí•©, ìŠ¹ì¸(L2)Â·ë¯¸ë¦¬ë³´ê¸°Â·ê°ì‚¬ë¡œê·¸ ë“± ìš´ì˜/ë¦¬ìŠ¤í¬ ìš”êµ¬ì‚¬í•­ì´ ì»´í¬ë„ŒíŠ¸ ì¤‘ì‹¬ìœ¼ë¡œ ê²°ì†

#### 3.7.1.2 ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ê³µí†µí™” ì „ëµ (Phase 2 ì‹œê°ì  ê°œì„ )

**âš ï¸ ì¤‘ìš”: Phase 2 ì‹œê°ì  ìœ„ê³„ ê°œì„ ì„ ìœ„í•œ ê³µí†µí™” ì „ëµ**

**ëª©ì :**
- Phase 2 ì‹œê°ì  ìœ„ê³„ ê°œì„  ì‘ì—…ëŸ‰ ëŒ€í­ ê°ì†Œ
- ì¹´ë“œë³„ ê³µí†µ UI íŒ¨í„´ ì¼ê´€ì„± ë³´ì¥
- ë„¤íŠ¸ì›Œí¬ ì¤‘ë³µ ì œê±° ë° ë¡œë”© íƒ€ì´ë° ì•ˆì •í™”

**ê³µí†µí™” ìš°ì„ ìˆœìœ„:**

**Tier 1: ì¦‰ì‹œ ê³µí†µí™” (ì„±ëŠ¥/ì •í•©ì„±)**

1. **`useMonthlyInvoices` Hook**
   - **íŒŒì¼:** `apps/academy-admin/src/hooks/useMonthlyInvoices.ts` (ì‹ ê·œ)
   - **ì´ìœ :**
     - HomePage 3ê³³, AllCardsPage 2ê³³, ë‹¤ë¥¸ í˜ì´ì§€ ë‹¤ìˆ˜ì—ì„œ ì¤‘ë³µ
     - ë„¤íŠ¸ì›Œí¬ ì¤‘ë³µ ì œê±°, ë¡œë”© íƒ€ì´ë° ë™ê¸°í™”
   - **ë°˜í™˜:** `{ invoices, isLoading, isFetching, error, monthKey }`
   - **ìš°ì„ ìˆœìœ„:** ìµœìš°ì„ 

2. **`DashboardCardShell` ì»´í¬ë„ŒíŠ¸**
   - **íŒŒì¼:** `apps/academy-admin/src/components/dashboard/DashboardCardShell.tsx` (ì‹ ê·œ)
   - **ì´ìœ :**
     - ì¹´ë“œ ì™¸ê³½ UI íŒ¨í„´ì´ ê³µí†µë¨ (ì¢Œì¸¡ ìŠ¤íŠ¸ë¦½, ë°°ì§€, í—¤ë”, hover, í´ë¦­, ì—…ë°ì´íŠ¸ dot, fade-in)
     - ê° ì¹´ë“œì—ì„œ ê°œë³„ êµ¬í˜„ ì‹œ 31ê°œ ìœ„ì¹˜ê°€ 50ê°œ+ë¡œ ì¦ê°€
     - ì‹œê°ì  ì¼ê´€ì„± ìœ ì§€
   - **Props ì„¤ê³„:**
     ```typescript
     interface DashboardCardShellProps {
       tone?: 'default' | 'info' | 'warning' | 'danger';
       leftAccent?: boolean; // ì¢Œì¸¡ ìƒ‰ ìŠ¤íŠ¸ë¦½
       icon?: React.ReactNode;
       title: string;
       badge?: React.ReactNode; // ìš°ìƒë‹¨ ë°°ì§€
       metaRight?: React.ReactNode; // ìš°ìƒë‹¨ ë©”íƒ€
       footer?: React.ReactNode;
       onClick?: () => void;
       animationDelayMs?: number;
       lastUpdatedAt?: Date;
       children: React.ReactNode;
     }
     ```
   - **íš¨ê³¼:**
     - Phase 2 ì‹œê°ì  ìœ„ê³„ ê°œì„  ì‘ì—…ëŸ‰ ëŒ€í­ ê°ì†Œ
     - ì¹´ë“œë³„ ê³µí†µ UI ì¼ê´€ì„± ë³´ì¥
   - **ìš°ì„ ìˆœìœ„:** ìµœìš°ì„ 

**Tier 2: ì¦‰ì‹œ ê³µí†µí™” (ì‹œê°ì  ì¼ê´€ì„±)**

3. **`DashboardCardSkeleton` ì»´í¬ë„ŒíŠ¸**
   - **íŒŒì¼:** `apps/academy-admin/src/components/dashboard/DashboardCardSkeleton.tsx` (ì‹ ê·œ)
   - **ì´ìœ :** HomePage, AllCardsPageì—ì„œ ë™ì¼í•œ ë¡œë”© UX í•„ìš”
   - **ìš°ì„ ìˆœìœ„:** ë†’ìŒ

4. **`StaggeredGrid` ë˜í¼ ì»´í¬ë„ŒíŠ¸**
   - **íŒŒì¼:** `apps/academy-admin/src/components/dashboard/StaggeredGrid.tsx` (ì‹ ê·œ)
   - **ì´ìœ :**
     - `renderCard(..., { animationDelay })` ë°©ì‹ì€ íŒŒê¸‰ íš¨ê³¼ í¼
     - Grid ë˜í¼ì—ì„œ childrenì— `animationDelay` ì£¼ì…ì´ ë” ë‹¨ìˆœ
   - **íš¨ê³¼:** `renderCard`, ì¹´ë“œ ì»´í¬ë„ŒíŠ¸, íƒ€ì… ìˆ˜ì • ìµœì†Œí™”
   - **ìš°ì„ ìˆœìœ„:** ë†’ìŒ

5. **`useLastUpdatedMap` ë˜ëŠ” `useTransientUpdatedFlag` Hook**
   - **íŒŒì¼:** `apps/academy-admin/src/hooks/useLastUpdatedMap.ts` (ì‹ ê·œ)
   - **ì´ìœ :**
     - ê° `useQuery`ì— `onSuccess` ì¶”ê°€ ì‹œ ì½”ë“œ ë³µì¡ë„ ì¦ê°€
     - í˜ì´ì§€ë³„ í¸ì°¨ ë°œìƒ
   - **êµ¬í˜„ ì˜µì…˜:**
     - Option A: `useLastUpdatedMap(keys: string[])` - ì—¬ëŸ¬ queryKey ì¶”ì 
     - Option B: `useTransientUpdatedFlag(trigger, 2000ms)` - ë‹¨ìˆœ í”Œë˜ê·¸
     - Option C: `react-query`ì˜ `dataUpdatedAt` í™œìš©
   - **`DashboardCardShell`ì´ `lastUpdatedAt`ì„ ë°›ì•„ ìš°ìƒë‹¨ dot í‘œì‹œ**
   - **ìš°ì„ ìˆœìœ„:** ë†’ìŒ

**Tier 3: ë‹¨ê¸° ê³µí†µí™” (ìœ ì§€ë³´ìˆ˜ì„±)**

6. **`useEmergencyCards` Hook**
   - **íŒŒì¼:** `packages/hooks/use-dashboard/src/useEmergencyCards.ts` (ì‹ ê·œ)
   - **ì´ìœ :**
     - HomePageì™€ AllCardsPageì—ì„œ ë¡œì§ ì¤‘ë³µ (ì•½ 85ì¤„ vs 27ì¤„)
     - AllCardsPage êµ¬í˜„ì´ ë¶ˆì™„ì „
     - Policy ê¸°ë°˜ ì„ê³„ê°’ ì²˜ë¦¬ í¬í•¨ í•„ìš”
   - **ìš°ì„ ìˆœìœ„:** ë†’ìŒ

7. **`useAIBriefingCards` Hook**
   - **íŒŒì¼:** `packages/hooks/use-dashboard/src/useAIBriefingCards.ts` (ì‹ ê·œ)
   - **ì´ìœ :**
     - HomePageì™€ AllCardsPageì—ì„œ ë¡œì§ ì¤‘ë³µ (ì•½ 158ì¤„ vs 51ì¤„)
     - AllCardsPage êµ¬í˜„ì´ ë¶ˆì™„ì „
     - `useMonthlyInvoices` ì‚¬ìš©
   - **ìš°ì„ ìˆœìœ„:** ë†’ìŒ

**Tier 4: ì„ íƒì  ê³µí†µí™” (ì¬ì‚¬ìš©ì„±)**

8. **`HeroSummaryStrip` ì»´í¬ë„ŒíŠ¸**
   - **íŒŒì¼:** `apps/academy-admin/src/components/dashboard/HeroSummaryStrip.tsx` (ì‹ ê·œ)
   - **ì´ìœ :**
     - HomePage ì „ìš©ì´ì§€ë§Œ AllCardsPageë‚˜ ë‹¤ë¥¸ ëŒ€ì‹œë³´ë“œì—ì„œë„ ì¬ì‚¬ìš© ê°€ëŠ¥
     - ì—…ì¢… í™•ì¥ ì‹œ ì¬ì‚¬ìš©ì„± ë†’ìŒ
   - **ì£¼ì˜:** ë¹„ì£¼ì–¼(ê·¸ë¼ë°ì´ì…˜/ë¸”ëŸ¬)ì€ ui-core í† í°/ë³€ìˆ˜ë¡œë§Œ ì²˜ë¦¬
   - **ìš°ì„ ìˆœìœ„:** ì¤‘ê°„

9. **`getAutomationPolicy` + `useAutomationPolicy` Hook**
   - **íŒŒì¼:**
     - `apps/academy-admin/src/utils/getAutomationPolicy.ts` (ì‹ ê·œ)
     - `apps/academy-admin/src/hooks/useAutomationPolicy.ts` (ì‹ ê·œ)
   - **ì´ìœ :**
     - Phase 3ì´ì§€ë§Œ ì¥ê¸°ì ìœ¼ë¡œ í•„ìˆ˜
     - Fail-closed ì›ì¹™ ì ìš© ìš©ì´
     - í•˜ë“œì½”ë”© ì„ê³„ê°’ ì œê±°
   - **ìš°ì„ ìˆœìœ„:** ì¤‘ê°„ (Phase 3)

**ê³µí†µí™” ë¹„ì¶”ì²œ:**

10. **ì¹´ë“œ ë‚´ë¶€ ì½˜í…ì¸  ê³µí†µí™”**
    - **ì´ìœ :**
      - BillingSummaryCard: ê²Œì´ì§€/ì¹©
      - ClassCard: ì‹œê°„ì¶•/ì¶œì„ë¥  í”„ë¡œê·¸ë ˆìŠ¤ ë°”
      - AIBriefingCard: ì¸ì‚¬ì´íŠ¸ í•˜ì´ë¼ì´íŠ¸
      - ê³µí†µí™” ì‹œ ì˜µì…˜ í­ë°œë¡œ ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€
    - **íŒë‹¨:** Shellë§Œ ê³µí†µí™”, ë‚´ë¶€ëŠ” ê°œë³„ ì¹´ë“œ ìœ ì§€

**ìµœì¢… ê³µí†µí™” ìš°ì„ ìˆœìœ„:**

**Phase 1 (ì¦‰ì‹œ):**
1. `useMonthlyInvoices` Hook
2. `DashboardCardShell` ì»´í¬ë„ŒíŠ¸

**Phase 2 (ë‹¨ê¸°):**
3. `DashboardCardSkeleton` ì»´í¬ë„ŒíŠ¸
4. `StaggeredGrid` ë˜í¼
5. `useLastUpdatedMap` Hook
6. `useEmergencyCards` Hook
7. `useAIBriefingCards` Hook

**Phase 3 (ì„ íƒ):**
8. `HeroSummaryStrip` ì»´í¬ë„ŒíŠ¸
9. `getAutomationPolicy` + `useAutomationPolicy` Hook

---

#### 3.7.2 AI ì¸ì‚¬ì´íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ ì£¼ê¸°

**Daily briefing: 07:00 ì„œë²„ê°€ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)**
- ë§¤ì¼ ì•„ì¹¨ 7ì‹œì— ì „ë‚  ë°ì´í„° ê¸°ë°˜ ë¸Œë¦¬í•‘ ì„œë²„ê°€ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)
- System Event Engineì˜ Time-based Eventë¡œ íŠ¸ë¦¬ê±°

**Risk detection: ì‹¤ì‹œê°„ ê°ì§€ ë° ì—…ë°ì´íŠ¸**
- ì´íƒˆ ìœ„í—˜, ì¶œê²° ì´ìƒ ë“±ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€
- Pattern-based Eventë¡œ ì¦‰ì‹œ íŠ¸ë¦¬ê±°

**ìƒë‹´ì¼ì§€ ìš”ì•½: ì €ì¥ ì‹œ ì¦‰ì‹œ ìƒì„±**
- ìƒë‹´ì¼ì§€ ì €ì¥ ì‹œ ì„œë²„ê°€ AI ìš”ì•½ ìƒì„± (Behavior-based Event)
- Level 3 Auto-Actionìœ¼ë¡œ ìë™ ì‹¤í–‰

#### 3.7.3 AI Insight ì •í™•ë„ ë³´ì •(Weighting Rule)

ì„œë²„ê°€ AI Insightì˜ ì—¬ëŸ¬ ì§€í‘œë¥¼ í•©ì‚°í•  ë•Œ ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•œë‹¤.

**risk_score ê³„ì‚° ê³µì‹:**

```
risk_score =
   (attendance_weight * attendance_score)
 + (counseling_weight * counseling_score)
 + (payment_weight * payment_score)
 + (performance_weight * performance_score)
```

**âš ï¸ H8: AI Risk Weight ì—…ì¢…ë³„ ê°€ì¤‘ì¹˜ ì¼ê´€ì„± í™•ë³´:**

**ëª¨ë“  Risk Score ê³„ì‚°ì— industry_risk_weights rule ì ìš©:**

ì„œë²„ê°€ AI Risk Scoreë¥¼ ê³„ì‚°í•  ë•Œ ë°˜ë“œì‹œ ì—…ì¢…ë³„(`industry_type`) ê¸°ë³¸ ê°€ì¤‘ì¹˜ë¥¼ ì‚¬ìš©í•˜ë©°, Tenant Overrideê°€ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤.

**ê¸°ë³¸ ê°€ì¤‘ì¹˜ (ì—…ì¢…ë³„ ì°¨ë“± ì ìš©):**

ì—…ì¢…ë³„ ê¸°ë³¸ ê°€ì¤‘ì¹˜ëŠ” ì•„ë˜ `industry_risk_weights` í…Œì´ë¸”ì„ ì°¸ì¡°í•©ë‹ˆë‹¤ (ë³¸ ë¬¸ì„œ 3.7.3 AI Insight ì •í™•ë„ ë³´ì • ì„¹ì…˜ ì°¸ì¡°).

**ê°€ì¤‘ì¹˜ ì ìš© ìˆœì„œ:**
1. Tenant Override (í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í„°ë§ˆì´ì§•, ìµœìš°ì„ )
2. Industry Default (ì—…ì¢…ë³„ ê¸°ë³¸ ê°€ì¤‘ì¹˜)
3. Global Default (ì „ì—­ ê¸°ë³¸ ê°€ì¤‘ì¹˜, fallback)

**ê°€ì¤‘ì¹˜ ì»¤ìŠ¤í„°ë§ˆì´ì§•:**
- í…Œë„ŒíŠ¸ë³„ë¡œ ê°€ì¤‘ì¹˜ ì¡°ì • ê°€ëŠ¥ (tenant_override)
- ì—…ì¢…ë³„ ê¸°ë³¸ ê°€ì¤‘ì¹˜ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ (industry_risk_weights ì°¸ì¡°)
- ì„œë²„ê°€ AI í•™ìŠµ ê²°ê³¼ì— ë”°ë¼ ê°€ì¤‘ì¹˜ ì¡°ì • ê°€ëŠ¥

**ì—…ì¢…ë³„ ê¸°ë³¸ ê°€ì¤‘ì¹˜ ì°¨ë“±:**

ì„œë²„ê°€ AI Risk Model ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•  ë•Œ `industry_type`ë³„ë¡œ Default Policyê°€ ë‹¤ë¥´ë©°, `tenant_override` ê°€ëŠ¥í•¨ì„ ëª…ì‹œí•œë‹¤:

```typescript
industry_risk_weights = {
  academy: {
    attendance_weight: 0.4,
    counseling_weight: 0.3,
    payment_weight: 0.2,
    performance_weight: 0.1
  },
  salon: {
    attendance_weight: 0.3,
    counseling_weight: 0.2,
    payment_weight: 0.4,
    performance_weight: 0.1
  },
  real_estate: {
    attendance_weight: 0.2,
    counseling_weight: 0.3,
    payment_weight: 0.4,
    performance_weight: 0.1
  }
}
```

**âš ï¸ ğŸ”¥ C1: industry_type enum ê°’ ë¶ˆì¼ì¹˜ ë¬¸ì œ (Critical â€” ì‹œìŠ¤í…œ ì „ì²´ê°€ ë¬´ë„ˆì§ˆ ìˆ˜ ìˆìŒ):**

**ë¬¸ì œ:**
ë¬¸ì„œ ê³³ê³³ì—ì„œ ë‹¤ìŒ 3ê°€ì§€ í‘œê¸°ê°€ í˜¼ì¬í•©ë‹ˆë‹¤:
- `realestate` / `real_estate` (ë¶™ì—¬ì”€/ì–¸ë”ìŠ¤ì½”ì–´ í˜¼ìš©)
- `salon` / `beauty_salon` (ë‹¨ìˆœ/ë³µí•© í˜¼ìš©)

**ì˜í–¥ ë²”ìœ„:**
Schema Engine / RLS / Analytics / Notification ë¼ìš°íŒ… / AI Risk Weight / SDUI Override / Regional Analytics í•„í„° / Event Engine industry filter ëª¨ë‘ê°€ `industry_type`ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë¯€ë¡œ, ì´ëŠ” ì¹˜ëª…ì  ì¶©ëŒì…ë‹ˆë‹¤.

**í•´ê²°: industry_type enum í†µì¼ (v3.2 í™•ì • ì •ë³¸):**

```typescript
// âš ï¸ ê³µì‹ industry_type enum (ë‹¨ì¼ ì •ë³¸, Schema Engine v2.1ê³¼ ë°˜ë“œì‹œ ì¼ì¹˜)
industry_type_enum = [
  'academy',      // í•™ì› (í™•ì •)
  'salon',        // ë¯¸ìš©ì‹¤ (í™•ì • - beauty_salon ì‚¬ìš© ê¸ˆì§€)
  'real_estate'   // ë¶€ë™ì‚° (í™•ì • - realestate ì‚¬ìš© ê¸ˆì§€, ì–¸ë”ìŠ¤ì½”ì–´ í•„ìˆ˜)
]

// âŒ ì‚¬ìš© ê¸ˆì§€ í‘œí˜„:
// - realestate (ë¶™ì—¬ì”€) â†’ real_estateë¡œ ë³€ê²½
// - beauty_salon â†’ salonë¡œ ë³€ê²½
// - real_estate (ì–¸ë”ìŠ¤ì½”ì–´) â†’ ìœ ì§€ (ì •ë³¸)
```

**í†µì¼ ê·œì¹™ (ê°•ì œ):**
1. âœ… `academy` - í•­ìƒ ì†Œë¬¸ì, ë‹¨ìˆ˜í˜•
2. âœ… `salon` - `beauty_salon` ì‚¬ìš© ê¸ˆì§€, `salon`ìœ¼ë¡œ í†µì¼
3. âœ… `real_estate` - `realestate` ì‚¬ìš© ê¸ˆì§€, `real_estate`(ì–¸ë”ìŠ¤ì½”ì–´)ë¡œ í†µì¼

**ì ìš© ë²”ìœ„ (ëª¨ë“  ê³„ì¸µ):**
- RLS ì •ì±…: `industry_type = 'academy' | 'salon' | 'real_estate'`
- Schema Registry: enum ê°’ê³¼ ì™„ì „ ì¼ì¹˜ í•„ìˆ˜
- AI Risk Weight: `industry_risk_weights.real_estate` (ì–¸ë”ìŠ¤ì½”ì–´)
- SDUI Override: `industry_type` í•„í„°ë§
- Regional Analytics: ì—…ì¢… í•„í„°ë§
- Notification í…œí”Œë¦¿: ì—…ì¢…ë³„ ë¶„ê¸°
- Event Engine: industry filter

**âš ï¸ ë¬¸ì„œ ì „ì²´ì—ì„œ industry_type ì „ë¶€ íƒìƒ‰ í›„ ì¼ê´„ êµì • í•„ìš”**

**ê¸°ë³¸ê°’ ì„¤ì • (RLS ì •ì±… ì¶©ëŒ ë°©ì§€):**

**ê¸°ë³¸ê°’ ì„¤ì • (RLS ì •ì±… ì¶©ëŒ ë°©ì§€):**

ëª¨ë“  Industry í…Œì´ë¸”ì— `industry_type` DEFAULT ê°’ ì§€ì • í•„ìš”:

```sql
-- âš ï¸ ë ˆê±°ì‹œ: students í…Œì´ë¸”ì€ ë ˆê±°ì‹œì´ë©°, ì‹ ê·œ ì½”ë“œì—ì„œëŠ” ì‚¬ìš© ê¸ˆì§€. ì •ë³¸ì€ persons + academy_students ì¡°í•©ì´ë©°, ì‹ ê·œ ì½”ë“œëŠ” persons + academy_students ì¡°í•©ë§Œ ì‚¬ìš©
ALTER TABLE students
  ALTER COLUMN industry_type
  SET DEFAULT 'academy';  -- ë˜ëŠ” ì‹¤ì œ ê¸°ë³¸ê°’

-- Supabaseì—ì„œ insert ì‹œ í•„ë“œ ëˆ„ë½ ì‹œ null â†’ policy mismatchë¡œ 403 ë°œìƒ ê°€ëŠ¥
-- ë”°ë¼ì„œ DEFAULT ê°’ í•„ìˆ˜
```

**ê°€ì¤‘ì¹˜ ì ìš© ìš°ì„ ìˆœìœ„:**
1. tenant_override (í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ê°€ì¤‘ì¹˜)
2. industry_default (ì—…ì¢…ë³„ ê¸°ë³¸ ê°€ì¤‘ì¹˜)
3. global_default (ì „ì—­ ê¸°ë³¸ ê°€ì¤‘ì¹˜)

**ì ìˆ˜ ì •ê·œí™”:**
- ê° ì§€í‘œ ì ìˆ˜ëŠ” 0-100 ë²”ìœ„ë¡œ ì •ê·œí™”
- ìµœì¢… risk_scoreëŠ” 0-100 ë²”ìœ„

**risk_score ë ˆì´ë¸” í‘œ:**

| risk_score ë²”ìœ„ | ë ˆì´ë¸” | Emergency ì¹´ë“œ í‘œì‹œ | ì„¤ëª… |
|----------------|--------|-------------------|------|
| 90 ì´ìƒ | Emergency | âœ… í‘œì‹œ | ê¸´ê¸‰ ìœ„í—˜, ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš” |
| 70-89 | ê³ ìœ„í—˜ | âŒ í‘œì‹œ ì•ˆ í•¨ | ë†’ì€ ìœ„í—˜ë„, ì£¼ì˜ í•„ìš” |
| 40-69 | ì¤‘ìœ„í—˜ | âŒ í‘œì‹œ ì•ˆ í•¨ | ë³´í†µ ìœ„í—˜ë„, ëª¨ë‹ˆí„°ë§ í•„ìš” |
| 0-39 | ì €ìœ„í—˜ | âŒ í‘œì‹œ ì•ˆ í•¨ | ë‚®ì€ ìœ„í—˜ë„, ì •ìƒ ë²”ìœ„ |

#### 3.7.4 AI Override System (AI í–‰ë™ ë³´ì • ì²´ê³„)

Zero-Interaction ì‹œìŠ¤í…œì—ì„œ AI ì˜¤íŒ(incorrect action)ì— ëŒ€í•œ ë³´ì • ê¸°ëŠ¥ì´ í•„ìˆ˜ì ì´ë‹¤.

ì‚¬ìš©ìëŠ” ì•„ë˜ ë°©ì‹ìœ¼ë¡œ AI ë™ì‘ì„ ë³´ì •í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤:

**1) Insight Override**
- "ì´íƒˆ ìœ„í—˜ ì•„ë‹˜"ìœ¼ë¡œ í‘œì‹œ â†’ ëª¨ë¸ í•™ìŠµì— ë°˜ì˜
- "ì¶œê²° íŒ¨í„´ ì •ìƒ"ìœ¼ë¡œ ìˆ˜ì • â†’ AI íŒë‹¨ ê¸°ì¤€ ì—…ë°ì´íŠ¸
- ì˜ëª»ëœ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•œ í”¼ë“œë°± ì œê³µ

**2) TaskCard Override** (âš ï¸ ì°¸ê³ : 'Suggestion Override'ëŠ” ë ˆê±°ì‹œ ìš©ì–´, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- TaskCard (task_type: 'ai_suggested', entity_type='student') ë©”ì‹œì§€ ì´ˆì•ˆ ìˆ˜ì • â†’ ìƒˆë¡œìš´ í…œí”Œë¦¿ í•™ìŠµ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- ì¶”ì²œëœ ë©”ì‹œì§€ ë‚´ìš© ìˆ˜ì • ë° ì¬ë°œì†¡
- TaskCard (task_type: 'ai_suggested', entity_type='student') ë¬´ì‹œ ì˜µì…˜ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

**3) Auto-Action Undo**
- ìë™ ë°œì†¡ëœ ì•Œë¦¼ ì·¨ì†Œ (ê°€ëŠ¥í•œ ê²½ìš°)
- ìë™ ê²°ì œ ì¬ì‹œë„ OFFë¡œ ì „í™˜
- ì˜ëª»ëœ ìë™ ì²­êµ¬ ì œê±°
- ìë™ ì²˜ë¦¬ëœ ì‘ì—…ì˜ ë¡¤ë°± ê¸°ëŠ¥

**AI Feedback Loop (í”¼ë“œë°± ì¬ë°˜ì˜):**

ì‚¬ìš©ìê°€ AI íŒë‹¨ì„ ë³´ì •(Override)í•˜ê±°ë‚˜ ìë™ ì•¡ì…˜ì„ Undoí•  ë•Œ, í•´ë‹¹ í”¼ë“œë°±ì´ AI ëª¨ë¸ í•™ìŠµì— ì¬ë°˜ì˜ë˜ì–´ í–¥í›„ íŒë‹¨ ì •í™•ë„ê°€ í–¥ìƒë©ë‹ˆë‹¤.

**í”¼ë“œë°± ìˆ˜ì§‘:**
- `ai_feedback_logs` í…Œì´ë¸”ì— Override/Undo ì´ë²¤íŠ¸ ê¸°ë¡
- í”¼ë“œë°± ìœ í˜•: `insight_override`, `student_task_override` (âš ï¸ ì°¸ê³ : 'suggestion_override'ëŠ” ë ˆê±°ì‹œ, í˜„ì¬ëŠ” TaskCard í”¼ë“œë°±, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­), `auto_action_undo`
- í”¼ë“œë°± ë‚´ìš©: ì›ë˜ AI íŒë‹¨, ì‚¬ìš©ì ë³´ì • ë‚´ìš©, ë³´ì • ì´ìœ 

**í”¼ë“œë°± ì¬ë°˜ì˜:**
- ì£¼ê¸°ì  ëª¨ë¸ ì¬í•™ìŠµ ì‹œ `ai_feedback_logs` ë°ì´í„°ë¥¼ í•™ìŠµ ë°ì´í„°ì— í¬í•¨
- Overrideëœ íŒ¨í„´ì€ í–¥í›„ ë™ì¼ ìƒí™©ì—ì„œ ì„œë²„ê°€ AI ëª¨ë¸ì„ ì¬í•™ìŠµí•˜ì—¬ ë‹¤ë¥¸ ì¶”ì²œì„ í•˜ë„ë¡ ê°€ì¤‘ì¹˜ ì¡°ì •
- Undoëœ ìë™ ì•¡ì…˜ì€ í•´ë‹¹ ì•¡ì…˜ì˜ íŠ¸ë¦¬ê±° ì¡°ê±´ì„ ì™„í™”í•˜ê±°ë‚˜ ì œê±°

**Zero-Interaction ì² í•™ ê°•í™”:**
- ì‚¬ìš©ì í”¼ë“œë°±ì´ ìë™ìœ¼ë¡œ í•™ìŠµì— ë°˜ì˜ë˜ì–´, ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ AI íŒë‹¨ ì •í™•ë„ê°€ í–¥ìƒ
- ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ í•™ìŠµ ë°ì´í„°ë¥¼ ì œê³µí•˜ì§€ ì•Šì•„ë„, ì¼ìƒì ì¸ ì‚¬ìš© ì¤‘ ë°œìƒí•˜ëŠ” Override/Undoê°€ ìì—°ìŠ¤ëŸ½ê²Œ í•™ìŠµ ë°ì´í„°ë¡œ ì¶•ì 

#### 3.7.5 Auto-Action Undo ì¡°ê±´ ëª…ì„¸

ì–´ë–¤ Auto-Actionì€ Undo ê°€ëŠ¥í•˜ê³  ì–´ë–¤ ê²ƒì€ ë¶ˆê°€ëŠ¥í•œì§€ ëª…í™•íˆ ì •ì˜:

| Action | Undo ê°€ëŠ¥ ì—¬ë¶€ | ì´ìœ  | Undo ë°©ë²• |
|--------|--------------|------|----------|
| ìë™ ë¯¸ë‚© ì•Œë¦¼ ë°œì†¡ | âŒ ë¶ˆê°€ | ì´ë¯¸ ì „ì†¡ëœ ë©”ì‹œì§€ëŠ” íšŒìˆ˜ê°€ ë¶ˆê°€ | - |
| ìë™ ì²­êµ¬ ìƒì„± | â­• ê°€ëŠ¥ | ì²­êµ¬ì„œ ì‚­ì œ ë˜ëŠ” draft ë³µê·€ ê°€ëŠ¥ | ì²­êµ¬ì„œ ì‚­ì œ ë˜ëŠ” statusë¥¼ 'draft'ë¡œ ë³€ê²½ |
| ìë™ ê²°ì œ ì¬ì‹œë„ | â­• ê°€ëŠ¥ | next_retry_at ì´ˆê¸°í™” ê°€ëŠ¥ | ì¬ì‹œë„ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ, next_retry_at = null |
| ì„œë²„ê°€ ìƒë‹´ AI ìš”ì•½ ìƒì„± | â­• ê°€ëŠ¥ | ìš”ì•½ ì¬ìƒì„± ê°€ëŠ¥ | ìš”ì•½ ì‚­ì œ í›„ ì¬ìƒì„± |
| ìë™ ì¶œê²° ì²˜ë¦¬ | âŒ ë¶ˆê°€ | ì´ë¯¸ ê¸°ë¡ëœ ì¶œê²°ì€ ìˆ˜ì •ë§Œ ê°€ëŠ¥ | ì¶œê²° ìˆ˜ì • ê¸°ëŠ¥ ì‚¬ìš© |
| ìë™ ì²­êµ¬ ë°œì†¡ | âŒ ë¶ˆê°€ | ì´ë¯¸ ë°œì†¡ëœ ì²­êµ¬ì„œëŠ” íšŒìˆ˜ ë¶ˆê°€ | - |
| ìë™ ë¦¬í¬íŠ¸ ìƒì„± | â­• ê°€ëŠ¥ | ë¦¬í¬íŠ¸ ì‚­ì œ ê°€ëŠ¥ | ë¦¬í¬íŠ¸ ì‚­ì œ |
| AI ì¸ì‚¬ì´íŠ¸ ìƒì„± | â­• ê°€ëŠ¥ | ì¸ì‚¬ì´íŠ¸ ì¬ìƒì„± ê°€ëŠ¥ | ì¸ì‚¬ì´íŠ¸ ì‚­ì œ í›„ ì¬ìƒì„± |

**Undo ê°€ëŠ¥í•œ Action ì²˜ë¦¬:**
- Undo ë²„íŠ¼ ì œê³µ
- Undo ì‹¤í–‰ ì‹œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
- Undo ì´ë ¥ ë¡œê·¸ ì €ì¥
- Undo í›„ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬

**Undo ë¶ˆê°€ëŠ¥í•œ Action ì²˜ë¦¬:**
- Undo ë²„íŠ¼ ë¹„í™œì„±í™” ë˜ëŠ” ìˆ¨ê¹€
- ëŒ€ì‹  "ìˆ˜ì •" ë˜ëŠ” "ë³´ì •" ê¸°ëŠ¥ ì œê³µ
- ì‚¬ìš©ìì—ê²Œ Undo ë¶ˆê°€ëŠ¥ ì´ìœ  ëª…ì‹œ

**âš ï¸ H9: AI Undo ê·œì¹™ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ ì¶©ëŒ í•´ê²°:**

**Auto-Action Undo ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ (v3.3 í™•ì •):**

| Action | Admin | Sub Admin | Teacher | Assistant |
|--------|-------|-----------|---------|-----------|
| ìë™ ì²­êµ¬ ìƒì„± Undo | â­• | â­• | âŒ | âŒ |
| ìë™ ê²°ì œ ì¬ì‹œë„ ì·¨ì†Œ | â­• | â­• | âŒ | âŒ |
| ì„œë²„ê°€ ìƒë‹´ AI ìš”ì•½ ìƒì„± ì‚­ì œ | â­• | â­• | â­• | âŒ |
| ìë™ ë¦¬í¬íŠ¸ ìƒì„± ì‚­ì œ | â­• | â­• | âŒ | âŒ |
| (ì‹¤ì œ ë°œì†¡ëœ) ë¯¸ë‚© ì•Œë¦¼ Undo | âŒ | âŒ | âŒ | âŒ |

**ê¶Œí•œ ì ìš© ê·œì¹™ (ëª…í™•í™”):**
- **Admin**: ëª¨ë“  Undo ê°€ëŠ¥ í•­ëª©ì— ëŒ€í•´ Undo ê°€ëŠ¥
- **Sub Admin**: í‘œì—ì„œ â­• ì¸ í•­ëª©ë§Œ Undo ê°€ëŠ¥ (ì²­êµ¬ ìƒì„±, ê²°ì œ ì¬ì‹œë„ ì·¨ì†Œ, ìƒë‹´ ìš”ì•½ ì‚­ì œ, ë¦¬í¬íŠ¸ ìƒì„± ì‚­ì œ)
- **Teacher**: ìƒë‹´ ìš”ì•½ ì‚­ì œë§Œ ê°€ëŠ¥ (â­• í‘œì‹œëœ í•­ëª©)
- **Assistant**: Undo ê¶Œí•œ ì—†ìŒ (ëª¨ë“  í•­ëª© âŒ)

**âš ï¸ ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ "UndoëŠ” Adminë§Œ"ì´ë¼ê³  ì„œìˆ ëœ ê²½ìš°ëŠ” ì˜¤ë¥˜ì…ë‹ˆë‹¤.**
**ìœ„ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ê°€ ì •ë³¸ì…ë‹ˆë‹¤.**

#### 3.7.6 Auto-Action Undo API & Audit Rule

**Undo API ê·œê²©:**

```
POST /api/automation/{action_id}/undo

Request Body:
{
  "reason": "mistaken_action" | "incorrect_data" | "user_request",
  "requested_by": "user_id",
  "comment": "string (ì„ íƒ)"
}

Response:
{
  "success": boolean,
  "action_id": "uuid",
  "undo_status": "completed" | "failed",
  "message": "string"
}
```

**Undo API ì¸ì¦:**
- Admin ê¶Œí•œ í•„ìˆ˜
- Sub Adminì€ ì œí•œì  Undoë§Œ ê°€ëŠ¥ (ë³¸ ë¬¸ì„œ 3.7.5 Auto-Action Undo ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ ì°¸ì¡°)
- Undo ì‹¤í–‰ ì „ ê¶Œí•œ í™•ì¸

**Undo Audit Log ì •ì˜:**

```sql
CREATE TABLE automation_undo_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  action_id uuid NOT NULL REFERENCES automation_actions(id),
  user_id uuid NOT NULL,
  tenant_id uuid NOT NULL,
  reason text NOT NULL,

  // âš ï¸ ğŸ”¥ 12ë²ˆ: Auto-Action Undo ì›ë³¸ ìƒíƒœ ì €ì¥ êµ¬ì¡°
  before_state jsonb NOT NULL,  // ë³€ê²½ ì „ ì „ì²´ ìƒíƒœ (snapshot)
  after_state jsonb NOT NULL,   // ë³€ê²½ í›„ ì „ì²´ ìƒíƒœ (snapshot)
  reversible boolean NOT NULL DEFAULT true,  // Undo ê°€ëŠ¥ ì—¬ë¶€ í”Œë˜ê·¸

  // ì›ë³¸ ìƒíƒœ ë³µêµ¬ì— í•„ìš”í•œ ì¶”ê°€ ì •ë³´
  original_action_type text NOT NULL,  // ì›ë³¸ ì•¡ì…˜ íƒ€ì… (ì˜ˆ: 'auto_billing_create')
  original_entity_type text NOT NULL,  // ì›ë³¸ ì—”í‹°í‹° íƒ€ì… (ì˜ˆ: 'invoice')
  original_entity_id uuid NOT NULL,    // ì›ë³¸ ì—”í‹°í‹° ID

  undo_status text NOT NULL,
  comment text,
  created_at timestamptz NOT NULL DEFAULT now()
);

// âš ï¸ ì›ë³¸ ìƒíƒœ ì €ì¥ ê·œì¹™:
// - before_state: ë³€ê²½ ì „ ì „ì²´ ì—”í‹°í‹° ìƒíƒœë¥¼ JSONìœ¼ë¡œ ì €ì¥
// - after_state: ë³€ê²½ í›„ ì „ì²´ ì—”í‹°í‹° ìƒíƒœë¥¼ JSONìœ¼ë¡œ ì €ì¥
// - reversible: ì´ ì•¡ì…˜ì„ Undoí•  ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ (falseë©´ Undo ë¶ˆê°€)
// - ì›ë³¸ ìƒíƒœ ë³µêµ¬ ì‹œ before_stateë¥¼ ê·¸ëŒ€ë¡œ ë³µì›
```

**Audit Log ê¸°ë¡ í•­ëª©:**
- action_id: Undoëœ ì•¡ì…˜ ID
- user_id: Undo ì‹¤í–‰í•œ ì‚¬ìš©ì
- before_state: Undo ì „ ìƒíƒœ (JSON)
- after_state: Undo í›„ ìƒíƒœ (JSON)
- reason: Undo ì‚¬ìœ 
- undo_status: Undo ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ

**Audit Log í™œìš©:**
- Undo ì´ë ¥ ì¶”ì 
- ë³´ì•ˆ ê°ì‚¬
- ë¬¸ì œ ë¶„ì„
- AI í•™ìŠµ ë°ì´í„°

#### 3.7.7 AI Feedback Persistence (í•™ìŠµ ì €ì¥ ë°©ì‹)

AIê°€ ìˆ˜ì • ë‚´ìš©ì„ ì €ì¥í•˜ê³  í•™ìŠµí•˜ëŠ” êµ¬ì¡°:

**ai_feedback_logs í…Œì´ë¸” êµ¬ì¡°:**

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| id | UUID | PK |
| tenant_id | UUID | ë©€í‹°í…Œë„ŒíŠ¸ |
| ai_type | VARCHAR | insight / auto_action (âš ï¸ ì°¸ê³ : 'suggestion'ì€ ë ˆê±°ì‹œ, í˜„ì¬ëŠ” TaskCard ì‚¬ìš©, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­) |
| original_output | JSONB | AI ì›ë³¸ ê²°ê³¼ |
| user_override | JSONB | ì‚¬ìš©ì ìˆ˜ì • ë‚´ìš© |
| override_type | VARCHAR | deny / edit / undo |
| created_at | TIMESTAMP | ì‹œê°„ |
| applied_to_model | BOOLEAN | ëª¨ë¸ ë°˜ì˜ ì—¬ë¶€ |
| feedback_context | JSONB | ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ |

**í”¼ë“œë°± ì²˜ë¦¬ íë¦„:**
1. ì‚¬ìš©ìê°€ AI ê²°ê³¼ë¥¼ ìˆ˜ì •/ê±°ë¶€/ì·¨ì†Œ
2. ai_feedback_logsì— ìë™ ì €ì¥
3. ì£¼ê¸°ì ìœ¼ë¡œ í”¼ë“œë°± ë°ì´í„°ë¥¼ ëª¨ë¸ í•™ìŠµì— ë°˜ì˜
4. applied_to_model = trueë¡œ ì—…ë°ì´íŠ¸

**ëª¨ë¸ í•™ìŠµ ë°˜ì˜:**
- ì£¼ê¸°ì  ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ í”¼ë“œë°± ë°ì´í„° ìˆ˜ì§‘
- ëª¨ë¸ ì¬í•™ìŠµ ë˜ëŠ” Fine-tuningì— í™œìš©
- AIê°€ ì ì  ë˜‘ë˜‘í•´ì§€ëŠ” êµ¬ì¡° ì™„ì„±

**AI Feedback â†’ ëª¨ë¸ ë°˜ì˜ ê³¼ì •**

Feedbackì´ ëª¨ë¸ì— ë°˜ì˜ë˜ëŠ” êµ¬ì²´ì ì¸ í”„ë¡œì„¸ìŠ¤:

**âš ï¸ C12: AI Feedback learning cycleê³¼ Event Engine ìŠ¤ì¼€ì¤„ ì¶©ëŒ í•´ê²°:**

**AI Feedback í•™ìŠµ ìŠ¤ì¼€ì¤„ê³¼ Event Engine í†µí•© ê·œì¹™:**

```typescript
AI_feedback_learning_schedule = {
  // ë§¤ì¼ ìƒˆë²½ 3ì‹œì— Fine-tuning í ì—…ë°ì´íŠ¸
  daily_fine_tuning_queue: '03:00',

  // âš ï¸ Event Engine ìŠ¤ì¼€ì¤„ê³¼ í†µí•©:
  // - Daily queue refill(03:00) â†’ AI Insight ìƒì„±(07:00) ì‚¬ì´ 4ì‹œê°„ ê°„ê²©
  // - Weekly retrain(04:00 ì¼ìš”ì¼) â†’ AI Insight ìƒì„±(07:00) ì‚¬ì´ 3ì‹œê°„ ê°„ê²©
  // - ì¶©ë¶„í•œ ê°„ê²©ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ Event Queue ì§€ì—° ë°©ì§€

  // Insights ëª¨ë¸ ì¬í•™ìŠµ ì£¼ê¸°: ì£¼ 1íšŒ (ì¼ìš”ì¼ ìƒˆë²½ 4ì‹œ)
  insights_model_retrain: {
    schedule: 'weekly',
    day: 'sunday',
    time: '04:00',
    // âš ï¸ AI Insight ìƒì„±(07:00) ì „ì— ì™„ë£Œë˜ë„ë¡ ì„¤ì •
    max_duration: '2 hours',  // ìµœëŒ€ 2ì‹œê°„ ë‚´ ì™„ë£Œ ê°€ì •

    // âš ï¸ Event Queue ìš°ì„ ìˆœìœ„ ì¡°ì •:
    // - AI Feedback ì¬í•™ìŠµì€ ë‚®ì€ ìš°ì„ ìˆœìœ„ë¡œ ì²˜ë¦¬
    // - ì¶œê²°/ê²°ì œ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¬í•™ìŠµ ì‘ì—… ì¼ì‹œ ì¤‘ë‹¨ ê°€ëŠ¥
    event_queue_priority: 'low',
    interruptible: true  // ë†’ì€ ìš°ì„ ìˆœìœ„ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì¤‘ë‹¨ ê°€ëŠ¥
  },

  // Risk ëª¨ë¸ ì¬í•™ìŠµ ì£¼ê¸°: ì£¼ 1íšŒ
  risk_model_retrain: {
    schedule: 'weekly',
    day: 'sunday',
    time: '04:00',
    max_duration: '2 hours'
  },

  // Feedback ê°€ì¤‘ì¹˜ ì¦ê°€ ê·œì¹™: ìµœê·¼ 30ì¼ ë°ì´í„°ì— ê°€ì¤‘
  feedback_weight_rule: {
    recent_30_days: 1.5,
    recent_90_days: 1.2,
    older: 1.0
  },

  // âš ï¸ ëŒ€ëŸ‰ ì¶œê²°/ê²°ì œ ë°œìƒ ì‹œ ì²˜ë¦¬:
  // ì›”ìš”ì¼ ëŒ€ëŸ‰ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ AI Feedback ì²˜ë¦¬ â†’ Event Queue ì§€ì—° ê°€ëŠ¥
  // â†’ AI Feedback ì²˜ë¦¬ëŠ” ë‚®ì€ ìš°ì„ ìˆœìœ„ë¡œ ì„¤ì •í•˜ì—¬
  //   ì¶œê²°/ê²°ì œ ì´ë²¤íŠ¸ê°€ ìš°ì„  ì²˜ë¦¬ë˜ë„ë¡ í•¨
  priority: 'low',  // Event Queueì—ì„œ ë‚®ì€ ìš°ì„ ìˆœìœ„
  batch_size: 100,  // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ì—¬ Queue ë¶€í•˜ ìµœì†Œí™”
  max_processing_time: '30 minutes'  // ìµœëŒ€ ì²˜ë¦¬ ì‹œê°„ ì œí•œ
}
```

**ëª¨ë¸ ë°˜ì˜ ë²”ìœ„:**
- **Insights ëª¨ë¸**: AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì •í™•ë„ í–¥ìƒ
- **Risk ëª¨ë¸**: ì´íƒˆ ìœ„í—˜ íƒì§€ ì •í™•ë„ í–¥ìƒ
- **Suggestion ëª¨ë¸**: AI ì¶”ì²œ ë©”ì‹œì§€ í’ˆì§ˆ í–¥ìƒ
- **Auto-Action ëª¨ë¸**: ìë™ ì‹¤í–‰ íŒë‹¨ ì •í™•ë„ í–¥ìƒ

**Feedback ì˜í–¥ ë²”ìœ„:**
- Level 1 (AI Insight Only): Insights ëª¨ë¸ì— ë°˜ì˜
- Level 2 (TaskCard, task_type: 'ai_suggested', entity_type='student'): TaskCard í”¼ë“œë°± ëª¨ë¸ì— ë°˜ì˜ (âš ï¸ ì°¸ê³ : 'AI Suggestion'ì€ ë ˆê±°ì‹œ ìš©ì–´, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- Level 3 (AI Auto-Action): Auto-Action ëª¨ë¸ì— ë°˜ì˜

**Zero-Trust ì¤€ìˆ˜:**
- ëª¨ë“  AI íŒë‹¨ê³¼ ì‚¬ìš©ì ë³´ì •ì€ ì¶”ì  ê°€ëŠ¥
- ai_feedback_logsëŠ” RLSë¡œ í…Œë„ŒíŠ¸ë³„ ì™„ì „ ë¶„ë¦¬

**ë³´ì • ì‚¬ë¡€:**
- ì •ìƒ í•™ìƒì„ ì´íƒˆ ìœ„í—˜ìœ¼ë¡œ íŒë‹¨ â†’ "ì´íƒˆ ìœ„í—˜ ì•„ë‹˜" í‘œì‹œ
- ì˜ëª»ëœ ì¶œê²° íŒ¨í„´ ë¶„ì„ â†’ ë¶„ì„ ê²°ê³¼ ìˆ˜ì • ë° í”¼ë“œë°±
- ë¯¸ë‚© ì•Œë¦¼ì„ ì˜ëª»ëœ í•™ë¶€ëª¨ì—ê²Œ ë³´ëƒ„ â†’ ì•Œë¦¼ ì·¨ì†Œ ë° ì¬ë°œì†¡

## 4. UI/UX ì•„í‚¤í…ì²˜ (UI/UX Architecture)

### 4.1 Zero-Learning UI

ì‚¬ìš©ìê°€ íŠœí† ë¦¬ì–¼ ì—†ì´ë„ ì§ê´€ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
- í™”ë©´ì´ ë³µì¡í•˜ì§€ ì•Šë‹¤.
- ê¸°ëŠ¥ë³´ë‹¤ "í•´ì•¼ í•  ì¼" ì¤‘ì‹¬ì´ë‹¤.
- í•œ í™”ë©´ì— í•œ ê°€ì§€ í–‰ë™ë§Œ ëª…í™•íˆ ë“œëŸ¬ë‚˜ì•¼ í•œë‹¤.
- ë©”ë‰´ êµ¬ì¡°ëŠ” ë‹¨ìˆœí™”í•˜ì—¬, í•™ì› ì›ì¥/ì„ ìƒë‹˜ì´ ì²˜ìŒ ì ‘í•´ë„ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

### 4.2 Zero-Interaction UX

ì‚¬ìš©ìê°€ í´ë¦­í•˜ì§€ ì•Šì•„ë„ ì‹œìŠ¤í…œì´ ë¨¼ì € ì¶”ì²œ/ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì‹¤í–‰(ë°œì†¡/ì ìš©)ì€ ìŠ¹ì¸/ì •ì±… ê²Œì´íŠ¸ë¥¼ í†µí•´ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

**ì ìš© ì˜ì—­:**
- ì¶œê²° ìë™ ê°ì§€
- ì„œë²„ê°€ ì²­êµ¬ ìƒì„±
- ìë™ ë¯¸ë‚© ì•Œë¦¼
- ì„œë²„ê°€ ìƒë‹´ ìš”ì•½ ìƒì„±
- ì„œë²„ê°€ ë¦¬í¬íŠ¸ ìƒì„±
- ì„œë²„ê°€ í†µê³„ ë¶„ì„ (AI í˜¸ì¶œ í¬í•¨)
- ì„œë²„ê°€ ì¶”ì²œ ë©”ì‹œì§€ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)

ì´ ì›ì¹™ì€ ì¶œê²°Â·ì²­êµ¬Â·AIÂ·í†µê³„ ì „ì²´ì— ì ìš©ë˜ëŠ” ìµœìƒìœ„ ê·œì¹™ì´ë‹¤.

### 4.3 Adaptive UI

(ë³¸ ë¬¸ì„œ 1.8 ì„¹ì…˜ ì°¸ì¡°)

### 4.4 ê¸°ê¸°ë³„ UX(PC/Tablet/Mobile)

(ë³¸ ë¬¸ì„œ 1.8 ì„¹ì…˜ ì°¸ì¡°)

### 4.5 íƒœë¸”ë¦¿/í‚¤ì˜¤ìŠ¤í¬ ì „ìš© UI ê·œì•½

(ë³¸ ë¬¸ì„œ 3.3.9 ì„¹ì…˜ ì°¸ì¡°)

**ìƒì„¸ UI/UX ê·œì•½:**
- UI/UX Technical Architecture v6.0 - "Responsive UX / Kiosk Mode" ì„¹ì…˜ ì°¸ì¡°

### 4.5.1 UI ê¸°ìˆ  ìŠ¤íƒ ìš”ì•½

**âš ï¸ UI ê¸°ìˆ  ìŠ¤íƒ í•µì‹¬ ê·œì•½ (U6, S3 ì°¸ì¡°):**

ë””ì–´ìŒ¤ UIëŠ” ë‹¤ìŒ ê¸°ìˆ  ìŠ¤íƒ ê²½ë¡œë¥¼ ë”°ë¥¸ë‹¤:

**ë ˆì´ì–´ êµ¬ì¡°:**
- `schema-engine` â†’ `core-ui` â†’ `design-system` â†’ `theme-engine` (U6 ì°¸ì¡°)
- ì˜ì¡´ì„± ë°©í–¥: schema-engine â†’ `@ui-core/react` â†’ (design-system/theme-engine í† í°) â†’ CSS ë³€ìˆ˜ (S3 ì°¸ì¡°)

**í•µì‹¬ ì œì•½:**
- **Tailwind í´ë˜ìŠ¤ ì§ì ‘ ì‚¬ìš© ê¸ˆì§€**: ì–´ë–¤ ë ˆì´ì–´ì—ì„œë„ Tailwind í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤
- **ui-core ê¸°ë°˜ ì»´í¬ë„ŒíŠ¸**: ì‹¤ì œ UI ì»´í¬ë„ŒíŠ¸ëŠ” `@ui-core/react`ë¥¼ ì‚¬ìš©í•˜ë©°, ìŠ¤íƒ€ì¼ì€ design-system/theme-engine í† í°ì´ CSS ë³€ìˆ˜ë¡œ ì ìš©ëœë‹¤
- **ì•± ë ˆë²¨ ìŠ¤íƒ€ì¼ ì œí•œ**: ì•± ë ˆë²¨(index.css)ëŠ” ì•± ì „ìš© ìµœì†Œ ìŠ¤íƒ€ì¼ë§Œ ì‚¬ìš©í•˜ê³ , ê¸€ë¡œë²Œ ìŠ¤íƒ€ì¼ì€ ë””ìì¸ ì‹œìŠ¤í…œ/í…Œë§ˆ ì—”ì§„ì—ì„œ ì œê³µí•œë‹¤
- **Schema Engine ì¤‘ì‹¬**: ëª¨ë“  UI ë Œë”ë§ì€ Schema Engineì„ í†µí•´ì„œë§Œ ìˆ˜í–‰í•œë‹¤

**ìƒì„¸ ê·œì•½:**
- UI/UX Technical Architecture v6.0 (U6) ì°¸ì¡°
- Schema Engine v2.1 (S3) ì°¸ì¡°

### 4.6 í™ˆ ëŒ€ì‹œë³´ë“œ ìš°ì„ ìˆœìœ„ ê·œì¹™

**âš ï¸ í™ˆ ëŒ€ì‹œë³´ë“œ ì •ë ¬ ì›ì¹™:**

í™ˆ ëŒ€ì‹œë³´ë“œ ì •ë ¬ì€ Group Priority â†’ ê·¸ë£¹ ë‚´ë¶€ Priority ìˆœìœ¼ë¡œ ì •ë ¬í•œë‹¤.
TaskCardì˜ priorityëŠ” 'TaskCard ê·¸ë£¹ ë‚´ë¶€'ì—ì„œë§Œ ì ìš©ëœë‹¤. (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

**Home Priority Rule (í™ˆ ëŒ€ì‹œë³´ë“œ ìš°ì„ ìˆœìœ„ ê·œì¹™)**

í™ˆ í™”ë©´ì—ì„œ ì¹´ë“œ í‘œì‹œ ìš°ì„ ìˆœìœ„:

**1ìˆœìœ„: ê¸´ê¸‰ ì•Œë¦¼**
- ê²°ì œ ì‹¤íŒ¨
- ìœ„í—˜ í•™ìƒ
- ì¶œê²° ì˜¤ë¥˜
- ì‹œìŠ¤í…œ ì˜¤ë¥˜

**2ìˆœìœ„: AI ë¸Œë¦¬í•‘ ì¹´ë“œ**
- ì˜¤ëŠ˜ì˜ AI ì¸ì‚¬ì´íŠ¸
- ì„œë²„ê°€ ìƒì„±í•œ ìš”ì•½ ì •ë³´

**3ìˆœìœ„: ì˜¤ëŠ˜ í•´ì•¼ í•  ì¼(í•™ìƒ ì—…ë¬´ ì¹´ë“œ)**
- ìƒë‹´ í•„ìš” í•™ìƒ
- ê²°ì„ í•™ìƒ
- ì´íƒˆ ìœ„í—˜ í•™ìƒ
- ì‹ ê·œ ë“±ë¡ í•™ìƒ

**4ìˆœìœ„: ì˜¤ëŠ˜ ë°˜ ìˆ˜ì—… ìš”ì•½**
- ì˜¤ëŠ˜ ìˆ˜ì—… ìˆëŠ” ë°˜
- ì¶œê²° í˜„í™© ìš”ì•½
- ìˆ˜ì—… ì¼ì •

**5ìˆœìœ„: í†µê³„/íŠ¸ë Œë“œ ìš”ì•½**
- ì§€ì—­ í†µê³„ ìš”ì•½
- ì„±ì¥ ì§€í‘œ
- íŠ¸ë Œë“œ ë¶„ì„

**ìš°ì„ ìˆœìœ„ ì ìš© ê·œì¹™:**
- ê¸´ê¸‰ ì•Œë¦¼ì€ í•­ìƒ ìµœìƒë‹¨ ê³ ì •
- ë™ì¼ ìš°ì„ ìˆœìœ„ ë‚´ì—ì„œëŠ” ì‹œê°„ìˆœ ì •ë ¬
- ì¹´ë“œ ê°œìˆ˜ ì œí•œ: ì œí•œ ì—†ìŒ (ëª¨ë“  ì¹´ë“œ ì¶œë ¥, ê·¸ë£¹ë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ í‘œì‹œ)
- ì‚¬ìš©ìê°€ ì¹´ë“œë¥¼ ë‹«ìœ¼ë©´ í•´ë‹¹ ì¹´ë“œëŠ” í•˜ë£¨ ë™ì•ˆ ìˆ¨ê¹€ ì²˜ë¦¬

**âš ï¸ C4: Billing Home ì¹´ë“œ ìš°ì„ ìˆœìœ„ ì¶©ëŒ í•´ê²°:**

**í™ˆ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìš°ì„ ìˆœìœ„ í†µí•© ê·œì¹™ (í™•ì •):**

ìœ„ì˜ "í™ˆ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìš°ì„ ìˆœìœ„ ê³µì‹ í…Œì´ë¸”" (3112-3184ì¤„)ì´ ìœ ì¼í•œ ì •ì‹ ì •ì˜ì…ë‹ˆë‹¤.

**ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ ì¹´ë“œ ìš°ì„ ìˆœìœ„ë¥¼ ì–¸ê¸‰í•  ë•ŒëŠ”:**
- "3.7.1 AI ë¸Œë¦¬í•‘ ì¹´ë“œì˜ í™ˆ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìš°ì„ ìˆœìœ„ ê³µì‹ í…Œì´ë¸” ì°¸ì¡°" í˜•íƒœë¡œë§Œ ì–¸ê¸‰
- ì¤‘ë³µëœ ìš°ì„ ìˆœìœ„ ê·œì¹™ ì •ì˜ ì œê±°

**Merge Rule ì ìš©:**
- Card Groupì´ ìš°ì„ ì´ê³ , PriorityëŠ” ê·¸ë£¹ ë‚´ë¶€ì—ì„œë§Œ ì ìš©ëœë‹¤
- Emergency ê·¸ë£¹ì€ í•­ìƒ ìµœìƒë‹¨ ê³ ì • (priority ë¬´ì‹œ)
- AI ê·¸ë£¹ì€ Emergency ë‹¤ìŒ
- TaskCard ê·¸ë£¹ ë‚´ë¶€ì—ì„œë§Œ priority í•„ë“œë¡œ ì •ë ¬ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- emergency_card ì¡°ê±´ì´ TaskCardì˜ priorityë³´ë‹¤ ê°•í•¨ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

**âš ï¸ M8: Home í™”ë©´ ì¹´ë“œ ì¶œë ¥ ê·œì¹™ (v3.4 ì—…ë°ì´íŠ¸, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­):**

**ì¹´ë“œ ì¶œë ¥ ê·œì¹™ (v3.4 í™•ì •):**

í™ˆ í™”ë©´ì€ ëª¨ë“  ì¹´ë“œë¥¼ ì¶œë ¥í•˜ë©°, ê·¸ë£¹ë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ 4ì—´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒìœ¼ë¡œ í‘œì‹œí•œë‹¤:

```typescript
home_card_display = {
  // ì¹´ë“œ ì¶œë ¥ ì œí•œ: ì—†ìŒ (ëª¨ë“  ì¹´ë“œ ì¶œë ¥)
  card_limit: null,

  // ë ˆì´ì•„ì›ƒ
  layout: {
    type: 'grid',
    desktop_columns: 4,
    tablet_columns: 2,
    mobile_columns: 1,
    group_by_category: true  // ê·¸ë£¹ë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ í‘œì‹œ
  },

  // ì¹´ë“œ ê·¸ë£¹ ë¶„ë¥˜
  card_groups: {
    EMERGENCY: 'ê¸´ê¸‰ ì•Œë¦¼',
    AI_BRIEFING: 'AI ë¸Œë¦¬í•‘',
    STUDENT_TASKS: 'í•™ìƒ ì—…ë¬´',
    CLASSES: 'ì˜¤ëŠ˜ ìˆ˜ì—…',
    ATTENDANCE_STATS: 'ì¶œì„ ê´€ë ¨ ì§€í‘œ',
    STUDENT_GROWTH_STATS: 'í•™ìƒ ì„±ì¥ ì§€í‘œ',
    REVENUE_STATS: 'ë§¤ì¶œ ê´€ë ¨ ì§€í‘œ',
    COLLECTION_STATS: 'ìˆ˜ë‚© ê´€ë ¨ ì§€í‘œ',
    BILLING: 'ìˆ˜ë‚© í˜„í™©'
  },

  // ì‚¬ìš©ì ìˆ¨ê¹€ ì²˜ë¦¬ TTL ê·œì¹™
  user_hidden_card_ttl: {
    // ì‚¬ìš©ìê°€ ì¹´ë“œë¥¼ ë‹«ìœ¼ë©´ í•´ë‹¹ ì¹´ë“œëŠ” í•˜ë£¨ ë™ì•ˆ ìˆ¨ê¹€ ì²˜ë¦¬
    hidden_duration: '24 hours',

    // ìˆ¨ê¹€ ì²˜ë¦¬ ì €ì¥ ìœ„ì¹˜
    storage: 'user_preferences.hidden_cards',

    // ìˆ¨ê¹€ ì¹´ë“œ ë³µêµ¬ ê·œì¹™
    restore_rules: {
      // ê¸´ê¸‰ ì•Œë¦¼ ì¹´ë“œëŠ” ìˆ¨ê¹€ í•´ì œ ë¶ˆê°€
      emergency_cards_cannot_hide: true,

      // 24ì‹œê°„ í›„ ìë™ ë³µêµ¬
      auto_restore_after_ttl: true,

      // ìˆ˜ë™ ë³µêµ¬ ê°€ëŠ¥
      manual_restore_enabled: true,
      restore_ui_location: '/settings/preferences'
    }
  }
}
```

**ì¹´ë“œ ê·¸ë£¹ ë¶„ë¥˜:**
- ê¸´ê¸‰ ì•Œë¦¼ ê·¸ë£¹: ê²°ì œ ì‹¤íŒ¨, ì¶œê²° ì˜¤ë¥˜, ì‹œìŠ¤í…œ ì˜¤ë¥˜
- AI ë¸Œë¦¬í•‘ ê·¸ë£¹: AI ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ
- í•™ìƒ ì—…ë¬´ ê·¸ë£¹: ìƒë‹´ í•„ìš”, ê²°ì„, ì´íƒˆ ìœ„í—˜, ì‹ ê·œ ë“±ë¡
- ë°˜ ìˆ˜ì—… ê·¸ë£¹: ì˜¤ëŠ˜ ìˆ˜ì—… ìˆëŠ” ë°˜
- í†µê³„/íŠ¸ë Œë“œ ê·¸ë£¹: ì§€ì—­ í†µê³„ ìš”ì•½, ì„±ì¥ ì§€í‘œ

**Emergency Card í‘œì‹œ ì¡°ê±´:**

ê¸´ê¸‰ ì•Œë¦¼ ì¹´ë“œëŠ” ì•„ë˜ ì¡°ê±´ì„ ë§Œì¡±í•  ë•Œë§Œ í‘œì‹œëœë‹¤:

```typescript
emergency_rule = {
  // ê²°ì œ ì‹¤íŒ¨ê°€ ìµœê·¼ Nì¼ê°„ 2íšŒ ì´ìƒ ë°œìƒ (Policy ê¸°ë°˜ lookback window)
  // Policy ê²½ë¡œ: auto_notification.recurring_payment_failed.threshold (ì„ê³„ê°’, ê±´ìˆ˜)
  // Policy ê²½ë¡œ: auto_notification.recurring_payment_failed.lookback_days (ì¡°íšŒ ê¸°ê°„, ì¼ìˆ˜)
  // Fail Closed: Policyê°€ ì—†ìœ¼ë©´ Emergency Card ìƒì„±í•˜ì§€ ì•ŠìŒ
  payment_failed: count(payments where status = 'failed' AND created_at >= (now - lookback_days)) >= threshold,

  // ì¶œê²° ì˜¤ë¥˜ ì´ë²¤íŠ¸ê°€ 10ë¶„ ì´ë‚´ ë°œìƒ
  attendance_error_event: exists(attendance_errors within 10 minutes),

  // AI ìœ„í—˜ ì ìˆ˜ê°€ 90 ì´ìƒ
  ai_risk_score: risk_score >= 90
}
```

**ê¸´ê¸‰ ì•Œë¦¼ ì¹´ë“œ ì²˜ë¦¬:**
- ê¸´ê¸‰ ì•Œë¦¼ì€ í•­ìƒ ìµœìƒë‹¨ ê³ ì •
- ê¸´ê¸‰ ì•Œë¦¼ì€ ì‚¬ìš©ìê°€ ë‹«ì•„ë„ 1ì‹œê°„ í›„ ì¬í‘œì‹œ
- ê¸´ê¸‰ ì•Œë¦¼ ì²˜ë¦¬ ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ ì¹´ë“œ ì œê±°

### 4.7 ë©”ì¸ ë©”ë‰´ êµ¬ì¡°

**ê¸°ë³¸ ë©”ë‰´ (í•­ìƒ ë…¸ì¶œ - 6ê°œë§Œ)**

1. **í™ˆ**
   - ì˜¤ëŠ˜ì˜ ì§€í‘œ
   - í†µê³„ ìš”ì•½ ì¹´ë“œ
   - AI ë¸Œë¦¬í•‘ ì¹´ë“œ (ìƒë‹¨ ê³ ì •)

2. **ì¶œê²°**
   - ì˜¤ëŠ˜ ì¶œê²°í•˜ê¸°
   - QR ì¶œê²° ì‹¤í–‰ (ì„¤ì • í™œì„±í™” ì‹œ)

3. **í•™ìƒ**
   - ì˜¤ëŠ˜ì˜ í•™ìƒ ì—…ë¬´ ì¹´ë“œ (ì„œë²„ê°€ ìƒì„±)
   - í•™ìƒ ê¸°ë³¸ ì¡°íšŒ ë° ë“±ë¡
   - ìƒë‹´ì¼ì§€ ì‘ì„±

4. **ìˆ˜ë‚©**
   - ì´ë²ˆë‹¬ ì²­êµ¬ì„œ ë³´ê¸° (ì„œë²„ê°€ ìƒì„±)
   - ê²°ì œ ìƒíƒœ ë³´ê¸°
   - ì´ë²ˆë‹¬ ì˜ˆìƒ ìˆ˜ë‚©ë¥ 

5. **í†µê³„** ğŸ”¥ í•µì‹¬ ë©”ë‰´
   - AI í•´ì„ ë¬¸ì¥ (ìµœìƒë‹¨)
   - ì§€ì—­ ê¸°ë°˜ í†µê³„ ìš”ì•½
   - ìƒì„¸ ë¶„ì„ í™”ë©´ (í¼ì¹˜ê¸°)
   - ë¹„êµ/ìˆœìœ„ ê¸°ëŠ¥
   - íˆíŠ¸ë§µ ê¸°ëŠ¥

6. **AI** ğŸ”¥ í•µì‹¬ ë©”ë‰´
   - AI ë¸Œë¦¬í•‘ ì¹´ë“œ
   - ìƒì„¸ ë¶„ì„ í™”ë©´
   - ì¶œê²° ì´ìƒ íƒì§€
   - ìš´ì˜ ë¦¬í¬íŠ¸

**í•µì‹¬ ì›ì¹™:**
- ê¸°ë³¸ ë©”ë‰´ëŠ” 6ê°œë§Œ í•­ìƒ ë…¸ì¶œ: í™ˆ, ì¶œê²°, í•™ìƒ, ìˆ˜ë‚©, í†µê³„, AI
- í†µê³„ì™€ AIëŠ” ì ˆëŒ€ë¡œ ê³ ê¸‰ ë©”ë‰´ì— ë“¤ì–´ê°€ë©´ ì•ˆ ë˜ê³ ,
- ìˆ˜ë‚©/ì¶œê²°/í•™ìƒê´€ë¦¬ì™€ ë™ì¼í•œ ë ˆë²¨ì˜ ë©”ì¸ ë©”ë‰´ì—¬ì•¼ í•œë‹¤.
- í™”ë©´ì´ ê³§ "í•´ì•¼ í•  ì¼ ëª©ë¡"ì´ì–´ì•¼ í•˜ë©°, ìµœëŒ€ 1~2íƒ­ìœ¼ë¡œ ëª¨ë“  ì—…ë¬´ê°€ ì²˜ë¦¬ë¼ì•¼ í•¨

### 4.8 Advanced ë©”ë‰´ ê¸°ì¤€

**ê³ ê¸‰ ë©”ë‰´ (Advanced - ìˆ¨ê²¨ì§„ ë©”ë‰´ / í¼ì¹˜ê¸° ë°©ì‹)**

ë‚˜ë¨¸ì§€ ëª¨ë“  ê¸°ëŠ¥ì€ Advanced Menuë¡œ ì ‘ê¸°

- ë°˜/ê°•ì‚¬ ê´€ë¦¬
- ì¶œê²° ì„¤ì •
- ìƒí’ˆ/ì²­êµ¬ ì„¤ì •
- ë©”ì‹œì§€ í…œí”Œë¦¿/ì˜ˆì•½ë°œì†¡
- ì •ì‚°/ë§¤ì¶œ ìƒì„¸
- ì‹œìŠ¤í…œ ì„¤ì •

**Advanced Functions Hidden ê·œì¹™:**
- Advanced Functions Hidden ê·œì¹™ì€ í†µê³„Â·AIì—ëŠ” ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ìƒí’ˆì„¤ì •Â·ì •ì‚°Â·ì„¸ë¶€ í•„í„°Â·í…œí”Œë¦¿ ê´€ë¦¬ ë“±ë§Œ ê°ì¶¤ ëŒ€ìƒì´ë‹¤.
- ì´ˆê¸° í™”ë©´ì— ë…¸ì¶œë˜ë©´ í˜¼ë€ì„ ì£¼ëŠ” ìš´ì˜ ê¸°ëŠ¥ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬í•œë‹¤.

### 4.9 ë°˜ì‘í˜• í…Œì´ë¸” & ì¹´ë“œí˜• ëª¨ë°”ì¼ UI

**ì¶œê²° í™”ë©´**

**PC:**
- ì¶œê²° ë¦¬ìŠ¤íŠ¸ + ê²€ìƒ‰/í•„í„° + ì¼ì ì„ íƒ

**íƒœë¸”ë¦¿:**
- í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ(í° ë²ˆí˜¸ íŒ¨ë“œ + ë“±ì›/í•˜ì› ë²„íŠ¼)

**ëª¨ë°”ì¼:**
- í•™ìƒìš©/ê°•ì‚¬ìš© ë·° ë¶„ë¦¬, QR ìŠ¤ìº” ì§„ì… ë™ì„  ìµœì í™”

**ì²­êµ¬/ìˆ˜ë‚© í™”ë©´**

**PC:**
- ë³µí•© í…Œì´ë¸”(í•™ìƒÂ·ìƒí’ˆÂ·ê¸ˆì•¡Â·ìƒíƒœ) + ìš°ì¸¡ ìƒì„¸ íŒ¨ë„

**ëª¨ë°”ì¼:**
- ì¹´ë“œí˜• ë¦¬ìŠ¤íŠ¸ + ìµœì†Œ ì»¬ëŸ¼ë§Œ ë…¸ì¶œ, ìƒì„¸ëŠ” ë“œë¡œì–´/ëª¨ë‹¬ë¡œ ë¶„ë¦¬

**í†µê³„/ëŒ€ì‹œë³´ë“œ**

**Desktop:**
- ì¹´ë“œ + ì°¨íŠ¸ + íˆíŠ¸ë§µ ì¡°í•©

**Mobile:**
- ì¹´ë“œí˜• ìœ„ì£¼, ì°¨íŠ¸ëŠ” í•œ í™”ë©´ í•˜ë‚˜ì”©ë§Œ ë…¸ì¶œ

**Daily-Use First**
- ë§¤ì¼ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥(ì¶œê²°, í•™ìƒì¡°íšŒ, ì²­êµ¬í™•ì¸)ì€ ìµœìƒë‹¨ ë©”ë‰´ì— ê³ ì •í•œë‹¤.
- í†µê³„ì™€ AIëŠ” ë””ì–´ìŒ¤ì˜ í•µì‹¬ ê°€ì¹˜ì´ë¯€ë¡œ Daily-Use ì›ì¹™ì˜ ì˜ˆì™¸ë¡œ ì²˜ë¦¬í•œë‹¤.
- í†µê³„/AIëŠ” ì´ˆë³´ìë„ ë¶€ë‹´ ì—†ë„ë¡ "ìš”ì•½ ì¹´ë“œ â†’ ìƒì„¸ í™”ë©´" ë‹¨ê³„ êµ¬ì¡°ë¡œ ì œê³µí•œë‹¤.

**Role-Based UI Simplification**
- ë³´ì¡°êµì‚¬: 'ì¶œê²°'ë§Œ
- ì„ ìƒë‹˜: 'ì˜¤ëŠ˜ ë°˜ + ì¶œê²°'
- ì›ì¥: ì „ì²´ ë©”ë‰´
- ì—­í• ë³„ë¡œ í™”ë©´ ë°€ë„ ë° ë…¸ì¶œ ê¸°ëŠ¥ì´ ë‹¤ë¥´ë‹¤.

## 5. SDUI Schema Engine v2.1 (ì¤‘ì•™ Schema Registry)

### 5.1 SDUI ì ìš© ë²”ìœ„

(ë³¸ ë¬¸ì„œ 1.6 ì„¹ì…˜ ì°¸ì¡°)

**í•™ì› ë„ë©”ì¸ ì£¼ìš” í™”ë©´ë³„ SDUI ì ìš© ë²”ìœ„:**

| í™”ë©´ | SDUI ì ìš© ì—¬ë¶€ | ë¹„ê³  |
|------|--------------|------|
| **í•™ìƒ ë“±ë¡/ìˆ˜ì •** | 100% SDUI | FormSchema (S3 ì°¸ì¡°) |
| **ë°˜ ë°°ì •** | SDUI + Custom | Table + Custom Action |
| **ì¶œê²° ë©”ì¸ í™”ë©´** | Custom | Realtime Feed (ì‹¤ì‹œê°„ ì¶œê²° ì²˜ë¦¬) |
| **ì²­êµ¬ ìƒì„¸** | 100% SDUI | DetailSchema (S3 ì°¸ì¡°) |
| **ìˆ˜ë‚© ëª©ë¡** | SDUI + Custom | Table/FilterëŠ” SDUI, ê²°ì œ ì²˜ë¦¬ ë¶€ë¶„ì€ Custom |
| **í†µê³„ ëŒ€ì‹œë³´ë“œ** | Custom | Analytics ì°¨íŠ¸ (ì‹¤ì‹œê°„ ì°¨íŠ¸/íˆíŠ¸ë§µ) |
| **AI ì¸ì‚¬ì´íŠ¸ í™”ë©´** | Custom | ì‹¤ì‹œê°„ ìœ„í—˜ ê°ì§€, ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸ |
| **í™˜ê²½ì„¤ì • í™”ë©´** | 100% SDUI | FormSchema (S3 ì°¸ì¡°) |
| **ë©”ì‹œì§€ í…œí”Œë¦¿ ê´€ë¦¬** | 100% SDUI | FormSchema (S3 ì°¸ì¡°) |

**SDUI ì ìš© ì›ì¹™:**
- ì •ì  í¼/í…Œì´ë¸”/ìƒì„¸ í™”ë©´: 100% SDUI ì ìš©
- ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬ í™”ë©´: SDUI + ì»¤ìŠ¤í…€ ìœ„ì ¯ í˜¼í•©
- ë³µì¡í•œ ìƒí˜¸ì‘ìš© í™”ë©´: ì»¤ìŠ¤í…€ ìœ„ì ¯ ì¤‘ì‹¬, ê¸°ë³¸ ë ˆì´ì•„ì›ƒë§Œ SDUI í™œìš©

### 5.2 SDUI vs Custom ê²½ê³„ ê·œì¹™

**SDUIì™€ Custom UIì˜ ê²½ê³„ ì¡°ê±´**

ê°œë°œ ì‹œ ì¶©ëŒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ëª…í™•í•œ ê²½ê³„ ê·œì¹™:

**â‘  ì‹¤ì‹œê°„ ë°ì´í„°ê°€ í•„ìš”í•œ í™”ë©´ì€ Custom Only**
- ì¶œê²° í™”ë©´ (ì‹¤ì‹œê°„ ì¶œê²° ì²˜ë¦¬)
- ë¼ì´ë¸Œ ë°˜ ìˆ˜ì—… (ì‹¤ì‹œê°„ í•™ìƒ ìƒíƒœ)
- AI ëª¨ë‹ˆí„°ë§ (ì‹¤ì‹œê°„ ìœ„í—˜ ê°ì§€)
- ì‹¤ì‹œê°„ í†µê³„ ëŒ€ì‹œë³´ë“œ

**â‘¡ ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ ë§ì€ í™”ë©´ì€ SDUI ë¹„ê¶Œì¥**
- ìº˜ë¦°ë” í¸ì„±í‘œ (ë“œë˜ê·¸ ì•¤ ë“œë¡­, ë³µì¡í•œ ìƒí˜¸ì‘ìš©)
- ì¶œê²°ë¶€ (ì‹¤ì‹œê°„ ì²´í¬, ë³µì¡í•œ í•„í„°)
- AI ëŒ€ì‹œë³´ë“œ (ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸, ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)

**â‘¢ SDUI ì¶œë ¥ êµ¬ì¡°ì˜ í‘œì¤€ Component Set**

**Form:**
- Field.Control: ë‹¨ì¼ í•„ë“œ ì…ë ¥
- Field.Group: í•„ë“œ ê·¸ë£¹í™”
- Section: ì„¹ì…˜ êµ¬ë¶„

**Table:**
- Columns: ì»¬ëŸ¼ ì •ì˜
- Pagination: í˜ì´ì§€ë„¤ì´ì…˜
- Filter: í•„í„° íŒ¨ë„
- Summary: ìš”ì•½ í–‰

**Detail:**
- KeyValueView: í‚¤-ê°’ ìŒ í‘œì‹œ

**Widget:**
- Card: ì¹´ë“œ ë ˆì´ì•„ì›ƒ
- Metric: ì§€í‘œ í‘œì‹œ
- ChipList: ì¹© ë¦¬ìŠ¤íŠ¸

ì´ í‘œì¤€ Component Setì„ ì¤€ìˆ˜í•˜ì—¬ ê°œë°œìë§ˆë‹¤ ë‹¤ë¥¸ êµ¬ì¡°ë¡œ ì„¤ê³„ë˜ëŠ” ê²ƒì„ ë°©ì§€í•œë‹¤.

### 5.3 Form Schema

**SDUI Component Props êµ¬ì¡° ëª…ì„¸**

ê° SDUI ì»´í¬ë„ŒíŠ¸ì˜ JSON Schema êµ¬ì¡°:

**Field.Control Props:**
- id: string (í•„ìˆ˜)
- label: string (í•„ìˆ˜)
- type: 'text' | 'number' | 'select' | 'date' | 'datetime' | 'email' | 'phone' | 'textarea' | 'checkbox' | 'radio' (í•„ìˆ˜)
- placeholder: string (ì„ íƒ)
- default_value: any (ì„ íƒ)
- validation: ValidationRule (ì„ íƒ)
- condition: ConditionRule[] (ì„ íƒ)
- options?: Option[] (select/radio íƒ€ì… ì‹œ í•„ìˆ˜)

**Field.Group Props:**
- fields: Field.Control[] (í•„ìˆ˜)
- layout: { columns: number, columnGap: string } (ì„ íƒ)
- title?: string (ì„ íƒ)

**Section Props:**
- title: string (í•„ìˆ˜)
- description?: string (ì„ íƒ)
- fields: (Field.Control | Field.Group)[] (í•„ìˆ˜)
- collapsible?: boolean (ì„ íƒ)

**JSON Schema ì˜ˆì‹œ:**

```json
{
  "version": "1.0.0",
  "entity": "student",
  "type": "form",
  "form": {
    "fields": [
      {
        "id": "name",
        "label": "ì´ë¦„",
        "type": "text",
        "placeholder": "í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”",
        "validation": {
          "required": true,
          "min": 1,
          "max": 50
        }
      },
      {
        "id": "grade",
        "label": "í•™ë…„",
        "type": "select",
        "options": [
          { "value": "1", "label": "1í•™ë…„" },
          { "value": "2", "label": "2í•™ë…„" }
        ],
        "default_value": "1",
        "condition": [
          {
            "field": "student_type",
            "op": "==",
            "value": "regular",
            "action": "show"
          }
        ]
      }
    ]
  }
}
```

### 5.4 Table Schema

**âš ï¸ B5: SDUI Table Schema ì˜ˆì‹œ ì¶”ê°€:**

**Table Props:**
- columns: ColumnDefinition[] (í•„ìˆ˜)
- data: any[] (í•„ìˆ˜)
- pagination?: { page: number, pageSize: number } (ì„ íƒ)
- filter?: FilterSchema (ì„ íƒ)
- summary?: SummaryRow (ì„ íƒ)
- actions?: TableActions (ì„ íƒ)

**Table SDUI Schema ì˜ˆì‹œ:**

```json
{
  "version": "1.0.0",
  "entity": "student",
  "type": "table",
  "table": {
    "columns": [
      {
        "id": "name",
        "label": "ì´ë¦„",
        "type": "text",
        "sortable": true,
        "width": "150px"
      },
      {
        "id": "grade",
        "label": "í•™ë…„",
        "type": "number",
        "sortable": true,
        "width": "80px"
      },
      {
        "id": "class_name",
        "label": "ë°˜",
        "type": "text",
        "sortable": true,
        "width": "120px"
      },
      {
        "id": "status",
        "label": "ìƒíƒœ",
        "type": "badge",
        "badge_config": {
          "present": { "color": "green", "label": "ì¬ì›" },
          "absent": { "color": "red", "label": "íœ´ì›" }
        },
        "width": "100px"
      },
      {
        "id": "created_at",
        "label": "ë“±ë¡ì¼",
        "type": "date",
        "sortable": true,
        "width": "120px"
      }
    ],
    "pagination": {
      "enabled": true,
      "pageSize": 20,
      "pageSizeOptions": [10, 20, 50, 100]
    },
    "filter": {
      "enabled": true,
      "fields": [
        {
          "id": "grade",
          "type": "select",
          "options": [
            { "value": "1", "label": "1í•™ë…„" },
            { "value": "2", "label": "2í•™ë…„" }
          ]
        },
        {
          "id": "status",
          "type": "select",
          "options": [
            { "value": "present", "label": "ì¬ì›" },
            { "value": "absent", "label": "íœ´ì›" }
          ]
        },
        {
          "id": "search",
          "type": "text",
          "placeholder": "ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰"
        }
      ]
    },
    "summary": {
      "enabled": true,
      "rows": [
        {
          "label": "ì „ì²´ í•™ìƒ ìˆ˜",
          "value": "count(*)",
          "position": "bottom"
        }
      ]
    }
  }
}
```

**Table Actions ì •ì˜:**

```json
{
  "actions": {
    "row": [
      {
        "id": "view",
        "label": "ë³´ê¸°",
        "action_url": "/students/{id}",
        "icon": "string (ì„ íƒ)"
      },
      {
        "id": "edit",
        "label": "ìˆ˜ì •",
        "action_url": "/students/{id}/edit",
        "icon": "string (ì„ íƒ)"
      },
      {
        "id": "menu",
        "label": "ë”ë³´ê¸°",
        "menu_items": [
          { "id": "delete", "label": "ì‚­ì œ", "action": "delete" },
          { "id": "export", "label": "ë‚´ë³´ë‚´ê¸°", "action": "export" }
        ]
      }
    ],
    "bulk": [
      {
        "id": "export",
        "label": "ì—‘ì…€ ë‹¤ìš´ë¡œë“œ",
        "action": "export_excel"
      },
      {
        "id": "send_message",
        "label": "ê³µì§€ ë³´ë‚´ê¸°",
        "action": "send_notification"
      },
      {
        "id": "bulk_update",
        "label": "ì¼ê´„ ìˆ˜ì •",
        "action": "bulk_edit"
      }
    ],
    "inline_edit": {
      "enabled": true,
      "editable_fields": ["name", "grade"],
      "save_action": "update_student",
      "save_method": "edge_function"  // edge_function | supabase_rpc | direct_update
    }
  }
}
```

**Inline Edit ì €ì¥ ë°©ì‹:**

SDUI Tableì˜ inline_edit ê¸°ëŠ¥ì€ ì•„ë˜ ë°©ì‹ ì¤‘ í•˜ë‚˜ë¡œ ì €ì¥ëœë‹¤:

```typescript
inline_edit_save_method = {
  // ë°©ë²• 1: Edge Function í˜¸ì¶œ (ê¶Œì¥)
  edge_function: {
    endpoint: '/api/students/{id}',
    method: 'PATCH',
    validation: 'server_side'
  },

  // ë°©ë²• 2: Supabase RPC í˜¸ì¶œ
  supabase_rpc: {
    function_name: 'update_student',
    params: { id, field, value }
  },

  // ë°©ë²• 3: Direct Table Update (RLS ì •ì±… í†µê³¼)
  direct_update: {
    table: 'students',
    where: { id },
    update: { field: value }
  }
}
```

**âš ï¸ C5: SDUI Inline Edit Direct Update ê·œì¹™ í†µì¼ (í™•ì •):**

ë¬¸ì„œ ë‚´ ì„œë¡œ ë‹¤ë¥¸ ì„¤ëª…ì´ ìˆì—ˆìœ¼ë‚˜, ì•„ë˜ í™•ì •ë³¸ìœ¼ë¡œ í†µì¼:

**Direct Update í—ˆìš© ë²”ìœ„ ì œí•œ (ê³µì‹ ê·œì¹™):**

Direct UpdateëŠ” RLS ì •ì±… ì¶©ëŒ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ ë§¤ìš° ì œí•œëœ í…Œì´ë¸”/í•„ë“œì—ì„œë§Œ í—ˆìš©í•œë‹¤:

```typescript
// âš ï¸ ê³µì‹ Direct Update í—ˆìš©/ê¸ˆì§€ ëª©ë¡ (v3.2 í™•ì •)
direct_update_allowed = {
  // Default Policy: Direct UpdateëŠ” í…Œë„ŒíŠ¸ ìƒì„± ì‹œ ë¹„í™œì„±ìœ¼ë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥
  default_policy: {
    direct_update_enabled: false,  // Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ falseë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥
    allow_list_only: true  // Allow-listì— í¬í•¨ëœ í…Œì´ë¸”ë§Œ enable
  },

  // í—ˆìš© í…Œì´ë¸” ëª©ë¡ (Allow-list)
  allowed_tables: [
    'students',  // ë‹¨ìˆœ í•„ë“œë§Œ (name, grade, status)
    'classes',   // ë‹¨ìˆœ í•„ë“œë§Œ (name, color, capacity)
    'contacts'   // ë‹¨ìˆœ í•„ë“œë§Œ (phone, email, address)
  ],

  // ê¸ˆì§€ í…Œì´ë¸” (Forbidden-list, ì ˆëŒ€ Direct Update ë¶ˆê°€)
  forbidden_tables: [
    'invoices',         // ê²°ì œ/ìˆ˜ë‚© ê´€ë ¨ â†’ Edge Function í•„ìˆ˜
    'payments',         // ê²°ì œ ë‚´ì—­ â†’ Edge Function í•„ìˆ˜
    'attendance_logs',  // ì¶œê²° ê¸°ë¡ â†’ Edge Function í•„ìˆ˜
    'ai_insights',     // AI ì¸ì‚¬ì´íŠ¸ â†’ Edge Function í•„ìˆ˜
    'notifications',    // ì•Œë¦¼ ë°œì†¡ â†’ Edge Function í•„ìˆ˜
    'ai_feedback_logs', // AI í”¼ë“œë°± ë¡œê·¸ â†’ Edge Function í•„ìˆ˜
    'automation_undo_logs' // ìë™í™” Undo ë¡œê·¸ â†’ Edge Function í•„ìˆ˜
  ],

  // í—ˆìš© í•„ë“œ ì œí•œ (í…Œì´ë¸”ë³„ ì„¸ë¶€ í•„ë“œ ì œí•œ)
  allowed_fields: {
    students: ['name', 'grade', 'status'],
    classes: ['name', 'color', 'capacity'],
    contacts: ['phone', 'email', 'address']
  },

  // ê¸ˆì§€ í•„ë“œ (í—ˆìš© í…Œì´ë¸” ë‚´ì—ì„œë„ ê¸ˆì§€)
  forbidden_fields: {
    students: ['tenant_id', 'industry_type', 'created_at', 'updated_at'],
    classes: ['tenant_id', 'industry_type', 'created_at', 'updated_at'],
    contacts: ['tenant_id', 'created_at', 'updated_at']
  }
}
```

**ì €ì¥ ë°©ì‹ ì„ íƒ ê·œì¹™ (í™•ì •):**
- ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ í•„ìš”í•œ ê²½ìš°: Edge Function (ê¶Œì¥)
- ë‹¨ìˆœ í•„ë“œ ì—…ë°ì´íŠ¸: Supabase RPC (ê¶Œì¥)
- ì‹¤ì‹œê°„ì„±ì´ ì¤‘ìš”í•œ ê²½ìš°: Direct Update (í—ˆìš© í…Œì´ë¸”/í•„ë“œë§Œ, RLS ì •ì±… í•„ìˆ˜, Default Policyì— ë”°ë¼ ë¹„í™œì„±ìœ¼ë¡œ ì„¤ì •)
- ì¶œê²°/ì²­êµ¬/AI ê´€ë ¨ í…Œì´ë¸”: Direct Update ì ˆëŒ€ ê¸ˆì§€, Edge Function í•„ìˆ˜

**âš ï¸ Implementation ê°€ì´ë“œ:**
- Direct UpdateëŠ” Default Policyì— ë”°ë¼ ë¹„í™œì„±ìœ¼ë¡œ ì„¤ì •ë¨
- Allow-listì— í¬í•¨ëœ í…Œì´ë¸”ë§Œ enable
- RLS ì •ì±…ì´ ëª¨ë“  í•„ë“œì— ì ìš©ë˜ëŠ”ì§€ í™•ì¸ í•„ìˆ˜
- ê¶Œí•œ ê²€ì¦ì´ ì„œë²„ ì¸¡ì—ì„œ ìˆ˜í–‰ë˜ëŠ”ì§€ í™•ì¸ í•„ìˆ˜
- Audit Logê°€ ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ê¸°ë¡í•˜ëŠ”ì§€ í™•ì¸ í•„ìˆ˜

**SDUI Inline Edit ì €ì¥ ì‹¤íŒ¨ ì‹œ Rollback ì²˜ë¦¬:**

ì €ì¥ ì‹¤íŒ¨ ì‹œ UI rollback ê·œì¹™:

```typescript
inline_edit_rollback = {
  // ì €ì¥ ì‹¤íŒ¨ ì‹œ, SDUI ì—”ì§„ì€ í¸ì§‘ ì „ ìƒíƒœ(prev_state)ë¥¼ ì¦‰ì‹œ ë³µêµ¬
  on_save_failure: {
    action: 'rollback_to_prev_state',
    restore_fields: 'all_edited_fields',
    show_error_message: true
  },

  // prev_stateëŠ” í¸ì§‘ ì‹œì‘ ì‹œì ì— ìë™ ì €ì¥
  prev_state_storage: {
    on_edit_start: 'save_prev_state',
    storage_location: 'component_state'
  }
}
```

**Rollback ì²˜ë¦¬ ê·œì¹™:**
- í¸ì§‘ ì‹œì‘ ì‹œì ì— í¸ì§‘ ì „ ìƒíƒœ(prev_state) ìë™ ì €ì¥
- ì €ì¥ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ prev_stateë¡œ ë³µêµ¬
- ì‚¬ìš©ìì—ê²Œ ì €ì¥ ì‹¤íŒ¨ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
- ë³µêµ¬ëœ í•„ë“œëŠ” í¸ì§‘ ì „ ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, ì„œë²„ ì˜¤ë¥˜, ê²€ì¦ ì‹¤íŒ¨ ë“± ëª¨ë“  ì‹¤íŒ¨ ì¼€ì´ìŠ¤ì— ì ìš©
```

**Row Action:**
- ê° í–‰ì— ëŒ€í•œ ê°œë³„ ì•¡ì…˜ ë²„íŠ¼
- ë³´ê¸°, ìˆ˜ì •, ì‚­ì œ, ë©”ë‰´ ë“±

**Bulk Action:**
- ë‹¤ì¤‘ ì„ íƒ ì‹œ ì¼ê´„ ì²˜ë¦¬ ì•¡ì…˜
- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ, ê³µì§€ ë³´ë‚´ê¸°, ì¼ê´„ ìˆ˜ì • ë“±

**Inline Edit:**
- í…Œì´ë¸” ë‚´ ì§ì ‘ ìˆ˜ì • ê¸°ëŠ¥
- í¸ì§‘ ê°€ëŠ¥í•œ í•„ë“œ ì§€ì •
- ì €ì¥ ì•¡ì…˜ ì •ì˜

### 5.5 Detail Schema

**âš ï¸ B5: SDUI Detail Schema ì˜ˆì‹œ ì¶”ê°€:**

**Detail Props:**
- fields: KeyValueField[] (í•„ìˆ˜)
- layout: 'vertical' | 'horizontal' | 'grid' (ì„ íƒ)

**Detail SDUI Schema ì˜ˆì‹œ:**

```json
{
  "version": "1.0.0",
  "entity": "student",
  "type": "detail",
  "detail": {
    "layout": "vertical",
    "sections": [
      {
        "title": "ê¸°ë³¸ ì •ë³´",
        "fields": [
          {
            "id": "name",
            "label": "ì´ë¦„",
            "type": "text",
            "value": "{student.name}"
          },
          {
            "id": "grade",
            "label": "í•™ë…„",
            "type": "number",
            "value": "{student.grade}"
          },
          {
            "id": "class_name",
            "label": "ë°˜",
            "type": "text",
            "value": "{student.class_name}"
          },
          {
            "id": "status",
            "label": "ìƒíƒœ",
            "type": "badge",
            "value": "{student.status}",
            "badge_config": {
              "present": { "color": "green", "label": "ì¬ì›" },
              "absent": { "color": "red", "label": "íœ´ì›" }
            }
          }
        ]
      },
      {
        "title": "ì—°ë½ì²˜ ì •ë³´",
        "fields": [
          {
            "id": "parent_name",
            "label": "í•™ë¶€ëª¨ëª…",
            "type": "text",
            "value": "{student.parent_name}"
          },
          {
            "id": "phone",
            "label": "ì—°ë½ì²˜",
            "type": "phone",
            "value": "{student.phone}"
          },
          {
            "id": "email",
            "label": "ì´ë©”ì¼",
            "type": "email",
            "value": "{student.email}"
          }
        ]
      }
    ],
    "actions": [
      {
        "id": "edit",
        "label": "ìˆ˜ì •",
        "action_url": "/students/{id}/edit",
        "type": "button"
      },
      {
        "id": "delete",
        "label": "ì‚­ì œ",
        "action": "delete",
        "type": "button",
        "variant": "danger"
      }
    ]
  }
}
```

### 5.6 Widget Schema

**Widget Props:**
- type: 'card' | 'metric' | 'chiplist' (í•„ìˆ˜)
- data: any (í•„ìˆ˜)
- config: WidgetConfig (ì„ íƒ)

### 5.7 Validation Rule

**SDUI Validation & ConditionRule ê·œì¹™**

Schema Engine v2.1ì— ë”°ë¥¸ Validation ë° ConditionRule ëª…ì„¸:

**Validation ê·œê²©:**

**required:**
- í•„ìˆ˜ í•„ë“œ ê²€ì¦
- ì˜ˆ: { validation: { required: true } }

**min/max:**
- ìˆ«ì/ë¬¸ìì—´ ê¸¸ì´ ì œí•œ
- ì˜ˆ: { validation: { min: 1, max: 100 } }

**regex:**
- ì •ê·œì‹ íŒ¨í„´ ê²€ì¦
- ì˜ˆ: { validation: { regex: "^[0-9]{3}-[0-9]{4}-[0-9]{4}$" } }

**custom (Edge Function í˜¸ì¶œ):**
- ì»¤ìŠ¤í…€ ê²€ì¦ ë¡œì§
- ì˜ˆ: { validation: { custom: "validate-student-id" } }
- Edge Functionì—ì„œ ê²€ì¦ ìˆ˜í–‰ í›„ ê²°ê³¼ ë°˜í™˜

### 5.8 ConditionRule

**ConditionRule ê·œê²©:**

**field == value:**
- í•„ë“œ ê°’ ì¼ì¹˜ ì¡°ê±´
- ì˜ˆ: { condition: { field: "student_type", op: "==", value: "regular" } }

**field in [...]:**
- í•„ë“œ ê°’ì´ ë°°ì—´ ë‚´ í¬í•¨ ì—¬ë¶€
- ì˜ˆ: { condition: { field: "grade", op: "in", value: ["1", "2", "3"] } }

**visibility (show/hide):**
- ì¡°ê±´ì— ë”°ë¥¸ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
- ì˜ˆ: { condition: { field: "has_parent", op: "==", value: true }, action: "show" }

**readonly (true/false):**
- ì¡°ê±´ì— ë”°ë¥¸ í•„ë“œ ì½ê¸° ì „ìš© ì„¤ì •
- ì˜ˆ: { condition: { field: "status", op: "==", value: "graduated" }, action: "readonly" }

**default_value (ë™ì ):**
- ì¡°ê±´ì— ë”°ë¥¸ ê¸°ë³¸ê°’ ë™ì  ì„¤ì •
- ì˜ˆ: { condition: { field: "billing_mode", op: "==", value: "prepaid" }, default_value: 0 }

ì´ ê·œì¹™ì´ ì—†ìœ¼ë©´ SDUI í¼ ìƒì„± ì‹œ í…Œë„ŒíŠ¸/ì—…ì¢…ë³„ ë™ì‘ì´ ë¶ˆì•ˆì •í•´ì§„ë‹¤.

### 5.9 Field-Level Event

**SDUI Form Schemaì˜ Field-Level Event**

Field ë³€ê²½ ì‹œ ë‹¤ë¥¸ Field ê°’ ìë™ ë³€ê²½ì„ ìœ„í•œ Form-Level Event ê·œì¹™:

**Field Event Rule:**

```json
{
  "events": [
    {
      "trigger": "billing_mode",
      "action": "set_default",
      "target": "amount",
      "value_map": {
        "prepaid": 300000,
        "postpaid": 250000
      }
    },
    {
      "trigger": "student_type",
      "action": "set_default",
      "target": "enrollment_fee",
      "value_map": {
        "regular": 0,
        "premium": 50000
      }
    }
  ]
}
```

**Event Action íƒ€ì…:**
- set_default: ê¸°ë³¸ê°’ ì„¤ì •
- show/hide: í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
- enable/disable: í•„ë“œ í™œì„±í™”/ë¹„í™œì„±í™”
- set_options: ì˜µì…˜ ëª©ë¡ ë™ì  ë³€ê²½

**Event Trigger ì¡°ê±´:**
- field ê°’ ë³€ê²½ ì‹œ
- field ê°’ì´ íŠ¹ì • ì¡°ê±´ì¼ ë•Œ
- ë³µìˆ˜ í•„ë“œ ì¡°ê±´ (AND/OR)

**âš ï¸ ë³µí•© ì¡°ê±´(AND/OR) ì˜ˆì‹œ:**

```json
{
  "events": [
    {
      "trigger": {
        "logic": "AND",
        "conditions": [
          { "field": "student_type", "op": "==", "value": "regular" },
          { "field": "grade", "op": "in", "value": ["1", "2", "3"] }
        ]
      },
      "action": "set_default",
      "target": "enrollment_fee",
      "value": 0
    },
    {
      "trigger": {
        "logic": "OR",
        "conditions": [
          { "field": "billing_mode", "op": "==", "value": "prepaid" },
          { "field": "payment_method", "op": "==", "value": "card" }
        ]
      },
      "action": "show",
      "target": "discount_field"
    }
  ]
}
```

**ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤:**
- billing_mode ì„ íƒ â†’ ê¸ˆì•¡/íšŒì°¨ ìë™ ì±„ì›€
- student_type ë³€ê²½ â†’ íŠ¹ì • í•„ë“œ default ìë™ ì„¤ì •
- grade ì„ íƒ â†’ í•´ë‹¹ í•™ë…„ ë°˜ ëª©ë¡ë§Œ í‘œì‹œ

ì´ ê·œì¹™ì´ ì—†ìœ¼ë©´ SDUI Formì˜ ë™ì  ìƒí˜¸ì‘ìš©ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

### 5.10 Industry Override â†’ Tenant Override ê·œì¹™

**SDUI ìš°ì„ ìˆœìœ„ ê·œì¹™:**

1. tenant override (í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆ)
2. industry override (ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ)
3. core default (ê³µí†µ ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ)

### 5.11 Custom Widget ë“±ë¡ ê·œì¹™

Custom Widgetì€ SDUI ë‚´ì—ì„œ ë™ì  ë¡œë”© ê°€ëŠ¥í•˜ë‹¤.

## 6. Event Engine (Automation & Workflow Engine)

### 6.1 Event Source 4ì¢…

(ë³¸ ë¬¸ì„œ 1.5 ì„¹ì…˜ ì°¸ì¡°)

### 6.2 Event Priority Rule

**Event Priority Rule (ì´ë²¤íŠ¸ ìš°ì„ ìˆœìœ„ ê·œì¹™)**

ì—¬ëŸ¬ ì´ë²¤íŠ¸ê°€ ë™ì‹œì— ë°œìƒí•  ê²½ìš° ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì²˜ë¦¬í•œë‹¤.

**ìš°ì„ ìˆœìœ„ (ë†’ì€ ìˆœì„œ):**
1. ê²°ì œ(Webhook) - ìµœìš°ì„  ì²˜ë¦¬
2. ì¶œê²°(Behavior) - ì¦‰ì‹œ ì²˜ë¦¬
3. AI ìœ„í—˜ ê°ì§€(Pattern) - ë¹ ë¥¸ ì²˜ë¦¬
4. ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸(Time-based) - ì¼ë°˜ ì²˜ë¦¬
5. ë©”ì‹œì§€ ìë™ ë°œì†¡(Behavior/Pattern) - ì¼ë°˜ ì²˜ë¦¬

**ì¶©ëŒ ì‹œ ì²˜ë¦¬ ê·œì¹™:**
- ë†’ì€ ìš°ì„ ìˆœìœ„ ì´ë²¤íŠ¸ë§Œ ì¦‰ì‹œ ì‹¤í–‰
- ë‚®ì€ ìš°ì„ ìˆœìœ„ ì´ë²¤íŠ¸ëŠ” 5~30ì´ˆ ì§€ì—° íì— ë„£ê³  ìˆœì°¨ ì²˜ë¦¬
- UIì—ëŠ” "ìë™ ì²˜ë¦¬ ì¤‘" ì•Œë¦¼ë§Œ í‘œì‹œ
- ë™ì¼ ìš°ì„ ìˆœìœ„ ì´ë²¤íŠ¸ëŠ” ë°œìƒ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬

**ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤:**
- 07:00 AI ë¸Œë¦¬í•‘ ìƒì„± ì¤‘ì— ì¶œê²° ì´ë²¤íŠ¸ ë°œìƒ
  â†’ ì¶œê²° ì´ë²¤íŠ¸ ì¦‰ì‹œ ì²˜ë¦¬, AI ë¸Œë¦¬í•‘ì€ 30ì´ˆ ì§€ì—° í›„ ì²˜ë¦¬
- ì›¹í›… â†’ ë¯¸ë‚© ìë™ ì•Œë¦¼ â†’ AI ìœ„í—˜ ë¶„ì„ì´ ì—°ì†ì ìœ¼ë¡œ ì¤‘ì²©
  â†’ ì›¹í›… ì¦‰ì‹œ ì²˜ë¦¬, ë¯¸ë‚© ì•Œë¦¼ 5ì´ˆ ì§€ì—°, AI ë¶„ì„ 10ì´ˆ ì§€ì—°

### 6.3 Event Queue & Retry

**Event Queue êµ¬ì¡°:**

- ëª¨ë“  ì´ë²¤íŠ¸ëŠ” `event_logs` + ë‚´ë¶€ Queueì— ì ì¬ í›„ ë¹„ë™ê¸° ì²˜ë¦¬
  - âš ï¸ ì°¸ê³ : `event_logs.event_type`ì€ ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ `event_type`ê³¼ ë‹¤ë¥¸ ë„ë©”ì¸ ê°’ì…ë‹ˆë‹¤. `event_logs.event_type`ì€ ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ íƒ€ì…(ì˜ˆ: `payment_webhook`, `attendance.check_in`)ì´ë©°, ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ `event_type`ì€ ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ í‚¤(ì˜ˆ: `overdue_outstanding_over_limit`, `payment_due_reminder`)ì…ë‹ˆë‹¤.
- ìš°ì„ ìˆœìœ„ í(Priority Queue) ì‚¬ìš©: ê²°ì œ > ì¶œê²° > AI > ëŒ€ì‹œë³´ë“œ > ì¼ë°˜ ë©”ì‹œì§€
- RetryëŠ” 3íšŒ, Exponential Backoff (1ì´ˆ â†’ 5ì´ˆ â†’ 30ì´ˆ)
- ì¬ì‹œë„ ì‹¤íŒ¨ ì´ë²¤íŠ¸ëŠ” DLQë¡œ ì´ë™ (ë³¸ ë¬¸ì„œ 6.5 ì„¹ì…˜ ì°¸ì¡°)

### 6.4 Event Reliability Spec (ì‹ ë¢°ì„± ë³´ì¥ ê·œì¹™)

ëŒ€ê·œëª¨ SaaS ìš´ì˜ì„ ìœ„í•œ ì´ë²¤íŠ¸ ì‹ ë¢°ì„± ë³´ì¥ ì •ì±…:

**ì¬ì‹œë„ ì •ì±…:**
- ëª¨ë“  ì´ë²¤íŠ¸ëŠ” ìµœëŒ€ 3íšŒ ì¬ì‹œë„
- ì¬ì‹œë„ ê°„ê²©: Exponential Backoff (1ì´ˆ â†’ 5ì´ˆ â†’ 30ì´ˆ)
- Webhook ì´ë²¤íŠ¸ëŠ” ì¬ì‹œë„ + ë©±ë“±ì„± í‚¤(idempotency_key) í™•ì¸

### 6.5 Dead-Letter Queue

**Dead Letter Queue (DLQ):**
- ì‹¤íŒ¨ ì‹œ DLQì— ì €ì¥ â†’ ì¬ì²˜ë¦¬ í˜ì´ì§€ ì œê³µ
- AI ë¶„ì„ ì‹¤íŒ¨, ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨ ë“± ì˜êµ¬ ì‹¤íŒ¨ ì´ë²¤íŠ¸ ì €ì¥
- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ DLQ ì´ë²¤íŠ¸ ì¡°íšŒ ë° ìˆ˜ë™ ì¬ì²˜ë¦¬ ê°€ëŠ¥

### 6.6 Batch Flush

**Batch Flush ì •ì±…:**
- ì¶œê²°Â·ë©”ì‹œì§€ ì´ë²¤íŠ¸ëŠ” Batch Flush(1ì´ˆ ë‹¨ìœ„ ë¬¶ìŒ ì²˜ë¦¬)
- ë‹¨ì¼ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë°©ì‹ì€ ì„±ëŠ¥ ë‚­ë¹„ ë°©ì§€
- ë™ì¼ íƒ€ì… ì´ë²¤íŠ¸ëŠ” 1ì´ˆ ë‚´ ë¬¶ì–´ì„œ ì¼ê´„ ì²˜ë¦¬

### 6.7 ë©±ë“±ì„±(idempotency_key) êµ¬ì¡°

**Event Engine ë©±ë“±ì„± ê·œì¹™ì˜ DB Level ì •ì˜**

ëª¨ë“  ì´ë²¤íŠ¸ëŠ” ë©±ë“±ì„±(idempotency_key)ì„ ë³´ì¥í•´ì•¼ í•œë‹¤.

âš ï¸ ì°¸ê³ : automation_actions í…Œì´ë¸”ì˜ request_idëŠ” ë³„ë„ ê·œì¹™ì„ ë”°ë¦…ë‹ˆë‹¤ (ì±—ë´‡.md 6.3.1 ì°¸ì¡°).
- request_id í˜•ì‹: `{task_id}:{action}:{attempt_window}` (5ë¶„ ë²„í‚·)
- automation_actions í…Œì´ë¸”ì—ì„œ request_id ìœ ë‹ˆí¬ ì œì•½ìœ¼ë¡œ ë©±ë“± ê°•ì œ
- automation_actions.request_idì™€ execution_audit_runs.reference.request_idëŠ” ë™ì¼í•œ í˜•ì‹ì„ ì‚¬ìš© (ì•¡í‹°ë¹„í‹°.md 7.2 ì°¸ì¡°)
- idempotency_keyëŠ” webhook/event_logsìš©, request_idëŠ” automation_actions ì „ìš©
- âš ï¸ ì°¸ê³ : automation_actions(ì›Œí¬í”Œë¡œìš° ì´ë²¤íŠ¸)ì™€ execution_audit_runs(ì‹¤í–‰ ê²°ê³¼)ì˜ ê´€ê³„ëŠ” ì•¡í‹°ë¹„í‹°.md ì°¸ì¡°

**event_logs í…Œì´ë¸” êµ¬ì¡°:**

```sql
CREATE TABLE event_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  idempotency_key text UNIQUE NOT NULL,
  event_type text NOT NULL,
  tenant_id uuid NOT NULL,
  payload jsonb NOT NULL,
  status text NOT NULL DEFAULT 'pending',
  created_at timestamptz NOT NULL DEFAULT now(),
  processed_at timestamptz,
  retry_count integer DEFAULT 0,
  error_message text
);

CREATE UNIQUE INDEX idx_event_logs_idempotency
ON event_logs(idempotency_key);
```

**âš ï¸ C11: Billing Webhook ë©±ë“±ì„± ê·œì¹™ í†µì¼ (í™•ì •):**

ì‹¤ì œ PG Webhook ì„¤ê³„ì— ë”°ë¼ í•˜ë‚˜ì˜ ë°©ì‹ìœ¼ë¡œ í™•ì •:

```typescript
// âš ï¸ ê³µì‹ ë©±ë“±ì„± í‚¤ ìƒì„± ê·œì¹™ (v3.2 í™•ì •)
idempotency_key_generation = {
  // Webhook ë©±ë“±ì„± í‚¤ ìƒì„± (í†µì¼ ê·œì¹™)
  webhook: {
    // ê¸°ë³¸ ê·œì¹™: provider + webhook_id + payment_id (ë˜ëŠ” invoice_id)
    // timestampëŠ” webhook_idì— í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë‚˜, ë³„ë„ë¡œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
    standard: '{provider}_{webhook_id}_{payment_id}',

    // payment_idê°€ ì—†ëŠ” ê²½ìš° (ì˜ˆ: ì²­êµ¬ì„œ ìƒì„± webhook)
    fallback: '{provider}_{webhook_id}_{invoice_id}',

    // ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš° (ë“œë¬¸ ê²½ìš°)
    fallback2: '{provider}_{webhook_id}_{tenant_id}_{received_at}',

    // âš ï¸ timestampë¥¼ ë³„ë„ë¡œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
    // webhook_id ìì²´ê°€ Providerì—ì„œ ê³ ìœ ì„±ì„ ë³´ì¥í•˜ë¯€ë¡œ
    // payment_id ë˜ëŠ” invoice_idë§Œ ì¶”ê°€í•˜ë©´ ì¶©ë¶„
  },

  // Behavior Event ë©±ë“±ì„± í‚¤
  behavior_event: '{event_type}_{entity_id}_{timestamp}',

  // Pattern Event ë©±ë“±ì„± í‚¤
  pattern_event: '{pattern_type}_{tenant_id}_{detected_at}'
}
```

**ë©±ë“±ì„± í‚¤ ìƒì„± ê·œì¹™ (í™•ì •):**
- Webhook: `{provider}_{webhook_id}_{payment_id}` (ë˜ëŠ” `{invoice_id}`)
- Behavior Event: `{event_type}_{entity_id}_{timestamp}`
- Pattern Event: `{pattern_type}_{tenant_id}_{detected_at}`

**âš ï¸ ì´ì „ ë²„ì „ì˜ `{provider}_{webhook_id}_{timestamp}` ë°©ì‹ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ**

**ë©±ë“±ì„± ê²€ì¦:**
- ì´ë²¤íŠ¸ ì²˜ë¦¬ ì „ idempotency_keyë¡œ ì¤‘ë³µ í™•ì¸
- ì¤‘ë³µ ë°œê²¬ ì‹œ ê¸°ì¡´ ì´ë²¤íŠ¸ ê²°ê³¼ ë°˜í™˜
- ìƒˆë¡œìš´ ì´ë²¤íŠ¸ëŠ” event_logsì— ì €ì¥ í›„ ì²˜ë¦¬

**ì ìš© ë²”ìœ„:**
- Webhook(ì•Œë¦¼ë±…í¬): ê²°ì œ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
- Behavior Event(ì¶œê²°): ì¶œê²° ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
- Pattern Event(AI): AI ë¶„ì„ ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€

ë©±ë“±ì„±ì´ ì—†ìœ¼ë©´ ì¤‘ë³µ í­íƒ„ ì‹œìŠ¤í…œì´ ëœë‹¤.

### 6.8 Event Logs í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

(ë³¸ ë¬¸ì„œ 6.7 ì„¹ì…˜ ì°¸ì¡°)

### 6.9 Event â†’ AI â†’ Billing/Notification ì—°ë™

**ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ Role ì •ì˜:**
Time-based ì„œë²„ê°€ ì²­êµ¬ ìƒì„±, Webhook ì´ë²¤íŠ¸ ë“± ì‹œìŠ¤í…œì´ ì§ì ‘ ìƒì„±í•˜ëŠ” ì´ë²¤íŠ¸ëŠ” `system_role = 'system'`ìœ¼ë¡œ í‰ê°€ëœë‹¤.
ì´ `system_role`ì€ Event Engineì˜ Role ê²€ì¦ ì‹œ íŠ¹ì • ê¶Œí•œì„ ìš°íšŒí•˜ê±°ë‚˜, ì‹œìŠ¤í…œ ë‚´ë¶€ ë¡œì§ì— ë”°ë¼ íŠ¹ë³„ ì²˜ë¦¬ëœë‹¤.

**âš ï¸ C12: AI Feedback learning cycleê³¼ Event Engine ìŠ¤ì¼€ì¤„ í†µí•©:**

**Event Engine ìŠ¤ì¼€ì¤„ê³¼ AI Feedback í•™ìŠµ ìŠ¤ì¼€ì¤„ í†µí•© ê·œì¹™:**

```typescript
ai_feedback_event_schedule_alignment = {
  // Event Engine Time-based ìŠ¤ì¼€ì¤„
  event_engine_schedule: {
    '04:00': 'auto_billing_generation',  // ì„œë²„ê°€ ì²­êµ¬ ìƒì„±
    '07:00': 'ai_insight_generation',     // AI ì¸ì‚¬ì´íŠ¸ ìƒì„±
    '23:59': 'daily_statistics_update'    // ì¼ì¼ í†µê³„ ì—…ë°ì´íŠ¸
  },

  // AI Feedback í•™ìŠµ ìŠ¤ì¼€ì¤„
  ai_feedback_schedule: {
    '03:00': 'daily_fine_tuning_queue_refill',  // Fine-tuning í ì—…ë°ì´íŠ¸
    '04:00_sunday': 'weekly_model_retrain'      // ì£¼ê°„ ëª¨ë¸ ì¬í•™ìŠµ
  },

  // âš ï¸ ì¶©ëŒ ë°©ì§€ ê·œì¹™:
  conflict_prevention: {
    // 1. AI Feedback ì¬í•™ìŠµì€ ë‚®ì€ ìš°ì„ ìˆœìœ„ë¡œ ì²˜ë¦¬
    ai_feedback_priority: 'low',

    // 2. ì¶œê²°/ê²°ì œ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ AI Feedback ì‘ì—… ì¼ì‹œ ì¤‘ë‹¨
    interrupt_on_high_priority_event: true,

    // 3. ì›”ìš”ì¼ ëŒ€ëŸ‰ ì¶œê²°/ê²°ì œ ë°œìƒ ì‹œ AI Feedback ì§€ì—° ì²˜ë¦¬
    monday_high_volume_handling: {
      detect_high_volume: 'count(events) > 100 within 1 hour',
      action: 'delay_ai_feedback_processing',
      delay_duration: '30 minutes',
      resume_after: 'event_queue_normalized'
    },

    // 4. AI Insight ìƒì„±(07:00) ì „ì— ëª¨ë“  AI Feedback ì‘ì—… ì™„ë£Œ ë³´ì¥
    ensure_completion_before_insight: {
      deadline: '06:30',  // AI Insight ìƒì„± 30ë¶„ ì „
      action: 'force_complete_or_skip'
    }
  }
}
```

**âš ï¸ í•µì‹¬ ê°œì„ ì•ˆ 2: Event â†’ Notification â†’ AI â†’ UI ì¼ì›í™” íë¦„ë„**

**í†µí•© ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ (v3.2):**

```
[Event Source] â†’ [Event Engine] â†’ [AI Engine] â†’ [Notification Engine] â†’ [UI]
     |                |                |                  |                |
     |                |                |                  |                |
  ì¶œê²°/ê²°ì œ      Role ê²€ì¦         Risk ë¶„ì„         ì±„ë„ ë¼ìš°íŒ…      ê¶Œí•œ í•„í„°ë§
     |                |                |                  |                |
     |                |                |                  |                |
     v                v                v                  v                v
[Event Logs]   [Event Queue]   [AI Insights]    [Notification Logs]  [Dashboard]
```

**ìƒì„¸ íë¦„:**

**1) ì¶œê²° ì´ë²¤íŠ¸ íë¦„:**
```
attendance_created (by Teacher/Assistant)
  â†’ Event Engine (Role ê²€ì¦)
  â†’ AI Risk Detection (Trigger)
  â†’ AI Insight ìƒì„± (Result Visibility: Teacher=visible, Assistant=hidden)
  â†’ Notification (ì¶œê²° ì•Œë¦¼, Roleì— ë”°ë¼ ë°œì†¡)
  â†’ UI (ê¶Œí•œì— ë”°ë¼ ì¹´ë“œ í‘œì‹œ/ìˆ¨ê¹€)
```

**2) ê²°ì œ Webhook íë¦„:**
```
payment_webhook (by System)
  â†’ Event Engine (system_role, bypass role check)
  â†’ Billing Engine (invoice/payment ì—…ë°ì´íŠ¸)
  â†’ AI Insight ì—…ë°ì´íŠ¸ (ë¯¸ë‚© í•´ì†Œ ì¹´ë“œ ì œê±°)
  â†’ Notification (ê²°ì œ ì™„ë£Œ ì•Œë¦¼, ë¯¸ë‚© ì•Œë¦¼ ì·¨ì†Œ)
  â†’ UI (Billing Home ì¹´ë“œ ì—…ë°ì´íŠ¸)
```

**3) ìƒë‹´ì¼ì§€ ì €ì¥ íë¦„:**
```
counseling_note_saved (by Teacher)
  â†’ Event Engine (Role ê²€ì¦: Teacher)
  â†’ AI Summary Generation (Trigger)
  â†’ AI Insight ìƒì„± (Result Visibility: Teacher=visible)
  â†’ Notification (ì„ íƒì , ìƒë‹´ ìš”ì•½ ì™„ë£Œ ì•Œë¦¼)
  â†’ UI (TaskCard ì—…ë°ì´íŠ¸, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
```

**âš ï¸ C2: Event â†’ Notification â†’ AI íë¦„ Role ì œí•œ ì¶©ëŒ ì™„ì „ í•´ê²°:**

**Role â†’ Event â†’ Result â†’ UI ê¶Œí•œ ë§¤í•‘ í…Œì´ë¸” (ì™„ì „ ëª…ì„¸):**

| Event Source | Event Role | AI Trigger | AI Result Visibility | Notification | UI Visibility |
|-------------|-----------|-----------|---------------------|--------------|--------------|
| ì¶œê²° ìƒì„± (Assistant) | assistant | ai_risk_detection | assistant=hidden, teacher=visible, admin=visible | ì¶œê²° ì•Œë¦¼ (ë°œì†¡) | AssistantëŠ” AI ì¹´ë“œ ìˆ¨ê¹€ |
| ì¶œê²° ìƒì„± (Teacher) | teacher | ai_risk_detection | teacher=visible, admin=visible | ì¶œê²° ì•Œë¦¼ (ë°œì†¡) | TeacherëŠ” AI ì¹´ë“œ í‘œì‹œ |
| ìƒë‹´ì¼ì§€ ì €ì¥ (Teacher) | teacher | ai_summary | teacher=visible, admin=visible | ì„ íƒì  | TeacherëŠ” ìš”ì•½ í‘œì‹œ |
| ê²°ì œ Webhook (System) | system | ai_insight_update | all=visible | ê²°ì œ ì•Œë¦¼ (ë°œì†¡) | ëª¨ë“  Role í‘œì‹œ |
| ìë™ ì²­êµ¬ ìƒì„± (System) | system | billing_auto | admin=visible, sub_admin=visible | ì²­êµ¬ ì•Œë¦¼ (ë°œì†¡) | Admin/Sub Adminë§Œ í‘œì‹œ |

**Event ì—°ë™ íë¦„:**

**Payment Webhook â†’ Event â†’ Billing/Notification:**
- `payment_webhook` ìˆ˜ì‹  â†’ `event_logs`ì— `event_type='payment_webhook'` ê¸°ë¡
  - âš ï¸ ì°¸ê³ : `event_logs.event_type`ì€ ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ `event_type`ê³¼ ë‹¤ë¥¸ ë„ë©”ì¸ ê°’ì…ë‹ˆë‹¤. `event_logs.event_type`ì€ ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ íƒ€ì…(ì˜ˆ: `payment_webhook`, `attendance.check_in`)ì´ë©°, ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ `event_type`ì€ ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ í‚¤(ì˜ˆ: `overdue_outstanding_over_limit`, `payment_due_reminder`)ì…ë‹ˆë‹¤.
- Event Engineì´ ì´ë¥¼ ì²˜ë¦¬ (`system_role`ë¡œ í‰ê°€):
  1) `invoices` / `payments` ì—…ë°ì´íŠ¸
  2) ë¯¸ë‚© í•´ì†Œ ì‹œ ë¯¸ë‚© ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ (3.4.3 ê·œì¹™)
  3) í•„ìš”í•œ ê²½ìš° AI ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸ (ì˜ˆ: 'ë¯¸ë‚© í•´ì†Œ' ì¹´ë“œ ì œê±°)

**Attendance Event â†’ AI â†’ Notification:**
- `attendance_event` â†’ `ai_risk_detection` â†’ `notification`(ì¶œê²° ì•Œë¦¼/ì•ˆë¶€ ë¬¸êµ¬) ìˆœìœ¼ë¡œ ì—°ë™
- ì¶œê²° ì´ìƒ íŒ¨í„´ ê°ì§€ ì‹œ ì„œë²„ê°€ ìœ„í—˜ë„ ë¶„ì„ í›„ ì•Œë¦¼ ë°œì†¡ ê²°ì • (AI í˜¸ì¶œ í¬í•¨)
- **Roleì— ë”°ë¼ AI ê²°ê³¼ ê°€ì‹œì„± í•„í„°ë§ ì ìš©**

ì´ë²¤íŠ¸ëŠ” AI ë¶„ì„, ì²­êµ¬ ìƒì„±, ì•Œë¦¼ ë°œì†¡ ë“±ê³¼ ì—°ë™ë˜ë©°, Role ê¸°ë°˜ ê¶Œí•œ ë§¤í•‘ì´ ì „ ê³¼ì •ì— ì ìš©ëœë‹¤.

### 6.10 Role-Restricted Automation

**Event Engine ê¶Œí•œ ê¸°ë°˜ ìë™í™” ì œí•œ**

Event Engine ë‚´ë¶€ì—ì„œ ì´ë²¤íŠ¸ ì‹¤í–‰ ìì²´ë¥¼ Roleë¡œ ì œí•œí•˜ëŠ” ê·œì¹™:

**ê¶Œí•œ ê¸°ë°˜ ì´ë²¤íŠ¸ í•„í„°ë§:**
- TeacherëŠ” ìë™ ë¯¸ë‚© ì•Œë¦¼ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŒ â†’ ì´ë²¤íŠ¸ ì œê±° ë˜ëŠ” ReadOnly
- AssistantëŠ” ì¶œê²° ì´ë²¤íŠ¸ë§Œ ìƒì„± ê°€ëŠ¥
- ì›ì¥(Admin)ë§Œ ì„œë²„ê°€ ì²­êµ¬ ìƒì„±, ë¯¸ë‚© ì•Œë¦¼ ì‹¤í–‰ ê°€ëŠ¥

**ì´ë²¤íŠ¸ ì‹¤í–‰ ì „ Role Check:**
- ëª¨ë“  ì´ë²¤íŠ¸ ì‹¤í–‰ ì „ ì‚¬ìš©ì Role í™•ì¸
- ê¶Œí•œ ì—†ëŠ” Roleì˜ ì´ë²¤íŠ¸ëŠ” ìë™ ì œê±° ë˜ëŠ” ë¬´ì‹œ
- ê¶Œí•œ ë¶€ì¡± ì‹œ ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ ì¹´ë“œ ìƒì„±

**ì´ë²¤íŠ¸ ìƒì„± ì‹œ Role ê²€ì¦:**
- ì¶œê²° ì´ë²¤íŠ¸: Teacher, Assistant ìƒì„± ê°€ëŠ¥
- ë¯¸ë‚© ì•Œë¦¼ ì´ë²¤íŠ¸: Adminë§Œ ìƒì„± ê°€ëŠ¥
- ìë™ ì²­êµ¬ ì´ë²¤íŠ¸: Adminë§Œ ìƒì„± ê°€ëŠ¥
- AI ë¶„ì„ ì´ë²¤íŠ¸: Admin, Sub Admin, Teacher ìƒì„± ê°€ëŠ¥

**âš ï¸ ì‹œìŠ¤í…œì´ ìƒì„±í•œ ì´ë²¤íŠ¸ì˜ Role ì •ì˜:**

Time-based ì„œë²„ê°€ ì²­êµ¬ ìƒì„±, Webhook ì´ë²¤íŠ¸ ë“± ì‹œìŠ¤í…œì´ ìƒì„±í•œ ì´ë²¤íŠ¸ëŠ” roleì´ ì—†ìœ¼ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ê·œì¹™ì´ í•„ìš”í•˜ë‹¤:

```typescript
system_event_role = {
  // ì‹œìŠ¤í…œì´ ìƒì„±í•œ ì´ë²¤íŠ¸ëŠ” 'system' roleë¡œ ì²˜ë¦¬
  system_role: 'system',

  // Super Adminì€ ëª¨ë“  ì´ë²¤íŠ¸ì— ì ‘ê·¼ ê°€ëŠ¥
  super_admin_role: 'super_admin',

  // Role ê²€ì¦ ê·œì¹™
  role_check_rule: {
    // system role ì´ë²¤íŠ¸ëŠ” role ê²€ì¦ ìš°íšŒ
    system_events: 'bypass_role_check',

    // ì‚¬ìš©ì ìƒì„± ì´ë²¤íŠ¸ëŠ” role ê²€ì¦ í•„ìˆ˜
    user_events: 'require_role_check'
  }
}
```

**ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ ì²˜ë¦¬:**
- Time-based ì„œë²„ê°€ ì²­êµ¬ ìƒì„±: `role='system'` â†’ role ê²€ì¦ ìš°íšŒ
- Webhook ì´ë²¤íŠ¸: `role='system'` â†’ role ê²€ì¦ ìš°íšŒ
- ì‚¬ìš©ì í–‰ë™ ê¸°ë°˜ ì´ë²¤íŠ¸: ì‚¬ìš©ì role ê²€ì¦ í•„ìˆ˜
- AI Pattern ì´ë²¤íŠ¸: `role='system'` â†’ role ê²€ì¦ ìš°íšŒ

**âš ï¸ Event Engine Role-Based Automationê³¼ Notification/AI Trigger ê·œì¹™ ì¶©ëŒ í•´ê²°:**

Teacher/Assistantì˜ í–‰ë™ ì œì•½ì´ Notification/AI Trigger ê·œì¹™ê³¼ ì¶©ëŒí•˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°:

```typescript
event_role_result_visibility_matrix = {
  // Event â†’ Result â†’ UI ê¶Œí•œ ë§¤í•‘ í…Œì´ë¸”
  mapping: {
    // Assistantê°€ ì¶œê²° ìƒì„± â†’ AI Risk Detection íŠ¸ë¦¬ê±°
    'attendance_created_by_assistant': {
      event_role: 'assistant',
      triggers: ['ai_risk_detection'],
      result_visibility: {
        // AssistantëŠ” Risk Insightë¥¼ ë³¼ ìˆ˜ ì—†ìŒ
        assistant: 'hidden',
        teacher: 'visible',
        admin: 'visible'
      },
      action: 'create_insight_but_hide_from_assistant'
    },

    // Teacherê°€ ìƒë‹´ì¼ì§€ ì €ì¥ â†’ AI Insight ìƒì„±
    'counseling_note_saved_by_teacher': {
      event_role: 'teacher',
      triggers: ['ai_insight_generation'],
      result_visibility: {
        teacher: 'visible',  // TeacherëŠ” ë³¼ ìˆ˜ ìˆìŒ
        assistant: 'hidden',
        admin: 'visible'
      },
      action: 'create_insight_with_teacher_visibility'
    }
  },

  // Role â†’ Event â†’ Result â†’ UI ê¶Œí•œ ì „ë¶€ ë§¤í•‘
  role_event_result_ui_mapping = {
    assistant: {
      can_create_events: ['attendance_created'],
      cannot_create_events: ['billing_auto_generate', 'unpaid_notification'],
      event_results: {
        attendance_created: {
          ai_risk_detection: 'hidden',  // AI ê²°ê³¼ëŠ” ìˆ¨ê¹€
          notification: 'hidden',       // ì•Œë¦¼ë„ ìˆ¨ê¹€
          statistics: 'visible'         // í†µê³„ëŠ” ë³¼ ìˆ˜ ìˆìŒ
        }
      }
    },
    teacher: {
      can_create_events: ['attendance_created', 'counseling_note_saved'],
      cannot_create_events: ['billing_auto_generate', 'unpaid_notification'],
      event_results: {
        attendance_created: {
          ai_risk_detection: 'visible',
          notification: 'visible',
          statistics: 'visible'
        },
        counseling_note_saved: {
          ai_insight: 'visible',
          ai_summary: 'visible'
        }
      }
    }
  }
}
```

**ì¶©ëŒ í•´ê²° ê·œì¹™:**
- AssistantëŠ” ì¶œê²° ìƒì„± ê°€ëŠ¥í•˜ì§€ë§Œ, AI Risk Detection ê²°ê³¼ëŠ” ë³¼ ìˆ˜ ì—†ìŒ
- TeacherëŠ” ìƒë‹´ì¼ì§€ ì €ì¥ ì‹œ AI Insight ìƒì„± ê°€ëŠ¥, ê²°ê³¼ë„ ë³¼ ìˆ˜ ìˆìŒ
- Event â†’ Result â†’ UI ê¶Œí•œì´ ì „ë¶€ ë§¤í•‘ë˜ì–´ ìˆì–´ ê¶Œí•œ ì¶©ëŒ ë°©ì§€
- ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ëŠ” role ê²€ì¦ì„ ìš°íšŒí•˜ë˜, ì‹¤í–‰ ê²°ê³¼ëŠ” ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ì— ë”°ë¼ í•„í„°ë§

**Permission Matrixì™€ì˜ ì—°ë™:**
- Automation Permission Matrixì˜ ê¶Œí•œ ê·œì¹™ì„ Event Engineì—ì„œë„ ì ìš©
- UI ê´€ì ë¿ë§Œ ì•„ë‹ˆë¼ Event Engine ë‚´ë¶€ ë™ì‘ì—ë„ role-check ê·œì¹™ ì ìš©
- ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ëŠ” role ê²€ì¦ì„ ìš°íšŒí•˜ë˜, ì‹¤í–‰ ê²°ê³¼ëŠ” ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ì— ë”°ë¼ í•„í„°ë§

**Queue Overflow ì²˜ë¦¬:**
- Queue Overflow ì‹œ FIFO Drop ì˜µì…˜ ë˜ëŠ” Sticky Priority Queue ì ìš©
- ë‚®ì€ ìš°ì„ ìˆœìœ„ ì´ë²¤íŠ¸ëŠ” ìë™ Drop, ë†’ì€ ìš°ì„ ìˆœìœ„ëŠ” ìœ ì§€
- Overflow ë°œìƒ ì‹œ ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ ì¹´ë“œ ìƒì„±

**ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì²˜ë¦¬:**
- ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì‹œ Webhook ì²˜ë¦¬ ì¬ì‹œë„ ì •ì±… ì ìš©
- ì•Œë¦¼ë±…í¬ Webhook ì‹¤íŒ¨ â†’ ê²°ì œ ìƒíƒœ Sync ë³´ì¥ì„ ìœ„í•œ ì¬ì‹œë„
- ìµœëŒ€ 3íšŒ ì¬ì‹œë„ í›„ DLQì— ì €ì¥

**ì´ë²¤íŠ¸ ë“œë¦¬í”„íŠ¸ ë°©ì§€:**
- ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨ë¡œ ì¸í•œ ìë™í™” ë¶ˆì¼ì¹˜ ë°©ì§€
- ëª¨ë“  ì´ë²¤íŠ¸ëŠ” ì²˜ë¦¬ ìƒíƒœ ì¶”ì  (pending â†’ processing â†’ completed/failed)
- ì‹¤íŒ¨ ì´ë²¤íŠ¸ëŠ” ìë™ ì¬ì²˜ë¦¬ ë˜ëŠ” ê´€ë¦¬ì ì•Œë¦¼

## 7. ë°ì´í„° ëª¨ë¸/DB ì•„í‚¤í…ì²˜ (DB & Data Architecture)

### 7.1 Core Entity êµ¬ì¡°(persons, parties ë“±)

Core Platformì˜ ê³µí†µ ì—”í‹°í‹°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™•ì¥í•œë‹¤.

**Core Platform ê³µí†µ ì—”í‹°í‹°:**

- **tenants**: í…Œë„ŒíŠ¸(í•™ì›/ë§¤ì¥/ì¡°ì§) ê¸°ë³¸ ì •ë³´
- **tenant_settings**: í…Œë„ŒíŠ¸ë³„ JSON ì„¤ì • (attendance, location, notification, billing ë“±)
- **persons**: ê°œì¸ ì •ë³´ (í•™ìƒ, í•™ë¶€ëª¨, êµì‚¬ ë“±)
- **parties**: ì¡°ì§/ë‹¨ì²´ ì •ë³´ (í•™ì› ë³¸ì›/ë¶„ì›, ë²•ì¸ ë“±)
- **contacts**: ì—°ë½ì²˜ ì •ë³´
- **addresses**: ì£¼ì†Œ ì •ë³´

**âš ï¸ tenant_settings JSON êµ¬ì¡° í†µí•© ì›ì¹™:**

ë¬¸ì„œ ì „ë°˜ì—ì„œ ì‚¬ìš©í•˜ëŠ” `attendance.*`, `location.*` ë“± ê²½ë¡œëŠ” ëª¨ë‘ tenant_settings(key='config').value(JSONB) ë‚´ë¶€ ê²½ë¡œì´ë‹¤. ì´ êµ¬ì¡°ëŠ” Schema ì„¤ê³„ ì‹œ ë‹¨ì¼ ì†ŒìŠ¤ë¡œ ê´€ë¦¬ëœë‹¤.

**tenant_settings KV êµ¬ì¡°ì˜ value(JSONB) ìŠ¤í‚¤ë§ˆ v1 ê³µì‹ ì •ì˜:**

âš ï¸ ì¤‘ìš”: tenant_settingsëŠ” KV êµ¬ì¡°ì´ë©°, ëª¨ë“  ì„¤ì •ì€ key='config'ì¸ ë‹¨ì¼ rowì˜ value(JSONB) í•„ë“œì— ì €ì¥ë©ë‹ˆë‹¤.
ì•„ë˜ëŠ” value(JSONB) ë‚´ë¶€ì˜ ë‹¨ì¼ JSON ìŠ¤í‚¤ë§ˆë¡œ í†µí•© ê´€ë¦¬ë©ë‹ˆë‹¤:

```json
{
  "attendance": {
    // 3.3.7 ì¶œê²° ì„¤ì • ì°¸ì¡°
    "late_after_minutes": 10,
    "absent_after_minutes": 60,
    "allow_duplicate_checkin": false,
    "time_format_24h": true,
    "default_mode": "pc",
    "qr_enabled": true,
    "qr_token_expiry_days": 90,  // âš ï¸ 3.3.7 ì¶œê²° ì„¤ì • ì°¸ì¡° (ì¤‘ë³µ ì œê±°)
    "qr_auth_fallback_enabled": true,
    "sms_auth_fallback_enabled": true,
    "qr_gps_enabled": false,
    "qr_gps_radius_meters": 150,
    "device_fingerprint_strict": true,
    "device_fingerprint_fallback_policy": "sms_auth",  // âš ï¸ 3.3.7 ì¶œê²° ì„¤ì • ì°¸ì¡° (ì¤‘ë³µ ì œê±°)
    "class_specific_late_rules": {}  // âš ï¸ 3.3.7 ì¶œê²° ì„¤ì • ì°¸ì¡° (ì¤‘ë³µ ì œê±°)
  },
  "location": {
    // 3.6.2 ì§€ì—­ì½”ë“œ ê·œì¹™ ì°¸ì¡°
    "si": "ì„œìš¸íŠ¹ë³„ì‹œ",
    "gu": "ê°•ë‚¨êµ¬",
    "dong": "ëŒ€ì¹˜ë™",
    "lat": 37.498,
    "lng": 127.061,
    "sido_code": "11",
    "sigungu_code": "11680",
    "location_code": "1168010100",
    "region_code": "SEOUL_SOUTH"  // ê¶Œì—­ ì½”ë“œ (ì„ íƒ)
  },
  "notification": {
    "default_channel": "kakao_at",  // kakao_at | sms
    "kakao_at_fallback_to_sms": true,
    "sms_fallback_delay_seconds": 10,
    "throttle_per_parent_per_day": 20,
    "throttle_per_parent_urgent": 5,
    "same_message_hash_cooldown_minutes": 10,
    "notification_queue_grace_period_seconds": 15  // Queue ì§€ì—° ê³ ë ¤ grace period
  },
  "billing": {
    "auto_billing_enabled": true,
    "auto_billing_time": "04:00",
    "early_payment_allowed": false,
    "early_payment_discount": null,
    "early_payment_period": null,
    "partial_payment_allowed": true,
    "monthly_closing_time": "last_day_of_month 23:59"
  },
  "ai": {
    // âš ï¸ ì¤‘ìš”: AI ê¸°ëŠ¥ ì˜¨ì˜¤í”„ëŠ” tenant_features(feature_key='ai').enabledë¥¼ SSOTë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    // tenant_settings.ai.enabledëŠ” ë ˆê±°ì‹œì´ë©°, ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    // SSOT: tenant_features(feature_key='ai').enabled (í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ ì°¸ì¡°)
    "risk_score_weights": {
      "attendance_weight": 0.4,
      "counseling_weight": 0.3,
      "payment_weight": 0.2,
      "performance_weight": 0.1
    },
    "daily_briefing_time": "07:00",
    "model_retraining_schedule": "weekly_sunday_04:00",
    "pii_masking_enabled": true  // ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ í™œì„±í™”
  },
  "regional_analytics": {
    "minimum_sample_size": 3,  // ì§€ë°©ì§€ì—­ ê³ ë ¤í•˜ì—¬ 5ì—ì„œ 3ìœ¼ë¡œ ì¡°ì •
    "fallback_sample_size": 3,
    "comparison_priority": ["dong", "sigungu", "sido", "region_zone"],
    "industry_filter_enabled": true
  }
}
```

**âš ï¸ ëª¨ë“  ì„¤ì •ì€ ì´ ë‹¨ì¼ JSON ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°, ë¬¸ì„œ ë‚´ ë‹¤ë¥¸ ìœ„ì¹˜ì—ì„œ ì–¸ê¸‰ë˜ëŠ” ì„¤ì •ë„ ì´ êµ¬ì¡°ì— ë§ì¶°ì•¼ í•œë‹¤.**

### 7.2 Industry Layer Entity í™•ì¥ ê·œì¹™

(ë³¸ ë¬¸ì„œ 2.6 ì„¹ì…˜ ì°¸ì¡°)

### 7.3 í…Œë„ŒíŠ¸ ê²©ë¦¬ êµ¬ì¡°(RLS)

(ë³¸ ë¬¸ì„œ 1.3 ì„¹ì…˜ ì°¸ì¡°)

### 7.4 Analytics Pipeline

(ë³¸ ë¬¸ì„œ 3.6.5 ì„¹ì…˜ ì°¸ì¡°)

**âš ï¸ 2-3: Event Engine ìŠ¤ì¼€ì¤„ vs Supabase Scheduled Functions:**

ìœ„ì—ì„œ ì •ì˜ëœ Event Engine ì‹œê°„ ê¸°ë°˜ ìŠ¤ì¼€ì¤„(04:00 ì„œë²„ê°€ ì²­êµ¬ ìƒì„±, 07:00 ì„œë²„ê°€ AI ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ ìƒì„±, 03:00 AI Feedback ë“±)ì€
Supabase Scheduled Functions(ë˜ëŠ” ë³„ë„ Cron Runner)ë¡œ êµ¬í˜„í•œë‹¤.

### 7.5 Materialized View ì„¤ê³„

**âš ï¸ 2-4: Materialized View Refresh ì „ëµ (Phase êµ¬ë¶„):**

**ìƒìš©í™” ë‹¨ê³„ (100~300 í…Œë„ŒíŠ¸):**
- attendance MV â†’ 5ë¶„ ì£¼ê¸° ê°±ì‹ 
- heatmap MV â†’ 10ë¶„~15ë¶„ ì£¼ê¸° ê°±ì‹ 
- regional MV â†’ 1ì¼ 1íšŒ ê°±ì‹  (00:30)

**ìƒìš©í™” ë‹¨ê³„ (ê³ ì„±ëŠ¥ ìŠ¤í™):**
- attendance MV â†’ 30ì´ˆ ì£¼ê¸° ê°±ì‹ 
- heatmap MV â†’ 5ë¶„ ì£¼ê¸° ê°±ì‹ 
- regional MV â†’ 1ì¼ 1íšŒ ê°±ì‹  (00:30) (ë™ì¼)

**Materialized View ì˜ˆì‹œ (âš ï¸ ì´ìŠˆ 3: MV vs í…Œì´ë¸” êµ¬ë¶„):**

| ì´ë¦„ | íƒ€ì… | ì„¤ëª… |
|---|---|---|
| daily_attendance_stats | TABLE (Staging) | ì¼ë³„ ì¶œê²° í†µê³„ |
| class_attendance_heatmap | TABLE (Staging) | ë°˜ë³„ ì¶œê²° íˆíŠ¸ë§µ |
| analytics.daily_store_metrics | TABLE | ë§¤ì¥ ë‹¨ìœ„ ì¼ë³„ KPI (ì •ë³¸) |
| analytics.daily_region_metrics | TABLE | ì§€ì—­ ë‹¨ìœ„ ì§‘ê³„ KPI (ì •ë³¸) |
| ai_insights | TABLE | AI ì¸ì‚¬ì´íŠ¸ ë…¼ë¦¬ í…Œì´ë¸” (í•„ìš” ì‹œ MVë¡œ íŒŒìƒ ê°€ëŠ¥) |

**âš ï¸ ì°¸ê³ :**
- ~~regional_metrics_daily~~, ~~tenant_kpi_daily~~ëŠ” êµ¬ë²„ì „/íê¸°ëœ ë„¤ì´ë°ì…ë‹ˆë‹¤.
- ì •ë³¸ í…Œì´ë¸”ì€ `analytics.daily_store_metrics`, `analytics.daily_region_metrics`ì…ë‹ˆë‹¤.
- ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ê²½ìš° MVë¥¼ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë‚˜, ì •ë³¸ í…Œì´ë¸”ì„ ìš°ì„  ì‚¬ìš©í•©ë‹ˆë‹¤.

**ì°¸ê³ :** Staging í…Œì´ë¸”ì€ ì›ì²œ ë°ì´í„°ì—ì„œ ì§‘ê³„ëœ ì¤‘ê°„ í…Œì´ë¸”ì´ë©°, Materialized ViewëŠ” Staging í…Œì´ë¸” ë˜ëŠ” Raw ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹ ë˜ëŠ” ìµœì¢… ë¶„ì„ ë·°ì´ë‹¤.

### 7.6 Backfill/Repair

(ë³¸ ë¬¸ì„œ 3.6.6 ì„¹ì…˜ ì°¸ì¡°)

### 7.7 Audit Log ì •ì±…

**Audit Log ì •ì±…:**

ëª¨ë“  ì¤‘ìš”í•œ ë°ì´í„° ë³€ê²½ì€ Audit Logì— ê¸°ë¡ë˜ì–´ì•¼ í•œë‹¤.

**Audit Log í…Œì´ë¸” ì˜ˆì‹œ:**
- automation_undo_logs: ìë™í™” Undo ì´ë ¥
- event_logs: ì´ë²¤íŠ¸ ì²˜ë¦¬ ì´ë ¥
- ai_feedback_logs: AI í”¼ë“œë°± ì´ë ¥

**Audit Log ê¸°ë¡ í•­ëª©:**
- ë³€ê²½ ì „ ìƒíƒœ (before_state)
- ë³€ê²½ í›„ ìƒíƒœ (after_state)
- ë³€ê²½ì (user_id)
- ë³€ê²½ ì‹œê°„ (created_at)
- ë³€ê²½ ì‚¬ìœ  (reason)

### 7.8 AI Feedback ì €ì¥ ëª¨ë¸

(ë³¸ ë¬¸ì„œ 3.7.7 ì„¹ì…˜ ì°¸ì¡°)

## 8. ê²°ì œ ì•„í‚¤í…ì²˜ (Payment Architecture)

### 8.1 ì•Œë¦¼ë±…í¬ API êµ¬ì¡°

**ì¤‘ìš”: ë””ì–´ìŒ¤ í”Œë«í¼ì€ ê²°ì œ ë¡œì§(ì´ì²´, ì¹´ë“œìŠ¹ì¸, ê°„í¸ê²°ì œ)ì„ ì§ì ‘ êµ¬í˜„í•˜ì§€ ì•ŠëŠ”ë‹¤.**

ëª¨ë“  ê²°ì œëŠ” ì•Œë¦¼ë±…í¬(íš¨ì„±FMS) ë° ê·¸ í•˜ìœ„ PGì‚¬ì—ì„œ ì²˜ë¦¬ë˜ë©°, ë””ì–´ìŒ¤ì€ API í˜¸ì¶œ + Webhook ìˆ˜ì‹  + DB ì—…ë°ì´íŠ¸ë§Œ ë‹´ë‹¹í•œë‹¤.

**ê²°ì œ ìˆ˜ë‹¨:**
- ê³„ì¢Œì´ì²´(ì•Œë¦¼ë±…í¬ ê°€ìƒê³„ì¢Œ/ê³„ì¢Œì´ì²´)
- ì¹´ë“œê²°ì œ (ì•Œë¦¼ë±…í¬ ì—°ë™ PG)
- ê°„í¸ê²°ì œ(ì¹´ì¹´ì˜¤í˜ì´/ë„¤ì´ë²„í˜ì´ ë“±, ì•Œë¦¼ë±…í¬ë¥¼ í†µí•´ ì œê³µ)

### 8.2 ê²°ì œ ìš”ì²­ â†’ ìŠ¹ì¸ â†’ Webhook

**Billing & Payment ì•„í‚¤í…ì²˜ ê°œìš”:**

ì•Œë¦¼ë±…í‚¹ â†” Edge Function â†” audit.webhook_events â†” payments/invoices â†” Reconcile UI

**í•µì‹¬ êµ¬ì„± ìš”ì†Œ:**
- **Core Billing ëª¨ë“ˆ**: invoices/invoice_items/payments êµ¬ì¡° (T3 ì°¸ì¡°)
- **ì•Œë¦¼ë±…í‚¹ Adapter**: Edge Function ê¸°ë°˜ ê²°ì œ ìš”ì²­/Webhook ì²˜ë¦¬
- **Event/Hook êµ¬ì¡°**: Webhook ì´ë²¤íŠ¸ ì¶”ì  ë° ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜

**ë©±ë“±ì„± Â· Advisory Lock Â· Webhook ì¬ì‹œë„ ê·œì¹™:**
- T3 ì°¸ì¡° (14-2-1-1 ì„¹ì…˜: ê²°ì œ/ì•Œë¦¼ë±…í‚¹ ìš´ì˜ ì •ì±…)
- R7.4 ì°¸ì¡°

**ì‹¤íŒ¨ ì‹œ Fallback ê²½ë¡œ:**

ì•Œë¦¼ë±…í‚¹ Webhook ì‹¤íŒ¨/ì§€ì—° ì‹œ ì²˜ë¦¬ íë¦„:

1. **Webhook ì‹¤íŒ¨ ê°ì§€:**
   - `audit.webhook_events` í…Œì´ë¸”ì— ì‹¤íŒ¨ ìƒíƒœ ê¸°ë¡
   - ì¬ì‹œë„ íì— ì¶”ê°€ (ì§€ìˆ˜ ë°±ì˜¤í”„: 5s â†’ 30s â†’ 2m â†’ 10m â†’ 30m, ìµœëŒ€ 5íšŒ)

2. **ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼ ì‹œ:**
   - Dead Letter Queue(DLQ)ë¡œ ì´ë™
   - ìš´ì˜ì ì•Œë¦¼ ì¹´ë“œ ìƒì„±
   - ìˆ˜ë™ ì¡°ì • UIì—ì„œ ì¬ì²˜ë¦¬ ê°€ëŠ¥

3. **ì •ì‚° ë¶ˆì¼ì¹˜ ê°ì§€:**
   - `audit.webhook_events` vs `payments` vs ì •ì‚° ë°ì´í„° ë¹„êµ
   - ë¶ˆì¼ì¹˜ ê¸ˆì•¡ < 1,000ì›: ìë™ ì¡°ì • (ë¡œê·¸ ê¸°ë¡)
   - ë¶ˆì¼ì¹˜ ê¸ˆì•¡ â‰¥ 1,000ì›: ìˆ˜ë™ ì¡°ì • UIì—ì„œ ìŠ¹ì¸ í•„ìš”

4. **ìˆ˜ë™ ì¡°ì • UI:**
   - ì •ì‚° ë¶ˆì¼ì¹˜ ëª©ë¡ ì¡°íšŒ (ë‚ ì§œë³„, ì—…ì²´ë³„ í•„í„°)
   - ë¶ˆì¼ì¹˜ ìƒì„¸ ë‚´ì—­ í™•ì¸ (webhook ì´ë²¤íŠ¸ vs ì •ì‚° ë°ì´í„° ë¹„êµ)
   - ìˆ˜ë™ ì¡°ì • ìŠ¹ì¸/ê±°ë¶€ (ìŠ¹ì¸ ì‹œ audit.eventsì— ê¸°ë¡)
   - ì¡°ì • ì´ë ¥ ì¡°íšŒ

**ìƒì„¸ êµ¬í˜„:**
- T3 ì°¸ì¡° (14-2-1-1 ì„¹ì…˜: ê²°ì œ/ì•Œë¦¼ë±…í‚¹ ìš´ì˜ ì •ì±…)
- R7.4 ì°¸ì¡°

**âš ï¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€:**

Billing/Payments íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì€ ì „ì²´ ê¸°ìˆ ë¬¸ì„œ PART 4-1-1ì˜ ê·œì¹™(Billing/PaymentsëŠ” REPEATABLE READ)ì„ ë”°ë¥¸ë‹¤.

### 8.3 ë¶€ë¶„ë‚©ë¶€ ì²˜ë¦¬

(ë³¸ ë¬¸ì„œ 3.4.3 ì„¹ì…˜ ì°¸ì¡°)

### 8.4 Early Payment

(ë³¸ ë¬¸ì„œ 3.4.4 ì„¹ì…˜ ì°¸ì¡°)

### 8.5 Smart Retry Logic

(ë³¸ ë¬¸ì„œ 3.4.5 ì„¹ì…˜ ì°¸ì¡°)

### 8.6 ë©±ë“±ì„± ì²˜ë¦¬

**Webhook ë©±ë“±ì„±:**
- idempotency_keyë¡œ ì¤‘ë³µ ì½œë°± ë°©ì§€
- ë™ì¼ idempotency_keyëŠ” í•œ ë²ˆë§Œ ì²˜ë¦¬
- ì¤‘ë³µ ìš”ì²­ ì‹œ ê¸°ì¡´ ê²°ê³¼ ë°˜í™˜

### 8.7 ì •ì‚°/íšŒê³„ ì±…ì„ ë²”ìœ„

**ì •ì‚°/íšŒê³„ ì±…ì„:**
- ì •ì‚°/íšŒê³„ëŠ” ì•Œë¦¼ë±…í¬ ë° PGì‚¬ì—ì„œ ì œê³µí•˜ëŠ” ì •ì‚° ë‚´ì—­ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°,
- ë””ì–´ìŒ¤ì€ ì¡°íšŒÂ·í•„í„°Â·í†µê³„Â·ëŒ€ì‹œë³´ë“œ ì—­í• ì— ì§‘ì¤‘í•œë‹¤.

## 9. ìš´ì˜Â·ë°°í¬ êµ¬ì¡° (DevOps / Deployment)

### 9.1 Vercel + Supabase êµ¬ì¡°

**ë°°í¬ êµ¬ì¡°:**
- Frontend: Vercel ë°°í¬
- Backend: Supabase (PostgreSQL + Edge Functions)
- ì¸ì¦: Supabase Auth
- ìŠ¤í† ë¦¬ì§€: Supabase Storage

### 9.2 CI/CD Workflow (TurboRepo + Git)

**Monorepo êµ¬ì¡°:**
- TurboRepo ê¸°ë°˜ ë¹Œë“œ ì‹œìŠ¤í…œ
- Git ê¸°ë°˜ ë²„ì „ ê´€ë¦¬
- ìë™ ë°°í¬ íŒŒì´í”„ë¼ì¸

**âš ï¸ 2-3: Event Engine ìŠ¤ì¼€ì¤„ vs Supabase Scheduled Functions:**

ë¬¸ì„œì—ì„œ ì •ì˜ëœ Event Engine ì‹œê°„ ê¸°ë°˜ ìŠ¤ì¼€ì¤„ì€ Supabase Scheduled Functions(ë˜ëŠ” ë³„ë„ Cron Runner)ë¡œ êµ¬í˜„í•œë‹¤:
- 04:00 ì„œë²„ê°€ ì²­êµ¬ ìƒì„±
- 07:00 ì„œë²„ê°€ AI ë°ì¼ë¦¬ ë¸Œë¦¬í•‘ ìƒì„± (AI í˜¸ì¶œ í¬í•¨)
- 03:00 AI Feedback Queue Refill
- 04:00 (ì¼ìš”ì¼) AI ëª¨ë¸ ì¬í•™ìŠµ
- 23:59 ì¼ì¼ í†µê³„ ì—…ë°ì´íŠ¸

### 9.3 í™˜ê²½ë³€ìˆ˜ & Secrets ê´€ë¦¬

**í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬:**
- Vercel í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- Supabase Secrets ê´€ë¦¬
- ë¯¼ê° ì •ë³´ëŠ” Secretsë¡œ ê´€ë¦¬

### 9.4 ì—ëŸ¬ ëª¨ë‹ˆí„°ë§(Sentry)

**ì—ëŸ¬ ëª¨ë‹ˆí„°ë§:**
- Sentryë¥¼ í†µí•œ ì—ëŸ¬ ì¶”ì 
- ì‹¤ì‹œê°„ ì•Œë¦¼ ì„¤ì •
- ì—ëŸ¬ ë¡œê·¸ ë¶„ì„

### 9.5 ì„±ëŠ¥ ê¸°ì¤€(FCP, Bundle Size â‰¤ 500KB)

**ì„±ëŠ¥ ê¸°ì¤€:**
- First Contentful Paint (FCP) ìµœì í™”
- Bundle Size â‰¤ 500KB
- ì´ë¯¸ì§€ ìµœì í™”
- ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…

### 9.6 Logging & Observability

**ë¡œê¹… ì „ëµ:**
- êµ¬ì¡°í™”ëœ ë¡œê·¸ í˜•ì‹
- ë¡œê·¸ ë ˆë²¨ ê´€ë¦¬ (DEBUG, INFO, WARN, ERROR)
- ë¡œê·¸ ì§‘ê³„ ë° ë¶„ì„

### 9.7 Scale-up ì „ëµ (20,000 í…Œë„ŒíŠ¸ ëŒ€ë¹„)

**ìŠ¤ì¼€ì¼ ì—… ì „ëµ:**
- ë°ì´í„°ë² ì´ìŠ¤ ìƒ¤ë”© (í•„ìš” ì‹œ)
  - ìƒ¤ë”© ë‹¨ìœ„: `tenant_id` ë˜ëŠ” `industry_type + tenant_id`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤
  - í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ê²©ë¦¬ ìœ ì§€
- ìºì‹± ì „ëµ (Redis)
- CDN í™œìš©
- Edge Function ìµœì í™”

### 9.8 Disaster Recovery & Backup

**âš ï¸ ë°±ì—…Â·DRÂ·Region ì „ëµ ê³„ì¸µì  ë¡œë“œë§µ:**

ë³¸ ë¬¸ì„œì—ì„œëŠ” ë°±ì—…Â·DRÂ·Region ì „ëµì˜ ê³„ì¸µì  ë¡œë“œë§µë§Œ ëª…ì‹œí•˜ë©°, ìƒì„¸ RTO/RPO ê°’ ë° Region Failover ì •ì±…ì€ T7ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.

**ìƒìš©í™” ë‹¨ê³„: ë‹¨ì¼ Region + ì •ê¸° ë°±ì—…**
- Supabase ìë™ ë°±ì—… í™œìš©
- ì¼ì¼ ìë™ ë°±ì—…
- PITR(Point-In-Time Recovery) ê¸°ëŠ¥ í™œìš©
- ë°±ì—… ë³´ê´€ ê¸°ê°„ ì„¤ì •

**ìƒìš©í™” ë‹¨ê³„: Read Replica ê¸°ë°˜ ë³´ê³ ì„œ ë¶„ë¦¬**
- ì½ê¸° ì „ìš© ì¿¼ë¦¬ë¥¼ Read Replicaë¡œ ë¶„ë¦¬
- ë³´ê³ ì„œ/í†µê³„ ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ
- ë©”ì¸ DB ë¶€í•˜ ê°ì†Œ

**ì„ íƒì  êµ¬í˜„: ë©€í‹° ë¦¬ì „/DR (ì™¸ë¶€ DB ì „í™˜ í•„ìš” ì‹œ)**
- Region Failover ì „ëµ
- ìƒì„¸ RTO/RPO ì •ì±…
- ìë™ ì¥ì•  ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜

**ìƒì„¸ ì •ì±…:**
- T7 ì°¸ì¡° (Multi-Region DRì€ ì„ íƒì  êµ¬í˜„ìœ¼ë¡œ ì™¸ë¶€ DB ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„, ì‹¤ì œ í•„ìš” ì‹œ)

## 10. ë³´ì•ˆ(Security) ê·œì•½

### 10.1 Zero-Trust Data Path

(ë³¸ ë¬¸ì„œ 1.4 ì„¹ì…˜ ì°¸ì¡°)

### 10.2 Supabase RLS ì •ì±… í‘œì¤€

(ë³¸ ë¬¸ì„œ 1.3 ì„¹ì…˜ ì°¸ì¡°)

### 10.3 Audit Log & Event Log

(ë³¸ ë¬¸ì„œ 7.7 ì„¹ì…˜ ì°¸ì¡°)

### 10.4 API Request Signature(HMAC)

**HMAC ì„œëª…:**
- QR í† í° ì„œëª…ì— HMAC ì‚¬ìš©
- API ìš”ì²­ ì„œëª… ê²€ì¦
- ì„œëª… í‚¤ëŠ” Secretsë¡œ ê´€ë¦¬

### 10.5 QR Token Security

(ë³¸ ë¬¸ì„œ 3.3.5 ì„¹ì…˜ ì°¸ì¡°)

### 10.6 Parent App ì¸ì¦ ëª¨ë¸

**í•™ë¶€ëª¨ ì•± ì¸ì¦:**
- Public Gatewayë¥¼ í†µí•œ ì¸ì¦
- JWT í† í° ê¸°ë°˜ ì¸ì¦
- ìë…€ ì •ë³´ë§Œ ì ‘ê·¼ ê°€ëŠ¥

### 10.7 Rate Limit & Abuse Detection

**âš ï¸ M4: Notification Throttling ì¤‘ë³µ ì œê±°:**

Rate Limit ê·œì¹™ì€ **3.5.5 Notification Throttling Rule** ì„¹ì…˜ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.

**Rate Limit (ë³¸ ë¬¸ì„œ 3.5.5 ì„¹ì…˜ ì°¸ì¡°):**
- ì„œë²„ ì „ì²´: 50ê±´/ì´ˆ
- ë‹¨ì¼ í…Œë„ŒíŠ¸: 3ê±´/ì´ˆ
- ì´ˆê³¼ ì‹œ ìë™ íì‰ ë° ì§€ì—° ì²˜ë¦¬

**Abuse Detection:**
- ë™ì¼ IPì—ì„œ ê³¼ë„í•œ ìš”ì²­: 1ë¶„ì— 100íšŒ ì´ˆê³¼ ì‹œ ìë™ ì°¨ë‹¨
- ìŠ¤íŒ¸ì„± ë©”ì‹œì§€ ìë™ ì°¨ë‹¨: AI ê¸°ë°˜ ìŠ¤íŒ¸ ê°ì§€
- ë¹„ì •ìƒ íŒ¨í„´ ê°ì§€ ì‹œ ìë™ ê³„ì • ì¼ì‹œ ì •ì§€

### 10.8 Data Encryption ì •ì±…

**âš ï¸ 2-2: PII/ì•”í˜¸í™” ì„¹ì…˜ Phase êµ¬ë¶„ ëª…ì‹œ:**

**ìƒìš©í™” ë‹¨ê³„:**
- ìµœì†Œ ìˆ˜ì§‘, ë…¸ì¶œ ìµœì†Œí™”, UI/ë¡œê·¸ ë§ˆìŠ¤í‚¹ ìœ„ì£¼
- DB ì»¬ëŸ¼ì€ í‰ë¬¸ì´ì§€ë§Œ RLS + ê¶Œí•œ + Audit Logë¡œ ë°©ì–´
- ì „ì†¡ ì¤‘ ì•”í˜¸í™” (HTTPS)

**ìƒìš©í™” ë‹¨ê³„:**
- ì ì§„ì  ì»¬ëŸ¼ ì•”í˜¸í™” ê²€í† 

**ì„ íƒì  êµ¬í˜„:**
- App Layer AEAD(Envelope Encryption) ì•”í˜¸í™” ê¸°ë³¸ ì ìš©
- pgcryptoëŠ” ì—¬ì „íˆ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ìš´ì˜ ë³µì¡ì„±, ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ìœ )
- ìì„¸í•œ í‚¤ íšŒì „/PII ì¹´íƒˆë¡œê·¸ëŠ” ì „ì²´ ê¸°ìˆ ë¬¸ì„œ 19ì¥ ì°¸ì¡°

**ë°ì´í„° ì•”í˜¸í™”:**
- ì „ì†¡ ì¤‘ ì•”í˜¸í™” (HTTPS)
- ì €ì¥ ë°ì´í„° ì•”í˜¸í™” (Phaseë³„ ì ìš©)
- ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹ (ìƒìš©í™” ë‹¨ê³„ë¶€í„° ì ìš©)

**âš ï¸ 2-6: ë³´ì•ˆ ì„¹ì…˜ - Audit/Monitoring/Alerting ì—°ê²°:**

**Audit Log â†’ ë³´ì•ˆ ì´ë²¤íŠ¸ ì—°ê³„:**
- ê¶Œí•œ ì‹¤íŒ¨, RLS ì°¨ë‹¨, ë¹„ì •ìƒ ë¡œê·¸ì¸ ì‹œë„ ë“± ë³´ì•ˆ ì´ë²¤íŠ¸ëŠ” Audit Logì— ê¸°ë¡
- ë³´ì•ˆ ê´€ë ¨ ì—ëŸ¬ëŠ” Monitoring/Alerting Tool(Sentry, Logflare ë“±)ê³¼ ì—°ë™í•˜ì—¬ ë™ì¼ ì±„ë„ì—ì„œ ëª¨ë‹ˆí„°ë§

**ìš´ì˜ ìë™í™”/ì•ŒëŒ:**
- Custom Domain í—¬ìŠ¤ì²´í¬, SSL ë§Œë£Œ ì•ŒëŒ, Auth Redirect Allowlist ë™ê¸°í™” ë°°ì¹˜ ë“±ì€ ì „ì²´ ê¸°ìˆ ë¬¸ì„œ 28ì¥ ì°¸ê³ 
- ë³´ì•ˆ = ê·œì¹™ + ëª¨ë‹ˆí„°ë§ ì›ì¹™ ì ìš©

## 11. API / Edge Function êµ¬ì¡°

### 11.1 Public Gateway API

**Public Gateway ì—­í• :**
- í•™ë¶€ëª¨ ì•± ì ‘ê·¼
- QR ì¶œê²° ì ‘ê·¼
- ê³µê°œ API ì œê³µ

**Public Gateway ì—”ë“œí¬ì¸íŠ¸:**
- /public-gateway/payment/**
- /public-gateway/attendance/notifications
- /public-gateway/billing/history

### 11.2 Supabase Edge Function êµ¬ì¡°

**Edge Function êµ¬ì¡°:**
- Domain Function (Students, Classes, Billing ë“±)
- Payment Function (Request/Webhook)
- SDUI Schema API
- AI API (ìš”ì•½/ì¸ì‚¬ì´íŠ¸ ìƒì„±)
- Notification API

### 11.3 Domain Function (Students, Classes, Billing ë“±)

**ë„ë©”ì¸ë³„ Edge Function:**
- fns-student-*: í•™ìƒ ê´€ë ¨ í•¨ìˆ˜
- fns-class-*: ë°˜ ê´€ë ¨ í•¨ìˆ˜
- fns-billing-*: ì²­êµ¬ ê´€ë ¨ í•¨ìˆ˜
- fns-attendance-*: ì¶œê²° ê´€ë ¨ í•¨ìˆ˜

### 11.4 Payment Function (Request/Webhook)

(ë³¸ ë¬¸ì„œ 8.2 ì„¹ì…˜ ì°¸ì¡°)

### 11.5 SDUI Schema API

**SDUI Schema API:**
- ìŠ¤í‚¤ë§ˆ ì¡°íšŒ API
- ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ API
- í…Œë„ŒíŠ¸ë³„ ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆ API

### 11.6 AI API (ìš”ì•½/ì¸ì‚¬ì´íŠ¸ ìƒì„±)

**AI API:**
- ìƒë‹´ì¼ì§€ ìš”ì•½ API
- AI ì¸ì‚¬ì´íŠ¸ ìƒì„± API
- ìœ„í—˜ íƒì§€ API

### 11.7 Notification API

**Notification API:**
- ë©”ì‹œì§€ ë°œì†¡ API
- í…œí”Œë¦¿ ê´€ë¦¬ API
- ë°œì†¡ ë‚´ì—­ ì¡°íšŒ API

## 12. ìš´ì˜ ë§¤ë‰´ì–¼ (Operation Manual)

### 12.1 í…Œë„ŒíŠ¸ ìƒì„±

**âš ï¸ B3: í…Œë„ŒíŠ¸ ìƒì„± í”Œë¡œìš°ì— location_code ë“±ë¡ Step ì¶”ê°€:**

**í…Œë„ŒíŠ¸ ìƒì„± ì ˆì°¨ (v3.3 í™•ì •):**

Regional AnalyticsëŠ” `location.*` ê²½ë¡œê°€ í•„ìˆ˜ì´ë¯€ë¡œ, í…Œë„ŒíŠ¸ ìƒì„± ì‹œ ìœ„ì¹˜ ì •ë³´ë¥¼ ë°˜ë“œì‹œ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB)):

**Step 1: ì—…ì¢… ì„ íƒ**
- í•™ì› (academy)
- ë¯¸ìš©ì‹¤ (salon)
- ë¶€ë™ì‚° (real_estate)

**Step 2: í•™ì› ê¸°ë³¸ ì •ë³´ ì…ë ¥**
- í•™ì›ëª…
- ëŒ€í‘œìëª…
- ì—°ë½ì²˜
- ì´ë©”ì¼

**Step 3: ì£¼ì†Œ ì…ë ¥ â†’ í–‰ì •ë™ ì½”ë“œ ìë™ ë§¤í•‘**
- ì£¼ì†Œ ê²€ìƒ‰ (ë‹¤ìŒ/ì¹´ì¹´ì˜¤ ì£¼ì†Œ API ì—°ë™)
- ì‹œ/ë„ ì„ íƒ
- ì‹œ/êµ°/êµ¬ ì„ íƒ
- ë™ ì„ íƒ
- ìƒì„¸ ì£¼ì†Œ ì…ë ¥
- **ìë™ ë§¤í•‘:**
  - `sido_code`: ì‹œ/ë„ ì½”ë“œ (ì˜ˆ: "11" = ì„œìš¸íŠ¹ë³„ì‹œ)
  - `sigungu_code`: ì‹œ/êµ°/êµ¬ ì½”ë“œ (ì˜ˆ: "11680" = ê°•ë‚¨êµ¬)
  - `location_code`: í–‰ì •ë™ ì½”ë“œ (ì˜ˆ: "1168010100" = ëŒ€ì¹˜ë™)

**Step 4: ì§€ë„ì—ì„œ ìœ„ì¹˜ ì¡°ì • (ì„ íƒ)**
- ì§€ë„ì—ì„œ ì •í™•í•œ ìœ„ì¹˜ ì„ íƒ
- `lat`, `lng` ìë™ ì €ì¥
- ì§€ë„ì—ì„œ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì£¼ì†Œ ê¸°ë°˜ ì¢Œí‘œ ìë™ ì„¤ì •

**Step 5: ì§€ì—­ ì½”ë“œ ì €ì¥**
- `location.*` ê²½ë¡œì— ëª¨ë“  ìœ„ì¹˜ ì •ë³´ ì €ì¥ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB)):
  ```json
  {
    "location": {
      "si": "ì„œìš¸íŠ¹ë³„ì‹œ",
      "gu": "ê°•ë‚¨êµ¬",
      "dong": "ëŒ€ì¹˜ë™",
      "lat": 37.498,
      "lng": 127.061,
      "sido_code": "11",
      "sigungu_code": "11680",
      "location_code": "1168010100",
      "region_code": null  // ë³¸ì‚¬ì—ì„œ ë‚˜ì¤‘ì— ì„¤ì • ê°€ëŠ¥
    }
  }
  ```

**Step 6: ê¸°ë³¸ ì„¤ì • ì™„ë£Œ**
- í…Œë„ŒíŠ¸ ìƒì„± ì™„ë£Œ
- Regional Analytics ì‚¬ìš© ê°€ëŠ¥

**ê¸°ì¡´ í…Œë„ŒíŠ¸ ìƒì„± ì ˆì°¨ (ìœ„ì¹˜ ì •ë³´ í•„ìˆ˜):**
1. í…Œë„ŒíŠ¸ ê¸°ë³¸ ì •ë³´ ì…ë ¥
2. ìœ„ì¹˜ ì •ë³´ ì„¤ì • (í•„ìˆ˜)
3. ì´ˆê¸° ì‚¬ìš©ì ìƒì„±
4. ê¶Œí•œ ì„¤ì •

### 12.2 ìœ„ì¹˜ ì •ë³´ ì„¤ì •

(ë³¸ ë¬¸ì„œ 3.6.1 ì„¹ì…˜ ì°¸ì¡°)

### 12.3 ì•Œë¦¼ë±…í¬ ë“±ë¡ ì ˆì°¨

**ì•Œë¦¼ë±…í¬ ë“±ë¡:**
1. ì•Œë¦¼ë±…í¬ ê³„ì • ìƒì„±
2. API í‚¤ ë°œê¸‰
3. Webhook URL ì„¤ì •
4. í…ŒìŠ¤íŠ¸ ê²°ì œ ì§„í–‰

### 12.4 ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ í…œí”Œë¦¿ ìŠ¹ì¸

(ë³¸ ë¬¸ì„œ 3.5.3 ì„¹ì…˜ ì°¸ì¡°)

### 12.5 ë°ì´í„° ì¬ì§‘ê³„(Backfill)

(ë³¸ ë¬¸ì„œ 3.6.6 ì„¹ì…˜ ì°¸ì¡°)

### 12.6 Quota ì¦ê°€ ìš”ì²­

**Quota ê´€ë¦¬:**
- Quota ì‚¬ìš©ëŸ‰ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
- Quota ì´ˆê³¼ ì‹œ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— ì•Œë¦¼
- Quota ì¦ê°€ ìš”ì²­ í”„ë¡œì„¸ìŠ¤ ì œê³µ

### 12.7 í•™ë¶€ëª¨ ì•± ì´ˆê¸° ì„¤ì •

**í•™ë¶€ëª¨ ì•± ì„¤ì •:**
1. í•™ë¶€ëª¨ ê³„ì • ìƒì„±
2. ìë…€ ì •ë³´ ì—°ê²°
3. ì•Œë¦¼ ì„¤ì •
4. ê²°ì œ ìˆ˜ë‹¨ ë“±ë¡

## 13. ë¶€ë¡(Appendix)

### 13.1 ëª¨ë“  í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ëª©ë¡

**ì£¼ìš” í…Œì´ë¸”:**
- students: í•™ìƒ ì •ë³´
- classes: ë°˜ ì •ë³´
- attendance_logs: ì¶œê²° ë¡œê·¸ (âš ï¸ B6: Device Fingerprint/GPS/Auth Method í•„ë“œ í¬í•¨)
- invoices: ì²­êµ¬ì„œ (id, tenant_id, student_id, amount, amount_paid, amount_due, status, period_start, period_end, ...)
- payments: ê²°ì œ ë‚´ì—­
- event_logs: ì´ë²¤íŠ¸ ë¡œê·¸
- ai_feedback_logs: AI í”¼ë“œë°± ë¡œê·¸
- automation_undo_logs: ìë™í™” Undo ë¡œê·¸
- tenants: í…Œë„ŒíŠ¸ ê¸°ë³¸ ì •ë³´
- tenant_settings: í…Œë„ŒíŠ¸ë³„ JSON ì„¤ì • (attendance, location, notification, billing ë“±)

### 13.2 Materialized View SQL

(ë³¸ ë¬¸ì„œ 7.5 ì„¹ì…˜ ì°¸ì¡°)

### 13.3 SDUI Schema JSON ìƒ˜í”Œ

(ë³¸ ë¬¸ì„œ 5.3 ì„¹ì…˜ ì°¸ì¡°)

### 13.4 Event Logs ìƒ˜í”Œ

**Event Log ì˜ˆì‹œ:**
```json
{
  "id": "uuid",
  "idempotency_key": "webhook_alimbank_12345_20240101",
  "event_type": "payment_webhook",  // âš ï¸ ì°¸ê³ : event_logs.event_typeì€ ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ event_typeê³¼ ë‹¤ë¥¸ ë„ë©”ì¸ ê°’ì…ë‹ˆë‹¤
  "tenant_id": "uuid",
  "payload": {
    "invoice_id": "uuid",
    "amount": 300000,
    "status": "paid"
  },
  "status": "completed",
  "created_at": "2024-01-01T00:00:00Z",
  "processed_at": "2024-01-01T00:00:01Z",
  "retry_count": 0
}
```

### 13.5 AI ë¸Œë¦¬í•‘ ìƒ˜í”Œ

**AI ë¸Œë¦¬í•‘ ì˜ˆì‹œ:**
- "ì›ì¥ë‹˜, ì˜¤ëŠ˜ 3ê±´ì˜ ìƒë‹´ì´ í•„ìš”í•˜ë©° 2ëª…ì˜ í•™ìƒì´ ì´íƒˆ ìœ„í—˜ ë‹¨ê³„ì…ë‹ˆë‹¤."
- "ì´ë²ˆ ì£¼ ìˆ˜ì—… ì¤‘ ìˆ˜í•™Aë°˜ ì¶œê²°ë¥ ì´ ì§€ì—­ í‰ê·  ëŒ€ë¹„ 12% ë‚®ìŠµë‹ˆë‹¤. ì›ì¸ì„ ë¶„ì„í• ê¹Œìš”?"
- "ì´ë²ˆ ë‹¬ ì²­êµ¬ì„œê°€ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆìƒ ìˆ˜ë‚©ë¥ ì€ 92%ì…ë‹ˆë‹¤."

### 13.6 í™”ë©´ ì™€ì´ì–´í”„ë ˆì„

**ì£¼ìš” í™”ë©´:**
- í™ˆ ëŒ€ì‹œë³´ë“œ
- ì¶œê²° í™”ë©´
- í•™ìƒ ê´€ë¦¬ í™”ë©´
- ìˆ˜ë‚©/ì²­êµ¬ í™”ë©´
- í†µê³„ í™”ë©´
- AI ì¸ì‚¬ì´íŠ¸ í™”ë©´

### 13.7 ìš©ì–´ì§‘

**ì£¼ìš” ìš©ì–´:**
- Zero-Management: ê´€ë¦¬ í•„ìš” ì—†ìŒ, ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ìš´ì˜
- SDUI: Schema-Driven UI, ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ í™”ë©´ ìë™ ìƒì„±
- RLS: Row Level Security, í–‰ ë‹¨ìœ„ ë³´ì•ˆ ì •ì±…
- Multi-Tenant: ë©€í‹°í…Œë„ŒíŠ¸, ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì—¬ëŸ¬ ê³ ê° ê²©ë¦¬
- Regional Analytics: ì§€ì—­ ê¸°ë°˜ í†µê³„, ì§€ì—­ ë‹¨ìœ„ ë¹„êµ ë¶„ì„
- Auto-Billing: ìë™ ì²­êµ¬ ìƒì„± ë° ë°œì†¡
- Partial Payment: ë¶€ë¶„ë‚©ë¶€, ì²­êµ¬ ê¸ˆì•¡ì˜ ì¼ë¶€ë§Œ ë‚©ë¶€
- Early Payment: ì¡°ê¸°ë‚©ë¶€, ê¸°ê°„ ë‚´ ì¡°ê¸° ë‚©ë¶€ ì‹œ í• ì¸
- TaskCard: ì—…ë¬´ ì¹´ë“œ, ì„œë²„ê°€ ìƒì„±í•˜ë©° ì¼ë¶€ íƒ€ì…ì—ì„œë§Œ AI í˜¸ì¶œ ë°œìƒ (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- Idempotency: ë©±ë“±ì„±, ë™ì¼ ìš”ì²­ì˜ ë°˜ë³µ ì‹¤í–‰ ì‹œ ë™ì¼ ê²°ê³¼ ë³´ì¥

---

**ë¬¸ì„œ ë²„ì „:** v3.3
**ìµœì¢… ì—…ë°ì´íŠ¸:** 2025-12-10
**ì‘ì„±ì:** ë””ì–´ìŒ¤ ê°œë°œíŒ€

---

## ğŸ“Œ ì¤‘ìš” í†µí•© êµ¬ì¡° ëª…ì‹œ

### ì¶œê²° ì„¤ì • í†µí•© êµ¬ì¡°

**âš ï¸ ì¶œê²° ì„¤ì •ì€ ë‹¨ì¼ JSON êµ¬ì¡°ë¡œ í†µí•©:**

ì¶œê²° ì„¤ì •(attendance_settings)ì€ ë‹¨ì¼ JSON êµ¬ì¡°(`attendance.*` ê²½ë¡œ)ë¡œ í†µí•©ë˜ì–´ì•¼ í•˜ë©°, QR ì¸ì¦/ë³´ì¡° ì¸ì¦/í† í° ë¡œì§/ì§€ê° ê¸°ì¤€/ì¤‘ë³µ ì²´í¬/ì¶œê²° ëª¨ë“œë„ ëª¨ë‘ ì´ JSON êµ¬ì¡°ì—ì„œ ì œì–´ëœë‹¤. (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))

**â€» ì´ êµ¬ì¡°ì˜ ê³µì‹ ì •ì˜ëŠ” 3.3.7 ì„¹ì…˜ì„ ì°¸ì¡°í•œë‹¤.**

**âš ï¸ ğŸ”¥ 3ë²ˆ: attendance_settings JSON ì¤‘ë³µ ì œê±°:**

**ë‹¨ì¼ ì†ŒìŠ¤ ì›ì¹™:**

ì¶œê²° ì„¤ì • JSONì€ **3.3.7 ì¶œê²° ì„¤ì •** ì„¹ì…˜ì˜ `attendance.*` ê²½ë¡œ ê³µì‹ ìŠ¤í™ë§Œ ìœ ì§€í•˜ê³ , ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œëŠ” ì°¸ì¡° í˜•íƒœë¡œë§Œ ì–¸ê¸‰ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB)):

- `class_specific_late_rules`: 3.3.7 ì°¸ì¡°
- `qr_token_expiry_days`: 3.3.7 ì°¸ì¡°
- `device_fingerprint_fallback_policy`: 3.3.7 ì°¸ì¡°

**ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ ì¶œê²° ì„¤ì •ì„ ì–¸ê¸‰í•  ë•Œ:**
- "3.3.7 ì¶œê²° ì„¤ì •ì˜ `attendance.*` ê²½ë¡œ ê³µì‹ ìŠ¤í™ ì°¸ì¡°" í˜•íƒœë¡œë§Œ ì–¸ê¸‰ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))
- ì¤‘ë³µëœ í•„ë“œ ì •ì˜ ì œê±°

**âš ï¸ C6: ì¶œê²° ì„¤ì • JSON êµ¬ì¡° ì¤‘ë³µ ì œê±°:**

ë¬¸ì„œ ë‚´ 2ê°œ ë²„ì „ ì¡´ì¬ â†’ ì•„ë˜ í™•ì •ë³¸ 1ê°œë§Œ ì‚¬ìš©:

**í™•ì •ë³¸ (3.3.7 ì„¹ì…˜ì˜ ê³µì‹ ìŠ¤í™):**

ìœ„ì˜ `attendance.*` ê²½ë¡œ ê³µì‹ ìŠ¤í™ (ë‹¨ì¼ ì†ŒìŠ¤) ì„¹ì…˜(3.3.7 ì¶œê²° ì„¤ì •, 1732-1776ì¤„)ì´ ìœ ì¼í•œ ì •ì‹ ì •ì˜ì…ë‹ˆë‹¤. (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))

**ë‹¤ë¥¸ ì„¹ì…˜ì—ì„œ ì¶œê²° ì„¤ì •ì„ ì–¸ê¸‰í•  ë•ŒëŠ”:**
- "3.3.7 ì¶œê²° ì„¤ì •ì˜ `attendance.*` ê²½ë¡œ ê³µì‹ ìŠ¤í™ ì°¸ì¡°" í˜•íƒœë¡œë§Œ ì–¸ê¸‰ (ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))
- ì¤‘ë³µëœ JSON êµ¬ì¡° ì •ì˜ ì œê±°

---

## 14. ë³€ê²½ ì´ë ¥ (Changelog)

- YYYY-MM-DD: AI ì˜¨ì˜¤í”„ SSOT í†µì¼ ì‘ì—… ì™„ë£Œ
  - AI ì˜¨ì˜¤í”„ ì œì–´ë¥¼ `tenant_features(feature_key='ai').enabled`ë¡œ í†µì¼ (SSOT)
  - `tenant_settings.ai.enabled`ëŠ” ë ˆê±°ì‹œë¡œ í‘œì‹œ
  - í”Œë«í¼ ìŠ¤ìœ„ì¹˜ `PLATFORM_AI_ENABLED` ì¶”ê°€ (env-registry/server)
  - ìµœì¢… ìœ íš¨ê°’ ê³„ì‚° ë¡œì§ ëª…ì‹œ: `effective_ai_enabled = PLATFORM_AI_ENABLED && tenant_features['ai'].enabled`
  - í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ SSOT ì„¹ì…˜ ì°¸ì¡° ì¶”ê°€
- YYYY-MM-DD: Critical ì´ìŠˆ ìˆ˜ì • ì™„ë£Œ
  - Analytics í…Œì´ë¸”ëª… ì •ë³¸í™” (regional_metrics_daily â†’ analytics.daily_region_metrics, SSOT í™•ì •)
  - êµ¬ë²„ì „ ë„¤ì´ë° ì™„ì „ ì œê±° (analytics.daily_metrics, analytics.monthly_revenue, regional_metrics_daily)
  - ì •ë³¸ í…Œì´ë¸” ëª…ì‹œ: analytics.daily_store_metrics, analytics.daily_region_metrics (SSOT)
  - AI ì¸ì‚¬ì´íŠ¸ ì—”í‹°í‹° ë‹¨ì¼í™” (ai_insights ì •ë³¸, MVëŠ” íŒŒï¿½
