# 코드 생성 전 필수 체크리스트

> **참고**: 이 체크리스트는 AI가 자동으로 확인합니다. 사용자는 `docu/사용자_지시_가이드.md`를 참고하세요.

## 🎯 코드 생성 전 반드시 확인할 사항 (AI 자동 검증)

### 1. 아키텍처 레이어 확인
- [ ] **클라이언트 코드인가?** → `@api-sdk/core` 사용 필수, `@services/*` 직접 호출 금지
- [ ] **서버 코드인가?** → `@services/*` 또는 `@industry/*/service` 사용, `withTenant()` 필수
- [ ] **Hook인가?** → `@api-sdk/core`만 사용, `getApiContext()`로 tenantId 가져오기
- [ ] **Industry Layer 코드인가?** → `@core/*`만 import, `@industry/*` 간 의존성 금지
- [ ] **Core Layer 코드인가?** → `@core/*` 간 의존성만 허용, `@industry/*` import 금지

### 2. 의존성 경로 확인
- [ ] 모든 `file:` 경로는 `file:../../packages/...` 형식인가?
- [ ] `file:../../lib/...` 같은 잘못된 경로는 없는가?
- [ ] `package.json`의 `dependencies`에 올바른 경로가 있는가?

### 3. Zero-Trust 원칙 확인
- [ ] UI에서 `tenantId`, `industryType`을 하드코딩하지 않았는가?
- [ ] `setApiContext()`는 `main.tsx`에서만 개발용으로 설정하는가?
- [ ] API SDK의 `post()` 메서드가 자동으로 `tenant_id`, `industry_type`을 삽입하는가?

### 4. Service Layer 규칙 확인
- [ ] **INSERT**: `tenant_id`를 row object에 직접 포함하는가? (`.eq('tenant_id')` 사용 금지)
- [ ] **SELECT/UPDATE/DELETE**: `withTenant()`를 사용하는가? (`.eq('tenant_id', ...)` 직접 사용 금지)
- [ ] Service는 `@lib/supabase-client/server`를 사용하는가?

### 5. 환경변수 접근 확인
- [ ] **서버 코드**: `@env-registry/core/server`에서 `envServer` import하는가?
- [ ] **클라이언트 코드**: `@env-registry/core`에서 `envClient`만 import하는가?
- [ ] `process.env` 직접 접근은 없는가? (서버에서도 금지)

### 6. 클라이언트-서버 분리 확인
- [ ] 서버 전용 코드(`@core/tags/service`, `@services/*/service`, `@industry/*/service`)가 클라이언트 번들에 포함되지 않는가?
- [ ] 패키지의 `index.ts`에서 서버 코드를 export하지 않는가?
- [ ] 서버 코드는 `/service` 경로에서만 import하는가?
- [ ] Industry Layer의 `index.ts`는 타입만 export하는가?

### 7. 타입 안전성 확인
- [ ] `any` 타입을 사용하지 않았는가? (필터링 등 필수 경우 제외)
- [ ] 모든 함수 파라미터와 반환값에 타입이 지정되어 있는가?

### 8. UI/UX 규칙 확인
- [ ] Tailwind 클래스를 직접 사용하지 않고 CSS 변수나 ui-core 컴포넌트를 사용하는가?
- [ ] `@ui-core/react/styles`를 import하여 전역 스타일을 사용하는가?
- [ ] 앱별 `index.css`는 비어있거나 앱 전용 스타일만 포함하는가?

### 9. 패키지 구조 확인
- [ ] 패키지의 `exports` 필드가 올바르게 설정되어 있는가?
- [ ] 서버 전용 export는 `/server`, `/service` 경로로 분리되어 있는가?

### 10. RLS 정책 확인 (SQL 생성 시)
- [ ] RLS 정책 이름이 `tenant_isolation_<table>` 형식인가?
- [ ] JWT claim 기반 RLS를 사용하는가? (`auth.jwt() -> 'tenant_id'`)
- [ ] `set_config` 기반 RLS는 사용하지 않는가?

### 11. 의존성 방향 확인
- [ ] 허용 방향: `apps/* → hooks/* → services/* → industry/* → core/* → DB`를 따르는가?
- [ ] 금지 방향: `core/* → industry-*` 같은 금지된 의존성이 없는가?
- [ ] 금지 방향: `industry-* → industry-*` (업종 간 의존성)이 없는가?
- [ ] 허용 방향: `core/* → core/*` (Core 모듈 간 의존성)이 올바른가?
- [ ] React 컴포넌트에서 Supabase 직접 호출이 없는가?
- [ ] 순환 의존성이 없는가?
- [ ] Service Layer가 Industry Layer를 래핑하는 구조인가?

### 12. API SDK 메서드 확인
- [ ] `post()` 메서드가 `tenant_id`, `industry_type`을 자동 삽입하는가?
- [ ] `patch()`, `delete()` 메서드가 RLS를 통해 자동 필터링되는가?
- [ ] Hook에서 `apiClient`를 통해서만 데이터 요청하는가?

### 13. Hook 패턴 확인
- [ ] Hook에서 `getApiContext()`로 `tenantId`를 가져오는가?
- [ ] `useQuery`의 `queryKey`에 `tenantId`가 포함되어 있는가?
- [ ] `onSuccess`에서 `invalidateQueries`를 올바르게 사용하는가?
- [ ] `enabled` 옵션으로 `tenantId` 존재 여부를 확인하는가?

### 14. 에러 처리 확인
- [ ] PostgREST 에러를 `AppError`로 매핑하는가?
- [ ] 에러 메시지에 민감 정보가 포함되지 않는가?
- [ ] 적절한 HTTP 상태 코드를 반환하는가?

### 15. PII 마스킹 확인
- [ ] 로그/모니터링에서 `maskPII()`를 사용하는가?
- [ ] 사용자 객체 전체를 로그에 남기지 않는가?
- [ ] 전화번호, 이메일, 이름 등을 직접 출력하지 않는가?

### 16. 날짜/시간 처리 확인
- [ ] DB에서 `CURRENT_DATE`를 직접 사용하지 않는가?
- [ ] KST 기준 날짜가 필요하면 `timezone('Asia/Seoul', now())::date`를 사용하는가?
- [ ] 앱 레이어에서 KST 기준 날짜를 계산해서 파라미터로 넘기는가?

### 17. SQL 인덱스 확인 (SQL 생성 시)
- [ ] 파티셔닝 테이블에 `(tenant_id, occurred_at DESC)` 인덱스가 있는가?
- [ ] 모든 멀티테넌트 테이블에 `tenant_id` 인덱스가 있는가?

### 18. 운영 규칙 확인
- [ ] 운영 코드에 더미 데이터 생성 코드가 없는가?
- [ ] 코드/UI 텍스트에 이모지가 없는가?
- [ ] 환경변수가 하드코딩되지 않았는가?

---

## 🚨 코드 생성 후 즉시 검증

1. **TypeScript 타입 체크**: `npm run type-check`
2. **Linter 실행**: `npm run lint` (있다면)
3. **빌드 테스트**: `npm run build` (가능한 경우)
4. **수동 검토**: 위 체크리스트 항목 재확인

---

## 📝 AI 사용 가이드

> **중요**: 이 체크리스트는 코드 생성 시 **자동으로** 확인해야 합니다.
> 사용자가 별도로 요청하지 않아도 반드시 모든 항목을 검증합니다.

### AI가 수행해야 할 작업

1. **코드 생성 전**: 이 체크리스트의 모든 항목 확인
2. **코드 생성 중**: 모든 규칙 적용
3. **코드 생성 후**: 자동 검증 및 오류 수정
4. **최종 확인**: 모든 Critical 항목 통과 확인

### 검증 우선순위

- **Critical 항목** (1-10번): 반드시 통과해야 함
- **일반 항목** (11-18번): 가능한 한 모두 통과

---

## 🔄 반복 발생하는 위반 사항

1. **의존성 경로 오류**: `file:../../lib/...` → `file:../../packages/lib/...`
2. **Service Layer에서 withTenant() 누락**: SELECT/UPDATE/DELETE에서 `.eq('tenant_id', ...)` 직접 사용
3. **API SDK 자동 삽입 누락**: `post()` 메서드에서 `tenant_id` 자동 삽입 확인
4. **서버 코드 클라이언트 번들 포함**: `index.ts`에서 서버 코드 export
5. **환경변수 직접 접근**: `process.env` 직접 사용

