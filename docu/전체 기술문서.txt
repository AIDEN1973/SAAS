ğŸ“˜ ë””ì–´ìŒ¤ Multi-Tenant SaaS í”Œë«í¼ â€” ê¸°ìˆ ë¬¸ì„œ

Monorepo + Supabase + PostgreSQL + ë©€í‹°í…Œë„ŒíŠ¸ + KST ìš´ì˜ í‘œì¤€

## âš ï¸ Automation Config First (ë¶ˆë³€ ì›ì¹™)

**ë³¸ ì‹œìŠ¤í…œì—ì„œ ì–´ë– í•œ ìë™í™”ë„ í•˜ë“œì½”ë”©ëœ ì¡°ê±´ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.**
**ëª¨ë“  ìë™í™”ëŠ” ì‚¬ìš©ì ì„¤ì •ê°’(Policy / Threshold / Toggle)ì„ í†µí•´ í™œì„±Â·ë¹„í™œì„± ë° ê°•ë„ê°€ ê²°ì •ë˜ë©°,**
**ì‹¤í–‰ ì—¬ë¶€ëŠ” ì„œë²„/Edge Functionì´ í•´ë‹¹ ì„¤ì •ì„ í•´ì„í•˜ì—¬ íŒë‹¨í•œë‹¤.**

âš ï¸ í‘œí˜„Â·ë‹¨ì–´Â·ìˆœì„œ ë³€ê²½ ê¸ˆì§€

### ê¸°ë³¸ê°’(Default)ì˜ ì •ë³¸ ì •ì˜

**ê¸°ë³¸ê°’(Default)ì´ë€ ì½”ë“œ ìƒìˆ˜ê°€ ì•„ë‹ˆë¼ Default Policyì´ë‹¤.**
**ëª¨ë“  ìë™í™” ê¸°ëŠ¥ì€ ê¸°ë³¸ ì •ì±…(Default Policy)ì„ ê°€ì§€ë©°,**
**ì´ ê¸°ë³¸ ì •ì±…ì€ í…Œë„ŒíŠ¸ ìƒì„± ì‹œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥ëœë‹¤.**
**ì½”ë“œì— í•˜ë“œì½”ë”©ëœ ê¸°ë³¸ ì„ê³„ê°’ì´ë‚˜ ì¡°ê±´ì€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.**

**ê¸ˆì§€ íŒ¨í„´:**
- âŒ "ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©"
- âŒ "undefinedë©´ 3ìœ¼ë¡œ ì²˜ë¦¬"
- âŒ ì½”ë“œ ë‚´ë¶€ ìƒìˆ˜ ê¸°ë°˜ ì¡°ê±´

**ì •ë³¸ íŒ¨í„´:**
- âœ… ì„¤ì •ì´ ì¡´ì¬ â†’ ì‚¬ìš©
- âœ… ì„¤ì •ì´ ì—†ìŒ â†’ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (Fail Closed)

### ìë™í™”ì˜ ì •ë³¸ êµ¬ì¡°

ìë™í™”ëŠ” ë°˜ë“œì‹œ ì•„ë˜ 3ìš”ì†Œ ì¡°í•©ìœ¼ë¡œë§Œ ì„¤ëª…í•œë‹¤:

1. **Trigger**: ìƒí™© ì‹ í˜¸ ë˜ëŠ” ì´ë²¤íŠ¸
2. **Policy**: ì‚¬ìš©ì ì„¤ì •ê°’ (ON/OFF, ì„ê³„ê°’, ìŠ¹ì¸ ë ˆë²¨)
3. **Executor**: Server / Edge Function (ì •ì±… í•´ì„ + ì‹¤í–‰)

âŒ í”„ë¡ íŠ¸ì—”ë“œëŠ” íŒë‹¨Â·ì‹¤í–‰ ì£¼ì²´ê°€ ì•„ë‹ˆë‹¤.

### ìë™í™” í•­ëª©ë³„ Policy ì„¤ì • í‘œ (ê³µí†µ)

**âš ï¸ ëª¨ë“  ë¬¸ì„œì— ë™ì¼í•˜ê²Œ ì‚½ì… (í˜•íƒœÂ·ë‚´ìš© ë³€ê²½ ê¸ˆì§€)**

| ìë™í™” í•­ëª© | ì‚¬ìš©ì ì„¤ì • ê°€ëŠ¥ | í•˜ë“œì½”ë”© ê¸ˆì§€ |
|------------|----------------|--------------|
| ì¶œê²° ì´ìƒ ê°ì§€ | ê°ì§€ ê¸°ì¤€, ì¹´ë“œ ìƒì„± ì—¬ë¶€ | ê¸°ì¤€ê°’ |
| ë¯¸ë‚© ì•Œë¦¼ | ìë™ ë°œì†¡ ON/OFF, ì‹œì  | ë°œì†¡ ì¡°ê±´ |
| AI ì—…ë¬´ ì¹´ë“œ(TaskCard, task_type: 'ai_suggested', entity_type='student') | AI ON/OFF, ìŠ¹ì¸ í•„ìš” ì—¬ë¶€ | ì„œë²„ê°€ ì •ì±…ì— ë”°ë¼ ì‹¤í–‰ | (StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
| ëŒ€ì‹œë³´ë“œ ìš°ì„ ìˆœìœ„ | ê°€ì¤‘ì¹˜ ì¡°ì • | ê·¸ë£¹ ìˆœì„œ |
| ë¦¬í¬íŠ¸ ìƒì„± | ìë™ ìƒì„± ì—¬ë¶€ | ìƒì„± ì£¼ê¸° |

â€» ìƒìœ„ Policy KeyëŠ” SSOT(v2 6ê°œ)ë¡œ ê³ ì •ëœë‹¤. ì‹ ê·œ ìë™í™”ëŠ” event_type ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ í›„ ê°€ëŠ¥í•˜ë©°, ì¹´íƒˆë¡œê·¸ì— ì—†ëŠ” event_typeì€ ì‹¤í–‰/ì¶”ê°€í•  ìˆ˜ ì—†ë‹¤. (ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ = ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`ì— event_type ì¶”ê°€)

---

## âš ï¸ Automation & AI Industry-Neutral Rule (SSOT)

ë³¸ í”Œë«í¼ì˜ ìë™í™” ì„¤ì • ë° AI ê¸°ëŠ¥ì€ **ì—…ì¢…(Academy/Salon/Nail ë“±)ì— ì¢…ì†ë˜ì§€ ì•ŠëŠ”ë‹¤.**

### ë¶ˆë³€ ì›ì¹™
- ìë™í™”/AIì˜ ì‹¤í–‰ êµ¬ì¡°ëŠ” **Core Platform ê³µí†µ ë¡œì§**ì´ë‹¤.
- ì—…ì¢…ë³„ ì°¨ì´ëŠ” ë¡œì§ì´ ì•„ë‹ˆë¼ **Adapter + Schema ë ˆì´ì–´**ì—ì„œë§Œ í—ˆìš©ëœë‹¤.
- ì—…ì¢…ë³„ ì‹ ê·œ ìë™í™” ì—”ì§„ ë˜ëŠ” AI ì—”ì§„ì„ ìƒì„±í•˜ëŠ” í–‰ìœ„ëŠ” ê¸ˆì§€ëœë‹¤.

### í—ˆìš© êµ¬ì¡°
```
Core Automation / AI Engine
 â””â”€ Industry Adapter (academy | salon | nail | ...)
```

### ê¸ˆì§€ êµ¬ì¡°
- ì—…ì¢…ë³„ Automation Engine âŒ
- ì—…ì¢…ë³„ AI Engine âŒ
- ì—…ì¢…ë³„ í•˜ë“œì½”ë”© ì¡°ê±´ âŒ

ë³¸ ê·œì¹™ì€ ëª¨ë“  ë¬¸ì„œì™€ êµ¬í˜„ì˜ ì •ë³¸(SSOT)ì´ë‹¤.

### AI Engine Architecture (SSOT)

AI ê¸°ëŠ¥ì€ ë‹¤ìŒ 2ê³„ì¸µìœ¼ë¡œ êµ¬ì„±ëœë‹¤.

1. **Core AI Engine**
- ìš”ì•½, íŒ¨í„´ ê°ì§€, ë¦¬í¬íŠ¸ ìƒì„±, ì´ìƒ íƒì§€
- ì—…ì¢… ë¹„ì˜ì¡´
- ëª¨ë¸ í˜¸ì¶œ / í”„ë¡¬í”„íŠ¸ / ê²°ê³¼ í¬ë§· ê³µí†µ

2. **Industry Adapter**
- ì—…ì¢…ë³„ ë°ì´í„° ë§¤í•‘
- ìš©ì–´ ì¹˜í™˜
- ê°€ì¤‘ì¹˜ ì„¤ì •
- UI Label ë³€í™˜

âš ï¸ AI íŒë‹¨ ë° ì‹¤í–‰ ë¡œì§ì€ Core Engineì—ë§Œ ì¡´ì¬í•œë‹¤.

### Edge Functions Industry Adapter êµ¬í˜„ (SSOT)

Edge Functionsì—ì„œ ì—…ì¢…ë³„ í…Œì´ë¸”ëª… ë° FK ê´€ê³„ëª…ì„ ë™ì ìœ¼ë¡œ ë§¤í•‘í•˜ê¸° ìœ„í•œ Industry Adapterê°€ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

**êµ¬í˜„ ìœ„ì¹˜:**
- `infra/supabase/functions/_shared/industry-adapter.ts`

**ì£¼ìš” ê¸°ëŠ¥:**
1. **í…Œì´ë¸”ëª… ë™ì  ë§¤í•‘**
   - `getTenantTableName(supabase, tenantId, entityType)`: í…Œë„ŒíŠ¸ì˜ industry_typeì— ë”°ë¼ ì—”í‹°í‹° íƒ€ì…('student', 'class' ë“±)ì„ ì—…ì¢…ë³„ í…Œì´ë¸”ëª…ìœ¼ë¡œ ë³€í™˜
   - ì˜ˆ: `academy` â†’ `academy_students`, `salon` â†’ `salon_customers`

2. **FK ê´€ê³„ëª… ë™ì  ë§¤í•‘**
   - `getFKRelationName(fkKey, industryType)`: ì—…ì¢…ë³„ FK ê´€ê³„ëª…ì„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ì¡°íšŒ
   - ì§€ì› FK í‚¤: `attendance_logs_class_id`, `student_classes_class_id`, `student_classes_student_id`, `class_sessions_class_id`, `invoices_student_id`, `student_person_id`, `class_teacher_id`

3. **ì—…ì¢… íƒ€ì… ì¡°íšŒ**
   - `getTenantIndustryType(supabase, tenantId)`: í…Œë„ŒíŠ¸ì˜ industry_type ì¡°íšŒ

**ì‚¬ìš© ê·œì¹™:**
- âŒ í•˜ë“œì½”ë”©ëœ í…Œì´ë¸”ëª… ì‚¬ìš© ê¸ˆì§€ (ì˜ˆ: `'academy_students'`, `'academy_classes'`)
- âœ… Industry Adapter í•¨ìˆ˜ ì‚¬ìš© í•„ìˆ˜
- âœ… Fail-Closed ì›ì¹™: ë§¤í•‘ ì‹¤íŒ¨ ì‹œ null ë°˜í™˜, fallback íŒ¨í„´ ì‚¬ìš©

**ì‚¬ìš© ì˜ˆì‹œ:**
```typescript
import { getTenantTableName, getTenantIndustryType, getFKRelationName } from '../_shared/industry-adapter.ts';

// í…Œì´ë¸”ëª… ë™ì  ì¡°íšŒ
const studentTableName = await getTenantTableName(supabase, tenant_id, 'student');
const classTableName = await getTenantTableName(supabase, tenant_id, 'class');

// FK ê´€ê³„ëª… ë™ì  ì¡°íšŒ
const industryType = await getTenantIndustryType(supabase, tenant_id);
const classFKName = getFKRelationName('attendance_logs_class_id', industryType) ||
  'academy_classes!attendance_logs_class_id_fkey'; // Fallback

// ì¿¼ë¦¬ ì‹¤í–‰
const { data } = await withTenant(
  supabase
    .from(studentTableName || 'academy_students') // Fallback
    .select(`*`),
  tenant_id
);
```

**ì ìš© ë²”ìœ„:**
- ëª¨ë“  Edge Functionsì—ì„œ ì—…ì¢…ë³„ í…Œì´ë¸”ëª… ì‚¬ìš© ì‹œ í•„ìˆ˜
- L0 í•¸ë“¤ëŸ¬ (`l0-handlers.ts`): ëª¨ë“  í•¸ë“¤ëŸ¬ì—ì„œ ì ìš© ì™„ë£Œ
- Task ì‹¤í–‰ í•¸ë“¤ëŸ¬ (`execute-student-task/handlers/*`): ëª¨ë“  í•¸ë“¤ëŸ¬ì—ì„œ ì ìš© ì™„ë£Œ
- ìë™í™” Edge Functions: ëª¨ë“  ìë™í™” í•¨ìˆ˜ì—ì„œ ì ìš© ì™„ë£Œ

### UI Component Industry-Neutral Rule

AI ê´€ë ¨ UI ì»´í¬ë„ŒíŠ¸(ChatOpsPanel, ExecutionAuditPanel, AILayerMenu)ë„ ì—…ì¢…ì— ì¢…ì†ë˜ì§€ ì•Šìœ¼ë©°, ëª¨ë“  ì—…ì¢…ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ë¶ˆë³€ ì›ì¹™:**
- AI UI ì»´í¬ë„ŒíŠ¸ëŠ” `packages/ui-core/src/components/`ì— ìœ„ì¹˜í•˜ë©°, ì—…ì¢… ë…ë¦½ì ìœ¼ë¡œ ì„¤ê³„ë©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ ì°¨ì´ëŠ” propì„ í†µí•œ í™•ì¥ í¬ì¸íŠ¸(`onViewTaskCard`, `onChatOpsViewTaskCard` ë“±)ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ í•˜ë“œì½”ë”©ëœ ë¼ìš°íŒ… ê²½ë¡œë‚˜ CSS í´ë˜ìŠ¤ëŠ” ê¸ˆì§€ë©ë‹ˆë‹¤.

**êµ¬í˜„ ìœ„ì¹˜:**
- `ChatOpsPanel`: `packages/ui-core/src/components/ChatOpsPanel.tsx`
- `ExecutionAuditPanel`: `packages/ui-core/src/components/ExecutionAuditPanel.tsx`
- `AILayerMenu`: `packages/ui-core/src/components/AILayerMenu.tsx`

**ì—…ì¢…ë³„ í™•ì¥ ë°©ë²•:**
- ì—…ì¢…ë³„ ë¼ìš°íŒ…ì€ `AppLayout`ì—ì„œ `onChatOpsViewTaskCard` propì„ í†µí•´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ ë¼ë²¨/ìš©ì–´ëŠ” Industry Adapterë¥¼ í†µí•´ ë³€í™˜ë©ë‹ˆë‹¤.

### Automation Policy Schema Rule

ìë™í™” ì„¤ì •(Policy)ì€ ì—…ì¢…ê³¼ ë¬´ê´€í•œ **ì¤‘ë¦½ ìŠ¤í‚¤ë§ˆ**ë¡œ ì •ì˜ëœë‹¤.

- Schema KeyëŠ” ì—…ì¢… ìš©ì–´ë¥¼ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.
- UI Labelë§Œ Industry Adapterì—ì„œ ë³€í™˜ëœë‹¤.
- tenant_settings JSONì€ ì—…ì¢… ê³µí†µ êµ¬ì¡°ë¥¼ ê°€ì§„ë‹¤.

ì˜ˆ:
- academy: "ì¶œê²° ì´ìƒ"
- salon: "ë°©ë¬¸ ì´ìƒ"
â†’ ë‚´ë¶€ ì •ì±… í‚¤ëŠ” ë™ì¼í•˜ë‹¤.

## âœ… ì„¤ì • ì €ì¥ SSOT (Single Source of Truth)

âš ï¸ ëª¨ë“  ìë™í™” ì„¤ì •ì€ ì•„ë˜ ê·œê²©ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.

ì €ì¥ì†Œ ë° ê²½ë¡œ ê·œê²©
- ì €ì¥ì†Œ: tenant_settings KV êµ¬ì¡° (key='config' rowì˜ value JSONB)
  - tenant_settings í…Œì´ë¸”ì€ (tenant_id, key, value JSONB) KV êµ¬ì¡°ì…ë‹ˆë‹¤.
  - âš ï¸ ì¤‘ìš”: `config`ëŠ” ì»¬ëŸ¼ì´ ì•„ë‹ˆë¼ key='config'ì¸ rowì˜ value(JSONB)ì…ë‹ˆë‹¤. `tenant_settings.auto_notification.*` ê°™ì€ top-level ì»¬ëŸ¼ í‘œê¸° ê¸ˆì§€
- ìë™í™” ì •ì±… ê²½ë¡œ: auto_notification.<event_type>.(enabled|channel|template_key|throttle|...)
- ì½”ë“œì—ì„œ ì„¤ì • ì½ê¸°:
  - ì„œë²„/Edge Function: getTenantSettingByPath(supabase, tenantId, path, legacyPath?) í˜•ì‹ ì‚¬ìš©
    - ì˜ˆ: await getTenantSettingByPath(supabase, tenantId, "auto_notification.overdue_outstanding_over_limit.enabled")
    - ì‹œê·¸ë‹ˆì²˜: (supabase: SupabaseClient, tenantId: string, path: string, legacyPath?: string) => Promise<unknown>
    - ë°˜í™˜ íƒ€ì…: `unknown` (ì‹¤ì œ êµ¬í˜„ íƒ€ì…) â†’ ì‚¬ìš© ì‹œ íƒ€ì… ìºìŠ¤íŒ… í•„ìš” (ì˜ˆ: `as boolean`, `as number`)
    - ë°˜í™˜ ê°’ ì˜ë¯¸: Policyê°€ ì—†ìœ¼ë©´ `null`, ìˆìœ¼ë©´ ì§ì ‘ ê°’ `T` ë°˜í™˜ (`.value` ì ‘ê·¼ ë¶ˆí•„ìš”)
    - í”„ë¡ íŠ¸ì—”ë“œ Hook useTenantSettingByPath: UseQueryResult<unknown, Error> ë°˜í™˜ (React Queryì˜ useQuery ë°˜í™˜ ê°ì²´)
      - ì‚¬ìš© ì˜ˆì‹œ: const { data: enabledValue } = useTenantSettingByPath("auto_notification.overdue.enabled");
    - í”„ë¡ íŠ¸ì—”ë“œ SSOT ìœ í‹¸ë¦¬í‹° (apps/academy-admin/src/utils):
      - âš ï¸ Policy ì¡°íšŒ SSOT: getPolicyValueFromConfig<T>(config, path) í•¨ìˆ˜ ì‚¬ìš© (SSOT ìœ„ì¹˜: apps/academy-admin/src/utils/policy-utils.ts)
        - ì‚¬ìš© ì˜ˆì‹œ: import { getPolicyValueFromConfig } from '../utils'; const threshold = getPolicyValueFromConfig<number>(config, 'auto_notification.overdue.threshold');
      - âš ï¸ Policy Registry SSOT: POLICY_REGISTRY ë° getPolicyValue<T>(key, config) í•¨ìˆ˜ ì‚¬ìš© (SSOT ìœ„ì¹˜: apps/academy-admin/src/utils/policy-registry.ts)
        - Policy ì†ŒìŠ¤ ì´ì›í™” ë¬¸ì œ í•´ê²°: ëª¨ë“  Policyë¥¼ Registryì— ë“±ë¡í•˜ì—¬ ë‹¨ì¼ ì†ŒìŠ¤ë¡œ í†µì¼
        - ì‚¬ìš© ì˜ˆì‹œ: import { getPolicyValue, POLICY_REGISTRY } from '../utils'; const threshold = getPolicyValue<number>('PAYMENT_FAILED_THRESHOLD', config);
        - âš ï¸ EMERGENCY_CARDS_POLICY_PATHS ë³€ê²½ì‚¬í•­: apps/academy-admin/src/constants/emergency-cards-policy.tsì˜ EMERGENCY_CARDS_POLICY_PATHSëŠ” POLICY_REGISTRYë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¬ì •ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ exportëŠ” ìœ ì§€í•˜ë˜, ì‹ ê·œ ì½”ë“œì—ì„œëŠ” POLICY_REGISTRYë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      - âš ï¸ Barrel Export íŒ¨í„´: ëª¨ë“  ìœ í‹¸ë¦¬í‹°ëŠ” apps/academy-admin/src/utils/index.tsë¥¼ í†µí•´ export (SSOT)
        - ì‚¬ìš© ì˜ˆì‹œ: import { getPolicyValueFromConfig, getPolicyValue, safe, normalizeDashboardCard } from '../utils';
      - âš ï¸ Constants Barrel Export íŒ¨í„´: ëª¨ë“  ìƒìˆ˜ëŠ” apps/academy-admin/src/constants/index.tsë¥¼ í†µí•´ export (SSOT)
        - ì‚¬ìš© ì˜ˆì‹œ: import { POLICY_KEY_V2_CATEGORIES, AUTOMATION_EVENT_CRITERIA_FIELDS, AUTOMATION_EVENT_DESCRIPTIONS, validateAutomationEventDescriptions } from '../constants';
        - Automation Event ê´€ë ¨ ìƒìˆ˜ì™€ ê²€ì¦ í•¨ìˆ˜ëŠ” ì´ íŒŒì¼ì„ í†µí•´ export
      - data ì†ì„±: T | null (Policyê°€ ì—†ìœ¼ë©´ null, ìˆìœ¼ë©´ ì§ì ‘ ê°’ T, .value ì ‘ê·¼ ë¶ˆí•„ìš”)
      - ì½”ë“œ ìœ„ì¹˜: packages/hooks/use-config/src/useConfig.ts
    - ì½”ë“œ ìœ„ì¹˜: infra/supabase/functions/_shared/policy-utils.ts
    - âš ï¸ **ìë™ ê²€ì¦ (êµ¬í˜„ ìƒíƒœ)**: `getTenantSettingByPath()` í•¨ìˆ˜ëŠ” `auto_notification.<event_type>.*` í˜•ì‹ì˜ ê²½ë¡œë¥¼ ë°›ì„ ë•Œ ìë™ìœ¼ë¡œ event_typeì„ ì¶”ì¶œí•˜ì—¬ ì¹´íƒˆë¡œê·¸ì— ë“±ë¡ëœ ê°’ì¸ì§€ ê²€ì¦í•©ë‹ˆë‹¤ (Fail-Closed, êµ¬í˜„ í™•ì¸: `infra/supabase/functions/_shared/policy-utils.ts:82`ì—ì„œ `assertAutomationEventType` í˜¸ì¶œ).
  - í”„ë¡ íŠ¸ì—”ë“œ: í”„ë¡ íŠ¸ì—”ë“œ ë˜í¼ í•¨ìˆ˜ ì‚¬ìš© (êµ¬í˜„ í•„ìš” ì‹œ packages/hooks/use-config ë˜ëŠ” ìœ ì‚¬ íŒ¨í‚¤ì§€ì—ì„œ ì œê³µ)
    - âš ï¸ í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” ì§ì ‘ getTenantSettingByPathë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©°, React Hook ë˜ëŠ” API í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ ì ‘ê·¼
  - ë‚´ë¶€ ë™ì‘: 1) tenant_settingsì—ì„œ tenant_id + key='config' rowì˜ value(JSONB) íšë“, 2) value(JSONB)ì—ì„œ ê²½ë¡œ ì¶”ì¶œ

âœ… ê¸ˆì§€ ì‚¬í•­
- âŒ tenant_settings.auto_notification.* ì²˜ëŸ¼ config ì—†ì´ top-level ì»¬ëŸ¼ì²˜ëŸ¼ ë³´ì´ëŠ” í‘œê¸° ê¸ˆì§€
- âŒ v1/v2 í‚¤ë¥¼ ì´ì¤‘ ì €ì¥ ê¸ˆì§€ (legacy v1ì€ alias-only, ì €ì¥ ê²½ë¡œë¡œ ì‚¬ìš© ê¸ˆì§€)
- âŒ ì±„ë„ ì½”ë“œ 'kakao' ì €ì¥ ê¸ˆì§€ (SSOT-3: ì €ì¥/ì‹¤í–‰ìš©ì€ 'sms' | 'kakao_at'ë§Œ í—ˆìš©)

## âš ï¸ Policy Key v2 (Purpose-Based) â€” SSOT (ì •ë³¸)

âš ï¸ ì¤‘ìš”: ì •ë³¸ì€ Policy Key v2 6ê°œë§Œ ì‚¬ìš©, legacy_policy_keyëŠ” UI í•„í„°/ê²€ìƒ‰ìš© alias

ë³¸ ì‹œìŠ¤í…œì˜ ìë™í™”ëŠ” Policy Key(v2) 6ê°œë¥¼ ì •ë³¸(SSOT)ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
- ì •ì±… ì €ì¥/ê¶Œí•œ/ë¼ìš°íŒ…/ì„¤ì • UI ê·¸ë£¹í•‘ì€ policy_key_v2ë§Œ ì‚¬ìš©í•œë‹¤.
- ê¸°ì¡´ 5ê°œ Policy KeyëŠ” legacy_policy_key(alias)ë¡œë§Œ ìœ ì§€í•œë‹¤. (ëŸ°íƒ€ì„ SSOT ì•„ë‹˜)
- ì‹ ê·œ ìë™í™” ì¶”ê°€ëŠ” Policy Keyë¥¼ ëŠ˜ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ event_type(ì‹œë‚˜ë¦¬ì˜¤) ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ë¡œë§Œ ìˆ˜í–‰í•œë‹¤. (ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€ = ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`ì— event_type ì¶”ê°€)
- ì„¤ì •ê°’ì´ ì—†ê±°ë‚˜ enabled=falseì´ë©´ ìë™í™”ëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤(Fail-Closed).

### Policy Key v2 (6)
1) financial_health: ì¬ë¬´/í˜„ê¸ˆíë¦„/ìˆ˜ë‚©/ë§¤ì¶œ KPI
2) capacity_optimization: ì •ì›/ì‹œê°„í‘œ/ë°˜ ìš´ì˜ ìµœì í™”
3) customer_retention: ì¶œê²° ìœ ì§€/ì´íƒˆ ì˜ˆë°©/ë¦¬ìŠ¤í¬ ì¼€ì–´
4) growth_marketing: ì‹ ê·œ/ì„±ì¥/ì „í™˜/ì§€ì—­ ê²½ìŸ(ë²¤ì¹˜ë§ˆí‚¹)
5) safety_compliance: ì•ˆì „/ê³µì§€/ë™ì˜/ë¯¼ê°ì •ë³´/ë¶„ìŸ ë¦¬ìŠ¤í¬
6) workforce_ops: ê°•ì‚¬/ì§ì› ìš´ì˜(ì—…ë¬´ëŸ‰/ê²°ê·¼/ëŒ€ì²´)

### Legacy Policy Key(v1, ê¸°ì¡´ 5ê°œ) â€” Alias Only
- attendance_anomaly / payment_overdue / ai_suggestion / report_generation / dashboard_priority(ë¯¸ì‚¬ìš©)
- legacy_policy_keyëŠ” í‘œì‹œ/ê²€ìƒ‰/í˜¸í™˜ì„ ìœ„í•œ ë©”íƒ€ë°ì´í„°ì´ë©°, ì •ì±… ì €ì¥ ê²½ë¡œì˜ SSOTê°€ ì•„ë‹ˆë‹¤.
- ë™ì¼ event_typeì— ëŒ€í•´ v2 ì •ì±…ê³¼ v1 ì •ì±…ì„ ì´ì¤‘ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤(ì„¤ì • ì¤‘ë³µ ê¸ˆì§€).

### í™•ì¥ ê·œì¹™
- ìƒìœ„ Policy Key(v2 6ê°œ)ëŠ” ê³ ì •(SSOT).
- ì‹ ê·œ ìë™í™”ëŠ” event_type ì¹´íƒˆë¡œê·¸ì— ì¶”ê°€í•˜ê³ , policy_key_v2 / legacy_policy_key / level / trigger / executor / policy_pathë¥¼ ì •ì˜í•œë‹¤.
- ë¬¸ì„œ/ì½”ë“œì—ì„œ "í‘œì— ì—†ëŠ” ìë™í™” ì‹ ê·œ ì¶”ê°€ ë¶ˆê°€"ëŠ” "ì¹´íƒˆë¡œê·¸ì— ì—†ëŠ” event_typeì€ ì‹¤í–‰/ì¶”ê°€ ë¶ˆê°€"ë¡œ í•´ì„í•œë‹¤.

### ì½”ë“œ SSOT ìœ„ì¹˜
- âš ï¸ ì¤‘ìš”: ì •ë³¸(SSOT)ì€ ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`, ë¬¸ì„œì˜ í‘œëŠ” ê·¸ ì¶œë ¥ë¬¼
- event_type ì¹´íƒˆë¡œê·¸ ì •ë³¸(SSOT)ì€ ì½”ë“œ ìƒìˆ˜ `AUTOMATION_EVENT_CATALOG`ì´ë©°, ë¬¸ì„œì˜ í‘œëŠ” ê·¸ ì¹´íƒˆë¡œê·¸ë¥¼ ë°˜ì˜í•œ ì¶œë ¥ë¬¼ì´ë‹¤.
  - **êµ¬í˜„ ìƒíƒœ**: âœ… `AUTOMATION_EVENT_CATALOG` ì½”ë“œ ìƒìˆ˜ êµ¬í˜„ ì™„ë£Œ (2024ë…„ êµ¬í˜„, íŒŒì¼ ê²½ë¡œ: `packages/core/core-automation/src/automation-event-catalog.ts`, `infra/supabase/functions/_shared/automation-event-catalog.ts`, `infra/supabase/supabase/functions/_shared/automation-event-catalog.ts`)
  - ì½”ë“œ ìœ„ì¹˜:
    - packages/core/core-automation/src/automation-event-catalog.ts (Node.js/TypeScript í™˜ê²½, ì •ë³¸)
    - infra/supabase/functions/_shared/automation-event-catalog.ts (Edge Function/Deno í™˜ê²½)
    - infra/supabase/supabase/functions/_shared/automation-event-catalog.ts (re-export íŒŒì¼, ìë™ ë™ê¸°í™”ë¨)
    - âš ï¸ ìˆ˜ì • ì‹œ: 2ê°œ íŒŒì¼(packages + infra/functions/_shared)ë§Œ ì—…ë°ì´íŠ¸í•˜ë©´ ë©ë‹ˆë‹¤. infra/supabase/supabase/functions/_shared/automation-event-catalog.tsëŠ” re-exportì´ë¯€ë¡œ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
  - ì„±ëŠ¥ ìµœì í™”: isAutomationEventType() í•¨ìˆ˜ëŠ” Set ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ O(1) ì‹œê°„ ë³µì¡ë„ë¡œ ê²€ì¦í•©ë‹ˆë‹¤. ë°°ì—´ì˜ includes()ëŠ” O(n)ì´ì§€ë§Œ Setì˜ has()ëŠ” O(1)ì…ë‹ˆë‹¤.
  - ê²€ì¦ í•¨ìˆ˜: apps/academy-admin/src/constants/automation-event-descriptions.tsì˜ validateAutomationEventDescriptions() í•¨ìˆ˜ëŠ” AUTOMATION_EVENT_CRITERIA_FIELDSì™€ AUTOMATION_EVENT_DESCRIPTIONSê°€ AUTOMATION_EVENT_CATALOGì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ ì‚¬ìš© ê¶Œì¥)
- legacy_policy_keyëŠ” UI í•„í„°/ê²€ìƒ‰/í˜¸í™˜ í‘œê¸°ìš©ì´ë©°, ëŸ°íƒ€ì„ ì €ì¥/ì‹¤í–‰/ê¶Œí•œ ë¶„ê¸°ì—ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ì„¤ì • ì €ì¥ì€ tenant_settings KV êµ¬ì¡°ì—ì„œ key='config' rowì˜ value(JSONB) ê²½ë¡œ ê¸°ë°˜ì´ë©°, ì‹ ê·œ í•­ëª©ì€ auto_notification.<event_type>.<field> í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•œë‹¤.
  - ì„œë²„/Edge Function ì½”ë“œ ì˜ˆì‹œ: await getTenantSettingByPath(supabase, tenantId, "auto_notification.overdue_outstanding_over_limit.enabled")
  - ë‚´ë¶€ ë™ì‘: 1) tenant_settingsì—ì„œ key='config' rowì˜ value(JSONB) íšë“, 2) value(JSONB)ì—ì„œ ê²½ë¡œ ì¶”ì¶œ

### ì±…ì„ ê²½ê³„ (Responsibility Boundary)

1) tenant_settings KV: key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œ notification.* (ë©”ì‹œì§€/ì•Œë¦¼ ì¸í”„ë¼ ê¸°ë³¸ ì •ì±…)
  - âš ï¸ ì¤‘ìš”: notification.* ê²½ë¡œëŠ” tenant_settings í…Œì´ë¸”ì˜ key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œì…ë‹ˆë‹¤. ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB)ì…ë‹ˆë‹¤.
- ê¸°ë³¸ ì±„ë„, ë°œì†¡ ì œí•œ, fallback, provider ë“± "ì¸í”„ë¼ ë ˆë²¨" ì •ì±…
- ìë™í™”ë³„ ì˜¤ë²„ë ˆì´ê°€ ì—†ì„ ë•Œ ì‚¬ìš©ë˜ëŠ” ê¸°ë³¸ê°’

2) tenant_settings KV: key='config' rowì˜ value(JSONB) ë‚´ë¶€ ê²½ë¡œ auto_notification.<event_type>.* (ìë™í™”ë³„ ì •ì±… ì˜¤ë²„ë ˆì´)
- ìë™í™” enable/channel/template_key ë“± "event_type ë‹¨ìœ„ ì •ì±…"
- ê° ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„¸ë¶€ ì„¤ì •

3) tenant_features['ai'].enabled (+ PLATFORM_AI_ENABLED)
- AI ì‹¤í–‰/ë¹„ìš©ì´ ê±¸ë¦¬ëŠ” ê¸°ëŠ¥ì˜ ìµœì¢… ìŠ¤ìœ„ì¹˜ (Fail-Closed)
- í”„ë¡ íŠ¸ëŠ” ìˆ¨ê¹€ì´ ì•„ë‹ˆë¼ "í‘œì‹œí•˜ë˜ ì‹¤í–‰ì„ ë§‰ëŠ” ë°©ì‹"ì´ ì›ì¹™

### Industry Expansion Rule (Critical)

ì‹ ê·œ ì—…ì¢…(Salon, Nail ë“±) í™•ì¥ ì‹œ ë‹¤ìŒì„ ê¸ˆì§€í•œë‹¤:

- ì‹ ê·œ ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•
- ì‹ ê·œ AI ë¶„ì„ ì‹œìŠ¤í…œ êµ¬ì¶•
- ì‹ ê·œ ì„¤ì • UI íë¦„ êµ¬ì¶•

í—ˆìš©ë˜ëŠ” ì‘ì—…ì€ ë‹¤ìŒë¿ì´ë‹¤:
- Industry Adapter ì¶”ê°€
- Schema Override ì¶”ê°€
- Label / Copy / ê°€ì¤‘ì¹˜ ì¡°ì •

---

âš ï¸ Architecture v3.3 ì‹¤í–‰ ì£¼ì²´ ë¶„ë¦¬ (ì •ë³¸ ê·œì¹™):

**âš ï¸ ì¤‘ìš”: ìš©ì–´ í†µì¼ ê·œì¹™ (ëª¨ë“  ë¬¸ì„œ ê³µí†µ):**

ë³¸ ë¬¸ì„œì—ì„œ "AIê°€ íŒë‹¨í•˜ì—¬ ì‹¤í–‰í•œë‹¤"ëŠ” í‘œí˜„ì€ **ì˜¤í•´ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ** ë‹¤ìŒìœ¼ë¡œ ëª…í™•íˆ ë¶„ë¦¬í•©ë‹ˆë‹¤:
- **AI/Rule Engine**: íŒë‹¨ ë° ì¶”ì²œ ìƒì„± (ì„œë²„, ì‹¤í–‰ ì•„ë‹˜)
- **Edge Function**: ì‹¤ì œ ì‹¤í–‰ ë° Role ê²€ì¦ (ì„œë²„, ì‹¤í–‰ ì£¼ì²´)
- **í”„ë¡ íŠ¸ì—”ë“œ**: ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘, UI ì¡°ì •, ìŠ¹ì¸ ìš”ì²­ë§Œ (UIëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ, íŒë‹¨í•˜ì§€ ì•ŠìŒ, ê¶Œí•œ ê²€ì¦í•˜ì§€ ì•ŠìŒ)

**ì •ë³¸ í‘œí˜„:**
- âŒ "AIê°€ ìë™ ì‹¤í–‰í•œë‹¤" (ì˜¤í•´ í‘œí˜„)
- âŒ "AIê°€ íŒë‹¨í•˜ê³ , Edge Functionì´ ì‹¤í–‰í•œë‹¤" (ì˜¤í•´ í‘œí˜„, AIëŠ” íŒë‹¨í•˜ì§€ ì•ŠìŒ)
- âœ… "ì„œë²„ê°€ AI ì¶”ì²œ ìƒì„±í•˜ê³ , Edge Functionì´ ì •ì±… í•´ì„ í›„ ì‹¤í–‰í•œë‹¤" (ì •ë³¸ í‘œí˜„)
- âœ… "ì„œë²„ê°€ ì •ì±…ì„ í•´ì„í•˜ì—¬ TaskCardë¥¼ ìƒì„±í•œë‹¤" (ì •ë³¸ í‘œí˜„, ì£¼ì–´ ëª…ì‹œ, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)

âš ï¸ Platform RBAC vs Tenant RBAC ë¶„ë¦¬ ê·œì¹™ (ë³´ì•ˆ ë¶ˆë³€ ê·œì¹™, ëª¨ë“  ë¬¸ì„œ ê³µí†µ):

**meta.schema_registryëŠ” Platform ê¶Œí•œ(user_platform_roles)ìœ¼ë¡œë§Œ í†µì œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.**
- âœ… **í—ˆìš©**: `user_platform_roles.role = 'super_admin'` ë˜ëŠ” `'developer'` ë˜ëŠ” `'qa'`
- âŒ **ê¸ˆì§€**: `user_tenant_roles` ê¸°ë°˜ ì ‘ê·¼ (í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€)
- âš ï¸ ì¤‘ìš”: ì´ ê·œì¹™ì€ "í•œ ë¬¸ì„œì˜ ì˜ˆì‹œ"ê°€ ì•„ë‹ˆë¼, **ì „ êµ¬ê°„ ê³µí†µ SSOT ë¸”ë¡(= ë³´ì•ˆ ë¶ˆë³€ ê·œì¹™)**ì…ë‹ˆë‹¤.

**ğŸ”¥ Critical ë³´ì•ˆ ê²½ê³  (ì¦‰ì‹œ ìˆ˜ì • ê¶Œì¥):**

í˜„ì¬ RLS.txtì˜ `meta.schema_registry` ì •ì±…ì—ëŠ” **fallback ë¡œì§**ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤:
```sql
OR (NOT (EXISTS ( SELECT 1 FROM information_schema.tables WHERE ... user_platform_roles ...)))
```

ì´ fallbackì€ `user_platform_roles` í…Œì´ë¸”ì´ ì—†ì„ ê²½ìš° **ëª¨ë“  authenticated ì‚¬ìš©ìì—ê²Œ ì ‘ê·¼ì„ í—ˆìš©**í•˜ëŠ” ì¹˜ëª…ì ì¸ ë³´ì•ˆ ì·¨ì•½ì ì…ë‹ˆë‹¤.

**ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”:**
1. âŒ **fallback ë¡œì§ ì œê±° í•„ìˆ˜**: `meta.schema_registry`ëŠ” ë¬´ì¡°ê±´ `user_platform_roles` ì¡´ì¬ ì „ì œ
2. âœ… **ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ ë³´ì¥**: `user_platform_roles` í…Œì´ë¸” ìƒì„± â†’ RLS ì •ì±… ì ìš© ìˆœì„œ í•„ìˆ˜
3. âœ… **CI Contract Test ê°•ì œ**: ë¬¸ì„œì— ì •ì˜ëœ ê³„ì•½ í…ŒìŠ¤íŠ¸ë¥¼ CIì— í¬í•¨í•˜ì—¬ ë³´ì•ˆ ì‚¬ê³  ë°©ì§€
4. âš ï¸ **ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ê²½**: ê°œë°œ/ìŠ¤í…Œì´ì§• í™˜ê²½ì—ì„œë„ fallback ì—†ì´ í…ŒìŠ¤íŠ¸ í•„ìˆ˜

**ì •ë³¸ RLS ì •ì±… (fallback ì œê±°):**
```sql
-- âŒ ê¸ˆì§€: fallback ë¡œì§ í¬í•¨
-- OR (NOT (EXISTS ( SELECT 1 FROM information_schema.tables WHERE ... user_platform_roles ...)))

-- âœ… ì •ë³¸: user_platform_roles ì¡´ì¬ ì „ì œ
CREATE POLICY schema_registry_read ON meta.schema_registry
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM user_platform_roles
    WHERE user_id = auth.uid()
      AND role IN ('super_admin', 'developer', 'qa')
  )
);
```

**ê³„ì•½ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ (Contract Test, í•„ìˆ˜):**

ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ëŠ” CI/CD íŒŒì´í”„ë¼ì¸ì— í¬í•¨ë˜ì–´ì•¼ í•˜ë©°, ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤:

| í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ | ê¸°ëŒ€ ê²°ê³¼ | ì„¤ëª… |
|------------|---------|------|
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` SELECT ì‹œë„ | 403 Forbidden ë˜ëŠ” ë¹ˆ ê²°ê³¼ì…‹ | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` INSERT ì‹œë„ | 403 Forbidden | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` UPDATE ì‹œë„ | 403 Forbidden | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_tenant_roles`ë§Œ ê°€ì§„ ì‚¬ìš©ìê°€ `meta.schema_registry` DELETE ì‹œë„ | 403 Forbidden | âš ï¸ ì •ë³¸ ê·œì¹™: `meta.schema_registry`ëŠ” `user_platform_roles`ë§Œ ì ‘ê·¼ ê°€ëŠ¥, í…Œë„ŒíŠ¸ ê¶Œí•œìœ¼ë¡œëŠ” ì ˆëŒ€ ì ‘ê·¼ ë¶ˆê°€ |
| `user_platform_roles.role = 'super_admin'` ì‚¬ìš©ìê°€ SELECT | ì„±ê³µ (ë°ì´í„° ë°˜í™˜) | Platform ê¶Œí•œ í—ˆìš© |
| `user_platform_roles.role = 'developer'` ì‚¬ìš©ìê°€ SELECT | ì„±ê³µ (ë°ì´í„° ë°˜í™˜) | Platform ê¶Œí•œ í—ˆìš© |
| `user_platform_roles.role = 'qa'` ì‚¬ìš©ìê°€ SELECT | ì„±ê³µ (ë°ì´í„° ë°˜í™˜) | Platform ê¶Œí•œ í—ˆìš© |
| `user_platform_roles.role = 'super_admin'` ì‚¬ìš©ìê°€ INSERT/UPDATE/DELETE | ì„±ê³µ | Platform ê¶Œí•œ í—ˆìš© |

âš ï¸ ì¤‘ìš”: ì´ í…ŒìŠ¤íŠ¸ë“¤ì€ RLS ì •ì±…ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ ê²€ì¦í•˜ë©°, ë³´ì•ˆ ì‚¬ê³ ë¥¼ ì‚¬ì „ì— ë°©ì§€í•©ë‹ˆë‹¤.

**âš ï¸ Platform RBAC ì ìš© ë²”ìœ„ (super_admin ìš°íšŒ í•„ìš” í…Œì´ë¸” ëª©ë¡):**

ë‹¤ìŒ í…Œì´ë¸”ë“¤ì€ ìš´ì˜/ì¥ì•  ëŒ€ì‘/ê³ ê°ì§€ì›ì„ ìœ„í•´ `super_admin` ìš°íšŒê°€ í•„ìš”í•©ë‹ˆë‹¤:
- âœ… **persons**: Core Party ëª¨ë¸, ë‹¤ì¤‘ í…Œë„ŒíŠ¸ ë°ì´í„° ê´€ë¦¬ í•„ìš”
- âœ… **meta.schema_registry**: í”Œë«í¼ ì „ì²´ ìŠ¤í‚¤ë§ˆ ê´€ë¦¬
- âœ… **tenant_schema_pins**: í…Œë„ŒíŠ¸ë³„ ìŠ¤í‚¤ë§ˆ í•€ ê´€ë¦¬

**âš ï¸ notification_templates ì •ì±… ëª…í™•í™”:**

`notification_templates` í…Œì´ë¸”ì€ **ì˜ë„ì ìœ¼ë¡œ tenant roleë§Œìœ¼ë¡œ ì œí•œ**ë©ë‹ˆë‹¤ (super_admin ìš°íšŒ ì—†ìŒ):
- **ì •ì±… ì˜ë„**: í…Œë„ŒíŠ¸ë³„ í…œí”Œë¦¿ì€ í…Œë„ŒíŠ¸ ì†Œìœ ì(owner/admin)ê°€ ê´€ë¦¬í•˜ë©°, ìš´ì˜ì ê°œì…ì„ ìµœì†Œí™”
- **í˜„ì¬ RLS**: `user_tenant_roles` ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (owner/admin/sub_adminë§Œ ìˆ˜ì • ê°€ëŠ¥)
- **super_admin ìš°íšŒ**: ì—†ìŒ (ì˜ë„ì  ì œí•œ)
- **ìš´ì˜ í•„ìš” ì‹œ**: ë³„ë„ ê²€í†  í›„ ì •ì±… ë³€ê²½ ê°€ëŠ¥í•˜ë‚˜, í˜„ì¬ëŠ” ì˜ë„ì ìœ¼ë¡œ ì œí•œë¨

âš ï¸ ì°¸ê³ : RLS.txtì—ì„œ `super_admin` ìš°íšŒê°€ ì—†ëŠ” í…Œì´ë¸”ì€ ì˜ë„ì ìœ¼ë¡œ ì œí•œëœ ê²ƒì´ë©°, ìš´ì˜ í•„ìš” ì‹œ ë³„ë„ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.

**âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ ì—­í•  ì¬ì •ì˜ (í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ SSOT):**
- âœ… **ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘** (Context Signal Collection)
- âœ… **UI ì¡°ì •** (Priority ê°€ì¤‘ì¹˜, ë°°ë„ˆ í‘œì‹œ)
- âœ… **ìŠ¹ì¸ ìš”ì²­** (Approval Request)
- âŒ **íŒë‹¨** (Judgment) - ì„œë²„/Edge Function ì „ë‹´
- âŒ **ì‹¤í–‰** (Execution) - ì„œë²„/Edge Function ì „ë‹´
- âŒ **ê¶Œí•œ ê²€ì¦** (Authorization) - ì„œë²„/RLS ì „ë‹´

**ìš©ì–´ í†µì¼:**
- ~~"AI Suggestion"~~ (v2.x ì‚­ì œ) = TaskCard (task_type: 'ai_suggested', entity_type='student') (ì •ë³¸, StudentTaskCardëŠ” í•™ìƒìš© ë³„ì¹­)
- "ìë™ ì‹¤í–‰" = ì„œë²„ê°€ ì •ì±… í•´ì„ í›„ ìƒì„± ë° ì‹¤í–‰
- "í”„ë¡ íŠ¸ ìŠ¹ì¸" = ìŠ¹ì¸ ìš”ì²­ (ì‹¤í–‰ì€ ì„œë²„)

âš ï¸ ì¤‘ìš”: êµ¬í˜„ ê°€ì´ë“œë¼ì¸ (1ì¸ ê°œë°œì‚¬/ì†Œê·œëª¨ íŒ€ í˜„ì‹¤ì  ë²”ìœ„)

ì´ ë¬¸ì„œëŠ” ìµœì¢… ëª©í‘œ(20,000~30,000+ í…Œë„ŒíŠ¸)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë‚˜, 1ì¸ ê°œë°œì‚¬/ì†Œê·œëª¨ íŒ€ í™˜ê²½ì„ ê³ ë ¤í•˜ì—¬ í˜„ì‹¤ì  ë²”ìœ„ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.

ìƒìš©í™” ë‹¨ê³„ (í•„ìˆ˜ ê¸°ëŠ¥ + í™•ì¥ ê¸°ëŠ¥):
- âœ… ê¸°ë³¸ ë©€í‹°í…Œë„ŒíŠ¸ (RLS + tenant_id)
- âœ… ê¸°ë³¸ ì¸ì¦/ê¶Œí•œ
- âœ… ê¸°ë³¸ ê²°ì œ/ì•Œë¦¼ë±…í‚¹ (ë‹¨ì¼ Provider)
- âœ… ê¸°ë³¸ Analytics (ê°„ë‹¨í•œ ì§‘ê³„, Supabase Edge Function ì‚¬ìš©)
- âš ï¸ ì§€ì—­ ê¸°ë°˜ í†µê³„ (ê¸°ë³¸ ê¸°ëŠ¥: ì§€ì—­ìˆœìœ„, ì§€ì—­ í‰ê·  ëŒ€ë¹„ ë¹„êµ, ê¸°ë³¸ íˆíŠ¸ë§µ) - ìƒìš©í™” ë‹¨ê³„ êµ¬í˜„ ì˜ˆì • (í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜ ì™„ë£Œ, core_stores/core_regions ë° analytics.daily_store_metrics/daily_region_metrics í…Œì´ë¸” ìƒì„± ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)
- âœ… AI ë¶„ì„ ê¸°ëŠ¥ (ê¸°ë³¸ ì¸ì‚¬ì´íŠ¸: ìƒë‹´ì¼ì§€ ìš”ì•½, ì¶œê²° ì´ìƒ íƒì§€, ê¸°ë³¸ ë¦¬í¬íŠ¸)
- âœ… ê¸°ë³¸ Public Gateway
- âœ… ê¸°ë³¸ Custom Domain (ìˆ˜ë™ ê´€ë¦¬)
- âœ… ê¸°ë³¸ ëª¨ë‹ˆí„°ë§
- âš ï¸ Analytics ì™¸ë¶€ ì›Œì»¤ (Lambda/Workers) - ì„¤ê³„ ì™„ë£Œ, êµ¬í˜„ ì˜ˆì •
- âœ… Edge Function Role ë¶„ë¦¬
- âš ï¸ Custom Domain ìë™í™” - ìš´ì˜ ê·œì¹™ ì •ì˜ ì™„ë£Œ, êµ¬í˜„ ì˜ˆì •
- âœ… ê³ ê¸‰ ìºì‹œ ë¬´íš¨í™”
- âœ… PII ë§ˆìŠ¤í‚¹ ê°•í™”
- âš ï¸ ì§€ì—­ ê¸°ë°˜ í†µê³„ ê³ ê¸‰ ê¸°ëŠ¥ (ê³ ê¸‰ íˆíŠ¸ë§µ, ë‹¤ì¤‘ ì§€ì—­ ë¹„êµ, AI ì¸ì‚¬ì´íŠ¸ ê³ ë„í™”) - ìƒìš©í™” ë‹¨ê³„ êµ¬í˜„ ì˜ˆì •
- âš ï¸ ì§€ë„ ê¸°ë°˜ ë§¤ì¥ ë¶„í¬ ì‹œê°í™” (ê³ ê¸‰) - ìƒìš©í™” ë‹¨ê³„ êµ¬í˜„ ì˜ˆì •
- âš ï¸ ì™¸ë¶€ ê²€ìƒ‰ ì—”ì§„ (Meilisearch/Algolia) - Phase 1 ì™„ë£Œ (PostgreSQL FTS), Phase 2+ ê²€í†  ì˜ˆì •

ì„ íƒì  êµ¬í˜„ (ì‹¤ì œ í•„ìš” ì‹œ ë„ì…):
- âš ï¸ Multi-Region DR (ì™¸ë¶€ DB ì‚¬ìš© ì‹œ, ë‚œì´ë„: ì¤‘)
  â†’ ì™¸ë¶€ PostgreSQL ì†”ë£¨ì…˜(Neon, AWS RDS, Aurora) ê¸°ë°˜ DR ë„ì…
  â†’ Supabase ë‹¨ì¼ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ ì™¸ë¶€ DB ì „í™˜ í•„ìš”
- âš ï¸ PII AEAD ì•”í˜¸í™” (ê¸ˆìœµì¸ì¦ í•„ìš” ì‹œ)
- âš ï¸ KMS í‚¤ íšŒì „ (ê¸ˆìœµì¸ì¦ í•„ìš” ì‹œ)
- âš ï¸ ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ (ì‹¤ì œ ë°ì´í„°ëŸ‰ í­ì¦ ì‹œ)
- âš ï¸ ì´ì¤‘ íŒŒí‹°ì…”ë‹ (ì‹¤ì œ í•„ìš” ì‹œ)

ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤ (í˜„ì¬ ë¶ˆí•„ìš”, 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ ë¹„í˜„ì‹¤ì ):
- âŒ Multi-Region + ìƒ¤ë”© í†µí•© êµ¬ì¡° (ë‚œì´ë„: ë§¤ìš° ë†’ìŒ, ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤)
- âŒ WebAuthn/Passkey (ìš°ì„ ìˆœìœ„ ë‚®ìŒ)
- âŒ Hot Tenant ìˆ˜ì§ ìƒ¤ë”© (CDC ë™ê¸°í™”, conflict í•´ê²°, routing layer, ì˜êµ¬ ë¶„ë¦¬ ì •ì±… ë“± ë³µì¡ë„ ë§¤ìš° ë†’ìŒ)
- âŒ Shard ì¬ì¡°ì • (ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸ ê·œëª¨ì—ì„œë§Œ í•„ìš”)
- âŒ CDC ê¸°ë°˜ ìƒ¤ë”© ìë™í™” (ìš´ì˜ ë³µì¡ë„ ë§¤ìš° ë†’ìŒ)

âš ï¸ ì¤‘ìš”: 1ì¸ ê°œë°œì‚¬/ì†Œê·œëª¨ íŒ€ í˜„ì‹¤ì„± ê³ ë ¤:
- ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ìœ„ì˜ í•„ìˆ˜ ê¸°ëŠ¥ + í™•ì¥ ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.
- ì„ íƒì  êµ¬í˜„ì€ ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ í›„ì—ë§Œ ë„ì…í•©ë‹ˆë‹¤ (ì˜ˆ: ê¸ˆìœµì¸ì¦ í•„ìš” ì‹œ PII ì•”í˜¸í™”, ì™¸ë¶€ DB ì „í™˜ í•„ìš” ì‹œ Multi-Region DR).
- ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ëŠ¥ì€ í˜„ì¬ ì‚¬ì—… ëª©í‘œ(2~3ë§Œ í…Œë„ŒíŠ¸)ë¥¼ ë„˜ì–´ì„œëŠ” ê·œëª¨ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”í•˜ë¯€ë¡œ, 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ì´ ë¹„í˜„ì‹¤ì ì…ë‹ˆë‹¤.

â†’ ê° ì„¹ì…˜ì— "ì„ íƒì  êµ¬í˜„" ë˜ëŠ” "ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤" í‘œì‹œê°€ ìˆëŠ” ê²½ìš°, ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” êµ¬í˜„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ğŸ“˜ PART 1
ì „ì²´ ì•„í‚¤í…ì²˜ / Monorepo / ë©€í‹°í…Œë„ŒíŠ¸ / DB ëª¨ë¸

0. ëª©í‘œ & ì»¨ì…‰

ì´ í”Œë«í¼ì€ ë‹¨ì¼ Supabase + ë‹¨ì¼ PostgreSQL ìœ„ì—ì„œ
í•™ì›Â·ë¯¸ìš©ì‹¤Â·ë„¤ì¼ìƒµÂ·ë¶€ë™ì‚°Â·ì²´ìœ¡ê´€Â·ë¹„ì˜ë¦¬ ê¸°ê´€ ë“± ì—¬ëŸ¬ ì—…ì¢… SaaSë¥¼ ë™ì‹œì— ìš´ì˜í•˜ëŠ” êµ¬ì¡°ë¥¼ ëª©í‘œë¡œ í•œë‹¤.

ğŸ¯ ìµœì¢… ëª©í‘œ

í•™ì› 10,000ê°œ, ë¶€ë™ì‚° 10,000ê°œ, ê¸°íƒ€ ì—…ì¢… ìˆ˜ì²œ ê°œ

í•©ê³„ 20,000~30,000+ í…Œë„ŒíŠ¸ ìš´ì˜ ê°€ëŠ¥í•œ êµ¬ì¡°

ë‹¨ì¼ ì½”ë“œë² ì´ìŠ¤(Monorepo)ì—ì„œ ì—…ì¢…ë³„ SaaSë¥¼ ë²„íŠ¼ì²˜ëŸ¼ ìƒì„±

ê³µí†µ Core Platform ëª¨ë“ˆì„ ê³µìœ í•˜ë©´ì„œ ì—…ì¢…ë³„ ê¸°ëŠ¥ì€ Industry Layerë¡œ ì°¨ë³„í™”

ëª¨ë°”ì¼Â·íƒœë¸”ë¦¿ ì™„ë²½ ëŒ€ì‘

ë‹¤í¬ëª¨ë“œ, UI í™•ëŒ€(Zoom) ê¸°ë³¸ ì§€ì›

íš¨ì„±FMS ì•Œë¦¼ë±…í‚¹ ì—°ë™(Payments Provider) ì „ ì—…ì¢… ê³µí†µ ì§€ì›

ì¥ê¸°ì ìœ¼ë¡œëŠ” íŒŒí‹°ì…”ë‹ â†’ ë¦¬ë“œ ë ˆí”Œë¦¬ì¹´ â†’ ìƒ¤ë”©ê¹Œì§€ í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°

âš ï¸ ì£¼ì˜: ë¦¬ì „ ë¶„ë¦¬ëŠ” Supabaseì—ì„œ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, Multi-Regionì´ í•„ìš”í•œ ê²½ìš° ì™¸ë¶€ PostgreSQL ì†”ë£¨ì…˜(Neon, AWS RDS, Aurora) ì‚¬ìš© í•„ìˆ˜

íƒ€ì„ì¡´ ì •ì±… (KST í‘œì¤€):

ëª¨ë“  ì‹œê°„ì€ DBì—ëŠ” UTCë¡œ ì €ì¥í•˜ë˜, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§Â·í‘œì‹œÂ·ì§‘ê³„ëŠ” KST ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.

â†’ ìƒì„¸ ê·œì¹™ì€ PART 5 '19-1. íƒ€ì„ì¡´(KST) í‘œì¤€' ì„¹ì…˜ ì°¸ì¡°

ì—¬ê¸°ì„œ ë§í•˜ëŠ” "ë‹¨ì¼ Supabase + ë‹¨ì¼ PostgreSQL"ì€ ìš´ì˜(prod) í™˜ê²½ ê¸°ì¤€ì´ë©°, dev/staging í™˜ê²½ì€ ë³„ë„ í”„ë¡œì íŠ¸/DBë¡œ ë¶„ë¦¬ ìš´ì˜í•˜ëŠ” ê²ƒì„ ì „ì œë¡œ í•œë‹¤.

ğŸ“Œ Supabase Multi-Region ì œì•½ ìš”ì•½ (Critical - ì¦‰ì‹œ ìˆ˜ì •)

âš ï¸ ì¤‘ìš”: SupabaseëŠ” ê³µì‹ì ìœ¼ë¡œ Cross-Region Read Replica / Region Failover ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤.

í˜„ì¬(2025 ê¸°ì¤€) SupabaseëŠ” ë‹¨ì¼ Region ìš´ì˜ë§Œ ê°€ëŠ¥í•˜ë©°, Replicaë„ ë™ì¼ Regionì—ì„œë§Œ ì§€ì›ëœë‹¤.

âŒ Secondary Region = Supabase ê¸°ëŠ¥ì´ ì•„ë‹ˆë‹¤

âŒ Region Failover = ë¶ˆê°€ëŠ¥

âŒ Replication across region = ì§€ì› ì•ˆ ë¨

DR/Failoverë¥¼ í•˜ë ¤ë©´:

PostgreSQL ìì²´ë¥¼ ë³„ë„ë¡œ êµ¬ì¶•í•˜ê±°ë‚˜

Neon/Aurora ë“± ì™¸ë¶€ DBë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤

ë˜ëŠ” Supabaseì˜ ë‹¨ì¼ Region ë°±ì—…/ë³µì› ê¸°ëŠ¥ë§Œ ì‚¬ìš©

PITR(Point-in-Time Recovery)ì€ íŠ¹ì • ì‹œì  ë³µì›ë§Œ ê°€ëŠ¥í•˜ë©°, table-level restoreëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤.

â†’ Multi-Region DRì´ í•„ìš”í•œ ê²½ìš° ì™¸ë¶€ PostgreSQL ì†”ë£¨ì…˜(Neon, AWS RDS, Aurora) ì‚¬ìš© í•„ìˆ˜

âš ï¸ ì£¼ì˜: ìœ„ ì œì•½ì‚¬í•­ê³¼ ìˆ˜ì¹˜ëŠ” 2025ë…„ ê¸°ì¤€ì´ë©°, Supabase ê¸°ëŠ¥Â·í”Œëœ ë³€ê²½ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‹¤ì œ ì„¤ê³„Â·êµ¬í˜„ ì‹œì ì—ëŠ” Supabase ìµœì‹  ê³µì‹ ë¬¸ì„œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì•¼ í•œë‹¤.

âš ï¸ ì¤‘ìš”: ìš°ë¦¬ í”Œë«í¼ì˜ ì´ˆê¸°~ì¤‘ê¸° ë‹¨ê³„ì—ì„œëŠ” Supabase ë‹¨ì¼ ë¦¬ì „ + ê¸°ë³¸ ë°±ì—…ë§Œ ì‚¬ìš©í•˜ë©°, Multi-Region êµ¬ì¡°ë¥¼ ë‹¹ì¥ ë„ì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” Supabase ë‹¨ì¼ ë¦¬ì „ ìš´ì˜ì´ ê¸°ë³¸ì…ë‹ˆë‹¤.
â†’ ì„ íƒì  êµ¬í˜„: ì™¸ë¶€ DB(Aurora/Neon) ê¸°ë°˜ Multi-Region DR ë„ì… (ì™¸ë¶€ DB ì „í™˜ í•„ìš” ì‹œ).
â†’ ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤: Multi-Region + ìƒ¤ë”© í†µí•© êµ¬ì¡° (í˜„ì¬ ë¶ˆí•„ìš”, 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ ë¹„í˜„ì‹¤ì ).

â†’ ìƒì„¸ DR ì •ì±…ì€ PART 7 'ì¥ì•  ë³µêµ¬ / ë°±ì—…Â·ë³µì› (DR & BCP)' ì„¹ì…˜ ì°¸ì¡°

1. ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”
1-1. Monorepo êµ¬ì¡°
.
â”œâ”€ apps/                        # ìµœì¢… ë°°í¬ë˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜
â”‚  â”œâ”€ academy-admin/            # í•™ì› ê´€ë¦¬ì/ì„ ìƒë‹˜ìš©
â”‚  â”œâ”€ academy-parent/           # í•™ë¶€ëª¨ìš©
â”‚  â”œâ”€ super-admin/              # SaaS ë³¸ì‚¬ í”Œë«í¼ ì½˜ì†”
â”‚  â””â”€ public-gateway/           # ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼í•˜ëŠ” ê²°ì œ/í‚¤ì˜¤ìŠ¤í¬/ê³µê°œ í˜ì´ì§€
â”‚
â”œâ”€ packages/                    # ê³µìœ  ëª¨ë“ˆ
â”‚  â”œâ”€ core/                     # ì—…ì¢… ê³µí†µ Core Platform Layer
â”‚  â”‚  â”œâ”€ core-auth/
â”‚  â”‚  â”œâ”€ core-tenancy/
â”‚  â”‚  â”œâ”€ core-billing/
â”‚  â”‚  â”œâ”€ core-metering/
â”‚  â”‚  â”œâ”€ core-notification/
â”‚  â”‚  â”œâ”€ core-payment/
â”‚  â”‚  â”œâ”€ core-config/
â”‚  â”‚  â”œâ”€ core-party/            # íšŒì›/ê³ ê° ê³µí†µ ëª¨ë¸ (persons í…Œì´ë¸” ê¸°ë°˜)
â”‚  â”‚  â”œâ”€ core-community/      # ê³µí†µ ê²Œì‹œíŒ/ëŒ“ê¸€/ê³µì§€/íŒŒì¼ ì²¨ë¶€ ìŠ¤í‚¤ë§ˆ ë° API
â”‚  â”‚  â”œâ”€ core-storage/         # íŒŒì¼ ì—…ë¡œë“œ/ê¶Œí•œ/í´ë” êµ¬ì¡° ê³µí†µí™”, Supabase Storage ë˜í•‘
â”‚  â”‚  â”œâ”€ core-calendar/        # ì¼ì •/ì˜ˆì•½/ìˆ˜ì—… ìŠ¤ì¼€ì¤„ ê³µí†µ ë„ë©”ì¸
â”‚  â”‚  â”œâ”€ core-search/          # Full Text Search ê³µí†µ ë ˆì´ì–´ (PART 16 ì°¸ì¡°)
â”‚  â”‚  â”œâ”€ core-tags/            # ê³µí†µ íƒœê¹… ì‹œìŠ¤í…œ(í•™ìƒ íƒœê·¸, ê³ ê° íƒœê·¸, ë§¤ë¬¼ íƒœê·¸ ë“±)
â”‚  â”‚  â”œâ”€ core-analytics/       # í†µê³„ íŒŒì´í”„ë¼ì¸ (PART 3ì˜ 15. Analytics & í†µê³„ ì„¹ì…˜ ì°¸ì¡°)
â”‚  â”‚  â”œâ”€ core-activity/        # Activity Feed / íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ê¸°ë¡
â”‚  â”‚  â”œâ”€ core-consultation/    # ìƒë‹´/ê¸°ë¡ ê´€ë¦¬ ê³µí†µ ëª¨ë“ˆ
â”‚  â”‚  â”œâ”€ core-reviews/             # ë¦¬ë·°/í‰ê°€ ì‹œìŠ¤í…œ
â”‚  â”‚  â”œâ”€ core-coupons/         # ì¿ í°/í• ì¸ ê´€ë¦¬
â”‚  â”‚  â”œâ”€ core-tenancy-referral/ # B2B ì¶”ì²œì¸ ì½”ë“œ ì œë„
â”‚  â”‚  â”œâ”€ core-events/          # ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜ ê´€ë¦¬
â”‚  â”‚  â””â”€ ui-core/               # UI ì»´í¬ë„ŒíŠ¸ (DataTable, TableCardView, SplitTableLayout ë“±)
â”‚  â”‚
â”‚  â”œâ”€ schema-engine/            # SDUI Renderer + Meta-Schema + Versioning + Custom Widget Registry
â”‚  â”‚
â”‚  â”œâ”€ design-system/            # Design Tokens, Theme Engine (ë‹¤í¬ëª¨ë“œ, Zoom ì§€ì›)
â”‚  â”‚
â”‚  â”œâ”€ api-sdk/                  # Zero-Trust API SDK Layer
â”‚  â”‚
â”‚  â””â”€ theme-engine/             # Theme Override Engine (í…Œë„ŒíŠ¸ë³„ í…Œë§ˆ ì»¤ìŠ¤í„°ë§ˆì´ì§•)
â”‚
âš ï¸ ì¤‘ìš”: UI ë ˆì´ì–´ êµ¬ì¡° ê°œë… vs ì‹¤ì œ íŒ¨í‚¤ì§€ ë§¤í•‘ (ëª¨ë“  ë¬¸ì„œ ê³µí†µ):

**ê°œë… ë ˆì´ì–´ (UI ë¬¸ì„œ ì„¤ëª…ìš©):**
UI/UX ë¬¸ì„œì—ì„œëŠ” UI ì•„í‚¤í…ì²˜ë¥¼ ê°œë…ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ëª…í•©ë‹ˆë‹¤:
- schema-engine â†’ core-ui â†’ design-system â†’ theme-engine

ì´ëŠ” **ë…¼ë¦¬ì  ë ˆì´ì–´ êµ¬ì¡°**ì´ë©°, "ì˜ì¡´ì„± ë°©í–¥"ê³¼ "ì±…ì„ ë¶„ë¦¬"ë¥¼ ì„¤ëª…í•˜ëŠ” ê°œë…ì  ëª¨ë¸ì…ë‹ˆë‹¤.

**ì‹¤ì œ íŒ¨í‚¤ì§€ êµ¬ì¡° (ê°œë°œ ì‹œ ê¸°ì¤€):**
- schema-engine: `packages/schema-engine` (ë…ë¦½ íŒ¨í‚¤ì§€)
- core-ui(ê°œë… ë ˆì´ì–´): `packages/ui-core` (ì‹¤ì œ íŒ¨í‚¤ì§€)
- design-system: `packages/design-system` (ë…ë¦½ íŒ¨í‚¤ì§€)
- theme-engine: `packages/design-system` ë‚´ë¶€ ë˜ëŠ” ë³„ë„ `theme-engine` íŒ¨í‚¤ì§€ (êµ¬í˜„ ë°©ì‹ì— ë”°ë¼)

**âš ï¸ ì¤‘ìš” ê·œì¹™:**
- **ê°œë… ë ˆì´ì–´ â‰  ë””ë ‰í† ë¦¬ 1:1 ì•„ë‹˜**: UI ë¬¸ì„œì˜ ë ˆì´ì–´ êµ¬ì¡°ëŠ” ê°œë…ì  ëª¨ë¸ì´ë©°, ì‹¤ì œ ë””ë ‰í† ë¦¬ êµ¬ì¡°ì™€ 1:1ë¡œ ë™ì¼í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ê°œë°œ ì‹œ ê¸°ì¤€**: ì‹¤ì œ Monorepo êµ¬ì¡°(`packages/*`)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜, UI ë¬¸ì„œì˜ ë ˆì´ì–´ ê°œë…ì„ ì°¸ê³ í•˜ì—¬ ëª¨ë“ˆ ê°„ ì˜ì¡´ì„±ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
- **SSOT**: ì‹¤ì œ íŒ¨í‚¤ì§€ ê²½ë¡œëŠ” R1.1(rules.md)ë§Œ ì •ë³¸ì´ë©°, ê°œë… ë ˆì´ì–´ëŠ” ì„¤ëª…ìš©ì…ë‹ˆë‹¤.
â”‚  â”‚  â”œâ”€ core/                  # ê³µí†µ API SDK (tenant_id, industry_type ìë™ ì‚½ì…)
â”‚  â”‚  â””â”€ academy/               # ì—…ì¢…ë³„ í™•ì¥ SDK (í–¥í›„ ì¶”ê°€)
â”‚  â”‚
â”‚  â”œâ”€ payments/
â”‚  â”‚  â””â”€ payment-alimbank/      # íš¨ì„±FMS ì•Œë¦¼ë±…í‚¹ Adapter
â”‚  â”‚
â”‚  â”œâ”€ industry/                 # ì—…ì¢…ë³„ ëª¨ë“ˆ (í•™ì›/ë¯¸ìš©/ë„¤ì¼/ë¶€ë™ì‚°/ì²´ìœ¡ê´€/ë¹„ì˜ë¦¬)
â”‚  â”‚  â”œâ”€ industry-academy/
â”‚  â”‚  â”œâ”€ industry-salon/
â”‚  â”‚  â”œâ”€ industry-real-estate/
â”‚  â”‚  â”œâ”€ industry-gym/
â”‚  â”‚  â”œâ”€ industry-ngo/
â”‚  â”‚  â””â”€ ...
â”‚  â”‚
â”‚  â”‚  âš ï¸ ì—…ì¢… í‚¤ ë§¤í•‘ ê·œì¹™ (SSOT):
â”‚  â”‚  - í´ë”ëª…: í•˜ì´í”ˆ ì‚¬ìš© (ì˜ˆ: industry-real-estate)
â”‚  â”‚  - DB í‚¤(industry_type): ì–¸ë”ìŠ¤ì½”ì–´ ì‚¬ìš© (ì˜ˆ: real_estate)
â”‚  â”‚  - UI ë¼ë²¨: ì—…ì¢…ë³„ Adapterì—ì„œ ë³€í™˜
â”‚  â”‚  ë§¤í•‘ í‘œ:
â”‚  â”‚  | í´ë”ëª… | DB í‚¤(industry_type) | UI ë¼ë²¨ ì˜ˆì‹œ |
â”‚  â”‚  |--------|---------------------|-------------|
â”‚  â”‚  | industry-academy | academy | í•™ì› |
â”‚  â”‚  | industry-salon | salon | ë¯¸ìš©ì‹¤ |
â”‚  â”‚  | industry-real-estate | real_estate | ë¶€ë™ì‚° (âš ï¸ realestate ì‚¬ìš© ê¸ˆì§€) |
â”‚  â”‚  | industry-gym | gym | ì²´ìœ¡ê´€ |
â”‚  â”‚  | industry-ngo | ngo | ë¹„ì˜ë¦¬ |
â”‚  â”‚  | industry-nail | nail | ë„¤ì¼ìƒµ (âš ï¸ ì‹¤ì œ DB ì œì•½ì¡°ê±´ í™•ì¸ í•„ìš”) |
â”‚  â”‚
â”‚  â”œâ”€ services/                 # DB ì ‘ê·¼ Service Layer
â”‚  â”‚  â”œâ”€ attendance-service/
â”‚  â”‚  â”œâ”€ billing-service/
â”‚  â”‚  â”œâ”€ messaging-service/
â”‚  â”‚  â”œâ”€ student-service/
â”‚  â”‚  â”œâ”€ community-service/
â”‚  â”‚  â””â”€ ...
â”‚  â”‚
â”‚  â”œâ”€ hooks/                    # React Query ê¸°ë°˜ Hooks
â”‚  â”‚  â”œâ”€ use-attendance/
â”‚  â”‚  â”œâ”€ use-billing/
â”‚  â”‚  â”œâ”€ use-notification/
â”‚  â”‚  â”œâ”€ use-community/
â”‚  â”‚  â””â”€ ...
â”‚  â”‚
â”‚  â”œâ”€ lib/                      # ê³µí†µ ìœ í‹¸
â”‚  â”‚  â”œâ”€ supabase-client/
â”‚  â”‚  â”œâ”€ logger/
â”‚  â”‚  â””â”€ router-guards/
â”‚  â”‚
â”‚  â”œâ”€ env-registry/             # ì¤‘ì•™ í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬ ì‹œìŠ¤í…œ (íƒ€ì… ì•ˆì •ì„± + ê²€ì¦ + í™˜ê²½ ìë™ ì¸ì‹)
â”‚  â”‚
â”‚  â””â”€ docs/                     # ì„¤ê³„ ë¬¸ì„œ
â”‚
â””â”€ infra/
   â”œâ”€ supabase/
   â”‚  â”œâ”€ migrations/            # DB ë§ˆì´ê·¸ë ˆì´ì…˜ SQL
   â”‚  â”œâ”€ functions/             # Supabase Edge Functions
   â”‚  â”‚  â”œâ”€ fns-payment-alimbank-webhook/
   â”‚  â”‚  â”œâ”€ fns-payment-alimbank-request/
   â”‚  â”‚  â”œâ”€ fns-notification-dispatch/
   â”‚  â”‚  â”œâ”€ fns-daily-metrics-aggregation/
   â”‚  â”‚  â””â”€ ...
   â”‚  â””â”€ policies/              # RLS/ì •ì±… SQL
   â”‚
   â”œâ”€ scripts/                  # ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸
   â””â”€ .github/                  # CI/CD

2. ë©€í‹°í…Œë„ŒíŠ¸ ëª¨ë¸ & ìš©ì–´

2-0. í…Œë„ŒíŠ¸ ì‚­ì œ ì •ì±… (Critical)

í•„ìˆ˜ í•­ëª©:

grace period (ì˜ˆ: 30ì¼ ë³´ê´€ í›„ ì‚­ì œ):

í…Œë„ŒíŠ¸ ì‚­ì œ ìš”ì²­ ì‹œ ì¦‰ì‹œ ì‚­ì œí•˜ì§€ ì•Šê³  30ì¼ê°„ ë³´ê´€

30ì¼ ë‚´ ë³µêµ¬ ìš”ì²­ ê°€ëŠ¥

billing unpaid ì¼€ì´ìŠ¤ ì²˜ë¦¬:

ë¯¸ë‚© í…Œë„ŒíŠ¸ëŠ” ì‚­ì œí•˜ì§€ ì•Šê³  ì¼ì‹œ ì •ì§€ ìƒíƒœë¡œ ì „í™˜

ë¯¸ë‚© í•´ê²° í›„ ìë™ í™œì„±í™” ë˜ëŠ” ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”

audit/eventsëŠ” ë³´ê´€í•´ì•¼ í•˜ëŠ”ê°€ ì—¬ë¶€:

audit.eventsëŠ” ë²•ì  ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ìµœì†Œ 1ë…„ ë³´ê´€

í…Œë„ŒíŠ¸ ì‚­ì œ í›„ì—ë„ audit.eventsëŠ” ë³´ê´€ (tenant_idë¡œ ì¡°íšŒ ê°€ëŠ¥)

storage íŒŒì¼ì‚­ì œ ì •ì±…:

í…Œë„ŒíŠ¸ ì‚­ì œ ì‹œ storage íŒŒì¼ì€ ì¦‰ì‹œ ì‚­ì œí•˜ì§€ ì•Šê³  30ì¼ ë³´ê´€

30ì¼ í›„ ìë™ ì‚­ì œ ë°°ì¹˜ ì‹¤í–‰

êµ¬í˜„ ì˜ˆì‹œ:

```typescript
async function deleteTenant(tenantId: string) {
  // 1. í…Œë„ŒíŠ¸ ìƒíƒœë¥¼ 'deleting'ìœ¼ë¡œ ë³€ê²½
  await db.updateTenantStatus(tenantId, 'deleting');

  // 2. ì‚­ì œ ì˜ˆì•½ (30ì¼ í›„)
  await db.scheduleDeletion(tenantId, new Date(Date.now() + 30 * 24 * 60 * 60 * 1000));

  // 3. Storage íŒŒì¼ ì‚­ì œ ì˜ˆì•½
  await scheduleStorageDeletion(tenantId, 30);

  // 4. audit.eventsëŠ” ë³´ê´€ (ì‚­ì œí•˜ì§€ ì•ŠìŒ)
}
```
2-1. ìš©ì–´ ì •ì˜
ìš©ì–´	ì„¤ëª…
Platform	ì „ì²´ SaaS ìƒì„± í”Œë«í¼
Tenant(í…Œë„ŒíŠ¸)	í•˜ë‚˜ì˜ ì‚¬ì—…ì(í•™ì›/ë§¤ì¥/ì§€ì  1ê°œ)
Industry	ì—…ì¢… ë ˆì´ì–´(academy/salon/real_estate/gym/ngo ë“±)
User	ê°œì¸ ê³„ì • (ì—¬ëŸ¬ í…Œë„ŒíŠ¸ì— ì†Œì† ê°€ëŠ¥)
SaaS ì œí’ˆ	ì—…ì¢…ë³„ íŒ¨í‚¤ì§€(í•™ì›ê´€ë¦¬, ë„¤ì¼ìƒµê´€ë¦¬ ë“±)
2-2. í•µì‹¬ í…Œì´ë¸”
tenants (
  id uuid PK,
  name text,
  industry_type text,
  plan text,
  status text,
  created_at timestamptz
)

users (...)

user_tenant_roles (
  user_id,
  tenant_id,
  role (owner/staff/instructor/teacher/guardian/parent ...)  -- instructor/guardianì€ ì •ë³¸ í‚¤, teacher/parentëŠ” backward compatibility
)

âš ï¸ ì—­í•  í‚¤ SSOT (Single Source of Truth):
- ì •ë³¸ ì—­í•  í‚¤: owner, staff, instructor, guardian (ì—…ì¢… ê³µí†µ)
- Backward compatibility: teacher (instructorì˜ alias), parent (guardianì˜ alias)
- í”Œë«í¼ ê¶Œí•œ: super_admin, developer, qa (user_platform_roles í…Œì´ë¸”)
- í…Œë„ŒíŠ¸ ê¶Œí•œ: owner, admin, sub_admin, instructor, assistant (user_tenant_roles í…Œì´ë¸”)
- âš ï¸ ì¤‘ìš”: ì‹¤ì œ í—ˆìš© ì—­í•  ëª©ë¡ì€ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì˜ CHECK ì œì•½ì¡°ê±´ì„ SSOTë¡œ ì°¸ì¡°í•˜ì„¸ìš”.

tenant_settings (
  tenant_id,
  key,
  value jsonb
)

tenant_features (
  tenant_id,
  feature_key,
  enabled,
  quota
)

2-2-1. ìŠ¤í‚¤ë§ˆ ë‹¨ë‹¨í™”(ë°ì´í„° ë¬´ê²°ì„±) (Critical)

industry_type, status, role, provider ë“±ì€ ENUM ë˜ëŠ” CHECKë¡œ í‘œì¤€í™”:

-- ì˜ˆì‹œ
ALTER TABLE tenants
  ADD CONSTRAINT chk_tenants_status CHECK (status IN ('active','paused','closed'));

ALTER TABLE tenants
  ADD CONSTRAINT chk_tenants_industry CHECK (industry_type IN ('academy','salon','real_estate','gym','ngo','nail'));
  -- âš ï¸ ì£¼ì˜: ìœ„ ëª©ë¡ì€ ì˜ˆì‹œì´ë©°, ì‹¤ì œ í—ˆìš© ì—…ì¢…ì€ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì˜ CHECK ì œì•½ì¡°ê±´ì„ SSOTë¡œ ì°¸ì¡°í•˜ì„¸ìš”.
  -- nail ì—…ì¢…ì€ ë¬¸ì„œ ì˜ˆì‹œì—ì„œ ìì£¼ ì–¸ê¸‰ë˜ì§€ë§Œ, ì‹¤ì œ DB ì œì•½ì¡°ê±´ì— í¬í•¨ ì—¬ë¶€ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

tenant_settings.valueëŠ” JSON Schema ìœ íš¨ì„±(ì„œë²„ë‹¨) + ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ê¸°ë³¸ê°’ ê°•ì œ

â†’ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ ë° ëŸ°íƒ€ì„ ì˜¤ë¥˜ ë°©ì§€

â†’ ëª¨ë“  ë„ë©”ì¸ í…Œì´ë¸”ì€ tenant_id í•„ìˆ˜ + ì¸ë±ìŠ¤ êµ¬ì„±

2-2-2. ë§¤ì¥(Store) ë° ì§€ì—­(Region) ëª¨ë¸

âš ï¸ ì¤‘ìš”: ê¸°ë³¸ ë§¤ì¥/ì§€ì—­ ëª¨ë¸ê³¼ ê³ ê¸‰ ë§¤ì¥ ê´€ë¦¬ ê¸°ëŠ¥ì€ ìƒìš©í™” ë‹¨ê³„ êµ¬í˜„ ì˜ˆì • (í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜ ì™„ë£Œ, core_stores/core_regions í…Œì´ë¸” ìƒì„± ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”).

ìƒìš©í™” ë‹¨ê³„ ê¸°ë³¸ êµ¬ì¡°:
- core_stores í…Œì´ë¸” (ê¸°ë³¸ ë§¤ì¥ ì •ë³´)
- core_regions í…Œì´ë¸” (ì§€ì—­ ë§ˆìŠ¤í„° ë°ì´í„°)
- ë§¤ì¥ â†” ì§€ì—­ ë§¤í•‘ (ì§€ì—­ í†µê³„ìš©)

ìƒìš©í™” ë‹¨ê³„ ê³ ê¸‰ ê¸°ëŠ¥:
- ë‹¤ì¤‘ ë§¤ì¥ ê´€ë¦¬
- ë§¤ì¥ë³„ ì„¸ë¶€ ì„¤ì •
- ë§¤ì¥ë³„ ê¶Œí•œ ê´€ë¦¬

ì§€ì—­ ê³„ì¸µ í…Œì´ë¸” (Core Layer ê³µí†µ):

CREATE TABLE core_regions (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  level           text NOT NULL CHECK (level IN ('dong', 'gu_gun', 'si', 'nation')), -- ë™/ì/ë©´, êµ¬/êµ°, ì‹œ/ë„, ì „êµ­
  code            text NOT NULL,    -- í–‰ì •ì•ˆì „ë¶€ í–‰ì •êµ¬ì—­ ì½”ë“œ ë“±
  name_ko         text NOT NULL,
  parent_id       uuid NULL REFERENCES core_regions(id),
  created_at      timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX ux_core_regions_level_code
  ON core_regions(level, code);

CREATE INDEX idx_core_regions_parent ON core_regions(parent_id);

ë§¤ì¥(Store) í…Œì´ë¸”:

CREATE TABLE core_stores (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       uuid NOT NULL REFERENCES tenants(id),
  name            text NOT NULL,
  industry_type   text NOT NULL,    -- tenants.industry_typeê³¼ ë™ì¼
  region_id       uuid NOT NULL REFERENCES core_regions(id),  -- ë§¤ì¥ì´ ì†í•œ ê¸°ì¤€ ì§€ì—­(ë³´í†µ ë™/ì/ë©´)
  latitude        double precision,  -- ì§€ë„ ë Œë”ë§ìš© ìœ„ë„ (WGS84)
  longitude       double precision, -- ì§€ë„ ë Œë”ë§ìš© ê²½ë„ (WGS84)
  address         text,
  phone           text,
  status          text NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'paused', 'closed')),
  created_at      timestamptz NOT NULL DEFAULT now(),
  updated_at      timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX idx_core_stores_tenant ON core_stores(tenant_id);
CREATE INDEX idx_core_stores_region ON core_stores(region_id);
CREATE INDEX idx_core_stores_industry_region ON core_stores(industry_type, region_id);

ALTER TABLE core_stores ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_core_stores ON core_stores
FOR ALL TO authenticated
USING (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
)
WITH CHECK (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
);

âš ï¸ ì¤‘ìš”: PgBouncer Transaction Poolingì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, JWT claim ê¸°ë°˜ RLSë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. set_config ê¸°ë°˜ RLSëŠ” Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ ì „ìš©ì…ë‹ˆë‹¤.

â†’ Regionì€ Core Layerì˜ ê³µí†µ ì°¨ì›(Dimension)ì´ê³ , Industry Layer(í•™ì›, ë¶€ë™ì‚° ë“±)ëŠ” ì´ Regionì„ ê·¸ëŒ€ë¡œ ê³µìš©ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ê¸°ë³¸ ë§¤ì¥/ì§€ì—­ ëª¨ë¸ê³¼ ê³ ê¸‰ ë§¤ì¥ ê´€ë¦¬ ê¸°ëŠ¥ì„ ëª¨ë‘ êµ¬í˜„ ì˜ˆì • (í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜ ì™„ë£Œ, core_stores/core_regions í…Œì´ë¸” ìƒì„± ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”).

3. Supabase êµ¬ì¡° & ì›ì¹™
3-1. ë‹¨ì¼ í”„ë¡œì íŠ¸ ì „ëµ

Supabase í”„ë¡œì íŠ¸ëŠ” í™˜ê²½ë³„ë¡œ ë¶„ë¦¬í•˜ë©°, íŠ¹íˆ prodëŠ” dev/stagingê³¼ ì™„ì „íˆ ë‹¤ë¥¸ í”„ë¡œì íŠ¸/DBë¥¼ ì‚¬ìš©í•œë‹¤.

ì´ ë¬¸ì„œì˜ "ë‹¨ì¼ PostgreSQL"ì€ ìš´ì˜(prod) í™˜ê²½ ë‚´ ë©€í‹°í…Œë„ŒíŠ¸ë¥¼ ì˜ë¯¸í•œë‹¤.

ëª¨ë“  ì—…ì¢… SaaS í…Œë„ŒíŠ¸ëŠ” ìš´ì˜(prod) í™˜ê²½ì˜ ë‹¨ì¼ PostgreSQLì— ì €ì¥

ì›ì¹™ì ìœ¼ë¡œëŠ” ëª¨ë“  í…Œë„ŒíŠ¸ê°€ ë‹¨ì¼ PostgreSQL ì¸ìŠ¤í„´ìŠ¤ì— ê³µì¡´í•˜ë©°, íŠ¹ì • Hot Tenantê°€ ì „ì²´ ë¶€í•˜ì— ì‹¬ê°í•œ ì˜í–¥ì„ ì£¼ëŠ” ê²½ìš°ì— í•œí•´ ì˜ˆì™¸ì ìœ¼ë¡œ í•´ë‹¹ í…Œë„ŒíŠ¸ë§Œ ë³„ë„ ìƒ¤ë“œ(ë¶„ë¦¬ DB)ë¡œ ìˆ˜ì§ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤.

RLS + tenant_id + app.current_tenant_id ì¡°í•©ìœ¼ë¡œ ì™„ì „ ê²©ë¦¬

âš ï¸ ì¤‘ìš”: í…Œë„ŒíŠ¸ë³„ í…Œì´ë¸” ìƒì„± êµ¬ì¡°ê°€ ì•„ë‹˜

ì´ í”Œë«í¼ì€ "í…Œë„ŒíŠ¸ë§ˆë‹¤ ìŠ¤í‚¤ë§ˆ/í…Œì´ë¸”ì„ ìƒˆë¡œ ë§Œë“œëŠ” êµ¬ì¡°"ê°€ ì•„ë‹™ë‹ˆë‹¤.

ê¸°ë³¸ êµ¬ì¡°:
- public ìŠ¤í‚¤ë§ˆ + tenant_id + industry_type ì»¬ëŸ¼ (í‘œì¤€)
- íŒŒí‹°ì…”ë‹ì€ ì‹œê°„ ê¸°ì¤€(RANGE, occurred_at)
- ì—…ì¢…ë³„ í…Œì´ë¸”ì€ "í•„ìš”í•  ë•Œë§Œ" academy_*, salon_* ê°™ì€ ì†Œìˆ˜ì˜ prefix í…Œì´ë¸”

ì¦‰, í…Œë„ŒíŠ¸ 3ë§Œ ê°œê°€ ìƒê²¨ë„:
- "í…Œì´ë¸” ê°œìˆ˜"ëŠ” ê·¸ëŒ€ë¡œ (ë˜ëŠ” ì›”/ì—° íŒŒí‹°ì…˜ë§Œ ì‹œê°„ì— ë”°ë¼ ì¦ê°€)
- "í–‰(row) ìˆ˜"ë§Œ ëŠ˜ì–´ë‚˜ëŠ” êµ¬ì¡°

ì„ íƒì  êµ¬í˜„ì—ì„œ ë§í•˜ëŠ” "ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬"ë„ industry ë‹¨ìœ„ì§€, tenant ë‹¨ìœ„ê°€ ì•„ë‹™ë‹ˆë‹¤.

â†’ "ì‚¬ìŠ¤ í•˜ë‚˜ ìƒê¸¸ ë•Œë§ˆë‹¤ DB í…Œì´ë¸” ì”ëœ© ëŠ˜ì–´ë‚˜ëŠ” êµ¬ì¡°ëŠ” ì•„ë‹ˆë‹¤"ë¡œ ì´í•´í•˜ë©´ ë©ë‹ˆë‹¤.
â†’ í…Œì´ë¸” í­ì¦ì€ "ì›”ë³„ íŒŒí‹°ì…˜ ìˆ˜ Ã— ë¡œê·¸ì„± í…Œì´ë¸” ìˆ˜" ì •ë„ë¼ì„œ, ìš´ì˜ ì„¤ê³„ë¡œ ì»¨íŠ¸ë¡¤ ê°€ëŠ¥í•©ë‹ˆë‹¤.

3-1-1. Supabase ë‹¨ì¼ í”„ë¡œì íŠ¸ í™•ì¥ì„± ë° ë³‘ëª© ëŒ€ì‘ ì „ëµ (Critical)

âš ï¸ ì¤‘ìš”: 20,000~30,000 í…Œë„ŒíŠ¸ë¥¼ ë‹¨ì¼ Supabase í”„ë¡œì íŠ¸ì—ì„œ ìš´ì˜í•˜ë ¤ë©´ ë°˜ë“œì‹œ ë‹¤ìŒ ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤.

DB ì—°ê²° ìˆ˜ & í’€ë§ ì „ëµ:

[ë¶ˆë³€ ê·œì¹™] SupabaseëŠ” í”Œëœ/ì»´í“¨íŠ¸ ìŠ¤í™ë³„ë¡œ DB ì—°ê²° ìˆ˜ê°€ ì œí•œë˜ì–´ ìˆìœ¼ë¯€ë¡œ, PgBouncer(ì»¤ë„¥ì…˜ í’€ëŸ¬) ì‚¬ìš©ì„ ì „ì œë¡œ í•©ë‹ˆë‹¤.

ì—°ê²° ìˆ˜ ì œí•œ (ì˜ˆì‹œ, ì‹¤ì œëŠ” Supabase ìµœì‹  ë¬¸ì„œ í™•ì¸ í•„ìš”):
- Free/Pro í”Œëœ: ì œí•œì  ì—°ê²° ìˆ˜
- Enterprise: ë” ë§ì€ ì—°ê²° ìˆ˜ ì œê³µ

PgBouncer í’€ë§ ëª¨ë“œ:
- Transaction Pooling (ê¶Œì¥): ì§§ì€ íŠ¸ëœì­ì…˜ì— ìµœì í™”
- Session Pooling: ê¸´ íŠ¸ëœì­ì…˜ í•„ìš” ì‹œ

âš ï¸ Critical: PgBouncer Transaction Poolingê³¼ RLS ì „ëµ (êµ¬ì¡°ì  í•´ê²°ì±… í•„ìˆ˜)

ğŸš¨ ì¤‘ìš”: PgBouncer Transaction Pooling ëª¨ë“œì—ì„œëŠ” ì„¸ì…˜ ë³€ìˆ˜(set_config)ê°€ íŠ¸ëœì­ì…˜ ì¢…ë£Œ í›„ ìœ ì§€ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, RLSëŠ” ê¸°ë³¸ì ìœ¼ë¡œ JWT claim ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.

**ì •ë³¸ íŒ¨í„´ (ê¶Œì¥):**
- JWT claim ê¸°ë°˜: `tenant_id = (auth.jwt() ->> 'tenant_id')::uuid`
- Transaction Pooling í˜¸í™˜, ì„±ëŠ¥ ìš°ìˆ˜

**ì˜ˆì™¸ íŒ¨í„´ (í—ˆìš©, ê·¼ê±° í•„ìš”):**
- auth.uid + RBAC ì¡°ì¸: `tenant_id IN (SELECT tenant_id FROM user_tenant_roles WHERE user_id = auth.uid())`
- ì‚¬ìš© ì¡°ê±´: ë³µì¡í•œ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ê°€ í•„ìš”í•œ ê²½ìš°, ì¸ë±ìŠ¤ ìµœì í™” í•„ìš”
- âš ï¸ ì£¼ì˜: JOIN ê¸°ë°˜ RLSëŠ” PgBouncer Transaction Poolingê³¼ í˜¸í™˜ë˜ì§€ë§Œ, ì„±ëŠ¥ ìµœì í™”(ì¸ë±ìŠ¤)ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. ê°€ëŠ¥í•˜ë©´ JWT claim ê¸°ë°˜ì„ ìš°ì„  ì‚¬ìš©í•˜ì„¸ìš”.

[ë¶ˆë³€ ê·œì¹™] PgBouncer Transaction Pooling ëª¨ë“œë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” RLS ì •ì±…ì´ JWT claim ê¸°ë°˜ìœ¼ë¡œ ì‘ë™í•˜ë„ë¡ ì„¤ê³„í•´ì•¼ í•©ë‹ˆë‹¤. set_config ê¸°ë°˜ RLSëŠ” Transaction Poolingê³¼ í˜¸í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**âš ï¸ í˜„ì¬ ìƒíƒœ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ë°©í–¥:**
- **í˜„í™©**: ì¼ë¶€ í…Œì´ë¸”ì€ ë ˆê±°ì‹œ íŒ¨í„´(JOIN ê¸°ë°˜ ë˜ëŠ” set_config ê¸°ë°˜) ì‚¬ìš© ì¤‘
- **ëª©í‘œ**: ëª¨ë“  í…Œì´ë¸”ì„ JWT claim ê¸°ë°˜ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ (ìƒìš©í™” ë‹¨ê³„)
- **ê¸ˆì§€ ëŒ€ìƒ**: set_config('app.current_tenant_id') ê¸°ë°˜ RLS (Transaction Poolingê³¼ í˜¸í™˜ ì•ˆ ë¨, ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€)
- **ì˜ˆì™¸ íŒ¨í„´**: JOIN ê¸°ë°˜ RLSëŠ” ì¸ë±ìŠ¤ ìµœì í™” ì‹œ í—ˆìš© ê°€ëŠ¥í•˜ë‚˜, JWT claim ê¸°ë°˜ ê¶Œì¥
- **ë§ˆì´ê·¸ë ˆì´ì…˜ ìš°ì„ ìˆœìœ„**: ì‹ ê·œ í…Œì´ë¸”ì€ ë°˜ë“œì‹œ JWT claim ê¸°ë°˜ë§Œ ì‚¬ìš©, ê¸°ì¡´ í…Œì´ë¸”ì€ ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜

ë¬¸ì œì :
- Transaction Pooling ëª¨ë“œì—ì„œëŠ” ì„¸ì…˜ ë ˆë²¨ SETì´ íŠ¸ëœì­ì…˜ ì¢…ë£Œ í›„ ìœ ì§€ë˜ì§€ ì•ŠìŒ
- set_config('app.current_tenant_id') ê¸°ë°˜ RLSëŠ” Transaction Poolingì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŒ
- RLS ì •ì±…ì´ ì˜ëª»ëœ tenant_idë¡œ í‰ê°€ë˜ê±°ë‚˜ ëª¨ë“  rowê°€ ì°¨ë‹¨ë  ìœ„í—˜

í•´ê²°ì±… (êµ¬ì¡°ì ):

ì˜µì…˜ 1: JWT claim ê¸°ë°˜ RLS (ê¶Œì¥, Supabase ê¸°ë³¸ ë°©ì‹):
- Supabase JWTì— tenant_idë¥¼ claimìœ¼ë¡œ í¬í•¨
- RLS ì •ì±…ì—ì„œ JWT claimì„ ì§ì ‘ ì½ì–´ tenant_id í™•ì¸
- PgBouncer Transaction Poolingê³¼ ì™„ë²½ í˜¸í™˜

ì˜µì…˜ 2: Session Pooling ëª¨ë“œ (ì œí•œì ):
- PgBouncer Session Pooling ëª¨ë“œ ì‚¬ìš© (ì»¤ë„¥ì…˜ ìˆ˜ ì œí•œ ì¦ê°€)
- ì„¸ì…˜ ë³€ìˆ˜ ìœ ì§€ ê°€ëŠ¥í•˜ë‚˜ ì»¤ë„¥ì…˜ íš¨ìœ¨ì„± ì €í•˜

ì˜µì…˜ 3: ì „ìš© ì»¤ë„¥ì…˜ (íŠ¹ìˆ˜ ì¼€ì´ìŠ¤):
- íŠ¹ì • Edge Functionë§Œ ì „ìš© ì»¤ë„¥ì…˜ ì‚¬ìš© (ë…¼í’€ë§)
- ì¼ë°˜ì ì¸ ê²½ìš°ì—ëŠ” ê¶Œì¥í•˜ì§€ ì•ŠìŒ

ğŸ“Œ JWT claim ê¸°ë°˜ RLS êµ¬í˜„ (ê¶Œì¥):

1. Supabase JWTì— tenant_id í¬í•¨:
   - ì‚¬ìš©ì ì¸ì¦ ì‹œ user_tenant_rolesì—ì„œ tenant_id ì¡°íšŒ
   - JWT ìƒì„± ì‹œ claimì— tenant_id í¬í•¨

2. RLS ì •ì±… ìˆ˜ì •:
```sql
CREATE POLICY tenant_isolation_students ON public.students
FOR ALL TO authenticated
USING (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
)
WITH CHECK (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
);
```

3. Service Layerì—ì„œ withTenant() ì‚¬ìš©:
   - RLSëŠ” ë³´ì•ˆ ë ˆì´ì–´, Service LayerëŠ” ì¿¼ë¦¬ ë ˆì´ì–´
   - 2ì¤‘ í•„í„°ë¡œ ë³´ì•ˆ ê°•í™”

ëª¨ë‹ˆí„°ë§ ì „ëµ:
- RLS ì‹¤íŒ¨ìœ¨ ëª¨ë‹ˆí„°ë§ (ì˜ˆìƒì¹˜ ëª»í•œ 401/403 ì¦ê°€ ê°ì§€)
- JWT claim ëˆ„ë½ ê°ì§€ (ë¡œê·¸ ìˆ˜ì§‘)
- í…Œë„ŒíŠ¸ ê°„ ë°ì´í„° ëˆ„ìˆ˜ ê°ì§€ (audit ë¡œê·¸ ë¶„ì„)

ğŸš¨ [ë¶ˆë³€ ê·œì¹™] PgBouncer Transaction Pooling ì‚¬ìš© ì‹œ set_config ê¸°ë°˜ RLS ê¸ˆì§€:

[ë¶ˆë³€ ê·œì¹™] Supabase í™˜ê²½ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ PgBouncer Transaction Poolingì„ ì‚¬ìš©í•˜ë¯€ë¡œ, set_config('app.current_tenant_id') ê¸°ë°˜ RLSëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] Transaction Pooling ëª¨ë“œì—ì„œëŠ” ì„¸ì…˜ ë³€ìˆ˜ê°€ íŠ¸ëœì­ì…˜ ì¢…ë£Œ í›„ ìœ ì§€ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, set_config ê¸°ë°˜ RLSëŠ” ë³´ì•ˆ ìƒ ì•ˆì „í•˜ê²Œ ë™ì‘í•˜ì§€ ì•Šì„ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] RLS ì •ì±…ì€ ê¸°ë³¸ì ìœ¼ë¡œ JWT claim ê¸°ë°˜(auth.jwt() ->> 'tenant_id')ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

**âš ï¸ ë ˆê±°ì‹œ ì°¸ê³ : app.current_tenant_id (ì‚¬ìš© ê¸ˆì§€, ì°¸ê³ ìš©):**

`app.current_tenant_id`ëŠ” **Session Pooling ëª¨ë“œ ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ ì „ìš©**ì´ë©°, í˜„ì¬ Supabase í™˜ê²½(Transaction Pooling)ì—ì„œëŠ” **ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

**ë ˆê±°ì‹œ íŒ¨í„´ (ì°¸ê³ ìš©, ì‚¬ìš© ê¸ˆì§€):**
```sql
-- âŒ ê¸ˆì§€: Transaction Pooling í™˜ê²½ì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŒ
SELECT set_config('app.current_tenant_id', tenant_id, true);
```

**ì •ë³¸ íŒ¨í„´ (í•„ìˆ˜):**
```sql
-- âœ… ì •ë³¸: JWT claim ê¸°ë°˜
tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
```

**âŒ ì˜ëª»ëœ íŒ¨í„´ (ê¸ˆì§€):**
```sql
-- âŒ ê¸ˆì§€: ì¤‘ë³µ ê´„í˜¸ì™€ ë¶ˆí•„ìš”í•œ ::text ìºìŠ¤íŒ…
tenant_id = ((auth.jwt() ->> 'tenant_id'::text))::uuid
```

**ì˜ëª»ëœ íŒ¨í„´ì˜ ë¬¸ì œì :**
- ì¤‘ë³µ ê´„í˜¸ `((...))`ëŠ” ë¶ˆí•„ìš”í•˜ë©° ê°€ë…ì„±ì„ í•´ì¹©ë‹ˆë‹¤
- `'tenant_id'::text` ìºìŠ¤íŒ…ì€ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤ (JSON ì—°ì‚°ì `->>` ëŠ” ì´ë¯¸ textë¥¼ ë°˜í™˜)
- ì˜¬ë°”ë¥¸ íŒ¨í„´: `(auth.jwt() ->> 'tenant_id')::uuid` (ë‹¨ì¼ ê´„í˜¸, ::text ì—†ìŒ)

**ì°¸ê³ :** ì¼ë¶€ ë¬¸ì„œì—ì„œ `app.current_tenant_id`ê°€ ì–¸ê¸‰ë˜ì–´ ìˆìœ¼ë‚˜, ì´ëŠ” **ë ˆê±°ì‹œ ì°¸ê³ ìš©**ì´ë©°, ì‹ ê·œ ì½”ë“œëŠ” ë°˜ë“œì‹œ JWT claim ê¸°ë°˜ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

**ì •ë³¸ íŒ¨í„´ (ê¶Œì¥):**
- JWT claim ê¸°ë°˜: `tenant_id = (auth.jwt() ->> 'tenant_id')::uuid`
- Transaction Pooling í˜¸í™˜, ì„±ëŠ¥ ìš°ìˆ˜

**ì˜ˆì™¸ íŒ¨í„´ (í—ˆìš©, ê·¼ê±° í•„ìš”):**
- auth.uid + RBAC ì¡°ì¸: `tenant_id IN (SELECT tenant_id FROM user_tenant_roles WHERE user_id = auth.uid())`
- ì‚¬ìš© ì¡°ê±´: ë³µì¡í•œ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ê°€ í•„ìš”í•œ ê²½ìš°, ì¸ë±ìŠ¤ ìµœì í™” í•„ìš”
- ì„±ëŠ¥ ê³ ë ¤: user_tenant_roles í…Œì´ë¸”ì— (user_id, tenant_id) ë³µí•© ì¸ë±ìŠ¤ í•„ìˆ˜

âš ï¸ ì¤‘ìš”: í˜„ì¬ ë¬¸ì„œì˜ set_config ê¸°ë°˜ RLS ì˜ˆì‹œëŠ” Session Pooling ëª¨ë“œ ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—ë§Œ ìœ íš¨í•©ë‹ˆë‹¤. Transaction Poolingì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°(ê¸°ë³¸ ì„¤ì •) ê¸°ë³¸ì ìœ¼ë¡œ JWT claim ê¸°ë°˜ RLSë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

**ì •ë³¸ íŒ¨í„´ (ê¶Œì¥):**
- JWT claim ê¸°ë°˜: `tenant_id = (auth.jwt() ->> 'tenant_id')::uuid`
- Transaction Pooling í˜¸í™˜, ì„±ëŠ¥ ìš°ìˆ˜

**ì˜ˆì™¸ íŒ¨í„´ (í—ˆìš©, ê·¼ê±° í•„ìš”):**
- auth.uid + RBAC ì¡°ì¸: `tenant_id IN (SELECT tenant_id FROM user_tenant_roles WHERE user_id = auth.uid())`
- ì‚¬ìš© ì¡°ê±´: ë³µì¡í•œ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ê°€ í•„ìš”í•œ ê²½ìš°, ì¸ë±ìŠ¤ ìµœì í™” í•„ìš”

[ë¶ˆë³€ ê·œì¹™] ê¸´ íŠ¸ëœì­ì…˜ / í†µê³„ ì¿¼ë¦¬ / ë°°ì¹˜ ì¿¼ë¦¬ëŠ” Primary DBì— ì§ì ‘ ì‹¤í–‰í•˜ì§€ ì•Šìœ¼ë©°, Read Replica ë˜ëŠ” ì™¸ë¶€ Workerë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] Admin ë„êµ¬(ì˜ˆ: Metabase, Grafana)ë„ ë‚®ì€ ì»¤ë„¥ì…˜ ì†Œë¹„ë¥¼ ìœ„í•´ Read Replicaë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

ì—°ê²° ìˆ˜ ëª¨ë‹ˆí„°ë§:
- pg_stat_activity ëª¨ë‹ˆí„°ë§
- PgBouncer í†µê³„ ìˆ˜ì§‘
- ì—°ê²° ìˆ˜ ì„ê³„ê°’ ì„¤ì • (ì˜ˆ: 80% ë„ë‹¬ ì‹œ ì•Œë¦¼)

ë¦¬ë“œ ë ˆí”Œë¦¬ì¹´(Read Replica) ì „ëµ:

[ë¶ˆë³€ ê·œì¹™] ìš´ì˜ íŠ¸ëœì­ì…˜ì€ Primary, ëŒ€ì‹œë³´ë“œÂ·í†µê³„Â·ë¦¬í¬íŠ¸ëŠ” Read Replicaë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.

íŠ¸ë˜í”½ ë¶„ë¦¬ ì „ëµ:

Primary DB (ì“°ê¸° + ì‹¤ì‹œê°„ ì½ê¸°):
- INSERT/UPDATE/DELETE ì‘ì—…
- ì‹¤ì‹œê°„ ì¡°íšŒ (í•™ìƒ ëª©ë¡, ìˆ˜ë‚© ë‚´ì—­ ë“±)
- Edge Functionì—ì„œì˜ íŠ¸ëœì­ì…˜ ì‘ì—…

Read Replica (ì½ê¸° ì „ìš©):
- ëŒ€ì‹œë³´ë“œ í†µê³„ ì¿¼ë¦¬
- ë¦¬í¬íŠ¸ ìƒì„±
- Analytics ì§‘ê³„ ì¿¼ë¦¬
- Admin ë„êµ¬ ì¿¼ë¦¬

Read Replica ë¼ìš°íŒ… ì˜ˆì‹œ:

// services/analytics-service.ts
import { createClient } from '@supabase/supabase-js';
import { envServer } from '@env-registry/server';

// Primary DB (ì“°ê¸°ìš©)
const supabasePrimary = createClient(
  envServer.SUPABASE_URL,
  envServer.SERVICE_ROLE_KEY,
);

// Read Replica (ì½ê¸° ì „ìš©)
const supabaseReplica = createClient(
  envServer.SUPABASE_READ_REPLICA_URL,  // Read Replica URL
  envServer.SUPABASE_ANON_KEY,  // ì½ê¸° ì „ìš©ì´ë¯€ë¡œ ANON_KEY ì‚¬ìš© ê°€ëŠ¥
);

// í†µê³„ ì¿¼ë¦¬ëŠ” Read Replica ì‚¬ìš©
export async function getDashboardStats(tenantId: string) {
  return withTenant(
    supabaseReplica
      .from('analytics.daily_store_metrics') // ì •ë³¸: daily_metricsëŠ” êµ¬ë²„ì „
      .select('*')
      .order('date_kst', { ascending: false })
      .limit(30),
    tenantId,
  );
}

âš ï¸ ì£¼ì˜: Read ReplicaëŠ” ë³µì œ ì§€ì—°(replication lag)ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì‹¤ì‹œê°„ì„±ì´ ì¤‘ìš”í•œ ì¿¼ë¦¬ëŠ” Primaryë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

ë³µì œ ì§€ì—° ëª¨ë‹ˆí„°ë§:
- pg_stat_replication ëª¨ë‹ˆí„°ë§
- UIì— "ìµœê·¼ ë™ê¸°í™” ì‹œê°(KST)" ë°°ì§€ í‘œê¸°

íŒŒí‹°ì…”ë‹ ì „ëµ:

[ë¶ˆë³€ ê·œì¹™] ëŒ€ìš©ëŸ‰ í…Œì´ë¸”ì€ ë°˜ë“œì‹œ íŒŒí‹°ì…”ë‹ì„ ì ìš©í•©ë‹ˆë‹¤.

íŒŒí‹°ì…”ë‹ ëŒ€ìƒ í…Œì´ë¸”:
- attendance_logs (ë¡œê·¸ì„±)
- invoice_items (ê±°ë˜ ë¡œê·¸)
- notification_logs (ì•Œë¦¼ ë¡œê·¸)
- audit_logs (ê°ì‚¬ ë¡œê·¸)
- analytics.events (ì´ë²¤íŠ¸ ë¡œê·¸)

íŒŒí‹°ì…”ë‹ ì „ëµ:

ë¡œê·¸ì„± í…Œì´ë¸”: tenant_id + ë‚ ì§œ(ì›”) ê¸°ì¤€ RANGE íŒŒí‹°ì…”ë‹

CREATE TABLE attendance_logs (
  id bigserial,
  tenant_id uuid NOT NULL,
  occurred_at timestamptz NOT NULL,
  ...
) PARTITION BY RANGE (occurred_at);

CREATE TABLE attendance_logs_2025_01
  PARTITION OF attendance_logs
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE INDEX ON attendance_logs_2025_01 (tenant_id, occurred_at DESC);

[ë¶ˆë³€ ê·œì¹™] ë¡œê·¸ì„± í…Œì´ë¸”(attendance_logs, analytics.events ë“±)ì˜ ëª¨ë“  íŒŒí‹°ì…˜ì—ëŠ” ë°˜ë“œì‹œ (tenant_id, occurred_at DESC) ë³µí•© ì¸ë±ìŠ¤ê°€ ì ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

â†’ íŒŒí‹°ì…”ë‹ ê¸°ì¤€ì´ ì—†ìœ¼ë©´, 5~10ë…„ ë°ì´í„°ê°€ ìŒ“ì˜€ì„ ë•Œ ì¸ë±ìŠ¤ê°€ ë¹„íš¨ìœ¨ì ì´ ë©ë‹ˆë‹¤.

íŒŒí‹°ì…”ë‹ ë„ì… ê¸°ì¤€ ë° íƒ€ì´ë°:

âš ï¸ Critical: íŒŒí‹°ì…”ë‹ì€ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒí•˜ê¸° ì „ì— ë¯¸ë¦¬ ë„ì…í•´ì•¼ í•©ë‹ˆë‹¤.

ğŸ“Œ íŒŒí‹°ì…”ë‹ ê¸°ì¤€ ìˆ˜ì¹˜ ë° ê·¼ê±°:

ë¡œê·¸ì„± í…Œì´ë¸” (attendance_logs, analytics.events ë“±):
- ë„ì… ê¸°ì¤€: ë‹¨ì¼ íŒŒí‹°ì…˜ 1ì–µ rows ë˜ëŠ” íŒŒí‹°ì…˜ íŒŒì¼ í¬ê¸° ~50GB ë„ë‹¬
- ê·¼ê±°: ë¡œê·¸ì„± í…Œì´ë¸”ì€ ì‹œê°„ ê¸°ë°˜ ì¡°íšŒê°€ ì£¼ íŒ¨í„´ì´ë©°, ì¸ë±ìŠ¤ í¬ê¸°ê°€ ì»¤ì§ˆìˆ˜ë¡ ì„±ëŠ¥ ì €í•˜ê°€ ê¸‰ê²©íˆ ë°œìƒ. 1ì–µ rows ê¸°ì¤€ì€ PostgreSQL ì¸ë±ìŠ¤ íš¨ìœ¨ì„± ì„ê³„ê°’ ê·¼ê±°
- ë„ì… íƒ€ì´ë°: ì„ê³„ê°’ì˜ 50~70% ë„ë‹¬ ì‹œì  (5ì²œë§Œ rows ë˜ëŠ” 25GB ë„ë‹¬ ì‹œ)ì— ë¯¸ë¦¬ ë„ì…

ì½”ì–´ í…Œì´ë¸” (students, invoices ë“±):
- ë„ì… ê¸°ì¤€: í…Œë„ŒíŠ¸ ìˆ˜ â‰¥ 5,000, ì´ rows â‰¥ 5ì²œë§Œ ë˜ëŠ” í…Œì´ë¸” í¬ê¸° â‰¥ 200GB ì‹œ industry_type ê¸°ë°˜ íŒŒí‹°ì…”ë‹ ê²€í† 
- ê·¼ê±°: ì½”ì–´ í…Œì´ë¸”ì€ ë¡œê·¸ì„± í…Œì´ë¸”ë³´ë‹¤ ì¡°íšŒ íŒ¨í„´ì´ ë‹¤ì–‘í•˜ê³ , tenant_id + industry_type ë³µí•© ì¸ë±ìŠ¤ë¡œ ì¸í•´ ì¸ë±ìŠ¤ í¬ê¸°ê°€ ë” í¬ê²Œ ì¦ê°€. 200GB ê¸°ì¤€ì€ ì½”ì–´ í…Œì´ë¸”ì˜ ë³µì¡í•œ ì¸ë±ìŠ¤ êµ¬ì¡°ë¥¼ ê³ ë ¤í•œ ìˆ˜ì¹˜
- ë„ì… íƒ€ì´ë°: ì„ê³„ê°’ì˜ 50~70% ë„ë‹¬ ì‹œì ì— ë¯¸ë¦¬ ë„ì…

â†’ íŒŒí‹°ì…”ë‹ ë„ì…ì€ "ì„±ëŠ¥ ë¬¸ì œ í•´ê²°"ì´ ì•„ë‹ˆë¼ "ì„±ëŠ¥ ë¬¸ì œ ì˜ˆë°©" ëª©ì ì…ë‹ˆë‹¤.

Supabase ì¿¼í„° / ì œí•œ:

âš ï¸ ì¤‘ìš”: SupabaseëŠ” "ì„œë²„ë¦¬ìŠ¤ì²˜ëŸ¼ ë¬´í•œì • ì“´ë‹¤"ëŠ” ì°©ê°ì„ í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. í”Œëœë³„ ì œí•œì´ ìˆìŠµë‹ˆë‹¤.

ì£¼ìš” ì œí•œ ì‚¬í•­ (ì˜ˆì‹œ, ì‹¤ì œëŠ” Supabase ìµœì‹  ë¬¸ì„œ í™•ì¸ í•„ìš”):

í•¨ìˆ˜ ì‹¤í–‰ ìˆ˜:
- Free: ì œí•œì 
- Pro: ì›”ê°„ ì‹¤í–‰ ìˆ˜ ì œí•œ
- Enterprise: ë” ë†’ì€ ì œí•œ

ìŠ¤í† ë¦¬ì§€:
- íŒŒì¼ ì €ì¥ ìš©ëŸ‰ ì œí•œ
- ëŒ€ìš©ëŸ‰ íŒŒì¼ ì—…ë¡œë“œ ì‹œ ì£¼ì˜

ë„¤íŠ¸ì›Œí¬ ì „ì†¡ëŸ‰:
- ì›”ê°„ ì „ì†¡ëŸ‰ ì œí•œ
- ëŒ€ìš©ëŸ‰ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹œ ì£¼ì˜

DB í¬ê¸°:
- í”Œëœë³„ ìµœëŒ€ DB í¬ê¸° ì œí•œ
- íŒŒí‹°ì…”ë‹ìœ¼ë¡œ ì˜¤ë˜ëœ ë°ì´í„° ì•„ì¹´ì´ë¹™ í•„ìš”

ëª¨ë‹ˆí„°ë§ ì „ëµ:
- Supabase Dashboardì—ì„œ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
- ì¿¼í„° ì„ê³„ê°’ ì„¤ì • (ì˜ˆ: 80% ë„ë‹¬ ì‹œ ì•Œë¦¼)
- ìƒìš©í™” ë‹¨ê³„ì—ì„œ í”Œëœ ì—…ê·¸ë ˆì´ë“œ êµ¬í˜„ ì˜ˆì •

â†’ ìƒì„¸ ì œì•½ì‚¬í•­ì€ Supabase ìµœì‹  ê³µì‹ ë¬¸ì„œë¥¼ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

3-2. ë©€í‹°í…Œë„ŒíŠ¸ & RLS ì„¤ê³„ ì›ì¹™ (Critical)

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ë©€í‹°í…Œë„ŒíŠ¸ êµ¬ì¡°ì˜ í•µì‹¬ ì„¤ê³„ ì›ì¹™ì„ ëª…ì‹œí•©ë‹ˆë‹¤.

3-2-1. tenant_id ì „ëµ ë° PK ì„¤ê³„

[ë¶ˆë³€ ê·œì¹™] ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ í…Œì´ë¸”ì€ tenant_idë¥¼ í•„ìˆ˜ ì»¬ëŸ¼ìœ¼ë¡œ í¬í•¨í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] PK ì„¤ê³„ëŠ” bigserial id + tenant_id ì¡°í•©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (tenant_id, local_id) ë³µí•©í‚¤ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

PK ì„¤ê³„ ì›ì¹™:

âœ… ê¶Œì¥ íŒ¨í„´ (í‘œì¤€):
-- âš ï¸ ë ˆê±°ì‹œ: students í…Œì´ë¸”ì€ ë ˆê±°ì‹œì´ë©°, ì‹ ê·œ ì½”ë“œì—ì„œëŠ” ì‚¬ìš© ê¸ˆì§€
-- ì •ë³¸ ì—”í‹°í‹° ëª¨ë¸: persons í…Œì´ë¸” (Core Party) + academy_students í…Œì´ë¸” (ì—…ì¢…ë³„ í™•ì¥)
-- ì‹ ê·œ ì½”ë“œëŠ” persons + academy_students ì¡°í•©ë§Œ ì‚¬ìš©
CREATE TABLE students (
  id bigserial PRIMARY KEY,
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  name text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  ...
);

CREATE INDEX idx_students_tenant ON students(tenant_id);
CREATE INDEX idx_students_tenant_created ON students(tenant_id, created_at DESC);

âŒ ê¸ˆì§€ íŒ¨í„´:
-- âš ï¸ ë ˆê±°ì‹œ ì°¸ê³ : students í…Œì´ë¸”ì€ ë ˆê±°ì‹œì…ë‹ˆë‹¤.
-- ì •ë³¸ ì—”í‹°í‹° ëª¨ë¸: persons í…Œì´ë¸” (Core Party) + academy_students í…Œì´ë¸” (ì—…ì¢…ë³„ í™•ì¥)
-- ì‹ ê·œ ì½”ë“œëŠ” persons + academy_students ì¡°í•©ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
CREATE TABLE students (
  tenant_id uuid NOT NULL,
  local_id bigint NOT NULL,
  PRIMARY KEY (tenant_id, local_id),  -- ë³µí•©í‚¤ ì‚¬ìš© ê¸ˆì§€
  ...
);

ì´ìœ :
- bigserial idëŠ” ì „ì—­ ìœ ë‹ˆí¬ì„±ì„ ë³´ì¥í•˜ì—¬ ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ ì‹œ ì•ˆì „
- ë³µí•©í‚¤ëŠ” JOIN ë³µì¡ë„ ì¦ê°€ ë° ì™¸ë˜í‚¤ ì°¸ì¡° ì–´ë ¤ì›€
- ì¸ë±ìŠ¤ ì„±ëŠ¥ ì¸¡ë©´ì—ì„œ bigserial ë‹¨ì¼ PKê°€ ìœ ë¦¬

industry_type ì²˜ë¦¬ ì „ëµ:

[ë¶ˆë³€ ê·œì¹™] industry_typeì€ tenants í…Œì´ë¸”ì—ì„œ ì¡°ì¸í•˜ì—¬ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ë©°, ìì£¼ ì¡°íšŒë˜ëŠ” í…Œì´ë¸”(students, invoices ë“±)ì—ëŠ” ì»¬ëŸ¼ìœ¼ë¡œ í•¨ê»˜ ì €ì¥í•©ë‹ˆë‹¤.

ì˜µì…˜ 1 (ê¶Œì¥): í…Œì´ë¸”ì— industry_type ì»¬ëŸ¼ í¬í•¨
-- âš ï¸ ë ˆê±°ì‹œ ì°¸ê³ : students í…Œì´ë¸”ì€ ë ˆê±°ì‹œì…ë‹ˆë‹¤.
-- ì •ë³¸ ì—”í‹°í‹° ëª¨ë¸: persons í…Œì´ë¸” (Core Party) + academy_students í…Œì´ë¸” (ì—…ì¢…ë³„ í™•ì¥)
-- ì‹ ê·œ ì½”ë“œëŠ” persons + academy_students ì¡°í•©ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
CREATE TABLE students (
  id bigserial PRIMARY KEY,
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  industry_type text NOT NULL,  -- tenants.industry_typeê³¼ ë™ì¼
  name text NOT NULL,
  ...
);

ì˜µì…˜ 2: tenant_settingsì—ì„œ ì¡°ì¸ (íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ìš©)
-- ìì£¼ ì¡°íšŒë˜ì§€ ì•ŠëŠ” í…Œì´ë¸”ì—ì„œë§Œ ì‚¬ìš©
SELECT s.*, t.industry_type
FROM students s
JOIN tenants t ON s.tenant_id = t.id;

â†’ ê¸°ë³¸ì€ ì˜µì…˜ 1ì´ë©°, ì˜µì…˜ 2ëŠ” íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ì—ì„œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

3-2-2. RLS ê·œì¹™ í…œí”Œë¦¿ ë° í…Œì´ë¸” ê·¸ë£¹ êµ¬ë¶„

[ë¶ˆë³€ ê·œì¹™] RLS ì •ì±…ì€ í…Œì´ë¸” ê·¸ë£¹ë³„ë¡œ ë‹¤ë¥´ê²Œ ì ìš©í•©ë‹ˆë‹¤.

í…Œì´ë¸” ê·¸ë£¹ ë¶„ë¥˜:

A. ì™„ì „ í…Œë„ŒíŠ¸ë³„ ê²©ë¦¬ í…Œì´ë¸” (ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë°ì´í„°)

ì˜ˆ: students, invoices, payments, attendance_logs, guardians, classes ë“±

RLS ì •ì±… í…œí”Œë¦¿ (í‘œì¤€):

âš ï¸ ì¤‘ìš”: PgBouncer Transaction Poolingì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ê¸°ë³¸ì ìœ¼ë¡œ JWT claim ê¸°ë°˜ RLSë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

**ì •ë³¸ íŒ¨í„´ (ê¶Œì¥):**
- JWT claim ê¸°ë°˜: `tenant_id = (auth.jwt() ->> 'tenant_id')::uuid`
- Transaction Pooling í˜¸í™˜, ì„±ëŠ¥ ìš°ìˆ˜

**ì˜ˆì™¸ íŒ¨í„´ (í—ˆìš©, ê·¼ê±° í•„ìš”):**
- auth.uid + RBAC ì¡°ì¸: `tenant_id IN (SELECT tenant_id FROM user_tenant_roles WHERE user_id = auth.uid())`
- ì‚¬ìš© ì¡°ê±´: ë³µì¡í•œ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ê°€ í•„ìš”í•œ ê²½ìš°, ì¸ë±ìŠ¤ ìµœì í™” í•„ìš”

ì˜µì…˜ 1: JWT claim ê¸°ë°˜ RLS (ê¶Œì¥, Transaction Pooling í˜¸í™˜):

ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_students ON public.students
FOR ALL TO authenticated
USING (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
)
WITH CHECK (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
);

â†’ JWT claimì—ì„œ tenant_idë¥¼ ì§ì ‘ ì½ì–´ RLS ì •ì±… ì ìš©
â†’ PgBouncer Transaction Poolingê³¼ ì™„ë²½ í˜¸í™˜
â†’ Supabase JWT ìƒì„± ì‹œ tenant_idë¥¼ claimì— í¬í•¨í•´ì•¼ í•¨

âš ï¸ ë ˆê±°ì‹œ ì˜µì…˜ 2: ì„¸ì…˜ ë³€ìˆ˜ ê¸°ë°˜ RLS (Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ ì „ìš©):

ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_students ON public.students
FOR ALL TO authenticated
USING (
  tenant_id = NULLIF(current_setting('app.current_tenant_id', true), '')::uuid
)
WITH CHECK (
  tenant_id = NULLIF(current_setting('app.current_tenant_id', true), '')::uuid
);

âš ï¸ ë ˆê±°ì‹œ ì˜ˆì‹œ: JWT claim ê¸°ë°˜ RLS ì‚¬ìš© ê¶Œì¥. ì´ ë°©ì‹ì€ PgBouncer Transaction Poolingê³¼ í˜¸í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
â†’ NULLIF(current_setting(..., true), '') íŒ¨í„´ì€ ë¯¸ì„¤ì • ì‹œ NULLì„ ë°˜í™˜í•˜ì—¬ ì–´ë–¤ rowë„ í†µê³¼í•˜ì§€ ëª»í•˜ë„ë¡ ì•ˆì „ ê°€ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
â†’ âš ï¸ ì£¼ì˜: ì´ ë°©ì‹ì€ PgBouncer Transaction Poolingê³¼ í˜¸í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—ë§Œ ìœ íš¨í•©ë‹ˆë‹¤.

â†’ ì¿¼ë¦¬ì¸µ(services/*)ì—ì„œëŠ” í•­ìƒ ëª…ì‹œì  tenant_id í•„í„°ë¥¼ ë™ì‹œì— ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤ (RLSëŠ” ë³´ì•ˆ ë ˆì´ì–´, í•„í„°ë§ì€ ì¿¼ë¦¬ ë ˆì´ì–´).

B. ì „ì—­ ê³µí†µ í…Œì´ë¸” (RLS ì ìš© ì•ˆ í•¨ ë˜ëŠ” ì œí•œì  ì ìš©)

ì˜ˆ: notification_templates, system_configs, core_regions ë“±

RLS ì •ì±…:
- Super Adminë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê±°ë‚˜
- RLS ë¹„í™œì„±í™” (ì „ì—­ ê³µí†µ ë°ì´í„°)

ì˜ˆì‹œ:
ALTER TABLE notification_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY notification_templates_superadmin ON notification_templates
FOR ALL TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM user_platform_roles
    WHERE user_id = auth.uid()
    AND role = 'super_admin'
  )
);
-- âš ï¸ ì¤‘ìš”: super_adminì€ user_platform_roles(í”Œë«í¼ ê¶Œí•œ)ì— ì†í•˜ë©°, user_tenant_roles(í…Œë„ŒíŠ¸ ê¶Œí•œ)ê°€ ì•„ë‹™ë‹ˆë‹¤.
-- ìœ„ ì˜ˆì‹œëŠ” RLS ì •ì±… ì˜ˆì‹œì´ë©°, ì‹¤ì œ êµ¬í˜„ì€ RLS.txt ë˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ SSOTë¡œ ì°¸ì¡°í•˜ì„¸ìš”.

C. ìµëª… ì ‘ê·¼ í—ˆìš© í…Œì´ë¸” (Public ë°ì´í„°)

ì˜ˆ: public_landing_pages, public_announcements ë“±

RLS ì •ì±…:
- SELECTëŠ” ìµëª… ì‚¬ìš©ìë„ í—ˆìš©
- INSERT/UPDATE/DELETEëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ

ì˜ˆì‹œ:
CREATE POLICY public_landing_pages_read ON public_landing_pages
FOR SELECT
TO public
USING (true);  -- ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥

CREATE POLICY public_landing_pages_write ON public_landing_pages
FOR ALL
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM user_tenant_roles
    WHERE user_id = auth.uid()
    AND role IN ('super_admin', 'admin')
  )
);

3-2-3. Industry Layer ìŠ¤í‚¤ë§ˆ í™•ì¥ ì „ëµ

[ë¶ˆë³€ ê·œì¹™] Industry LayerëŠ” "Core Party í…Œì´ë¸” + ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”" íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì—…ì¢…ë³„ë¡œ ì™„ì „ ë³„ë„ í…Œì´ë¸”ì„ ë§Œë“œëŠ” íŒ¨í„´ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: Core Party ëª¨ë¸ì€ `core-party` ëª¨ë“ˆì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

Core Party í…Œì´ë¸” (ëª¨ë“  ì—…ì¢… ê³µí†µ):

CREATE TABLE persons (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  name text NOT NULL,
  email text,
  phone text,
  address text,
  person_type text NOT NULL CHECK (person_type IN ('learner', 'student', 'customer', 'member', 'resident', 'donor', 'instructor', 'teacher')),  -- ì—…ì¢…ë³„ ì˜ë¯¸ ë‹¤ë¦„ (learner/instructorëŠ” ì •ë³¸ í‚¤, student/teacherëŠ” backward compatibility)
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

[ë¶ˆë³€ ê·œì¹™] persons í…Œì´ë¸”ì€ `core-party` ëª¨ë“ˆì—ì„œ ê´€ë¦¬ë˜ë©°, Industry LayerëŠ” ì´ë¥¼ í™•ì¥í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”:

í•™ì›(academy):
CREATE TABLE academy_students (
  person_id uuid PRIMARY KEY REFERENCES persons(id),
  grade text,
  class_name text,
  school_name text,
  ...
);

CREATE TABLE academy_classes (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  name text NOT NULL,
  ...
);

ë¯¸ìš©ì‹¤(salon):
CREATE TABLE salon_customers (
  person_id uuid PRIMARY KEY REFERENCES persons(id),
  hair_type text,
  preferred_style text,
  ...
);

CREATE TABLE salon_reservations (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  customer_id uuid REFERENCES salon_customers(person_id),
  service_id uuid,
  ...
);

ë¶€ë™ì‚°(real_estate):
CREATE TABLE estate_properties (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  address text NOT NULL,
  property_type text,
  ...
);

CREATE TABLE estate_contracts (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  property_id uuid REFERENCES estate_properties(id),
  tenant_person_id uuid REFERENCES persons(id),  -- ì„¸ì…ì
  ...
);

â†’ ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”ì€ Industry Layerì—ì„œ ì •ì˜í•˜ë©°, Core LayerëŠ” ê³µí†µ persons í…Œì´ë¸”ë§Œ ì œê³µí•©ë‹ˆë‹¤.

â†’ ì—…ì¢…ì´ ëŠ˜ì–´ë‚˜ë„ í…Œì´ë¸” ìˆ˜ëŠ” "ì—…ì¢… ìˆ˜ Ã— ë„ë©”ì¸ ìˆ˜"ì— ë”°ë¼ ëŠ˜ì–´ë‚˜ë©°, í…Œë„ŒíŠ¸ ìˆ˜ì™€ëŠ” ë¬´ê´€í•©ë‹ˆë‹¤.

3-2-3-1. Industry Layer í™•ì¥ ê·œë²” (Critical)

âš ï¸ ì¤‘ìš”: ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ í™•ì¥ ì‹œ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•˜ëŠ” ê·œì¹™ì…ë‹ˆë‹¤.

ì»¬ëŸ¼ í™•ì¥ ê·œì¹™:

Core Party í…Œì´ë¸” (persons)ì€ Core Layerì—ì„œ ê´€ë¦¬:
- Core LayerëŠ” persons í…Œì´ë¸”ì˜ ê¸°ë³¸ ì»¬ëŸ¼ë§Œ ì œê³µ
- Core LayerëŠ” ì—…ì¢…ë³„ í™•ì¥ ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ

ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”ì€ Industry Layerì—ì„œ ê´€ë¦¬:
- ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”ì€ persons í…Œì´ë¸”ì„ ì°¸ì¡° (person_id FK)
- ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”ì€ ì—…ì¢… ì „ìš© ì»¬ëŸ¼ë§Œ í¬í•¨
- ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”ì€ tenant_id í•„ìˆ˜ í¬í•¨

ì—…ì¢… ê³µí†µ vs ì—…ì¢… íŠ¹í™” êµ¬ë¶„:

ì—…ì¢… ê³µí†µ ì»¬ëŸ¼ (Core Party í…Œì´ë¸”):
- name, email, phone, address, person_type
- created_at, updated_at

ì—…ì¢… íŠ¹í™” ì»¬ëŸ¼ (ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”):
- í•™ì›: grade, class_name, school_name
- ë¯¸ìš©ì‹¤: hair_type, preferred_style
- ë¶€ë™ì‚°: property_type, contract_type

ìŠ¤í‚¤ë§ˆ ë²„ì „ ì¶©ëŒ ì „ëµ:

ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸” ì¶”ê°€ ì‹œ:
- ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” Industry Layer íŒ¨í‚¤ì§€ì— í¬í•¨
- ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ëª…: `{ì—…ì¢…}_{í…Œì´ë¸”ëª…}_{ë‚ ì§œ}.sql`
- ì˜ˆ: `academy_students_20250115.sql`

ì—…ì¢… ê°„ ìŠ¤í‚¤ë§ˆ ì¶©ëŒ ë°©ì§€:
- ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”ì€ ì—…ì¢… prefix ì‚¬ìš© (academy_, salon_, estate_ ë“±)
- í…Œì´ë¸” ì´ë¦„ ì¶©ëŒ ë°©ì§€
- ì¸ë±ìŠ¤ ì´ë¦„ ì¶©ëŒ ë°©ì§€ (tenant_id ì¸ë±ìŠ¤ëŠ” ì—…ì¢…ë³„ë¡œ ë¶„ë¦¬)

ì—…ì¢…ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ìˆœì„œ:
1. Core Layer ë§ˆì´ê·¸ë ˆì´ì…˜ (persons í…Œì´ë¸” ë³€ê²½)
2. Industry Layer ë§ˆì´ê·¸ë ˆì´ì…˜ (ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”)
3. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (ê¸°ì¡´ ë°ì´í„° ë³€í™˜)

ì—…ì¢…ë³„ ê¸°ë³¸ ì—”í‹°í‹° í…œí”Œë¦¿:

ëª¨ë“  ì—…ì¢…ì€ ë‹¤ìŒ íŒ¨í„´ì„ ë”°ë¼ì•¼ í•¨:

```sql
-- Core Party í…Œì´ë¸” (Core Layer)
CREATE TABLE persons (
  id uuid PRIMARY KEY,
  tenant_id uuid NOT NULL,
  name text NOT NULL,
  -- ... ê³µí†µ í•„ë“œ
);

-- ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸” (Industry Layer)
CREATE TABLE {ì—…ì¢…}_{ì—”í‹°í‹°ëª…} (
  person_id uuid PRIMARY KEY REFERENCES persons(id),
  tenant_id uuid NOT NULL,  -- ì¸ë±ìŠ¤ í•„ìˆ˜
  -- ... ì—…ì¢… íŠ¹í™” í•„ë“œ
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_{ì—…ì¢…}_{ì—”í‹°í‹°}_tenant ON {ì—…ì¢…}_{ì—”í‹°í‹°ëª…}(tenant_id);

-- RLS ì •ì±…
CREATE POLICY tenant_isolation_{ì—…ì¢…}_{ì—”í‹°í‹°} ON {ì—…ì¢…}_{ì—”í‹°í‹°ëª…}
FOR ALL TO authenticated
USING (tenant_id = (auth.jwt() -> 'tenant_id')::uuid)
WITH CHECK (tenant_id = (auth.jwt() -> 'tenant_id')::uuid);
```

â†’ ì´ í…œí”Œë¦¿ì„ ë”°ë¼ì•¼ ì—…ì¢… ê°„ ì¼ê´€ì„± ìœ ì§€ ë° í™•ì¥ ìš©ì´

3-2-4. Soft vs Hard Isolation ìˆ˜ì¤€

í˜„ì¬ êµ¬ì¡°: Soft Isolation (ê³µìš© DB + RLS)

[ë¶ˆë³€ ê·œì¹™] í˜„ì¬ êµ¬ì¡°ëŠ” Soft Isolation(ê³µìš© DB + RLS)ì„ ì‚¬ìš©í•˜ë©°, ëª¨ë“  í…Œë„ŒíŠ¸ê°€ ë‹¨ì¼ PostgreSQL ì¸ìŠ¤í„´ìŠ¤ì— ê³µì¡´í•©ë‹ˆë‹¤.

ğŸ“Œ Isolation ì „ëµ êµ¬ë¶„ (Critical):

| Isolation ìˆ˜ì¤€ | ì ìš© ë²”ìœ„ | ì„¤ëª… | Phase |
|----------------|----------|------|-------|
| **Soft Isolation** | ëª¨ë“  í…Œë„ŒíŠ¸ | ê³µìš© DB + RLS + tenant_id ë…¼ë¦¬ì  ê²©ë¦¬ | ìƒìš©í™” ë‹¨ê³„ ê¸°ë³¸ |
| **ì—…ì¢…ë³„ ë¶„ë¦¬** | ì—…ì¢… ë‹¨ìœ„ | industry_type íŒŒí‹°ì…”ë‹ â†’ prefix í…Œì´ë¸” â†’ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ | ì„ íƒì  êµ¬í˜„ (ì‹¤ì œ í•„ìš” ì‹œ) |
| **Hot Tenant ë¶„ë¦¬** | íŠ¹ì • í…Œë„ŒíŠ¸ ë‹¨ìœ„ | íŠ¹ì • tenant_idë§Œ ë³„ë„ DBë¡œ ìˆ˜ì§ ë¶„ë¦¬ | ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤ (í˜„ì¬ ë¶ˆí•„ìš”) |
| **Hard Isolation** | ì „ì²´ êµ¬ì¡° ë³€ê²½ | í…Œë„ŒíŠ¸ ë‹¨ìœ„ DB ë¶„ë¦¬, Multi-Region | ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤ (í˜„ì¬ ë¶ˆí•„ìš”) |

âš ï¸ ì¤‘ìš”: ì´ 4ê°€ì§€ ì „ëµì€ ì„œë¡œ ë‹¤ë¥¸ ëª©ì ê³¼ ë²”ìœ„ë¥¼ ê°€ì§€ë©°, í˜¼ë™í•˜ì§€ ì•Šë„ë¡ ëª…í™•íˆ êµ¬ë¶„í•´ì•¼ í•©ë‹ˆë‹¤.

Soft Isolation íŠ¹ì§•:
- ëª¨ë“  í…Œë„ŒíŠ¸ê°€ ë™ì¼ DB/ìŠ¤í‚¤ë§ˆ ê³µìœ 
- RLS + tenant_idë¡œ ë…¼ë¦¬ì  ê²©ë¦¬
- í…Œë„ŒíŠ¸ ìˆ˜ ì¦ê°€ ì‹œ í–‰(row) ìˆ˜ë§Œ ì¦ê°€, í…Œì´ë¸” êµ¬ì¡°ëŠ” ë™ì¼
- ìš´ì˜ ë¹„ìš© íš¨ìœ¨ì , ê´€ë¦¬ ë‹¨ìˆœ
- **ì ìš© ë²”ìœ„**: ìƒìš©í™” ë‹¨ê³„ ê¸°ë³¸ êµ¬ì¡°, 2~3ë§Œ í…Œë„ŒíŠ¸ê¹Œì§€ ì¶©ë¶„

ì—…ì¢…ë³„ ë¶„ë¦¬ (ì—…ì¢… ë‹¨ìœ„ Isolation):
- **ëª©ì **: íŠ¹ì • ì—…ì¢…ì˜ ë°ì´í„°ëŸ‰/ì¡°íšŒëŸ‰ì´ í­ì¦í•  ë•Œ í•´ë‹¹ ì—…ì¢…ë§Œ ë¶„ë¦¬
- **ë°©ì‹**: industry_type íŒŒí‹°ì…”ë‹ â†’ prefix í…Œì´ë¸” â†’ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ (Migration Roadmap ì°¸ì¡°)
- **ì ìš© ë²”ìœ„**: ì„ íƒì  êµ¬í˜„ (ì‹¤ì œ í•„ìš” ì‹œ), ì—…ì¢… ë‹¨ìœ„ë¡œ ì„ íƒì  ì ìš©
- **ì˜ˆì‹œ**: academy ì—…ì¢…ë§Œ academy.students ìŠ¤í‚¤ë§ˆë¡œ ë¶„ë¦¬

Hot Tenant ë¶„ë¦¬ (í…Œë„ŒíŠ¸ ë‹¨ìœ„ Isolation):
- **ëª©ì **: íŠ¹ì • í…Œë„ŒíŠ¸ì˜ íŠ¸ë˜í”½/ë°ì´í„°ëŸ‰ì´ ì „ì²´ DB ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ë•Œ í•´ë‹¹ í…Œë„ŒíŠ¸ë§Œ ë¶„ë¦¬
- **ë°©ì‹**: íŠ¹ì • tenant_id ë°ì´í„°ë¥¼ ë³„ë„ PostgreSQL ì¸ìŠ¤í„´ìŠ¤ë¡œ ìˆ˜ì§ ë¶„ë¦¬ (ìˆ˜ë™)
- **ì ìš© ë²”ìœ„**: ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤ (í˜„ì¬ ë¶ˆí•„ìš”), í…Œë„ŒíŠ¸ ë‹¨ìœ„ë¡œ ì„ íƒì  ì ìš©
- **ì˜ˆì‹œ**: ëŒ€í˜• í•™ì› ì²´ì¸(ë‹¨ì¼ í…Œë„ŒíŠ¸)ë§Œ ë³„ë„ DBë¡œ ë¶„ë¦¬

Hard Isolation ë¡œë“œë§µ (ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤, í˜„ì¬ ë¶ˆí•„ìš”):

âš ï¸ ì¤‘ìš”: Hard Isolationì€ ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸ ê·œëª¨ì—ì„œë§Œ ê²€í† í•˜ëŠ” ì˜µì…˜ì´ë©°, 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ì´ ë¹„í˜„ì‹¤ì ì…ë‹ˆë‹¤.

Hard Isolation ì˜µì…˜:

ì˜µì…˜ 1: í…Œë„ŒíŠ¸ ë‹¨ìœ„ DB ë¶„ë¦¬ (ìˆ˜ë™)
- íŠ¹ì • Hot Tenantë§Œ ë³„ë„ PostgreSQL ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¶„ë¦¬
- CDC(Change Data Capture) ê¸°ë°˜ ë™ê¸°í™”
- ìš´ì˜ ë³µì¡ë„ ë§¤ìš° ë†’ìŒ

ì˜µì…˜ 2: í”„ë¡œì íŠ¸ ë‹¨ìœ„ ë¶„ë¦¬ (Supabase Multi-Project)
- SupabaseëŠ” ê³µì‹ì ìœ¼ë¡œ Multi-Project ìë™í™”ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ
- ìˆ˜ë™ìœ¼ë¡œ í”„ë¡œì íŠ¸ ìƒì„±/ê´€ë¦¬ í•„ìš”

ì˜µì…˜ 3: ì™¸ë¶€ DB ì†”ë£¨ì…˜ (Neon, AWS RDS, Aurora)
- Multi-Region ì§€ì› í•„ìš” ì‹œ
- Supabase ì œì•½ì„ ë²—ì–´ë‚˜ì•¼ í•  ë•Œ

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” Soft Isolationë§Œ ì‚¬ìš©í•˜ë©°, Hard Isolationì€ ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤(ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸)ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”í•˜ë¯€ë¡œ í˜„ì¬ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.

â†’ ì‹¤ì œ 2~3ë§Œ í…Œë„ŒíŠ¸ ìˆ˜ì¤€ì—ì„œëŠ” Soft Isolation + íŒŒí‹°ì…”ë‹ + Read Replicaë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: ë©€í‹°í…Œë„ŒíŠ¸/RLS êµ¬ì¡° ì•ˆì „ì„±

ì´ ì¡°í•©(tenant_id NOT NULL + INDEX + RLS + ì„œë¹„ìŠ¤ ë ˆì´ì–´ 2ì¤‘ í•„í„°)ì€ Supabase + PostgreSQL ë©€í‹°í…Œë„ŒíŠ¸ì—ì„œ ê±°ì˜ í‘œì¤€ì— ê°€ê¹Œìš´ íŒ¨í„´ìœ¼ë¡œ, ë³´ì•ˆ/ì„±ëŠ¥ ê´€ì ì—ì„œ êµ¬ì¡°ì ìœ¼ë¡œ ì•ˆì „í•©ë‹ˆë‹¤.

ë‹¤ë§Œ, ê°œë°œíŒ€ì— ê³„ì† ê°•ì¡°í•´ì•¼ í•  ì‚¬í•­:
- ì¿¼ë¦¬ì—ì„œ tenant_id ì¡°ê±´ ë¹ ì§€ë©´ "ë™ì‘ì€ í•˜ì§€ë§Œ ëŠë ¤ì§€ëŠ”" ì¼€ì´ìŠ¤ â†’ ëª¨ë‹ˆí„°ë§ í•„ìš”
- íŠ¹íˆ attendance_logs, analytics.events ê°™ì´ íŒŒí‹°ì…”ë‹ëœ í…Œì´ë¸”ì€ tenant_id, occurred_at ì¸ë±ìŠ¤ íŒ¨í„´ì„ ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•¨


Edge Functionì—ì„œ tenant_id ì„¤ì •:

âš ï¸ ì¤‘ìš”: PgBouncer Transaction Poolingì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, set_configëŠ” ì‘ë™í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ JWT claim ê¸°ë°˜ RLSë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ì˜µì…˜ 1: JWT claim ê¸°ë°˜ (ê¶Œì¥):
- Supabase JWT ìƒì„± ì‹œ tenant_idë¥¼ claimì— í¬í•¨
- RLS ì •ì±…ì—ì„œ auth.jwt() ->> 'tenant_id'ë¡œ ì½ê¸°
- Edge Functionì—ì„œ ë³„ë„ ì„¤ì • ë¶ˆí•„ìš”

ì˜µì…˜ 2: ì„¸ì…˜ ë³€ìˆ˜ ê¸°ë°˜ (Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ ì „ìš©) - âš ï¸ Deprecated:

ğŸš¨ [ë¶ˆë³€ ê·œì¹™] set_config('app.current_tenant_id')ëŠ” RLS ì •ì±…ì—ì„œ ì§ì ‘ ì‚¬ìš©í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: RLS íŒ¨í„´ SSOT (ì •ë³¸ ê·œì¹™, í™•ì •)

**ì •ë³¸ íŒ¨í„´ (ì•ˆ A, í™•ì •): JWT claim ê¸°ë°˜ `auth.jwt() ->> 'tenant_id'`**

- âœ… **ì •ë³¸**: ëª¨ë“  ì¼ë°˜ í…Œì´ë¸”ì€ JWT claim ê¸°ë°˜ `auth.jwt() ->> 'tenant_id'` ì‚¬ìš© (Transaction Pooling í˜¸í™˜)
- âœ… **ì¥ì **: "í˜„ì¬ ì„ íƒëœ í…Œë„ŒíŠ¸" ê²©ë¦¬ê°€ í™•ì‹¤, Zero-Trust ì›ì¹™ê³¼ ì¼ê´€ì„±
- âš ï¸ **ìš”êµ¬ì‚¬í•­**: í…Œë„ŒíŠ¸ ì „í™˜ ì‹œ í† í° ì¬ë°œê¸‰/ê°±ì‹  í”Œë¡œìš°ê¹Œì§€ SSOTë¡œ ê³ ì • í•„ìš” (ì•„ë˜ ì°¸ì¡°)

**í…Œë„ŒíŠ¸ ì „í™˜ í”Œë¡œìš° (SSOT):**
1. ì‚¬ìš©ìê°€ í…Œë„ŒíŠ¸ ì„ íƒ UIì—ì„œ í…Œë„ŒíŠ¸ ë³€ê²½
2. í”„ë¡ íŠ¸ì—”ë“œ: `@api-sdk/core`ì˜ `switchTenant(tenantId)` í˜¸ì¶œ
3. ì„œë²„/Edge Function: ìƒˆë¡œìš´ JWT í† í° ë°œê¸‰ (tenant_id claim í¬í•¨)
4. í”„ë¡ íŠ¸ì—”ë“œ: ìƒˆ í† í°ìœ¼ë¡œ ëª¨ë“  í›„ì† ìš”ì²­ ìˆ˜í–‰

**ğŸ”¥ Critical: RLS tenant íŒë³„ ë°©ì‹ í˜¼ì¬ ë¬¸ì œ (ì¦‰ì‹œ ìˆ˜ì • ê¶Œì¥):**

**í˜„ì¬ RLS.txt ìƒíƒœ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ ì¤‘):**

í˜„ì¬ RLS.txtì—ëŠ” ë‘ íŒ¨í„´ì´ í˜¼ì¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤:
- âœ… **JWT claim ê¸°ë°˜ (ì •ë³¸)**: `attendance_logs`, `automation_actions`, `automation_undo_logs`, `automation_safety_state`, `ai_decision_logs`, `tags`, `tag_assignments`, `tenant_features` ë“±
  - âš ï¸ ì°¸ê³ : automation_actions í…Œì´ë¸”ì˜ request_idëŠ” ë³„ë„ ê·œì¹™ì„ ë”°ë¦…ë‹ˆë‹¤ (ì±—ë´‡.md 6.3.1 ì°¸ì¡°)
  - request_id í˜•ì‹: `{task_id}:{action}:{attempt_window}` (5ë¶„ ë²„í‚·)
  - automation_actions í…Œì´ë¸”ì—ì„œ request_id ìœ ë‹ˆí¬ ì œì•½ìœ¼ë¡œ ë©±ë“± ê°•ì œ
  - âš ï¸ ì°¸ê³ : automation_actions(ì›Œí¬í”Œë¡œìš° ì´ë²¤íŠ¸)ì™€ execution_audit_runs(ì‹¤í–‰ ê²°ê³¼)ì˜ ê´€ê³„ëŠ” ì•¡í‹°ë¹„í‹°.md ì°¸ì¡°
- âš ï¸ **ë ˆê±°ì‹œ íŒ¨í„´ (ë§ˆì´ê·¸ë ˆì´ì…˜ ëŒ€ìƒ)**: `academy_classes`, `academy_students`, `academy_teachers`, `ai_insights`, `persons` ë“±ì€ `user_tenant_roles` ì¡°ì¸ ê¸°ë°˜

**ë¬¸ì œì :**
1. **ì„±ëŠ¥ ì €í•˜**: `user_tenant_roles` ì¡°ì¸ì€ ë§¤ ì¿¼ë¦¬ë§ˆë‹¤ ì„œë¸Œì¿¼ë¦¬ ì‹¤í–‰ â†’ ì¸ë±ìŠ¤ ìµœì í™” í•„ìš”
2. **ë³´ì•ˆ ìœ„í—˜**: PgBouncer Transaction Pooling í™˜ê²½ì—ì„œ ì¼ê´€ì„± ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
3. **ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ì„±**: í–¥í›„ PgBouncer ì„¤ì • ë³€ê²½ ì‹œ ì¼ë¶€ í…Œì´ë¸”ë§Œ ì ‘ê·¼ ë¶ˆê°€/í—ˆìš©ë˜ëŠ” ë¹„ì •ìƒ ìƒíƒœ ë°œìƒ ê°€ëŠ¥

**ì¡°ì¹˜ ê¶Œì¥:**
- **Aê·¸ë£¹ (ì¼ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ í…Œì´ë¸”)**: JWT claim ê¸°ë°˜ìœ¼ë¡œ ë‹¨ì¼í™” (`tenant_id = (auth.jwt() ->> 'tenant_id')::uuid`)
- **Bê·¸ë£¹ (ë³µì¡ ê¶Œí•œ í…Œì´ë¸”)**: ì¡°ì¸ í—ˆìš© + ëª…ì‹œì  ë¬¸ì„œí™” (ì˜ˆ: `user_tenant_roles` ìì²´ëŠ” ì¡°ì¸ í•„ìš”)
- **í˜¼ì¬ ê¸ˆì§€**: ë¬¸ì„œ/ì½”ë“œ SSOT ìœ„ë°˜, ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš ìˆ˜ë¦½ í•„ìˆ˜

**ë§ˆì´ê·¸ë ˆì´ì…˜ ìš°ì„ ìˆœìœ„:**
1. **P0 (ì¦‰ì‹œ)**: `persons`, `academy_students`, `academy_teachers` (Core Party ëª¨ë¸, ëª¨ë“  ì—…ì¢… ê¸°ë°˜)
2. **P1 (ìƒìš©í™” ë‹¨ê³„ ì „)**: `academy_classes`, `ai_insights` (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í•µì‹¬)
3. **P2 (ìƒìš©í™” ë‹¨ê³„)**: ë‚˜ë¨¸ì§€ ë ˆê±°ì‹œ í…Œì´ë¸”

**ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš:**
- ì‹ ê·œ í…Œì´ë¸”/ì •ì±…: ë°˜ë“œì‹œ JWT claim ê¸°ë°˜ë§Œ ì‚¬ìš©
- ê¸°ì¡´ í…Œì´ë¸”: ì ì§„ì ìœ¼ë¡œ JWT claim ê¸°ë°˜ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì • (ìƒìš©í™” ë‹¨ê³„)
- âš ï¸ í˜„ì¬ ìƒíƒœ: ë¬¸ì„œ SSOTëŠ” JWT claim ê¸°ë°˜ì´ì§€ë§Œ, ì¼ë¶€ í…Œì´ë¸”ì€ ì•„ì§ ë ˆê±°ì‹œ íŒ¨í„´ ì‚¬ìš© ì¤‘

âš ï¸ ì¤‘ìš”: ì´ ë°©ì‹ì€ Supabase í™˜ê²½ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” PgBouncer Transaction Poolingê³¼ í˜¸í™˜ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**âš ï¸ ë ˆê±°ì‹œ/ì˜ˆì™¸ ì¼€ì´ìŠ¤ (Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ ì „ìš©, ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ì‚¬ìš© ê¸ˆì§€):**

ì•„ë˜ íŒ¨í„´ì€ Transaction Poolingê³¼ í˜¸í™˜ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```sql
-- âš ï¸ ë ˆê±°ì‹œ ì˜ˆì‹œ: Transaction Poolingì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŒ, JWT claim ê¸°ë°˜ RLS ì‚¬ìš© ê¶Œì¥
-- âŒ ê¸ˆì§€: RLS ì •ì±…ì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²½ìš° (ìƒìš©í™” ë‹¨ê³„ ì‚¬ìš© ê¸ˆì§€)
SELECT set_config('app.current_tenant_id', tenant_id, true);
```

âš ï¸ ì°¸ê³ : ì´ íŒ¨í„´ì€ Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ í™˜ê²½ì—ì„œë§Œ ì˜ˆì™¸ì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë©°, Supabase ê¸°ë³¸ í™˜ê²½(Transaction Pooling)ì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

âœ… **ì •ë³¸**: JWT claim ê¸°ë°˜ RLSë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (ì˜µì…˜ 1 ì°¸ì¡°)

3-3. ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬

ê¸°ë³¸ êµ¬ì¡°: public ìŠ¤í‚¤ë§ˆ + industry_type ì»¬ëŸ¼ìœ¼ë¡œ ê´€ë¦¬ (í‘œì¤€)

ëª¨ë“  ë„ë©”ì¸ í…Œì´ë¸”ì€ public ìŠ¤í‚¤ë§ˆì— ì €ì¥ë˜ë©°, industry_type ì»¬ëŸ¼ìœ¼ë¡œ ì—…ì¢…ì„ êµ¬ë¶„í•œë‹¤.

ìŠ¤í‚¤ë§ˆ	ì—­í• 
public	ëŒ€ë¶€ë¶„ì˜ ë„ë©”ì¸ (ê¸°ë³¸ íŒ¨í„´)
analytics	ì§‘ê³„/í†µê³„
meta	ë°°ì¹˜/ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬
audit	ê°ì‚¬ ë¡œê·¸ (ì¡°íšŒ í¬í•¨)

ì—…ì¢…ë³„ ë°ì´í„° ë¶„ë¦¬ ì „ëµ (ê³„ì¸µì  í™•ì¥):

ğŸ“Œ ìƒìœ„ ì›ì¹™ (ì² í•™ì  í†µì¼ì„±):

[ë¶ˆë³€ ê·œì¹™] ê¸°ë³¸ ì² í•™ì€ "ë‹¨ì¼ í…Œì´ë¸” + industry_type ì»¬ëŸ¼ + Soft Isolation"ì´ë©°, ëª¨ë“  í™•ì¥ ì „ëµì€ ì´ ê¸°ë³¸ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì„ íƒì ìœ¼ë¡œ ë¶„ë¦¬í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

í•µì‹¬ ì›ì¹™:
1. ê¸°ë³¸ êµ¬ì¡°: ëª¨ë“  ì—…ì¢…ì´ public ìŠ¤í‚¤ë§ˆì˜ ë™ì¼ í…Œì´ë¸”ì— ê³µì¡´ (industry_type ì»¬ëŸ¼ìœ¼ë¡œ êµ¬ë¶„)
2. í™•ì¥ ì „ëµ: íŠ¹ì • ì—…ì¢…ì˜ ë°ì´í„°ëŸ‰/ì¡°íšŒëŸ‰ì´ í­ì¦í•  ë•Œë§Œ í•´ë‹¹ ì—…ì¢…ì„ ì„ íƒì ìœ¼ë¡œ ë¶„ë¦¬
3. ë¶„ë¦¬ ë²”ìœ„: ì „ì²´ êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³ , í•„ìš”í•œ ì—…ì¢…ë§Œ ì„ íƒì ìœ¼ë¡œ ë¶„ë¦¬
4. ì¼ê´€ì„± ìœ ì§€: ë¶„ë¦¬ëœ ì—…ì¢…ë„ ë™ì¼í•œ ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìœ ì§€

âš ï¸ ì¤‘ìš”: ì—…ì¢…ë³„ ë°ì´í„° ë¶„ë¦¬ëŠ” 3ê°€ì§€ ëª¨ë¸ì´ ìˆìœ¼ë‚˜, ë„ì… ìˆœì„œì™€ ì¡°ê±´ì´ ëª…í™•íˆ êµ¬ë¶„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

ğŸ“Œ Migration Roadmap (ì—…ì¢…ë³„ ë°ì´í„° ë¶„ë¦¬ ì „ëµ) - í†µí•© ì „í™˜ ê¸°ì¤€í‘œ:

| ë‹¨ê³„ | ë¶„ë¦¬ ë°©ì‹ | ì „í™˜ ê¸°ì¤€ (ëª…í™•í•œ ìˆ˜ì¹˜) | ì„¤ëª… |
|------|----------|----------------------|------|
| ìƒìš©í™” ë‹¨ê³„ | industry_type ì»¬ëŸ¼ ë‹¨ì¼ í…Œì´ë¸” | í…Œë„ŒíŠ¸ ìˆ˜ < 5,000<br>í…Œì´ë¸” í¬ê¸° < 50GB<br>ë‹¨ì¼ ì—…ì¢… row ìˆ˜ < 1ì²œë§Œ | ê¸°ë³¸ êµ¬ì¡°. ëª¨ë“  ì—…ì¢…ì´ public ìŠ¤í‚¤ë§ˆì˜ ë™ì¼ í…Œì´ë¸”ì— ê³µì¡´ |
| ìƒìš©í™” ë‹¨ê³„ | industry_type ê¸°ë°˜ íŒŒí‹°ì…”ë‹ | íŠ¹ì • ì—…ì¢… row ìˆ˜ â‰¥ 1ì²œë§Œ<br>ë˜ëŠ” íŠ¹ì • ì—…ì¢… í…Œì´ë¸” í¬ê¸° â‰¥ 50GB<br>ë˜ëŠ” íŠ¹ì • ì—…ì¢… QPSê°€ ì „ì²´ì˜ 30% ì´ˆê³¼ | SELECT ê²½ë¡œ ì°¨ë³„í™” ìš©ë„. ì˜ˆ: `students_academy PARTITION OF students FOR VALUES IN ('academy')` |
| ìƒìš©í™” ë‹¨ê³„ | ì—…ì¢…ë³„ prefix í…Œì´ë¸” (ì„ íƒì ) | ì—…ì¢… ì „ìš© ë„ë©”ì¸ í…Œì´ë¸” í•„ìš” ì‹œ<br>(Core Party í…Œì´ë¸”ê³¼ëŠ” ë³„ê°œ) | ì—…ì¢… ì „ìš© ë„ë©”ì¸ í…Œì´ë¸”ë§Œ. ì˜ˆ: `academy_classes`, `salon_customers` (Core Party í…Œì´ë¸”ê³¼ëŠ” ë³„ê°œ) |
| ì„ íƒì  êµ¬í˜„ | ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ | í…Œë„ŒíŠ¸ ìˆ˜ â‰¥ 20k<br>ë˜ëŠ” Core í…Œì´ë¸”(students/invoices) ë‹¨ì¼ íŒŒí‹°ì…˜ â‰¥ 200GB<br>ë˜ëŠ” íŠ¹ì • ì—…ì¢… ì¡°íšŒëŸ‰ì´ ì „ì²´ì˜ 50% ì´ˆê³¼ | ì¡°íšŒëŸ‰ í¸ì¤‘ ì‹œ. ì˜ˆ: `academy.students`, `salon.customers` |

ğŸ“Œ ì „í™˜ ê¸°ì¤€ ìƒì„¸ ì„¤ëª…:

1. **í…Œë„ŒíŠ¸ ìˆ˜ ê¸°ì¤€**: ì „ì²´ í…Œë„ŒíŠ¸ ìˆ˜ê°€ ì¦ê°€í•˜ë©´ ì—…ì¢…ë³„ ë¶„ë¦¬ í•„ìš”ì„± ì¦ê°€
2. **í…Œì´ë¸” í¬ê¸° ê¸°ì¤€**: ë‹¨ì¼ í…Œì´ë¸” ë˜ëŠ” íŒŒí‹°ì…˜ì´ 50GB(íŒŒí‹°ì…”ë‹) ë˜ëŠ” 200GB(ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬) ë„ë‹¬ ì‹œ ì„±ëŠ¥ ì €í•˜
3. **Row ìˆ˜ ê¸°ì¤€**: íŠ¹ì • ì—…ì¢…ì˜ row ìˆ˜ê°€ 1ì²œë§Œ ì´ìƒì´ë©´ íŒŒí‹°ì…”ë‹ ê²€í† 
4. **íŠ¸ë˜í”½ ê¸°ì¤€**: íŠ¹ì • ì—…ì¢…ì˜ QPSê°€ ì „ì²´ì˜ 30% ì´ˆê³¼ ì‹œ íŒŒí‹°ì…”ë‹, 50% ì´ˆê³¼ ì‹œ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ ê²€í† 
5. **ì—…ì¢…ë³„ ë°ì´í„° ì¦ê°€ ì†ë„**: ì›”ê°„ ì¦ê°€ìœ¨ì´ 10% ì´ìƒ ì§€ì†ë˜ë©´ ì¡°ê¸° ì „í™˜ ê²€í† 

âš ï¸ ì¤‘ìš”: ìœ„ ê¸°ì¤€ ì¤‘ í•˜ë‚˜ë¼ë„ ë„ë‹¬í•˜ë©´ í•´ë‹¹ ì—…ì¢…ë§Œ ì„ íƒì ìœ¼ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤. ì „ì²´ êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³  í•„ìš”í•œ ì—…ì¢…ë§Œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬(academy.students)ì™€ ì—…ì¢…ë³„ í…Œì´ë¸” prefix(academy_classes)ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì „ëµì´ë©°, ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•©ë‹ˆë‹¤. ë‘˜ì„ ë™ì‹œì— ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ê¸°ë³¸ ì›ì¹™:
- ê¸°ë³¸ì€ public ìŠ¤í‚¤ë§ˆ + industry_type ì»¬ëŸ¼
- í™•ì¥ì€ íŒŒí‹°ì…”ë‹ â†’ prefix í…Œì´ë¸” â†’ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ ìˆœì„œë¡œ ê²€í† 
- ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ëŠ” "íŠ¹ìˆ˜ ì¼€ì´ìŠ¤(ì´ˆëŒ€ê·œëª¨)"ì—ë§Œ ì œí•œì ìœ¼ë¡œ ì‚¬ìš©
- âš ï¸ ì¤‘ìš”: "3ë§Œ í…Œë„ŒíŠ¸ê¹Œì§€ ê´œì°®ë‹¤"ëŠ” ê²ƒì€ Soft Isolation êµ¬ì¡°ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ì´ë©°, ì—…ì¢…ë³„ ë¶„ë¦¬ ì „ëµ(íŒŒí‹°ì…”ë‹/prefix/ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬)ì€ 3ë§Œ í…Œë„ŒíŠ¸ ì´ì „ì—ë„ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—…ì¢…ë³„ ë°ì´í„°ëŸ‰/ì¡°íšŒëŸ‰ì´ í­ì¦í•˜ë©´ í•´ë‹¹ ì—…ì¢…ë§Œ ì„ íƒì ìœ¼ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.

3-4. ì¤‘ì•™ í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬ ì‹œìŠ¤í…œ (Critical)

âš ï¸ ì¤‘ìš”: ëª¨ë“  í™˜ê²½ë³€ìˆ˜ëŠ” packages/env-registryë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼í•´ì•¼ í•˜ë©°, process.env ì§ì ‘ ì ‘ê·¼ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.

3-4-1. êµ¬ì¡° ë° ìœ„ì¹˜

packages/env-registry/

â”œâ”€ src/
â”‚  â”œâ”€ index.ts                 # ì§„ì…ì  (server/client/common export)
â”‚  â”œâ”€ server.ts                # ğŸ”µ ì„œë²„/Edge ì „ìš© (Node + Edge + Supabaseìš©)
â”‚  â”œâ”€ client.ts                # ğŸ”µ í´ë¼ì´ì–¸íŠ¸ ì „ìš© (React/Next.js í´ë¼ì´ì–¸íŠ¸ìš©)
â”‚  â”œâ”€ common.ts                # ğŸ”µ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ê³µí†µ (ì•±ëª…, ë²„ì „ì •ë³´ ë“±)
â”‚  â”œâ”€ schema.ts                 # Zod ê¸°ë°˜ í™˜ê²½ë³€ìˆ˜ ìŠ¤í‚¤ë§ˆ ì •ì˜
â”‚  â””â”€ resolve.ts               # Vercel/Supabase í™˜ê²½ë³€ìˆ˜ ë¡œë”© ë¡œì§ (Edge/App/Node í™˜ê²½ ìë™ ì¸ì‹)
â”œâ”€ .env.example                # í™˜ê²½ë³€ìˆ˜ ì˜ˆì‹œ íŒŒì¼ (ì‹¤ì œ í‚¤ ì œì™¸)
â””â”€ package.json

âš ï¸ ì¤‘ìš”: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìœ„ì¹˜
- í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬: .env.local (ë¡œì»¬ ê°œë°œìš©, gitignore, ì¤‘ì•™ ê´€ë¦¬)
- packages/env-registry/.env.example: ì˜ˆì‹œ íŒŒì¼ë§Œ (ì‹¤ì œ í‚¤ ì œì™¸)
- ëª¨ë“  ì•±ê³¼ íŒ¨í‚¤ì§€ëŠ” ë£¨íŠ¸ì˜ .env.local íŒŒì¼ì„ ê³µìœ í•˜ë©°, packages/env-registry/src/server.tsì—ì„œ dotenvë¡œ ìë™ ë¡œë“œë¨

3ë‹¨ê³„ ë¶„ë¦¬ êµ¬ì¡°:
- ğŸ”µ server-env: ëª¨ë“  SECRET ë³€ìˆ˜ í¬í•¨ (SERVICE_ROLE_KEY, webhook secret ë“±)
- ğŸ”µ client-env: NEXT_PUBLIC_*ë¡œ ì‹œì‘í•˜ëŠ” ë³€ìˆ˜ë§Œ (ì ˆëŒ€ Service Role Key í¬í•¨ X)
- ğŸ”µ common-env: ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ê³µí†µ (industry_mode, ì•±ëª…, ë²„ì „ì •ë³´ ë“±)

íŠ¹ì§•:
- ìœ íš¨ì„± ê²€ì¦(Zod): Missing ë³€ìˆ˜ ì—ëŸ¬ ì¦‰ì‹œ í‘œì‹œ
- Edge / App / Node í™˜ê²½ ìë™ ì¸ì‹
- ì„œë²„/í´ë¼ì´ì–¸íŠ¸/ê³µí†µ 3ë‹¨ê³„ ë¶„ë¦¬: ë¹„ë°€ ê°’ì´ í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— í¬í•¨ë˜ì§€ ì•Šë„ë¡ ë³´í˜¸
- Cursorê°€ .env ì§ì ‘ ì ‘ê·¼í•  ì¼ ì—†ìŒ
- íƒ€ì… ì•ˆì •ì„± ë³´ì¥

3-4-2. í•µì‹¬ ì›ì¹™

[ë¶ˆë³€ ê·œì¹™] ì„œë²„/Edge/Node ì½”ë“œ(services/*, Edge Functions, Server Components)ëŠ” process.envë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë°˜ë“œì‹œ packages/env-registryì—ì„œ exportëœ envServer ê°ì²´ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] React í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œëŠ” @env-registry/server importëŠ” ê¸ˆì§€ì´ê³ , @env-registry/client, envClient/envCommonë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤. Service Role Keyê°€ í¬í•¨ëœ envServerëŠ” ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— ë“¤ì–´ê°€ë©´ ì•ˆ ë©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] í™˜ê²½ë³€ìˆ˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ê²€ì¦ë˜ë©°, ëˆ„ë½ë˜ê±°ë‚˜ ì˜ëª»ëœ ê°’ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œì•¼ í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] ë¯¼ê°í•œ ì •ë³´(Service Role Key, Webhook Secret ë“±)ëŠ” íƒ€ì… ì•ˆì •ì„±ì„ ë³´ì¥í•˜ë©´ì„œë„ ëŸ°íƒ€ì„ì—ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„í•´ì•¼ í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] Edge/App/Node í™˜ê²½ì€ ìë™ìœ¼ë¡œ ì¸ì‹ë˜ë©°, ê° í™˜ê²½ì— ë§ëŠ” í™˜ê²½ë³€ìˆ˜ ë¡œë”© ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] envServerëŠ” ì„œë²„/Edge ì „ìš©ì´ë©°, í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— í¬í•¨ë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. ESLint ê·œì¹™ìœ¼ë¡œ ê°•ì œí•©ë‹ˆë‹¤.

3-4-3. í™˜ê²½ë³€ìˆ˜ ìŠ¤í‚¤ë§ˆ ì •ì˜ ì˜ˆì‹œ

// packages/env-registry/src/schema.ts
import { z } from 'zod';

// ì„œë²„/Edge ì „ìš© ìŠ¤í‚¤ë§ˆ (ëª¨ë“  í™˜ê²½ë³€ìˆ˜ í¬í•¨)
const envServerSchema = z.object({
  // Supabase
  SUPABASE_URL: z.string().url(),
  SUPABASE_ANON_KEY: z.string().min(1),
  SERVICE_ROLE_KEY: z.string().min(1),  // Edge Function / ì„œë²„ ì „ìš©
  SUPABASE_READ_REPLICA_URL: z.string().url().optional(),  // ìƒìš©í™” ë‹¨ê³„ Read Replica (ì½ê¸° ì „ìš©)

  // í™˜ê²½ êµ¬ë¶„
  NODE_ENV: z.enum(['development', 'staging', 'production']),

  // ê²°ì œ/ì•Œë¦¼ë±…í‚¹ (ìƒìš©í™” ë‹¨ê³„ í•„ìˆ˜, ì‹¤ì œ ì‚¬ìš© ì‹œì ì— requireEnv()ë¡œ ì²´í¬)
  PAYMENT_ALIMBANK_API_URL: z.string().url().optional(),
  PAYMENT_ALIMBANK_API_KEY: z.string().min(1).optional(),
  PAYMENT_WEBHOOK_SECRET: z.string().min(1).optional(),

  // ìƒìš©í™” ë‹¨ê³„ (Role ë¶„ë¦¬)
  PAYMENT_WEBHOOK_ROLE_KEY: z.string().min(1).optional(),
  BILLING_BATCH_ROLE_KEY: z.string().min(1).optional(),
  ANALYTICS_ROLE_KEY: z.string().min(1).optional(),

  // Custom Domain (ìƒìš©í™” ë‹¨ê³„)
  CUSTOM_DOMAIN_VERIFY_SECRET: z.string().min(1).optional(),

  // ì™¸ë¶€ ì›Œì»¤ (ìƒìš©í™” ë‹¨ê³„)
  AWS_LAMBDA_ANALYTICS_FUNCTION_NAME: z.string().optional(),
  CLOUDFLARE_WORKER_ANALYTICS_URL: z.string().url().optional(),

  // Kakao Maps API (ìƒìš©í™” ë‹¨ê³„ ì§€ë„ ê¸°ëŠ¥ìš©, ì„œë²„/Edge Function ì „ìš©)
  KAKAO_REST_API_KEY: z.string().min(1).optional(),
});

// í´ë¼ì´ì–¸íŠ¸ ì „ìš© ìŠ¤í‚¤ë§ˆ (NEXT_PUBLIC_* ë“± ë¹Œë“œíƒ€ì„ ë…¸ì¶œ ê°’ë§Œ)
const envClientSchema = z.object({
  NEXT_PUBLIC_SUPABASE_URL: z.string().url().optional(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1).optional(),
  NEXT_PUBLIC_KAKAO_JS_KEY: z.string().min(1).optional(),  // ìƒìš©í™” ë‹¨ê³„ ì§€ë„ ê¸°ëŠ¥ìš© (JavaScript SDK)
  // í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œ ê°€ëŠ¥í•œ ê³µê°œ ê°’ë§Œ í¬í•¨
  // ì ˆëŒ€ Service Role Keyë‚˜ ë¹„ë°€ ê°’ í¬í•¨ ê¸ˆì§€
});

// ì„œë²„/Edge ì „ìš© ê³µí†µ ìŠ¤í‚¤ë§ˆ (ì•±ëª…, ë²„ì „ì •ë³´ ë“±)
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„ìš”í•œ ê°’ì€ NEXT_PUBLIC_*ë¡œ envClientì— í¬í•¨
const envCommonSchema = z.object({
  APP_NAME: z.string().min(1).optional(),
  APP_VERSION: z.string().min(1).optional(),
  INDUSTRY_MODE: z.enum(['academy', 'salon', 'real_estate', 'gym', 'ngo']).optional(),
  // ì„œë²„/Edgeì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” ê³µê°œ ê°’
});

export type EnvServer = z.infer<typeof envServerSchema>;
export type EnvClient = z.infer<typeof envClientSchema>;
export type EnvCommon = z.infer<typeof envCommonSchema>;
export { envServerSchema, envClientSchema, envCommonSchema };

// packages/env-registry/src/resolve.ts
/**
 * ì„œë²„/Edge í™˜ê²½ë³„ í™˜ê²½ë³€ìˆ˜ ë¡œë”© ì „ëµ
 * - Edge Function (Supabase): Deno.env.toObject()
 * - Vercel (App/Node): process.env
 * - ë¡œì»¬ ê°œë°œ: process.env (dotenvë¡œ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì˜ .env.local íŒŒì¼ ìë™ ë¡œë“œ)
 *
 * âš ï¸ ì£¼ì˜: ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€ (resolveEnv() í˜¸ì¶œ ì‹œ ì—ëŸ¬ ë°œìƒ)
 *
 * í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìœ„ì¹˜:
 * - í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬: .env.local (ë¡œì»¬ ê°œë°œìš©, ì¤‘ì•™ ê´€ë¦¬)
 * - packages/env-registry/src/server.tsì—ì„œ dotenvë¡œ ìë™ ë¡œë“œ
 */
export function resolveEnv(): Record<string, string | undefined> {
  // Edge Function í™˜ê²½ ê°ì§€ (Supabase Edge FunctionsëŠ” Deno ëŸ°íƒ€ì„)
  if (typeof Deno !== 'undefined' && Deno.env) {
    const env: Record<string, string | undefined> = {};
    for (const [key, value] of Object.entries(Deno.env.toObject())) {
      env[key] = value;
    }
    return env;
  }

  // Node.js / Vercel í™˜ê²½
  if (typeof process !== 'undefined' && process.env) {
    return process.env;
  }

  throw new Error(
    'í™˜ê²½ë³€ìˆ˜ ì ‘ê·¼ ë¶ˆê°€: Edge/App/Node í™˜ê²½ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n' +
    'ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œëŠ” env-registry/serverë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n' +
    'í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œëŠ” NEXT_PUBLIC_* ë“± ë¹Œë“œíƒ€ì„ ê°’ì„ ì§ì ‘ ì‚¬ìš©í•˜ì„¸ìš”.'
  );
}

// packages/env-registry/src/server.ts
import { envServerSchema, type EnvServer } from './schema';
import { resolveEnv } from './resolve';

function validateEnvServer(): EnvServer {
  const rawEnv = resolveEnv();
  const parsed = envServerSchema.safeParse(rawEnv);

  if (!parsed.success) {
    const errors = parsed.error.errors.map(e =>
      `${e.path.join('.')}: ${e.message}`
    ).join('\n');

    const missingVars = parsed.error.errors
      .filter(e => e.code === 'invalid_type' && e.received === 'undefined')
      .map(e => e.path.join('.'))
      .join(', ');

    throw new Error(
      `í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨:\n${errors}\n\n` +
      (missingVars ? `ëˆ„ë½ëœ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜: ${missingVars}\n\n` : '') +
      `í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.\n` +
      `í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— .env.local íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜, packages/env-registry/.env.example íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.`
    );
  }

  return parsed.data;
}

// ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ê²€ì¦
export const envServer = validateEnvServer();

// íƒ€ì… ì•ˆì „í•œ ì ‘ê·¼
// ì‚¬ìš© ì˜ˆ: envServer.SUPABASE_URL, envServer.SERVICE_ROLE_KEY

// packages/env-registry/src/client.ts
import { envClientSchema, type EnvClient } from './schema';

function validateEnvClient(): EnvClient {
  // í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ì—ì„œëŠ” process.envê°€ ë¹Œë“œíƒ€ì„ì— ì¸ë¼ì¸ë¨
  // Next.jsì˜ ê²½ìš° NEXT_PUBLIC_*ë§Œ í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— í¬í•¨
  // âš ï¸ ì£¼ì˜: í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì—ì„œ process.envëŠ” ë¹Œë“œ íƒ€ì„ì—ë§Œ ì¡´ì¬í•˜ë©°,
  // ëŸ°íƒ€ì„(ë¸Œë¼ìš°ì €)ì—ì„œëŠ” ì´ë¯¸ ê°’ì´ ì¸ë¼ì¸ë˜ì–´ ìˆì–´ process.env ê°ì²´ ìì²´ëŠ” undefinedì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  if (typeof window !== 'undefined' || typeof process === 'undefined') {
    // ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œëŠ” ë¹Œë“œíƒ€ì„ì— ì´ë¯¸ ê°’ì´ ì¸ë¼ì¸ë˜ì–´ ìˆìŒ
    const rawEnv: Record<string, string | undefined> = {};
    if (typeof process !== 'undefined' && process.env) {
      // ë¹Œë“œíƒ€ì„ì— ì´ë¯¸ NEXT_PUBLIC_* ê°’ë§Œ í¬í•¨ë¨
      // ëŸ°íƒ€ì„ì—ì„œëŠ” process.envê°€ undefinedì¼ ìˆ˜ ìˆì§€ë§Œ, ë¹Œë“œíƒ€ì„ì— ì¸ë¼ì¸ëœ ê°’ì€ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.
      for (const key in process.env) {
        if (key.startsWith('NEXT_PUBLIC_')) {
          rawEnv[key] = process.env[key];
        }
      }
    }
    const parsed = envClientSchema.safeParse(rawEnv);
    return parsed.success ? parsed.data : ({} as EnvClient);
  }

  // ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ ì¤‘ì—ë„ í´ë¼ì´ì–¸íŠ¸ ìŠ¤í‚¤ë§ˆë§Œ ì‚¬ìš©
  const rawEnv: Record<string, string | undefined> = {};
  if (process.env) {
    for (const key in process.env) {
      if (key.startsWith('NEXT_PUBLIC_')) {
        rawEnv[key] = process.env[key];
      }
    }
  }
  const parsed = envClientSchema.safeParse(rawEnv);
  return parsed.success ? parsed.data : ({} as EnvClient);
}

export const envClient = validateEnvClient();

// packages/env-registry/src/common.ts
import { envCommonSchema, type EnvCommon } from './schema';

function validateEnvCommon(): EnvCommon {
  // ê³µí†µ í™˜ê²½ë³€ìˆ˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì„œë²„/Edgeì—ì„œ ì‚¬ìš©
  // í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„ìš”í•œ ê°’ì€ NEXT_PUBLIC_*ë¡œ ë³„ë„ ë…¸ì¶œ
  const rawEnv: Record<string, string | undefined> = {};

  if (typeof process !== 'undefined' && process.env) {
    // APP_NAME, APP_VERSION, INDUSTRY_MODE ë“± ê³µê°œ ê°’ë§Œ
    for (const key in process.env) {
      if (['APP_NAME', 'APP_VERSION', 'INDUSTRY_MODE'].includes(key)) {
        rawEnv[key] = process.env[key];
      }
    }
  }

  const parsed = envCommonSchema.safeParse(rawEnv);
  return parsed.success ? parsed.data : ({} as EnvCommon);
}

export const envCommon = validateEnvCommon();

// packages/env-registry/src/index.ts
// ğŸ”µ ì„œë²„/Edge ì „ìš© export (í´ë¼ì´ì–¸íŠ¸ì—ì„œ import ì‹œ ESLint ì—ëŸ¬)
export { envServer } from './server';
export type { EnvServer } from './schema';

// ğŸ”µ í´ë¼ì´ì–¸íŠ¸ ì „ìš© export
export { envClient } from './client';
export type { EnvClient } from './schema';

// ğŸ”µ ì„œë²„/Edge ì „ìš© ê³µí†µ export (í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
// envCommonì€ ì„œë²„/Edgeì—ì„œë§Œ ì‚¬ìš©í•˜ë©°, í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„ìš”í•œ ê°’ì€ NEXT_PUBLIC_*ë¡œ envClientì— í¬í•¨
export { envCommon } from './common';
export type { EnvCommon } from './schema';

3-4-4. ì‚¬ìš© íŒ¨í„´

âŒ ê¸ˆì§€ (process.env ì§ì ‘ ì ‘ê·¼):
const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SERVICE_ROLE_KEY!,
);

âœ… í—ˆìš© (ì„œë²„/Edge ì½”ë“œ):
import { envServer } from '@env-registry/server';

const supabase = createClient(
  envServer.SUPABASE_URL,
  envServer.SERVICE_ROLE_KEY,
);

âœ… í—ˆìš© (í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ):
// í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” NEXT_PUBLIC_* ê°’ë§Œ ì§ì ‘ ì‚¬ìš©
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

// ë˜ëŠ” ì„ íƒì ìœ¼ë¡œ envClient ì‚¬ìš© (ë¹Œë“œíƒ€ì„ ê°’ë§Œ)
import { envClient } from '@env-registry/client';
const supabaseUrl = envClient.NEXT_PUBLIC_SUPABASE_URL;

âŒ ì ˆëŒ€ ê¸ˆì§€ (í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ):
import { envServer } from '@env-registry/server';  // ESLint ì—ëŸ¬ ë°œìƒ
// Service Role Keyê°€ í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— í¬í•¨ë  ìœ„í—˜

3-4-5. í™˜ê²½ë³„ ì„¤ì • ê´€ë¦¬

ê°œë°œ í™˜ê²½:
- í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬: .env.local (ë¡œì»¬ ê°œë°œìš©, gitignore, ì¤‘ì•™ ê´€ë¦¬)
  - ëª¨ë“  ì•±ê³¼ íŒ¨í‚¤ì§€ê°€ ì´ íŒŒì¼ì„ ê³µìœ 
  - packages/env-registry/src/server.tsì—ì„œ dotenvë¡œ ìë™ ë¡œë“œ
- packages/env-registry/.env.example: ì˜ˆì‹œ íŒŒì¼ (ì‹¤ì œ í‚¤ ì œì™¸, git í¬í•¨)

ìŠ¤í…Œì´ì§•/í”„ë¡œë•ì…˜:
- í™˜ê²½ë³€ìˆ˜ëŠ” ë°°í¬ í”Œë«í¼(Vercel, Supabase Secrets ë“±)ì—ì„œ ê´€ë¦¬
- ì½”ë“œì—ëŠ” ê¸°ë³¸ê°’ì´ë‚˜ ì˜ˆì‹œë§Œ í¬í•¨

âš ï¸ ì¤‘ìš”:
- .env.local íŒŒì¼ì€ í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ë§Œ ìƒì„± (ê° ì•±ë³„ë¡œ ìƒì„±í•˜ì§€ ì•ŠìŒ)
- .env.local íŒŒì¼ì—ëŠ” ì‹¤ì œ Service Role Keyë¥¼ í¬í•¨í•˜ì§€ ì•Šê³ , ê°œë°œìš© í…ŒìŠ¤íŠ¸ í‚¤ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

3-4-6. Edge Functionì—ì„œì˜ ì‚¬ìš©

Edge Functionì€ Supabase Secretsë¥¼ í†µí•´ í™˜ê²½ë³€ìˆ˜ë¥¼ ì£¼ì…ë°›ìœ¼ë©°, ë™ì¼í•œ packages/env-registry íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

resolve.tsê°€ ìë™ìœ¼ë¡œ Deno í™˜ê²½ì„ ê°ì§€í•˜ì—¬ Deno.env.toObject()ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

âš ï¸ ì£¼ì˜: Edge Function ë²ˆë“¤ì— env-registry íŒ¨í‚¤ì§€ë¥¼ í¬í•¨í•  ë•Œ ë²ˆë“¤ ì‚¬ì´ì¦ˆì™€ cold start ì˜í–¥ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒìš©í™” ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì„±ëŠ¥ ì¸¡ì • í›„ ìµœì í™”ë¥¼ ê²€í† í•©ë‹ˆë‹¤.

// supabase/functions/payment-webhook/index.ts
import { envServer } from '@env-registry/server';

// envServer.SERVICE_ROLE_KEYëŠ” Supabase Secretsì—ì„œ ìë™ ì£¼ì…ë¨
// resolve.tsê°€ Deno í™˜ê²½ì„ ìë™ ê°ì§€í•˜ì—¬ Deno.envì—ì„œ ë¡œë“œ

3-4-7. Phaseë³„ í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬

ìƒìš©í™” ë‹¨ê³„:
- SUPABASE_URL, SUPABASE_ANON_KEY, SERVICE_ROLE_KEY (ë‹¨ì¼)
- PAYMENT_ALIMBANK_* (ê²°ì œ ì—°ë™) - ìŠ¤í‚¤ë§ˆëŠ” optionalì´ì§€ë§Œ ì‹¤ì œ ì‚¬ìš© ì‹œì ì— requireEnv()ë¡œ ì²´í¬
- PAYMENT_WEBHOOK_SECRET

ìƒìš©í™” ë‹¨ê³„ (í™•ì¥):
- Read Replica: SUPABASE_READ_REPLICA_URL (ì½ê¸° ì „ìš©, í†µê³„/ë¦¬í¬íŠ¸ ì¿¼ë¦¬ ë¶„ë¦¬ìš©)
- Role ë¶„ë¦¬: PAYMENT_WEBHOOK_ROLE_KEY, BILLING_BATCH_ROLE_KEY ë“±
- Custom Domain: CUSTOM_DOMAIN_VERIFY_SECRET
- ì™¸ë¶€ ì›Œì»¤: AWS_LAMBDA_*, CLOUDFLARE_WORKER_* ë“±
- Kakao Maps API: KAKAO_REST_API_KEY (ì„œë²„/Edge Function ì „ìš©), NEXT_PUBLIC_KAKAO_JS_KEY (í´ë¼ì´ì–¸íŠ¸ ì „ìš©)

â†’ ìƒìš©í™” ë‹¨ê³„ í™˜ê²½ë³€ìˆ˜ëŠ” .optional()ë¡œ ì •ì˜í•˜ì—¬ ëˆ„ë½ë˜ì–´ë„ ê²€ì¦ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

3-4-7-1. Optional í™˜ê²½ë³€ìˆ˜ì˜ ì‹¤ì œ ì‚¬ìš© ì‹œì  ì²´í¬ (Lazy Validation)

ìƒìš©í™” ë‹¨ê³„ì—ì„œ ì•Œë¦¼ë±…í‚¹ì€ í•„ìˆ˜ ê¸°ëŠ¥ì´ì§€ë§Œ, ìŠ¤í‚¤ë§ˆì—ì„œëŠ” optionalë¡œ ì •ì˜í•˜ì—¬ ì•Œë¦¼ë±…í‚¹ì´ í™œì„±í™”ë˜ì§€ ì•Šì€ í™˜ê²½ì—ì„œëŠ” ì•± ì‹œì‘ ì‹œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

ì‹¤ì œ payment-alimbank, analytics, custom-domain ëª¨ë“ˆì—ì„œ ì‚¬ìš© ì‹œì ì— requireEnv() ìœ í‹¸ì„ ì‚¬ìš©í•˜ì—¬ ê°•í•˜ê²Œ ì²´í¬í•©ë‹ˆë‹¤ (Lazy Validation):

// packages/payments/payment-alimbank/src/env.ts
import { envServer, type EnvServer } from '@env-registry/server';

/**
 * í™˜ê²½ë³€ìˆ˜ê°€ ì‹¤ì œë¡œ í•„ìš”í•œ ì‹œì ì—ë§Œ ì²´í¬í•˜ëŠ” ìœ í‹¸ (Lazy Validation)
 * ìƒìš©í™” ë‹¨ê³„ì—ì„œ ì•Œë¦¼ë±…í‚¹ì€ í•„ìˆ˜ì´ì§€ë§Œ, ìŠ¤í‚¤ë§ˆëŠ” optionalë¡œ ì •ì˜ë˜ì–´ ìˆìŒ
 *
 * ì‚¬ìš© íŒ¨í„´:
 * const secret = envServer.PAYMENT_ALIMBANK_SECRET;
 * if (!secret) throw new Error("PAYMENT_ALIMBANK_SECRET missing");
 *
 * ë˜ëŠ” requireEnv() ìœ í‹¸ ì‚¬ìš©:
 */
export function requireEnv<K extends keyof EnvServer>(
  key: K
): NonNullable<EnvServer[K]> {
  const value = envServer[key];
  if (!value) {
    throw new Error(
      `í™˜ê²½ë³€ìˆ˜ ${key}ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. (payment-alimbank ëª¨ë“ˆ)\n` +
      `ì•Œë¦¼ë±…í‚¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì´ í™˜ê²½ë³€ìˆ˜ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.`
    );
  }
  return value as NonNullable<EnvServer[K]>;
}

// ì‚¬ìš© ì˜ˆì‹œ
// packages/payments/payment-alimbank/src/client.ts
import { requireEnv } from './env';

const apiUrl = requireEnv('PAYMENT_ALIMBANK_API_URL');
const apiKey = requireEnv('PAYMENT_ALIMBANK_API_KEY');
const webhookSecret = requireEnv('PAYMENT_WEBHOOK_SECRET');

// ë˜ëŠ” ì§ì ‘ ì²´í¬ (ê°„ë‹¨í•œ ê²½ìš°)
const secret = envServer.PAYMENT_ALIMBANK_SECRET;
if (!secret) throw new Error("PAYMENT_ALIMBANK_SECRET missing");

â†’ ì´ë ‡ê²Œ í•˜ë©´ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ì•Œë¦¼ë±…í‚¹ ê¸°ëŠ¥ì„ ì‹¤ì œë¡œ "ì‚¬ìš©í•˜ëŠ” ìˆœê°„"ì—ë§Œ ê°•í•˜ê²Œ ì—ëŸ¬ë¥¼ ë„ìš°ê³ , ì•Œë¦¼ë±…í‚¹ì´ ì•„ì§ í™œì„±í™”ë˜ì§€ ì•Šì€ í™˜ê²½ì—ì„œëŠ” ê·¸ëƒ¥ ê·¸ ì½”ë“œë¥¼ ì•ˆ íƒ€ë©´ ë©ë‹ˆë‹¤.

â†’ Payment, Analytics, Custom Domain ëª¨ë“ˆ ëª¨ë‘ ë™ì¼í•œ íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

3-4-7-2. í…Œë„ŒíŠ¸ë³„ í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬ (ì„ íƒì  êµ¬í˜„, ì‹¤ì œ í•„ìš” ì‹œ)

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ì„ íƒì  êµ¬í˜„ì´ë©°, ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ í›„ì—ë§Œ ë„ì…í•©ë‹ˆë‹¤.

í˜„ì¬ êµ¬ì¡°ëŠ” "í™˜ê²½ë³€ìˆ˜ëŠ” ì „ì—­(Global)"ì´ì§€ë§Œ, SaaSê°€ ì»¤ì§€ë©´ "í…Œë„ŒíŠ¸ë³„ Secret Storage"ê°€ í•„ìš”í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì‚¬ìš© ì‚¬ë¡€:
- Larger SaaS ê³ ê°ì´ ìì²´ PG ê³„ì•½ì„ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ë•Œ
- Industry Layerì— ë”°ë¼ í‚¤ê°€ ë‹¬ë¼ì§ˆ ë•Œ
- í…Œë„ŒíŠ¸ë³„ Custom Domain Key ê´€ë¦¬ê°€ í•„ìš”í•œ ê²½ìš°

êµ¬ì¡° ì˜ˆì‹œ:

CREATE TABLE tenant_secrets (
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  secret_key text NOT NULL,  -- ì˜ˆ: 'payment_alimbank_api_key', 'custom_domain_verify_secret'
  secret_value text NOT NULL,  -- ì•”í˜¸í™”ëœ ê°’
  encrypted_at timestamptz NOT NULL DEFAULT now(),
  key_version smallint DEFAULT 1,
  PRIMARY KEY (tenant_id, secret_key)
);

CREATE INDEX idx_tenant_secrets_tenant ON tenant_secrets(tenant_id);

ALTER TABLE tenant_secrets ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_tenant_secrets ON tenant_secrets
FOR ALL TO authenticated
USING (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
)
WITH CHECK (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
);

âš ï¸ ì¤‘ìš”: PgBouncer Transaction Poolingì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, JWT claim ê¸°ë°˜ RLSë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. set_config ê¸°ë°˜ RLSëŠ” Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ ì „ìš©ì…ë‹ˆë‹¤.

ë³´ì•ˆ ê³ ë ¤ì‚¬í•­:
- secret_valueëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥ (AEAD ì•”í˜¸í™”, ì„ íƒì  êµ¬í˜„)
- KMS ê¸°ë°˜ í‚¤ íšŒì „ ì§€ì›
- í…Œë„ŒíŠ¸ë³„ Secret ì ‘ê·¼ì€ RLSë¡œ ê²©ë¦¬

ì‚¬ìš© íŒ¨í„´:

// packages/services/tenant-secret-service.ts
// services/tenant-secret-service.ts
import { withTenant } from '../_db';

export async function getTenantSecret(
  tenantId: string,
  secretKey: string
): Promise<string | null> {
  // RLSë¡œ ìë™ í•„í„°ë§ + withTenant() ì‚¬ìš©
  const { data } = await withTenant(
    supabase
      .from('tenant_secrets')
      .select('secret_value, key_version')
      .eq('secret_key', secretKey),
    tenantId
  ).single();

  if (!data) return null;

  // ë³µí˜¸í™” í›„ ë°˜í™˜
  return decryptSecret(data.secret_value, data.key_version);
}

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ì „ì—­ í™˜ê²½ë³€ìˆ˜ë§Œ ì‚¬ìš©í•˜ë©°, í…Œë„ŒíŠ¸ë³„ Secret StorageëŠ” ì„ íƒì  êµ¬í˜„(ì‹¤ì œ í•„ìš” ì‹œ)ìœ¼ë¡œ ë„ì…í•©ë‹ˆë‹¤.

3-4-8. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

[ë¶ˆë³€ ê·œì¹™] Service Role KeyëŠ” í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ(apps/*ì˜ Client Components)ì—ì„œ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°, Edge Functionê³¼ ì„œë²„ ì‚¬ì´ë“œ ì½”ë“œì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] envServerëŠ” ì„œë²„/Edge ì „ìš©ì´ë©°, í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— í¬í•¨ë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. ESLint ê·œì¹™ìœ¼ë¡œ ê°•ì œí•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] í™˜ê²½ë³€ìˆ˜ëŠ” ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ì•Šê³ , ë°˜ë“œì‹œ í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” Secrets ê´€ë¦¬ ì‹œìŠ¤í…œì„ í†µí•´ ì£¼ì…ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] .env.local íŒŒì¼ì€ gitì— ì»¤ë°‹í•˜ì§€ ì•Šìœ¼ë©°, í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ë§Œ ìƒì„±í•©ë‹ˆë‹¤ (ê° ì•±ë³„ë¡œ ìƒì„±í•˜ì§€ ì•ŠìŒ).
[ë¶ˆë³€ ê·œì¹™] packages/env-registry/.env.example íŒŒì¼ì— ì˜ˆì‹œë§Œ í¬í•¨í•©ë‹ˆë‹¤ (ì‹¤ì œ í‚¤ ì œì™¸).

3-4-8-1. ESLint ê·œì¹™ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ envServer import ê¸ˆì§€)

í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œ envServerë¥¼ importí•˜ë©´ Service Role Key ë“± ë¹„ë°€ ê°’ì´ ë²ˆë“¤ì— í¬í•¨ë  ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.

ESLint ê·œì¹™ìœ¼ë¡œ ê°•ì œí•©ë‹ˆë‹¤:

// .eslintrc.json (apps/* í”„ë¡œì íŠ¸)
{
  "rules": {
    "no-restricted-imports": [
      "error",
      {
        "paths": [
          {
            "name": "@env-registry/server",
            "message": "í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œëŠ” @env-registry/serverë¥¼ importí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. NEXT_PUBLIC_* ê°’ë§Œ ì§ì ‘ ì‚¬ìš©í•˜ì„¸ìš”."
          }
        ],
        "patterns": [
          {
            "group": ["@env-registry/server"],
            "message": "í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œëŠ” @env-registry/serverë¥¼ importí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          }
        ]
      }
    ]
  }
}

â†’ í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ envServerë¥¼ importí•˜ë ¤ê³  í•˜ë©´ ë¹Œë“œ ì‹œì ì— ESLint ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.

3-4-9. Phaseë³„ í™•ì¥ ì „ëµ

ìƒìš©í™” ë‹¨ê³„ - í˜„ì¬ ë°©ì‹ (Aì•ˆ: Monorepo ë‚´ë¶€ íŒ¨í‚¤ì§€):
- packages/env-registry/ ì‚¬ìš©
- Zod ê¸°ë°˜ ê²€ì¦
- Edge/App/Node í™˜ê²½ ìë™ ì¸ì‹
- Vercel Environment Variables + Supabase Secrets

ìƒìš©í™” ë‹¨ê³„ (í™•ì¥ ì‹œ ê³ ë ¤ ê°€ëŠ¥í•œ ì˜µì…˜):

Bì•ˆ) ì™¸ë¶€ ë¹„ë°€ ê´€ë¦¬ ì‹œìŠ¤í…œ ì—°ë™:
- AWS SSM Parameter Store
- AWS Secrets Manager
- HashiCorp Vault
- Doppler / Infisical / 1Password Secrets Automation
- â†’ DearSaaS ê·œëª¨ê°€ ì»¤ì§€ë©´ í™•ì¥ì„±ê³¼ ë³´ì•ˆ ë©´ì—ì„œ ìµœìƒ

Cì•ˆ) Supabase Config ê¸°ë°˜:
- Edge Function: Supabase Secrets ì‚¬ìš©
- í”„ë¡ íŠ¸ì™€ Node: Vercel Environment Variables ì‚¬ìš©
- ì¤‘ì•™ Manifestì—ì„œ ë™ê¸°í™”

âš ï¸ ì¤‘ìš”: ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” Aì•ˆ(Monorepo ë‚´ë¶€ íŒ¨í‚¤ì§€)ì„ ì‚¬ìš©í•˜ë©°, ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ í›„ Bì•ˆ ë˜ëŠ” Cì•ˆìœ¼ë¡œ í™•ì¥ì„ ê²€í† í•©ë‹ˆë‹¤.

4. Core ë°ì´í„° ëª¨ë¸

4-0. Profile í™•ì¥ ì „ëµ (Critical)

ì—…ì¢…ë³„/í…Œë„ŒíŠ¸ë³„ë¡œ íšŒì›ê°€ì… ì–‘ì‹/í•„ë“œ êµ¬ì„±ì´ ë‹¤ë¥´ë¯€ë¡œ, Profile í™•ì¥ ì „ëµì´ í•„ìš”í•˜ë‹¤.

ì˜µì…˜ 1: ê³µí†µ profiles + ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”

ê³µí†µ profiles í…Œì´ë¸”:
CREATE TABLE profiles (
  id uuid PRIMARY KEY,
  user_id uuid NOT NULL,
  tenant_id uuid NOT NULL,
  name text,
  email text,
  phone text,
  created_at timestamptz
);

4-0-1. Profile Schema ë³€ê²½ ì •ì±… (migration ì—†ëŠ” schema add/remove)

ì—…ì¢…ë§ˆë‹¤ ë‹¤ë¥¸ profile schema ì •ì˜ ì „ëµ:

migration ì—†ëŠ” schema add/remove ì •ì±… ëª…ì‹œ:

JSON Schema ê¸°ë°˜ ë™ì  í•„ë“œ ì¶”ê°€/ì œê±°ëŠ” migration ì—†ì´ ê°€ëŠ¥

í…Œì´ë¸” ì»¬ëŸ¼ ì¶”ê°€/ì œê±°ëŠ” ë°˜ë“œì‹œ migration í•„ìš”

ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸”:

CREATE TABLE academy_profiles (
  profile_id uuid PRIMARY KEY REFERENCES profiles(id),
  grade text,        -- í•™ë…„
  class_name text,   -- ë°˜
  school_name text   -- í•™êµëª…
);

CREATE TABLE salon_profiles (
  profile_id uuid PRIMARY KEY REFERENCES profiles(id),
  hair_type text,      -- ëª¨ë°œíƒ€ì…
  preferred_style text -- ì„ í˜¸ìŠ¤íƒ€ì¼
);

ì˜µì…˜ 2: ê³µí†µ profiles + extra_fields jsonb + JSON Schema

CREATE TABLE profiles (
  id uuid PRIMARY KEY,
  user_id uuid NOT NULL,
  tenant_id uuid NOT NULL,
  name text,
  email text,
  phone text,
  extra_fields jsonb,  -- ì—…ì¢…ë³„/í…Œë„ŒíŠ¸ë³„ í™•ì¥ í•„ë“œ
  created_at timestamptz
);

í…Œë„ŒíŠ¸ë³„ í¼ ì„¤ì •ì€ tenant_settings KV êµ¬ì¡°ì—ì„œ key='profile_schema' rowì˜ value(JSONB)ì— JSON Schemaë¡œ ì €ì¥:

{
  "schema": {
    "type": "object",
    "properties": {
      "grade": { "type": "string" },
      "class_name": { "type": "string" }
    }
  }
}

CoreëŠ” ê³µí†µ í•„ë“œë§Œ ì•Œê³ , ì—…ì¢…ë³„/í…Œë„ŒíŠ¸ë³„ í¼ì€ JSON Schema ê¸°ë°˜ ë Œë”ë§

â†’ ì—…ì¢…/í…Œë„ŒíŠ¸ë³„ í”„ë¡œí•„ ì»¬ëŸ¼ ì°¨ì´ ì´ìŠˆ í•´ê²°

4-1. Billing/Payment ê³µí†µ ìŠ¤í‚¤ë§ˆ
invoices

tenant_id

payer_id

amount

due_date

status

industry_type

â€¦

invoice_items

item_type

category

quantity

unit_price

description

payments

invoice_id

provider(alimbank/toss/kg ë“±)

paid_at

amount

status

ì—…ì¢…ë³„ ì°¨ì´ëŠ” industry ëª¨ë“ˆì—ì„œ templating/mapping,
DBëŠ” Coreì—ì„œ ê³µí†µ ìœ ì§€.

4-1-1. íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ ëª…ì‹œ (Critical)

ê¸ˆìœµì„± ë„ë©”ì¸ì€ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ëª…í™•íˆ ì •ì˜í•´ì•¼ í•¨:

Billing: REPEATABLE READ

ì²­êµ¬ì„œ ìƒì„± ì‹œ ì¼ê´€ì„± ë³´ì¥ í•„ìš”

ì¤‘ë³µ ì²­êµ¬ ë°©ì§€

Attendance: READ COMMITTED

ì¶œê²° ë°ì´í„°ëŠ” ì‹¤ì‹œê°„ì„±ì´ ì¤‘ìš”

ë‚®ì€ ê²©ë¦¬ ìˆ˜ì¤€ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”

Payments: REPEATABLE READ (ê¶Œì¥)

SERIALIZABLEì€ PostgreSQLì—ì„œ ë¹„ìš©ì´ ì»¤ì„œ REPEATABLE READ ê¶Œì¥

ì¤‘ë³µ ê²°ì œ ë°©ì§€ ë° ê¸ˆì•¡ ì •í•©ì„± ë³´ì¥

ì„¤ì • ì˜ˆì‹œ:

BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;

-- billing ì‘ì—… ìˆ˜í–‰

COMMIT;

4-1-2. ë©±ë“±ì„± ë° ì¤‘ë³µ ë°©ì§€ ì „ëµ (Critical)

âš ï¸ ì¤‘ìš”: ë©±ë“±ì„± ë° Duplicate ì²˜ë¦¬ ìƒì„¸ ì •ì±…ì€ PART 3ì˜ 14-2-1-1 "ê²°ì œ/ì•Œë¦¼ë±…í‚¹ ìš´ì˜ ì •ì±…" ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”.

ë©±ë“±ì„± í‚¤ + ìœ ë‹ˆí¬ ì œì•½ìœ¼ë¡œ ë…¼ë¦¬ì  ì¤‘ë³µ ì°¨ë‹¨:

-- ì²­êµ¬ì„œ ë©±ë“±ì„± (í…Œë„ŒíŠ¸Â·ì£¼ê¸°Â·í…œí”Œë¦¿ ì¡°í•©)
ALTER TABLE invoices
  ADD CONSTRAINT ux_invoice_period UNIQUE (tenant_id, period_start, period_end, template_key);

-- ê²°ì œ ë©±ë“±ì„± (ìš”ì²­ ë‹¨ìœ„)
ALTER TABLE payments
  ADD COLUMN idempotency_key text,
  ADD CONSTRAINT ux_payment_idem UNIQUE (tenant_id, idempotency_key);

-- Webhook ë©±ë“±ì„±ì€ 14-2-1-1 (audit.webhook_events) ì„¹ì…˜ ì°¸ì¡°

Advisory Lock ì‚¬ìš© (ì²­êµ¬ì„œ ìƒì„± ì‹œ):

-- ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ í…Œë„ŒíŠ¸-ì£¼ê¸° ë‹¨ìœ„ Advisory Lock ì‚¬ìš©
-- SELECT pg_advisory_xact_lock(hashtext(:tenant_id || :period_key));

-- ì²­êµ¬ì„œ ìƒì„± ì „ ë½ íšë“ â†’ ì¤‘ë³µ ìƒì„± ë°©ì§€
-- íŠ¸ëœì­ì…˜ ì¢…ë£Œ ì‹œ ìë™ í•´ì œ

ì£¼ì˜ì‚¬í•­:

Supabase í”ŒëœÂ·pool ëª¨ë“œì— ë”°ë¼ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ ë³€ê²½ì´ ì œí•œë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì‹¤ì œ prod í™˜ê²½ì—ì„œ ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , í•„ìš”í•œ ê²½ìš° DB ë ˆë²¨ ê¸°ë³¸ ê²©ë¦¬ ìˆ˜ì¤€ ë˜ëŠ” ë³„ë„ ì „ìš© ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•œë‹¤.

ì˜ˆì‹œëŠ” direct PG ì ‘ì† ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜(ë…¼í’€ë§) ê¸°ì¤€ì´ë©°, PgBouncer íŠ¸ëœì­ì…˜ í’€ë§ì¼ ë•Œ SETë¥˜ê°€ ì„¸ì…˜ì— ì•ˆ ë‚¨ëŠ” ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆë‹¤.

â†’ ê¸ˆìœµì„± ë„ë©”ì¸ì—ì„œëŠ” ë°˜ë“œì‹œ ëª…ì‹œí•´ì•¼ í•¨

4-2. ê³µí†µ ë„ë©”ì¸ ì˜ˆì‹œ

students, guardians, classes, attendance

members, contracts

contacts, properties

donors, donations

â†’ tenant_id + industry_typeë¡œ í™•ì¥ ì§€ì›.

4-3. Multi-Industry ê³µìš© í…Œì´ë¸” ê²½ìŸ ìœ„í—˜ (Optional)

í˜„ì¬ êµ¬ì¡°ëŠ” industry_type + tenant_id ëª¨ë¸ë¡œ ë™ì‘í•˜ë©° ë§¤ìš° íš¨ìœ¨ì ì…ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ Core í…Œì´ë¸”(students, invoices ë“±)ì€ ì—¬ëŸ¬ ì‚°ì—…ì„ ê³µìœ í•˜ë¯€ë¡œ í…Œì´ë¸”ì´ ìˆ˜ì‹­~ìˆ˜ë°± GB ìˆ˜ì¤€ê¹Œì§€ ì»¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Industry ê°„ cross-traffic ì˜í–¥ ë°©ì§€:

Core í…Œì´ë¸”ì€ industry_type + tenant_id ë³µí•© ì¸ë±ìŠ¤ê°€ í•„ìˆ˜

ì˜ˆì‹œ:

CREATE INDEX idx_students_industry_tenant
ON students(industry_type, tenant_id, created_at DESC);


ì¥ê¸°ì ìœ¼ë¡œ industry_type ë‹¨ìœ„ íŒŒí‹°ì…”ë‹ë„ ì˜µì…˜ìœ¼ë¡œ ê³ ë ¤:

-- âš ï¸ ë ˆê±°ì‹œ: students í…Œì´ë¸”ì€ ë ˆê±°ì‹œì´ë©°, ì‹ ê·œ ì½”ë“œì—ì„œëŠ” persons + academy_students ì¡°í•© ì‚¬ìš©. students í…Œì´ë¸” íŒŒí‹°ì…”ë‹ì€ ë ˆê±°ì‹œ ëª¨ë¸ì…ë‹ˆë‹¤.
-- ì •ë³¸ ì—”í‹°í‹° ëª¨ë¸: persons í…Œì´ë¸” (Core Party) + academy_students í…Œì´ë¸” (ì—…ì¢…ë³„ í™•ì¥)
-- ì‹ ê·œ ì½”ë“œëŠ” persons + academy_students ì¡°í•©ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
CREATE TABLE students_academy PARTITION OF students
FOR VALUES IN ('academy');

CREATE TABLE students_salon PARTITION OF students
FOR VALUES IN ('salon');

Industry íŒŒí‹°ì…˜ í…Œì´ë¸”ëª… ê·œì¹™:

Industry íŒŒí‹°ì…˜ í…Œì´ë¸”ëª…ì€ <table>_<industry_type> íŒ¨í„´ì„ ê°•ì œí•œë‹¤.

ì˜ˆ: industry_type='academy' â†’ students_academy, industry_type='salon' â†’ students_salon

â†’ industry_type ê°’ê³¼ partition ì´ë¦„ì„ 1:1ë¡œ ë§ì¶°ì•¼ í•˜ë©°, í…Œì´ë¸” ì´ë¦„ì„ ì œë©‹ëŒ€ë¡œ ì§“ì§€ ì•Šë„ë¡ ê·œì¹™í™”


ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ ë„ì… ê¸°ì¤€ (ì„ íƒì  êµ¬í˜„, ì‹¤ì œ í•„ìš” ì‹œ):

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ì„ íƒì  êµ¬í˜„ì´ë©°, ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ í›„ì—ë§Œ ë„ì…í•©ë‹ˆë‹¤.

ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” industry_type ì»¬ëŸ¼ ê¸°ë°˜ ë‹¨ì¼ public í…Œì´ë¸”ì„ ìœ ì§€í•©ë‹ˆë‹¤.

ğŸ“Œ Migration Roadmap ì°¸ì¡°: ìœ„ "ì—…ì¢…ë³„ ë°ì´í„° ë¶„ë¦¬ ì „ëµ" ì„¹ì…˜ì˜ ë‹¨ê³„ë³„ ë„ì… ì¡°ê±´ì„ ë”°ë¦…ë‹ˆë‹¤.

Core í…Œì´ë¸”(students/invoices)ì´ 200~300GB ì´ìƒìœ¼ë¡œ ì»¤ì§€ê±°ë‚˜ industry_type êµì°©ì´ ë°œìƒí•˜ëŠ” ê²½ìš°, ì—…ì¢…ë³„ ë¶„ë¦¬ ì˜µì…˜ì„ ë„ì…í•  ìˆ˜ ìˆë‹¤.

ğŸ“Œ ëª…ì‹œì  ì „í™˜ ê¸°ì¤€:

ë‹¤ìŒ ê¸°ì¤€ ì¤‘ í•˜ë‚˜ë¼ë„ ë„ë‹¬í•˜ë©´ ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤:

- âš ï¸ ë ˆê±°ì‹œ: students í…Œì´ë¸” ë‹¨ì¼ íŒŒí‹°ì…˜ 200~300GB ë„ë‹¬ (ì‹ ê·œ ì½”ë“œì—ì„œëŠ” persons + academy_students ì¡°í•© ì‚¬ìš©)
- invoices í…Œì´ë¸” 100M rows ì´ìƒ
- analytics.events ì—°ê°„ 1B rows ì´ìƒ

ê·¼ê±°:
- âš ï¸ ë ˆê±°ì‹œ: students/invoicesëŠ” ì½”ì–´ í…Œì´ë¸”ë¡œ ë³µì¡í•œ ì¸ë±ìŠ¤ êµ¬ì¡°(tenant_id + industry_type + created_at ë“±)ë¥¼ ê°€ì§€ë¯€ë¡œ, 200~300GB ë„ë‹¬ ì‹œ ì¸ë±ìŠ¤ í¬ê¸°ê°€ ìˆ˜ì‹­ GBì— ë‹¬í•˜ì—¬ ì¿¼ë¦¬ ì„±ëŠ¥ ì €í•˜ê°€ ë°œìƒ (ì‹ ê·œ ì½”ë“œì—ì„œëŠ” persons + academy_students ì¡°í•© ì‚¬ìš©)
- analytics.eventsëŠ” ë¡œê·¸ì„± í…Œì´ë¸”ì´ì§€ë§Œ ì—°ê°„ 1B rowsëŠ” ì›” íŒŒí‹°ì…˜ ê¸°ì¤€ ì•½ 8ì²œë§Œ rows/ì›”ë¡œ, ë‹¨ì¼ íŒŒí‹°ì…˜ 1ì–µ rows ì„ê³„ê°’ì— ê·¼ì ‘
- Industry ê°„ cross-traffic ì˜í–¥ ìµœì†Œí™”ë¥¼ ìœ„í•œ í•„ìˆ˜ ì¸ë±ìŠ¤ ì „ëµ

â†’ ì—…ì¢… ë°ì´í„°ëŸ‰ì´ 200~300GB ë„˜ì–´ê°€ê¸° ì „ì—ëŠ” í•„ìš” ì—†ìœ¼ë©°, "í–¥í›„ íŒŒí‹°ì…”ë‹ í•„ìš” ì‹œ ë„ì… ê°€ëŠ¥" ì •ë„ë¡œ ì¶•ì†Œí•©ë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬(academy.students)ì™€ ì—…ì¢…ë³„ í…Œì´ë¸” prefix(academy_classes)ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì „ëµì´ë©°, ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒí•©ë‹ˆë‹¤. ë‘˜ì„ ë™ì‹œì— ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

- ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬: academy.students, salon.customers (ìŠ¤í‚¤ë§ˆ ë ˆë²¨ ë¶„ë¦¬)
- ì—…ì¢…ë³„ prefix í…Œì´ë¸”: academy_classes, salon_customers (ê°™ì€ ìŠ¤í‚¤ë§ˆ ë‚´ prefix)

â†’ ê¸°ë³¸ì€ industry_type ì»¬ëŸ¼ ê¸°ë°˜ ë‹¨ì¼ í…Œì´ë¸”ì´ë©°, í™•ì¥ ì‹œ íŒŒí‹°ì…”ë‹ â†’ prefix í…Œì´ë¸” â†’ ìŠ¤í‚¤ë§ˆ ë¶„ë¦¬ ìˆœì„œë¡œ ê²€í† í•©ë‹ˆë‹¤.

5. ëŒ€ê·œëª¨ í…Œë„ŒíŠ¸ í™•ì¥ ì „ëµ
5-1. ì˜ˆìƒ ê·œëª¨

10,000 í•™ì› Ã— 50ëª… = í•™ìƒ 50ë§Œ

ì¶œê²° ë¡œê·¸: ì—° 1ì–µ 8ì²œë§Œ ê±´

ë‚©ë¶€ ë¡œê·¸: ì—° 600ë§Œ ê±´

5-2. ë‹¨ê³„ë³„ í™•ì¥
ë‹¨ê³„ 1) ê¸°ë³¸ ë©€í‹°í…Œë„ŒíŠ¸

ëª¨ë“  í…Œì´ë¸” tenant_id & ì¸ë±ìŠ¤

RLS ì „ë©´ ì ìš©

analytics ì§‘ê³„ëŠ” ì™¸ë¶€ ëŸ°íƒ€ì„(Lambda/Cloudflare Workers) ë°°ì¹˜ë¡œ ì²˜ë¦¬

ë‹¨ê³„ 2) íŒŒí‹°ì…”ë‹ ë„ì… (5ì²œ~2ë§Œ í…Œë„ŒíŠ¸ êµ¬ê°„)

ë¡œê·¸ì„± í…Œì´ë¸” ëŒ€ìƒ:

attendance_logs

activity_logs

payments

ì „ëµ: ì›”/ì—° ë‹¨ìœ„ RANGE íŒŒí‹°ì…”ë‹

âœ… ê¸°ë³¸ ê¶Œì¥ì•ˆ(ë‹¨ì¼ RANGE íŒŒí‹°ì…˜) ì˜ˆì‹œ:

CREATE TABLE attendance_logs (
  id bigserial,
  tenant_id uuid,
  ...
  occurred_at timestamptz
) PARTITION BY RANGE (occurred_at);

íŒŒí‹°ì…”ë‹ ë„ì… ê¸°ì¤€ (êµ¬ì²´ì  ìˆ˜ì¹˜):

ë¡œê·¸ì„± í…Œì´ë¸”: ì›” íŒŒí‹°ì…˜ ê¶Œì¥. ë‹¨ì¼ íŒŒí‹°ì…˜ 1ì–µ rows ë˜ëŠ” íŒŒí‹°ì…˜ íŒŒì¼ í¬ê¸° ~50GB ë„ë‹¬ ì‹œ ë¶„í•  ê²€í† .
- ê·¼ê±°: ë¡œê·¸ì„± í…Œì´ë¸”ì€ ì‹œê°„ ê¸°ë°˜ ì¡°íšŒê°€ ì£¼ íŒ¨í„´ì´ë©°, ì¸ë±ìŠ¤ í¬ê¸°ê°€ ì»¤ì§ˆìˆ˜ë¡ ì„±ëŠ¥ ì €í•˜ê°€ ê¸‰ê²©íˆ ë°œìƒ

ì½”ì–´ í…Œì´ë¸”(students/invoices): í…Œë„ŒíŠ¸ ìˆ˜ â‰¥ 5,000, ì´ rows â‰¥ 5ì²œë§Œ or í…Œì´ë¸” í¬ê¸° â‰¥ 200GB ì‹œ industry_type ì„œë¸Œí…Œì´ë¸”(íŒŒí‹°ì…˜) ë¶„ë¦¬ ê²€í† .
- ê·¼ê±°: ì½”ì–´ í…Œì´ë¸”ì€ ë¡œê·¸ì„± í…Œì´ë¸”ë³´ë‹¤ ì¡°íšŒ íŒ¨í„´ì´ ë‹¤ì–‘í•˜ê³ , tenant_id + industry_type ë³µí•© ì¸ë±ìŠ¤ë¡œ ì¸í•´ ì¸ë±ìŠ¤ í¬ê¸°ê°€ ë” í¬ê²Œ ì¦ê°€

ê° íŒŒí‹°ì…˜ì— ì¸ë±ìŠ¤:

[ë¶ˆë³€ ê·œì¹™] ëª¨ë“  íŒŒí‹°ì…˜ì—ëŠ” ë°˜ë“œì‹œ (tenant_id, occurred_at DESC) ë³µí•© ì¸ë±ìŠ¤ê°€ ì ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

CREATE INDEX ON attendance_logs_2025 (tenant_id, occurred_at DESC);

ê¸°ë³¸ íŒŒí‹°ì…”ë‹ ì˜ˆì‹œ (ìƒìš©í™” ë‹¨ê³„):

CREATE TABLE attendance_logs (
  id bigserial,
  tenant_id uuid NOT NULL,
  student_id uuid,
  occurred_at timestamptz NOT NULL,
  ...
) PARTITION BY RANGE (occurred_at);

CREATE TABLE attendance_logs_2025
  PARTITION OF attendance_logs
  FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

[ë¶ˆë³€ ê·œì¹™] ëª¨ë“  íŒŒí‹°ì…˜ì—ëŠ” ë°˜ë“œì‹œ (tenant_id, occurred_at DESC) ë³µí•© ì¸ë±ìŠ¤ê°€ ì ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

CREATE INDEX ON attendance_logs_2025 (tenant_id, occurred_at DESC);

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ë‹¨ì¼ RANGE íŒŒí‹°ì…”ë‹ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì½”ì–´ ì¡°íšŒ ì¸ë±ìŠ¤ (í•„ìˆ˜):

CREATE INDEX IF NOT EXISTS idx_students_tenant_created
  ON public.students(tenant_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_invoices_tenant_status_due
  ON public.invoices(tenant_id, status, due_date DESC);

ìƒìš©í™” ë‹¨ê³„ ì„ íƒ ì¸ë±ìŠ¤ (ì´ë¦„ ê²€ìƒ‰ ë“± ì‹¤ìš´ì˜ ìµœì í™”):

í•™ìƒ ì´ë¦„ ê²€ìƒ‰ì´ ë¹ˆë²ˆí•œ ê²½ìš° (ìƒìš©í™” ë‹¨ê³„):
CREATE INDEX IF NOT EXISTS idx_students_name_pattern
  ON public.students USING btree (name text_pattern_ops)
  WHERE tenant_id IS NOT NULL;

â†’ text_pattern_opsëŠ” LIKE 'ê¹€%' ê°™ì€ íŒ¨í„´ ê²€ìƒ‰ì— ìµœì í™”ëœ ì¸ë±ìŠ¤ì…ë‹ˆë‹¤.
â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ì‹¤ì œ ê²€ìƒ‰ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•  ë•Œ ì¶”ê°€í•©ë‹ˆë‹¤.

ì¸ë±ìŠ¤ ê²€ì¦ ë£¨í‹´:

ì›” 1íšŒ pg_stat_statements ìƒìœ„ 50ê°œ ì¿¼ë¦¬ ë¶„ì„ â†’ ì¸ë±ìŠ¤ ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸ì— ë°˜ì˜

Autovacuum íŠœë‹:

attendance_logs, payments ë“± write-heavy í…Œì´ë¸”ì€ autovacuum_vacuum_scale_factor, autovacuum_analyze_scale_factor, freeze_min_age íŒŒë¼ë¯¸í„°ë¥¼ í…Œì´ë¸” ë‹¨ìœ„ë¡œ ì¡°ì •í•´ì•¼ í•œë‹¤.

ì˜ˆì‹œ:

ALTER TABLE attendance_logs SET (
  autovacuum_vacuum_scale_factor = 0.05,
  autovacuum_analyze_scale_factor = 0.02,
  autovacuum_freeze_min_age = 50000000
);

â†’ ìˆ˜ë°±ë§Œ row/hour ìˆ˜ì¤€ì˜ write-heavy í…Œì´ë¸”ì—ì„œëŠ” í•„ìˆ˜ íŠœë‹

5-2-1. íŒŒí‹°ì…˜ ì •ì±… ê¸°ë°˜ ìƒì„±Â·ë³´ì¡´ ë°°ì¹˜ (Critical)

ë§¤ì›” [Policy ê¸°ë°˜ ì„ê³„ê°’ì¼] 03:00 KST: ë‹¤ìŒ ë‹¬ íŒŒí‹°ì…˜ ì •ì±… í•´ì„ í›„ ìƒì„± (Policy ê¸°ë°˜)
âš ï¸ ì¤‘ìš”: ì›”ë§ ì„ê³„ê°’ì€ Policyì—ì„œ ì¡°íšŒ (`billing.month_end_threshold_day`, ê¸°ë³¸ê°’ì€ 25ì¼, ì €ì¥ ìœ„ì¹˜ëŠ” tenant_settings(key='config').value(JSONB))

ë§¤ì›” 01ì¼ 03:10 KST: TTL ì§€ë‚œ íŒŒí‹°ì…˜ ì•„ì¹´ì´ë¸Œ/ë“œë¡­

íŒŒí‹°ì…˜ ìƒì„± í•¨ìˆ˜ ì˜ˆì‹œ:

CREATE OR REPLACE FUNCTION meta.create_month_partition(_table regclass, _yyyymm text) RETURNS void AS $$
DECLARE
  _from date := to_date(_yyyymm || '01','YYYYMMDD');
  _to   date := (_from + INTERVAL '1 month')::date;
BEGIN
  EXECUTE format(
    'CREATE TABLE IF NOT EXISTS %s_%s PARTITION OF %s FOR VALUES FROM (%L) TO (%L);',
    _table::text, to_char(_from,'YYYY_MM'), _table::text, _from, _to
  );
END; $$ LANGUAGE plpgsql SECURITY DEFINER;

ìŠ¤ì¼€ì¤„: ì™¸ë¶€ ëŸ°íƒ€ì„(Lambda/Cloudflare Workers)ì—ì„œ í˜¸ì¶œ (KST 03:00/03:10)

â†’ íŒŒí‹°ì…˜ ê´€ë¦¬ ìë™í™”ëŠ” ìš´ì˜ í•„ìˆ˜ ìš”ì†Œ

5-3. RLS ì„±ëŠ¥ ê°€ë“œë ˆì¼ ë° ìµœì í™”

ì‹¤ì‹œê°„ íŠ¸ëœì­ì…˜ â†’ RLS 100% ì ìš©

Heavy Analytics / Export â†’ SECURITY DEFINER ë˜ëŠ” Edge Function + Service Role

tenant_id í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸, audit ë¡œê·¸ í•„ìˆ˜

ì œì–´ëœ ìš°íšŒ ì˜ˆì‹œ:

CREATE OR REPLACE FUNCTION analytics.fn_aggregate_daily(
  _tenant_ids uuid[], _kst_date date
) RETURNS void
LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  -- tenant_id IN (_tenant_ids) ê°•ì œ
  -- statement_timeout, row limit í•„ìˆ˜
END; $$;


UI íŠ¸ëœì­ì…˜ ê²½ë¡œì—ì„œëŠ” í•­ìƒ RLS ì ìš©

ëª¨ë“  ìš°íšŒ ì¿¼ë¦¬ëŠ” audit.events ì— ë¡œê·¸ ë‚¨ê¹€

RLS ì„±ëŠ¥ ìµœì í™”: 2ì¤‘ í•„í„°ë§ íŒ¨í„´ (Critical)

ë¬¸ì œì : PostgreSQL RLS ì •ì±…ìœ¼ë¡œ ì¸í•´ ì¿¼ë¦¬ í”Œë˜ë„ˆê°€ ì¸ë±ìŠ¤ë¥¼ ìµœì ìœ¼ë¡œ ì„ íƒí•˜ì§€ ëª»í•˜ëŠ” ê²½ìš° ì¡´ì¬

RLS + Partition ì¡°í•© ì‹œ ì˜ˆìƒë˜ëŠ” ì„±ëŠ¥ ë¬¸ì œ (Critical):

Partition Pruningì´ tenant_idì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ (ì‹œê°„ ê¸°ë°˜ íŒŒí‹°ì…˜ ê¸°ì¤€)

RLS ì¡°ê±´ì´ plannerì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŒ

PostgreSQL 14+ì—ì„œë„ RLSê°€ plannerì— ê°„ì„­ ê°€ëŠ¥

Partitioned Tableì—ì„œëŠ” RLSê°€ Partition Pruningì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤

â†’ RLSì™€ Partitionì€ ì™„ì „íˆ ë…ë¦½ì ì´ì§€ ì•Šìœ¼ë©°, plannerê°€ ìµœì í™”ë¥¼ ì œëŒ€ë¡œ ìˆ˜í–‰í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŒ

âš ï¸ ì¤‘ìš”: Supabase í™˜ê²½ì—ì„œì˜ ì¶”ê°€ ê³ ë ¤ì‚¬í•­

PgBouncer íŠ¸ëœì­ì…˜ í’€ë§ì—ì„œëŠ” set_configê°€ ì„¸ì…˜ ë ˆë²¨ì´ ì•„ë‹˜

ì¼ë¶€ Edge Function í™˜ê²½ì—ì„  planner ì˜ˆì¸¡ì´ ë‚®ì•„ì§ˆ ê°€ëŠ¥ì„± ìˆìŒ

ğŸ“Œ ê¶Œê³ : Service Layerì—ì„œ tenant_id ê°•ì œ í•„í„°ë¥¼ lint ê·œì¹™ìœ¼ë¡œ ë§Œë“¤ì–´ë¼

multi-column index ì„¤ê³„ ì „ëµì´ ëª…í™•í•´ì•¼ í•¨

í•´ê²°ì±…: Service Layerì—ì„œ í•­ìƒ tenant_id ì¡°ê±´ì„ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€

ê·œì¹™: ëª¨ë“  Service Layer ì¿¼ë¦¬ëŠ” WHERE ì ˆì— tenant_id ì¡°ê±´ í•„ìˆ˜

â†’ ì´ë¯¸ ë¬¸ì„œì— ê¸°ì¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ OK. ESLint ê·œì¹™ìœ¼ë¡œ ê°•ì œí•˜ì—¬ ê°œë°œìê°€ ì‹¤ìˆ˜ë¡œ tenant_id ì¡°ê±´ì„ ë¹ ëœ¨ë¦¬ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.

5-3-1. ì¿¼ë¦¬ íŒ¨í„´ë³„ ê¶Œì¥ ì¸ë±ìŠ¤ ë§¤íŠ¸ë¦­ìŠ¤ (Critical)

ì¿¼ë¦¬ íŒ¨í„´	ê¶Œì¥ ì¸ë±ìŠ¤	ì˜ˆì‹œ
tenant_id + occurred_at (ì‹œê°„ ë²”ìœ„)	(tenant_id, occurred_at)	attendance_logs ì¡°íšŒ
tenant_id + status + created_at	(tenant_id, status, created_at)	ë¯¸ë‚© ì²­êµ¬ì„œ ì¡°íšŒ
tenant_id + industry_type	(tenant_id, industry_type)	ì—…ì¢…ë³„ í•™ìƒ ì¡°íšŒ
tenant_id + email_hash (PII ê²€ìƒ‰)	(tenant_id, email_hash)	ë³´í˜¸ì ì´ë©”ì¼ ê²€ìƒ‰

ì¸ë±ìŠ¤ ì„¤ê³„ ì›ì¹™:

í•­ìƒ tenant_idë¥¼ ì²« ë²ˆì§¸ ì»¬ëŸ¼ìœ¼ë¡œ í¬í•¨ (Partition Pruning ìµœì í™”)

ì‹œê°„ ê¸°ë°˜ ì¿¼ë¦¬ëŠ” (tenant_id, occurred_at) ë³µí•© ì¸ë±ìŠ¤ í•„ìˆ˜

RLS ì¡°ê±´ê³¼ WHERE ì ˆ ì¡°ê±´ì´ ì¼ì¹˜í•˜ë„ë¡ ì„¤ê³„

ì˜ˆì‹œ:

-- âŒ ì˜ëª»ëœ ì˜ˆ (RLSë§Œ ì˜ì¡´)
SELECT * FROM students WHERE name = 'ê¹€ì² ìˆ˜';

-- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ (RLS + ëª…ì‹œì  í•„í„°)
SELECT * FROM students
WHERE tenant_id = :tenant_id AND name = 'ê¹€ì² ìˆ˜';


RLSëŠ” ë³´ì•ˆ ë ˆì´ì–´, í•„í„°ë§ì€ ì¿¼ë¦¬ ë ˆì´ì–´ì—ì„œ ìˆ˜í–‰í•˜ëŠ” "2ì¤‘ í•„í„°ë§ íŒ¨í„´" ë„ì…

â†’ ì„±ëŠ¥ ì €í•˜ ë°©ì§€ì— ë§¤ìš° íš¨ê³¼ì ì´ë©° ì‹¤ë¬´ì—ì„œ í•„ìˆ˜ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹

RLS + Partition ì¡°í•© ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­:

Partitioned Tables ì‚¬ìš© ì‹œ, RLS ì¡°ê±´ì´ Partition Pruningì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, tenant_idë¥¼ Partition Keyë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” êµ¬ì¡°(=ì‹œê°„ ê¸°ë°˜ íŒŒí‹°ì…˜)ëŠ” ìœ ì§€í•˜ëŠ” ê²ƒì´ ì˜³ìŒ.

ì‹œê°„ ê¸°ë°˜ íŒŒí‹°ì…”ë‹ì„ ìœ ì§€í•˜ë©´ RLS ì¡°ê±´ê³¼ ë…ë¦½ì ìœ¼ë¡œ Partition Pruningì´ ì‘ë™í•˜ì—¬ ì¿¼ë¦¬ í”Œë˜ë„ˆê°€ ìµœì ì˜ í”Œëœì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

5-4. ì´ì¤‘ íŒŒí‹°ì…”ë‹ (ì‹œê°„ RANGE + tenant HASH) (ì„ íƒì  êµ¬í˜„, ì‹¤ì œ í•„ìš” ì‹œ)

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ì„ íƒì  êµ¬í˜„ì´ë©°, ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ í›„ì—ë§Œ ë„ì…í•©ë‹ˆë‹¤.

ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ë‹¨ì¼ RANGE íŒŒí‹°ì…”ë‹ë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.

íŠ¸ë˜í”½ì´ ë§¤ìš° í° í™˜ê²½ì—ì„œ ì„ íƒì ìœ¼ë¡œ ë„ì… ê°€ëŠ¥í•œ ì˜µì…˜(ì´ì¤‘ íŒŒí‹°ì…”ë‹ ì˜ˆì‹œ):

Hot Partition ë°©ì§€ ë° Shard ì´í–‰ ìš©ì´ì„±ì„ ìœ„í•´ ì´ì¤‘ íŒŒí‹°ì…”ë‹ ì „ëµ ì ìš© (ì„ íƒì  êµ¬í˜„, ì‹¤ì œ í•„ìš” ì‹œ):

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ì„ íƒì  êµ¬í˜„ì´ë©°, ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ í›„ì—ë§Œ ë„ì…í•©ë‹ˆë‹¤.

ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ë‹¨ì¼ RANGE íŒŒí‹°ì…”ë‹ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì´ì¤‘ íŒŒí‹°ì…”ë‹ êµ¬ì¡° (ì°¸ê³ ìš© ì˜ˆì‹œ):

CREATE TABLE attendance_logs (
  id bigserial,
  tenant_id uuid NOT NULL,
  occurred_at timestamptz NOT NULL
) PARTITION BY RANGE (occurred_at);

CREATE TABLE attendance_logs_2025_01
  PARTITION OF attendance_logs
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01')
  PARTITION BY HASH (tenant_id);

â†’ Hot Partition ë°©ì§€ / Shard ì´í–‰ ìš©ì´.

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ë‹¨ì¼ RANGE íŒŒí‹°ì…”ë‹ë§Œ ì‚¬ìš©í•˜ë©°, ì´ì¤‘ íŒŒí‹°ì…”ë‹ì€ ì„ íƒì  êµ¬í˜„(ì‹¤ì œ í•„ìš” ì‹œ)ìœ¼ë¡œ ê²€í† í•©ë‹ˆë‹¤.

â†’ ì‹¤ì œ 2~3ë§Œ í…Œë„ŒíŠ¸ ìˆ˜ì¤€ì—ì„œëŠ” ë‹¨ì¼ RANGE íŒŒí‹°ì…”ë‹ë§Œìœ¼ë¡œ ì¶©ë¶„í•˜ë©°, ì´ì¤‘ íŒŒí‹°ì…”ë‹ì€ ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸ ê·œëª¨ì—ì„œë§Œ ê²€í† í•©ë‹ˆë‹¤.

ë‹¨ê³„ 3) Read Replica (ì¡°íšŒ íŠ¸ë˜í”½ ë¶„ë¦¬)

ë¦¬í¬íŠ¸/í†µê³„/ëŒ€ì‹œë³´ë“œ ì¡°íšŒëŠ” replicaë¡œ ì „ì†¡

core-analyticsëŠ” replica ê¸°ë°˜ heavy query ì‹¤í–‰

ë‹¨ê³„ 4) ë¦¬ì „/ìƒ¤ë”© (ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤, í˜„ì¬ ë¶ˆí•„ìš”)

AP-Northeast-2(í•œêµ­), AP-Southeast-1(ë™ë‚¨ì•„) ë“± ë¶„ë¦¬

í…Œë„ŒíŠ¸ ID í•´ì‹œ ê¸°ë°˜ ë¼ìš°íŒ…

Supabase í´ë¼ì´ì–¸íŠ¸ì—ì„œ DB route layer ì¶”ê°€

5-5. Hot Tenant ëŒ€ì‘ ì „ëµ (Critical)

ë¬¸ì œì : íŠ¹ì • í…Œë„ŒíŠ¸ì˜ íŠ¸ë˜í”½Â·ì²­êµ¬Â·ì¶œê²° í­ì£¼ ì‹œ ì „ì²´ DB ì„±ëŠ¥ì— ì˜í–¥

Hot Tenant ìë™ ê°ì§€ ì§€í‘œ

tenantë³„ QPS, CPU, IOPS ë¹„ì¤‘ ëª¨ë‹ˆí„°ë§

ê¸‰ì¦ íŒ¨í„´ íƒì§€: 5ë¶„ ì´ë™í‰ê·  ëŒ€ë¹„ 200% ì¦ê°€ ì‹œ ê²½ê³ 

Hot Tenant ê°ì§€ ì„ê³„ê°’ (ëª¨ë‹ˆí„°ë§ìš©):
- ë‹¨ì¼ í…Œë„ŒíŠ¸ QPSê°€ ì „ì²´ì˜ 10% ì´ˆê³¼
- ë‹¨ì¼ í…Œë„ŒíŠ¸ CPU ì‚¬ìš©ëŸ‰ì´ ì „ì²´ì˜ 15% ì´ˆê³¼
- ë‹¨ì¼ í…Œë„ŒíŠ¸ IOPSê°€ ì „ì²´ì˜ 20% ì´ˆê³¼

ğŸ“Œ Hot Tenant ìƒ¤ë”© íŠ¸ë¦¬ê±° ê¸°ì¤€ (ì •ëŸ‰í™”ëœ ìˆ˜ì¹˜):

[ë¶ˆë³€ ê·œì¹™] ë‹¤ìŒ ê¸°ì¤€ ì¤‘ 3ê°œ ì´ìƒì„ ë™ì‹œì— ë§Œì¡±í•˜ë©´ Hot Tenant ìƒ¤ë”©ì„ ê²€í† í•©ë‹ˆë‹¤:

1. ì´ˆë‹¹ ìš”ì²­ ìˆ˜ (QPS):
   - ë‹¨ì¼ í…Œë„ŒíŠ¸ QPS â‰¥ 1,000 req/s
   - ë˜ëŠ” ë‹¨ì¼ í…Œë„ŒíŠ¸ QPSê°€ ì „ì²´ì˜ 30% ì´ˆê³¼ (7ì¼ ì´ë™í‰ê· )

2. ì›”ë³„ Row ì¦ê°€ëŸ‰:
   - ë‹¨ì¼ í…Œë„ŒíŠ¸ ì›”ë³„ row ì¦ê°€ëŸ‰ â‰¥ 1ì²œë§Œ rows/ì›”
   - ë˜ëŠ” ë‹¨ì¼ í…Œë„ŒíŠ¸ ì´ row ìˆ˜ê°€ ì „ì²´ì˜ 20% ì´ˆê³¼

3. ì´ë²¤íŠ¸ Ingestion ì†ë„:
   - ë‹¨ì¼ í…Œë„ŒíŠ¸ ì´ë²¤íŠ¸ ingestion ì†ë„ â‰¥ 10,000 events/min
   - ë˜ëŠ” analytics.events í…Œì´ë¸”ì—ì„œ ë‹¨ì¼ í…Œë„ŒíŠ¸ ë¹„ì¤‘ â‰¥ 25%

4. CPU/IO ë¶€í•˜ ê¸°ì¤€:
   - ë‹¨ì¼ í…Œë„ŒíŠ¸ CPU ì‚¬ìš©ëŸ‰ì´ ì „ì²´ì˜ 25% ì´ˆê³¼ (1ì‹œê°„ ì´ë™í‰ê· )
   - ë‹¨ì¼ í…Œë„ŒíŠ¸ IOPSê°€ ì „ì²´ì˜ 30% ì´ˆê³¼ (1ì‹œê°„ ì´ë™í‰ê· )
   - ë‹¨ì¼ í…Œë„ŒíŠ¸ DB ì—°ê²° ìˆ˜ê°€ ì „ì²´ì˜ 20% ì´ˆê³¼

5. íŠ¸ë˜í”½ ê¸‰ì¦ íŒ¨í„´:
   - 5ë¶„ ì´ë™í‰ê·  ëŒ€ë¹„ 300% ì¦ê°€ê°€ 3íšŒ ì´ìƒ ë°œìƒ
   - ë˜ëŠ” ì¼ì¼ íŠ¸ë˜í”½ì´ ì „ì¼ ëŒ€ë¹„ 200% ì¦ê°€

âš ï¸ ì¤‘ìš”: ìœ„ ê¸°ì¤€ ì¤‘ 3ê°œ ì´ìƒì„ ë™ì‹œì— ë§Œì¡±í•˜ê³ , Read Replicaë¡œ íŠ¸ë˜í”½ ë¶„ì‚°, íŒŒí‹°ì…”ë‹, ì—…ì¢…ë³„ ë¶„ë¦¬ ì „ëµìœ¼ë¡œ í•´ê²°ë˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ Hot Tenant ìƒ¤ë”©ì„ ê²€í† í•©ë‹ˆë‹¤.

Hot Tenant ìˆ˜ì§ ìƒ¤ë”© ì ˆì°¨

Step 1: íŠ¹ì • tenant_id íŠ¸ë˜í”½ì„ read replica ë˜ëŠ” ì „ìš© replicaë¡œ ë¼ìš°íŒ…

Step 2: traffic routing layerì—ì„œ í•´ë‹¹ í…Œë„ŒíŠ¸ë§Œ ë³„ë„ DBë¡œ ì´ë™ (vertical split)

Step 3: ë‹¤ë¥¸ í…Œë„ŒíŠ¸ ì˜í–¥ ì—†ì´ ì‹¤ì‹œê°„ ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜í–‰

5-5-1. Hot Tenant ìˆ˜ì§ ë¶„ë¦¬ ì ˆì°¨ (ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤, í˜„ì¬ ë¶ˆí•„ìš”)

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤(ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸)ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”í•˜ë©°, 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ì´ ë¹„í˜„ì‹¤ì ì…ë‹ˆë‹¤.

ğŸš¨ 1ì¸ ê°œë°œì‚¬/ì†Œê·œëª¨ íŒ€ í˜„ì‹¤ì„± ê²½ê³ : Hot Tenant ìˆ˜ì§ ìƒ¤ë”©ì€ ê¸°ìˆ ì ìœ¼ë¡œ ë§¤ìš° ë³µì¡í•œ ì‘ì—…ì´ë©°, Supabase ë‹¨ì¼ í”„ë¡œì íŠ¸ ì² í•™ê³¼ ì¶©ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. CDC ë™ê¸°í™”, conflict í•´ê²°, routing layer, ì˜êµ¬ ë¶„ë¦¬ ì •ì±… ë“± ë³µì¡ë„ê°€ ë§¤ìš° ë†’ì•„ 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ì´ ë¹„í˜„ì‹¤ì ì…ë‹ˆë‹¤. í˜„ì¬ ì‚¬ì—… ëª©í‘œ(2~3ë§Œ í…Œë„ŒíŠ¸)ì—ì„œëŠ” ë¶ˆí•„ìš”í•˜ë©°, ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤(ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸)ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”í•©ë‹ˆë‹¤.

ì‹¤ì œ ë‚œì´ë„:
- CDC ë™ê¸°í™”: ë³µì¡ë„ ë§¤ìš° ë†’ìŒ
- ë‹¤ìš´íƒ€ì„ ì—†ëŠ” ì´í–‰: ë§¤ìš° ì–´ë ¤ì›€
- Merge back ë¶ˆê°€: ì˜êµ¬ ë¶„ë¦¬ ì •ì±… ìœ ì§€ í•„ìš”
- ëª¨ë‹ˆí„°ë§ íŒŒì´í”„ë¼ì¸: ë³„ë„ êµ¬ì¶• í•„ìš”

ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” Read Replicaë¡œ íŠ¸ë˜í”½ ë¶„ì‚°ë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.

CDC ê¸°ë°˜ ìƒ¤ë”© ìë™í™”ëŠ” ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤(ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸ê¸‰)ì—ì„œë‚˜ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë©°, ì‹¤ì œ 2~3ë§Œ í…Œë„ŒíŠ¸ ìˆ˜ì¤€ì—ì„œëŠ” PostgreSQL íŒŒí‹°ì…”ë‹ + Read Replicaë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.

Hot Tenant ë°œìƒ ì‹œ ëŒ€ì‘ ìˆœì„œ (ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤):

âš ï¸ ì¤‘ìš”: Hot Tenant ìƒ¤ë”©ì€ "ìµœí›„ì˜ ìˆ˜ë‹¨"ì´ë©°, ë‹¤ìŒ ìˆœì„œë¡œ ëŒ€ì‘ì„ ê²€í† í•©ë‹ˆë‹¤:
1. Read Replicaë¡œ íŠ¸ë˜í”½ ë¶„ì‚° (ìš°ì„  ì‹œë„)
2. íŒŒí‹°ì…”ë‹ìœ¼ë¡œ ë°ì´í„° ë¶„ë¦¬ (ë‹¤ìŒ ë‹¨ê³„)
3. ì—…ì¢…ë³„ ë¶„ë¦¬ ì „ëµ ì ìš© (ì—…ì¢… ë‹¨ìœ„ ë¶„ë¦¬)
4. Hot Tenant ìˆ˜ì§ ìƒ¤ë”© (ìµœí›„ì˜ ìˆ˜ë‹¨, ìˆ˜ë™ ë¶„ë¦¬ë§Œ, ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤)

ìˆ˜ë™ ìˆ˜ì§ ë¶„ë¦¬ ì ˆì°¨ (ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤):

Step 1: íŠ¹ì • tenant_id ë°ì´í„°ë¥¼ ë³„ë„ DBë¡œ ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜
- ë‹¤ìš´íƒ€ì„ ìµœì†Œí™”ë¥¼ ìœ„í•œ ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜
- CDC ë™ê¸°í™”ëŠ” ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”

Step 2: íŠ¸ë˜í”½ ë¼ìš°íŒ… ë ˆì´ì–´ì—ì„œ í•´ë‹¹ í…Œë„ŒíŠ¸ë§Œ ë³„ë„ DBë¡œ ë¼ìš°íŒ…
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ tenant_id ê¸°ë°˜ ë¼ìš°íŒ… êµ¬í˜„
- Supabase í´ë¼ì´ì–¸íŠ¸ ë˜í¼ í•„ìš”

Step 3: ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„ ì†ŒìŠ¤ DBì—ì„œ í•´ë‹¹ tenant_id ë°ì´í„° ì œê±°
- Merge back ë¶ˆê°€ ì •ì±… ìœ ì§€
- ì˜êµ¬ ë¶„ë¦¬ë¡œ ìš´ì˜

â†’ ìë™í™”ëœ CDC ê¸°ë°˜ ìƒ¤ë”©ì€ ê°œë°œ ë³µì¡ë„ê°€ ë§¤ìš° ë†’ìœ¼ë¯€ë¡œ, ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”í•©ë‹ˆë‹¤.

êµ¬í˜„ ë²”ìœ„:

ìƒìš©í™” ë‹¨ê³„ (ì´ˆê¸°, í•™ì› 100~300ê°œ ìˆ˜ì¤€): Read Replicaë¡œ íŠ¸ë˜í”½ ë¶„ì‚°ë§Œ ì‚¬ìš©

ì„ íƒì  êµ¬í˜„: Multi-Region DR ë„ì… (ì™¸ë¶€ DB ì‚¬ìš© ì‹œ, ë‚œì´ë„: ì¤‘)

ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤: Hot Tenant ìˆ˜ì§ ìƒ¤ë”© ë„ì… (ìˆ˜ë™ ë¶„ë¦¬, ë‚œì´ë„: ë§¤ìš° ë†’ìŒ, ëŒ€ê·œëª¨ íŒ€ í•„ìš”)

ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤: CDC ê¸°ë°˜ ìƒ¤ë”© ìë™í™” ê²€í†  (ì„ íƒì , ë‚œì´ë„: ë§¤ìš° ë†’ìŒ, ëŒ€ê·œëª¨ íŒ€ í•„ìš”)

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” Over-engineeringì„ ë°©ì§€í•˜ê¸° ìœ„í•´ Read Replicaì™€ íŒŒí‹°ì…”ë‹ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

5-5-2. Hot Tenant ìˆ˜ì§ ìƒ¤ë”© ì›ë³µ ì „ëµ (Critical)

ìˆ˜ì§ ìƒ¤ë”©ëœ í…Œë„ŒíŠ¸ëŠ” ì›ì¹™ì ìœ¼ë¡œ "ì˜êµ¬ ë¶„ë¦¬(shard-pinned)" ìƒíƒœë¡œ ìœ ì§€í•˜ë©°, merge-backì€ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì •ì±… ê·¼ê±°:

Merge-back ê³¼ì •ì—ì„œ ë°ì´í„° ì¶©ëŒ ë°©ì§€ ë³µì¡ë„ê°€ ë§¤ìš° ë†’ìŒ

CDC ë™ê¸°í™” ì¤‘ë‹¨ ë° ì •í•©ì„± ê²€ì¦ í”„ë¡œì„¸ìŠ¤ê°€ ë³µì¡

ìš´ì˜ ë‚œì´ë„ ê·¹ì ìœ¼ë¡œ ê°ì†Œ

ëŒ€ì•ˆ:

íŠ¸ë˜í”½ì´ ì§„ì •ëœ ê²½ìš°ì—ë„ ë…ë¦½ ìƒ¤ë“œì—ì„œ ê³„ì† ìš´ì˜

ìƒ¤ë“œ ê°„ ë¶€í•˜ ë¶„ì‚°ìœ¼ë¡œ ì „ì²´ ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ

ë§Œì•½ merge-backì´ í•„ìˆ˜ì¸ ê²½ìš°:

CDC ê¸°ë°˜ ì–‘ë°©í–¥ ë™ê¸°í™” í•„ìš”

ì •í•©ì„± ê²€ì¦ í”„ë¡œì„¸ìŠ¤ í•„ìˆ˜

ë°ì´í„° ì¶©ëŒ í•´ê²° ì „ëµ ìˆ˜ë¦½

â†’ ìš´ì˜ ë³µì¡ë„ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ì˜êµ¬ ë¶„ë¦¬ ì •ì±… ê¶Œì¥

5-5-3. Shard ì¬ì¡°ì • ì „ëµ (ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤, í˜„ì¬ ë¶ˆí•„ìš”)

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤(ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸)ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”í•˜ë©°, 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ì´ ë¹„í˜„ì‹¤ì ì…ë‹ˆë‹¤.

ğŸš¨ 1ì¸ ê°œë°œì‚¬/ì†Œê·œëª¨ íŒ€ í˜„ì‹¤ì„± ê²½ê³ : Shard ì¬ì¡°ì •ì€ ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸ ê·œëª¨ì—ì„œë§Œ í•„ìš”í•˜ë©°, CDC ê¸°ë°˜ ìë™í™”ëŠ” ìš´ì˜ ë³µì¡ë„ê°€ ë§¤ìš° ë†’ì•„ 1ì¸ ê°œë°œì‚¬ì—ì„œëŠ” êµ¬í˜„ì´ ë¹„í˜„ì‹¤ì ì…ë‹ˆë‹¤.

ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ìƒ¤ë”© ìì²´ê°€ ë¶ˆí•„ìš”í•˜ë¯€ë¡œ ì´ ê¸°ëŠ¥ë„ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.

ìƒ¤ë“œ ê°„ ë¶€í•˜ ë¶ˆê· í˜•ì´ ìƒê²¼ì„ ë•Œ ëŒ€ì‘ (ì´ˆê³¼ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤):

ì‹œë‚˜ë¦¬ì˜¤:

íŠ¹ì • shardë§Œ ê³¼ë¶€í•˜ë˜ëŠ” ê²½ìš° (ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸ ìš´ì˜ ì‹œ ë°œìƒ ê°€ëŠ¥)

ìƒ¤ë“œ ê°„ ë¶€í•˜ ë¶„ì‚°ì„ ìœ„í•œ í…Œë„ŒíŠ¸ ì¬ë°°ì¹˜

êµ¬í˜„ ë°©ì‹:

ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ë°˜ ì¬ë°°ì¹˜ (ìš°ì„  ê¶Œì¥)

CDC ê¸°ë°˜ ìë™í™”ëŠ” ìš´ì˜ ë³µì¡ë„ê°€ ë§¤ìš° ë†’ìœ¼ë¯€ë¡œ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”

ìš´ì˜ ì¡°ê±´:

ë¶€í•˜ ê¸°ë°˜ shard ì¬ì¡°ì •ì€ ìš´ì˜ ë¹„ìš©ì´ í¬ë¯€ë¡œ ì›” ë‹¨ìœ„/ë¶„ê¸° ë‹¨ìœ„ì™€ ê°™ì€ ì œí•œëœ ì‹œì ì—ë§Œ ì‹¤í–‰í•œë‹¤.

â†’ ìˆ˜ì‹­ë§Œ í…Œë„ŒíŠ¸ ì´ìƒ ê·œëª¨ì—ì„œë„ ëŒ€ê·œëª¨ íŒ€ì´ í•„ìš”í•˜ë©°, í˜„ì¬ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.

ìë™ ê²½ê³  ë° ë¼ìš°íŒ… ì‹œìŠ¤í…œ

Edge â†’ Supabase Routing Layer â†’ fallback replica

ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œì—ì„œ Hot Tenant ìë™ ê°ì§€ ì‹œ Slack/ì´ë©”ì¼ ì•Œë¦¼

ë¼ìš°íŒ… ë ˆì´ì–´ì—ì„œ tenant_id ê¸°ë°˜ ìë™ ë¶„ì‚° ì²˜ë¦¬

Hot Tenant ë¼ìš°íŒ… ë ˆì´ì–´ëŠ” Edge Middleware ë˜ëŠ” Server Gateway(API Layer)ì— êµ¬í˜„ë˜ë©°, Supabaseì˜ ë‹¨ì¼ RLS ëª¨ë¸ê³¼ ì¶©ëŒ ì—†ì´ í…Œë„ŒíŠ¸ ë‹¨ìœ„ ìˆ˜ì§ ìƒ¤ë”©ì„ ê°€ëŠ¥í•˜ê²Œ í•œë‹¤.

5. Schema Registry ìš´ì˜ ë¬¸ì„œ (Critical)

âš ï¸ ì¤‘ìš”: Schema RegistryëŠ” ìˆ˜ì²œ í…Œë„ŒíŠ¸ ìš´ì˜ ì‹œ í•µì‹¬ ì¸í”„ë¼ì…ë‹ˆë‹¤. ìŠ¤í‚¤ë§ˆ ë²„ì „ ê´€ë¦¬, ì¶©ëŒ í•´ê²°, Rollback ì •ì±…ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.

5-6. Schema Registry ì €ì¥ ìœ„ì¹˜ ë° ê´€ë¦¬ ë°©ì‹

ì €ì¥ ë°©ì‹ ì˜µì…˜:

ì˜µì…˜ 1: PostgreSQL í…Œì´ë¸” (ê¶Œì¥, ìƒìš©í™” ë‹¨ê³„)
- í…Œì´ë¸”: `meta.schema_registry` (ì‹¤ì œ í…Œì´ë¸”)
- VIEW: `public.schema_registry` (PostgREST ë…¸ì¶œìš©, underlying tableì€ `meta.schema_registry`)
- ì¥ì : Supabaseì™€ í†µí•©, íŠ¸ëœì­ì…˜ ë³´ì¥, RLS ì ìš© ê°€ëŠ¥
- ë‹¨ì : Git ì—°ë™ì´ ìˆ˜ë™
- âš ï¸ ì¤‘ìš”: `public.schema_registry`ëŠ” VIEWì´ë¯€ë¡œ, RLS ì •ì±…ì€ underlying table(`meta.schema_registry`)ì˜ RLSì— ì˜í•´ ë³´í˜¸ë¨

ì˜µì…˜ 2: Git-managed JSON íŒŒì¼ (ìƒìš©í™” ë‹¨ê³„ ê¶Œì¥)
- ì €ì¥ ìœ„ì¹˜: `infra/schemas/{industry_type}/{entity}/{version}.json`
- ì¥ì : ë²„ì „ ê´€ë¦¬ ìë™í™”, PR ê¸°ë°˜ ê²€í† , ë¡¤ë°± ìš©ì´
- ë‹¨ì : Git ì—°ë™ í•„ìš”, CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì„± í•„ìš”

ì˜µì…˜ 3: S3 + Git í•˜ì´ë¸Œë¦¬ë“œ (ì„ íƒì  êµ¬í˜„)
- Git: ìŠ¤í‚¤ë§ˆ ì •ì˜ íŒŒì¼ (ì†ŒìŠ¤)
- S3: ë°°í¬ëœ ìŠ¤í‚¤ë§ˆ ë²„ì „ (ëŸ°íƒ€ì„)
- ì¥ì : ì†ŒìŠ¤ ê´€ë¦¬ì™€ ë°°í¬ ë¶„ë¦¬, CDN ìºì‹± ê°€ëŠ¥
- ë‹¨ì : ë³µì¡ë„ ì¦ê°€

ìƒìš©í™” ë‹¨ê³„ ê¶Œì¥ êµ¬ì¡°:

```sql
CREATE SCHEMA IF NOT EXISTS meta;

CREATE TABLE meta.schema_registry (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  entity text NOT NULL,              -- 'student', 'invoice', 'schedule' ë“±
  industry_type text,                -- 'academy', 'salon' ë“± (nullable = ê³µí†µ)
  version text NOT NULL,             -- '2.0.1'
  min_supported_client text NOT NULL, -- '1.12.0' (ì •ë³¸, í•„ìˆ˜)
  min_client text,                    -- '1.12.0' (ë ˆê±°ì‹œ ì…ë ¥ í—ˆìš©, ì €ì¥ ì‹œ min_supported_clientë¡œ ì •ê·œí™”)
  -- âš ï¸ ì¤‘ìš”: min_client ì •ê·œí™” ê·œì¹™ (DB/API ë ˆë²¨ ê°•ì œ)
  -- 1. min_client ì…ë ¥ ì‹œ: ìë™ìœ¼ë¡œ min_supported_clientì— ì €ì¥í•˜ê³  min_clientëŠ” NULLë¡œ ì„¤ì • (ì•„ë˜ íŠ¸ë¦¬ê±° ì°¸ì¡°)
  -- 2. ìš°ì„ ìˆœìœ„: min_supported_clientê°€ í•­ìƒ SSOT, ë‘˜ ë‹¤ ê°’ì´ ìˆìœ¼ë©´ min_supported_client ìš°ì„ 
  -- 3. ì½ê¸° ì‹œ: min_supported_clientë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ min_client ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜)
  -- 4. âš ï¸ ì‹ ê·œ ì½”ë“œì—ì„œëŠ” min_client ì‚¬ìš© ê¸ˆì§€, min_supported_clientë§Œ ì‚¬ìš©
  schema_json jsonb NOT NULL,        -- ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì •ì˜
  migration_script text,             -- Migration Script (nullable)
  status text NOT NULL DEFAULT 'draft', -- 'draft', 'active', 'deprecated'
  registered_by uuid REFERENCES auth.users(id),
  registered_at timestamptz NOT NULL DEFAULT now(),
  activated_at timestamptz,          -- í™œì„±í™” ì‹œì 
  deprecated_at timestamptz,         -- íê¸° ì‹œì 
  UNIQUE(entity, industry_type, version)
);

-- âš ï¸ ì¤‘ìš”: Schema Registry ì»¬ëŸ¼ SSOT (ì •ë³¸)
-- ì •ë³¸ ì»¬ëŸ¼: registered_at, activated_at, deprecated_at, registered_by (ì „ì²´ ê¸°ìˆ ë¬¸ì„œ ì •ë³¸)
-- âš ï¸ ì°¸ê³ : ìŠ¤í‚¤ë§ˆì—ë””í„° ë¬¸ì„œì˜ created_at/updated_at/created_by/updated_byëŠ” ê°œë…ì  í‘œê¸°ì´ë©°,
-- ì‹¤ì œ DB ì»¬ëŸ¼ì€ ìœ„ ì •ë³¸ ì»¬ëŸ¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

CREATE INDEX idx_schema_registry_entity ON meta.schema_registry(entity, industry_type, status);
CREATE INDEX idx_schema_registry_version ON meta.schema_registry(entity, industry_type, version DESC);

-- âš ï¸ ì¤‘ìš”: min_client ì •ê·œí™” íŠ¸ë¦¬ê±° (DB ë ˆë²¨ ê°•ì œ)
-- min_client ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ min_supported_clientë¡œ ì •ê·œí™”í•˜ê³  min_clientëŠ” NULLë¡œ ì„¤ì •
CREATE OR REPLACE FUNCTION normalize_min_client()
RETURNS TRIGGER AS $$
BEGIN
  -- min_clientê°€ ì…ë ¥ë˜ë©´ min_supported_clientë¡œ ì •ê·œí™”
  IF NEW.min_client IS NOT NULL AND NEW.min_client != '' THEN
    NEW.min_supported_client := NEW.min_client;
    NEW.min_client := NULL;
  END IF;

  -- ë‘˜ ë‹¤ ê°’ì´ ìˆìœ¼ë©´ min_supported_client ìš°ì„  (SSOT)
  IF NEW.min_supported_client IS NOT NULL AND NEW.min_client IS NOT NULL THEN
    NEW.min_client := NULL;  -- min_supported_clientê°€ SSOTì´ë¯€ë¡œ min_clientëŠ” ë¬´ì‹œ
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_normalize_min_client
  BEFORE INSERT OR UPDATE ON meta.schema_registry
  FOR EACH ROW
  EXECUTE FUNCTION normalize_min_client();
```

âš ï¸ ì¤‘ìš”: ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì¼ê´€ì„±
- ì •ë³¸ ë§ˆì´ê·¸ë ˆì´ì…˜: `infra/supabase/migrations/039_create_schema_registry.sql` (20ì¤„)ì—ì„œ `min_supported_client text NOT NULL`ë¡œ ì •ì˜ë¨
- âœ… ê²€ì¦ ì™„ë£Œ: `infra/supabase/migrations/043_verify_meta_tables.sql` (35ì¤„)ì—ì„œ `min_supported_client text NOT NULL,`ë¡œ ì˜¬ë°”ë¥´ê²Œ ì •ì˜ë¨ (ì¼ê´€ì„± ìœ ì§€)
- âœ… ê²€ì¦ ì™„ë£Œ: `packages/core/core-schema-registry/src/service.ts` (54-58ì¤„)ì—ì„œ `input.minSupportedClient`ê°€ null/undefinedì¸ ê²½ìš° ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ì´ ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆìŒ
  - ë¬¸ì„œ ìŠ¤í™ì— ë”°ë¥´ë©´ `min_supported_client`ëŠ” í•„ìˆ˜(NOT NULL)ì´ë©°, ì„œë¹„ìŠ¤ ë ˆë²¨ ê²€ì¦ë„ ì™„ë£Œë¨

5-7. Schema Registry ë“±ë¡ ì‹œì  Validation

ìŠ¤í‚¤ë§ˆ ë“±ë¡ ì‹œ ë‹¤ìŒ ê²€ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

1. Meta-Schema Validation
   - ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ê°€ Meta-Schema ê·œì¹™ì„ ì¤€ìˆ˜í•˜ëŠ”ì§€ ê²€ì¦
   - í•„ìˆ˜ í•„ë“œ: version, minSupportedClient (camelCase, Schema JSON ì •ë³¸), entity
   - âš ï¸ ì¤‘ìš”: í•„ë“œëª… SSOT
     - Schema JSON (ë¬¸ì„œ/ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì •ë³¸): `minSupportedClient` (camelCase)
     - DB ì»¬ëŸ¼ ì •ë³¸: `min_supported_client` (snake_case)
     - í•˜ìœ„í˜¸í™˜ alias: `minClient`/`min_client`ëŠ” "ì½ê¸°ë§Œ í—ˆìš©(Deprecated)"ë¡œ ë‘ê³ , ì €ì¥ ì‹œ ì •ê·œí™”í•´ì„œ `minSupportedClient`ë¡œ ë³€í™˜
   - Tailwind í´ë˜ìŠ¤ ë¬¸ìì—´ ì‚¬ìš© ê¸ˆì§€ ê²€ì¦

2. ë²„ì „ ì¶©ëŒ ê²€ì¦
   - ë™ì¼ entity + industry_typeì—ì„œ ì´ë¯¸ í™œì„±í™”ëœ ë²„ì „ê³¼ ì¶©ëŒ ì—¬ë¶€ í™•ì¸
   - Major ë²„ì „ ì—…ê·¸ë ˆì´ë“œ ì‹œ Migration Script í•„ìˆ˜

3. í•˜ìœ„ í˜¸í™˜ì„± ê²€ì¦
   - ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ê°€ ìƒˆ ìŠ¤í‚¤ë§ˆë¥¼ ë Œë”ë§í•  ìˆ˜ ìˆëŠ”ì§€ ê²€ì¦
   - Breaking change ê°ì§€ ì‹œ ê²½ê³  ë˜ëŠ” ê±°ë¶€

4. Migration Script ê²€ì¦ (Major ì—…ê·¸ë ˆì´ë“œ ì‹œ)
   - Migration Script êµ¬ë¬¸ ê²€ì¦
   - ë¹Œë“œ íƒ€ì„ ë³€í™˜ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

ë“±ë¡ í”„ë¡œì„¸ìŠ¤:

```typescript
// packages/schema-engine/registry.ts
export async function registerSchema(schema: SchemaDefinition) {
  // 1. Meta-Schema Validation
  const validationResult = validateMetaSchema(schema);
  if (!validationResult.valid) {
    throw new Error(`Meta-Schema validation failed: ${validationResult.errors}`);
  }

  // 2. ë²„ì „ ì¶©ëŒ ê²€ì¦
  const existingActive = await getActiveSchema(schema.entity, schema.industry_type);
  if (existingActive && isVersionConflict(existingActive.version, schema.version)) {
    throw new Error(`Version conflict: ${existingActive.version} is still active`);
  }

  // 3. í•˜ìœ„ í˜¸í™˜ì„± ê²€ì¦
  if (existingActive && !isBackwardCompatible(existingActive, schema)) {
    if (!schema.migrationScript) {
      throw new Error('Breaking change requires migration script');
    }
  }

  // 4. ë“±ë¡ (status = 'draft')
  await db.insert('meta.schema_registry', {
    entity: schema.entity,
    industry_type: schema.industry_type,
    version: schema.version,
    min_supported_client: schema.minSupportedClient,
    schema_json: schema,
    migration_script: schema.migrationScript,
    status: 'draft'
  });
}
```

5-8. Git ì—°ë™ (ìƒìš©í™” ë‹¨ê³„)

Git-managed Schema Registry êµ¬ì¡°:

```
infra/schemas/
  â”œâ”€ common/                    # ê³µí†µ ìŠ¤í‚¤ë§ˆ
  â”‚  â”œâ”€ invoice/
  â”‚  â”‚  â”œâ”€ 1.0.0.json
  â”‚  â”‚  â”œâ”€ 2.0.0.json
  â”‚  â”‚  â””â”€ migrations/
  â”‚  â”‚     â””â”€ 1.0.0_to_2.0.0.ts
  â”‚  â””â”€ payment/
  â”‚     â””â”€ 1.0.0.json
  â”œâ”€ academy/                   # ì—…ì¢…ë³„ ìŠ¤í‚¤ë§ˆ
  â”‚  â”œâ”€ student/
  â”‚  â”‚  â”œâ”€ 1.0.0.json
  â”‚  â”‚  â”œâ”€ 2.0.1.json
  â”‚  â”‚  â””â”€ migrations/
  â”‚  â””â”€ class/
  â””â”€ salon/
     â””â”€ customer/
```

CI/CD íŒŒì´í”„ë¼ì¸:

1. ê°œë°œìê°€ PR ìƒì„± â†’ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì¶”ê°€/ìˆ˜ì •
2. CIì—ì„œ Meta-Schema Validation ì‹¤í–‰
3. PR ë¨¸ì§€ ì‹œ ìë™ìœ¼ë¡œ `meta.schema_registry`ì— ë“±ë¡ (status = 'draft')
4. ìš´ì˜ìê°€ Super Adminì—ì„œ í™œì„±í™” (status = 'active')

5-9. Rollback ì •ì±…

Rollback ì‹œë‚˜ë¦¬ì˜¤:

ì‹œë‚˜ë¦¬ì˜¤ 1: ìƒˆ ìŠ¤í‚¤ë§ˆ ë²„ì „ ë°°í¬ ì‹¤íŒ¨
- ì´ì „ í™œì„± ë²„ì „ìœ¼ë¡œ ìë™ ë¡¤ë°±
- `meta.schema_registry`ì—ì„œ ìƒˆ ë²„ì „ statusë¥¼ 'deprecated'ë¡œ ë³€ê²½
- ì´ì „ ë²„ì „ì„ ë‹¤ì‹œ 'active'ë¡œ ë³€ê²½

ì‹œë‚˜ë¦¬ì˜¤ 2: Migration Script ì‹¤í–‰ ì‹¤íŒ¨
- ìŠ¤í‚¤ë§ˆ í™œì„±í™” ì „ì— Migration Scriptë¥¼ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ê²€ì¦
- ì‹¤íŒ¨ ì‹œ ìŠ¤í‚¤ë§ˆ ë“±ë¡ ìì²´ë¥¼ ê±°ë¶€

ì‹œë‚˜ë¦¬ì˜¤ 3: í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„± ë¬¸ì œ
- `minSupportedClient` (ì •ë³¸) ë˜ëŠ” `min_supported_client` (DB ì»¬ëŸ¼) ë²„ì „ ë¯¸ë§Œ í´ë¼ì´ì–¸íŠ¸ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°
- âš ï¸ ì¤‘ìš”: ì •ë³¸ì€ `minSupportedClient` (Schema JSON) / `min_supported_client` (DB ì»¬ëŸ¼)ì…ë‹ˆë‹¤. `minClient`/`min_client`ëŠ” ë ˆê±°ì‹œ ì…ë ¥ í—ˆìš© ì‹œ ì €ì¥ ì‹œ ì •ê·œí™”ë©ë‹ˆë‹¤.
- ìŠ¤í‚¤ë§ˆ í™œì„±í™”ë¥¼ ì§€ì—°í•˜ê±°ë‚˜ í´ë¼ì´ì–¸íŠ¸ ì—…ë°ì´íŠ¸ ìœ ë„

Rollback ì ˆì°¨:

```typescript
export async function rollbackSchema(entity: string, industryType: string | null) {
  // 1. í˜„ì¬ í™œì„± ë²„ì „ í™•ì¸
  const active = await getActiveSchema(entity, industryType);
  if (!active) {
    throw new Error('No active schema to rollback');
  }

  // 2. ì´ì „ ë²„ì „ ì°¾ê¸°
  const previous = await getPreviousVersion(entity, industryType, active.version);
  if (!previous) {
    throw new Error('No previous version available');
  }

  // 3. í˜„ì¬ ë²„ì „ ë¹„í™œì„±í™”
  await db.update('meta.schema_registry',
    { id: active.id },
    { status: 'deprecated', deprecated_at: now() }
  );

  // 4. ì´ì „ ë²„ì „ í™œì„±í™”
  await db.update('meta.schema_registry',
    { id: previous.id },
    { status: 'active', activated_at: now() }
  );

  // 5. ì•Œë¦¼ ë°œì†¡
  await sendAlert('Schema rollback', { entity, industryType, from: active.version, to: previous.version });
}
```

5-10. Version Pinning ì •ì±…

í…Œë„ŒíŠ¸ë³„ ìŠ¤í‚¤ë§ˆ ë²„ì „ ê³ ì •:

íŠ¹ì • í…Œë„ŒíŠ¸ê°€ íŠ¹ì • ìŠ¤í‚¤ë§ˆ ë²„ì „ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš° (ì˜ˆ: ì»¤ìŠ¤í…€ ìœ„ì ¯ í˜¸í™˜ì„±):

```sql
CREATE TABLE meta.tenant_schema_pins (
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  entity text NOT NULL,
  industry_type text,
  pinned_version text NOT NULL,
  reason text,
  pinned_at timestamptz NOT NULL DEFAULT now(),
  pinned_by uuid REFERENCES auth.users(id),
  UNIQUE(tenant_id, entity, industry_type)
);
```

Version Pinning ìš°ì„ ìˆœìœ„:

1. í…Œë„ŒíŠ¸ë³„ Pinì´ ìˆìœ¼ë©´ í•´ë‹¹ ë²„ì „ ì‚¬ìš©
2. Pinì´ ì—†ìœ¼ë©´ í™œì„±í™”ëœ ìµœì‹  ë²„ì „ ì‚¬ìš©
3. í´ë¼ì´ì–¸íŠ¸ `minSupportedClient` (ì •ë³¸) / `min_supported_client` (DB ì»¬ëŸ¼) ë¯¸ë§Œ ë²„ì „ì€ ì‚¬ìš© ë¶ˆê°€
- âš ï¸ ì¤‘ìš”: ì •ë³¸ì€ `minSupportedClient` (Schema JSON) / `min_supported_client` (DB ì»¬ëŸ¼)ì…ë‹ˆë‹¤. `minClient`/`min_client`ëŠ” ë ˆê±°ì‹œ ì…ë ¥ í—ˆìš© ì‹œ ì €ì¥ ì‹œ ì •ê·œí™”ë©ë‹ˆë‹¤.

5-11. Conflict Resolution ì •ì±…

ìŠ¤í‚¤ë§ˆ ë²„ì „ ì¶©ëŒ í•´ê²°:

ì¶©ëŒ ìœ í˜• 1: ë™ì‹œ ë“±ë¡
- ë™ì¼ entity + industry_type + versionì´ ë™ì‹œì— ë“±ë¡ë˜ëŠ” ê²½ìš°
- UNIQUE ì œì•½ì¡°ê±´ìœ¼ë¡œ ì°¨ë‹¨
- ë¨¼ì € ë“±ë¡ëœ ê²ƒì´ ìŠ¹ì¸, ë‚˜ë¨¸ì§€ëŠ” ê±°ë¶€

ì¶©ëŒ ìœ í˜• 2: í™œì„± ë²„ì „ê³¼ì˜ í˜¸í™˜ì„±
- ìƒˆ ë²„ì „ì´ ê¸°ì¡´ í™œì„± ë²„ì „ê³¼ í˜¸í™˜ë˜ì§€ ì•ŠëŠ” ê²½ìš°
- Migration Script í•„ìˆ˜
- Migration Script ì—†ì´ëŠ” ë“±ë¡ ê±°ë¶€

ì¶©ëŒ ìœ í˜• 3: í´ë¼ì´ì–¸íŠ¸ ì§€ì› ë²”ìœ„
- `minSupportedClient` (ì •ë³¸) / `min_supported_client` (DB ì»¬ëŸ¼)ê°€ ë„ˆë¬´ ë†’ì•„ì„œ ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ê°€ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš°
- âš ï¸ ì¤‘ìš”: ì •ë³¸ì€ `minSupportedClient` (Schema JSON) / `min_supported_client` (DB ì»¬ëŸ¼)ì…ë‹ˆë‹¤. `minClient`/`min_client`ëŠ” ë ˆê±°ì‹œ ì…ë ¥ í—ˆìš© ì‹œ ì €ì¥ ì‹œ ì •ê·œí™”ë©ë‹ˆë‹¤.
- ê²½ê³  ë°œì†¡, í™œì„±í™”ëŠ” ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”

5-12. ìš´ì˜ ë‹´ë‹¹ì ê¸°ì¤€ ë¬¸ì„œ

Super Adminì—ì„œ Schema Registry ê´€ë¦¬:

1. ìŠ¤í‚¤ë§ˆ ëª©ë¡ ì¡°íšŒ
   - entity, industry_type, version, status í•„í„°ë§
   - í™œì„±/ë¹„í™œì„± ë²„ì „ êµ¬ë¶„ í‘œì‹œ

2. ìŠ¤í‚¤ë§ˆ í™œì„±í™”/ë¹„í™œì„±í™”
   - Draft â†’ Active ì „í™˜ ì‹œ Migration Script ì‹¤í–‰ í™•ì¸
   - Active â†’ Deprecated ì „í™˜ ì‹œ ì˜í–¥ ë²”ìœ„ í™•ì¸

3. Rollback ì‹¤í–‰
   - ì´ì „ ë²„ì „ ëª©ë¡ í‘œì‹œ
   - Rollback ì‹¤í–‰ ì‹œ ì˜í–¥ ë²”ìœ„ ê²½ê³ 

4. í…Œë„ŒíŠ¸ë³„ Version Pinning ê´€ë¦¬
   - íŠ¹ì • í…Œë„ŒíŠ¸ì˜ ìŠ¤í‚¤ë§ˆ ë²„ì „ ê³ ì •/í•´ì œ
   - Pin ì´ìœ  ê¸°ë¡

5. ì¶©ëŒ í•´ê²°
   - ì¶©ëŒ ê°ì§€ ì‹œ ì•Œë¦¼
   - ìˆ˜ë™ ìŠ¹ì¸/ê±°ë¶€ ì¸í„°í˜ì´ìŠ¤

â†’ Schema RegistryëŠ” ì‹¤ ì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ Schema Rollout ì‹¤íŒ¨ ì‹œ ëŒ€ì‘ì„ ìœ„í•œ í•µì‹¬ ì¸í”„ë¼ì´ë¯€ë¡œ, ìœ„ ì •ì±…ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.

ğŸ“˜ PART 2
Core Platform / Industry ëª¨ë“ˆ / Services / Hooks / core-ui / ë°˜ì‘í˜• / ëª¨ë°”ì¼Â·íƒœë¸”ë¦¿ / ë‹¤í¬ëª¨ë“œ / í™•ëŒ€ë³´ê¸°(Zoom)

6. Core Platform Layer ìƒì„¸ ì„¤ê³„

Core LayerëŠ” ì „ ì—…ì¢… ê³µí†µ ê¸°ëŠ¥ì„ ì œê³µí•˜ë©°, ëª¨ë“  Industry ëª¨ë“ˆì˜ ê¸°ë°˜ì´ ëœë‹¤.

6-1. core-auth / core-tenancy (ì¸ì¦Â·í…Œë„Œì‹œ)

1) ì¸ì¦ (Supabase Auth)

[ë¶ˆë³€ ê·œì¹™] ì¸ì¦ ë¡œì§ì€ core-auth ëª¨ë“ˆì—ì„œ ê³µí†µìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

íŒ¨í‚¤ì§€ êµ¬ì¡°:
- packages/core/core-auth/src/login.ts: ë¡œê·¸ì¸ ì„œë¹„ìŠ¤ (ì´ë©”ì¼/ì†Œì…œ/OTP)
- packages/core/core-auth/src/signup.ts: íšŒì›ê°€ì… ì„œë¹„ìŠ¤ (ì‚¬ìš©ì ê³„ì • ìƒì„±)
- packages/core/core-auth/src/service.ts: ê¸°ë³¸ ì¸ì¦ ì„œë¹„ìŠ¤ (ì‚¬ìš©ì ì¡°íšŒ ë“±)

ì§€ì› ì¸ì¦ ë°©ì‹:
- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ (loginWithEmail)
- ì†Œì…œ ë¡œê·¸ì¸ (Google, Kakao ë“±) (loginWithOAuth)
- ì „í™”ë²ˆí˜¸Â·OTP ë¡œê·¸ì¸ (ì—…ì¢…ì— ë”°ë¼ í™œì„±í™”) (loginWithOTP)

ë¡œê·¸ì¸ í”Œë¡œìš°:
1. ì‚¬ìš©ì ì¸ì¦ (Supabase Auth)
2. ì‚¬ìš©ìì˜ í…Œë„ŒíŠ¸ ëª©ë¡ ì¡°íšŒ (user_tenant_roles)
3. í…Œë„ŒíŠ¸ ì„ íƒ (JWT claimì— tenant_id í¬í•¨)
4. ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨ (ì—…ë°ì´íŠ¸ëœ JWT ë°›ê¸°)

íšŒì›ê°€ì… í”Œë¡œìš°:
1. ì‚¬ìš©ì ê³„ì • ìƒì„± (Supabase Auth) - core-auth/signup.ts
2. ì´ë©”ì¼ ì¸ì¦ (ì„ íƒì )
3. í…Œë„ŒíŠ¸ ìƒì„± ë° ì˜¨ë³´ë”© - core-tenancy/onboarding.ts
4. ì—…ì¢…ë³„ ì´ˆê¸° ë°ì´í„° ì‹œë“œ - Industry Layer

2) í…Œë„ŒíŠ¸ ì¡°ì¸ ëª¨ë¸

í•˜ë‚˜ì˜ ìœ ì € â†’ ì—¬ëŸ¬ í…Œë„ŒíŠ¸ ì†Œì† ê°€ëŠ¥
(user_tenant_rolesë¡œ ë§¤í•‘)

user_tenant_roles
- user_id
- tenant_id
- role (owner, admin, sub_admin, manager, staff, teacher, assistant, counselor, parent, super_admin)

3) í…Œë„ŒíŠ¸ ì˜¨ë³´ë”© (core-tenancy/onboarding.ts)

[ë¶ˆë³€ ê·œì¹™] í…Œë„ŒíŠ¸ ìƒì„± ë° ì´ˆê¸°í™”ëŠ” core-tenancy/onboarding.tsì—ì„œ ê³µí†µìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

í…Œë„ŒíŠ¸ ìƒì„± í”Œë¡œìš°:
1. tenants í…Œì´ë¸”ì— row ìƒì„±
2. tenant_settingsì— ì—…ì¢…ë³„ ê¸°ë³¸ê°’ ì €ì¥ (timezone, locale ë“±)
   - ì£¼ì˜: industry_typeì€ tenant_settingsì— ì €ì¥í•˜ì§€ ì•ŠìŒ (SSOT-2: public.tenants.industry_typeì´ 1ì°¨ ì†ŒìŠ¤)
3. tenant_featuresì— í”Œëœ/ê¸°ëŠ¥ ON/OFF ì„¤ì •
   - âš ï¸ ì¤‘ìš”: AI ê¸°ëŠ¥ì€ `tenant_features(feature_key='ai').enabled`ë¡œ ê´€ë¦¬ (Default Policy: í…Œë„ŒíŠ¸ ìƒì„± ì‹œ enabled=trueë¡œ ì„¤ì •ê°’ìœ¼ë¡œ ì €ì¥)
   - SSOT: `tenant_features(feature_key='ai').enabled` (í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ ì°¸ì¡°)
4. owner ìœ ì €ë¥¼ user_tenant_rolesì— ì—°ê²°
5. ì¶”ì²œì¸ ì½”ë“œ ì²˜ë¦¬ (ì„ íƒì , core-tenancy-referral ì—°ë™)
6. ì—…ì¢…ë³„ seed ì‹¤í–‰ (Industry Layerì—ì„œ ë³„ë„ ì²˜ë¦¬)

âš ï¸ ì¤‘ìš”: ì—…ì¢…ë³„ ì´ˆê¸° ë°ì´í„° ì‹œë“œ(ì˜ˆ: í•™ì› ê¸°ë³¸ ë°˜, ë¯¸ìš©ì‹¤ ê¸°ë³¸ ì„œë¹„ìŠ¤)ëŠ” Industry Layerì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
core-tenancy/onboarding.tsëŠ” í…Œë„ŒíŠ¸ ìƒì„±, ê¸°ë³¸ ì„¤ì •, ì—­í•  í• ë‹¹ë§Œ ë‹´ë‹¹í•©ë‹ˆë‹¤.

4) RLS ë³´ì•ˆ ê·œì¹™

ìœ ì €ê°€ ì†Œì†ëœ í…Œë„ŒíŠ¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥

í‘œì¤€ RLS íŒ¨í„´ í…œí”Œë¦¿ (ì •ë³¸, 3-2 ì°¸ì¡°):

âš ï¸ ì¤‘ìš”: í‘œì¤€ RLS ì •ì±…ì€ JWT claim ê¸°ë°˜ìœ¼ë¡œ í†µì¼í•©ë‹ˆë‹¤. current_setting ê¸°ë°˜ì€ ë ˆê±°ì‹œ/ê¸ˆì§€ì…ë‹ˆë‹¤.

**ì •ë³¸ (Transaction Pooling í˜¸í™˜, í•„ìˆ˜):**
CREATE POLICY tenant_isolation_<table> ON public.<table>
FOR ALL TO authenticated
USING (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
)
WITH CHECK (
  tenant_id = (auth.jwt() ->> 'tenant_id')::uuid
);

**ë ˆê±°ì‹œ/ê¸ˆì§€ (Session Pooling ë˜ëŠ” ì „ìš© ì»¤ë„¥ì…˜ ì „ìš©, ì‚¬ìš© ê¸ˆì§€):**
âš ï¸ ë ˆê±°ì‹œ ì˜ˆì‹œ: ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ, JWT claim ê¸°ë°˜ RLS ì‚¬ìš© ê¶Œì¥. ì•„ë˜ íŒ¨í„´ì€ Transaction Poolingê³¼ í˜¸í™˜ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
-- tenant_id = NULLIF(current_setting('app.current_tenant_id', true), '')::uuid
WITH CHECK (
  tenant_id = NULLIF(current_setting('app.current_tenant_id', true), '')::uuid
);

â†’ ëª¨ë“  RLS ì •ì±…ì€ ìœ„ ì˜µì…˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. Transaction Poolingì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë°˜ë“œì‹œ ì˜µì…˜ 1ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

5) Service Layer ë° Hooks

[ë¶ˆë³€ ê·œì¹™] Service LayerëŠ” Core Layerë¥¼ ë˜í•‘í•˜ì—¬ ì œê³µí•©ë‹ˆë‹¤.

íŒ¨í‚¤ì§€ êµ¬ì¡°:
- packages/services/auth-service: Auth Service (Core Layer ë˜í¼)
- packages/hooks/use-auth: React Query ê¸°ë°˜ ì¸ì¦ ê´€ë¦¬ Hook

ì£¼ìš” Hook:
- useLoginWithEmail: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸
- useLoginWithOAuth: ì†Œì…œ ë¡œê·¸ì¸
- useLoginWithOTP: OTP ë¡œê·¸ì¸
- useSelectTenant: í…Œë„ŒíŠ¸ ì„ íƒ
- useLogout: ë¡œê·¸ì•„ì›ƒ
- useSignupWithEmail: íšŒì›ê°€ì…
- useCreateTenant: í…Œë„ŒíŠ¸ ìƒì„± ë° ì˜¨ë³´ë”©
- useUserTenants: ì‚¬ìš©ì í…Œë„ŒíŠ¸ ëª©ë¡ ì¡°íšŒ

6-2. core-billing / core-metering (ê³¼ê¸ˆÂ·ì‚¬ìš©ëŸ‰ ì¶”ì )
Billing ê³µí†µ ê·œì¹™

invoices / invoice_items êµ¬ì¡° ëª¨ë“  ì—…ì¢… ê³µí†µ

item_type / categoryë¡œ ì—…ì¢…ë³„ ì²­êµ¬í•­ëª©ì„ ë¶„ë¥˜

ê²°ì œëŠ” payments í…Œì´ë¸”ì—ì„œ providerë³„ í†µí•© ì²˜ë¦¬

Metering(ì‚¬ìš©ëŸ‰ ê³„ì¸¡)

ì¶œê²° ê±´ìˆ˜

ë¬¸ìë°œì†¡ ìˆ˜

í™œì„± ëª¨ë“ˆ ìˆ˜

ì‚¬ìš©ì ìˆ˜

Edge Functionì—ì„œ ìˆ˜ì§‘í•˜ì—¬ ì„œë²„ê°€ ì¸ë³´ì´ìŠ¤ ìƒì„±.
ë°°ì¹˜ ì‹¤í–‰ ì‹œê°ì€ ë§¤ì¼ 04:00 KST ê³ ì •.

6-3. core-notification (ë©”ì‹œì§•/ì•Œë¦¼)

ì§€ì› ì±„ë„:

- SMS (`sms`): ê¸°ë³¸ ë¬¸ì ë©”ì‹œì§€ ì±„ë„
- ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ (`kakao_at`): ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ì±„ë„ (âš ï¸ ì¤‘ìš”: ì €ì¥/ì‹¤í–‰ìš© ì½”ë“œëŠ” 'kakao_at'ë§Œ í—ˆìš©, 'kakao' ì €ì¥ ê¸ˆì§€)
  - âš ï¸ Fallback ì •ì±…: ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ SMSë¡œ fallback
- ì´ë©”ì¼ (`email`): ì´ë©”ì¼ ì±„ë„
- ì•± Push (`push`): ì•± í‘¸ì‹œ ì•Œë¦¼ (ì„ íƒ)

Edge Function:

fns-notification-dispatch


ê¸°ëŠ¥:

í…œí”Œë¦¿ ê´€ë¦¬

ë©”ì‹œì§€ í ì²˜ë¦¬

ì¬ì‹œë„ ì •ì±…

ë°œì†¡ ë¡œê·¸ ì €ì¥

6-4. core-payment (ê²°ì œ/ì•Œë¦¼ë±…í‚¹ Provider)

core-paymentëŠ” ê²°ì œ ë„ë©”ì¸ ê³µí†µ ìŠ¤í‚¤ë§ˆ/ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì„ ì œê³µí•˜ê³ , ì‹¤ì œ ê²°ì œ API ì—°ë™ ì½”ë“œëŠ” /packages/payments/* Provider ëª¨ë“ˆì—ì„œ êµ¬í˜„í•œë‹¤.

Provider êµ¬ì¡°:

/packages/payments/
  â”œâ”€ payment-alimbank/
  â”œâ”€ payment-toss/
  â”œâ”€ payment-kg/
  â””â”€ payment-nice/


ê° ProviderëŠ” ë‹¤ìŒì„ êµ¬í˜„:

ê²°ì œ ìš”ì²­ ìƒì„±

ê²°ê³¼ ì›¹í›… ìˆ˜ì‹  ì²˜ë¦¬

ì‘ë‹µ ê²€ì¦(HMAC/Signature)

ë©±ë“±ì„± ì²˜ë¦¬

invoice-status ì—…ë°ì´íŠ¸

Edge Function:

fns-payment-alimbank-request
fns-payment-alimbank-webhook

6-5. core-config (í™˜ê²½ì„¤ì •)

tenant_settings ê¸°ë°˜ìœ¼ë¡œ ì—…ì¢…ë³„ ì„¸íŒ… ì œê³µ:

ì˜ˆì‹œ:

ì¶œê²° ê¸°ì¤€ ì‹œê°„
ì§€ê°/ê²°ì„ ê¸°ì¤€ (ë¶„ ë‹¨ìœ„)
ê¸°ë³¸ ì²­êµ¬ ì£¼ê¸°
UI í…Œë§ˆ(light/dark)
ê¸°ë³¸ ë¡œê³ /ë¸Œëœë”©
ê¸°ëŠ¥ on/off


JSON êµ¬ì„±:

{
  "attendance": {
    "late_after": 10,
    "absent_after": 60
  },
  "billing": {
    "cycle": "monthly"
  },
  "ui": {
    "theme": "light",
    "zoom": 100
  },
  "ai": {
    // âš ï¸ ì¤‘ìš”: AI ê¸°ëŠ¥ ì˜¨ì˜¤í”„ëŠ” tenant_features(feature_key='ai').enabledë¥¼ SSOTë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    // tenant_settings.ai.enabledëŠ” ë ˆê±°ì‹œì´ë©°, ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    // SSOT: tenant_features(feature_key='ai').enabled (í”„ë¡ íŠ¸ ìƒí™© ì‹ í˜¸ ìˆ˜ì§‘ ë¬¸ì„œ ì°¸ì¡°)
    "risk_score_weights": {
      "attendance_weight": 0.4,
      "counseling_weight": 0.3,
      "payment_weight": 0.2,
      "performance_weight": 0.1
    },
    "daily_briefing_time": "07:00",
    "model_retraining_schedule": "weekly_sunday_04:00",
    "pii_masking_enabled": true
  }
}

6-6. core-analytics (í†µê³„ íŒŒì´í”„ë¼ì¸)
ë°ì´í„° ì†ŒìŠ¤

ì¶œê²° ì´ë²¤íŠ¸

ê²°ì œ ì´ë²¤íŠ¸(invoices/payments)

ìˆ˜ê°•ì‹ ì²­/ì˜ˆì•½

ë¡œê·¸ì¸ ê¸°ë¡

ì§ì› í™œë™

íŒŒì´í”„ë¼ì¸ êµ¬ì¡°
ì›ì‹œ ì´ë²¤íŠ¸ í…Œì´ë¸” (ë¡œê·¸ì„±) â€” íŒŒí‹°ì…”ë‹
â†“
ì™¸ë¶€ ëŸ°íƒ€ì„(Lambda/Cloudflare Workers) ì§‘ê³„ (ë§¤ì¼ 04:00 KST, Supabase cronì€ íŠ¸ë¦¬ê±°ë§Œ ìˆ˜í–‰)
â†“
analytics.daily_store_metrics (ë§¤ì¥ ë‹¨ìœ„ ì¼ë³„ KPI, ì •ë³¸)
analytics.daily_region_metrics (ì§€ì—­ ë‹¨ìœ„ ì§‘ê³„ KPI, ì •ë³¸)
âš ï¸ ì¤‘ìš”: analytics.daily_metrics, analytics.monthly_revenueëŠ” êµ¬ë²„ì „/íê¸°ëœ ë„¤ì´ë°ì´ë©° ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ë³¸ì€ analytics.daily_store_metrics, analytics.daily_region_metricsë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
â†“
ë·°(Materialized View)
â†“
ëŒ€ì‹œë³´ë“œ

6-7. core-party (íšŒì›/ê³ ê° ê³µí†µ ëª¨ë¸)

âš ï¸ ì¤‘ìš”: ëª¨ë“  ì—…ì¢…ì—ì„œ íšŒì›/ê³ ê° ê°œë…ì´ í•„ìš”í•˜ë¯€ë¡œ ê³µí†µ ëª¨ë“ˆë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.

ëª©ì 

ëª¨ë“  ì—…ì¢…ì˜ íšŒì›/ê³ ê° ê³µí†µ ëª¨ë¸ ì œê³µ

ì—…ì¢…ë³„ ì‚¬ìš©:
- í•™ì›: í•™ìƒ(Student)
- ì²´ìœ¡ê´€: íšŒì›(Member)
- ë¯¸ìš©ì‹¤: ê³ ê°(Customer)
- ë¶€ë™ì‚°: ì…ì£¼ì(Resident)
- ë¹„ì˜ë¦¬: í›„ì›ì(Donor)

ë°ì´í„° ëª¨ë¸

Core Party í…Œì´ë¸” (persons):

CREATE TABLE persons (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  name text NOT NULL,
  email text,
  phone text,
  address text,
  person_type text NOT NULL CHECK (person_type IN ('learner', 'student', 'customer', 'member', 'resident', 'donor', 'instructor', 'teacher')),  -- learner/instructorëŠ” ì •ë³¸ í‚¤, student/teacherëŠ” backward compatibility
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

ì—…ì¢…ë³„ í™•ì¥ í…Œì´ë¸” íŒ¨í„´:

í•™ì›(academy):
CREATE TABLE academy_students (
  person_id uuid PRIMARY KEY REFERENCES persons(id),
  grade text,
  class_name text,
  school_name text,
  ...
);

ë¯¸ìš©ì‹¤(salon):
CREATE TABLE salon_customers (
  person_id uuid PRIMARY KEY REFERENCES persons(id),
  hair_type text,
  preferred_style text,
  ...
);

ì£¼ìš” ê¸°ëŠ¥

Party CRUD (persons í…Œì´ë¸” ê¸°ë°˜)

person_type ê´€ë¦¬

ê³µí†µ í•„ë“œ ê´€ë¦¬ (name, email, phone, address ë“±)

ì—…ì¢…ë³„ í™•ì¥ ì§€ì›

Industry Layer ì—°ë™

Industry LayerëŠ” core-partyë¥¼ í™•ì¥í•˜ì—¬ ì‚¬ìš©:

```typescript
// Industry Layerì—ì„œ ì‚¬ìš©
import { partyService } from '@core/party/service';
import type { Person } from '@core/party';

// í•™ì› ì—…ì¢…ì—ì„œ í•™ìƒ ìƒì„± ì‹œ
const person = await partyService.createPerson(tenantId, {
  name: 'í™ê¸¸ë™',
  email: 'hong@example.com',
  person_type: 'student',
  ...
});

// ì´í›„ academy_students í…Œì´ë¸”ì— í™•ì¥ ì •ë³´ ì €ì¥
```

6-8. core-consultation (ìƒë‹´/ê¸°ë¡ ê´€ë¦¬)

ëª©ì 

ëª¨ë“  ì—…ì¢…ì˜ ìƒë‹´/ê¸°ë¡ ê³µí†µ ê´€ë¦¬

ì—…ì¢…ë³„ ì‚¬ìš©:
- í•™ì›: ìƒë‹´ì¼ì§€/í•™ìŠµì¼ì§€
- ì²´ìœ¡ê´€: ìˆ˜ë ¨ ê¸°ë¡
- ë¯¸ìš©ì‹¤: ì‹œìˆ  ê¸°ë¡
- ë¶€ë™ì‚°: ìƒë‹´ ê¸°ë¡

ì£¼ìš” ê¸°ëŠ¥

ìƒë‹´/ê¸°ë¡ CRUD

ì²¨ë¶€ íŒŒì¼ ê´€ë¦¬ (core-storage ì—°ë™)

ê²€ìƒ‰ ê¸°ëŠ¥ (core-search ì—°ë™)

AI ìš”ì•½ ì—°ë™ (í–¥í›„)

ë°ì´í„° ëª¨ë¸

CREATE TABLE consultations (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  person_id uuid REFERENCES persons(id),
  consultation_type text NOT NULL,
  title text,
  content text NOT NULL,
  consultation_date date NOT NULL,
  created_by uuid REFERENCES auth.users(id),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

6-9. core-reviews (ë¦¬ë·°/í‰ê°€ ì‹œìŠ¤í…œ)

ëª©ì 

ëª¨ë“  ì—…ì¢…ì˜ ë¦¬ë·°/í‰ê°€ ê³µí†µ ê´€ë¦¬

ì—…ì¢…ë³„ ì‚¬ìš©:
- í•™ì›: í•™ë¶€ëª¨ í‰ê°€
- ì²´ìœ¡ê´€: íšŒì› í‰ê°€
- ë¯¸ìš©ì‹¤: ê³ ê° ë¦¬ë·°
- ë¶€ë™ì‚°: ì…ì£¼ì í‰ê°€

ì£¼ìš” ê¸°ëŠ¥

ë¦¬ë·°/í‰ê°€ CRUD

í‰ì  ì‹œìŠ¤í…œ (1-5ì )

ëŒ“ê¸€ ê¸°ëŠ¥ (core-communityì™€ ì—°ë™ ê°€ëŠ¥)

ì‚¬ì§„ ì²¨ë¶€ (core-storage ì—°ë™)

ë°ì´í„° ëª¨ë¸

CREATE TABLE reviews (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  person_id uuid REFERENCES persons(id),
  rating integer NOT NULL CHECK (rating >= 1 AND rating <= 5),
  title text,
  content text,
  is_visible boolean NOT NULL DEFAULT true,
  created_by uuid REFERENCES auth.users(id),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

6-10. core-coupons (ì¿ í°/í• ì¸ ê´€ë¦¬)

ëª©ì 

ëª¨ë“  ì—…ì¢…ì˜ ì¿ í°/í• ì¸ ê´€ë¦¬ (ê³ ê° ëŒ€ìƒ)

ì£¼ìš” ê¸°ëŠ¥

ì¿ í° CRUD

í• ì¸ ì ìš© ë¡œì§

ì¿ í° ì‚¬ìš© ë‚´ì—­

ì¿ í° ìœ íš¨ì„± ê²€ì¦

ë°ì´í„° ëª¨ë¸

CREATE TABLE coupons (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  code text NOT NULL,
  name text NOT NULL,
  discount_type text NOT NULL CHECK (discount_type IN ('percentage', 'fixed')),
  discount_value numeric NOT NULL,
  min_purchase_amount numeric,
  max_discount_amount numeric,
  valid_from date NOT NULL,
  valid_until date NOT NULL,
  usage_limit integer,
  usage_count integer NOT NULL DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE coupon_usages (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  coupon_id uuid NOT NULL REFERENCES coupons(id),
  person_id uuid REFERENCES persons(id),
  invoice_id uuid REFERENCES invoices(id),
  used_at timestamptz NOT NULL DEFAULT now()
);

6-11. core-tenancy-referral (B2B ì¶”ì²œì¸ ì½”ë“œ)

âš ï¸ ì¤‘ìš”: SaaS ì‚¬ìš©ì(í…Œë„ŒíŠ¸) ê°„ B2B ì¶”ì²œì¸ ì½”ë“œ ì œë„ì…ë‹ˆë‹¤.

ëª©ì 

SaaS ì‚¬ìš©ì(í•™ì› ìš´ì˜ì)ê°€ ë‹¤ë¥¸ í•™ì› ì›ì¥ì—ê²Œ ì¶”ì²œí•˜ëŠ” B2B ì¶”ì²œì¸ ì‹œìŠ¤í…œ

íŠ¹ë³„ ìš”êµ¬ì‚¬í•­

B2B ì¶”ì²œì¸ ì½”ë“œ ì œë„ í•„ìˆ˜ í¬í•¨

ì¶”ì²œì¸ ì½”ë“œ ìƒì„±/ì‚¬ìš©/ë³´ìƒ ê´€ë¦¬

ì£¼ìš” ê¸°ëŠ¥

ì¶”ì²œì¸ ì½”ë“œ ìƒì„± (ì¶”ì²œì¸ tenant_idì™€ ì—°ê²°)

ì¶”ì²œì¸ ì½”ë“œ ê²€ì¦

ì¶”ì²œì¸ ì½”ë“œ ì‚¬ìš© ì¶”ì  (ì‹ ê·œ ê°€ì…ì tenant_idì™€ ì—°ê²°)

ì¶”ì²œì¸ ë³´ìƒ ì‹œìŠ¤í…œ (í• ì¸/í¬ë ˆë”§ ë“±)

ì¶”ì²œì¸ í†µê³„ (ì¶”ì²œ ê±´ìˆ˜, ì„±ê³µ ê±´ìˆ˜ ë“±)

ë°ì´í„° ëª¨ë¸

CREATE TABLE referral_codes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_tenant_id uuid NOT NULL REFERENCES tenants(id),
  code text NOT NULL UNIQUE,
  reward_type text NOT NULL CHECK (reward_type IN ('discount', 'credit', 'free_trial')),
  reward_value numeric,
  is_active boolean NOT NULL DEFAULT true,
  expires_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE referral_usages (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  referral_code_id uuid NOT NULL REFERENCES referral_codes(id),
  new_tenant_id uuid NOT NULL REFERENCES tenants(id),
  used_at timestamptz NOT NULL DEFAULT now(),
  reward_applied boolean NOT NULL DEFAULT false,
  reward_applied_at timestamptz
);

ë³´ìƒ ì§€ê¸‰ ë¡œì§

ì‹ ê·œ í…Œë„ŒíŠ¸ ê°€ì… ì‹œ ì¶”ì²œì¸ ì½”ë“œ ì‚¬ìš©

ë³´ìƒ íƒ€ì…ì— ë”°ë¼ í• ì¸/í¬ë ˆë”§/ë¬´ë£Œ ì²´í—˜ ì ìš©

ë³´ìƒ ì§€ê¸‰ í›„ reward_applied í”Œë˜ê·¸ ì—…ë°ì´íŠ¸

6-12. core-events (ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜)

ëª©ì 

ëª¨ë“  ì—…ì¢…ì˜ ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜ ê³µí†µ ê´€ë¦¬

ì£¼ìš” ê¸°ëŠ¥

ì´ë²¤íŠ¸ CRUD

ì°¸ì—¬ ê´€ë¦¬

ì•Œë¦¼ ë°œì†¡ (core-notification ì—°ë™)

í†µê³„ ì§‘ê³„

ë°ì´í„° ëª¨ë¸

CREATE TABLE events (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  title text NOT NULL,
  description text,
  event_type text NOT NULL,
  start_date date NOT NULL,
  end_date date NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE event_participants (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  event_id uuid NOT NULL REFERENCES events(id),
  person_id uuid REFERENCES persons(id),
  participated_at timestamptz NOT NULL DEFAULT now()
);

6-13. core-calendar (ì¼ì •/ì˜ˆì•½/ìˆ˜ì—… ìŠ¤ì¼€ì¤„)

âš ï¸ ì¤‘ìš”: ìì²´ êµ¬í˜„ ê¶Œì¥ (ë””ìì¸ ì‹œìŠ¤í…œ í†µí•©, ë©€í‹°í…Œë„ŒíŠ¸ íŠ¹í™”)

ëª©ì 

ì¼ì •/ì˜ˆì•½/ìˆ˜ì—… ìŠ¤ì¼€ì¤„ ê³µí†µ ë„ë©”ì¸

êµ¬í˜„ ë°©ì‹

ìì²´ êµ¬í˜„ ê¶Œì¥:
- ë””ìì¸ ì‹œìŠ¤í…œ(@ui-core/react)ê³¼ ì™„ë²½ í†µí•©
- ë©€í‹°í…Œë„ŒíŠ¸ íŠ¹í™” ê¸°ëŠ¥ êµ¬í˜„ ìš©ì´
- ë²ˆë“¤ í¬ê¸° ìµœì í™”
- Zero-Trust ì•„í‚¤í…ì²˜ì™€ì˜ í†µí•© ìš©ì´

ìƒìš©í™” ë‹¨ê³„ì—ì„œ ê¸°ë³¸ ìº˜ë¦°ë” ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì • (ì„œë¹„ìŠ¤ ì½”ë“œ ì™„ë£Œ, schedules í…Œì´ë¸” ìƒì„± ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)

ë³µì¡í•œ ê¸°ëŠ¥ì€ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ì¶”ê°€ ì˜ˆì •

ì£¼ìš” ê¸°ëŠ¥

ìŠ¤ì¼€ì¤„/ì˜ˆì•½ CRUD

ë°˜ë³µ ì¼ì • ê´€ë¦¬

ì •ì› ê´€ë¦¬

ë‹´ë‹¹ì ë°°ì •

ìº˜ë¦°ë” ë·° ì§€ì› (ê¸°ë³¸ ê¸°ëŠ¥)

ë°ì´í„° ëª¨ë¸

CREATE TABLE schedules (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  title text NOT NULL,
  description text,
  start_time timestamptz NOT NULL,
  end_time timestamptz NOT NULL,
  repeat_pattern text, -- 'daily', 'weekly', 'monthly', 'none'
  capacity integer,
  assigned_to uuid REFERENCES auth.users(id),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

6-14. core-storage (íŒŒì¼ ì—…ë¡œë“œ/ê¶Œí•œ)

ëª©ì 

íŒŒì¼ ì—…ë¡œë“œ/ê¶Œí•œ/í´ë” êµ¬ì¡° ê³µí†µí™”, Supabase Storage ë˜í•‘

ì£¼ìš” ê¸°ëŠ¥

íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ

ê¶Œí•œ ê´€ë¦¬

í´ë” êµ¬ì¡° ê´€ë¦¬

íŒŒì¼ ë©”íƒ€ë°ì´í„° ê´€ë¦¬

ë¬¸ì„œ ë²„ì „ ê´€ë¦¬ (ë¬¸ì„œ ê´€ë¦¬ ê¸°ëŠ¥ í¬í•¨)

êµ¬í˜„ ë°©ì‹

Supabase Storage ë˜í•‘

í…Œë„ŒíŠ¸ë³„ í´ë” êµ¬ì¡°: `{tenant_id}/{module}/{file_id}`

RLS ê¸°ë°˜ ê¶Œí•œ ê´€ë¦¬

6-15. core-community (ê²Œì‹œíŒ/ëŒ“ê¸€/ê³µì§€)

âš ï¸ ì¤‘ìš”: ìì²´ êµ¬í˜„ ê¶Œì¥ (RLS ê¸°ë°˜ í…Œë„ŒíŠ¸ ê²©ë¦¬)

ëª©ì 

ê³µí†µ ê²Œì‹œíŒ/ëŒ“ê¸€/ê³µì§€/íŒŒì¼ ì²¨ë¶€ ìŠ¤í‚¤ë§ˆ ë° API

êµ¬í˜„ ë°©ì‹

ìì²´ êµ¬í˜„ ê¶Œì¥:
- RLS ê¸°ë°˜ ì™„ë²½í•œ í…Œë„ŒíŠ¸ ê²©ë¦¬
- ë””ìì¸ ì‹œìŠ¤í…œ í†µí•©
- Zero-Trust ì•„í‚¤í…ì²˜ ì¤€ìˆ˜
- ì»¤ìŠ¤í„°ë§ˆì´ì§• ììœ ë„

ì£¼ìš” ê¸°ëŠ¥

ê²Œì‹œíŒ CRUD

ëŒ“ê¸€ ê¸°ëŠ¥

ê³µì§€ì‚¬í•­ ê´€ë¦¬

íŒŒì¼ ì²¨ë¶€ (core-storage ì—°ë™)

ë°ì´í„° ëª¨ë¸

CREATE TABLE posts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  title text NOT NULL,
  content text NOT NULL,
  post_type text NOT NULL CHECK (post_type IN ('notice', 'board', 'announcement')),
  is_pinned boolean NOT NULL DEFAULT false,
  created_by uuid REFERENCES auth.users(id),
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE comments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL REFERENCES tenants(id),
  post_id uuid NOT NULL REFERENCES posts(id),
  content text NOT NULL,
  created_by uuid REFERENCES auth.users(id),
  created_at timestamptz NOT NULL DEFAULT now()
);

6-16. core-search (Full Text Search)

âš ï¸ ì¤‘ìš”: ìƒìš©í™” ë‹¨ê³„ì—ì„œ PostgreSQL Full Text Search êµ¬í˜„ ì™„ë£Œ, ì™¸ë¶€ ê²€ìƒ‰ ì—”ì§„(Meilisearch/Algolia)ì€ Phase 2+ ê²€í†  ì˜ˆì •.

ëª©ì 

Full Text Search ê³µí†µ ë ˆì´ì–´

êµ¬í˜„ ë°©ì‹

ìƒìš©í™” ë‹¨ê³„: PostgreSQL Full Text Search
- ì¶”ê°€ ì¸í”„ë¼ ë¶ˆí•„ìš”
- RLSì™€ ì™„ë²½ í†µí•©
- ë¹„ìš© ì ˆê°

ìƒìš©í™” ë‹¨ê³„: ì™¸ë¶€ ê²€ìƒ‰ ì—”ì§„ êµ¬í˜„ ì˜ˆì • (Phase 2+ ê²€í† )
- Meilisearch, Algolia ë“±
- ê³ ê¸‰ ê²€ìƒ‰ ê¸°ëŠ¥ í•„ìš” ì‹œ

ì£¼ìš” ê¸°ëŠ¥

ê²€ìƒ‰ ì¸ë±ì‹± (PostgreSQL FTS)

ê²€ìƒ‰ ì¿¼ë¦¬ ì²˜ë¦¬

ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬

6-17. ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ vs ìì²´ êµ¬í˜„ ì •ì±…

âš ï¸ ì¤‘ìš”: Core Layer ëª¨ë“ˆ êµ¬í˜„ ì‹œ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ì •ì±…

ì›ì¹™

ë©€í‹°í…Œë„ŒíŠ¸ ê²©ë¦¬ì™€ Zero-Trust ì•„í‚¤í…ì²˜ê°€ í•µì‹¬ ìš”êµ¬ì‚¬í•­

ë””ìì¸ ì‹œìŠ¤í…œ í†µí•©ì´ ì¤‘ìš”

ìì²´ êµ¬í˜„ ê¶Œì¥ ëª¨ë“ˆ

core-calendar: ê¸°ë³¸ ê¸°ëŠ¥ì„ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ìì²´ êµ¬í˜„ ì˜ˆì • (ì„œë¹„ìŠ¤ ì½”ë“œ ì™„ë£Œ, schedules í…Œì´ë¸” ìƒì„± ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)

core-community: ê²Œì‹œíŒ/ëŒ“ê¸€ì€ ìì²´ êµ¬í˜„ (RLS ê¸°ë°˜ í…Œë„ŒíŠ¸ ê²©ë¦¬)

core-search: ìƒìš©í™” ë‹¨ê³„ëŠ” PostgreSQL Full Text Search

ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê³ ë ¤ ëª¨ë“ˆ (ìƒìš©í™” ë‹¨ê³„)

ê³ ê¸‰ ìº˜ë¦°ë” ê¸°ëŠ¥: í•„ìš” ì‹œ react-big-calendar ê²€í† 

ê³ ê¸‰ ê²€ìƒ‰: ìƒìš©í™” ë‹¨ê³„ì—ì„œ Meilisearch/Algolia êµ¬í˜„ ì˜ˆì • (Phase 2+ ê²€í† )

ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ì‹œ ê³ ë ¤ì‚¬í•­

ë²ˆë“¤ í¬ê¸° ì¦ê°€

ì»¤ìŠ¤í„°ë§ˆì´ì§• ì œí•œ

ë””ìì¸ ì‹œìŠ¤í…œê³¼ì˜ í†µí•© ì–´ë ¤ì›€

ë©€í‹°í…Œë„ŒíŠ¸ íŠ¹í™” ê¸°ëŠ¥ ì¶”ê°€ ì–´ë ¤ì›€

RLS ì •ì±…ê³¼ì˜ í†µí•© ë³µì¡

7. Industry Layer ì„¤ê³„

Industry LayerëŠ” ì—…ì¢…ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ Core ìœ„ì—ì„œ í™•ì¥í•˜ëŠ” êµ¬ì¡°ì´ë‹¤.

ì—…ì¢…ë³„ ì¶”ê°€ í•„ë“œëŠ” PART 1ì˜ 4-0 (Profile í™•ì¥ ì „ëµ) ì„¹ì…˜ì˜ Profile í™•ì¥ ëª¨ë¸(JSON Schema ë˜ëŠ” í™•ì¥ í…Œì´ë¸”)ì— ì˜í•´ êµ¬í˜„ëœë‹¤.

âš ï¸ ì¤‘ìš”: Industry Layer êµ¬ì¡°ëŠ” ìƒìš©í™” ë‹¨ê³„ë¶€í„° ì ìš©ë©ë‹ˆë‹¤.
- ì—…ì¢…ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ `packages/industry/industry-{ì—…ì¢…}/`ì— êµ¬í˜„ë©ë‹ˆë‹¤.
- Service LayerëŠ” Industry Layerë¥¼ ë˜í•‘í•˜ì—¬ ì œê³µí•©ë‹ˆë‹¤.
- Core LayerëŠ” Industry Layerë¥¼ importí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ë‹¨ë°©í–¥ ì˜ì¡´ì„±).

7-1. industry-academy (í•™ì›)

êµ¬ì¡°:
```
packages/industry/industry-academy/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ src/
    â”œâ”€â”€ index.ts          # íƒ€ì…ë§Œ export (í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ ì œì™¸)
    â”œâ”€â”€ types.ts          # í•™ì› ì „ìš© íƒ€ì… (Student, Guardian, Consultation ë“±)
    â””â”€â”€ service.ts        # í•™ì› ì „ìš© ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ì„œë²„ ì „ìš©)
```

Domain

í•™ìƒ(Student)

ë³´í˜¸ì(Guardian)

ë°˜(Class)

ìˆ˜ì—…(Lesson)

ì¶œê²°(Attendance)

ì²­êµ¬/ìˆ˜ë‚©(Billing)

ìƒë‹´(Consultation)

í•™ìŠµì¼ì§€(Learning Report)

Billing Mapping Example
êµìœ¡ë¹„
êµì¬ë¹„
íŠ¹ë³„í™œë™ë¹„
ê¸°íƒ€ë¹„ìš©

ì¶œê²° Hook íë¦„
ì¶œì„ ì²´í¬ â†’ ì¶œê²° ì´ë²¤íŠ¸ ë°œìƒ â†’ core-notification â†’ í•™ë¶€ëª¨ ì•Œë¦¼
â†’ core-metering â†’ ì‚¬ìš©ëŸ‰ ê¸°ë¡ â†’ core-billing â†’ ì›”ë§ ìë™ì²­êµ¬

Service Layer ì—°ë™:
- `@services/student-service`ëŠ” `@industry/academy/service`ë¥¼ ë˜í•‘í•˜ì—¬ ì œê³µí•©ë‹ˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ëŠ” `@services/student-service`ë¥¼ í†µí•´ íƒ€ì…ì„ importí•©ë‹ˆë‹¤.
- ì„œë²„ëŠ” `@industry/academy/service`ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ê±°ë‚˜ `@services/student-service/service`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

7-2. industry-salon (ë¯¸ìš©/ë„¤ì¼)
Domain

ì‹œìˆ  ë©”ë‰´

ì˜ˆì•½

ê³ ê°

ë©¤ë²„ì‹­/íšŸìˆ˜ê¶Œ

ì‹œìˆ  ê¸°ë¡

POS ë§¤ì¶œ

Billing Mapping

ì‹œìˆ ë¹„

ì¬ë£Œë¹„

íŒ¨í‚¤ì§€/íšŒì›ê¶Œ

7-3. industry-real-estate (ë¶€ë™ì‚°)
Domain

ë§¤ë¬¼

ì„ëŒ€/ë§¤ë§¤ ê³„ì•½

ì¤‘ê°œ ìˆ˜ìˆ˜ë£Œ

ê´€ë¦¬ë¹„

ì…ì£¼ì ê´€ë¦¬

Billing Mapping

ì¤‘ê°œ ìˆ˜ìˆ˜ë£Œ

ê´€ë¦¬ë¹„

ì˜µì…˜ë¹„

7-4. industry-gym (ì²´ìœ¡ê´€)
Domain

íšŒì›

ìˆ˜ë ¨ë¹„

ë„ë³µë¹„

ì‹¬ì‚¬ë¹„

ì¶œê²°

ë½ì»¤/ì‹œì„¤ ê´€ë¦¬

Billing Mapping

ìˆ˜ë ¨ë¹„

ë„ë³µë¹„

ì‹¬ì‚¬ë¹„

ì‹œì„¤ ì´ìš©ë£Œ

7-5. industry-ngo (ë¹„ì˜ë¦¬ ê¸°ê´€)
Domain

í›„ì›ì

ì •ê¸°/ì¼ì‹œ í›„ì›

ìº í˜ì¸

ì˜ìˆ˜ì¦ ë°œí–‰

ê¸°ë¶€ê¸ˆ ì˜ìˆ˜ì¦

Billing Mapping

ì •ê¸° í›„ì›ê¸ˆ

ì¼ì‹œ í›„ì›ê¸ˆ

ìº í˜ì¸ ê¸°ë¶€ê¸ˆ

7-6. Industry ê³µí†µ ê·œì¹™

[ë¶ˆë³€ ê·œì¹™] Core LayerëŠ” Industry ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•Šê³ , Industry ëª¨ë“ˆì´ Coreë¥¼ importí•˜ëŠ” ë‹¨ë°©í–¥ êµ¬ì¡°(Industry â†’ Core)ë¥¼ ìœ ì§€í•œë‹¤.

[ë¶ˆë³€ ê·œì¹™] Industry LayerëŠ” `packages/industry/industry-{ì—…ì¢…}/` êµ¬ì¡°ë¡œ êµ¬í˜„ë©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] Industry Layerì˜ `index.ts`ëŠ” íƒ€ì…ë§Œ exportí•˜ë©°, ì„œë²„ ì½”ë“œëŠ” `/service` ê²½ë¡œì—ì„œë§Œ importí•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] Service LayerëŠ” Industry Layerë¥¼ ë˜í•‘í•˜ì—¬ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆ: `@services/student-service` â†’ `@industry/academy/service`

[ë¶ˆë³€ ê·œì¹™] Industry LayerëŠ” Core Party ëª¨ë¸(`core-party`)ì„ í™•ì¥í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜ˆ: `academy_students` í…Œì´ë¸”ì€ `persons` í…Œì´ë¸”ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.

ê³µí†µ ë°ì´í„° ìŠ¤í‚¤ë§ˆ(invoices/payments/attendance ë“±) ì‚¬ìš©

ì—…ì¢…ë³„ configuration + í…œí”Œë¦¿ìœ¼ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§•

â†’ Industry â†’ Core ë°©í–¥ìœ¼ë¡œ ì˜ì¡´í•˜ë©°, CoreëŠ” Industryë¥¼ ëª¨ë¥´ë©´ ë©ë‹ˆë‹¤.

â†’ Service Layer â†’ Industry Layer â†’ Core Layer ì˜ì¡´ì„± ë°©í–¥ì„ ìœ ì§€í•©ë‹ˆë‹¤.

8. Service Layer

React ì»´í¬ë„ŒíŠ¸ëŠ” Supabase ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‹¤í–‰í•  ìˆ˜ ì—†ë‹¤.
Service Layerê°€ ëª¨ë“  DB ì ‘ê·¼ì„ ìº¡ìŠí™”í•œë‹¤.

âš ï¸ ì¤‘ìš”: Service LayerëŠ” Zero-Trust ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ êµ¬ì„± ìš”ì†Œì…ë‹ˆë‹¤.

8-0. Zero-Trustì™€ Service Layer ê´€ê³„ (Critical)

ë³´ì•ˆ ì±…ì„ ë¶„ë‹´ êµ¬ì¡°:

UI Layer (React ì»´í¬ë„ŒíŠ¸):
- tenant_idë¥¼ ì§ì ‘ ìƒì„±/ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
- @api-sdk/coreë¥¼ í†µí•´ì„œë§Œ ë°ì´í„° ìš”ì²­
- ê¶Œí•œ ì¶”ë¡ í•˜ì§€ ì•ŠìŒ

API SDK Layer (@api-sdk/core):
- Contextì—ì„œ tenant_id, industry_type ìë™ ê°€ì ¸ì˜¤ê¸°
- ëª¨ë“  ìš”ì²­ì— tenant_id, industry_type, auth token ìë™ ì‚½ì…
- ê¶Œí•œ ìƒì„±í•˜ì§€ ì•ŠìŒ
- ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„ ì •ì±… ê´€ë¦¬
- ìš”ì²­ ìºì‹± (ì„ íƒì )
- Edge Function í˜¸ì¶œ ë˜í•‘

Service Layer (@services/*, @industry/*/service):
- tenant_idë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ì‚¬ìš©
- withTenant()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ í•„í„°ë§
- RLS ì •ì±…ê³¼ í•¨ê»˜ 2ì¤‘ í•„í„°ë§ ë³´ì¥
- DB ì ‘ê·¼ ìº¡ìŠí™”

RLS Layer (PostgreSQL RLS):
- ìµœì¢… ë³´ì•ˆ ê²½ê³„
- JWT claim ê¸°ë°˜ tenant_id í•„í„°ë§
- ê¶Œí•œ ê²°ì • ë° ë°ì´í„° ê²©ë¦¬

ë³´ì•ˆ íë¦„:
```
UI â†’ @api-sdk/core (Contextì—ì„œ tenant_id ê°€ì ¸ì˜¤ê¸°)
  â†’ Service Layer (tenant_id íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬)
  â†’ withTenant() (ì¿¼ë¦¬ í•„í„°ë§)
  â†’ RLS (ìµœì¢… ë³´ì•ˆ ê²€ì¦)
  â†’ DB
```

Service Layerì˜ ë³´ì•ˆ ì±…ì„:
- tenant_id íŒŒë¼ë¯¸í„° ê²€ì¦ (null/undefined ì²´í¬)
- withTenant() ì‚¬ìš© ê°•ì œ (SELECT/UPDATE/DELETE)
- INSERT ì‹œ tenant_id ì§ì ‘ í¬í•¨
- RLS ìš°íšŒ ê¸ˆì§€ (Service Role Key ì‚¬ìš© ì‹œì—ë„ RLS ì •ì±… ì¤€ìˆ˜)

8-1. ê·œì¹™

Serviceë§Œ Supabase ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰

React â†’ Hook â†’ Service ìˆœì„œ

ServiceëŠ” í•­ìƒ tenant_idë¥¼ ê°•ì œë¡œ ì£¼ì…

ServiceëŠ” RLSë¥¼ ìš°íšŒí•˜ì§€ ì•ŠëŠ”ë‹¤

ë³µì¡ ì¿¼ë¦¬ëŠ” Edge Function ì‚¬ìš©

8-2. ì˜ˆì‹œ ì½”ë“œ
// attendance-service
import { withTenant } from '../_db';

export const attendanceService = {
  async checkIn(tenantId, studentId) {
    // INSERTëŠ” tenant_idë¥¼ row objectì— ì§ì ‘ í¬í•¨
    return supabase
      .from('attendance_logs')
      .insert({
        tenant_id: tenantId,
        student_id: studentId,
        occurred_at: new Date()
      });
  },

  async list(tenantId, filters) {
    // SELECTëŠ” ë°˜ë“œì‹œ withTenant() ì‚¬ìš©
    return withTenant(
      supabase
      .from('attendance_logs')
      .select('*')
        .order('occurred_at', { ascending: false }),
      tenantId
    );
  }
}

8-2-1. ì„œë¹„ìŠ¤ ê³µí†µ ì¿¼ë¦¬ ê°€ë“œ (Critical)

// services/_db.ts
export function withTenant<T>(q: PostgrestFilterBuilder<T>, tenantId: string) {
  return q.eq('tenant_id', tenantId);
}

// ì‚¬ìš© ì˜ˆ
return withTenant(
  supabase.from('students').select('*').order('created_at', { ascending: false }),
  tenantId
);

8-2-2. Supabase ì»¤ë„¥ì…˜ í’€ë§/ì¿¼ë¦¬ ê°€ë“œ (Critical)

í…Œë„ŒíŠ¸/ì•± ìˆ˜ ì¦ëŒ€ ì‹œ ì»¤ë„¥ì…˜ ê³ ê°ˆÂ·íì‰ ìœ„í—˜ ë°©ì§€:

pgbouncer(ì„¸ì…˜/íŠ¸ëœì­ì…˜ ëª¨ë“œ) ìƒì •, Edge/Lambda ë™ì‹œì ‘ì† ìƒí•œì¹˜ ë¬¸ì„œí™”

ì„œë¹„ìŠ¤ ë ˆì´ì–´ ê³µí†µ ë˜í¼ì— íƒ€ì„ì•„ì›ƒ ê°•ì œ:

ê°€ëŠ¥í•˜ë©´ DB ë ˆë²¨ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•˜ê³ , í•„ìš” ì‹œ Edge Functionì—ì„œ ì¿¼ë¦¬ ì§ì „ì— SET LOCALì„ ì“°ëŠ” í˜•íƒœë¡œ ì ìš©í•œë‹¤.

-- ì„¸ì…˜ ê°€ë“œ (ë¡œê·¸ì¸ ì§í›„, ë˜ëŠ” ì„œë¹„ìŠ¤ ì»¤ë„¥ì…˜ ì´ˆê¸°í™” ì‹œ)
-- ì£¼ì˜: Supabase PgBouncer í’€ë§ ëª¨ë“œì—ì„œëŠ” ì„¸ì…˜ ë ˆë²¨ SETì´ ì œí•œë  ìˆ˜ ìˆìŒ
SET statement_timeout = '8s';
SET idle_in_transaction_session_timeout = '3s';
SET lock_timeout = '2s';

ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ì •ì±…(ì§€ìˆ˜ ë°±ì˜¤í”„)ê³¼ ê²°ì œ/ì›¹í›… ì¬ì²˜ë¦¬ì™€ì˜ ì¤‘ë³µ ë°©ì§€ ë¡œì§ ì—°ê²° (14-2-1 ì°¸ì¡°)

â†’ ì»¤ë„¥ì…˜ í’€ ê´€ë¦¬ ë° ì¿¼ë¦¬ íƒ€ì„ì•„ì›ƒì€ ëŒ€ê·œëª¨ ìš´ì˜ í•„ìˆ˜

8-3. ì—ëŸ¬ í•¸ë“¤ë§ ì „ëµ (Critical)

Service Layer ì—ëŸ¬ ë¶„ë¥˜:

ValidationError: ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨ (400 Bad Request)

NotFoundError: ë¦¬ì†ŒìŠ¤ ì—†ìŒ (404 Not Found)

PermissionError: ê¶Œí•œ ì—†ìŒ (403 Forbidden)

ConflictError: ë¦¬ì†ŒìŠ¤ ì¶©ëŒ (409 Conflict)

RateLimitError: ìš”ì²­ í•œë„ ì´ˆê³¼ (429 Too Many Requests)

InternalError: ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ (500 Internal Server Error)

ì—ëŸ¬ ì‘ë‹µ í‘œì¤€í™”:

ëª¨ë“  Service í•¨ìˆ˜ëŠ” í‘œì¤€ ì—ëŸ¬ ê°ì²´ ë°˜í™˜

í´ë¼ì´ì–¸íŠ¸ì—ëŠ” ë¯¼ê° ì •ë³´ ë…¸ì¶œ ê¸ˆì§€ (ì˜ˆ: DB ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¹€)

ì—ëŸ¬ ë¡œê¹…:

ëª¨ë“  ì—ëŸ¬ëŠ” audit.eventsì— ê¸°ë¡ (InternalErrorëŠ” ì¦‰ì‹œ ì•Œë¦¼)

ì—ëŸ¬ ë¡œê·¸ ë° audit.eventsì—ëŠ” PII(ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ë“±)ë¥¼ ì§ì ‘ ë‚¨ê¸°ì§€ ì•ŠëŠ”ë‹¤.

í•„ìš”í•œ ê²½ìš° ì‹ë³„ ê°€ëŠ¥í•œ ìµœì†Œ ë‹¨ìœ„(ID, hash, key_version ë“±)ë§Œ ê¸°ë¡í•œë‹¤.

PII ìµœì†Œí™” ê°•ì œ ê·œì¹™:

audit.events.metaì— PII ê¸ˆì§€ ë£° ì¶”ê°€ (ì •ê·œì‹ ë§ˆìŠ¤í‚¹ í›„ ì‚½ì…)

ESLint/TS Rule: logger.* í˜¸ì¶œ ì‹œ PII íƒ€ì… ê²½ê³ 

19-6-1. PII ë§ˆìŠ¤í‚¹ ìœ í‹¸ë¦¬í‹° (Critical)

âš ï¸ ì¤‘ìš”: ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ë§ˆìŠ¤í‚¹ë§Œìœ¼ë¡œ ì¶©ë¶„í•˜ë©°, ëª¨ë“  PII ë§ˆìŠ¤í‚¹ ìœ í‹¸ë¦¬í‹°ëŠ” ì¤‘ì•™ ëª¨ë“ˆì— ì •ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

[ë¶ˆë³€ ê·œì¹™] PII ë§ˆìŠ¤í‚¹ ìœ í‹¸ë¦¬í‹°ëŠ” packages/core/pii-utils ë˜ëŠ” packages/core-config/pii-utilsì— ì •ì˜í•˜ë©°, ëª¨ë“  ì• í”Œë¦¬ì¼€ì´ì…˜(academy-admin, academy-parent ë“±)ì—ì„œ ì¼ê´€ë˜ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

ë§ˆìŠ¤í‚¹ ìœ í‹¸ë¦¬í‹° ìœ„ì¹˜:

packages/core/pii-utils/src/index.ts

ë˜ëŠ”

packages/core-config/pii-utils/src/index.ts

ë§ˆìŠ¤í‚¹ ìœ í‹¸ë¦¬í‹° ì •ì˜:

export const maskPhone = (phone: string | null | undefined): string => {
  if (!phone) return '';
  // 010-1234-5678 â†’ 010-****-5678
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
};

export const maskEmail = (email: string | null | undefined): string => {
  if (!email) return '';
  // user@example.com â†’ u***@example.com
  return email.replace(/(^.).*(@.*$)/, '$1***$2');
};

export const maskName = (name: string | null | undefined): string => {
  if (!name) return '';
  // í™ê¸¸ë™ â†’ í™*ë™
  if (name.length <= 2) return name.charAt(0) + '*';
  return name.charAt(0) + '*'.repeat(name.length - 2) + name.charAt(name.length - 1);
};

export const maskPII = (data: any): any => {
  if (typeof data === 'string') {
    // ì´ë©”ì¼ ë§ˆìŠ¤í‚¹
    data = data.replace(/(^.).*(@.*$)/, '$1***$2');
    // ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹
    data = data.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  }
  return data;
};

â†’ ê°ì‚¬ ë¡œê·¸ì˜ PII ìµœì†Œí™”ëŠ” ë²•ì  ìš”êµ¬ì‚¬í•­

ì¬ì‹œë„ ì •ì±…:

ì¬ì‹œë„ ê°€ëŠ¥: NetworkError, TimeoutError, RateLimitError

ì¬ì‹œë„ ë¶ˆê°€ëŠ¥: ValidationError, PermissionError, NotFoundError

êµ¬í˜„ ì˜ˆì‹œ:

export class AppError extends Error {
  constructor(
    public code: string,
    public statusCode: number,
    message: string,
    public isRetryable: boolean = false
  ) {
    super(message);
  }
}

export const handleServiceError = (error: unknown) => {
  if (error instanceof AppError) {
    // í´ë¼ì´ì–¸íŠ¸ìš© ì•ˆì „í•œ ë©”ì‹œì§€
    return { code: error.code, message: error.message };
  }
  // ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ëŠ” InternalErrorë¡œ ì²˜ë¦¬
  logger.error('Unexpected error', error);
  return { code: 'INTERNAL_ERROR', message: 'An error occurred' };
};

Supabase PostgREST Error ë³€í™˜:

Supabase PostgREST error (code, message, details, hint)ëŠ” AppErrorë¡œ ë³€í™˜í•´ statusCode Â· isRetryableì„ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.

ì˜ˆì‹œ:

const mapPostgrestError = (error: PostgrestError): AppError => {
  const code = error.code;
  if (code === '23505') return new AppError('CONFLICT', 409, error.message, false);
  if (code === '23503') return new AppError('NOT_FOUND', 404, error.message, false);
  // ... ê¸°íƒ€ ì—ëŸ¬ ì½”ë“œ ë§¤í•‘
  return new AppError('INTERNAL_ERROR', 500, error.message, false);
};


â†’ ì‹¤ë¬´ì—ì„œ í•„ìˆ˜ì ì¸ ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ

8-4. Service vs Edge Key ê²½ê³„ ëª…ë¬¸í™”

Layer	í—ˆìš© Key	ì„¤ëª…
Service Layer	anon/auth	RLS ìš°íšŒ ê¸ˆì§€
Edge Functions	Service Role	WebhookÂ·ë°°ì¹˜Â·ì„œëª… ê²€ì¦ìš©

í´ë¼ì´ì–¸íŠ¸ì—ì„œ tenant_id ì „ë‹¬ê°’ ì‹ ë¢° ê¸ˆì§€

âš ï¸ Deprecated: Edge Functionì—ì„œ set_config ì‚¬ìš©ì€ ë” ì´ìƒ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

âœ… ëŒ€ì‹ : JWT claim ê¸°ë°˜ RLSë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (PART 1ì˜ 3-1-1 ì„¹ì…˜ ì°¸ì¡°)

âŒ ê¸ˆì§€ ì˜ˆì‹œ:
```typescript
// âš ï¸ ë ˆê±°ì‹œ ì˜ˆì‹œ: Transaction Poolingì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŒ
// Edge Functionì—ì„œ set_config ì‚¬ìš© (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
await supabase.rpc('set_config', {
  key: 'app.current_tenant_id',
  value: verified_tenant_id
});
```

âœ… ê¶Œì¥ ì˜ˆì‹œ:
```typescript
// âš ï¸ ì¤‘ìš”: x-tenant-id í—¤ë”ë¥¼ ë„£ëŠ”ë‹¤ê³  JWT claimì´ ìë™ìœ¼ë¡œ ë°”ë€ŒëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.
// JWT claimì€ ì„œë²„/Edge Functionì—ì„œ tenant ì„ íƒ ì‹œ ëª…ì‹œì ìœ¼ë¡œ ì¬ë°œê¸‰í•´ì•¼ í•©ë‹ˆë‹¤.
//
// ì˜¬ë°”ë¥¸ íë¦„:
// 1. tenant ì„ íƒ â†’ ì„œë²„/Edge Functionì—ì„œ JWT ì¬ë°œê¸‰ (claimì— tenant_id í¬í•¨)
// 2. ì„¸ì…˜ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ JWT ë°›ê¸°
// 3. RLS ì •ì±…ì—ì„œ auth.jwt() ->> 'tenant_id'ë¡œ ìë™ ì½ê¸°
//
// x-tenant-id í—¤ë”ëŠ” Middlewareì—ì„œ tenant ë§¤í•‘ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ë©°,
// JWT claim ê°±ì‹ ì€ ë³„ë„ì˜ ì¸ì¦ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
```

9. Hooks Layer (React Query)

ê° Service í˜¸ì¶œì€ Hookìœ¼ë¡œ ë˜í•‘ë˜ì–´ UIì—ì„œ ì‚¬ìš©í•œë‹¤.

ì˜ˆ:

useAttendanceList
useCheckIn
useInvoices
useNotifications
useTenantSettings


Hookì€ ë‹¤ìŒ ê¸°ëŠ¥ ì œê³µ:

ë¡œë”© ìƒíƒœ

ìºì‹±

ì—ëŸ¬ í•¸ë“¤ë§

refetch ì •ì±…

10. core-ui ì„¤ê³„

10-1. ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸

DataTable, TableCardView, SplitTableLayout ë“± ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ëŠ” ê¸°ì¡´ ì„¤ê³„ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

10-2. ì§€ë„(Geo) ê¸°ë°˜ UI íŒ¨í„´ (ìƒìš©í™” ë‹¨ê³„)

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ë„ì…í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

// packages/ui-core/src/... (ì˜ˆì‹œ)
type MapMetricMode =
  | 'store-density'      // ë§¤ì¥ ìˆ˜
  | 'revenue-avg'        // í‰ê·  ë§¤ì¶œ
  | 'members-avg';       // í‰ê·  íšŒì›ìˆ˜

interface MapViewProps {
  center?: { lat: number; lng: number };
  zoom?: number;
  metricMode: MapMetricMode;
  // region ë‹¨ìœ„ íˆíŠ¸ë§µ ë°ì´í„° (âš ï¸ ì¤‘ìš”: ì •ë³¸ì€ `location_code`, `region_code`ëŠ” ë‚´ë¶€ ë§¤í•‘ìš© alias)
  regionMetrics?: Array<{
    regionCode: string;
    value: number;
  }>;
  // ë‚´ ë§¤ì¥ ìœ„ì¹˜ í‘œì‹œìš©
  myStores?: Array<{
    storeId: string;
    lat: number;
    lng: number;
  }>;
}

ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ:

Desktop: ì§€ë„ + ìš°ì¸¡ KPI ì¹´ë“œ/í…Œì´ë¸” (Split layout)

Tablet: ì§€ë„ ìƒë‹¨ / KPI í•˜ë‹¨ (vertical split)

Mobile:
- ê¸°ë³¸ì€ KPI ì¹´ë“œ ë¦¬ìŠ¤íŠ¸
- ì§€ë„ëŠ” "ì§€ë„ ë³´ê¸°" ë²„íŠ¼ìœ¼ë¡œ í’€ìŠ¤í¬ë¦° ëª¨ë‹¬ë¡œ ì „í™˜

â†’ useResponsiveMode()ì™€ í•¨ê»˜ ë ˆì´ì•„ì›ƒ íŒ¨í„´ì„ ëª…ì‹œí•©ë‹ˆë‹¤.

ì§€ë„ ë°ì´í„° ì†ŒìŠ¤:

ì§€ë„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìƒ‰ìƒ/íˆíŠ¸ë§µ ê°’ì€ analytics.daily_region_metricsì˜ ìµœê·¼ Nì¼ í‰ê·  í˜¹ì€ ì„ íƒ ê¸°ê°„ í‰ê· .

ë§¤ì¥ ìœ„ì¹˜ ë§ˆì»¤ëŠ” core_stores.latitude/longitude.

// services/analytics-service.ts
export const analyticsService = {
  async getRegionHeatmap(industryType: string, dateKst: string) {
    // âš ï¸ ì¤‘ìš”: ì •ë³¸ì€ `location_code`, `region_code`ëŠ” ë‚´ë¶€ ë§¤í•‘ìš© alias
    return supabase
      .from('analytics.daily_region_metrics')
      .select('region_level, region_code, revenue_avg, active_members_avg, store_count')
      .eq('industry_type', industryType)
      .eq('date_kst', dateKst)
      .eq('region_level', 'dong'); // or 'gu_gun', 'si', etc
  },
};
âš ï¸ ì¤‘ìš”: UI/UX ê·œì•½(ë°˜ì‘í˜•, ë‹¤í¬ëª¨ë“œ, Zoom, ì ‘ê·¼ì„± ë“±)ì˜ ì •ì‹ ì¶œì²˜ëŠ” ã€ˆUI/UX Technical Architectureã€‰ ë¬¸ì„œì…ë‹ˆë‹¤.

â†’ ìƒì„¸ ê·œì¹™ì€ UI/UX ë¬¸ì„œì˜ "6. Responsive UX â€” Enterprise Version" ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”.

ì£¼ìš” ì»´í¬ë„ŒíŠ¸ (core-ui íŒ¨í‚¤ì§€):

DataTable

TableCardView (ëª¨ë°”ì¼ ì „ìš©)

SplitTableLayout (íƒœë¸”ë¦¿ ì „ìš©)

FormField

Drawer / Modal

âš ï¸ ì¤‘ìš”: ëª¨ë‹¬ ì‚¬ìš© ê·œì¹™ (Critical)

[ë¶ˆë³€ ê·œì¹™] ëª¨ë“  ì•Œë¦¼/ê²½ê³ /í™•ì¸ ëŒ€í™”ìƒìëŠ” ì»¤ìŠ¤í…€ ëª¨ë‹¬ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

âŒ ê¸ˆì§€:
- window.alert()
- window.confirm()
- window.prompt()

âœ… í—ˆìš©:
- useModal().showAlert(message, title?, type?)
- useModal().showConfirm(message, title?)
- ì»¤ìŠ¤í…€ Modal ì»´í¬ë„ŒíŠ¸

ì´ìœ :
1. ì¼ê´€ëœ UX: ëª¨ë“  ì•Œë¦¼ì´ ë™ì¼í•œ ë””ìì¸ ì‹œìŠ¤í…œ ì‚¬ìš©
2. ì ‘ê·¼ì„±: ì»¤ìŠ¤í…€ ëª¨ë‹¬ì€ ì ‘ê·¼ì„± ê°œì„  ê°€ëŠ¥
3. ëª¨ë°”ì¼ ìµœì í™”: ëª¨ë°”ì¼ì—ì„œ ë„¤ì´í‹°ë¸Œ alertëŠ” ë¶€ìì—°ìŠ¤ëŸ¬ì›€
4. í…Œë§ˆ ì§€ì›: ë‹¤í¬ëª¨ë“œ, í…Œë„ŒíŠ¸ í…Œë§ˆ ì ìš© ê°€ëŠ¥
5. i18n ì§€ì›: ë‹¤êµ­ì–´ ë©”ì‹œì§€ ì§€ì›

ëª¨ë‹¬ vs í˜ì´ì§€ ì„ íƒ ê¸°ì¤€:
- ëª¨ë‹¬: ê°„ë‹¨í•œ ìˆ˜ì • ì‘ì—…, ëª©ë¡ì—ì„œ ë¹ ë¥¸ ì•¡ì…˜, í™•ì¸/ì•Œë¦¼ ë©”ì‹œì§€, ëª¨ë°”ì¼ í™˜ê²½
- í˜ì´ì§€: ë³µì¡í•œ ì‘ì—…, ë…ë¦½ì ì¸ ì‘ì—… íë¦„, ìƒì„¸ ì •ë³´ ì¡°íšŒ, URL ê³µìœ  í•„ìš”

â†’ ìƒì„¸ ê°€ì´ë“œë¼ì¸ì€ `docu/ì „ì²´ ìœ ì•„ì´ë¬¸ì„œ.txt`ì˜ "6-2. ëª¨ë‹¬ vs í˜ì´ì§€ ì„ íƒ ê¸°ì¤€" ì„¹ì…˜ ì°¸ì¡°

AppShellLayout

SearchBar

ActionHeader

11. ë°˜ì‘í˜• UX ì „ëµ (ìš”ì•½)

âš ï¸ ì¤‘ìš”: ë°˜ì‘í˜• UX ìƒì„¸ ê·œì¹™ì€ ã€ˆUI/UX Technical Architectureã€‰ ë¬¸ì„œì˜ "6. Responsive UX â€” Enterprise Version" ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”.

11-0. ë°˜ì‘í˜• ë¸Œë ˆì´í¬í¬ì¸íŠ¸ í‘œì¤€ (Critical)

âš ï¸ ì¤‘ìš”: ëª¨ë“  ë°˜ì‘í˜• êµ¬í˜„ì€ ë‹¤ìŒ ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ìˆ«ì ì²´ê³„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (âš ï¸ ì°¸ê³ : "Tailwind"ëŠ” ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ìˆ«ì ì²´ê³„ì˜ ê°œë…ì  ì°¸ì¡°ì´ë©°, Tailwind í´ë˜ìŠ¤ ë¬¸ìì—´ ì§ì ‘ ì‚¬ìš©ì€ ê¸ˆì§€):

ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ìˆ˜ì¹˜ (ê³ ì • ê°’):

| ë¸Œë ˆì´í¬í¬ì¸íŠ¸ | ìµœì†Œ ë„ˆë¹„ | ìš©ë„ |
|--------------|----------|------|
| xs (ê¸°ë³¸) | 0px | ëª¨ë°”ì¼ (ê¸°ë³¸) |
| sm | 640px | í° ëª¨ë°”ì¼ / ì‘ì€ íƒœë¸”ë¦¿ |
| md | 768px | íƒœë¸”ë¦¿ |
| lg | 1024px | ì‘ì€ ë°ìŠ¤í¬í†± |
| xl | 1280px | í° ë°ìŠ¤í¬í†± |

â†’ ì´ ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ìˆ˜ì¹˜ëŠ” ë””ìì¸íŒ€/í”„ë¡ íŠ¸ì—”ë“œíŒ€/ë°±ì—”ë“œíŒ€ ê°„ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ í‘œì¤€ì…ë‹ˆë‹¤.

í•µì‹¬ ì›ì¹™:

useResponsiveMode() í›… ì‚¬ìš© í•„ìˆ˜

ê¸°ê¸°ë³„ í…Œì´ë¸” ì „ëµ:
- íœ´ëŒ€í° (xs, sm): TableCardView (í–‰ â†’ ì¹´ë“œ)
- íƒœë¸”ë¦¿ (md): compact table or SplitTableLayout
- PC (lg, xl): DataTable (ê³ ì • í—¤ë” + ìˆ˜í‰ ìŠ¤í¬ë¡¤)

í„°ì¹˜ íƒ€ê¹ƒ ìµœì†Œ 44px ë³´ì¥ (í™•ëŒ€ 125% ì´ìƒ ì‹œì—ë„ ì ìš©)

ë‹¤í¬ëª¨ë“œ ë° UI í™•ëŒ€(Zoom) ì§€ì› í•„ìˆ˜

â†’ ìƒì„¸ ê·œì¹™ì€ UI/UX ë¬¸ì„œ ì°¸ì¡°

â†’ ëª¨ë°”ì¼ UX ì„±ëŠ¥ ë° ê°€ë…ì„± ë³´ì¥

11-3. íƒœë¸”ë¦¿ SplitTableLayout

ì¢Œì¸¡: í…Œì´ë¸”/ì¹´ë“œ ëª©ë¡
ìš°ì¸¡: ìƒì„¸ íŒ¨ë„(ê³ ì •, ìµœì†Œ í­ â‰¥ 360px)

í‚¤ë³´ë“œ/íœ ì…ë ¥ í¬ì»¤ìŠ¤ ìœ ì§€ ì •ì±… ëª…ì‹œ

â†’ ì•„ì´íŒ¨ë“œ/íƒœë¸”ë¦¿ UX ìµœì í™”

12. ë‹¤í¬ëª¨ë“œ
ThemeProvider ì œê³µ

light/dark í…Œë§ˆ í† í° ì‚¬ìš©

OS ì„¤ì • ìë™ ê°ì§€

ì‚¬ìš©ì override ê°€ëŠ¥

CSS ë³€ìˆ˜ ì˜ˆ (âš ï¸ Tailwind í´ë˜ìŠ¤ ë¬¸ìì—´ ì§ì ‘ ì‚¬ìš© ê¸ˆì§€):
- var(--color-background)
- var(--color-foreground)
- var(--color-border)
- var(--color-card)
- âš ï¸ ì°¸ê³ : ìœ„ëŠ” CSS ë³€ìˆ˜ ì˜ˆì‹œì´ë©°, ì‹¤ì œ Tailwind í´ë˜ìŠ¤ ë¬¸ìì—´(ì˜ˆ: `bg-background`, `text-foreground`)ì€ ë¬¸ì„œ ì˜ˆì‹œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

13. UI í™•ëŒ€(Zoom)

ZoomContextì—ì„œ í™•ëŒ€ê°’ ì œê³µ:

100%

110%

125%

150%

ëª¨ë“  ì»´í¬ë„ŒíŠ¸ëŠ” px ê°’ ì§ì ‘ ì§€ì • ê¸ˆì§€
â†’ í† í° ê¸°ë°˜ìœ¼ë¡œ ë¹„ìœ¨ ìë™ ì ìš©

í™•ëŒ€ 125% ì´ìƒ ì‹œ:

í–‰ ë†’ì´/ì•„ì´ì½˜ í„°ì¹˜ íƒ€ê¹ƒ 44px ë³´ì¥

í…ìŠ¤íŠ¸ ê°€ë…ì„± ìœ ì§€ (ìµœì†Œ í°íŠ¸ í¬ê¸° 14px)

â†’ ì ‘ê·¼ì„± ìš”êµ¬ì‚¬í•­ ì¤€ìˆ˜

ğŸ“˜ PART 3
ê²°ì œÂ·ì•Œë¦¼ë±…í‚¹ / Public Gateway / Analytics / ë°°ì¹˜(04:00 KST) / í†µê³„
14. ê²°ì œ & ì•Œë¦¼ë±…í‚¹ íë¦„
14-1. payment-alimbank ëª¨ë“ˆ

íš¨ì„±FMS ì•Œë¦¼ë±…í‚¹ê³¼ì˜ ì—°ë™ì€ ë‹¤ìŒ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” Provider ëª¨ë“ˆì—ì„œ ë‹´ë‹¹í•œë‹¤.

ê²°ì œ ìš”ì²­ Payload ìƒì„±

ì•Œë¦¼ë±…í‚¹/PG URL ë˜ëŠ” QR ì½”ë“œ ìƒì„±

ì‘ë‹µ ê²€ì¦(ì„œëª…Â·HMAC ê²€ì¦)

ìƒíƒœ ë§¤í•‘ (ì„±ê³µ/ì‹¤íŒ¨/ì·¨ì†Œ)

ë©±ë“±ì„± ë³´ì¥(Idempotency Key)

ì˜¤ë¥˜/ì§€ì—°ì— ëŒ€í•œ ì¬ì‹œë„ ì •ì±…

14-1-1. ê²°ì œ/ì•Œë¦¼ë±…í‚¹ Provider Retry Matrix (Critical)

PGì‚¬Â·íš¨ì„±FMSì˜ API ì‹¤íŒ¨/ì§€ì—°/íƒ€ì„ì•„ì›ƒì— ëŒ€í•œ í‘œì¤€ Retry ì •ì±…:

Failure Type	ì²˜ë¦¬ ë°©ì‹	ì¬ì‹œë„ íšŸìˆ˜	ë°±ì˜¤í”„ ì „ëµ
Timeout	ì¬ì‹œë„	3íšŒ	5ì´ˆ, 15ì´ˆ, 30ì´ˆ (ì§€ìˆ˜ ë°±ì˜¤í”„)
Signature mismatch	ì¦‰ì‹œ ì¤‘ë‹¨	0íšŒ	ì¬ì‹œë„ ë¶ˆê°€ (ë³´ì•ˆ ìœ„ë°˜)
PG internal error (5xx)	ì¬ì‹œë„	3íšŒ	5ì´ˆ, 30ì´ˆ, 120ì´ˆ (ì§€ìˆ˜ ë°±ì˜¤í”„)
Duplicate payment	ë©±ë“±ì„± í‚¤ë¡œ ì°¨ë‹¨	0íšŒ	ì¬ì‹œë„ ë¶ˆê°€ (ì´ë¯¸ ì²˜ë¦¬ë¨)
Network error (ECONNRESET ë“±)	ì¬ì‹œë„	3íšŒ	ì¦‰ì‹œ, 5ì´ˆ, 15ì´ˆ
Rate limit (429)	ì¬ì‹œë„	2íšŒ	60ì´ˆ, 120ì´ˆ (ê³ ì • ëŒ€ê¸°)
Invalid request (4xx, ì„œëª… ì œì™¸)	ì¦‰ì‹œ ì¤‘ë‹¨	0íšŒ	ì¬ì‹œë„ ë¶ˆê°€ (í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜)

êµ¬í˜„ ì˜ˆì‹œ:

```typescript
async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  maxRetries: number,
  backoffMs: number[]
): Promise<T> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (isNonRetryableError(error)) throw error;
      if (i < maxRetries - 1) {
        await sleep(backoffMs[i] || backoffMs[backoffMs.length - 1]);
      }
    }
  }
  throw new Error('Max retries exceeded');
}
```

êµ¬ì¡° ì˜ˆì‹œ:

// packages/payments/payment-alimbank/index.ts

export const alimbankProvider = {
  async createPaymentRequest(invoice) { ... },
  async verifyWebhookSignature(headers, rawBody) { ... },
  async mapStatus(alimbankStatus) { ... }
}

14-2. Edge Function ì—°ë™ (Server Side)
fns-payment-alimbank-request

ì—­í• 

invoice_id ê¸°ë°˜ìœ¼ë¡œ ê²°ì œ ìš”ì²­ ìƒì„±

ì•Œë¦¼ë±…í‚¹ API í˜¸ì¶œ

PG URL/QR ë°˜í™˜

ìƒíƒœ Pending ì„¤ì •

íë¦„

í´ë¼ì´ì–¸íŠ¸ì—ì„œ /pay/:invoice_id í˜¸ì¶œ

Edge Functionì—ì„œ invoice ì¡°íšŒ (tenant_id í¬í•¨)

alimbankProviderë¡œ ê²°ì œ ìš”ì²­ ìƒì„±

ìš”ì²­ ì„±ê³µ ì‹œ:

payments í…Œì´ë¸” Pending ìƒíƒœ row ìƒì„±

í´ë¼ì´ì–¸íŠ¸ë¡œ ê²°ì œ URL/QR ë°˜í™˜

fns-payment-alimbank-webhook

ì—­í• 

ì•Œë¦¼ë±…í‚¹/PGì—ì„œ ë³´ë‚´ëŠ” ê²°ì œ ê²°ê³¼ ìˆ˜ì‹ 

ì„œëª… ê²€ì¦ + ë©±ë“±ì„± ì²˜ë¦¬

payments ìƒíƒœ ì—…ë°ì´íŠ¸

invoices ìƒíƒœ ì—…ë°ì´íŠ¸

core-notification íŠ¸ë¦¬ê±°

analytics ì§‘ê³„ìš© ì´ë²¤íŠ¸ ê¸°ë¡

ë³´ì•ˆ/ë©±ë“±ì„± ì¡°ê±´

x-signature, x-timestamp, idempotency-key í—¤ë” í•„ìˆ˜

íƒ€ì„ìŠ¤íƒ¬í”„ëŠ” KST ê¸°ì¤€ Â±5ë¶„ ìœˆë„ìš° ì•ˆì´ì–´ì•¼ ìœ íš¨

idempotency-key ë‹¨ìœ„ë¡œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

14-2-1. Webhook ë©±ë“±ì„± ì¸ë±ìŠ¤ ë° ì¬ì‹œë„ í‘œì¤€í™”

audit.webhook_events í…Œì´ë¸” ì •ì˜:

CREATE TABLE audit.webhook_events (
  id bigserial primary key,
  provider text not null,
  idempotency_key text not null,
  status text not null,            -- 'success','failed','retrying' ë“±
  payload jsonb,
  event_timestamp timestamptz,       -- ì›¹í›…ì—ì„œ ë°›ì€ ì›ë³¸ íƒ€ì„ìŠ¤íƒ¬í”„
  received_at timestamptz default now(),  -- ìš°ë¦¬ ì‹œìŠ¤í…œì—ì„œ ë°›ì€ ì‹œê°
  created_at timestamptz default now()
);

CREATE UNIQUE INDEX IF NOT EXISTS ux_webhook_idem
  ON audit.webhook_events(provider, idempotency_key);

CREATE INDEX idx_webhook_timestamp
  ON audit.webhook_events(provider, event_timestamp);

ì¬ì‹œë„ ë°±ì˜¤í”„ : 5s â†’ 30s â†’ 2m â†’ 10m â†’ 30m (ìµœëŒ€ 5íšŒ)

ëŒ€ì‹œë³´ë“œ ì§€í‘œ : ì‹¤íŒ¨ìœ¨ / ë©±ë“±ì¶©ëŒë¥  / ì§€ì—° P95

14-2-1-1. ê²°ì œ/ì•Œë¦¼ë±…í‚¹ ìš´ì˜ ì •ì±… (í•€í…Œí¬ ìˆ˜ì¤€ í•„ìˆ˜)

âš ï¸ ì¤‘ìš”: SaaS Billingì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ "ì‹¤ìš´ì˜ ì•ˆì •ì„±"ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ í•µì‹¬ ì •ì±…ì…ë‹ˆë‹¤.

1. Webhook Idempotency ê°•í™”:

[ë¶ˆë³€ ê·œì¹™] ëª¨ë“  webhook ì´ë²¤íŠ¸ëŠ” ë°˜ë“œì‹œ idempotency_key ê¸°ë°˜ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ì¤‘ë³µ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œì§:
```typescript
async function processWebhook(provider: string, idempotencyKey: string, event: WebhookEvent) {
  // 1. ì¤‘ë³µ ì²´í¬ (íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ)
  const existing = await db.findWebhookEvent(provider, idempotencyKey);
  if (existing && existing.status === 'success') {
    return { status: 'duplicate', event: existing }; // ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë²¤íŠ¸
  }

  // 2. ë™ì‹œ ì²˜ë¦¬ ë°©ì§€ (SELECT FOR UPDATE)
  const locked = await db.lockWebhookEvent(provider, idempotencyKey);
  if (!locked) {
    throw new Error('Event is being processed by another worker');
  }

  // 3. ì´ë²¤íŠ¸ ì²˜ë¦¬
  try {
    await processPaymentEvent(event);
    await db.updateWebhookEvent(provider, idempotencyKey, 'success');
  } catch (error) {
    await db.updateWebhookEvent(provider, idempotencyKey, 'failed');
    throw error;
  }
}
```

2. Duplicate Event ì²˜ë¦¬:

[ë¶ˆë³€ ê·œì¹™] ë™ì¼ idempotency_keyë¡œ ìˆ˜ì‹ ëœ ì´ë²¤íŠ¸ëŠ” ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ë§Œ ì²˜ë¦¬í•˜ê³ , ì´í›„ ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œí•©ë‹ˆë‹¤.

Duplicate ê°ì§€ ê¸°ì¤€:
- idempotency_key ë™ì¼
- provider ë™ì¼
- event_timestamp ì°¨ì´ Â±5ë¶„ ì´ë‚´

Duplicate ì²˜ë¦¬ ì •ì±…:
- ì²« ë²ˆì§¸ ì´ë²¤íŠ¸: ì •ìƒ ì²˜ë¦¬
- ì´í›„ ì´ë²¤íŠ¸: audit.webhook_eventsì— 'duplicate' ìƒíƒœë¡œ ê¸°ë¡, ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ

3. Settlement Mismatch Reconciliation (ì •ì‚° ë¶ˆì¼ì¹˜ ì¡°ì •):

[ë¶ˆë³€ ê·œì¹™] ê²°ì œ/ì•Œë¦¼ë±…í‚¹ webhookê³¼ ì‹¤ì œ ì •ì‚° ë°ì´í„° ê°„ ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•˜ë©´ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ìˆ˜ë™ ì¡°ì • UIë¥¼ ì œê³µí•©ë‹ˆë‹¤.

âš ï¸ ì¤‘ìš”: ì •ì‚° ë¶ˆì¼ì¹˜ ì¡°ì • ìƒì„¸ ì •ì±…ì€ ì•„ë˜ "5. íšŒê³„ì  ì •í•©ì„± ê²€ì¦" ë° "6. ìˆ˜ë™ ì¡°ì • UI ìš”êµ¬ì‚¬í•­" ì„¹ì…˜ì„ ì°¸ì¡°í•˜ì„¸ìš”.

ì •ì‚° ë¶ˆì¼ì¹˜ ê°ì§€:
```sql
-- ì¼ë³„ ì •ì‚° ë¶ˆì¼ì¹˜ ì¡°íšŒ
SELECT
  DATE(event_timestamp) as settlement_date,
  provider,
  SUM(CASE WHEN status = 'success' THEN amount ELSE 0 END) as webhook_total,
  (SELECT SUM(amount) FROM settlement_records
   WHERE provider = w.provider AND date = DATE(w.event_timestamp)) as settlement_total,
  ABS(webhook_total - settlement_total) as mismatch_amount
FROM audit.webhook_events w
WHERE event_timestamp >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE(event_timestamp), provider
HAVING ABS(webhook_total - settlement_total) > 0.01; -- 1ì› ì´ìƒ ì°¨ì´
```

ìë™ ì¡°ì • ì •ì±…:
- ë¶ˆì¼ì¹˜ ê¸ˆì•¡ < 1,000ì›: ìë™ ì¡°ì • (ë¡œê·¸ ê¸°ë¡)
- ë¶ˆì¼ì¹˜ ê¸ˆì•¡ â‰¥ 1,000ì›: ìˆ˜ë™ ì¡°ì • UIì—ì„œ ìŠ¹ì¸ í•„ìš”

4. ê²°ì œ ì‹¤íŒ¨ ìë™ ì¬ì‹œë„:

[ë¶ˆë³€ ê·œì¹™] ê²°ì œ ì‹¤íŒ¨ ì‹œ ì§€ìˆ˜ ë°±ì˜¤í”„ íŒ¨í„´ìœ¼ë¡œ ìë™ ì¬ì‹œë„í•˜ë©°, ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ì™€ ì¬ì‹œë„ ê°„ê²©ì„ ëª…í™•íˆ ì •ì˜í•©ë‹ˆë‹¤.

ì¬ì‹œë„ ì •ì±…:
- ì¬ì‹œë„ íšŸìˆ˜: ìµœëŒ€ 5íšŒ
- ì¬ì‹œë„ ê°„ê²©: 5s â†’ 30s â†’ 2m â†’ 10m â†’ 30m
- ì¬ì‹œë„ ì¡°ê±´: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, íƒ€ì„ì•„ì›ƒ, ì¼ì‹œì  ì„œë²„ ì˜¤ë¥˜ë§Œ ì¬ì‹œë„
- ì¬ì‹œë„ ì œì™¸: ì¸ì¦ ì‹¤íŒ¨, ì”ì•¡ ë¶€ì¡±, ì¹´ë“œ ì •ì§€ ë“± ì˜êµ¬ì  ì˜¤ë¥˜ëŠ” ì¦‰ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬

ì¬ì‹œë„ ë¡œì§:
```typescript
async function retryPayment(paymentId: string, attempt: number = 1) {
  const maxAttempts = 5;
  const backoff = [5000, 30000, 120000, 600000, 1800000]; // ms

  try {
    const result = await processPayment(paymentId);
    return result;
  } catch (error) {
    if (isRetryableError(error) && attempt < maxAttempts) {
      await sleep(backoff[attempt - 1]);
      return retryPayment(paymentId, attempt + 1);
    }
    throw error;
  }
}
```

5. íšŒê³„ì  ì •í•©ì„± ê²€ì¦ (ì •ì‚° ë¶ˆì¼ì¹˜ ì¡°ì • ì •ì±… í†µí•©):

[ë¶ˆë³€ ê·œì¹™] ëª¨ë“  ê²°ì œ/ìˆ˜ë‚©/í™˜ë¶ˆ ê±°ë˜ëŠ” íšŒê³„ì  ì •í•©ì„±ì„ ê²€ì¦í•˜ë©°, ë¶ˆì¼ì¹˜ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.

ì •í•©ì„± ê²€ì¦ í•­ëª©:
- ì…ê¸ˆì•¡ = ì¶œê¸ˆì•¡ (ê±°ë˜ ì´í•©)
- ë¯¸ì •ì‚° ê¸ˆì•¡ = ì •ì‚° ì˜ˆì • ê¸ˆì•¡
- í™˜ë¶ˆ ê¸ˆì•¡ â‰¤ ì›ê±°ë˜ ê¸ˆì•¡
- ì¤‘ë³µ ê²°ì œ ì—†ìŒ

ê²€ì¦ ì£¼ê¸°:
- ì‹¤ì‹œê°„ ê²€ì¦: ëª¨ë“  ê±°ë˜ ì²˜ë¦¬ ì‹œ
- ì¼ë³„ ê²€ì¦: ë§¤ì¼ 04:00 KST
- ì›”ë³„ ê²€ì¦: ë§¤ì›” 1ì¼ 04:00 KST

ì •ì‚° ë¶ˆì¼ì¹˜ ê°ì§€ ë° ì¡°ì •:
- ìœ„ "3. Settlement Mismatch Reconciliation" ì„¹ì…˜ ì°¸ì¡°

6. ìˆ˜ë™ ì¡°ì • UI ìš”êµ¬ì‚¬í•­:

[ë¶ˆë³€ ê·œì¹™] ìš´ì˜íŒ€ì´ ê²°ì œ/ì •ì‚° ë¶ˆì¼ì¹˜ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆëŠ” UIë¥¼ ì œê³µí•©ë‹ˆë‹¤.

ìˆ˜ë™ ì¡°ì • UI ê¸°ëŠ¥:
- ì •ì‚° ë¶ˆì¼ì¹˜ ëª©ë¡ ì¡°íšŒ (ë‚ ì§œë³„, ì—…ì²´ë³„ í•„í„°)
- ë¶ˆì¼ì¹˜ ìƒì„¸ ë‚´ì—­ í™•ì¸ (webhook ì´ë²¤íŠ¸ vs ì •ì‚° ë°ì´í„° ë¹„êµ)
- ìˆ˜ë™ ì¡°ì • ìŠ¹ì¸/ê±°ë¶€ (ìŠ¹ì¸ ì‹œ audit.eventsì— ê¸°ë¡)
- ì¡°ì • ì´ë ¥ ì¡°íšŒ (ëˆ„ê°€, ì–¸ì œ, ë¬´ì—‡ì„ ì¡°ì •í–ˆëŠ”ì§€)

ìˆ˜ë™ ì¡°ì • ê¶Œí•œ:
- Super Adminë§Œ ìˆ˜ë™ ì¡°ì • ê°€ëŠ¥
- ëª¨ë“  ì¡°ì • ì‘ì—…ì€ audit.eventsì— ê¸°ë¡
- ì¡°ì • ì „í›„ ê¸ˆì•¡ ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„±

7. ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§:

[ë¶ˆë³€ ê·œì¹™] ê²°ì œ/ì•Œë¦¼ë±…í‚¹ ì‹œìŠ¤í…œì˜ ì‹¤ì‹œê°„ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³ , ì´ìƒ ì§•í›„ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.

ëª¨ë‹ˆí„°ë§ ì§€í‘œ:
- Webhook ìˆ˜ì‹  ì§€ì—°ë¥  (P95, P99)
- Webhook ì‹¤íŒ¨ìœ¨ (5ë¶„ ì´ë™í‰ê· )
- ì •ì‚° ë¶ˆì¼ì¹˜ ê±´ìˆ˜ (ì¼ë³„)
- ì¬ì‹œë„ìœ¨ (ì „ì²´ ìš”ì²­ ëŒ€ë¹„)
- ì¤‘ë³µ ì´ë²¤íŠ¸ìœ¨

ì•Œë¦¼ ì„ê³„ê°’:
- Webhook ì‹¤íŒ¨ìœ¨ > 5%: ì¦‰ì‹œ ì•Œë¦¼
- ì •ì‚° ë¶ˆì¼ì¹˜ ê¸ˆì•¡ > 10,000ì›: ì¦‰ì‹œ ì•Œë¦¼
- ì¬ì‹œë„ìœ¨ > 20%: ê²½ê³  ì•Œë¦¼
- ì¤‘ë³µ ì´ë²¤íŠ¸ìœ¨ > 1%: ê²½ê³  ì•Œë¦¼

8. ë¶€ë¶„ ì‹¤íŒ¨ ë³´ì • ë¡œì§:

[ë¶ˆë³€ ê·œì¹™] ê²°ì œ/ì•Œë¦¼ë±…í‚¹ ì²˜ë¦¬ ì¤‘ ì¼ë¶€ ë‹¨ê³„ë§Œ ì‹¤íŒ¨í•œ ê²½ìš°, ì™„ë£Œëœ ë‹¨ê³„ëŠ” ë¡¤ë°±í•˜ì§€ ì•Šê³  ë¶€ë¶„ ì„±ê³µ ìƒíƒœë¡œ ê¸°ë¡í•˜ë©°, ì‹¤íŒ¨í•œ ë‹¨ê³„ë§Œ ì¬ì‹œë„í•©ë‹ˆë‹¤.

ë¶€ë¶„ ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤:
- Webhook ìˆ˜ì‹  ì„±ê³µ â†’ DB ì €ì¥ ì‹¤íŒ¨: Webhookì€ ì¬ìˆ˜ì‹  ë¶ˆê°€í•˜ë¯€ë¡œ DB ì €ì¥ë§Œ ì¬ì‹œë„
- ê²°ì œ ì²˜ë¦¬ ì„±ê³µ â†’ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ê²°ì œëŠ” ìœ ì§€í•˜ê³  ì•Œë¦¼ë§Œ ì¬ì‹œë„
- ì •ì‚° ê¸°ë¡ ì„±ê³µ â†’ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ì •ì‚°ì€ ìœ ì§€í•˜ê³  ë¦¬í¬íŠ¸ë§Œ ì¬ì‹œë„

ë¶€ë¶„ ì‹¤íŒ¨ ì²˜ë¦¬ ë¡œì§:
```typescript
async function processPaymentWithPartialFailure(paymentId: string) {
  const steps = [
    { name: 'webhook_received', fn: () => saveWebhookEvent(paymentId) },
    { name: 'payment_processed', fn: () => processPayment(paymentId) },
    { name: 'notification_sent', fn: () => sendNotification(paymentId) },
    { name: 'settlement_recorded', fn: () => recordSettlement(paymentId) },
  ];

  const completedSteps = [];
  const failedSteps = [];

  for (const step of steps) {
    try {
      await step.fn();
      completedSteps.push(step.name);
    } catch (error) {
      failedSteps.push({ step: step.name, error });
      // ë¶€ë¶„ ì‹¤íŒ¨ ìƒíƒœë¡œ ê¸°ë¡
      await recordPartialFailure(paymentId, completedSteps, failedSteps);
      break; // ì‹¤íŒ¨í•œ ë‹¨ê³„ì—ì„œ ì¤‘ë‹¨
    }
  }

  // ì‹¤íŒ¨í•œ ë‹¨ê³„ë§Œ ì¬ì‹œë„
  if (failedSteps.length > 0) {
    await retryFailedSteps(paymentId, failedSteps);
  }
}
```

9. ê²°ì œ ì·¨ì†Œ / ì¬ìš”ì²­ ì •ì±…:

[ë¶ˆë³€ ê·œì¹™] ê²°ì œ ì·¨ì†ŒëŠ” ì›ê±°ë˜ì™€ ì—°ê²°í•˜ì—¬ ì²˜ë¦¬í•˜ë©°, ì¬ìš”ì²­ì€ ë©±ë“±ì„± í‚¤ë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ê²°ì œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

ê²°ì œ ì·¨ì†Œ ì •ì±…:
- ì·¨ì†Œ ê°€ëŠ¥ ê¸°ê°„: ê²°ì œ ì™„ë£Œ í›„ 7ì¼ ì´ë‚´ (ì—…ì²´ë³„ ì •ì±…ì— ë”°ë¼ ì¡°ì •)
- ì·¨ì†Œ ì²˜ë¦¬: ì›ê±°ë˜ì™€ ì—°ê²°í•˜ì—¬ í™˜ë¶ˆ ì²˜ë¦¬, audit.eventsì— ì·¨ì†Œ ì‚¬ìœ  ê¸°ë¡
- ë¶€ë¶„ ì·¨ì†Œ: ì§€ì›í•˜ì§€ ì•ŠìŒ (ì „ì•¡ ì·¨ì†Œë§Œ ê°€ëŠ¥)

ê²°ì œ ì¬ìš”ì²­ ì •ì±…:
- ì¬ìš”ì²­ ì‹œ ë™ì¼ idempotency_key ì‚¬ìš©: ì¤‘ë³µ ê²°ì œ ë°©ì§€
- ì¬ìš”ì²­ ê°€ëŠ¥ íšŸìˆ˜: ìµœëŒ€ 3íšŒ
- ì¬ìš”ì²­ ê°„ê²©: ìµœì†Œ 1ë¶„ (ìŠ¤íŒ¸ ë°©ì§€)

ì¬ìš”ì²­ ë¡œì§:
```typescript
async function retryPaymentRequest(paymentId: string, reason: string) {
  const originalPayment = await getPayment(paymentId);

  // ë™ì¼ idempotency_keyë¡œ ì¬ìš”ì²­
  const retryPayment = await createPayment({
    ...originalPayment,
    idempotency_key: originalPayment.idempotency_key, // ì¬ì‚¬ìš©
    retry_count: originalPayment.retry_count + 1,
    retry_reason: reason,
  });

  if (retryPayment.retry_count > 3) {
    throw new Error('Maximum retry count exceeded');
  }

  return retryPayment;
}
```

10. ì•Œë¦¼ë±…í‚¹ ì¥ì•  ëŒ€ë¹„ Fallback ì²˜ë¦¬:

[ë¶ˆë³€ ê·œì¹™] ì•Œë¦¼ë±…í‚¹ ì„œë¹„ìŠ¤ ì¥ì•  ì‹œ ìë™ìœ¼ë¡œ ëŒ€ì²´ ì±„ë„(SMS)ë¡œ ì „í™˜í•˜ê±°ë‚˜, ì¥ì•  ë³µêµ¬ í›„ ì¬ì‹œë„ íì— ì¶”ê°€í•©ë‹ˆë‹¤.

Fallback ì „ëµ:
- 1ì°¨: ì•Œë¦¼ë±…í‚¹ API í˜¸ì¶œ
- 2ì°¨ (ì¥ì•  ì‹œ): SMS ë°œì†¡ (core-notification ëª¨ë“ˆ)
- ìµœì¢… (ëª¨ë“  ì±„ë„ ì‹¤íŒ¨): ì¬ì‹œë„ íì— ì¶”ê°€ (ìµœëŒ€ 24ì‹œê°„ ë³´ê´€)

Fallback ì²˜ë¦¬ ë¡œì§:
```typescript
async function sendNotificationWithFallback(userId: string, message: string) {
  const channels = [
    { name: 'alimbank', fn: () => sendAlimbankNotification(userId, message) },
    { name: 'sms', fn: () => sendSMS(userId, message) },
  ];

  for (const channel of channels) {
    try {
      await channel.fn();
      await recordNotificationSuccess(userId, channel.name);
      return { success: true, channel: channel.name };
    } catch (error) {
      await recordNotificationFailure(userId, channel.name, error);
      // ë‹¤ìŒ ì±„ë„ë¡œ Fallback
      continue;
    }
  }

  // ëª¨ë“  ì±„ë„ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íì— ì¶”ê°€
  await addToRetryQueue(userId, message, { maxRetries: 5, ttl: 24 * 60 * 60 * 1000 });
  return { success: false, queued: true };
}
```

ì¥ì•  ê°ì§€ ê¸°ì¤€:
- ì•Œë¦¼ë±…í‚¹ API ì‘ë‹µ ì‹œê°„ > 5ì´ˆ: ì¥ì• ë¡œ ê°„ì£¼
- ì•Œë¦¼ë±…í‚¹ API ì—ëŸ¬ìœ¨ > 10% (5ë¶„ ì´ë™í‰ê· ): ì¥ì• ë¡œ ê°„ì£¼
- ì•Œë¦¼ë±…í‚¹ API 5xx ì—ëŸ¬: ì¦‰ì‹œ Fallback

ì¥ì•  ë³µêµ¬ ê°ì§€:
- ì•Œë¦¼ë±…í‚¹ API ì •ìƒ ì‘ë‹µ 3íšŒ ì—°ì†: ì¥ì•  ë³µêµ¬ë¡œ ê°„ì£¼
- Fallback ëª¨ë“œ í•´ì œ í›„ ì¬ì‹œë„ í ì²˜ë¦¬ ì‹œì‘

14-2-2. Webhook ì´ë²¤íŠ¸ ìˆœì„œ ë³´ì¥ (ìƒìš©í™” ë‹¨ê³„ ì„ íƒì )

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì€ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ì„ íƒì ìœ¼ë¡œ ë„ì…í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ë©±ë“±ì„± ì²˜ë¦¬ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë©°, ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ ê²½ìš°ì—ë§Œ ìˆœì„œ ë³´ì¥ì„ ë„ì…í•©ë‹ˆë‹¤.

í•€í…Œí¬ í”„ë¡œì íŠ¸ì—ì„œëŠ” Idempotency + Ordering Guarantee(ìˆœì„œ ë³´ì¥) ëª¨ë‘ í•„ìš”í•˜ì§€ë§Œ, "í•™ì›ê´€ë¦¬ SaaSì—ì„œ ì•Œë¦¼ë±…í‚¹ë§Œ ì§€ì›"í•˜ëŠ” ê²½ìš° ë©±ë“±ì„± + ì„œëª… ê²€ì¦ë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.

Ordering Guaranteeê°€ í•„ìš”í•œ ê²½ìš° (ìƒìš©í™” ë‹¨ê³„):

ë¬¸ì œ: retry ë•Œë¬¸ì— success â†’ pending ê°™ì€ ìˆœì„œë¡œ ë„ì°©í•  ìˆ˜ ìˆìŒ

í•´ê²°ì±…:

ìƒíƒœ ì „ì´ ê·œì¹™ ì •ì˜(State transition machine):

pending â†’ success (í—ˆìš©)

success â†’ pending (ê±°ë¶€, late event drop)

success â†’ cancelled (í—ˆìš©)

cancelled â†’ success (ê±°ë¶€, late event drop)

timestamp ë¹„êµ:

event_timestampê°€ ê¸°ì¡´ ìƒíƒœì˜ event_timestampë³´ë‹¤ ì´ì „ì´ë©´ late eventë¡œ ê°„ì£¼í•˜ì—¬ ë¬´ì‹œ

late event drop ë¡œì§:

```typescript
async function processWebhook(provider: string, idempotencyKey: string, event: WebhookEvent) {
  const existing = await db.findWebhookEvent(provider, idempotencyKey);

  if (existing) {
    // ìˆœì„œ ë³´ì¥ ê²€ì¦ (ìƒìš©í™” ë‹¨ê³„ ì„ íƒì )
    if (event.timestamp < existing.event_timestamp) {
      // late event, ë¬´ì‹œ
      return { status: 'ignored', reason: 'late_event' };
    }

    // ìƒíƒœ ì „ì´ ê·œì¹™ ê²€ì¦
    if (!isValidTransition(existing.status, event.status)) {
      return { status: 'rejected', reason: 'invalid_transition' };
    }
  }

  // ì²˜ë¦¬ ì§„í–‰...
}
```

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ë©±ë“±ì„± ì²˜ë¦¬ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë©°, Ordering GuaranteeëŠ” ì‹¤ì œ í•„ìš”ì„±ì´ í™•ì¸ëœ í›„ ë„ì…í•©ë‹ˆë‹¤.

14-3. Public Gateway UX

apps/public-gateway/ëŠ” ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•œ ê³µê°œ í˜ì´ì§€ ì§‘í•©ì´ë‹¤.

ì£¼ìš” ì‹œë‚˜ë¦¬ì˜¤

ì²­êµ¬ì„œ ì¡°íšŒ(ë§í¬/QR)

ê²°ì œ ì§„í–‰

ê²°ì œ ê²°ê³¼ ì•ˆë‚´

í‚¤ì˜¤ìŠ¤í¬/ë°ìŠ¤í¬ìš© ì¶œê²° í™”ë©´ (ìˆ«ìíŒ¨ë“œ, QRì²´í¬ ë“±)

ë³´ì•ˆ ì›ì¹™

Public Gateway ë³´ì•ˆ ì •ì±…ì€ 14-3-1 (Verification Gateway Pattern) ë° 19-8 (Public Gateway/í‚¤ì˜¤ìŠ¤í¬ ë³´ì•ˆ) ì„¹ì…˜ì„ ì°¸ì¡°í•œë‹¤.

invoice_idë¥¼ URLì— ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•Šê³  ì„œëª… í† í° ê¸°ë°˜ìœ¼ë¡œ ì‹ë³„

signed token ê¸°ë°˜ invoice ì ‘ê·¼ (Critical)

Public Gateway ì ‘ê·¼ ì‹œ ë‹¤ìŒì„ ë°˜ë“œì‹œ ì¶”ê°€:

1) Signed token ê¸°ë°˜ invoice ì ‘ê·¼

ì˜ˆì‹œ: /invoice/:signed_token (ì¹œêµ¬ì—ê²Œ ë§í¬ ê³µìœ í•´ë„ ìœ ì¶œ ë¶ˆê°€)

í† í° ìŠ¤í™ (JWT/HMAC):

ì•Œê³ ë¦¬ì¦˜: HMAC-SHA256

ë§Œë£Œ ì‹œê°„: 10ë¶„ (KST ê¸°ì¤€)

í´ë ˆì„ êµ¬ì¡°:

{
  "iss": "dearsaas",
  "aud": "public-gateway",
  "sub": "invoice:<uuid>",
  "tenant_id": "<uuid>",
  "scope": ["invoice.read","payment.create"],
  "exp": <unix_KST_plus_600s>,
  "jti": "<random-uuid>"
}

í† í° ìƒì„±: HMAC-SHA256(invoice_id + tenant_id + timestamp, secret_key)

í† í° ê²€ì¦: Edge Functionì—ì„œ ì„œëª… ê²€ì¦ í›„ invoice_id ì¶”ì¶œ

ì‹œê³„ ë“œë¦¬í”„íŠ¸ í—ˆìš©: Â±120s

2) URL ë§Œë£Œ ì •ì±…

ìƒìš©í™” ë‹¨ê³„: ë§Œë£Œ ì‹œê°„ 10ë¶„ìœ¼ë¡œ ì§§ê²Œ ì„¤ì •í•˜ì—¬ ì¬ì‚¬ìš© ë°©ì§€ (ë§Œë£Œ ì‹œê°„ìœ¼ë¡œ í˜„ì‹¤ì ìœ¼ë¡œ ì»¤ë²„)

ìƒìš©í™” ë‹¨ê³„: Edge KV / audit.public_tokens ê¸°ë°˜ ì¬ì‚¬ìš© ë°©ì§€ ë° rate-limit ë„ì…

â†’ Edge KV / audit.public_tokens ê¸°ë°˜ ì¬ì‚¬ìš© ë°©ì§€ì™€ rate-limitëŠ” ìƒìš©í™” ë‹¨ê³„ì—ì„œ ë„ì… ê°€ëŠ¥í•©ë‹ˆë‹¤. ë§Œë£Œì‹œê°„ ì§§ì€ signed tokenë§Œìœ¼ë¡œë„ ë¦¬ìŠ¤í¬ë¥¼ ìˆ˜ìš©í•©ë‹ˆë‹¤.

14-3-2. Public Gateway Token íšŒìˆ˜ ì •ì±… (Critical, ìƒìš©í™” ë‹¨ê³„ ê³ ë„í™”)

âš ï¸ ì¤‘ìš”: ì´ ì„¹ì…˜ì˜ ê³ ê¸‰ ê¸°ëŠ¥ì€ ìƒìš©í™” ë‹¨ê³„ì—ì„œ ë„ì…í•©ë‹ˆë‹¤.

ìƒìš©í™” ë‹¨ê³„: ë§Œë£Œ ì‹œê°„ 10ë¶„ìœ¼ë¡œ ì§§ê²Œ ì„¤ì •í•˜ì—¬ ì¬ì‚¬ìš© ë°©ì§€ (ë§Œë£Œ ì‹œê°„ìœ¼ë¡œ í˜„ì‹¤ì ìœ¼ë¡œ ì»¤ë²„)

ìƒìš©í™” ë‹¨ê³„: Used Tokenì˜ ì¦‰ì‹œ íê¸°

ì‚¬ìš©ëœ í† í°ì€ DB ë˜ëŠ” KVì— ì¦‰ì‹œ ê¸°ë¡í•˜ì—¬ ì¬ì‚¬ìš© ì°¨ë‹¨

ì ì¬ ì¤‘ë³µ ê³µê²© íŒ¨í„´ ë¶„ì„:

ê°™ì€ jtië¡œ ì§§ì€ ì‹œê°„ ë‚´ ë‹¤ìˆ˜ ìš”ì²­ ì‹œ ì°¨ë‹¨

ê°™ì€ invoice_idì— ëŒ€í•œ í† í° ì¬ì‚¬ìš© ì‹œë„ ê°ì§€

ë‹¨ì¼ invoice ì¡°íšŒ ì‹œ rate-limit í•„ìš”:

ê°™ì€ invoice_idì— ëŒ€í•œ ì¡°íšŒëŠ” 1ë¶„ë‹¹ ìµœëŒ€ 10íšŒ ì œí•œ

IP ê¸°ë°˜ rate-limit: 1ë¶„ë‹¹ ìµœëŒ€ 30íšŒ

â†’ ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” ì„œëª… ê²€ì¦ + exp(ë§Œë£Œ) + jtië§Œ ì ìš©í•˜ê³ , ì¬ì‚¬ìš© ë°©ì§€ëŠ” ì§§ì€ ë§Œë£Œ ì‹œê°„(10ë¶„)ìœ¼ë¡œ í˜„ì‹¤ì ìœ¼ë¡œ ì»¤ë²„í•©ë‹ˆë‹¤.

êµ¬í˜„ ì˜ˆì‹œ:

```typescript
async function verifyPublicToken(token: string, invoiceId: string) {
  // 1. í† í° ê²€ì¦
  const payload = await verifyToken(token);

  // 2. ì‚¬ìš© ì—¬ë¶€ í™•ì¸
  const used = await kv.get(`token:${payload.jti}`);
  if (used) {
    throw new Error('Token already used');
  }

  // 3. Rate limit í™•ì¸
  const rateLimitKey = `rate:invoice:${invoiceId}`;
  const count = await kv.incr(rateLimitKey);
  if (count === 1) {
    await kv.expire(rateLimitKey, 60); // 1ë¶„ TTL
  }
  if (count > 10) {
    throw new Error('Rate limit exceeded');
  }

  // 4. í† í° ì‚¬ìš© ê¸°ë¡
  await kv.set(`token:${payload.jti}`, 'used', { ex: 600 });

  return payload;
}
```

ì €ì¥ì†Œ ì •ì±… (í‘œì¤€):

ê¸°ë³¸ ì €ì¥ì†Œ: Edge KV (Redis ê¸°ë°˜) - ë¹ ë¥¸ ì¡°íšŒ, TTL ìë™ ê´€ë¦¬ (ê¶Œì¥)

ì„ íƒ ì €ì¥ì†Œ: audit.public_tokens í…Œì´ë¸” - ì˜êµ¬ ê¸°ë¡, ê°ì‚¬ ì¶”ì  í•„ìš” ì‹œì—ë§Œ ì‚¬ìš©

â†’ ê¸°ë³¸ì€ Edge KVë¡œ í†µì¼í•˜ê³ , audit í…Œì´ë¸”ì€ "ì„ íƒì  + ê°ì‚¬ìš©"ìœ¼ë¡œ ì‚¬ìš©

audit.public_tokens í…Œì´ë¸” ì •ì˜ (ì˜µì…˜ 2 ì‚¬ìš© ì‹œ):

CREATE TABLE audit.public_tokens (
  id bigserial primary key,
  token_jti text not null,           -- JWT jti ë˜ëŠ” í† í° í•´ì‹œ
  tenant_id uuid,
  resource_type text,                  -- 'invoice', 'kiosk', 'qr' ë“±
  resource_id text,
  used_at timestamptz,
  created_at timestamptz default now(),
  expires_at timestamptz
);

CREATE UNIQUE INDEX IF NOT EXISTS ux_public_tokens_jti
  ON audit.public_tokens(token_jti);

CREATE INDEX IF NOT EXISTS idx_public_tokens_expires
  ON audit.public_tokens(expires_at);

ì˜µì…˜ 3: JWT jti ê¸°ë°˜ revoke ë¦¬ìŠ¤íŠ¸ - JWT ì‚¬ìš© ì‹œ

14-3-1. Verification Gateway Pattern (Critical)

ëª¨ë“  Public Gateway ìš”ì²­ì€ fns-public-gateway-verifyë¥¼ í†µí•´ ì„œëª… ê²€ì¦ í›„ ë‚´ë¶€ APIë¡œ ì „ë‹¬í•˜ëŠ” ë‹¨ì¼ ì§„ì…ì  êµ¬ì¡°(Verification Gateway Pattern)ë¥¼ ì‚¬ìš©í•œë‹¤.

êµ¬ì¡°:

/invoice/:token â†’ fns-public-gateway-verify â†’ ê²€ì¦ ì„±ê³µ ì‹œ invoice_id ë°˜í™˜ â†’ ë‚´ë¶€ API í˜¸ì¶œ

/kiosk/:token â†’ fns-public-gateway-verify â†’ ê²€ì¦ ì„±ê³µ ì‹œ tenant_id ë°˜í™˜ â†’ ë‚´ë¶€ API í˜¸ì¶œ

/qr/:token â†’ fns-public-gateway-verify â†’ ê²€ì¦ ì„±ê³µ ì‹œ resource_id ë°˜í™˜ â†’ ë‚´ë¶€ API í˜¸ì¶œ


ì¥ì :

ê° í˜ì´ì§€ë§ˆë‹¤ ê°œë³„ ê²€ì¦ ë¡œì§ì„ ë„£ì„ í•„ìš” ì—†ìŒ (ì‹¤ìˆ˜ ë°œìƒ í™•ë¥  ê°ì†Œ)

ë³´ì•ˆì˜ "ìµœì¢… ê´€ë¬¸"ì´ ë‹¨ì¼ ì§€ì ì— ì§‘ì¤‘

í”„ë¡ì‹œ íŒ¨í„´ìœ¼ë¡œ ë³´ì•ˆ ì‚¬ê³  ê°€ëŠ¥ì„± í¬ê²Œ ê°ì†Œ

ì£¼ì˜ì‚¬í•­:

Verification GatewayëŠ” Public Gatewayì˜ ë‹¨ì¼ ì§„ì…ì ì´ë¯€ë¡œ, ì¥ì•  ì‹œ ì „ì²´ Public UXì— ì˜í–¥ì´ ê°ˆ ìˆ˜ ìˆë‹¤.

ì™„í™” ì „ëµ:

ë‹¤ì¤‘ ë°°í¬/í—¬ìŠ¤ì²´í¬/ìë™ ë¡¤ë°± ì „ëµ í•„ìˆ˜ ì ìš©

ì½ê¸° ì „ìš© í˜ì´ì§€ëŠ” CDNìœ¼ë¡œ ë°”ë¡œ ì œê³µí•˜ê³ , í† í° ê²€ì¦ì´ í•„ìš”í•œ ì—”ë“œí¬ì¸íŠ¸ë§Œ ì´ Gatewayë¥¼ ê±°ì¹˜ë„ë¡ êµ¬ë¶„

RLS ìš°íšŒ ê¶Œí•œ:

Verification GatewayëŠ” Public Gatewayì˜ ë‹¨ì¼ ì§„ì…ì ì´ë¯€ë¡œ, í† í° ê²€ì¦ í›„ ë‚´ë¶€ API í˜¸ì¶œ ì‹œ ì ì ˆí•œ DB Roleì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ public_gateway_role ë˜ëŠ” verification_roleì„ ì‚¬ìš©í•˜ë©°, í•´ë‹¹ Roleì€ í•„ìš”í•œ í…Œì´ë¸”(invoices, payments ë“±)ì— ëŒ€í•œ ìµœì†Œ ê¶Œí•œë§Œ ë¶€ì—¬í•œë‹¤.

â†’ Public Gateway íŠ¹ì„±ìƒ ê±°ì˜ í•„ìˆ˜ì  ì•„í‚¤í…ì²˜ íŒ¨í„´ì´ì§€ë§Œ, ë‹¨ì¼ ì¥ì• ì (SPOF) ì™„í™” ì „ëµ í•„ìˆ˜

CSRF ë°©ì–´ (POST ìš”ì²­ ì‹œ í† í°)

Clickjacking ë°©ì§€(X-Frame-Options, CSP)

Referrer ìµœì†Œí™”(Referrer-Policy: no-referrer)

ì‹œê°„ í‘œì‹œ ì •ì±…:

ìƒì„¸ KST í‘œì¤€ì€ PART 5ì˜ '19-1. íƒ€ì„ì¡´(KST) í‘œì¤€' ì„¹ì…˜ ê·œì¹™ì„ ë”°ë¥¸ë‹¤.

ì²­êµ¬ì¼, ë‚©ë¶€ê¸°í•œ, ê²°ì œì‹œê°„ ë“± Public Gatewayì— ë…¸ì¶œë˜ëŠ” ì‹œê°„ì€ ëª¨ë‘ KST ê¸°ì¤€ìœ¼ë¡œ í‘œê¸°í•œë‹¤.

â†’ ê²°ì œ/ì²­êµ¬ ì‹œìŠ¤í…œì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ë³´ì•ˆ ìš”ì†Œ

14-4. í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ (íƒœë¸”ë¦¿/ëª¨ë°”ì¼)

UIëŠ” core-uiì˜ KioskLayout ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©

ê¸°ëŠ¥ ì˜ˆ:

ë²ˆí˜¸ ì…ë ¥ í›„ ì¶œê²° ì²´í¬

QR/ë°”ì½”ë“œ ìŠ¤ìº” (ë¸Œë¼ìš°ì € ì¹´ë©”ë¼ API)

ê²°ì œìš© QR ë…¸ì¶œ

ìë™ ë¡œê·¸ì•„ì›ƒ/ì„¸ì…˜ ë§Œë£Œ íƒ€ì´ë¨¸ (ì˜ˆ: 10ë¶„ ë¬´ì…ë ¥ ì‹œ ìë™ ì ê¸ˆ, KST ê¸°ì¤€ ì„¸ì…˜ ê´€ë¦¬)

15. Analytics & í†µê³„

15-0. Analytics UI êµ¬ì„± ê·œì•½ (Critical)

âš ï¸ ì¤‘ìš”: Analytics UI êµ¬ì„± ê·œì•½ì€ ë””ìì¸íŒ€/í”„ë¡ íŠ¸ì—”ë“œíŒ€ ê°„ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ í‘œì¤€ì…ë‹ˆë‹¤.

15-0-1. ì°¨íŠ¸ í‘œì¤€

ë„ë„› ì°¨íŠ¸ (Donut Chart):
- ìš©ë„: ë¹„ìœ¨ í‘œì‹œ (ì˜ˆ: ê²°ì œ ìˆ˜ë‹¨ ë¹„ìœ¨, ì—…ì¢…ë³„ ë¶„í¬)
- ìƒ‰ìƒ: Theme Tokenì˜ `colors.chart.*` ì‚¬ìš©
- ìµœì†Œ ì„¹ì…˜ í¬ê¸°: 3% (3% ë¯¸ë§Œì€ "ê¸°íƒ€"ë¡œ í†µí•©)
- í˜¸ë²„ ì‹œ íˆ´íŒ: ê°’, ë¹„ìœ¨, ë¼ë²¨ í‘œì‹œ
- ì ‘ê·¼ì„±: ARIA label í•„ìˆ˜, í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì§€ì›

ë°” ì°¨íŠ¸ (Bar Chart):
- ìš©ë„: ë¹„êµ í‘œì‹œ (ì˜ˆ: ì¼ë³„ ë§¤ì¶œ, ì§€ì—­ë³„ ë¹„êµ)
- ìƒ‰ìƒ: Theme Tokenì˜ `colors.chart.*` ì‚¬ìš©
- ì¶• ë ˆì´ë¸”: ìµœëŒ€ 10ì, ì´ˆê³¼ ì‹œ ë§ì¤„ì„í‘œ
- ê·¸ë¦¬ë“œ ë¼ì¸: ì—°í•œ íšŒìƒ‰ (colors.border)
- í˜¸ë²„ ì‹œ íˆ´íŒ: ì •í™•í•œ ê°’ í‘œì‹œ

15-0-2. ìƒ‰ìƒ í† í° ê¸°ì¤€

ì°¨íŠ¸ ìƒ‰ìƒì€ Theme Tokenì˜ `colors.chart.*`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

```typescript
// packages/design-system/tokens/chart-colors.ts
export const chartColors = {
  primary: 'var(--color-chart-primary)',
  secondary: 'var(--color-chart-secondary)',
  success: 'var(--color-chart-success)',
  warning: 'var(--color-chart-warning)',
  error: 'var(--color-chart-error)',
  info: 'var(--color-chart-info)',
  // ... ì¶”ê°€ ìƒ‰ìƒ
};
```

ìƒ‰ìƒ ì‚¬ìš© ê·œì¹™:
- ì‹œë¦¬ì¦ˆê°€ 5ê°œ ì´í•˜: ê° ì‹œë¦¬ì¦ˆë§ˆë‹¤ ê³ ìœ  ìƒ‰ìƒ í• ë‹¹
- ì‹œë¦¬ì¦ˆê°€ 6ê°œ ì´ìƒ: ìƒ‰ìƒ ìˆœí™˜ ì‚¬ìš© (ë™ì¼ ìƒ‰ìƒ ì¬ì‚¬ìš©)
- ë‹¤í¬ëª¨ë“œ: ìë™ìœ¼ë¡œ ë‹¤í¬ëª¨ë“œ ìƒ‰ìƒ í† í° ì‚¬ìš©
- ì ‘ê·¼ì„±: WCAG 2.1 AA ëŒ€ë¹„ìœ¨ ì¤€ìˆ˜ (4.5:1 ì´ìƒ)

15-0-3. ì§€ë„ ì¤Œ/íŒ¨ë‹ UX

ì§€ë„ ì¤Œ ë ˆë²¨ â†” ì§€ì—­ ë ˆë²¨ ìë™ ì „í™˜:
- ì¤Œ ë ˆë²¨ 1-5: ì‹œ/ë„ ë ˆë²¨ (region_level = 'sido')
- ì¤Œ ë ˆë²¨ 6-8: ì‹œ/êµ°/êµ¬ ë ˆë²¨ (region_level = 'sigungu')
- ì¤Œ ë ˆë²¨ 9-11: ì/ë©´/ë™ ë ˆë²¨ (region_level = 'eupmyeondong')
- ì¤Œ ë ˆë²¨ 12+: ë²•ì •ë™ ë ˆë²¨ (region_level = 'beopjeongdong')

â†’ ìƒì„¸ ë§¤í•‘ ê·œì¹™ì€ "15-6-0-3. ì§€ë„ ì¤Œ ë ˆë²¨ â†” ì§€ì—­ ë ˆë²¨ ìë™ ì „í™˜" ì„¹ì…˜ ì°¸ì¡°

íŒ¨ë‹ UX:
- ë“œë˜ê·¸ë¡œ ì§€ë„ ì´ë™
- ì´ë™ ì‹œ ìë™ìœ¼ë¡œ í•´ë‹¹ ì§€ì—­ ë ˆë²¨ ë°ì´í„° ë¡œë“œ
- ë¡œë”© ì¤‘ ìŠ¤ì¼ˆë ˆí†¤ UI í‘œì‹œ
- ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

15-0-4. KPI ì¹´ë“œ ê·œê²©

KPI ì¹´ë“œ í‘œì¤€ êµ¬ì¡°:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ì•„ì´ì½˜] KPI ì´ë¦„        â”‚
â”‚                         â”‚
â”‚      ì£¼ìš” ê°’            â”‚
â”‚   (í° í°íŠ¸, ê°•ì¡°)       â”‚
â”‚                         â”‚
â”‚ ì „ì›” ëŒ€ë¹„: +10% â†‘       â”‚
â”‚ (ë˜ëŠ” ì „ë…„ ë™ì›” ëŒ€ë¹„)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

KPI ì¹´ë“œ ê·œê²©:
- ìµœì†Œ ë„ˆë¹„: 200px (ëª¨ë°”ì¼), 250px (íƒœë¸”ë¦¿), 300px (ë°ìŠ¤í¬í†±)
- ìµœëŒ€ ë„ˆë¹„: 400px
- íŒ¨ë”©: 16px (ëª¨ë°”ì¼), 20px (íƒœë¸”ë¦¿), 24px (ë°ìŠ¤í¬í†±)
- í…Œë‘ë¦¬: 1px solid colors.border
- ë°°ê²½: colors.card
- í˜¸ë²„ íš¨ê³¼: ê·¸ë¦¼ì ì¦ê°€ (elevation ì¦ê°€)

KPI ì¹´ë“œ ë ˆì´ì•„ì›ƒ:
- ê·¸ë¦¬ë“œ: ë°˜ì‘í˜• ê·¸ë¦¬ë“œ (xs: 1ì—´, sm: 2ì—´, md: 3ì—´, lg: 4ì—´, xl: 5ì—´)
- ê°„ê²©: 16px (ëª¨ë°”ì¼), 20px (íƒœë¸”ë¦¿), 24px (ë°ìŠ¤í¬í†±)

KPI ê°’ í‘œì‹œ ê·œì¹™:
- ìˆ«ì: ì²œ ë‹¨ìœ„ ì½¤ë§ˆ í‘œì‹œ (ì˜ˆ: 1,234,567)
- í†µí™”: ì›í™” ê¸°í˜¸ í‘œì‹œ (ì˜ˆ: â‚©1,234,567)
- ë¹„ìœ¨: ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ í‘œì‹œ (ì˜ˆ: 12.5%)
- ì¦ê°ë¥ : ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„ (ì¦ê°€: colors.success, ê°ì†Œ: colors.error)
- ì¦ê° ì•„ì´ì½˜: â†‘ (ì¦ê°€), â†“ (ê°ì†Œ)

15-0-5. Analytics ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ

í‘œì¤€ ë ˆì´ì•„ì›ƒ êµ¬ì¡°:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [KPI ì¹´ë“œ ê·¸ë¦¬ë“œ]                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ KPI â”‚ â”‚ KPI â”‚ â”‚ KPI â”‚ â”‚ KPI â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ì°¨íŠ¸ ì„¹ì…˜]                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   ë„ë„› ì°¨íŠ¸      â”‚ â”‚   ë°” ì°¨íŠ¸      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ì§€ë„ ì„¹ì…˜] (ì„ íƒ)                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚         ì§€ë„ ì‹œê°í™”                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [í…Œì´ë¸” ì„¹ì…˜]                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚         ë°ì´í„° í…Œì´ë¸”                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ:
- ëª¨ë°”ì¼ (xs, sm): ì„¸ë¡œ ìŠ¤íƒ (KPI â†’ ì°¨íŠ¸ â†’ ì§€ë„ â†’ í…Œì´ë¸”)
- íƒœë¸”ë¦¿ (md): 2ì—´ ê·¸ë¦¬ë“œ (KPI ê·¸ë¦¬ë“œ, ì°¨íŠ¸ 2ì—´)
- ë°ìŠ¤í¬í†± (lg, xl): 3-4ì—´ ê·¸ë¦¬ë“œ (KPI ê·¸ë¦¬ë“œ, ì°¨íŠ¸ 2-3ì—´, ì§€ë„ í’€í­)

15-0-6. ë°ì´í„° ì‹œê°í™” ìš°ì„ ìˆœìœ„

ë°ì´í„° ì‹œê°í™” ìš°ì„ ìˆœìœ„:
1. ìˆ«ì ì¹´ë“œ (KPI ì¹´ë“œ) - ê°€ì¥ ì¤‘ìš”
2. ì°¨íŠ¸ (ë„ë„›/ë°”) - ë¹„êµ/ë¹„ìœ¨ í‘œì‹œ
3. ì§€ë„ - ì§€ì—­ ë¶„í¬ ì‹œê°í™”
4. í…Œì´ë¸” - ìƒì„¸ ë°ì´í„°

â†’ ëª¨ë“  Analytics í™”ë©´ì€ ìœ„ ìš°ì„ ìˆœìœ„ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

15-1. Analytics íŒŒì´í”„ë¼ì¸ ì„¤ê³„ ì›ì¹™ (Critical)

âš ï¸ ì¤‘ìš”: Analytics LayerëŠ” ì‹¤ì‹œê°„ì„±ê³¼ ì •í™•ì„± ì‚¬ì´ì˜ íŠ¸ë ˆì´ë“œì˜¤í”„ë¥¼ ëª…í™•íˆ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

ğŸ“Œ íŒŒì´í”„ë¼ì¸ êµ¬ì¡°:

ì›ì‹œ ì´ë²¤íŠ¸ í…Œì´ë¸” (ë¡œê·¸ì„±) â€” íŒŒí‹°ì…”ë‹
â†“
ì™¸ë¶€ ëŸ°íƒ€ì„(Lambda/Cloudflare Workers) ì§‘ê³„ (ë§¤ì¼ 04:00 KST, Supabase cronì€ íŠ¸ë¦¬ê±°ë§Œ ìˆ˜í–‰)
â†“
analytics.daily_store_metrics (ë§¤ì¥ ë‹¨ìœ„ ì¼ë³„ KPI, ì •ë³¸)
- ì£¼ìš” ì»¬ëŸ¼: tenant_id, store_id, student_count, revenue, attendance_rate, new_enrollments, late_rate, absent_rate, active_student_count, inactive_student_count, avg_students_per_class, avg_capacity_rate, arpu, date_kst
analytics.daily_region_metrics (ì§€ì—­ ë‹¨ìœ„ ì§‘ê³„ KPI, ì •ë³¸)
âš ï¸ ì¤‘ìš”: analytics.daily_metrics, analytics.monthly_revenueëŠ” êµ¬ë²„ì „/íê¸°ëœ ë„¤ì´ë°ì´ë©° ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ë³¸ì€ analytics.daily_store_metrics, analytics.daily_region_metricsë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
â†“
ë·°(Materialized View)
- public.daily_store_metrics: PostgREST ë…¸ì¶œì„ ìœ„í•œ VIEW (underlying table: analytics.daily_store_metrics)
- public.daily_region_metrics: PostgREST ë…¸ì¶œì„ ìœ„í•œ VIEW (underlying table: analytics.daily_region_metrics)
- RLS ì •ì±…ì€ underlying tableì˜ RLSì— ì˜í•´ ë³´í˜¸ë¨
â†“
ëŒ€ì‹œë³´ë“œ

ğŸ“Œ ì´ë²¤íŠ¸ ìŠ¤í‚¤ë§ˆ êµ¬ì¡°:

analytics.events í…Œì´ë¸” êµ¬ì¡°:
- id: bigserial (ì „ì—­ ìœ ë‹ˆí¬)
- tenant_id: uuid (í•„ìˆ˜, RLS ê¸°ë°˜ í•„í„°ë§)
- user_id: uuid (ì„ íƒì , ì‚¬ìš©ì ì¶”ì ìš©)
- event_type: text (í•„ìˆ˜, ì—…ì¢…ë³„ ì´ë²¤íŠ¸ íƒ€ì…)
  - âš ï¸ ì°¸ê³ : analytics.events.event_typeì€ ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ event_typeê³¼ ë‹¤ë¥¸ ë„ë©”ì¸ ê°’ì…ë‹ˆë‹¤. analytics.events.event_typeì€ ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ íƒ€ì…(ì˜ˆ: 'attendance.check_in', 'payment_webhook')ì´ë©°, ìë™í™” ì¹´íƒˆë¡œê·¸ì˜ event_typeì€ ìë™í™” ì‹œë‚˜ë¦¬ì˜¤ í‚¤(ì˜ˆ: 'overdue_outstanding_over_limit', 'payment_due_reminder')ì…ë‹ˆë‹¤.
- occurred_at: timestamptz (í•„ìˆ˜, UTC ì €ì¥)
- payload: jsonb (ì—…ì¢…ë³„ í™•ì¥ ë°ì´í„°)
- store_id: uuid (ìƒìš©í™” ë‹¨ê³„, ì§€ì—­ ë²¤ì¹˜ë§ˆí‚¹ìš©)
- region_id: uuid (ìƒìš©í™” ë‹¨ê³„, ì§€ì—­ ë²¤ì¹˜ë§ˆí‚¹ìš©)
- industry_type: text (ìƒìš©í™” ë‹¨ê³„, ì§€ì—­ ë²¤ì¹˜ë§ˆí‚¹ìš©)
- event_date_kst: date (ìƒìš©í™” ë‹¨ê³„, KST ê¸°ì¤€ ì¼ì)

ğŸ“Œ ETL ê·œì¹™:

1. ì´ë²¤íŠ¸ ìˆ˜ì§‘ (ì‹¤ì‹œê°„):
   - Edge Function ë˜ëŠ” ì„œë²„ ì½”ë“œì—ì„œ ì¦‰ì‹œ analytics.eventsì— INSERT
   - occurred_atëŠ” UTCë¡œ ì €ì¥, event_date_kstëŠ” ì„œë²„ ì½”ë“œì—ì„œ toKST()ë¡œ ê³„ì‚°í•˜ì—¬ í•¨ê»˜ ì €ì¥
   - ìƒìš©í™” ë‹¨ê³„ì—ì„œëŠ” store_id, region_id, industry_typeì„ í•¨ê»˜ ì €ì¥

2. ì¼ë³„ ì§‘ê³„ (ë°°ì¹˜):
   - ë§¤ì¼ 04:00 KSTì— ì™¸ë¶€ Worker(Lambda/Cloudflare Workers)ê°€ ì „ë‚  ë°ì´í„° ì§‘ê³„
   - analytics.eventsì—ì„œ event_date_kst ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í•‘í•˜ì—¬ analytics.daily_store_metricsì— upsert (ì •ë³¸)
   - ì§‘ê³„ ì§€í‘œ: student_count, revenue, attendance_rate, new_enrollments, late_rate, absent_rate, active_student_count, inactive_student_count, avg_students_per_class, avg_capacity_rate, arpu
   - ì§€ì—­ë³„ ì§‘ê³„ëŠ” analytics.daily_region_metricsì— upsert (ì •ë³¸)
   - ì—…ì¢…ë³„ KPIëŠ” Industry Layerì˜ Mapperë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì‚°

âš ï¸ ì¤‘ìš”: analytics.daily_metrics, analytics.monthly_revenueëŠ” êµ¬ë²„ì „/íê¸°ëœ ë„¤ì´ë°ì´ë©° ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ë³¸ì€ analytics.daily_store_metrics, analytics.daily_region_metricsë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

ğŸ“Œ ì§€ì—° í—ˆìš© ì‹œê°„(SLA):

- ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì§‘: ì¦‰ì‹œ ì €ì¥ (ì§€ì—° ì—†ìŒ)
- ì¼ë³„ ì§‘ê³„: ë§¤ì¼ 04:00 KST ê¸°ì¤€, ìµœëŒ€ 1ì‹œê°„ ì§€ì—° í—ˆìš© (04:00~05:00 KST ì™„ë£Œ ëª©í‘œ)
- ì›”ë³„ ì§‘ê³„: ë§¤ì›” 1ì¼ 04:00 KST ê¸°ì¤€, ìµœëŒ€ 2ì‹œê°„ ì§€ì—° í—ˆìš© (04:00~06:00 KST ì™„ë£Œ ëª©í‘œ)
- ëŒ€ì‹œë³´ë“œ ì¡°íšŒ: ì§‘ê³„ ì™„ë£Œëœ ë°ì´í„°ë§Œ í‘œì‹œ (ìµœì‹  ë°ì´í„°ëŠ” "ì§‘ê³„ ì¤‘" í‘œì‹œ)

ğŸ“Œ ì‹¤ì‹œê°„ vs ë°°ì¹˜ ë¶„ë¦¬ ê¸°ì¤€:

ì‹¤ì‹œê°„ ì²˜ë¦¬ (Edge Function):
- ì´ë²¤íŠ¸ ìˆ˜ì§‘: analytics.eventsì— ì¦‰ì‹œ INSERT
- ë‹¨ì¼ í…Œë„ŒíŠ¸ ì¡°íšŒ: ìµœì‹  ì´ë²¤íŠ¸ ì¡°íšŒ (analytics.events ì§ì ‘ ì¡°íšŒ)
- ì‹¤ì‹œê°„ ì•Œë¦¼: ì´ë²¤íŠ¸ ë°œìƒ ì¦‰ì‹œ ì²˜ë¦¬

ë°°ì¹˜ ì²˜ë¦¬ (ì™¸ë¶€ Worker):
- ì¼ë³„/ì›”ë³„ ì§‘ê³„: ëŒ€ëŸ‰ ë°ì´í„° ì§‘ê³„ëŠ” ì™¸ë¶€ Workerì—ì„œ ìˆ˜í–‰
- í†µê³„/ë¦¬í¬íŠ¸ ìƒì„±: heavy queryëŠ” ë°°ì¹˜ë¡œ ì²˜ë¦¬
- ë°±í•„(Backfill): ê³¼ê±° ë°ì´í„° ì¬ì§‘ê³„ëŠ” ë°°ì¹˜ë¡œ ì²˜ë¦¬

ğŸ“Œ ì¸ë±ìŠ¤ ì„¤ê³„:

í•„ìˆ˜ ì¸ë±ìŠ¤:
- (tenant_id, occurred_at DESC): í…Œë„ŒíŠ¸ë³„ ìµœì‹  ì´ë²¤íŠ¸ ì¡°íšŒ
- (tenant_id, store_id, occurred_at DESC): ìƒìš©í™” ë‹¨ê³„, ë§¤ì¥ë³„ ì´ë²¤íŠ¸ ì¡°íšŒ
- (industry_type, region_id, event_date_kst): ìƒìš©í™” ë‹¨ê³„, ì§€ì—­ë³„ ì§‘ê³„
- (event_date_kst, industry_type, region_id): ìƒìš©í™” ë‹¨ê³„, ë‚ ì§œ ê¸°ì¤€ ì§‘ê³„
