í”„ë¡œì íŠ¸ SQL ìŠ¤í‚¤ë§ˆ ì •í•©ì„± ë¶„ì„ ë³´ê³ ì„œ
ğŸ“‹ ê°œìš”
ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆì™€ í”„ë¡œì íŠ¸ ì½”ë“œë² ì´ìŠ¤ë¥¼ êµì°¨ ê²€ì¦í•˜ì—¬ ë°ì´í„° ì •í•©ì„±, ì¼ê´€ì„±, ì ì¬ì  ì˜¤ë¥˜ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.

âœ… ì£¼ìš” ë°œê²¬ ì‚¬í•­ ìš”ì•½
ë²ˆí˜¸	ë¶„ë¥˜	ì‹¬ê°ë„	ë¬¸ì œ	ì˜í–¥ ë²”ìœ„
1	ë°ì´í„° ë¶ˆì¼ì¹˜	ğŸ”´ HIGH	academy_students.class_name ì»¬ëŸ¼ ë¶ˆí•„ìš”	ë°ì´í„° ì¤‘ë³µ, ì •ê·œí™” ìœ„ë°˜
2	ìŠ¤í‚¤ë§ˆ ëˆ„ë½	ğŸ”´ HIGH	academy_students.student_phone ì»¬ëŸ¼ ëˆ„ë½	í‚¤ì˜¤ìŠ¤í¬ ì¶œì„ ê¸°ëŠ¥ ë¶ˆê°€
3	ì™¸ë˜í‚¤ ë¶ˆì¼ì¹˜	ğŸŸ¡ MEDIUM	guardians.student_id FK ì •ì˜ ëª¨í˜¸	ì°¸ì¡° ë¬´ê²°ì„± ìœ„í—˜
4	ì™¸ë˜í‚¤ ë¶ˆì¼ì¹˜	ğŸŸ¡ MEDIUM	student_consultations FK ëˆ„ë½	ì°¸ì¡° ë¬´ê²°ì„± ìœ„í—˜
5	ì™¸ë˜í‚¤ ë¶ˆì¼ì¹˜	ğŸŸ¡ MEDIUM	student_classes.student_id FK ëˆ„ë½	ì°¸ì¡° ë¬´ê²°ì„± ìœ„í—˜
6	ì¸ë±ìŠ¤ ëˆ„ë½	ğŸŸ¢ LOW	academy_students ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ ëˆ„ë½	ì„±ëŠ¥ ì €í•˜, ì¤‘ë³µ ë°©ì§€ ë¯¸í¡
7	íƒ€ì… ë¶ˆì¼ì¹˜	ğŸŸ¢ LOW	attendance_logs bigint vs uuid	ì¼ê´€ì„± ì €í•˜
8	ì œì•½ ì¡°ê±´ ëˆ„ë½	ğŸŸ¢ LOW	academy_students.student_phone ìœ ë‹ˆí¬ ì œì•½ ëˆ„ë½	ì¤‘ë³µ ë°©ì§€ ë¯¸í¡
ğŸ”´ 1. ë°ì´í„° ë¶ˆì¼ì¹˜: academy_students.class_name ì»¬ëŸ¼ ë¶ˆí•„ìš”
ë¬¸ì œ ì„¤ëª…
SQL ìŠ¤í‚¤ë§ˆì— academy_students.class_name TEXT ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ì§€ë§Œ, ì´ëŠ” ë°ì´í„° ì •ê·œí™” ìœ„ë°˜ì…ë‹ˆë‹¤.


-- SQL ìŠ¤í‚¤ë§ˆ (ì œê³µëœ íŒŒì¼)
CREATE TABLE public.academy_students (
  ...
  class_name text,  -- âŒ ë¬¸ì œ: í•™ìƒ-ë°˜ ê´€ê³„ëŠ” student_classesì—ì„œ ê´€ë¦¬í•´ì•¼ í•¨
  ...
);
ì™œ ë¬¸ì œì¸ê°€?
ì •ê·œí™” ìœ„ë°˜: í•™ìƒê³¼ ë°˜ì˜ ê´€ê³„ëŠ” ì´ë¯¸ student_classes í…Œì´ë¸”ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤ (M:N ê´€ê³„).


CREATE TABLE public.student_classes (
  student_id uuid NOT NULL,  -- persons.id ì°¸ì¡°
  class_id uuid NOT NULL,    -- academy_classes.id ì°¸ì¡°
  enrolled_at date NOT NULL,
  left_at date,
  is_active boolean
);
ë°ì´í„° ì¤‘ë³µ: class_nameì„ academy_studentsì— ì €ì¥í•˜ë©´ í•™ìƒì´ ì—¬ëŸ¬ ë°˜ì— ë“±ë¡ë  ê²½ìš° ë°ì´í„°ê°€ ë¶ˆì¼ì¹˜í•©ë‹ˆë‹¤.

ì½”ë“œ ë¯¸ì‚¬ìš©: í”„ë¡œì íŠ¸ ì½”ë“œì—ì„œ class_nameì€ ì½ê¸° ì „ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ë©°, ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œëŠ” student_classes ì¡°ì¸ìœ¼ë¡œ ë°˜ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.


// packages/industry/industry-academy/src/service.ts (line 249)
class_name: undefined, // TODO: class_name ì²˜ë¦¬
ê¶Œì¥ ì‚¬í•­

-- âŒ ì œê±° ê¶Œì¥
ALTER TABLE public.academy_students DROP COLUMN class_name;

-- âœ… í•™ìƒì˜ ë°˜ ì •ë³´ëŠ” student_classes í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
SELECT
  p.name AS student_name,
  ac.name AS class_name
FROM persons p
INNER JOIN student_classes sc ON sc.student_id = p.id AND sc.is_active = true
INNER JOIN academy_classes ac ON ac.id = sc.class_id;
ğŸ”´ 2. ìŠ¤í‚¤ë§ˆ ëˆ„ë½: academy_students.student_phone ì»¬ëŸ¼ ëˆ„ë½
ë¬¸ì œ ì„¤ëª…
ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆì—ëŠ” academy_students.student_phone ì»¬ëŸ¼ì´ ì—†ì§€ë§Œ, ì‹¤ì œ í”„ë¡œì íŠ¸ ì½”ë“œì™€ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì—ì„œëŠ” í•„ìˆ˜ ì»¬ëŸ¼ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.


-- ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆ (ëˆ„ë½)
CREATE TABLE public.academy_students (
  ...
  -- student_phone ì»¬ëŸ¼ ì—†ìŒ âŒ
);

-- ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ (150_add_kiosk_check_in_support.sql)
ALTER TABLE public.academy_students
ADD COLUMN IF NOT EXISTS student_phone TEXT;

CREATE UNIQUE INDEX IF NOT EXISTS idx_academy_students_tenant_phone
ON public.academy_students(tenant_id, student_phone)
WHERE student_phone IS NOT NULL;
ì˜í–¥ ë²”ìœ„
í‚¤ì˜¤ìŠ¤í¬ ì¶œì„ ê¸°ëŠ¥ ë¶ˆê°€: KioskCheckInPage.tsx:88ì—ì„œ student_phone í•„ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.


student_phone: phoneNumber.replace(/-/g, ''), // í•˜ì´í”ˆ ì œê±°
Supabase Edge Function ì˜¤ë¥˜: kiosk-check-in/index.ts:76ì—ì„œ student_phoneìœ¼ë¡œ í•™ìƒì„ ì¡°íšŒí•©ë‹ˆë‹¤.


.eq('student_phone', normalizedPhone)
ê¶Œì¥ ì‚¬í•­

-- âœ… ìŠ¤í‚¤ë§ˆì— ì¶”ê°€ í•„ìš”
ALTER TABLE public.academy_students
ADD COLUMN IF NOT EXISTS student_phone TEXT;

-- âœ… ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ ì¶”ê°€ (í…Œë„ŒíŠ¸ ë‚´ ì¤‘ë³µ ë°©ì§€)
CREATE UNIQUE INDEX IF NOT EXISTS idx_academy_students_tenant_phone
ON public.academy_students(tenant_id, student_phone)
WHERE student_phone IS NOT NULL;

COMMENT ON COLUMN public.academy_students.student_phone IS
'í•™ìƒ ë³¸ì¸ íœ´ëŒ€í° ë²ˆí˜¸ (í‚¤ì˜¤ìŠ¤í¬ ì¶œì„ ì²´í¬ìš©). í…Œë„ŒíŠ¸ ë‚´ ìœ ë‹ˆí¬. í˜•ì‹: 01012345678 (í•˜ì´í”ˆ ì—†ìŒ)';
ğŸŸ¡ 3. ì™¸ë˜í‚¤ ë¶ˆì¼ì¹˜: guardians.student_id FK ì •ì˜ ëª¨í˜¸
ë¬¸ì œ ì„¤ëª…
ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆì—ì„œ guardians.student_idì˜ ì™¸ë˜í‚¤ê°€ ëª…ì‹œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.


-- ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆ
CREATE TABLE public.guardians (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL,
  student_id uuid NOT NULL,  -- âŒ FK ì—†ìŒ
  ...
);
ê·¸ëŸ¬ë‚˜ ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì—ì„œëŠ” persons.idë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤:


-- 008_update_guardians_fk_to_person_id.sql
ALTER TABLE public.guardians
ADD CONSTRAINT guardians_student_id_fkey
FOREIGN KEY (student_id) REFERENCES public.persons(id) ON DELETE CASCADE;
ê¶Œì¥ ì‚¬í•­

-- âœ… ìŠ¤í‚¤ë§ˆì— FK ëª…ì‹œ
ALTER TABLE public.guardians
ADD CONSTRAINT guardians_student_id_fkey
FOREIGN KEY (student_id) REFERENCES public.persons(id) ON DELETE CASCADE;
ğŸŸ¡ 4. ì™¸ë˜í‚¤ ë¶ˆì¼ì¹˜: student_consultations FK ëˆ„ë½
ë¬¸ì œ ì„¤ëª…
student_consultations.student_idë„ persons.idë¥¼ ì°¸ì¡°í•´ì•¼ í•˜ì§€ë§Œ, ì œê³µëœ ìŠ¤í‚¤ë§ˆì— FKê°€ ì—†ìŠµë‹ˆë‹¤.


-- ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆ
CREATE TABLE public.student_consultations (
  student_id uuid NOT NULL,  -- âŒ FK ì—†ìŒ
  ...
);
ê¶Œì¥ ì‚¬í•­

-- âœ… FK ì¶”ê°€
ALTER TABLE public.student_consultations
ADD CONSTRAINT student_consultations_student_id_fkey
FOREIGN KEY (student_id) REFERENCES public.persons(id) ON DELETE CASCADE;
ğŸŸ¡ 5. ì™¸ë˜í‚¤ ë¶ˆì¼ì¹˜: student_classes.student_id FK ëˆ„ë½
ë¬¸ì œ ì„¤ëª…
student_classes.student_idë„ persons.idë¥¼ ì°¸ì¡°í•´ì•¼ í•˜ì§€ë§Œ, ì œê³µëœ ìŠ¤í‚¤ë§ˆì— FKê°€ ì—†ìŠµë‹ˆë‹¤.


-- ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆ
CREATE TABLE public.student_classes (
  student_id uuid NOT NULL,  -- âŒ FK ì—†ìŒ
  class_id uuid NOT NULL,
  ...
  CONSTRAINT student_classes_class_id_fkey FOREIGN KEY (class_id) REFERENCES public.academy_classes(id)
  -- student_id FK ì—†ìŒ âŒ
);
ê¶Œì¥ ì‚¬í•­

-- âœ… FK ì¶”ê°€
ALTER TABLE public.student_classes
ADD CONSTRAINT student_classes_student_id_fkey
FOREIGN KEY (student_id) REFERENCES public.persons(id) ON DELETE CASCADE;
ğŸŸ¢ 6. ì¸ë±ìŠ¤ ëˆ„ë½: academy_students ìœ ë‹ˆí¬ ì œì•½
ë¬¸ì œ ì„¤ëª…
academy_students.person_idê°€ UNIQUE ì œì•½ì´ ìˆì–´ì•¼ í•˜ì§€ë§Œ, ì œê³µëœ ìŠ¤í‚¤ë§ˆì— ëª…ì‹œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.


-- ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆ
CREATE TABLE public.academy_students (
  person_id uuid NOT NULL UNIQUE,  -- âœ… UNIQUE ìˆìŒ (ë¬¸ì œ ì—†ìŒ)
  ...
);
ì´ ë¶€ë¶„ì€ ì‹¤ì œë¡œ ë¬¸ì œ ì—†ìŒìœ¼ë¡œ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. SQL ìŠ¤í‚¤ë§ˆì— ì´ë¯¸ UNIQUE ì œì•½ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ğŸŸ¢ 7. íƒ€ì… ë¶ˆì¼ì¹˜: attendance_logs bigint vs uuid
ë¬¸ì œ ì„¤ëª…
attendance_logs.idê°€ bigint íƒ€ì…ì¸ë°, ë‹¤ë¥¸ í…Œì´ë¸”ë“¤ì€ ëŒ€ë¶€ë¶„ uuidë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.


CREATE TABLE public.attendance_logs (
  id bigint NOT NULL DEFAULT nextval('attendance_logs_id_seq'::regclass),  -- bigint
  ...
);

CREATE TABLE public.academy_students (
  id uuid NOT NULL DEFAULT gen_random_uuid(),  -- uuid
  ...
);
ê¶Œì¥ ì‚¬í•­
ì¼ê´€ì„± ìœ ì§€: íŠ¹ë³„í•œ ì´ìœ ê°€ ì—†ë‹¤ë©´ uuidë¡œ í†µì¼í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
íŒŒí‹°ì…”ë‹ ê³ ë ¤: attendance_logsê°€ íŒŒí‹°ì…˜ í…Œì´ë¸”(occurred_atë¡œ íŒŒí‹°ì…”ë‹)ì´ë¯€ë¡œ bigintê°€ ì„±ëŠ¥ìƒ ìœ ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° í˜„ì¬ êµ¬ì¡° ìœ ì§€ê°€ í•©ë¦¬ì ì…ë‹ˆë‹¤.
ğŸŸ¢ 8. ì œì•½ ì¡°ê±´ ëˆ„ë½: academy_students.student_phone ìœ ë‹ˆí¬ ì œì•½
ë¬¸ì œ ì„¤ëª…
student_phoneì— ëŒ€í•œ ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ì—ëŠ” ìˆì§€ë§Œ, ì œê³µëœ ìŠ¤í‚¤ë§ˆì—ëŠ” ì—†ìŠµë‹ˆë‹¤.


-- ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
CREATE UNIQUE INDEX IF NOT EXISTS idx_academy_students_tenant_phone
ON public.academy_students(tenant_id, student_phone)
WHERE student_phone IS NOT NULL;
ê¶Œì¥ ì‚¬í•­
ìŠ¤í‚¤ë§ˆ ë¬¸ì„œì— ëª…ì‹œì ìœ¼ë¡œ ê¸°ì¬í•©ë‹ˆë‹¤.
ğŸ“Š ì™¸ë˜í‚¤ ê´€ê³„ ê²€ì¦ ê²°ê³¼
âœ… ì˜¬ë°”ë¥¸ ì™¸ë˜í‚¤ ê´€ê³„
ìì‹ í…Œì´ë¸”	ì»¬ëŸ¼	ë¶€ëª¨ í…Œì´ë¸”	ë¶€ëª¨ ì»¬ëŸ¼	ìƒíƒœ
academy_students	person_id	persons	id	âœ… ì •ìƒ
academy_teachers	person_id	persons	id	âœ… ì •ìƒ
student_classes	class_id	academy_classes	id	âœ… ì •ìƒ
class_teachers	class_id	academy_classes	id	âœ… ì •ìƒ
class_teachers	teacher_id	academy_teachers	person_id	âœ… ì •ìƒ
attendance_logs	student_id	persons	id	âœ… ì •ìƒ
attendance_logs	class_id	academy_classes	id	âœ… ì •ìƒ
âš ï¸ ëˆ„ë½ëœ ì™¸ë˜í‚¤
í…Œì´ë¸”	ì»¬ëŸ¼	ì°¸ì¡° ëŒ€ìƒ	ì¡°ì¹˜ í•„ìš”
guardians	student_id	persons(id)	ğŸ”´ FK ì¶”ê°€
student_consultations	student_id	persons(id)	ğŸ”´ FK ì¶”ê°€
student_classes	student_id	persons(id)	ğŸ”´ FK ì¶”ê°€
ğŸ› ï¸ ê¶Œì¥ ìˆ˜ì • SQL (ìš°ì„ ìˆœìœ„ë³„)
ğŸ”´ Priority 1: ì¦‰ì‹œ ìˆ˜ì • í•„ìš”

-- 1. student_phone ì»¬ëŸ¼ ì¶”ê°€ (í‚¤ì˜¤ìŠ¤í¬ ê¸°ëŠ¥ í•„ìˆ˜)
ALTER TABLE public.academy_students
ADD COLUMN IF NOT EXISTS student_phone TEXT;

CREATE UNIQUE INDEX IF NOT EXISTS idx_academy_students_tenant_phone
ON public.academy_students(tenant_id, student_phone)
WHERE student_phone IS NOT NULL;

-- 2. ì™¸ë˜í‚¤ ì¶”ê°€ (ì°¸ì¡° ë¬´ê²°ì„± ë³´ì¥)
ALTER TABLE public.guardians
ADD CONSTRAINT guardians_student_id_fkey
FOREIGN KEY (student_id) REFERENCES public.persons(id) ON DELETE CASCADE;

ALTER TABLE public.student_consultations
ADD CONSTRAINT student_consultations_student_id_fkey
FOREIGN KEY (student_id) REFERENCES public.persons(id) ON DELETE CASCADE;

ALTER TABLE public.student_classes
ADD CONSTRAINT student_classes_student_id_fkey
FOREIGN KEY (student_id) REFERENCES public.persons(id) ON DELETE CASCADE;
ğŸŸ¡ Priority 2: ë°ì´í„° ì •ê·œí™”

-- 3. class_name ì»¬ëŸ¼ ì œê±° (ì •ê·œí™” ìœ„ë°˜ í•´ê²°)
-- âš ï¸ ì£¼ì˜: ê¸°ì¡´ ë°ì´í„°ë¥¼ student_classesë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì‹¤í–‰
ALTER TABLE public.academy_students DROP COLUMN IF EXISTS class_name;
ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸
ìŠ¤í‚¤ë§ˆ ì •í•©ì„±
âœ… tenants - ê¸°ë³¸ êµ¬ì¡° ì •ìƒ
âœ… persons - ë©€í‹° ì¸ë”ìŠ¤íŠ¸ë¦¬ Party íŒ¨í„´ ì •ìƒ
âš ï¸ academy_students - student_phone ëˆ„ë½, class_name ë¶ˆí•„ìš”
âœ… academy_classes - ì •ìƒ
âœ… academy_teachers - ì •ìƒ
âš ï¸ guardians - FK ëˆ„ë½
âš ï¸ student_consultations - FK ëˆ„ë½
âš ï¸ student_classes - FK ëˆ„ë½
âœ… class_teachers - ì •ìƒ
âœ… attendance_logs - ì •ìƒ (íŒŒí‹°ì…”ë‹ ê³ ë ¤ ì‹œ bigint í•©ë¦¬ì )
ì½”ë“œì™€ ìŠ¤í‚¤ë§ˆ ì¼ê´€ì„±
âœ… TypeScript íƒ€ì… ì •ì˜ì™€ SQL ìŠ¤í‚¤ë§ˆ ì¼ì¹˜ (ëŒ€ë¶€ë¶„)
âš ï¸ student_phone ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ë§Œ ìŠ¤í‚¤ë§ˆ ë¬¸ì„œì— ëˆ„ë½
âš ï¸ class_name ìŠ¤í‚¤ë§ˆì— ìˆì§€ë§Œ ì½”ë“œì—ì„œ ë¯¸ì‚¬ìš©
ğŸ¯ ê²°ë¡ 
ì œê³µëœ SQL ìŠ¤í‚¤ë§ˆëŠ” ì „ë°˜ì ìœ¼ë¡œ ì˜ ì„¤ê³„ë˜ì—ˆìœ¼ë‚˜, ì•„ë˜ 3ê°€ì§€ í•µì‹¬ ì´ìŠˆë¥¼ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤:

academy_students.student_phone ì»¬ëŸ¼ ì¶”ê°€ - í‚¤ì˜¤ìŠ¤í¬ ê¸°ëŠ¥ í•„ìˆ˜
ì™¸ë˜í‚¤ ëª…ì‹œ - guardians, student_consultations, student_classesì˜ student_id FK ì¶”ê°€
academy_students.class_name ì œê±° - ë°ì´í„° ì •ê·œí™” ê°œì„ 
ìœ„ ìˆ˜ì • ì‚¬í•­ì„ ì ìš©í•˜ë©´ ë°ì´í„° ë¬´ê²°ì„±, ì¼ê´€ì„±, ìœ ì§€ë³´ìˆ˜ì„±ì´ í¬ê²Œ í–¥ìƒë©ë‹ˆë‹¤.
